rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user has QA tester role (for running QA tests)
    // SECURITY: QA testers should only exist in development/staging
    function isQATester() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
        'qa_tester' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }

    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (
          // Check roles array
          (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
           'admin' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles) ||
          // OR check isAdmin boolean field
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
        );
    }

    // Validate string length
    function isValidStringLength(str, maxLen) {
      return str is string && str.size() <= maxLen;
    }

    // Validate document has required fields
    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }

    // Rate limiting helper - check if enough time has passed since last action
    // Note: This requires storing lastActionAt in the document
    function isNotRateLimited(lastActionField, minIntervalSeconds) {
      return !resource.data.keys().hasAny([lastActionField]) ||
        request.time > resource.data[lastActionField] + duration.value(minIntervalSeconds, 's');
    }

    // Users collection - only the user can read/write their own data
    match /users/{userId} {
      // QA testers can read all users for testing purposes
      allow read: if isAuthenticated() && (isOwner(userId) || isQATester());
      allow write: if isAuthenticated() && isOwner(userId);

      // User's sub-collections (profile, gamification, etc.)
      match /{document=**} {
        allow read: if isAuthenticated() && (isOwner(userId) || isQATester());
        allow write: if isAuthenticated() && isOwner(userId);
      }
    }

    // Courses collection
    match /courses/{courseId} {
      // Teachers can create courses
      allow create: if isAuthenticated() && request.resource.data.teacherId == request.auth.uid;

      // Read access:
      // - Teachers can read their own courses
      // - Students can access via shared links (any authenticated user)
      // - QA testers for testing purposes
      // NOTE: For student links (studentCourseId), we allow any authenticated user to read
      allow read: if isAuthenticated();

      allow update, delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;

      // Units sub-collection - inherits course permissions
      match /units/{unitId} {
        // Any authenticated user can read units (for student links)
        allow read: if isAuthenticated();

        allow write: if isAuthenticated() &&
          get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid;
      }

      // Events sub-collection (for event sourcing pattern - future use)
      match /events/{eventId} {
        allow read: if isAuthenticated() &&
          get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid;

        allow create: if isAuthenticated() && (
          get(/databases/$(database)/documents/courses/$(courseId)).data.teacherId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/courses/$(courseId)).data.studentIds
        );
      }
    }

    // Assignments collection
    match /assignments/{assignmentId} {
      // Teachers can create assignments
      allow create: if isAuthenticated() && request.resource.data.teacherId == request.auth.uid;

      // Any authenticated user can read assignments (for student links)
      allow read: if isAuthenticated();

      // Only the teacher can update/delete
      allow update, delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;
    }

    // Student Tasks collection (for QA testing)
    match /student_tasks/{taskId} {
      // Teachers can create student tasks
      allow create: if isAuthenticated() && request.resource.data.teacherId == request.auth.uid;

      // Any authenticated user can read tasks (for student links)
      allow read: if isAuthenticated();

      // Teachers can update/delete
      allow update, delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;
    }

    // Student assignments collection
    match /student_assignments/{assignmentId} {
      // Teachers can create student assignments
      allow create: if isAuthenticated() && request.resource.data.teacherId == request.auth.uid;

      // Teachers and assigned students can read
      allow read: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        resource.data.studentId == request.auth.uid
      );

      // Teachers can update/delete
      // Students can update their own status
      allow update: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        (resource.data.studentId == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'completedAt', 'progress']))
      );

      allow delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;
    }

    // Submissions collection
    match /submissions/{submissionId} {
      // Students can create their own submissions
      allow create: if isAuthenticated() && request.resource.data.studentId == request.auth.uid;

      // Students can read their own submissions
      // Teachers can read submissions for their assignments
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.teacherId == request.auth.uid ||
        (resource.data.teacherIds != null && request.auth.uid in resource.data.teacherIds)
      );

      // Students can update their own submissions (before grading)
      // Teachers can update submissions (for grading)
      allow update: if isAuthenticated() && (
        (resource.data.studentId == request.auth.uid && resource.data.graded != true) ||
        resource.data.teacherId == request.auth.uid ||
        (resource.data.teacherIds != null && request.auth.uid in resource.data.teacherIds)
      );

      // Only teachers can delete submissions
      allow delete: if isAuthenticated() && (
        resource.data.teacherId == request.auth.uid ||
        (resource.data.teacherIds != null && request.auth.uid in resource.data.teacherIds)
      );
    }

    // Cache collection (for backend caching - future use)
    match /_cache/{cacheKey} {
      // Only allow reads - writes happen server-side
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write to cache
    }

    // Analytics/telemetry collection (write-only for users, read for admins)
    match /analytics/{docId} {
      allow create: if isAuthenticated();
      allow read: if false; // Only admins via Cloud Functions
      allow update, delete: if false;
    }

    // Student progress collection
    match /student_progress/{progressId} {
      // Students can create their own progress records
      allow create: if isAuthenticated() && request.resource.data.studentId == request.auth.uid;

      // Students can read their own progress
      // Teachers can read progress for their courses
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.teacherId == request.auth.uid
      );

      // Students can update their own progress
      // Teachers can update progress for their courses
      allow update: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        resource.data.teacherId == request.auth.uid
      );

      // Only teachers can delete progress records
      allow delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;
    }

    // Safety alerts collection
    match /safety_alerts/{alertId} {
      // System can create alerts (usually from Cloud Functions)
      allow create: if isAuthenticated();

      // Teachers can read alerts for their courses
      allow read: if isAuthenticated() && resource.data.teacherId == request.auth.uid;

      // Teachers can update alerts (mark as handled)
      allow update: if isAuthenticated() && resource.data.teacherId == request.auth.uid;

      // Teachers can delete alerts
      allow delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;
    }

    // AI News collection - public read for all authenticated users
    match /ai_news/{newsId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }

    // AI News collection (alternate name used in code)
    match /aiNews/{newsId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }

    // Prompts Library collection
    match /prompts/{promptId} {
      // All authenticated users can read prompts
      allow read: if isAuthenticated();

      // Authenticated users can create prompts (goes live immediately)
      allow create: if isAuthenticated() && (
        request.resource.data.createdBy == request.auth.uid ||
        request.resource.data.createdBy == null // Auto-generated prompts
      );

      // Only the creator can update their own prompts
      // Cloud Functions can update any prompt (for stats)
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        // Allow incrementing usageCount by anyone
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usageCount', 'averageRating', 'ratingCount'])
      );

      // Only the creator can delete their own prompts
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // Prompt Ratings collection
    match /prompt_ratings/{ratingId} {
      // All authenticated users can read ratings
      allow read: if isAuthenticated();

      // Users can create their own ratings
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own ratings
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can delete their own ratings
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // AI Blog collection - weekly curated articles
    match /aiBlog/{articleId} {
      // All authenticated users can read blog articles
      allow read: if isAuthenticated();

      // Only Cloud Functions can write (via admin SDK)
      allow write: if false;
    }

    // QA Reports collection - for automated testing system
    match /qa_reports/{reportId} {
      // All authenticated users can read QA reports
      allow read: if isAuthenticated();

      // All authenticated users can create QA reports
      allow create: if isAuthenticated();

      // Only the user who created the report can update/delete it
      allow update, delete: if isAuthenticated() && (
        resource.data.triggeredByUserId == request.auth.uid ||
        resource.data.triggeredByUserId == null // System-generated reports
      );
    }

    // ============================================
    // KNOWLEDGE BASE (RAG) COLLECTION
    // ============================================

    // Math knowledge base - for AI-powered question generation
    match /math_knowledge/{chunkId} {
      // All authenticated users can search/read knowledge base
      allow read: if isAuthenticated();

      // Only admins can write (upload documents) - via Cloud Functions
      allow write: if false;
    }

    // Extraction progress - for batch PDF processing status
    match /extraction_progress/{progressId} {
      // Authenticated users can read extraction progress
      allow read: if isAuthenticated();

      // Only Cloud Functions can write (via Admin SDK)
      allow write: if false;
    }

    // ============================================
    // WIZDI INTEGRATION COLLECTIONS
    // ============================================

    // Wizdi sessions - managed by Cloud Functions only
    match /wizdi_sessions/{sessionId} {
      // Only Cloud Functions can read/write (via Admin SDK)
      allow read, write: if false;
    }

    // Wizdi users mapping - managed by Cloud Functions only
    match /wizdi_users/{userId} {
      // Only Cloud Functions can read/write (via Admin SDK)
      allow read, write: if false;
    }

    // ============================================
    // SECURITY: Rate Limiting Collection
    // ============================================

    // Rate limit tracking - write-only for users
    match /rate_limits/{userId} {
      // Users can only write to their own rate limit document
      allow create, update: if isOwner(userId);
      // No reads allowed from client
      allow read, delete: if false;
    }

    // ============================================
    // SECURITY: Audit Logs Collection
    // ============================================

    // Audit logs - write-only, read only by admins
    match /audit_logs/{logId} {
      // Any authenticated user can create audit logs
      allow create: if isAuthenticated();
      // Only admins can read audit logs
      allow read: if isAdmin();
      // No updates or deletes allowed
      allow update, delete: if false;
    }

    // ============================================
    // LICENSING & USAGE TRACKING
    // ============================================

    // Check if user belongs to an institution
    function getUserInstitutionId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.institutionId;
    }

    // Check if user is institution admin
    function isInstitutionAdmin(institutionId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.institutionId == institutionId &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Institutions collection
    match /institutions/{institutionId} {
      // System admins can read all institutions
      // Institution admins can read their own
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isInstitutionAdmin(institutionId)
      );

      // Only system admins can create institutions
      allow create: if isAdmin();

      // Institution admins can update settings (not license-related)
      // System admins can update anything
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isInstitutionAdmin(institutionId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['licenseId', 'licenseStatus']))
      );

      // Only system admins can delete institutions
      allow delete: if isAdmin();
    }

    // Licenses collection
    match /licenses/{licenseId} {
      // System admins can read all licenses
      // Institution admins can read their own license
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (exists(/databases/$(database)/documents/institutions/$(resource.data.institutionId)) &&
         isInstitutionAdmin(resource.data.institutionId))
      );

      // Only system admins or Cloud Functions can write licenses
      allow create, update, delete: if isAdmin();
    }

    // Usage Logs collection
    match /usage_logs/{logId} {
      // System admins can read all usage logs
      // Institution admins can read their institution's logs
      // Teachers can read their own logs
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid ||
        (resource.data.institutionId != null && isInstitutionAdmin(resource.data.institutionId))
      );

      // Only Cloud Functions can write usage logs (via Admin SDK)
      allow create, update, delete: if false;
    }

    // Usage Aggregations collection
    match /usage_aggregations/{aggId} {
      // System admins can read all aggregations
      // Institution admins can read their institution's aggregations
      // Teachers can read their own aggregations
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid ||
        (resource.data.institutionId != null && isInstitutionAdmin(resource.data.institutionId))
      );

      // Only Cloud Functions can write aggregations (via Admin SDK)
      allow create, update, delete: if false;
    }

    // Usage Notifications collection
    match /usage_notifications/{notificationId} {
      // Users can read notifications for their institution
      // Or their own personal notifications
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid ||
        (resource.data.institutionId != null && isInstitutionAdmin(resource.data.institutionId))
      );

      // Users can update to dismiss their notifications
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isInstitutionAdmin(resource.data.institutionId)
      ) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dismissed']);

      // Only Cloud Functions can create/delete
      allow create, delete: if false;
    }

    // ============================================
    // GENERATION TIMINGS (Admin Analytics)
    // ============================================

    // Generation timing data for speed analytics
    match /generationTimings/{timingId} {
      // Any authenticated user can create timing records
      allow create: if isAuthenticated();

      // Only admins can read timing data
      allow read: if isAdmin();

      // No updates or deletes allowed
      allow update, delete: if false;
    }

    // ============================================
    // TEACHER PREFERENCES
    // ============================================

    // Teacher preferences - each teacher can read/write their own preferences
    match /teacher_preferences/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ============================================
    // GENERATION QUEUE
    // ============================================

    // Course generation queue - teachers can create and read their own requests
    match /course_generation_queue/{requestId} {
      // Teachers can create generation requests
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Teachers can read their own requests (to check status)
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions process and update these - allow user to read status updates
      // Users should not update/delete directly
      allow update, delete: if false;
    }

    // Exam generation queue - same rules as course queue
    match /exam_generation_queue/{requestId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ============================================
    // DEFAULT DENY
    // ============================================

    // Block all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
