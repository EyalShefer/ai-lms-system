<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Debug Tool</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #1a1a2e; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status { padding: 8px 16px; border-radius: 8px; font-weight: bold; display: inline-block; margin: 5px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #3565e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #2a52b8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #1a1a2e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-item { margin: 10px 0; padding: 10px; border-left: 3px solid #ddd; }
        .test-item.pass { border-color: #28a745; }
        .test-item.fail { border-color: #dc3545; }
        audio { width: 100%; margin: 10px 0; }
        input { padding: 10px; font-size: 14px; width: 100%; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>ğŸ™ï¸ Podcast Debug Tool</h1>

    <div class="card">
        <h2>1. ×‘×“×™×§×ª ElevenLabs API</h2>
        <p>×”×›× ×¡ ××ª ×”-API Key ×©×œ×š:</p>
        <input type="text" id="apiKey" placeholder="sk_..." value="">
        <br><br>
        <button onclick="testElevenLabsAPI()">×‘×“×•×§ ×—×™×‘×•×¨ ×œ-ElevenLabs</button>
        <button onclick="testTTS()">×‘×“×•×§ ×™×¦×™×¨×ª ××•×“×™×• (TTS)</button>
        <div id="elevenLabsResult"></div>
        <audio id="testAudio" controls style="display:none;"></audio>
    </div>

    <div class="card">
        <h2>2. ×‘×“×™×§×ª Firebase</h2>
        <p>×”×›× ×¡ Course ID ×œ×‘×“×™×§×”:</p>
        <input type="text" id="courseId" placeholder="×”×–×Ÿ Course ID ××”-URL">
        <br><br>
        <button onclick="checkFirebaseCourse()">×‘×“×•×§ ×§×•×¨×¡ ×‘-Firestore</button>
        <div id="firebaseResult"></div>
    </div>

    <div class="card">
        <h2>3. ×‘×“×™×§×•×ª ×“×¤×“×¤×Ÿ</h2>
        <button onclick="runBrowserTests()">×”×¨×¥ ×‘×“×™×§×•×ª</button>
        <div id="browserTests"></div>
    </div>

    <div class="card">
        <h2>4. ×œ×•×’ Console</h2>
        <pre id="consoleLog">×”×œ×•×’×™× ×™×•×¤×™×¢×• ×›××Ÿ...</pre>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Console interceptor
        const logDiv = document.getElementById('consoleLog');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(type, ...args) {
            const time = new Date().toLocaleTimeString();
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
            logDiv.textContent += `[${time}] ${type}: ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = (...args) => { originalLog(...args); addLog('LOG', ...args); };
        console.error = (...args) => { originalError(...args); addLog('ERROR', ...args); };
        console.warn = (...args) => { originalWarn(...args); addLog('WARN', ...args); };

        // Load API key from .env (if running on localhost)
        document.getElementById('apiKey').value = 'sk_d18ed797461a6f5590608508b3e173548ca42868b5fafaa8';

        // Firebase config (from .env)
        const firebaseConfig = {
            apiKey: "AIzaSyDpydu7ZwtyWzVO0oxHgdC5w04tBXuwgGA",
            authDomain: "ai-lms-pro.firebaseapp.com",
            projectId: "ai-lms-pro",
            storageBucket: "ai-lms-pro.firebasestorage.app",
            messagingSenderId: "479417566126",
            appId: "1:479417566126:web:c40e64e9ee2f403b70be3f"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (e) {
            console.error('Firebase init error:', e.message);
        }

        // Test 1: ElevenLabs API Connection
        async function testElevenLabsAPI() {
            const apiKey = document.getElementById('apiKey').value;
            const resultDiv = document.getElementById('elevenLabsResult');

            if (!apiKey) {
                resultDiv.innerHTML = '<div class="status error">×—×¡×¨ API Key</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="status info">×‘×•×“×§...</div>';

            try {
                // Test voices endpoint
                const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                    headers: { 'xi-api-key': apiKey }
                });

                if (response.ok) {
                    const data = await response.json();
                    const voiceCount = data.voices?.length || 0;
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… ×—×™×‘×•×¨ ×ª×§×™×Ÿ!</div>
                        <p>××¡×¤×¨ ×§×•×œ×•×ª ×–××™× ×™×: ${voiceCount}</p>
                        <details>
                            <summary>×¨×©×™××ª ×§×•×œ×•×ª</summary>
                            <pre>${JSON.stringify(data.voices?.slice(0, 5).map(v => ({name: v.name, id: v.voice_id})), null, 2)}</pre>
                        </details>
                    `;
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `
                        <div class="status error">âŒ ×©×’×™××”: ${response.status}</div>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="status error">âŒ ×©×’×™××ª ×¨×©×ª: ${e.message}</div>`;
                console.error('ElevenLabs test error:', e);
            }
        }

        // Test 2: TTS Generation
        async function testTTS() {
            const apiKey = document.getElementById('apiKey').value;
            const resultDiv = document.getElementById('elevenLabsResult');
            const audioEl = document.getElementById('testAudio');

            if (!apiKey) {
                resultDiv.innerHTML = '<div class="status error">×—×¡×¨ API Key</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="status info">××™×™×¦×¨ ××•×“×™×•...</div>';

            try {
                const voiceId = 'Hcr1PUBJC4hYJ9PyCCpi'; // Dan voice
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': apiKey
                    },
                    body: JSON.stringify({
                        text: '×©×œ×•×! ×–×•×”×™ ×‘×“×™×§×” ×©×œ ××¢×¨×›×ª ×”×¤×•×“×§××¡×˜.',
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75
                        }
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    audioEl.src = url;
                    audioEl.style.display = 'block';

                    resultDiv.innerHTML = `
                        <div class="status success">âœ… ××•×“×™×• × ×•×¦×¨ ×‘×”×¦×œ×—×”!</div>
                        <p>×’×•×“×œ ×”×§×•×‘×¥: ${(blob.size / 1024).toFixed(1)} KB</p>
                        <p>×œ×—×¥ Play ×›×“×™ ×œ×”××–×™×Ÿ:</p>
                    `;

                    // Try to autoplay
                    try {
                        await audioEl.play();
                        console.log('Audio autoplay succeeded');
                    } catch (playError) {
                        console.warn('Autoplay blocked:', playError.message);
                        resultDiv.innerHTML += `<div class="status warning">âš ï¸ Autoplay ×—×¡×•× - ×œ×—×¥ Play ×™×“× ×™×ª</div>`;
                    }
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `
                        <div class="status error">âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××•×“×™×•: ${response.status}</div>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="status error">âŒ ×©×’×™××ª ×¨×©×ª: ${e.message}</div>`;
                console.error('TTS test error:', e);
            }
        }

        // Test 3: Check Firebase Course
        async function checkFirebaseCourse() {
            const courseId = document.getElementById('courseId').value;
            const resultDiv = document.getElementById('firebaseResult');

            if (!courseId) {
                // Try to get from URL
                const urlParams = new URLSearchParams(window.location.search);
                const fromUrl = urlParams.get('courseId') || urlParams.get('studentCourseId');
                if (fromUrl) {
                    document.getElementById('courseId').value = fromUrl;
                    return checkFirebaseCourse();
                }
                resultDiv.innerHTML = '<div class="status warning">×”×–×Ÿ Course ID</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="status info">×˜×•×¢×Ÿ ×-Firestore...</div>';

            try {
                const doc = await db.collection('courses').doc(courseId).get();

                if (!doc.exists) {
                    resultDiv.innerHTML = '<div class="status error">âŒ ×§×•×¨×¡ ×œ× × ××¦×!</div>';
                    return;
                }

                const data = doc.data();
                const syllabus = data.syllabus || [];

                let podcastInfo = null;
                let blockCount = 0;

                for (const mod of syllabus) {
                    for (const unit of (mod.learningUnits || [])) {
                        const blocks = unit.activityBlocks || [];
                        blockCount += blocks.length;
                        const podcast = blocks.find(b => b.type === 'podcast');
                        if (podcast) {
                            podcastInfo = {
                                unitTitle: unit.title,
                                hasScript: !!podcast.content?.script,
                                lineCount: podcast.content?.script?.lines?.length || 0,
                                audioUrl: podcast.content?.audioUrl,
                                firstLine: podcast.content?.script?.lines?.[0]
                            };
                        }
                    }
                }

                let html = `
                    <div class="status success">âœ… ×§×•×¨×¡ × ××¦×!</div>
                    <p><strong>×›×•×ª×¨×ª:</strong> ${data.title}</p>
                    <p><strong>××¡×¤×¨ Blocks:</strong> ${blockCount}</p>
                    <p><strong>Product Type:</strong> ${data.wizardData?.settings?.productType || '×œ× ××•×’×“×¨'}</p>
                `;

                if (podcastInfo) {
                    html += `
                        <div class="test-item pass">
                            <strong>ğŸ™ï¸ ×¤×•×“×§×¡×˜ × ××¦×!</strong><br>
                            ×™×—×™×“×”: ${podcastInfo.unitTitle}<br>
                            Script: ${podcastInfo.hasScript ? 'âœ…' : 'âŒ'}<br>
                            ×©×•×¨×•×ª: ${podcastInfo.lineCount}<br>
                            Audio URL: ${podcastInfo.audioUrl || '×œ× × ×•×¦×¨ ×¢×“×™×™×Ÿ'}
                        </div>
                        ${podcastInfo.firstLine ? `<pre>${JSON.stringify(podcastInfo.firstLine, null, 2)}</pre>` : ''}
                    `;
                } else if (blockCount === 0) {
                    html += `
                        <div class="test-item fail">
                            <strong>âŒ ××™×Ÿ Activity Blocks!</strong><br>
                            ×–×• ×”×¡×™×‘×” ×œ××¡×š "×˜×•×¢×Ÿ ×©×™×¢×•×¨" ××™× ×¡×•×¤×™.
                        </div>
                    `;
                } else {
                    html += `<div class="test-item">×œ× × ××¦× ×¤×•×“×§×¡×˜ ×‘×§×•×¨×¡ ×–×”</div>`;
                }

                resultDiv.innerHTML = html;
                console.log('Course data:', data);

            } catch (e) {
                resultDiv.innerHTML = `<div class="status error">âŒ ×©×’×™××”: ${e.message}</div>`;
                console.error('Firebase error:', e);
            }
        }

        // Test 4: Browser Tests
        function runBrowserTests() {
            const resultDiv = document.getElementById('browserTests');
            let html = '';

            // Test: Web Audio API
            const hasWebAudio = !!(window.AudioContext || window.webkitAudioContext);
            html += `<div class="test-item ${hasWebAudio ? 'pass' : 'fail'}">
                Web Audio API: ${hasWebAudio ? 'âœ… × ×ª××š' : 'âŒ ×œ× × ×ª××š'}
            </div>`;

            // Test: Audio Element
            const audio = document.createElement('audio');
            const canPlayMp3 = audio.canPlayType('audio/mpeg');
            html += `<div class="test-item ${canPlayMp3 ? 'pass' : 'fail'}">
                ×ª××™×›×” ×‘-MP3: ${canPlayMp3 || 'âŒ ×œ× × ×ª××š'}
            </div>`;

            // Test: Autoplay Policy
            html += `<div class="test-item info">
                <strong>Autoplay Policy:</strong><br>
                ×¨×•×‘ ×”×“×¤×“×¤× ×™× ×“×•×¨×©×™× ××™× ×˜×¨××§×¦×™×” ×©×œ ×”××©×ª××© ×œ×¤× ×™ ×”×©××¢×ª ××•×“×™×•.<br>
                ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ Play ×¦×¨×™×›×” ×œ×¢×‘×•×“.
            </div>`;

            // Test: CORS
            html += `<div class="test-item info">
                <strong>CORS:</strong><br>
                ×§×¨×™××•×ª ×œ-ElevenLabs API ××”×“×¤×“×¤×Ÿ ×¢×œ×•×œ×•×ª ×œ×”×™×—×¡×.<br>
                ×¤×ª×¨×•×Ÿ: ×”×©×ª××© ×‘-proxy ××• Cloud Function.
            </div>`;

            // Test: localStorage
            try {
                localStorage.setItem('test', '1');
                localStorage.removeItem('test');
                html += `<div class="test-item pass">LocalStorage: âœ… ×–××™×Ÿ</div>`;
            } catch (e) {
                html += `<div class="test-item fail">LocalStorage: âŒ ×—×¡×•×</div>`;
            }

            // Browser info
            html += `<div class="test-item">
                <strong>×“×¤×“×¤×Ÿ:</strong> ${navigator.userAgent.split(' ').pop()}
            </div>`;

            resultDiv.innerHTML = html;
        }

        // Auto-run browser tests on load
        window.onload = () => {
            runBrowserTests();
            console.log('Debug tool loaded. Ready for testing.');
        };
    </script>
</body>
</html>
