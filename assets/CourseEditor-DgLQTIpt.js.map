{"version":3,"mappings":"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","names":["__iconNode","IconCircleCheck","createReactComponent","IconCircleX","IconPalette","AUDIO_OVERVIEW_PROMPT","AudioGenerator","request","fullPrompt","text","openai","MODEL_NAME","cleanJsonString","script","error","_script","SourceGuideService","fullText","prompt","CitationService","c","content","e","SourceViewer","onClose","pdfSource","activeTab","setActiveTab","useState","guideData","setGuideData","loadingGuide","setLoadingGuide","useEffect","handleHashChange","hash","id","el","handleGenerateGuide","data","jsxs","jsx","IconBook","IconSparkles","IconX","chunk","IconLoader","Fragment","ReactMarkdown","href","children","t","i","q","MAX_VERSIONS","STORAGE_PREFIX","useVersionHistory","unitId","blockId","currentContent","onUpdate","history","setHistory","isInitialized","useRef","storageKey","stored","parsed","err","saveVersion","useCallback","newContent","prev","newEntry","newVersions","goToPrevious","newIndex","previousVersion","goToNext","nextVersion","canGoBack","canGoForward","currentVersionNumber","totalVersions","hasHistory","generateDefaultPrompt","blockType","_a","_b","_c","AiRefineToolbar","className","isOpen","setIsOpen","instruction","setInstruction","isLoading","setIsLoading","setError","success","setSuccess","userEditedPromptRef","handleInstructionChange","value","handleRefine","refinedContent","refineActivityIntroImage","refineBlockContent","IconWand","IconCheck","IconChevronRight","IconChevronLeft","SAVE_DEBOUNCE_MS","saveTimeout","pendingCourse","cleanDataForFirestore","key","acc","executeSave","course","batch","writeBatch","db","courseRef","doc","lightweightSyllabus","module","unit","cleanCourseMain","unitRef","cleanUnit","saveCourseToFirestore","resolve","reject","courseToSave","saveCourseToFirestoreImmediate","saveUnitToFirestore","courseId","setDoc","uploadMediaFile","file","folder","isVideo","maxSize","storagePath","storageRef","ref","storage","metadata","snapshot","uploadBytes","getDownloadURL","DEFAULT_ACTIVITY_MEDIA_BUDGET","APPLICATION_TAXONOMY_LEVELS","SCENARIO_QUESTION_TYPES","shouldAddScenarioImage","questionText","taxonomyLevel","currentUsage","questionType","createContextImagePrompt","topic","subject","gradeLevel","createScenarioImagePrompt","createActivityMediaPlan","questions","usage","contextImage","scenarioImages","question","enrichActivityWithImages","onProgress","blocks","b","mediaPlan","totalImages","currentImage","newBlocks","contextImageUrl","generateAndUploadImage","introBlock","uuidv4","getContextTitle","scenarioImageMap","s","block","scenarioImage","scenarioImageUrl","scenarioBlock","getScenarioCaption","type","imageBlob","generateGeminiImage","imageUrl","uploadGeneratedImage","isActivityEnriched","generateContextImageBlock","customImagePrompt","mediaBudget","startTime","elapsed","processSuggestedMedia","steps","mediaBlocks","stepsNeedingMedia","stepsToProcess","current","total","step","media","infographicPrompt","buildInfographicPrompt","infographicBlock","getInfographicCaption","promptHint","STREAMING_BASE_URL","getAuthToken","user","auth","parseSSEData","line","jsonStr","streamContent","systemPrompt","options","callbacks","token","controller","response","reader","decoder","buffer","fullContent","done","lines","_d","_e","_f","_g","streamDifferentiatedContent","result","levels","eventType","dataLineIndex","dataLine","level","_h","_i","_j","_k","_l","_m","_n","streamLessonContent","lessonParts","part","streamPodcastContent","streamActivityContent","skeleton","finalResult","nextLine","isStreamingSupported","searchCache","CACHE_DURATION","getCacheKey","params","searchYouTubeVideos","cacheKey","cached","httpsCallable","functions","IconSearch","props","IconPlay","IconClock","IconSubtitles","IconStar","YouTubeSearchModal","onSelectVideo","initialQuery","searchQuery","setSearchQuery","videos","setVideos","selectedVideoId","setSelectedVideoId","previewVideoId","setPreviewVideoId","handleSearch","handleKeyPress","handleSelectVideo","video","getScoreColor","score","formatViewCount","count","num","createPortal","NODE_COLORS","EditableNode","selected","isEditing","setIsEditing","label","setLabel","bgColor","textColor","handleDoubleClick","handleBlur","handleKeyDown","Handle","Position","nodeTypes","nodeColor","node","MindMapEditorInner","onChange","onSave","nodes","setNodes","useNodesState","edges","setEdges","useEdgesState","selectedNode","setSelectedNode","showColorPicker","setShowColorPicker","onNodesChange","changes","nds","applyNodeChanges","onEdgesChange","eds","applyEdgeChanges","onConnect","addEdge","onNodeClick","_","onPaneClick","handleAddNode","newX","newY","n","newNode","handleDeleteSelected","handleColorChange","color","handleLabelChange","nodeId","newLabel","nodesWithHandlers","useMemo","styledEdges","edge","handleSave","updatedContent","ReactFlow","Controls","MiniMap","Background","Panel","IconPlus","IconTrash","MindMapEditor","ReactFlowProvider","openaiClient","generateMindMapFromContent","sourceText","maxNodes","trimmedText","MindMapGeneratorModal","onGenerate","isGenerating","setIsGenerating","generatedContent","setGeneratedContent","setMaxNodes","handleGenerate","handleConfirm","handleClose","handleRegenerate","IconBrain","MindMapViewer","IconLoader2","IconRefresh","USE_STREAMING_GENERATION","BLOCK_TYPE_MAPPING","stripHtml","html","div","IconShield","getOptionText","opt","getAiActions","UnitEditor","onCancel","onPreview","useCourseStore","editedUnit","setEditedUnit","editedUnitRef","loadingBlockId","setLoadingBlockId","uploadingBlockId","setUploadingBlockId","activeInsertIndex","setActiveInsertIndex","isAutoGenerating","setIsAutoGenerating","showSource","setShowSource","showHeaderMenu","setShowHeaderMenu","mediaInputMode","setMediaInputMode","mediaInputValue","setMediaInputValue","hasInitialized","isSaving","setIsSaving","saveSuccess","setSaveSuccess","isDirty","setIsDirty","blockEditLevel","setBlockEditLevel","regeneratingVariantBlock","setRegeneratingVariantBlock","podcastSourceMode","setPodcastSourceMode","podcastCustomText","setPodcastCustomText","youtubeSearchOpen","setYoutubeSearchOpen","youtubeSearchBlockId","setYoutubeSearchBlockId","mindMapModalOpen","setMindMapModalOpen","mindMapBlockId","setMindMapBlockId","expandedBlockId","setExpandedBlockId","handleYouTubeVideoSelect","transcript","MultimodalService","updateBlock","handleBack","assignmentModalOpen","setAssignmentModalOpen","assignmentData","setAssignmentData","defaultDate","createdAssignmentLink","setCreatedAssignmentLink","handleCopyLinkClick","handleCreateAssignment","combinedDate","docRef","addDoc","collection","serverTimestamp","link","handleCopyCreatedLink","handleCloseAssignmentModal","showScoring","AI_ACTIONS","mediaBtnClass","totalScore","React","sum","settings","productType","timer","__vitePreload","GenerationTimer","targetLength","safeIncludeBot","podcastBlock","streamStartTime","streamedBlocks","contextImageBlock","message","imgBlock","stepNumber","totalSteps","teachBlock","interactionBlock","mapSystemItemToBlock","contentBlocks","allBlocks","streamDuration","existingContextImage","finalBlocks","unitToSave","currentBlocks","mediaBlock","streamError","generateUnitSkeleton","contextImagePromise","placeholderBlocks","botBlock","personaId","personaData","BOT_PERSONAS","finalPlaceholders","promises","stepContent","generateStepContent","currentUnit","placeholderIndex","enrichActivityBlock","enrichedBlock","enrichedUnit","pendingPodcast","handleGeneratePodcastBlock","handleSaveWithFeedback","handleAutoDistributePoints","targetTotalStr","targetTotal","totalWeight","pointPerWeight","currentSum","weight","remainder","blockIndex","idx","moveBlock","index","direction","generatePedagogicalPrompt","customCharName","baseInfo","safetyProtocol","specificInstructions","persona","addBlockAtIndex","initialPersonaId","newBlock","createBlock","handleAutoGenerateFillInBlanks","handleAutoGenerateOrdering","handleAutoGenerateCategorization","handleAutoGenerateMemoryGame","handleAutoGenerateMCQuestion","handleAutoGenerateTrueFalseQuestion","deleteBlock","newMetadata","getBlockContentForLevel","variantKey","variant","stripAsterisks","updateBlockForLevel","existingVariant","regenerateVariant","generateHavanaVariant","generateHaamakaVariant","LevelSelector","hasVariants","currentLevel","isRegenerating","handlePersonaChange","newPersona","newPrompt","handleFileUpload","field","url","handleAiAction","actionPrompt","res","refineContentWithPedagogy","handleAutoGenerateOpenQuestion","videoTranscripts","userTopic","generateSingleOpenQuestion","generateSingleMultipleChoiceQuestion","generateCategorizationQuestion","learning_level","generateOrderingQuestion","generateFillInBlanksQuestion","learningLevel","generateMemoryGame","generateTrueFalseQuestion","ElevenLabsService","mode","updatedPodcastBlock","scriptText","l","mcqBlock","openBlock","podcastIndex","handleGenerateAiImage","targetField","generateAiImage","fileName","handleAddRelatedQuestion","newQuestionData","updateRelatedQuestion","updatedData","removeRelatedQuestion","renderRelatedQuestionEditor","relatedQ","optText","newOpts","getEmbedUrl","regExp","match","renderMediaToolbar","IconUpload","defaultPrompt","rawText","IconVideo","IconLink","videoId","IconImage","renderMediaInputPanel","InsertMenu","IconText","IconList","IconEdit","IconChat","IconLayer","IconBalance","IconMicrophone","IconHeadphones","IconInfographic","renderEmbeddedMedia","productTypeHebrew","productTypeStatusLabel","typewriterContentType","sourceMode","sourceTextHebrew","AIStarsSpinner","TypewriterLoader","IconEye","IconSave","IconMoreVertical","IconBack","IconArrowUp","IconArrowDown","RichTextEditor","action","ImageGenerationSkeleton","log","msg","debugEl","PodcastPlayer","_o","_p","_q","_r","_s","_t","_u","newOptions","_v","_w","_y","_x","_z","item","newItems","_A","_C","_B","_E","_D","_F","cat","newCats","_G","_I","_H","_J","pair","newPairs","_K","newStmts","_L","_M","_N","_O","_P","_Q","_R","_S","_T","_U","_V","_W","_X","visualType","generateInfographicFromText","_Y","_Z","removedId","newMatches","m","nextId","__","_$","IconCopy","initialState","useStreamingGeneration","state","setState","abortControllerRef","resetState","cancelStreaming","startStreaming","startDifferentiatedStreaming","levelNames","startLessonStreaming","partNames","startPodcastStreaming","startActivityStreaming","onStepComplete","onSkeletonComplete","LevelIndicator","completedLevels","isCompleted","isCurrent","StreamedText","StreamingProgress","showStreamedText","isStreaming","progress","currentPart","streamedText","LessonPlanOverview","onUpdateCourse","onSelectUnit","onUnitUpdate","onGenerateWithAI","onBack","useNavigate","expandedUnits","setExpandedUnits","viewingUnit","setViewingUnit","toggleUnitExpansion","newSet","handleBlockUpdateInUnit","updatedBlocks","updatedUnit","handleAddModule","newModule","updatedCourse","handleDeleteModule","moduleId","updatedSyllabus","handleMoveModule","newSyllabus","handleAddUnit","newUnit","handleDeleteUnit","u","handleMoveUnit","unitIndex","newUnits","shareOptions","setShareOptions","handleShare","unitTitle","initialTab","getAllUnitsInOrder","handlePreview","allUnits","getPhaseIcon","IconFlag","IconJoystick","IconArrowRight","IconShare","IconRobot","mIndex","uIndex","isExpanded","IconPlayerPlay","TeacherCockpit","ShareModal","pdfjsLib.GlobalWorkerOptions","fileToBase64","base64","extractTextFromPDF","arrayBuffer","pdf","pdfjsLib.getDocument","maxPages","pageText","createLessonSkeletonBlocks","lessonTitle","skeletonStyle","mainLoadingBlock","buildingBadge","UnitPreviewModal","CoursePlayer","CourseEditor","navigate","setCourse","selectedUnitId","setSelectedUnitId","previewUnit","setPreviewUnit","showWizard","setShowWizard","streamingState","forcedGrade","setForcedGrade","wizardHasRun","hasAutoSelected","hasSyllabus","isLessonMode","isDifferentiatedMode","firstUnit","isFreshShell","handleWizardComplete","handleGenerateWithAI","_instruction","handleStreamingActivityGeneration","stepPromises","final","grade","activityLength","questionPreferences","newCourse","displayGrade","processLessonPlanQueue","initialSyllabus","taxonomy","flatUnits","currentCourse","sourceType","wizardData","skeletonBlocks","lessonPlan","useParallel","buildPart1Blocks","part1","hookBlock","obj","slideBlocks","slide","p","generateTeacherLessonParallel","part1Blocks","parallelError","generateTeacherStepContent","visualPromise","generateLessonVisuals","planWithVisuals","hookUrl","visualUrl","independentPracticeBlocks","point","tip","updateFound","activityTimer","extractedGrade","userSubject","processedFileData","processedSourceText","fileError","topicToUse","extractTopicFromText","updatedCourseState","updateDoc","syllabus","generateCourseSyllabus","generateCoursePlan","courseWithSyllabus","useStreaming","generatePodcastScript","syllabusWithPodcast","mod","finalCourse","diffContent","isExam","createDiffUnit","levelName","items","unitSupportId","unitCoreId","unitEnrichmentId","skeletonUnits","syllabusWithSkeleton","unitSupport","unitCore","unitEnrichment","syllabusWithDiff","newBlocksRaw","syllabusWithContent","handleSaveUnit","nextUnitToGenerate","foundCurrent","currentSubject","generateFullUnitContentWithVariants","backgroundSyllabus","activeUnit","defaultUnit","unitToRender","IngestionWizard","unitData","updated","TypewriterLoaderInline"],"ignoreList":[0,1,2],"sources":["../../node_modules/@tabler/icons-react/dist/esm/icons/IconCircleCheck.mjs","../../node_modules/@tabler/icons-react/dist/esm/icons/IconCircleX.mjs","../../node_modules/@tabler/icons-react/dist/esm/icons/IconPalette.mjs","../../src/prompts/audioPrompts.ts","../../src/services/audioGenerator.ts","../../src/services/sourceGuideService.ts","../../src/components/SourceViewer.tsx","../../src/hooks/useVersionHistory.ts","../../src/components/AiRefineToolbar.tsx","../../src/firebaseUtils.ts","../../src/utils/mediaBudget.ts","../../src/services/activityMediaService.ts","../../src/services/streamingService.ts","../../src/services/youtubeService.ts","../../src/components/YouTubeSearchModal.tsx","../../src/components/MindMapEditor.tsx","../../src/services/ai/mindMapGenerator.ts","../../src/components/MindMapGeneratorModal.tsx","../../src/components/UnitEditor.tsx","../../src/hooks/useStreamingGeneration.ts","../../src/components/StreamingProgress.tsx","../../src/components/LessonPlanOverview.tsx","../../src/components/CourseEditor.tsx"],"sourcesContent":["/**\n * @license @tabler/icons-react v3.36.0 - MIT\n *\n * This source code is licensed under the MIT license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createReactComponent from '../createReactComponent.mjs';\n\nconst __iconNode = [[\"path\", { \"d\": \"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0\", \"key\": \"svg-0\" }], [\"path\", { \"d\": \"M9 12l2 2l4 -4\", \"key\": \"svg-1\" }]];\nconst IconCircleCheck = createReactComponent(\"outline\", \"circle-check\", \"CircleCheck\", __iconNode);\n\nexport { __iconNode, IconCircleCheck as default };\n//# sourceMappingURL=IconCircleCheck.mjs.map\n","/**\n * @license @tabler/icons-react v3.36.0 - MIT\n *\n * This source code is licensed under the MIT license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createReactComponent from '../createReactComponent.mjs';\n\nconst __iconNode = [[\"path\", { \"d\": \"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0\", \"key\": \"svg-0\" }], [\"path\", { \"d\": \"M10 10l4 4m0 -4l-4 4\", \"key\": \"svg-1\" }]];\nconst IconCircleX = createReactComponent(\"outline\", \"circle-x\", \"CircleX\", __iconNode);\n\nexport { __iconNode, IconCircleX as default };\n//# sourceMappingURL=IconCircleX.mjs.map\n","/**\n * @license @tabler/icons-react v3.36.0 - MIT\n *\n * This source code is licensed under the MIT license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createReactComponent from '../createReactComponent.mjs';\n\nconst __iconNode = [[\"path\", { \"d\": \"M12 21a9 9 0 0 1 0 -18c4.97 0 9 3.582 9 8c0 1.06 -.474 2.078 -1.318 2.828c-.844 .75 -1.989 1.172 -3.182 1.172h-2.5a2 2 0 0 0 -1 3.75a1.3 1.3 0 0 1 -1 2.25\", \"key\": \"svg-0\" }], [\"path\", { \"d\": \"M8.5 10.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0\", \"key\": \"svg-1\" }], [\"path\", { \"d\": \"M12.5 7.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0\", \"key\": \"svg-2\" }], [\"path\", { \"d\": \"M16.5 10.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0\", \"key\": \"svg-3\" }]];\nconst IconPalette = createReactComponent(\"outline\", \"palette\", \"Palette\", __iconNode);\n\nexport { __iconNode, IconPalette as default };\n//# sourceMappingURL=IconPalette.mjs.map\n","export const AUDIO_OVERVIEW_PROMPT = `\r\nRole: Specialized Podcast Producer & Scriptwriter.\r\nTask: Convert the provided academic/learning material into an engaging \"Deep Dive\" podcast script.\r\nFormat: A dialogue between two hosts: \"Dan\" and \"Noa\".\r\n\r\nPHASE 1: THE HOSTS\r\n1. **Dan (The Expert):**\r\n   - Tone: Analytical, slightly cynical, precise.\r\n   - Role: Grounds the conversation in facts. Loves structure.\r\n   - Signature: Uses analogies, corrects misconceptions.\r\n\r\n2. **Noa (The Curious Host):**\r\n   - Tone: Enthusiastic, relatable, asks the \"stupid questions\" everyone is thinking.\r\n   - Role: Moves the narrative forward, reacts emotionally (\"Wait, really?\").\r\n   - Signature: Summarizes complex points in simple terms.\r\n\r\nPHASE 2: THE STYLE\r\n- **Format:** Informal conversation. NOT a lecture.\r\n- **Micro-Hooks:** Start with a \"Cold Open\" (a surprising fact or question).\r\n- **Interactions:** Use interruptions (\"Wait, hang on...\"), agreement sounds (\"Right, right\"), and humor.\r\n- **Language:** Hebrew (Fluent, Conversational, Modern).\r\n\r\nPHASE 3: STRICT GROUNDING (Anti-Hallucination)\r\n- **Source:** You must base the script ONLY on the provided Source Text.\r\n- **Constraint:** Do not make up facts. If the text doesn't say it, don't say it.\r\n- **Citations:** If describing a specific claim, implicitly reference it (\"As the text mentions...\").\r\n\r\nPHASE 4: OUTPUT STRUCTURE (JSON ONLY)\r\nReturn a VALID JSON object:\r\n{\r\n  \"title\": \"Catchy Podcast Title\",\r\n  \"lines\": [\r\n    { \"speaker\": \"Noa\", \"text\": \"Wait, so you're telling me [Fact]?\", \"emotion\": \"Skeptical\" },\r\n    { \"speaker\": \"Dan\", \"text\": \"Exactly. And it gets weirder...\", \"emotion\": \"Neutral\" }\r\n  ]\r\n}\r\n`;\r\n","import { openai, MODEL_NAME } from \"./ai\";\r\nimport { cleanJsonString } from \"../shared/utils/geminiParsers\";\r\nimport type { AudioOverviewRequest, DialogueScript } from \"../shared/types/gemini.types\"; // Fixed path if needed\r\nimport { AUDIO_OVERVIEW_PROMPT } from \"../prompts/audioPrompts\";\r\n\r\n/**\r\n * Service to handle Audio Overview (NotebookLM) generation.\r\n * Refactored to use OpenAI (Unified Stack).\r\n */\r\nexport const AudioGenerator = {\r\n    /**\r\n     * Checks if service is available (user must be authenticated).\r\n     */\r\n    isConfigured: (): boolean => {\r\n        // Service available via secure proxy - just need authentication\r\n        return true;\r\n    },\r\n\r\n    /**\r\n     * Generates a \"Deep Dive\" podcast script from the source text.\r\n     * \r\n     * @param request - The configuration for the audio overview.\r\n     * @returns {Promise<DialogueScript | null>} The strict JSON script or null on failure.\r\n     */\r\n    generateScript: async (request: AudioOverviewRequest): Promise<DialogueScript | null> => {\r\n        if (!AudioGenerator.isConfigured()) {\r\n            console.error(\"OpenAI API Key missing.\");\r\n            return null;\r\n        }\r\n\r\n        try {\r\n            // Construct the full prompt\r\n            const fullPrompt = `\r\n        ${AUDIO_OVERVIEW_PROMPT}\r\n\r\n        ---\r\n        TARGET AUDIENCE: ${request.targetAudience}\r\n        LANGUAGE: ${request.language === 'he' ? \"Hebrew\" : \"English\"}\r\n        FOCUS TOPIC: ${request.focusTopic || \"General Overview\"}\r\n        \r\n        SOURCE TEXT:\r\n        \"\"\"\r\n        ${request.sourceText.substring(0, 50000)} \r\n        \"\"\"\r\n        // Note: GPT-4o-mini has 128k context, keeping safe buffer.\r\n      `;\r\n\r\n\r\n\r\n            const completion = await openai.chat.completions.create({\r\n                model: MODEL_NAME,\r\n                messages: [{ role: \"user\", content: fullPrompt }],\r\n                response_format: { type: \"json_object\" },\r\n                temperature: 0.7\r\n            });\r\n\r\n            let text = completion.choices[0].message.content || \"{}\";\r\n\r\n            // Clean and Parse\r\n            text = cleanJsonString(text);\r\n            const script = JSON.parse(text) as DialogueScript;\r\n\r\n            // Basic Validation\r\n            if (!script.lines || !Array.isArray(script.lines) || script.lines.length < 2) {\r\n                console.warn(\"Generated script is too short or invalid.\");\r\n                return null;\r\n            }\r\n\r\n            return script;\r\n\r\n        } catch (error) {\r\n            console.error(\"AudioGenerator.generateScript Failed:\", error);\r\n            return null;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Future method for TTS integration\r\n     * (Placeholder for Phase 3)\r\n     */\r\n    synthesizeAudio: async (_script: DialogueScript): Promise<string | null> => {\r\n\r\n        return null;\r\n    }\r\n};\r\n","import { openai, MODEL_NAME } from './ai';\r\nimport { cleanJsonString } from '../shared/utils/geminiParsers';\r\nimport { CitationService } from './citationService';\r\nimport type { SourceGuideData } from '../shared/types/gemini.types';\r\n\r\nexport const SourceGuideService = {\r\n    /**\r\n     * Generates a \"Source Guide\" (Summary, Topics, FAQ) based on the full text.\r\n     * Uses citations [1] where possible.\r\n     */\r\n    generateGuide: async (fullText: string): Promise<SourceGuideData | null> => {\r\n        if (!fullText || fullText.length < 50) return null;\r\n\r\n        // We use the chunks to help the AI cite correctly, \r\n        // asking it to reference the chunk IDs if possible.\r\n        // For a high-level summary, we might just pass the text and ask for citations by \"Paragraph X\" \r\n        // or just let it handle the content. \r\n        // To be strictly grounded, we should pass the chunked text.\r\n\r\n        // For efficiency, let's pass the text and ask it to cite roughly. \r\n        // Or better: Use the same \"Numbered Text\" format we used for the Chat.\r\n        const chunks = CitationService.chunkText(fullText);\r\n        const numberedContext = chunks.map(c => `[${c.id}] ${c.text}`).join(\"\\n\\n\");\r\n\r\n        const prompt = `\r\n        Role: Pedagogical Expert.\r\n        Task: Create a \"Source Guide\" for the following learning material.\r\n        Constraint: Refer to the content as \"The Text\" () and NOT \"The Article\" ().\r\n        \r\n        Input Text (Numbered Chunks):\r\n        \"\"\"\r\n        ${numberedContext.substring(0, 50000)} \r\n        \"\"\"\r\n        (Text truncated if too long)\r\n\r\n        Output Requirements (JSON):\r\n        1. \"summary\": A concise briefing (3-4 sentences) summarizing the main point. MUST include citations like [1].\r\n        2. \"topics\": An array of 5 key terms/concepts defined in the text.\r\n        3. \"faq\": An array of 3 questions a student might ask, with brief answers.\r\n\r\n        Language: Hebrew.\r\n        \r\n        Format:\r\n        {\r\n            \"summary\": \"...\",\r\n            \"topics\": [{ \"term\": \"...\", \"definition\": \"...\" }],\r\n            \"faq\": [{ \"question\": \"...\", \"answer\": \"...\" }]\r\n        }\r\n        `;\r\n\r\n        try {\r\n            const completion = await openai.chat.completions.create({\r\n                model: MODEL_NAME,\r\n                messages: [{ role: \"user\", content: prompt }],\r\n                response_format: { type: \"json_object\" }\r\n            });\r\n\r\n            const content = completion.choices[0].message.content || \"{}\";\r\n            return JSON.parse(cleanJsonString(content)) as SourceGuideData;\r\n\r\n        } catch (e) {\r\n            console.error(\"Failed to generate Source Guide:\", e);\r\n            return null;\r\n        }\r\n    }\r\n};\r\n","import React, { useState, useEffect } from 'react';\r\nimport { IconBook, IconSparkles, IconX, IconLoader } from '../icons';\r\nimport { CitationService } from '../services/citationService';\r\nimport { SourceGuideService } from '../services/sourceGuideService';\r\nimport type { SourceGuideData } from '../types/gemini.types';\r\nimport ReactMarkdown from 'react-markdown';\r\n// import remarkGfm from 'remark-gfm';\r\n\r\ninterface SourceViewerProps {\r\n    content: string;\r\n    onClose: () => void;\r\n    pdfSource?: string;\r\n}\r\n\r\nexport const SourceViewer: React.FC<SourceViewerProps> = ({ content, onClose, pdfSource }) => {\r\n    const [activeTab, setActiveTab] = useState<'text' | 'guide'>('text');\r\n    const [guideData, setGuideData] = useState<SourceGuideData | null>(null);\r\n    const [loadingGuide, setLoadingGuide] = useState(false);\r\n\r\n    // Auto-scroll to chunk if URL hash changes\r\n    useEffect(() => {\r\n        const handleHashChange = () => {\r\n            const hash = window.location.hash;\r\n            if (hash.startsWith('#chunk-')) {\r\n                const id = hash.replace('#', '');\r\n                const el = document.getElementById(id);\r\n                if (el) {\r\n                    setActiveTab('text'); // Ensure we are on text tab\r\n                    setTimeout(() => {\r\n                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n                        el.classList.add('bg-yellow-200');\r\n                        setTimeout(() => el.classList.remove('bg-yellow-200'), 2000);\r\n                    }, 100);\r\n                }\r\n            }\r\n        };\r\n\r\n        window.addEventListener('hashchange', handleHashChange);\r\n        return () => window.removeEventListener('hashchange', handleHashChange);\r\n    }, []);\r\n\r\n    const handleGenerateGuide = async () => {\r\n        if (guideData) return; // Already generated\r\n        setLoadingGuide(true);\r\n        const data = await SourceGuideService.generateGuide(content);\r\n        setGuideData(data);\r\n        setLoadingGuide(false);\r\n    };\r\n\r\n    // Auto-generate on first tab switch\r\n    useEffect(() => {\r\n        if (activeTab === 'guide' && !guideData && !loadingGuide) {\r\n            handleGenerateGuide();\r\n        }\r\n    }, [activeTab]);\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-gray-50 border-l border-gray-200 shadow-xl relative\">\r\n            {/* Header / Tabs */}\r\n            <div className=\"flex items-center justify-between px-4 py-3 bg-white border-b sticky top-0 z-10\">\r\n                <div className=\"flex gap-1 bg-gray-100 p-1 rounded-lg\">\r\n                    <button\r\n                        onClick={() => setActiveTab('text')}\r\n                        className={`px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'text' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}\r\n                    >\r\n                        <IconBook className=\"w-4 h-4\" />  \r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('guide')}\r\n                        className={`px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'guide' ? 'bg-white text-purple-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}\r\n                    >\r\n                        <IconSparkles className=\"w-4 h-4\" />  \r\n                    </button>\r\n                </div>\r\n                <button onClick={onClose} className=\"p-2 hover:bg-gray-100 rounded-full text-gray-500\">\r\n                    <IconX className=\"w-5 h-5\" />\r\n                </button>\r\n            </div>\r\n\r\n            {/* Content Area */}\r\n            <div className=\"flex-1 overflow-y-auto p-6 relative\">\r\n\r\n                {/* TAB: TEXT */}\r\n                {activeTab === 'text' && (\r\n                    <div className=\"prose max-w-none prose-sm prose-indigo leading-relaxed font-serif text-gray-800\">\r\n                        {pdfSource ? (\r\n                            <iframe src={pdfSource} className=\"w-full h-[800px] border-none\" title=\"PDF Source\" />\r\n                        ) : (\r\n                            CitationService.chunkText(content).map((chunk) => (\r\n                                <span\r\n                                    key={chunk.id}\r\n                                    id={`chunk-${chunk.id}`}\r\n                                    className=\"relative py-1 px-1 rounded transition-colors duration-1000 block md:inline hover:bg-yellow-50/50\"\r\n                                >\r\n                                    <sup className=\"text-gray-400 text-[10px] select-none pr-1\">[{chunk.id}]</sup>\r\n                                    {chunk.text + \" \"}\r\n                                </span>\r\n                            ))\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* TAB: GUIDE */}\r\n                {activeTab === 'guide' && (\r\n                    <div className=\"space-y-8 animate-fade-in\">\r\n                        {loadingGuide ? (\r\n                            <div className=\"text-center py-20 text-purple-600\">\r\n                                <IconLoader className=\"w-10 h-10 animate-spin mx-auto mb-4\" />\r\n                                <p className=\"font-bold\">  ...</p>\r\n                            </div>\r\n                        ) : guideData ? (\r\n                            <>\r\n                                {/* Summary */}\r\n                                <section>\r\n                                    <h3 className=\"text-xs font-bold uppercase tracking-widest text-gray-400 mb-3\"> </h3>\r\n                                    <div className=\"bg-white p-5 rounded-2xl shadow-sm border border-purple-100 text-gray-800 text-sm leading-7\">\r\n                                        <ReactMarkdown\r\n                                            children={guideData.summary.replace(/\\[(\\d+)\\]/g, '[$1](#chunk-$1)')}\r\n                                            components={{\r\n                                                a: ({ href, children }) => (\r\n                                                    <a\r\n                                                        href={href}\r\n                                                        onClick={(e) => {\r\n                                                            e.preventDefault();\r\n                                                            setActiveTab('text');\r\n                                                            window.location.hash = href || \"\";\r\n                                                        }}\r\n                                                        className=\"inline-flex items-center justify-center w-4 h-4 mx-1 text-[9px] font-bold text-purple-600 bg-purple-50 border border-purple-200 rounded-full hover:bg-purple-100 hover:scale-110 transition-all align-middle no-underline\"\r\n                                                    >\r\n                                                        {children}\r\n                                                    </a>\r\n                                                )\r\n                                            }}\r\n                                        />\r\n                                    </div>\r\n                                </section>\r\n\r\n                                {/* Topics */}\r\n                                <section>\r\n                                    <h3 className=\"text-xs font-bold uppercase tracking-widest text-gray-400 mb-3\"> </h3>\r\n                                    <div className=\"grid grid-cols-1 gap-3\">\r\n                                        {guideData.topics.map((t, i) => (\r\n                                            <div key={i} className=\"bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex gap-3 items-start\">\r\n                                                <div className=\"w-6 h-6 rounded-full bg-blue-50 text-blue-600 flex-shrink-0 flex items-center justify-center text-xs font-bold mt-0.5\">{i + 1}</div>\r\n                                                <div>\r\n                                                    <div className=\"font-bold text-gray-900 text-sm mb-1\">{t.term}</div>\r\n                                                    <div className=\"text-xs text-gray-500\">{t.definition}</div>\r\n                                                </div>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                </section>\r\n\r\n                                {/* FAQ */}\r\n                                <section>\r\n                                    <h3 className=\"text-xs font-bold uppercase tracking-widest text-gray-400 mb-3\"> </h3>\r\n                                    <div className=\"space-y-3\">\r\n                                        {guideData.faq.map((q, i) => (\r\n                                            <details key={i} className=\"group bg-white rounded-xl border border-gray-100 overflow-hidden\">\r\n                                                <summary className=\"p-4 cursor-pointer font-bold text-sm text-gray-800 flex justify-between items-center hover:bg-gray-50\">\r\n                                                    {q.question}\r\n                                                    <span className=\"group-open:rotate-180 transition-transform\"></span>\r\n                                                </summary>\r\n                                                <div className=\"p-4 pt-0 text-sm text-gray-600 leading-relaxed border-t border-gray-50\">\r\n                                                    {q.answer}\r\n                                                </div>\r\n                                            </details>\r\n                                        ))}\r\n                                    </div>\r\n                                </section>\r\n                            </>\r\n                        ) : (\r\n                            <div className=\"text-center py-10\">\r\n                                <p className=\"text-red-500\">  .</p>\r\n                                <button onClick={handleGenerateGuide} className=\"mt-4 text-blue-600 underline\"> </button>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","import { useState, useEffect, useCallback, useRef } from 'react';\r\n\r\n// Types\r\ninterface VersionEntry {\r\n  id: string;\r\n  content: any;\r\n  timestamp: number;\r\n  prompt?: string;\r\n}\r\n\r\ninterface BlockVersionHistory {\r\n  blockId: string;\r\n  unitId: string;\r\n  versions: VersionEntry[];\r\n  currentIndex: number;\r\n}\r\n\r\n// Constants\r\nconst MAX_VERSIONS = 5;\r\nconst STORAGE_PREFIX = 'ai-refine-history';\r\n\r\n/**\r\n * Custom hook for managing version history of AI refinements\r\n * Stores history in localStorage for persistence across sessions\r\n */\r\nexport function useVersionHistory(\r\n  unitId: string,\r\n  blockId: string,\r\n  currentContent: any,\r\n  onUpdate: (content: any) => void\r\n) {\r\n  const [history, setHistory] = useState<BlockVersionHistory | null>(null);\r\n  const isInitialized = useRef(false);\r\n  const storageKey = `${STORAGE_PREFIX}:${unitId}:${blockId}`;\r\n\r\n  // Load from localStorage on mount\r\n  useEffect(() => {\r\n    if (isInitialized.current) return;\r\n    isInitialized.current = true;\r\n\r\n    try {\r\n      const stored = localStorage.getItem(storageKey);\r\n      if (stored) {\r\n        const parsed = JSON.parse(stored) as BlockVersionHistory;\r\n        setHistory(parsed);\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to load version history:', err);\r\n    }\r\n  }, [storageKey]);\r\n\r\n  // Save to localStorage whenever history changes\r\n  useEffect(() => {\r\n    if (history) {\r\n      try {\r\n        localStorage.setItem(storageKey, JSON.stringify(history));\r\n      } catch (err) {\r\n        console.error('Failed to save version history:', err);\r\n      }\r\n    }\r\n  }, [history, storageKey]);\r\n\r\n  // Save new version after AI refinement\r\n  const saveVersion = useCallback((newContent: any, prompt?: string) => {\r\n    setHistory(prev => {\r\n      const newEntry: VersionEntry = {\r\n        id: crypto.randomUUID(),\r\n        content: JSON.parse(JSON.stringify(newContent)),\r\n        timestamp: Date.now(),\r\n        prompt\r\n      };\r\n\r\n      if (!prev) {\r\n        // First time - initialize with the new version\r\n        return {\r\n          blockId,\r\n          unitId,\r\n          versions: [newEntry],\r\n          currentIndex: 0\r\n        };\r\n      }\r\n\r\n      // If we're not at the end, we're creating a new branch\r\n      // Remove all versions after current index\r\n      const versionsUpToCurrent = prev.versions.slice(0, prev.currentIndex + 1);\r\n\r\n      // Add new version\r\n      let newVersions = [...versionsUpToCurrent, newEntry];\r\n\r\n      // Enforce max versions limit\r\n      if (newVersions.length > MAX_VERSIONS) {\r\n        newVersions = newVersions.slice(newVersions.length - MAX_VERSIONS);\r\n      }\r\n\r\n      return {\r\n        ...prev,\r\n        versions: newVersions,\r\n        currentIndex: newVersions.length - 1\r\n      };\r\n    });\r\n  }, [blockId, unitId]);\r\n\r\n  // Navigate to previous version\r\n  const goToPrevious = useCallback(() => {\r\n    if (!history || history.currentIndex <= 0) return;\r\n\r\n    const newIndex = history.currentIndex - 1;\r\n    const previousVersion = history.versions[newIndex];\r\n\r\n    setHistory(prev => prev ? { ...prev, currentIndex: newIndex } : null);\r\n    onUpdate(JSON.parse(JSON.stringify(previousVersion.content)));\r\n  }, [history, onUpdate]);\r\n\r\n  // Navigate to next version\r\n  const goToNext = useCallback(() => {\r\n    if (!history || history.currentIndex >= history.versions.length - 1) return;\r\n\r\n    const newIndex = history.currentIndex + 1;\r\n    const nextVersion = history.versions[newIndex];\r\n\r\n    setHistory(prev => prev ? { ...prev, currentIndex: newIndex } : null);\r\n    onUpdate(JSON.parse(JSON.stringify(nextVersion.content)));\r\n  }, [history, onUpdate]);\r\n\r\n  // Computed values\r\n  const canGoBack = history ? history.currentIndex > 0 : false;\r\n  const canGoForward = history ? history.currentIndex < history.versions.length - 1 : false;\r\n  const currentVersionNumber = history ? history.currentIndex + 1 : 0;\r\n  const totalVersions = history ? history.versions.length : 0;\r\n  const hasHistory = totalVersions > 0;\r\n\r\n  return {\r\n    saveVersion,\r\n    goToPrevious,\r\n    goToNext,\r\n    canGoBack,\r\n    canGoForward,\r\n    currentVersionNumber,\r\n    totalVersions,\r\n    hasHistory\r\n  };\r\n}\r\n","import React, { useState, useEffect, useRef } from 'react';\r\nimport { IconSparkles, IconWand, IconX, IconCheck, IconChevronLeft, IconChevronRight } from '../icons';\r\nimport { refineBlockContent, refineActivityIntroImage } from '../services/ai/geminiApi';\r\nimport { useVersionHistory } from '../hooks/useVersionHistory';\r\n\r\ninterface AiRefineToolbarProps {\r\n    blockId: string;\r\n    blockType: string;\r\n    content: any;\r\n    onUpdate: (newContent: any) => void;\r\n    className?: string;\r\n    unitId?: string; // Required for version history\r\n}\r\n\r\n/**\r\n * Generate a smart default prompt suggestion based on block type and content\r\n * Returns a focused, minimal prompt - favors refinement over expansion\r\n */\r\nconst generateDefaultPrompt = (blockType: string, content: any): string => {\r\n    // Check if content exists and has substance\r\n    const hasContent = (): boolean => {\r\n        if (!content) return false;\r\n        if (typeof content === 'string') return content.trim().length > 0;\r\n        if (content.question) return content.question.trim().length > 0;\r\n        if (content.text) return content.text.trim().length > 0;\r\n        if (content.pairs?.length > 0) return true;\r\n        if (content.items?.length > 0) return true;\r\n        if (content.correct_order?.length > 0) return true;\r\n        return false;\r\n    };\r\n\r\n    // If no content, suggest creation; otherwise suggest refinement\r\n    if (!hasContent()) {\r\n        // Empty content - suggest creating\r\n        switch (blockType) {\r\n            case 'multiple_choice':\r\n            case 'multipleChoice':\r\n            case 'multiple-choice':\r\n                return `  -  4 `;\r\n            case 'open_question':\r\n            case 'openQuestion':\r\n            case 'open-question':\r\n                return `  `;\r\n            case 'matching':\r\n                return ` 5  `;\r\n            case 'sorting':\r\n            case 'ordering':\r\n                return `   5 `;\r\n            case 'fill_blanks':\r\n            case 'fillBlanks':\r\n            case 'fill_in_blanks':\r\n                return `    `;\r\n            case 'categorization':\r\n                return ` 2   `;\r\n            case 'memory_game':\r\n                return ` 6   `;\r\n            case 'true_false_speed':\r\n                return ` 5  /`;\r\n            default:\r\n                return `   `;\r\n        }\r\n    }\r\n\r\n    // Content exists - suggest refinement (not expansion!)\r\n    // Return empty string so the user writes their own specific instruction\r\n    return '';\r\n};\r\n\r\nexport const AiRefineToolbar: React.FC<AiRefineToolbarProps> = ({ blockId, blockType, content, onUpdate, className, unitId }) => {\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const [instruction, setInstruction] = useState(\"\");\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [success, setSuccess] = useState(false);\r\n\r\n    // Store user's custom prompt to preserve it across open/close\r\n    const userEditedPromptRef = useRef<string | null>(null);\r\n\r\n    // Version history hook - only active when unitId is provided\r\n    const {\r\n        saveVersion,\r\n        goToPrevious,\r\n        goToNext,\r\n        canGoBack,\r\n        canGoForward,\r\n        currentVersionNumber,\r\n        totalVersions,\r\n        hasHistory\r\n    } = useVersionHistory(unitId || '', blockId, content, onUpdate);\r\n\r\n    // When opening the panel, set default prompt if user hasn't edited one\r\n    useEffect(() => {\r\n        if (isOpen && instruction === \"\") {\r\n            // If user previously edited a prompt, restore it; otherwise generate default\r\n            if (userEditedPromptRef.current !== null) {\r\n                setInstruction(userEditedPromptRef.current);\r\n            } else {\r\n                setInstruction(generateDefaultPrompt(blockType, content));\r\n            }\r\n        }\r\n    }, [isOpen, blockType, content]);\r\n\r\n    // Track user edits to preserve them\r\n    const handleInstructionChange = (value: string) => {\r\n        setInstruction(value);\r\n        userEditedPromptRef.current = value;\r\n    };\r\n\r\n    const handleRefine = async () => {\r\n        if (!instruction.trim()) return;\r\n\r\n        setIsLoading(true);\r\n        setError(null);\r\n\r\n        try {\r\n            console.log(` Refining block ${blockId} (${blockType})...`);\r\n\r\n            let refinedContent;\r\n\r\n            // Special handling for activity-intro - generates new image\r\n            if (blockType === 'activity-intro') {\r\n                refinedContent = await refineActivityIntroImage(content, instruction);\r\n                if (!refinedContent) {\r\n                    throw new Error('Failed to generate new image');\r\n                }\r\n            } else {\r\n                refinedContent = await refineBlockContent(blockType, content, instruction);\r\n            }\r\n\r\n            // Check if content actually changed\r\n            if (JSON.stringify(refinedContent) === JSON.stringify(content)) {\r\n                // Content didn't change - show warning to user\r\n                setError(\"  .       .\");\r\n                return;\r\n            }\r\n\r\n            // Save to version history (if unitId provided)\r\n            if (unitId) {\r\n                saveVersion(refinedContent, instruction);\r\n            }\r\n\r\n            onUpdate(refinedContent);\r\n            setSuccess(true);\r\n            setTimeout(() => {\r\n                setSuccess(false);\r\n                setIsOpen(false);\r\n                // Don't reset instruction - preserve user's prompt for next time\r\n            }, 1000);\r\n\r\n        } catch (err) {\r\n            console.error(\"Refine failed\", err);\r\n            setError(\"  .  .\");\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    if (!isOpen) {\r\n        return (\r\n            <div className={`flex items-center gap-2 justify-end ${className || ''}`}>\r\n                <button\r\n                    onClick={() => setIsOpen(true)}\r\n                    className=\"flex items-center gap-2 text-xs font-bold px-3 py-1.5 rounded-lg border transition-all shadow-sm\r\n                    bg-gradient-to-r from-violet-100 to-fuchsia-100 text-purple-700 border-purple-200 hover:from-violet-200 hover:to-fuchsia-200\"\r\n                    title=\"       \"\r\n                >\r\n                    <IconSparkles className=\"w-3 h-3 text-purple-600\" />\r\n                      AI\r\n                </button>\r\n\r\n                {/* Version history navigation - shows when there are saved versions */}\r\n                {hasHistory && totalVersions > 1 && (\r\n                    <div className=\"flex items-center gap-1 text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1\">\r\n                        <button\r\n                            onClick={goToPrevious}\r\n                            disabled={!canGoBack}\r\n                            className={`p-1 rounded-full transition-colors ${\r\n                                canGoBack\r\n                                    ? 'hover:bg-gray-200 text-gray-600'\r\n                                    : 'text-gray-300 cursor-not-allowed'\r\n                            }`}\r\n                            title=\" \"\r\n                        >\r\n                            <IconChevronRight className=\"w-3 h-3\" />\r\n                        </button>\r\n\r\n                        <span className=\"font-medium min-w-[32px] text-center text-gray-600\">\r\n                            {currentVersionNumber}/{totalVersions}\r\n                        </span>\r\n\r\n                        <button\r\n                            onClick={goToNext}\r\n                            disabled={!canGoForward}\r\n                            className={`p-1 rounded-full transition-colors ${\r\n                                canGoForward\r\n                                    ? 'hover:bg-gray-200 text-gray-600'\r\n                                    : 'text-gray-300 cursor-not-allowed'\r\n                            }`}\r\n                            title=\" \"\r\n                        >\r\n                            <IconChevronLeft className=\"w-3 h-3\" />\r\n                        </button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className={`mt-2 p-3 bg-gradient-to-br from-violet-50 to-white rounded-xl border border-purple-100 shadow-lg animate-scale-in relative ${className || ''}`}>\r\n            {/* Header */}\r\n            <div className=\"flex justify-between items-center mb-2\">\r\n                <div className=\"flex items-center gap-1.5 text-purple-700 font-bold text-xs\">\r\n                    <IconWand className=\"w-3 h-3\" />\r\n                    <span>  ?</span>\r\n                </div>\r\n                <button\r\n                    onClick={() => setIsOpen(false)}\r\n                    className=\"text-gray-400 hover:text-red-500 hover:bg-red-50 p-1 rounded-full transition-colors\"\r\n                >\r\n                    <IconX className=\"w-3 h-3\" />\r\n                </button>\r\n            </div>\r\n\r\n            {/* Input Area - Larger textarea to show full paragraph */}\r\n            <div className=\"relative\">\r\n                <textarea\r\n                    value={instruction}\r\n                    onChange={(e) => handleInstructionChange(e.target.value)}\r\n                    placeholder=\"    , : '   ', '  ', '  '...\"\r\n                    className=\"w-full min-w-[350px] text-sm p-3 pr-2 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-200 focus:border-purple-300 min-h-[100px] resize-y bg-white/80\"\r\n                    disabled={isLoading}\r\n                    autoFocus\r\n                    onKeyDown={(e) => {\r\n                        if (e.key === 'Enter' && !e.shiftKey) {\r\n                            e.preventDefault();\r\n                            handleRefine();\r\n                        }\r\n                    }}\r\n                />\r\n                <div className=\"text-[10px] text-gray-400 mt-1\">\r\n                    :    ,      \r\n                </div>\r\n            </div>\r\n\r\n            {/* Actions / Status */}\r\n            <div className=\"flex justify-between items-center mt-2\">\r\n                <div className=\"text-xs\">\r\n                    {error && <span className=\"text-red-500 font-medium\">{error}</span>}\r\n                    {success && <span className=\"text-green-600 font-bold flex items-center gap-1\"><IconCheck className=\"w-3 h-3\" />  !</span>}\r\n                </div>\r\n\r\n                <button\r\n                    onClick={handleRefine}\r\n                    disabled={!instruction.trim() || isLoading}\r\n                    className={`px-4 py-1.5 rounded-lg text-xs font-bold text-white shadow-sm flex items-center gap-2 transition-all\r\n                    ${success ? 'bg-green-500' : 'bg-purple-600 hover:bg-purple-700'} \r\n                    ${(!instruction.trim() || isLoading) ? 'opacity-50 cursor-not-allowed' : 'hover:-translate-y-0.5'}`}\r\n                >\r\n                    {isLoading ? (\r\n                        <>\r\n                            <div className=\"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div>\r\n                            ...\r\n                        </>\r\n                    ) : (\r\n                        <>\r\n                            <IconSparkles className=\"w-3 h-3\" />\r\n                            {success ? '' : ''}\r\n                        </>\r\n                    )}\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"absolute -top-1 right-6 w-3 h-3 bg-violet-50 border-t border-l border-purple-100 transform rotate-45 -translate-y-1/2\"></div>\r\n        </div>\r\n    );\r\n};\r\n","import { db, storage } from \"./firebase\";\r\nimport { doc, getDoc, setDoc, writeBatch, collection, getDocs } from \"firebase/firestore\";\r\nimport { ref, uploadBytes, getDownloadURL } from \"firebase/storage\";\r\nimport type { Course } from \"./shared/types/courseTypes\";\r\n\r\n// Debounce state for saveCourseToFirestore\r\nconst SAVE_DEBOUNCE_MS = 2500;\r\nlet saveTimeout: NodeJS.Timeout | null = null;\r\nlet pendingCourse: Course | null = null;\r\n\r\n//       (   undefined -Firestore)\r\n// Handles: undefined, Date objects, functions, circular references, custom classes\r\nconst cleanDataForFirestore = (data: any): any => {\r\n    // Use JSON.parse/stringify to handle most edge cases (undefined, functions, circular refs, Date->string)\r\n    // Then do a second pass to convert Date strings back if needed or handle remaining issues\r\n    try {\r\n        return JSON.parse(JSON.stringify(data, (key, value) => {\r\n            // Convert undefined to null (JSON.stringify would remove it)\r\n            if (value === undefined) return null;\r\n            // Convert Date objects to ISO strings\r\n            if (value instanceof Date) return value.toISOString();\r\n            // Skip functions\r\n            if (typeof value === 'function') return undefined;\r\n            return value;\r\n        }));\r\n    } catch (e) {\r\n        // Fallback for circular references or other issues\r\n        console.warn(\"cleanDataForFirestore fallback used:\", e);\r\n        if (Array.isArray(data)) {\r\n            return data.map(cleanDataForFirestore);\r\n        } else if (data !== null && typeof data === 'object') {\r\n            if (data instanceof Date) return data.toISOString();\r\n            return Object.entries(data).reduce((acc, [key, value]) => {\r\n                if (value !== undefined && typeof value !== 'function') {\r\n                    acc[key] = cleanDataForFirestore(value);\r\n                }\r\n                return acc;\r\n            }, {} as any);\r\n        }\r\n        return data;\r\n    }\r\n};\r\n\r\n// Internal function that actually performs the save\r\nconst executeSave = async (course: Course) => {\r\n    const batch = writeBatch(db);\r\n    const courseRef = doc(db, \"courses\", course.id);\r\n\r\n    // 1. Prepare Main Course Document (Lightweight)\r\n    const lightweightSyllabus = course.syllabus.map(module => ({\r\n        ...module,\r\n        learningUnits: module.learningUnits.map(unit => ({\r\n            id: unit.id,\r\n            title: unit.title,\r\n            type: unit.type,\r\n            isLazy: true, // Marker for new schema\r\n            // Strip heavy content\r\n            baseContent: null,\r\n            activityBlocks: [],\r\n            audioOverview: null\r\n        }))\r\n    }));\r\n\r\n    const cleanCourseMain = cleanDataForFirestore({\r\n        ...course,\r\n        syllabus: lightweightSyllabus,\r\n        updatedAt: new Date().toISOString()\r\n    });\r\n\r\n    batch.set(courseRef, cleanCourseMain, { merge: true });\r\n\r\n    // 2. Prepare Unit Documents (Sub-collection)\r\n    course.syllabus.forEach(module => {\r\n        module.learningUnits.forEach(unit => {\r\n            if (unit.id) {\r\n                const unitRef = doc(db, \"courses\", course.id, \"units\", unit.id);\r\n                const cleanUnit = cleanDataForFirestore(unit);\r\n                batch.set(unitRef, cleanUnit, { merge: true });\r\n            }\r\n        });\r\n    });\r\n\r\n    await batch.commit();\r\n    console.log(\" Lesson plan (split) saved successfully:\", course.id);\r\n};\r\n\r\n//  /  (Split to Sub-collections) - WITH DEBOUNCE\r\nexport const saveCourseToFirestore = async (course: Course): Promise<void> => {\r\n    if (!course.id) throw new Error(\"Course ID is missing\");\r\n\r\n    // Store the latest course to save\r\n    pendingCourse = course;\r\n\r\n    // Return a promise that resolves when the debounced save completes\r\n    return new Promise((resolve, reject) => {\r\n        // Clear existing timeout\r\n        if (saveTimeout) {\r\n            clearTimeout(saveTimeout);\r\n        }\r\n\r\n        // Set new debounced save\r\n        saveTimeout = setTimeout(async () => {\r\n            const courseToSave = pendingCourse;\r\n            if (!courseToSave) {\r\n                resolve();\r\n                return;\r\n            }\r\n\r\n            try {\r\n                await executeSave(courseToSave);\r\n                pendingCourse = null;\r\n                resolve();\r\n            } catch (error) {\r\n                console.error(\"Error saving lesson plan:\", error);\r\n                reject(error);\r\n            }\r\n        }, SAVE_DEBOUNCE_MS);\r\n    });\r\n};\r\n\r\n// Force immediate save (use sparingly - for critical saves like wizard completion)\r\nexport const saveCourseToFirestoreImmediate = async (course: Course): Promise<void> => {\r\n    if (!course.id) throw new Error(\"Course ID is missing\");\r\n\r\n    // Clear any pending debounced save\r\n    if (saveTimeout) {\r\n        clearTimeout(saveTimeout);\r\n        saveTimeout = null;\r\n    }\r\n    pendingCourse = null;\r\n\r\n    try {\r\n        await executeSave(course);\r\n    } catch (error) {\r\n        console.error(\"Error saving lesson plan:\", error);\r\n        throw error;\r\n    }\r\n};\r\n\r\n//    (Granular Update)\r\nexport const saveUnitToFirestore = async (courseId: string, unit: any) => {\r\n    if (!courseId || !unit.id) throw new Error(\"Missing Course ID or Unit ID\");\r\n\r\n    const unitRef = doc(db, \"courses\", courseId, \"units\", unit.id);\r\n    const cleanUnit = cleanDataForFirestore(unit);\r\n\r\n    try {\r\n        await setDoc(unitRef, cleanUnit, { merge: true });\r\n        console.log(`Unit ${unit.id} saved to sub-collection.`);\r\n    } catch (error) {\r\n        console.error(`Error saving unit ${unit.id}:`, error);\r\n        throw error;\r\n    }\r\n};\r\n\r\n//   (   /-)\r\nexport const getCourseFromFirestore = async (courseId: string): Promise<Course | null> => {\r\n    try {\r\n        const docRef = doc(db, \"courses\", courseId);\r\n        const docSnap = await getDoc(docRef);\r\n\r\n        if (docSnap.exists()) {\r\n            const courseData = docSnap.data() as Course;\r\n\r\n            //      (Lazy)\r\n            const hasLazyUnits = courseData.syllabus?.some(m => m.learningUnits?.some(u => (u as any).isLazy));\r\n\r\n            if (hasLazyUnits) {\r\n                console.log(\"Loading lazy units for course:\", courseId);\r\n                //    -\r\n                //  :     (Lazy Loading )\r\n                const unitsRef = collection(db, \"courses\", courseId, \"units\");\r\n                const unitsSnap = await getDocs(unitsRef);\r\n\r\n                const unitsMap = new Map();\r\n                unitsSnap.forEach(doc => {\r\n                    unitsMap.set(doc.id, doc.data());\r\n                });\r\n\r\n                //     \r\n                courseData.syllabus = courseData.syllabus.map(module => ({\r\n                    ...module,\r\n                    learningUnits: module.learningUnits.map(unit => {\r\n                        if ((unit as any).isLazy && unitsMap.has(unit.id)) {\r\n                            // :     ,     \r\n                            return unitsMap.get(unit.id) as any;\r\n                        }\r\n                        return unit;\r\n                    })\r\n                }));\r\n            }\r\n\r\n            return courseData;\r\n        } else {\r\n            console.log(\"No such document!\");\r\n            return null;\r\n        }\r\n    } catch (error) {\r\n        console.error(\"Error getting document:\", error);\r\n        throw error;\r\n    }\r\n};\r\n\r\n// ---    (/) ---\r\nexport const uploadMediaFile = async (file: File, folder: string = 'media'): Promise<string> => {\r\n    if (!file) throw new Error(\"No file provided\");\r\n\r\n    //   \r\n    const isVideo = file.type.startsWith('video/');\r\n    const maxSize = isVideo ? 50 * 1024 * 1024 : 5 * 1024 * 1024; // 50MB , 5MB \r\n\r\n    if (file.size > maxSize) {\r\n        throw new Error(`  .  : ${isVideo ? '50MB' : '5MB'}`);\r\n    }\r\n\r\n    //     Timestamp   \r\n    const storagePath = `course_assets/${folder}/${Date.now()}_${file.name}`;\r\n    const storageRef = ref(storage, storagePath);\r\n\r\n    // :   metadata  contentType   Storage \r\n    const metadata = {\r\n        contentType: file.type || 'application/octet-stream',\r\n    };\r\n\r\n    try {\r\n        const snapshot = await uploadBytes(storageRef, file, metadata);\r\n        const downloadURL = await getDownloadURL(snapshot.ref);\r\n        return downloadURL;\r\n    } catch (error) {\r\n        console.error(\"Upload failed:\", error);\r\n        throw error;\r\n    }\r\n};","/**\r\n * Media Budget Manager\r\n * Ensures balanced media distribution in lessons:\r\n * - ONE curiosity-provoking image in Hook (always)\r\n * - ONE infographic in Summary (always)\r\n * - No media in slides (teacher uses whiteboard)\r\n *\r\n * Total: 1-0-1 pattern (Hook image, no slides media, Summary infographic)\r\n */\r\n\r\nimport type { InfographicType } from '../services/ai/geminiApi';\r\n\r\n// --- Types ---\r\n\r\nexport interface MediaPlan {\r\n    hook_video_query: string | null;\r\n    summary_infographic_type: InfographicType;\r\n    summary_infographic_description: string;\r\n}\r\n\r\nexport interface MediaBudget {\r\n    maxHookImages: 1;      // One curiosity image in hook (always)\r\n    maxInfographics: 1;    // One infographic in summary (always)\r\n    maxSlideImages: 0;     // No images in slides (teacher uses whiteboard)\r\n}\r\n\r\nexport interface MediaUsage {\r\n    youtubeVideos: number;\r\n    infographics: number;\r\n    images: number;\r\n}\r\n\r\n// --- Constants ---\r\n\r\nexport const DEFAULT_MEDIA_BUDGET: MediaBudget = {\r\n    maxHookImages: 1,\r\n    maxInfographics: 1,\r\n    maxSlideImages: 0\r\n};\r\n\r\n// --- Functions ---\r\n\r\n/**\r\n * Validate media plan against budget\r\n */\r\nexport const validateMediaPlan = (plan: MediaPlan): { valid: boolean; warnings: string[] } => {\r\n    const warnings: string[] = [];\r\n\r\n    // Check infographic type\r\n    const validTypes: InfographicType[] = ['flowchart', 'timeline', 'comparison', 'cycle'];\r\n    if (!validTypes.includes(plan.summary_infographic_type)) {\r\n        warnings.push(`Invalid infographic type: ${plan.summary_infographic_type}. Defaulting to flowchart.`);\r\n    }\r\n\r\n    // Check description\r\n    if (!plan.summary_infographic_description || plan.summary_infographic_description.length < 10) {\r\n        warnings.push('Infographic description is too short. May result in generic output.');\r\n    }\r\n\r\n    return {\r\n        valid: warnings.length === 0,\r\n        warnings\r\n    };\r\n};\r\n\r\n/**\r\n * Get recommended infographic type based on content analysis\r\n */\r\nexport const suggestInfographicType = (content: string): InfographicType => {\r\n    const lowerContent = content.toLowerCase();\r\n\r\n    // Process indicators\r\n    const processKeywords = ['', '', '', '', '', '', ''];\r\n    const processScore = processKeywords.filter(k => lowerContent.includes(k)).length;\r\n\r\n    // Timeline indicators\r\n    const timelineKeywords = ['', '', '', '', '', '', '', ''];\r\n    const timelineScore = timelineKeywords.filter(k => lowerContent.includes(k)).length;\r\n    const hasYears = /\\b(19|20)\\d{2}\\b/.test(content); // Years like 1948, 2024\r\n\r\n    // Comparison indicators\r\n    const comparisonKeywords = ['', '', '', 'vs', '', '', '', '', ''];\r\n    const comparisonScore = comparisonKeywords.filter(k => lowerContent.includes(k)).length;\r\n\r\n    // Cycle indicators\r\n    const cycleKeywords = ['', '', '', '', '', ''];\r\n    const cycleScore = cycleKeywords.filter(k => lowerContent.includes(k)).length;\r\n\r\n    // Calculate scores\r\n    const scores = {\r\n        flowchart: processScore,\r\n        timeline: timelineScore + (hasYears ? 2 : 0),\r\n        comparison: comparisonScore,\r\n        cycle: cycleScore\r\n    };\r\n\r\n    // Find highest score\r\n    const maxScore = Math.max(...Object.values(scores));\r\n    if (maxScore === 0) {\r\n        return 'flowchart'; // Default\r\n    }\r\n\r\n    const winner = Object.entries(scores).find(([_, score]) => score === maxScore);\r\n    return (winner?.[0] as InfographicType) || 'flowchart';\r\n};\r\n\r\n/**\r\n * Create media plan from lesson content\r\n */\r\nexport const createMediaPlanFromContent = (\r\n    lessonTitle: string,\r\n    lessonContent: string,\r\n    objectives: string[]\r\n): MediaPlan => {\r\n    // Suggest infographic type\r\n    const infographicType = suggestInfographicType(lessonContent);\r\n\r\n    // Create description based on objectives\r\n    const objectivesText = objectives.length > 0\r\n        ? objectives.join(', ')\r\n        : lessonTitle;\r\n\r\n    const typeDescriptions: Record<InfographicType, string> = {\r\n        flowchart: `       ${objectivesText}`,\r\n        timeline: `       ${objectivesText}`,\r\n        comparison: `      ${objectivesText}`,\r\n        cycle: `       ${objectivesText}`\r\n    };\r\n\r\n    return {\r\n        hook_video_query: `${lessonTitle}  `,\r\n        summary_infographic_type: infographicType,\r\n        summary_infographic_description: typeDescriptions[infographicType]\r\n    };\r\n};\r\n\r\n/**\r\n * Check if media budget allows more of a specific type\r\n */\r\nexport const canAddMedia = (\r\n    type: 'youtube' | 'infographic' | 'image',\r\n    currentUsage: MediaUsage,\r\n    budget: MediaBudget = DEFAULT_MEDIA_BUDGET\r\n): boolean => {\r\n    switch (type) {\r\n        case 'youtube':\r\n            return currentUsage.youtubeVideos < budget.maxYouTubeVideos;\r\n        case 'infographic':\r\n            return currentUsage.infographics < budget.maxInfographics;\r\n        case 'image':\r\n            return currentUsage.images < budget.maxImages;\r\n        default:\r\n            return false;\r\n    }\r\n};\r\n\r\n/**\r\n * Get media usage summary for display\r\n */\r\nexport const getMediaUsageSummary = (usage: MediaUsage): string => {\r\n    const parts: string[] = [];\r\n\r\n    if (usage.youtubeVideos > 0) {\r\n        parts.push(` ${usage.youtubeVideos} `);\r\n    }\r\n    if (usage.infographics > 0) {\r\n        parts.push(` ${usage.infographics} `);\r\n    }\r\n    if (usage.images > 0) {\r\n        parts.push(` ${usage.images} `);\r\n    }\r\n\r\n    return parts.length > 0 ? parts.join(' | ') : ' ';\r\n};\r\n\r\n// ============ ACTIVITY MEDIA BUDGET ============\r\n// For standalone student activities (not lesson plans)\r\n// Strategy: Images provide \"the why\" (meaning), UI provides \"the fun\" (stars/gamification)\r\n\r\n/**\r\n * Activity Media Budget Configuration\r\n * - 1 Context Image (opening): Places student in professional/realistic situation\r\n * - 0-2 Scenario Images: Only for application questions that need visualization\r\n * - Total max: 3 images per activity\r\n */\r\nexport interface ActivityMediaBudget {\r\n    maxContextImages: 1;        // Opening image - mandatory\r\n    maxScenarioImages: 2;       // In-question images - only for application level\r\n    totalMaxImages: 3;          // Hard limit\r\n}\r\n\r\nexport interface ActivityMediaPlan {\r\n    contextImage: {\r\n        prompt: string;         // Gemini prompt for context image\r\n        description: string;    // Hebrew description for accessibility\r\n    };\r\n    scenarioImages: Array<{\r\n        blockId: string;        // Which question block needs this image\r\n        prompt: string;         // Gemini prompt\r\n        description: string;    // Hebrew description\r\n    }>;\r\n}\r\n\r\nexport interface ActivityMediaUsage {\r\n    contextImages: number;\r\n    scenarioImages: number;\r\n}\r\n\r\nexport const DEFAULT_ACTIVITY_MEDIA_BUDGET: ActivityMediaBudget = {\r\n    maxContextImages: 1,\r\n    maxScenarioImages: 2,\r\n    totalMaxImages: 3\r\n};\r\n\r\n/**\r\n * Bloom's Taxonomy levels that warrant scenario images\r\n * Only application+ levels benefit from visualization\r\n * Strategy: Images show \"the dilemma\" - a situation before intervention\r\n */\r\nconst APPLICATION_TAXONOMY_LEVELS = ['application', 'analysis', 'evaluation', 'creation'];\r\n\r\n/**\r\n * Question types that benefit from scenario images\r\n * These types typically present a situation that needs student intervention\r\n */\r\nconst SCENARIO_QUESTION_TYPES = ['multiple-choice', 'open-question'];\r\n\r\n/**\r\n * Determines if a question block should have a scenario image\r\n *\r\n * Strategy (from product requirements):\r\n * - Context image (opening): Always created, places student in professional setting\r\n * - Scenario images: Only for application+ level questions that benefit from visualization\r\n *\r\n * The key insight: UI provides \"the fun\" (stars/gamification),\r\n * images provide \"the why\" (meaning/context for the problem)\r\n */\r\nexport const shouldAddScenarioImage = (\r\n    questionText: string,\r\n    taxonomyLevel?: string,\r\n    currentUsage: ActivityMediaUsage = { contextImages: 0, scenarioImages: 0 },\r\n    questionType?: string\r\n): boolean => {\r\n    // Check budget - max 2 scenario images\r\n    if (currentUsage.scenarioImages >= DEFAULT_ACTIVITY_MEDIA_BUDGET.maxScenarioImages) {\r\n        return false;\r\n    }\r\n\r\n    // Check total budget - max 3 images total (1 context + 2 scenario)\r\n    const totalUsed = currentUsage.contextImages + currentUsage.scenarioImages;\r\n    if (totalUsed >= DEFAULT_ACTIVITY_MEDIA_BUDGET.totalMaxImages) {\r\n        return false;\r\n    }\r\n\r\n    // Primary criterion: Bloom's taxonomy level must be application or higher\r\n    // This is the main filter - only application+ questions benefit from scenario visualization\r\n    if (!taxonomyLevel || !APPLICATION_TAXONOMY_LEVELS.includes(taxonomyLevel.toLowerCase())) {\r\n        return false;\r\n    }\r\n\r\n    // Secondary criterion: Question type should benefit from visualization\r\n    // Categorization questions usually don't need scenario images (the items ARE the visual)\r\n    if (questionType && !SCENARIO_QUESTION_TYPES.includes(questionType)) {\r\n        return false;\r\n    }\r\n\r\n    // If we reach here, the question is application+ level and a suitable type\r\n    return true;\r\n};\r\n\r\n/**\r\n * Creates a context image prompt for activity opening\r\n * Places student in professional/realistic situation related to topic\r\n */\r\nexport const createContextImagePrompt = (\r\n    topic: string,\r\n    subject: string,\r\n    gradeLevel: string\r\n): string => {\r\n    const subjectContexts: Record<string, string> = {\r\n        '': ', ,   ',\r\n        '': ', ,   ',\r\n        '': ' ,  ,  ',\r\n        '': ', ,  ',\r\n        '': ', ,    ',\r\n        '': ', ,   ',\r\n        '': ' , ,   ',\r\n        '\"': ',   ,   '\r\n    };\r\n\r\n    const professionalContext = subjectContexts[subject] || ' ';\r\n\r\n    return `Create an educational illustration showing a ${professionalContext} in a realistic professional setting related to \"${topic}\".\r\nThe scene should:\r\n- Show a person actively working (not posed)\r\n- Include relevant professional tools or environment\r\n- Be age-appropriate for grade ${gradeLevel} students\r\n- Convey \"you are the expert\" feeling\r\n- CRITICAL: NO TEXT AT ALL - no labels, no signs, no writing, no letters, no words in any language\r\n- Warm, inviting colors\r\n- Semi-realistic style (not cartoon, not photorealistic)`;\r\n};\r\n\r\n/**\r\n * Creates a scenario image prompt for application questions\r\n * Shows a situation that needs student's intervention/solution\r\n */\r\nexport const createScenarioImagePrompt = (\r\n    questionText: string,\r\n    topic: string\r\n): string => {\r\n    return `Create an educational illustration showing a problem situation related to \"${topic}\".\r\nThe scene should:\r\n- Depict a moment BEFORE resolution (the problem state)\r\n- Show visual tension or something that needs fixing\r\n- Be clear enough that students can identify what's wrong\r\n- CRITICAL: NO TEXT AT ALL - no labels, no signs, no writing, no letters, no words in any language\r\n- Related to this question context: \"${questionText.slice(0, 100)}...\"\r\n- Semi-realistic educational style`;\r\n};\r\n\r\n/**\r\n * Creates complete activity media plan based on topic and questions\r\n */\r\nexport const createActivityMediaPlan = (\r\n    topic: string,\r\n    subject: string,\r\n    gradeLevel: string,\r\n    questions: Array<{ id: string; text: string; taxonomy?: string; type?: string }>\r\n): ActivityMediaPlan => {\r\n    const usage: ActivityMediaUsage = { contextImages: 1, scenarioImages: 0 };\r\n\r\n    // Always create context image\r\n    const contextImage = {\r\n        prompt: createContextImagePrompt(topic, subject, gradeLevel),\r\n        description: ` : ${subject} - ${topic}`\r\n    };\r\n\r\n    // Check which questions need scenario images\r\n    const scenarioImages: ActivityMediaPlan['scenarioImages'] = [];\r\n\r\n    for (const question of questions) {\r\n        if (shouldAddScenarioImage(question.text, question.taxonomy, usage, question.type)) {\r\n            scenarioImages.push({\r\n                blockId: question.id,\r\n                prompt: createScenarioImagePrompt(question.text, topic),\r\n                description: `  : ${question.text.slice(0, 50)}...`\r\n            });\r\n            usage.scenarioImages++;\r\n        }\r\n    }\r\n\r\n    return { contextImage, scenarioImages };\r\n};\r\n\r\n/**\r\n * Get activity media usage summary\r\n */\r\nexport const getActivityMediaSummary = (usage: ActivityMediaUsage): string => {\r\n    const total = usage.contextImages + usage.scenarioImages;\r\n    if (total === 0) return ' ';\r\n\r\n    const parts: string[] = [];\r\n    if (usage.contextImages > 0) {\r\n        parts.push(`  `);\r\n    }\r\n    if (usage.scenarioImages > 0) {\r\n        parts.push(` ${usage.scenarioImages}  `);\r\n    }\r\n\r\n    return parts.join(' + ');\r\n};\r\n","/**\r\n * Activity Media Service\r\n *\r\n * Handles image generation for standalone student activities.\r\n * Strategy: Images provide \"the why\" (meaning), UI provides \"the fun\" (stars)\r\n *\r\n * Budget: 1 context image (opening) + 0-2 scenario images (in questions)\r\n * Total max: 3 images per activity\r\n */\r\n\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { generateGeminiImage } from './ai/imagenService';\r\nimport { uploadGeneratedImage } from './storageService';\r\nimport {\r\n    createActivityMediaPlan,\r\n    shouldAddScenarioImage,\r\n    type ActivityMediaPlan,\r\n    type ActivityMediaUsage\r\n} from '../utils/mediaBudget';\r\nimport type { ActivityBlock, ActivityIntroContent, ScenarioImageContent, LearningUnit } from '../shared/types/courseTypes';\r\n\r\n// Progress callback for UI feedback\r\nexport type MediaProgressCallback = (step: string, current: number, total: number) => void;\r\n\r\n/**\r\n * Enriches an activity with context and scenario images\r\n * Call this after activity generation is complete\r\n */\r\nexport const enrichActivityWithImages = async (\r\n    unit: LearningUnit,\r\n    topic: string,\r\n    subject: string,\r\n    gradeLevel: string,\r\n    onProgress?: MediaProgressCallback\r\n): Promise<LearningUnit> => {\r\n    const blocks = unit.activityBlocks || [];\r\n    if (blocks.length === 0) return unit;\r\n\r\n    // Extract questions for media planning\r\n    // Include question type so we can filter appropriately (e.g., skip categorization)\r\n    const questions = blocks\r\n        .filter(b => ['multiple-choice', 'open-question', 'categorization'].includes(b.type))\r\n        .map(b => {\r\n            const content = b.content as any;\r\n            return {\r\n                id: b.id,\r\n                text: content?.question || content?.text || '',\r\n                taxonomy: b.metadata?.bloomLevel,\r\n                type: b.type\r\n            };\r\n        });\r\n\r\n    // Create media plan\r\n    const mediaPlan = createActivityMediaPlan(topic, subject, gradeLevel, questions);\r\n\r\n    const totalImages = 1 + mediaPlan.scenarioImages.length;\r\n    let currentImage = 0;\r\n\r\n    const newBlocks: ActivityBlock[] = [];\r\n\r\n    // 1. Generate and add context (intro) image as first block\r\n    onProgress?.('  ...', ++currentImage, totalImages);\r\n\r\n    try {\r\n        const contextImageUrl = await generateAndUploadImage(\r\n            mediaPlan.contextImage.prompt,\r\n            'ai-image'\r\n        );\r\n\r\n        if (contextImageUrl) {\r\n            const introBlock: ActivityBlock = {\r\n                id: uuidv4(),\r\n                type: 'activity-intro',\r\n                content: {\r\n                    imageUrl: contextImageUrl,\r\n                    title: getContextTitle(subject, topic),\r\n                    description: mediaPlan.contextImage.description,\r\n                    imagePrompt: mediaPlan.contextImage.prompt\r\n                } as ActivityIntroContent\r\n            };\r\n            newBlocks.push(introBlock);\r\n        }\r\n    } catch (error) {\r\n        console.warn('Failed to generate context image:', error);\r\n        // Continue without context image\r\n    }\r\n\r\n    // 2. Process existing blocks, inserting scenario images where needed\r\n    const scenarioImageMap = new Map(\r\n        mediaPlan.scenarioImages.map(s => [s.blockId, s])\r\n    );\r\n\r\n    for (const block of blocks) {\r\n        // Check if this block needs a scenario image\r\n        const scenarioImage = scenarioImageMap.get(block.id);\r\n\r\n        if (scenarioImage) {\r\n            onProgress?.('  ...', ++currentImage, totalImages);\r\n\r\n            try {\r\n                const scenarioImageUrl = await generateAndUploadImage(\r\n                    scenarioImage.prompt,\r\n                    'ai-image'\r\n                );\r\n\r\n                if (scenarioImageUrl) {\r\n                    // Insert scenario image block BEFORE the question\r\n                    const scenarioBlock: ActivityBlock = {\r\n                        id: uuidv4(),\r\n                        type: 'scenario-image',\r\n                        content: {\r\n                            imageUrl: scenarioImageUrl,\r\n                            caption: getScenarioCaption(block),\r\n                            imagePrompt: scenarioImage.prompt,\r\n                            relatedBlockId: block.id\r\n                        } as ScenarioImageContent\r\n                    };\r\n                    newBlocks.push(scenarioBlock);\r\n                }\r\n            } catch (error) {\r\n                console.warn('Failed to generate scenario image:', error);\r\n                // Continue without scenario image\r\n            }\r\n        }\r\n\r\n        // Add the original block\r\n        newBlocks.push(block);\r\n    }\r\n\r\n    return {\r\n        ...unit,\r\n        activityBlocks: newBlocks\r\n    };\r\n};\r\n\r\n/**\r\n * Generates an image using Gemini and uploads to Storage\r\n */\r\nconst generateAndUploadImage = async (\r\n    prompt: string,\r\n    type: 'ai-image' | 'infographic'\r\n): Promise<string | null> => {\r\n    try {\r\n        console.log(` [ActivityMedia] Generating image... (prompt: ${prompt.substring(0, 50)}...)`);\r\n        const imageBlob = await generateGeminiImage(prompt);\r\n        if (!imageBlob) {\r\n            console.warn(' [ActivityMedia] Gemini returned no image blob');\r\n            return null;\r\n        }\r\n        console.log(` [ActivityMedia] Image generated, size: ${(imageBlob.size / 1024).toFixed(1)}KB`);\r\n\r\n        console.log(` [ActivityMedia] Uploading to Firebase Storage...`);\r\n        const imageUrl = await uploadGeneratedImage(imageBlob, type);\r\n        console.log(` [ActivityMedia] Image uploaded successfully: ${imageUrl.substring(0, 80)}...`);\r\n        return imageUrl;\r\n    } catch (error) {\r\n        console.error(' [ActivityMedia] Image generation/upload failed:', error);\r\n        return null;\r\n    }\r\n};\r\n\r\n/**\r\n * Creates an engaging context title based on subject\r\n */\r\nconst getContextTitle = (subject: string, topic: string): string => {\r\n    const subjectTitles: Record<string, string> = {\r\n        '': ' !',\r\n        '': ' !',\r\n        '': ' !',\r\n        '': ' !',\r\n        '': ' !',\r\n        '': ' !',\r\n        '': '  !',\r\n        '\"': ' !'\r\n    };\r\n\r\n    return subjectTitles[subject] || `: ${topic}`;\r\n};\r\n\r\n/**\r\n * Creates a caption for scenario images\r\n */\r\nconst getScenarioCaption = (block: ActivityBlock): string => {\r\n    const content = block.content as any;\r\n    const question = content?.question || content?.text || '';\r\n\r\n    // Extract key action words\r\n    if (question.includes(' ')) return '   ?';\r\n    if (question.includes(' ')) return '   ?';\r\n    if (question.includes(' ')) return '   ';\r\n    if (question.includes('')) return '  -  ?';\r\n\r\n    return '     ';\r\n};\r\n\r\n/**\r\n * Checks if an activity already has media enrichment\r\n */\r\nexport const isActivityEnriched = (unit: LearningUnit): boolean => {\r\n    const blocks = unit.activityBlocks || [];\r\n    return blocks.some(b => b.type === 'activity-intro' || b.type === 'scenario-image');\r\n};\r\n\r\n/**\r\n * Gets media usage statistics for an activity\r\n */\r\nexport const getActivityMediaStats = (unit: LearningUnit): ActivityMediaUsage => {\r\n    const blocks = unit.activityBlocks || [];\r\n    return {\r\n        contextImages: blocks.filter(b => b.type === 'activity-intro').length,\r\n        scenarioImages: blocks.filter(b => b.type === 'scenario-image').length\r\n    };\r\n};\r\n\r\n/**\r\n * Generates ONLY the context (opening) image for an activity\r\n * Can be called in parallel with content generation for better performance\r\n *\r\n * @param topic - The activity topic (used as fallback if no custom prompt)\r\n * @param subject - The subject area\r\n * @param gradeLevel - Target grade level\r\n * @param customImagePrompt - AI-generated prompt from skeleton (preferred)\r\n * @param onProgress - Progress callback\r\n * @returns ActivityBlock of type 'activity-intro' or null if generation fails\r\n */\r\nexport const generateContextImageBlock = async (\r\n    topic: string,\r\n    subject: string,\r\n    gradeLevel: string,\r\n    customImagePrompt?: string,\r\n    onProgress?: MediaProgressCallback\r\n): Promise<ActivityBlock | null> => {\r\n    const { createContextImagePrompt } = await import('../utils/mediaBudget');\r\n\r\n    // Use AI-generated prompt if available, otherwise fall back to generic prompt\r\n    const prompt = customImagePrompt || createContextImagePrompt(topic, subject, gradeLevel);\r\n    onProgress?.('  ...', 1, 1);\r\n\r\n    console.log(` [Parallel] Starting context image generation for: ${topic}`);\r\n    if (customImagePrompt) {\r\n        console.log(` [Parallel] Using AI-generated prompt from skeleton`);\r\n    }\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n        const imageUrl = await generateAndUploadImage(prompt, 'ai-image');\r\n\r\n        if (imageUrl) {\r\n            const elapsed = Date.now() - startTime;\r\n            console.log(` [Parallel] Context image ready in ${(elapsed / 1000).toFixed(1)}s`);\r\n\r\n            return {\r\n                id: uuidv4(),\r\n                type: 'activity-intro',\r\n                content: {\r\n                    imageUrl,\r\n                    title: getContextTitle(subject, topic),\r\n                    description: ` : ${subject} - ${topic}`,\r\n                    imagePrompt: prompt\r\n                } as ActivityIntroContent\r\n            };\r\n        }\r\n    } catch (error) {\r\n        console.warn(' [Parallel] Context image generation failed:', error);\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Processes suggested_media from AI-generated steps and creates media blocks\r\n * This should be called after content generation to add scenario images/infographics\r\n *\r\n * @param steps - Array of AI-generated steps with suggested_media field\r\n * @param topic - The activity topic\r\n * @param onProgress - Progress callback\r\n * @returns Array of media blocks to insert\r\n */\r\nexport const processSuggestedMedia = async (\r\n    steps: Array<{\r\n        step_number: number;\r\n        suggested_media?: {\r\n            needed: boolean;\r\n            type?: 'scenario_image' | 'infographic';\r\n            infographic_type?: 'flowchart' | 'timeline' | 'comparison' | 'cycle';\r\n            prompt_hint?: string;\r\n        };\r\n        teach_content?: string;\r\n    }>,\r\n    topic: string,\r\n    onProgress?: MediaProgressCallback\r\n): Promise<Map<number, ActivityBlock>> => {\r\n    const mediaBlocks = new Map<number, ActivityBlock>();\r\n\r\n    // Filter steps that need SCENARIO IMAGES only\r\n    // IMPORTANT: Infographics are for LESSON PLANS, not student activities\r\n    // Student activities should only have scenario images (dilemmas, real-world situations)\r\n    const stepsNeedingMedia = steps.filter(s =>\r\n        s.suggested_media?.needed &&\r\n        s.suggested_media?.type === 'scenario_image'  // Exclude infographics\r\n    );\r\n\r\n    if (stepsNeedingMedia.length === 0) {\r\n        console.log(' [SuggestedMedia] No steps need scenario images');\r\n        return mediaBlocks;\r\n    }\r\n\r\n    // Limit to 2 scenario images (budget constraint)\r\n    const stepsToProcess = stepsNeedingMedia.slice(0, 2);\r\n    console.log(` [SuggestedMedia] Processing ${stepsToProcess.length} media requests`);\r\n\r\n    let current = 0;\r\n    const total = stepsToProcess.length;\r\n\r\n    for (const step of stepsToProcess) {\r\n        const media = step.suggested_media!;\r\n        current++;\r\n        onProgress?.(`   ${step.step_number}...`, current, total);\r\n\r\n        try {\r\n            if (media.type === 'scenario_image') {\r\n                // Generate scenario image\r\n                const prompt = media.prompt_hint\r\n                    ? `Create an educational illustration: ${media.prompt_hint}.\r\n                       Style: Semi-realistic, warm colors.\r\n                       CRITICAL: NO TEXT AT ALL in the image.`\r\n                    : `Create an educational problem-solving scenario image related to \"${topic}\".\r\n                       Show a moment that requires student decision-making.\r\n                       Style: Semi-realistic, warm colors.\r\n                       CRITICAL: NO TEXT AT ALL in the image.`;\r\n\r\n                console.log(` [SuggestedMedia] Generating scenario image for step ${step.step_number}`);\r\n                const imageUrl = await generateAndUploadImage(prompt, 'ai-image');\r\n\r\n                if (imageUrl) {\r\n                    const scenarioBlock: ActivityBlock = {\r\n                        id: uuidv4(),\r\n                        type: 'scenario-image',\r\n                        content: {\r\n                            imageUrl,\r\n                            caption: '     ',\r\n                            imagePrompt: prompt,\r\n                            relatedBlockId: `step-${step.step_number}`\r\n                        } as ScenarioImageContent\r\n                    };\r\n                    mediaBlocks.set(step.step_number, scenarioBlock);\r\n                    console.log(` [SuggestedMedia] Scenario image ready for step ${step.step_number}`);\r\n                }\r\n            } else if (media.type === 'infographic') {\r\n                // Generate infographic using the infographic service\r\n                const infographicPrompt = buildInfographicPrompt(\r\n                    step.teach_content || topic,\r\n                    media.infographic_type || 'flowchart',\r\n                    media.prompt_hint\r\n                );\r\n\r\n                console.log(` [SuggestedMedia] Generating ${media.infographic_type} infographic for step ${step.step_number}`);\r\n                const imageUrl = await generateAndUploadImage(infographicPrompt, 'infographic');\r\n\r\n                if (imageUrl) {\r\n                    const infographicBlock: ActivityBlock = {\r\n                        id: uuidv4(),\r\n                        type: 'scenario-image', // Use same type for rendering\r\n                        content: {\r\n                            imageUrl,\r\n                            caption: getInfographicCaption(media.infographic_type),\r\n                            imagePrompt: infographicPrompt,\r\n                            relatedBlockId: `step-${step.step_number}`\r\n                        } as ScenarioImageContent\r\n                    };\r\n                    mediaBlocks.set(step.step_number, infographicBlock);\r\n                    console.log(` [SuggestedMedia] Infographic ready for step ${step.step_number}`);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.warn(` [SuggestedMedia] Failed to generate media for step ${step.step_number}:`, error);\r\n            // Continue without this media\r\n        }\r\n    }\r\n\r\n    return mediaBlocks;\r\n};\r\n\r\n/**\r\n * Builds an infographic generation prompt based on type\r\n */\r\nconst buildInfographicPrompt = (\r\n    content: string,\r\n    type: 'flowchart' | 'timeline' | 'comparison' | 'cycle',\r\n    promptHint?: string\r\n): string => {\r\n    const typeInstructions: Record<string, string> = {\r\n        flowchart: 'Create a clean flowchart diagram showing the process steps with arrows connecting them.',\r\n        timeline: 'Create a horizontal timeline showing events/stages in chronological order.',\r\n        comparison: 'Create a side-by-side comparison diagram with clear visual differences.',\r\n        cycle: 'Create a circular diagram showing a recurring process with arrows indicating flow.'\r\n    };\r\n\r\n    return `Create an educational infographic in Hebrew.\r\n${typeInstructions[type]}\r\nContent to visualize: ${promptHint || content.substring(0, 500)}\r\nStyle: Clean, professional, educational. Use warm colors.\r\nCRITICAL: Include Hebrew text labels. Make it easy to read.\r\nAge-appropriate for students.`;\r\n};\r\n\r\n/**\r\n * Gets caption for infographic based on type\r\n */\r\nconst getInfographicCaption = (type?: string): string => {\r\n    const captions: Record<string, string> = {\r\n        flowchart: '   ',\r\n        timeline: '   ',\r\n        comparison: '  ',\r\n        cycle: ' '\r\n    };\r\n    return captions[type || 'flowchart'] || ' ';\r\n};\r\n","/**\r\n * Streaming Service - Client-side SSE handler\r\n *\r\n * This service connects to the Cloud Run streaming server\r\n * and provides real-time content updates to the UI.\r\n *\r\n * Features:\r\n * - EventSource-based SSE connection\r\n * - Automatic reconnection on failure\r\n * - Progress callbacks for UI updates\r\n * - JSON parsing for structured content\r\n * - Support for differentiated content levels\r\n */\r\n\r\nimport { auth } from '../firebase';\r\n\r\n// ============================================================\r\n// CONFIGURATION\r\n// ============================================================\r\n\r\n// Always use production URL (local emulator not typically used for streaming)\r\nconst STREAMING_BASE_URL = 'https://us-central1-ai-lms-pro.cloudfunctions.net/streamingServer';\r\n\r\n// ============================================================\r\n// TYPES\r\n// ============================================================\r\n\r\nexport interface StreamChunk {\r\n  type: 'text' | 'json_partial' | 'json_complete' | 'error' | 'done' | 'progress';\r\n  content: string;\r\n  metadata?: {\r\n    chunkIndex?: number;\r\n    totalExpected?: number;\r\n    itemType?: string;\r\n    level?: string;\r\n  };\r\n}\r\n\r\nexport interface StreamCallbacks {\r\n  onChunk?: (chunk: string, metadata?: StreamChunk['metadata']) => void;\r\n  onProgress?: (message: string, metadata?: StreamChunk['metadata']) => void;\r\n  onLevelStart?: (level: string) => void;\r\n  onLevelComplete?: (level: string, content: any) => void;\r\n  onPartStart?: (part: string) => void;\r\n  onPartComplete?: (part: string, content: any) => void;\r\n  onComplete?: (fullContent: string | any) => void;\r\n  onError?: (error: string) => void;\r\n}\r\n\r\nexport interface DifferentiatedResult {\r\n  support: any[];\r\n  core: any[];\r\n  enrichment: any[];\r\n}\r\n\r\nexport interface StreamContentOptions {\r\n  temperature?: number;\r\n  maxTokens?: number;\r\n  gradeLevel?: string;\r\n  subject?: string;\r\n  topic?: string;\r\n  isDifferentiated?: boolean;\r\n  activityLength?: string;\r\n  sourceText?: string;\r\n  productType?: string;\r\n  questionPreferences?: any;\r\n  contentTone?: 'friendly' | 'professional' | 'playful' | 'neutral';\r\n}\r\n\r\n// ============================================================\r\n// HELPER FUNCTIONS\r\n// ============================================================\r\n\r\n/**\r\n * Get Firebase auth token for API calls\r\n */\r\nasync function getAuthToken(): Promise<string> {\r\n  const user = auth.currentUser;\r\n  if (!user) {\r\n    throw new Error('User not authenticated');\r\n  }\r\n  return user.getIdToken();\r\n}\r\n\r\n/**\r\n * Parse SSE data line\r\n */\r\nfunction parseSSEData(line: string): StreamChunk | null {\r\n  if (!line.startsWith('data: ')) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    const jsonStr = line.slice(6); // Remove 'data: ' prefix\r\n    return JSON.parse(jsonStr) as StreamChunk;\r\n  } catch (e) {\r\n    console.warn('Failed to parse SSE data:', line);\r\n    return null;\r\n  }\r\n}\r\n\r\n// ============================================================\r\n// STREAMING FUNCTIONS\r\n// ============================================================\r\n\r\n/**\r\n * Stream generic content from the server\r\n *\r\n * @param prompt - The prompt to send\r\n * @param systemPrompt - Optional system prompt\r\n * @param options - Generation options\r\n * @param callbacks - Callbacks for streaming events\r\n * @returns AbortController to cancel the stream\r\n */\r\nexport async function streamContent(\r\n  prompt: string,\r\n  systemPrompt: string | undefined,\r\n  options: StreamContentOptions,\r\n  callbacks: StreamCallbacks\r\n): Promise<AbortController> {\r\n  const token = await getAuthToken();\r\n  const controller = new AbortController();\r\n\r\n  const response = await fetch(`${STREAMING_BASE_URL}/stream/content`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      'Authorization': `Bearer ${token}`\r\n    },\r\n    body: JSON.stringify({\r\n      type: options.productType || 'activity',\r\n      prompt,\r\n      systemPrompt,\r\n      options\r\n    }),\r\n    signal: controller.signal\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const error = await response.text();\r\n    callbacks.onError?.(error);\r\n    throw new Error(error);\r\n  }\r\n\r\n  // Process the stream\r\n  const reader = response.body?.getReader();\r\n  if (!reader) {\r\n    throw new Error('No response body');\r\n  }\r\n\r\n  const decoder = new TextDecoder();\r\n  let buffer = '';\r\n  let fullContent = '';\r\n\r\n  (async () => {\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n\r\n        // Process complete lines\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() || ''; // Keep incomplete line in buffer\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('event: ')) {\r\n            // Event type line - skip, we handle data lines\r\n            continue;\r\n          }\r\n\r\n          const chunk = parseSSEData(line);\r\n          if (!chunk) continue;\r\n\r\n          switch (chunk.type) {\r\n            case 'text':\r\n              fullContent += chunk.content;\r\n              callbacks.onChunk?.(chunk.content, chunk.metadata);\r\n              break;\r\n\r\n            case 'progress':\r\n              callbacks.onProgress?.(chunk.content, chunk.metadata);\r\n              break;\r\n\r\n            case 'json_complete':\r\n              try {\r\n                const parsed = JSON.parse(chunk.content);\r\n                callbacks.onComplete?.(parsed);\r\n              } catch (e) {\r\n                callbacks.onComplete?.(chunk.content);\r\n              }\r\n              break;\r\n\r\n            case 'done':\r\n              callbacks.onComplete?.(fullContent);\r\n              break;\r\n\r\n            case 'error':\r\n              callbacks.onError?.(chunk.content);\r\n              break;\r\n          }\r\n        }\r\n      }\r\n    } catch (error: any) {\r\n      if (error.name !== 'AbortError') {\r\n        callbacks.onError?.(error.message || 'Stream failed');\r\n      }\r\n    }\r\n  })();\r\n\r\n  return controller;\r\n}\r\n\r\n/**\r\n * Stream differentiated content (3 levels)\r\n *\r\n * This function streams content for support, core, and enrichment levels\r\n * one at a time, providing callbacks as each level completes.\r\n *\r\n * @param options - Generation options\r\n * @param callbacks - Callbacks for streaming events\r\n * @returns AbortController and a promise that resolves with the full result\r\n */\r\nexport async function streamDifferentiatedContent(\r\n  options: StreamContentOptions,\r\n  callbacks: StreamCallbacks\r\n): Promise<{ controller: AbortController; result: Promise<DifferentiatedResult> }> {\r\n  const token = await getAuthToken();\r\n  const controller = new AbortController();\r\n\r\n  const result = new Promise<DifferentiatedResult>(async (resolve, reject) => {\r\n    try {\r\n      const response = await fetch(`${STREAMING_BASE_URL}/stream/differentiated`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify({\r\n          topic: options.topic,\r\n          gradeLevel: options.gradeLevel,\r\n          subject: options.subject,\r\n          sourceText: options.sourceText,\r\n          productType: options.productType,\r\n          activityLength: options.activityLength,\r\n          questionPreferences: options.questionPreferences\r\n        }),\r\n        signal: controller.signal\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text();\r\n        callbacks.onError?.(error);\r\n        reject(new Error(error));\r\n        return;\r\n      }\r\n\r\n      const reader = response.body?.getReader();\r\n      if (!reader) {\r\n        reject(new Error('No response body'));\r\n        return;\r\n      }\r\n\r\n      const decoder = new TextDecoder();\r\n      let buffer = '';\r\n      const levels: DifferentiatedResult = {\r\n        support: [],\r\n        core: [],\r\n        enrichment: []\r\n      };\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() || '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('event: ')) {\r\n            const eventType = line.slice(7).trim();\r\n\r\n            // Get the next data line\r\n            const dataLineIndex = lines.indexOf(line) + 1;\r\n            if (dataLineIndex < lines.length) {\r\n              const dataLine = lines[dataLineIndex];\r\n              const chunk = parseSSEData(dataLine);\r\n              if (!chunk) continue;\r\n\r\n              switch (eventType) {\r\n                case 'level_start':\r\n                  callbacks.onLevelStart?.(chunk.metadata?.level || '');\r\n                  callbacks.onProgress?.(chunk.content, chunk.metadata);\r\n                  break;\r\n\r\n                case 'level_complete':\r\n                  const level = chunk.metadata?.level as keyof DifferentiatedResult;\r\n                  if (level && levels[level] !== undefined) {\r\n                    try {\r\n                      const parsed = JSON.parse(chunk.content);\r\n                      levels[level] = Array.isArray(parsed) ? parsed : [parsed];\r\n                    } catch (e) {\r\n                      levels[level] = [];\r\n                    }\r\n                    callbacks.onLevelComplete?.(level, levels[level]);\r\n                  }\r\n                  break;\r\n\r\n                case 'chunk':\r\n                  callbacks.onChunk?.(chunk.content, chunk.metadata);\r\n                  break;\r\n\r\n                case 'done':\r\n                  callbacks.onComplete?.(levels);\r\n                  resolve(levels);\r\n                  return;\r\n\r\n                case 'error':\r\n                  callbacks.onError?.(chunk.content);\r\n                  reject(new Error(chunk.content));\r\n                  return;\r\n              }\r\n            }\r\n            continue;\r\n          }\r\n\r\n          // Handle data lines that don't follow an event line\r\n          const chunk = parseSSEData(line);\r\n          if (!chunk) continue;\r\n\r\n          if (chunk.type === 'text') {\r\n            callbacks.onChunk?.(chunk.content, chunk.metadata);\r\n          } else if (chunk.type === 'done') {\r\n            callbacks.onComplete?.(levels);\r\n            resolve(levels);\r\n            return;\r\n          } else if (chunk.type === 'error') {\r\n            callbacks.onError?.(chunk.content);\r\n            reject(new Error(chunk.content));\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // If we got here without resolving, return what we have\r\n      resolve(levels);\r\n\r\n    } catch (error: any) {\r\n      if (error.name !== 'AbortError') {\r\n        callbacks.onError?.(error.message || 'Stream failed');\r\n        reject(error);\r\n      }\r\n    }\r\n  });\r\n\r\n  return { controller, result };\r\n}\r\n\r\n/**\r\n * Stream lesson plan content\r\n *\r\n * Streams lesson parts (hook, instruction, practice, summary) one at a time\r\n *\r\n * @param options - Generation options\r\n * @param callbacks - Callbacks for streaming events\r\n * @returns AbortController and a promise that resolves with the full lesson\r\n */\r\nexport async function streamLessonContent(\r\n  options: StreamContentOptions & { lessonParts?: string[] },\r\n  callbacks: StreamCallbacks\r\n): Promise<{ controller: AbortController; result: Promise<Record<string, any>> }> {\r\n  const token = await getAuthToken();\r\n  const controller = new AbortController();\r\n\r\n  const result = new Promise<Record<string, any>>(async (resolve, reject) => {\r\n    try {\r\n      const response = await fetch(`${STREAMING_BASE_URL}/stream/lesson`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify({\r\n          topic: options.topic,\r\n          gradeLevel: options.gradeLevel,\r\n          subject: options.subject,\r\n          sourceText: options.sourceText,\r\n          lessonParts: options.lessonParts || ['hook', 'instruction', 'practice', 'summary']\r\n        }),\r\n        signal: controller.signal\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text();\r\n        callbacks.onError?.(error);\r\n        reject(new Error(error));\r\n        return;\r\n      }\r\n\r\n      const reader = response.body?.getReader();\r\n      if (!reader) {\r\n        reject(new Error('No response body'));\r\n        return;\r\n      }\r\n\r\n      const decoder = new TextDecoder();\r\n      let buffer = '';\r\n      const lessonParts: Record<string, any> = {};\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() || '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('event: ')) {\r\n            const eventType = line.slice(7).trim();\r\n            const dataLineIndex = lines.indexOf(line) + 1;\r\n\r\n            if (dataLineIndex < lines.length) {\r\n              const dataLine = lines[dataLineIndex];\r\n              const chunk = parseSSEData(dataLine);\r\n              if (!chunk) continue;\r\n\r\n              switch (eventType) {\r\n                case 'part_start':\r\n                  callbacks.onPartStart?.(chunk.metadata?.itemType || '');\r\n                  callbacks.onProgress?.(chunk.content, chunk.metadata);\r\n                  break;\r\n\r\n                case 'part_complete':\r\n                  const part = chunk.metadata?.itemType;\r\n                  if (part) {\r\n                    try {\r\n                      lessonParts[part] = JSON.parse(chunk.content);\r\n                    } catch (e) {\r\n                      lessonParts[part] = chunk.content;\r\n                    }\r\n                    callbacks.onPartComplete?.(part, lessonParts[part]);\r\n                  }\r\n                  break;\r\n\r\n                case 'chunk':\r\n                  callbacks.onChunk?.(chunk.content, chunk.metadata);\r\n                  break;\r\n\r\n                case 'done':\r\n                  callbacks.onComplete?.(lessonParts);\r\n                  resolve(lessonParts);\r\n                  return;\r\n\r\n                case 'error':\r\n                  callbacks.onError?.(chunk.content);\r\n                  reject(new Error(chunk.content));\r\n                  return;\r\n              }\r\n            }\r\n            continue;\r\n          }\r\n\r\n          const chunk = parseSSEData(line);\r\n          if (!chunk) continue;\r\n\r\n          if (chunk.type === 'done') {\r\n            callbacks.onComplete?.(lessonParts);\r\n            resolve(lessonParts);\r\n            return;\r\n          } else if (chunk.type === 'error') {\r\n            callbacks.onError?.(chunk.content);\r\n            reject(new Error(chunk.content));\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      resolve(lessonParts);\r\n\r\n    } catch (error: any) {\r\n      if (error.name !== 'AbortError') {\r\n        callbacks.onError?.(error.message || 'Stream failed');\r\n        reject(error);\r\n      }\r\n    }\r\n  });\r\n\r\n  return { controller, result };\r\n}\r\n\r\n/**\r\n * Stream podcast script content\r\n *\r\n * Streams podcast dialogue generation (Dan & Noa format)\r\n *\r\n * @param options - Generation options\r\n * @param callbacks - Callbacks for streaming events\r\n * @returns AbortController and a promise that resolves with the script\r\n */\r\nexport async function streamPodcastContent(\r\n  options: StreamContentOptions,\r\n  callbacks: StreamCallbacks\r\n): Promise<{ controller: AbortController; result: Promise<any> }> {\r\n  const token = await getAuthToken();\r\n  const controller = new AbortController();\r\n\r\n  const result = new Promise<any>(async (resolve, reject) => {\r\n    try {\r\n      const response = await fetch(`${STREAMING_BASE_URL}/stream/podcast`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify({\r\n          topic: options.topic,\r\n          gradeLevel: options.gradeLevel,\r\n          sourceText: options.sourceText,\r\n          activityLength: options.activityLength\r\n        }),\r\n        signal: controller.signal\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text();\r\n        callbacks.onError?.(error);\r\n        reject(new Error(error));\r\n        return;\r\n      }\r\n\r\n      const reader = response.body?.getReader();\r\n      if (!reader) {\r\n        reject(new Error('No response body'));\r\n        return;\r\n      }\r\n\r\n      const decoder = new TextDecoder();\r\n      let buffer = '';\r\n      let fullContent = '';\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() || '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('event: ')) {\r\n            const eventType = line.slice(7).trim();\r\n            const dataLineIndex = lines.indexOf(line) + 1;\r\n\r\n            if (dataLineIndex < lines.length) {\r\n              const dataLine = lines[dataLineIndex];\r\n              const chunk = parseSSEData(dataLine);\r\n              if (!chunk) continue;\r\n\r\n              switch (eventType) {\r\n                case 'progress':\r\n                  callbacks.onProgress?.(chunk.content, chunk.metadata);\r\n                  break;\r\n\r\n                case 'chunk':\r\n                  fullContent += chunk.content;\r\n                  callbacks.onChunk?.(chunk.content, chunk.metadata);\r\n                  break;\r\n\r\n                case 'done':\r\n                  try {\r\n                    const parsed = JSON.parse(chunk.content);\r\n                    callbacks.onComplete?.(parsed);\r\n                    resolve(parsed);\r\n                  } catch (e) {\r\n                    callbacks.onComplete?.(fullContent);\r\n                    resolve(fullContent);\r\n                  }\r\n                  return;\r\n\r\n                case 'error':\r\n                  callbacks.onError?.(chunk.content);\r\n                  reject(new Error(chunk.content));\r\n                  return;\r\n              }\r\n            }\r\n            continue;\r\n          }\r\n\r\n          // Handle data lines without event prefix\r\n          const chunk = parseSSEData(line);\r\n          if (!chunk) continue;\r\n\r\n          if (chunk.type === 'text') {\r\n            fullContent += chunk.content;\r\n            callbacks.onChunk?.(chunk.content, chunk.metadata);\r\n          } else if (chunk.type === 'json_complete' || chunk.type === 'done') {\r\n            try {\r\n              const parsed = JSON.parse(chunk.content);\r\n              callbacks.onComplete?.(parsed);\r\n              resolve(parsed);\r\n            } catch (e) {\r\n              callbacks.onComplete?.(fullContent);\r\n              resolve(fullContent);\r\n            }\r\n            return;\r\n          } else if (chunk.type === 'error') {\r\n            callbacks.onError?.(chunk.content);\r\n            reject(new Error(chunk.content));\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // If we got here, try to parse what we have\r\n      resolve(fullContent);\r\n\r\n    } catch (error: any) {\r\n      if (error.name !== 'AbortError') {\r\n        callbacks.onError?.(error.message || 'Stream failed');\r\n        reject(error);\r\n      }\r\n    }\r\n  });\r\n\r\n  return { controller, result };\r\n}\r\n\r\n// ============================================================\r\n// SINGLE ACTIVITY STREAMING\r\n// ============================================================\r\n\r\nexport interface ActivityStreamResult {\r\n  title: string;\r\n  steps: any[];\r\n  skeleton?: any;\r\n  metadata?: {\r\n    topic: string;\r\n    gradeLevel: string;\r\n    stepCount: number;\r\n    generationTime: number;\r\n    method: string;\r\n  };\r\n}\r\n\r\nexport interface ActivityStreamCallbacks {\r\n  onProgress?: (message: string, metadata?: any) => void;\r\n  onSkeletonComplete?: (skeleton: any) => void;\r\n  onStepComplete?: (step: any, stepNumber: number, totalSteps: number) => void;\r\n  onComplete?: (result: ActivityStreamResult) => void;\r\n  onError?: (error: string) => void;\r\n}\r\n\r\n/**\r\n * Stream a single activity generation\r\n *\r\n * This replaces the old flow of:\r\n * 1. generateStudentUnitSkeleton (Cloud Function)\r\n * 2. generateStepContent x N (Cloud Functions, sequential)\r\n *\r\n * With a single streaming call that generates everything in parallel\r\n *\r\n * @param options - Generation options\r\n * @param callbacks - Callbacks for streaming events\r\n * @returns AbortController and a promise that resolves with the full activity\r\n */\r\nexport async function streamActivityContent(\r\n  options: StreamContentOptions,\r\n  callbacks: ActivityStreamCallbacks\r\n): Promise<{ controller: AbortController; result: Promise<ActivityStreamResult> }> {\r\n  const token = await getAuthToken();\r\n  const controller = new AbortController();\r\n\r\n  const result = new Promise<ActivityStreamResult>(async (resolve, reject) => {\r\n    try {\r\n      const response = await fetch(`${STREAMING_BASE_URL}/stream/activity`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: JSON.stringify({\r\n          topic: options.topic,\r\n          gradeLevel: options.gradeLevel,\r\n          subject: options.subject,\r\n          sourceText: options.sourceText,\r\n          activityLength: options.activityLength,\r\n          // Send both mode (for exam enforcement) and productType (for content style)\r\n          mode: options.productType === 'exam' ? 'exam' : 'learning',\r\n          productType: options.productType || 'activity', // activity | lesson | exam\r\n          questionPreferences: options.questionPreferences\r\n        }),\r\n        signal: controller.signal\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text();\r\n        callbacks.onError?.(error);\r\n        reject(new Error(error));\r\n        return;\r\n      }\r\n\r\n      const reader = response.body?.getReader();\r\n      if (!reader) {\r\n        reject(new Error('No response body'));\r\n        return;\r\n      }\r\n\r\n      const decoder = new TextDecoder();\r\n      let buffer = '';\r\n      let skeleton: any = null;\r\n      const steps: any[] = [];\r\n      let finalResult: ActivityStreamResult | null = null;\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() || '';\r\n\r\n        for (let i = 0; i < lines.length; i++) {\r\n          const line = lines[i];\r\n\r\n          if (line.startsWith('event: ')) {\r\n            const eventType = line.slice(7).trim();\r\n            const nextLine = lines[i + 1];\r\n\r\n            if (nextLine?.startsWith('data: ')) {\r\n              const chunk = parseSSEData(nextLine);\r\n              if (!chunk) continue;\r\n\r\n              switch (eventType) {\r\n                case 'progress':\r\n                  callbacks.onProgress?.(chunk.content, chunk.metadata);\r\n                  break;\r\n\r\n                case 'skeleton_complete':\r\n                  try {\r\n                    skeleton = JSON.parse(chunk.content);\r\n                    callbacks.onSkeletonComplete?.(skeleton);\r\n                  } catch (e) {\r\n                    console.warn('Failed to parse skeleton:', e);\r\n                  }\r\n                  break;\r\n\r\n                case 'step_complete':\r\n                  try {\r\n                    const step = JSON.parse(chunk.content);\r\n                    steps.push(step);\r\n                    callbacks.onStepComplete?.(\r\n                      step,\r\n                      chunk.metadata?.stepNumber || steps.length,\r\n                      chunk.metadata?.totalSteps || 5\r\n                    );\r\n                  } catch (e) {\r\n                    console.warn('Failed to parse step:', e);\r\n                  }\r\n                  break;\r\n\r\n                case 'done':\r\n                  try {\r\n                    finalResult = JSON.parse(chunk.content);\r\n                    callbacks.onComplete?.(finalResult!);\r\n                    resolve(finalResult!);\r\n                    return;\r\n                  } catch (e) {\r\n                    // Construct result from collected data\r\n                    finalResult = {\r\n                      title: skeleton?.unit_title || options.topic || '',\r\n                      steps: steps,\r\n                      skeleton: skeleton,\r\n                      metadata: chunk.metadata\r\n                    };\r\n                    callbacks.onComplete?.(finalResult);\r\n                    resolve(finalResult);\r\n                    return;\r\n                  }\r\n\r\n                case 'error':\r\n                  callbacks.onError?.(chunk.content);\r\n                  reject(new Error(chunk.content));\r\n                  return;\r\n              }\r\n              i++; // Skip the data line we just processed\r\n            }\r\n            continue;\r\n          }\r\n\r\n          // Handle standalone data lines\r\n          const chunk = parseSSEData(line);\r\n          if (!chunk) continue;\r\n\r\n          if (chunk.type === 'done') {\r\n            try {\r\n              finalResult = JSON.parse(chunk.content);\r\n            } catch (e) {\r\n              finalResult = {\r\n                title: skeleton?.unit_title || options.topic || '',\r\n                steps: steps,\r\n                skeleton: skeleton\r\n              };\r\n            }\r\n            callbacks.onComplete?.(finalResult!);\r\n            resolve(finalResult!);\r\n            return;\r\n          } else if (chunk.type === 'error') {\r\n            callbacks.onError?.(chunk.content);\r\n            reject(new Error(chunk.content));\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // If we got here without resolving, construct result from collected data\r\n      if (!finalResult) {\r\n        finalResult = {\r\n          title: skeleton?.unit_title || options.topic || '',\r\n          steps: steps,\r\n          skeleton: skeleton\r\n        };\r\n        callbacks.onComplete?.(finalResult);\r\n        resolve(finalResult);\r\n      }\r\n\r\n    } catch (error: any) {\r\n      if (error.name !== 'AbortError') {\r\n        callbacks.onError?.(error.message || 'Stream failed');\r\n        reject(error);\r\n      }\r\n    }\r\n  });\r\n\r\n  return { controller, result };\r\n}\r\n\r\n// ============================================================\r\n// UTILITY FUNCTIONS\r\n// ============================================================\r\n\r\n/**\r\n * Check if streaming is supported in the current environment\r\n */\r\nexport function isStreamingSupported(): boolean {\r\n  return typeof ReadableStream !== 'undefined' && typeof fetch !== 'undefined';\r\n}\r\n\r\n/**\r\n * Get the streaming server URL\r\n */\r\nexport function getStreamingServerUrl(): string {\r\n  return STREAMING_BASE_URL;\r\n}\r\n","/**\r\n * YouTube Educational Video Service\r\n *\r\n * Frontend service for searching and embedding YouTube videos in lessons\r\n */\r\n\r\nimport { functions } from '../firebase';\r\nimport { httpsCallable } from 'firebase/functions';\r\n\r\n// Types\r\nexport interface YouTubeVideoResult {\r\n    videoId: string;\r\n    title: string;\r\n    description: string;\r\n    thumbnailUrl: string;\r\n    channelTitle: string;\r\n    publishedAt: string;\r\n    duration: string;\r\n    viewCount: string;\r\n    hasCaptions: boolean;\r\n    captionLanguages: string[];\r\n    educationalScore: number;\r\n    ageAppropriate: boolean;\r\n    relevanceScore: number;\r\n    embedUrl: string;\r\n    watchUrl: string;\r\n}\r\n\r\nexport interface YouTubeSearchParams {\r\n    topic: string;\r\n    gradeLevel: string;\r\n    language?: 'he' | 'en' | 'any';\r\n    maxResults?: number;\r\n    requireCaptions?: boolean;\r\n    educationalOnly?: boolean;\r\n}\r\n\r\nexport interface YouTubeSearchResponse {\r\n    success: boolean;\r\n    videos: YouTubeVideoResult[];\r\n    totalResults: number;\r\n    query: string;\r\n    filters: {\r\n        language: string;\r\n        gradeLevel: string;\r\n        safeSearch: boolean;\r\n    };\r\n}\r\n\r\n// Cache for search results\r\nconst searchCache = new Map<string, { data: YouTubeSearchResponse; timestamp: number }>();\r\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 minutes\r\n\r\n/**\r\n * Generate cache key from search params\r\n */\r\nfunction getCacheKey(params: YouTubeSearchParams): string {\r\n    return `${params.topic}|${params.gradeLevel}|${params.language || 'he'}|${params.maxResults || 5}`;\r\n}\r\n\r\n/**\r\n * Search for educational YouTube videos\r\n */\r\nexport async function searchYouTubeVideos(params: YouTubeSearchParams): Promise<YouTubeSearchResponse> {\r\n    const cacheKey = getCacheKey(params);\r\n\r\n    // Check cache\r\n    const cached = searchCache.get(cacheKey);\r\n    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\r\n        console.log('[YouTube] Cache hit for:', params.topic);\r\n        return cached.data;\r\n    }\r\n\r\n    try {\r\n        const searchFn = httpsCallable(functions, 'searchYouTubeEducational');\r\n        const result = await searchFn(params);\r\n\r\n        const data = result.data as YouTubeSearchResponse;\r\n\r\n        // Cache successful results\r\n        if (data.success) {\r\n            searchCache.set(cacheKey, { data, timestamp: Date.now() });\r\n        }\r\n\r\n        return data;\r\n    } catch (error: any) {\r\n        console.error('[YouTube] Search failed:', error);\r\n        throw new Error(` YouTube : ${error.message}`);\r\n    }\r\n}\r\n\r\n/**\r\n * Get detailed info about a specific video\r\n */\r\nexport async function getVideoDetails(videoId: string): Promise<YouTubeVideoResult | null> {\r\n    try {\r\n        const detailsFn = httpsCallable(functions, 'getYouTubeVideoDetails');\r\n        const result = await detailsFn({ videoId });\r\n\r\n        const data = result.data as { success: boolean; video: YouTubeVideoResult };\r\n        return data.success ? data.video : null;\r\n    } catch (error: any) {\r\n        console.error('[YouTube] Get details failed:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Generate embed HTML for a YouTube video\r\n */\r\nexport function generateEmbedHtml(videoId: string, options?: {\r\n    width?: number;\r\n    height?: number;\r\n    autoplay?: boolean;\r\n    showControls?: boolean;\r\n}): string {\r\n    const { width = 560, height = 315, autoplay = false, showControls = true } = options || {};\r\n\r\n    const params = new URLSearchParams({\r\n        rel: '0', // Don't show related videos\r\n        modestbranding: '1', // Minimal YouTube branding\r\n        fs: '1', // Allow fullscreen\r\n    });\r\n\r\n    if (autoplay) params.set('autoplay', '1');\r\n    if (!showControls) params.set('controls', '0');\r\n\r\n    return `<iframe\r\n        width=\"${width}\"\r\n        height=\"${height}\"\r\n        src=\"https://www.youtube.com/embed/${videoId}?${params.toString()}\"\r\n        frameborder=\"0\"\r\n        allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\"\r\n        allowfullscreen\r\n    ></iframe>`;\r\n}\r\n\r\n/**\r\n * Validate a YouTube URL and extract video ID\r\n */\r\nexport function extractVideoId(url: string): string | null {\r\n    const patterns = [\r\n        /(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/|youtube\\.com\\/embed\\/)([^#&?]*)/,\r\n        /^([a-zA-Z0-9_-]{11})$/ // Direct video ID\r\n    ];\r\n\r\n    for (const pattern of patterns) {\r\n        const match = url.match(pattern);\r\n        if (match && match[1].length === 11) {\r\n            return match[1];\r\n        }\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n/**\r\n * Create a video block for the lesson plan\r\n */\r\nexport function createVideoBlock(video: YouTubeVideoResult): {\r\n    type: 'video';\r\n    content: string;\r\n    metadata: Record<string, any>;\r\n} {\r\n    return {\r\n        type: 'video',\r\n        content: video.embedUrl,\r\n        metadata: {\r\n            videoId: video.videoId,\r\n            title: video.title,\r\n            channelTitle: video.channelTitle,\r\n            duration: video.duration,\r\n            thumbnailUrl: video.thumbnailUrl,\r\n            hasCaptions: video.hasCaptions,\r\n            captionLanguages: video.captionLanguages,\r\n            educationalScore: video.educationalScore,\r\n            source: 'youtube-search',\r\n            watchUrl: video.watchUrl\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Search for videos and return as ready-to-use blocks\r\n */\r\nexport async function searchAndCreateVideoBlocks(\r\n    topic: string,\r\n    gradeLevel: string,\r\n    maxResults: number = 3\r\n): Promise<Array<{ type: 'video'; content: string; metadata: Record<string, any> }>> {\r\n    try {\r\n        const response = await searchYouTubeVideos({\r\n            topic,\r\n            gradeLevel,\r\n            language: 'he',\r\n            maxResults,\r\n            requireCaptions: true,\r\n            educationalOnly: true\r\n        });\r\n\r\n        if (!response.success || response.videos.length === 0) {\r\n            return [];\r\n        }\r\n\r\n        return response.videos.map(video => createVideoBlock(video));\r\n    } catch (error) {\r\n        console.error('[YouTube] Failed to create video blocks:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Export types\r\nexport type { YouTubeSearchResponse, YouTubeVideoResult, YouTubeSearchParams };\r\n","/**\r\n * YouTube Educational Video Search Modal\r\n *\r\n * Allows teachers to search and select educational YouTube videos\r\n * with filtering for Hebrew content and age-appropriate material.\r\n */\r\n\r\nimport React, { useState, useCallback } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { searchYouTubeVideos, type YouTubeVideoResult } from '../services/youtubeService';\r\n\r\n// Icons\r\nconst IconSearch = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <circle cx=\"11\" cy=\"11\" r=\"8\" />\r\n        <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\" />\r\n    </svg>\r\n);\r\n\r\nconst IconX = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\r\n        <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\r\n    </svg>\r\n);\r\n\r\nconst IconCheck = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <polyline points=\"20 6 9 17 4 12\" />\r\n    </svg>\r\n);\r\n\r\nconst IconPlay = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <polygon points=\"5 3 19 12 5 21 5 3\" />\r\n    </svg>\r\n);\r\n\r\nconst IconClock = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <circle cx=\"12\" cy=\"12\" r=\"10\" />\r\n        <polyline points=\"12 6 12 12 16 14\" />\r\n    </svg>\r\n);\r\n\r\nconst IconSubtitles = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <rect x=\"2\" y=\"4\" width=\"20\" height=\"16\" rx=\"2\" />\r\n        <path d=\"M7 15h4M15 15h2M7 11h2M13 11h4\" />\r\n    </svg>\r\n);\r\n\r\nconst IconStar = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"currentColor\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <polygon points=\"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2\" />\r\n    </svg>\r\n);\r\n\r\nconst IconLoader = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <line x1=\"12\" y1=\"2\" x2=\"12\" y2=\"6\" />\r\n        <line x1=\"12\" y1=\"18\" x2=\"12\" y2=\"22\" />\r\n        <line x1=\"4.93\" y1=\"4.93\" x2=\"7.76\" y2=\"7.76\" />\r\n        <line x1=\"16.24\" y1=\"16.24\" x2=\"19.07\" y2=\"19.07\" />\r\n        <line x1=\"2\" y1=\"12\" x2=\"6\" y2=\"12\" />\r\n        <line x1=\"18\" y1=\"12\" x2=\"22\" y2=\"12\" />\r\n        <line x1=\"4.93\" y1=\"19.07\" x2=\"7.76\" y2=\"16.24\" />\r\n        <line x1=\"16.24\" y1=\"7.76\" x2=\"19.07\" y2=\"4.93\" />\r\n    </svg>\r\n);\r\n\r\ninterface YouTubeSearchModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSelectVideo: (video: YouTubeVideoResult) => void;\r\n    gradeLevel: string;\r\n    subject?: string;\r\n    initialQuery?: string;\r\n}\r\n\r\nconst YouTubeSearchModal: React.FC<YouTubeSearchModalProps> = ({\r\n    isOpen,\r\n    onClose,\r\n    onSelectVideo,\r\n    gradeLevel,\r\n    subject,\r\n    initialQuery = ''\r\n}) => {\r\n    const [searchQuery, setSearchQuery] = useState(initialQuery);\r\n    const [videos, setVideos] = useState<YouTubeVideoResult[]>([]);\r\n    const [isLoading, setIsLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [selectedVideoId, setSelectedVideoId] = useState<string | null>(null);\r\n    const [previewVideoId, setPreviewVideoId] = useState<string | null>(null);\r\n\r\n    const handleSearch = useCallback(async () => {\r\n        if (!searchQuery.trim()) return;\r\n\r\n        setIsLoading(true);\r\n        setError(null);\r\n\r\n        try {\r\n            const response = await searchYouTubeVideos({\r\n                topic: searchQuery,\r\n                gradeLevel,\r\n                language: 'he',\r\n                maxResults: 6,\r\n                requireCaptions: true,\r\n                educationalOnly: true\r\n            });\r\n\r\n            if (response.success) {\r\n                setVideos(response.videos);\r\n                if (response.videos.length === 0) {\r\n                    setError('   .    .');\r\n                }\r\n            } else {\r\n                setError(' .   .');\r\n            }\r\n        } catch (err: any) {\r\n            setError(err.message || ' ');\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    }, [searchQuery, gradeLevel]);\r\n\r\n    const handleKeyPress = (e: React.KeyboardEvent) => {\r\n        if (e.key === 'Enter') {\r\n            handleSearch();\r\n        }\r\n    };\r\n\r\n    const handleSelectVideo = (video: YouTubeVideoResult) => {\r\n        setSelectedVideoId(video.videoId);\r\n        onSelectVideo(video);\r\n        onClose();\r\n    };\r\n\r\n    const getScoreColor = (score: number) => {\r\n        if (score >= 80) return 'text-green-600';\r\n        if (score >= 60) return 'text-yellow-600';\r\n        return 'text-red-600';\r\n    };\r\n\r\n    const formatViewCount = (count: string) => {\r\n        const num = parseInt(count);\r\n        if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;\r\n        if (num >= 1000) return `${(num / 1000).toFixed(0)}K`;\r\n        return count;\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return createPortal(\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm\" dir=\"rtl\">\r\n            <div className=\"bg-white rounded-2xl shadow-2xl w-[900px] max-w-[95vw] max-h-[90vh] flex flex-col overflow-hidden\">\r\n                {/* Header */}\r\n                <div className=\"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-l from-red-50 to-white\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-10 h-10 rounded-full bg-red-500 flex items-center justify-center\">\r\n                            <IconPlay className=\"w-5 h-5 text-white\" />\r\n                        </div>\r\n                        <div>\r\n                            <h2 className=\"text-xl font-bold text-gray-800\">  YouTube</h2>\r\n                            <p className=\"text-sm text-gray-500\">   {gradeLevel}</p>\r\n                        </div>\r\n                    </div>\r\n                    <button onClick={onClose} className=\"p-2 hover:bg-gray-100 rounded-full transition-colors\">\r\n                        <IconX className=\"w-6 h-6 text-gray-500\" />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Search Bar */}\r\n                <div className=\"p-4 bg-gray-50 border-b border-gray-200\">\r\n                    <div className=\"flex gap-3\">\r\n                        <div className=\"flex-1 relative\">\r\n                            <input\r\n                                type=\"text\"\r\n                                value={searchQuery}\r\n                                onChange={(e) => setSearchQuery(e.target.value)}\r\n                                onKeyPress={handleKeyPress}\r\n                                placeholder={`   ${subject || ''}...`}\r\n                                className=\"w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none\"\r\n                                autoFocus\r\n                            />\r\n                            <IconSearch className=\"absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\r\n                        </div>\r\n                        <button\r\n                            onClick={handleSearch}\r\n                            disabled={isLoading || !searchQuery.trim()}\r\n                            className=\"px-6 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2\"\r\n                        >\r\n                            {isLoading ? (\r\n                                <>\r\n                                    <IconLoader className=\"w-5 h-5 animate-spin\" />\r\n                                    ...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <IconSearch className=\"w-5 h-5\" />\r\n                                    \r\n                                </>\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Filters Info */}\r\n                    <div className=\"flex gap-2 mt-3 text-xs text-gray-500\">\r\n                        <span className=\"flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-200\">\r\n                            <IconSubtitles className=\"w-3 h-3\" /> /\r\n                        </span>\r\n                        <span className=\"flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-200\">\r\n                            <IconCheck className=\"w-3 h-3 text-green-500\" />  \r\n                        </span>\r\n                        <span className=\"flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-200\">\r\n                            <IconClock className=\"w-3 h-3\" /> 1-20 \r\n                        </span>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Results Area */}\r\n                <div className=\"flex-1 overflow-y-auto p-4\">\r\n                    {error && (\r\n                        <div className=\"text-center py-8 text-gray-500\">\r\n                            <p className=\"text-red-500 mb-2\">{error}</p>\r\n                            <p className=\"text-sm\">:       </p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {!isLoading && videos.length === 0 && !error && (\r\n                        <div className=\"text-center py-16 text-gray-500\">\r\n                            <IconPlay className=\"w-16 h-16 mx-auto mb-4 text-gray-300\" />\r\n                            <p className=\"text-lg font-medium\">  </p>\r\n                            <p className=\"text-sm mt-2\">       </p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Video Grid */}\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        {videos.map((video) => (\r\n                            <div\r\n                                key={video.videoId}\r\n                                className={`bg-white rounded-xl border-2 overflow-hidden transition-all hover:shadow-lg cursor-pointer ${selectedVideoId === video.videoId\r\n                                    ? 'border-red-500 ring-2 ring-red-200'\r\n                                    : 'border-gray-200 hover:border-red-300'\r\n                                    }`}\r\n                                onClick={() => setPreviewVideoId(previewVideoId === video.videoId ? null : video.videoId)}\r\n                            >\r\n                                {/* Thumbnail / Preview */}\r\n                                <div className=\"relative aspect-video bg-gray-100\">\r\n                                    {previewVideoId === video.videoId ? (\r\n                                        <iframe\r\n                                            src={`${video.embedUrl}?autoplay=1&rel=0`}\r\n                                            className=\"w-full h-full\"\r\n                                            allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\"\r\n                                            allowFullScreen\r\n                                        />\r\n                                    ) : (\r\n                                        <>\r\n                                            <img\r\n                                                src={video.thumbnailUrl}\r\n                                                alt={video.title}\r\n                                                className=\"w-full h-full object-cover\"\r\n                                                loading=\"lazy\"\r\n                                                decoding=\"async\"\r\n                                            />\r\n                                            <div className=\"absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 hover:opacity-100 transition-opacity\">\r\n                                                <div className=\"w-14 h-14 rounded-full bg-red-500 flex items-center justify-center\">\r\n                                                    <IconPlay className=\"w-6 h-6 text-white mr-[-2px]\" />\r\n                                                </div>\r\n                                            </div>\r\n                                            {/* Duration Badge */}\r\n                                            <span className=\"absolute bottom-2 left-2 bg-black/80 text-white text-xs px-2 py-1 rounded\">\r\n                                                {video.duration}\r\n                                            </span>\r\n                                        </>\r\n                                    )}\r\n                                </div>\r\n\r\n                                {/* Info */}\r\n                                <div className=\"p-3\">\r\n                                    <h3 className=\"font-medium text-gray-800 line-clamp-2 text-sm mb-1\">\r\n                                        {video.title}\r\n                                    </h3>\r\n                                    <p className=\"text-xs text-gray-500 mb-2\">{video.channelTitle}</p>\r\n\r\n                                    {/* Scores & Meta */}\r\n                                    <div className=\"flex items-center justify-between text-xs\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <span className={`flex items-center gap-1 ${getScoreColor(video.relevanceScore)}`}>\r\n                                                <IconStar className=\"w-3 h-3\" />\r\n                                                {video.relevanceScore}%\r\n                                            </span>\r\n                                            {video.hasCaptions && (\r\n                                                <span className=\"flex items-center gap-1 text-blue-600\">\r\n                                                    <IconSubtitles className=\"w-3 h-3\" />\r\n                                                    \r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                        <span className=\"text-gray-400\">{formatViewCount(video.viewCount)} </span>\r\n                                    </div>\r\n\r\n                                    {/* Select Button */}\r\n                                    <button\r\n                                        onClick={(e) => {\r\n                                            e.stopPropagation();\r\n                                            handleSelectVideo(video);\r\n                                        }}\r\n                                        className=\"w-full mt-3 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors flex items-center justify-center gap-2\"\r\n                                    >\r\n                                        <IconCheck className=\"w-4 h-4\" />\r\n                                          \r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"p-4 border-t border-gray-200 bg-gray-50 text-center text-xs text-gray-500\">\r\n                           \r\n                </div>\r\n            </div>\r\n        </div>,\r\n        document.body\r\n    );\r\n};\r\n\r\nexport default YouTubeSearchModal;\r\n","import React, { useState, useCallback, useMemo } from 'react';\r\nimport ReactFlow, {\r\n    ReactFlowProvider,\r\n    Controls,\r\n    Background,\r\n    MiniMap,\r\n    Panel,\r\n    useNodesState,\r\n    useEdgesState,\r\n    addEdge,\r\n    applyNodeChanges,\r\n    applyEdgeChanges,\r\n    Handle,\r\n    Position,\r\n} from 'reactflow';\r\nimport type { Node, Edge, Connection, NodeChange, EdgeChange } from 'reactflow';\r\nimport 'reactflow/dist/style.css';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport type { MindMapContent, MindMapNode, MindMapEdge } from '../shared/types/courseTypes';\r\nimport { IconPlus, IconTrash, IconPalette, IconCheck, IconX } from '@tabler/icons-react';\r\n\r\ninterface MindMapEditorProps {\r\n    content: MindMapContent;\r\n    onChange: (content: MindMapContent) => void;\r\n    onSave?: () => void;\r\n}\r\n\r\nconst NODE_COLORS = [\r\n    { name: '', value: '#3B82F6' },\r\n    { name: '', value: '#10B981' },\r\n    { name: '', value: '#F59E0B' },\r\n    { name: '', value: '#EF4444' },\r\n    { name: '', value: '#8B5CF6' },\r\n    { name: '', value: '#EC4899' },\r\n    { name: '', value: '#06B6D4' },\r\n    { name: '', value: '#6B7280' },\r\n];\r\n\r\n// Editable Custom Node with connection handles\r\nconst EditableNode = ({ data, id, selected }: { data: any; id: string; selected: boolean }) => {\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [label, setLabel] = useState(data.label);\r\n\r\n    const bgColor = data.color || '#fff';\r\n    const isLightBg = bgColor.toLowerCase() === '#fff' || bgColor.toLowerCase() === '#ffffff' ||\r\n        (bgColor.startsWith('#') && parseInt(bgColor.slice(1, 3), 16) > 180);\r\n    const textColor = isLightBg ? '#1f2937' : '#ffffff';\r\n\r\n    const handleDoubleClick = (e: React.MouseEvent) => {\r\n        e.stopPropagation();\r\n        setIsEditing(true);\r\n    };\r\n\r\n    const handleBlur = () => {\r\n        setIsEditing(false);\r\n        if (data.onLabelChange && label !== data.label) {\r\n            data.onLabelChange(id, label);\r\n        }\r\n    };\r\n\r\n    const handleKeyDown = (e: React.KeyboardEvent) => {\r\n        if (e.key === 'Enter') {\r\n            handleBlur();\r\n        }\r\n        if (e.key === 'Escape') {\r\n            setLabel(data.label);\r\n            setIsEditing(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div\r\n            className={`px-4 py-2 rounded-xl shadow-md border-2 min-w-[100px] text-center cursor-pointer transition-all ${selected ? 'ring-2 ring-blue-500 ring-offset-2' : ''\r\n                }`}\r\n            style={{\r\n                backgroundColor: bgColor,\r\n                borderColor: selected ? '#3B82F6' : `${bgColor}80`,\r\n                direction: 'rtl'\r\n            }}\r\n            onDoubleClick={handleDoubleClick}\r\n        >\r\n            {/* Connection handles */}\r\n            <Handle type=\"target\" position={Position.Top} className=\"w-3 h-3 !bg-blue-400\" />\r\n            <Handle type=\"source\" position={Position.Bottom} className=\"w-3 h-3 !bg-blue-400\" />\r\n            <Handle type=\"target\" position={Position.Right} className=\"w-3 h-3 !bg-blue-400\" />\r\n            <Handle type=\"source\" position={Position.Left} className=\"w-3 h-3 !bg-blue-400\" />\r\n\r\n            {isEditing ? (\r\n                <input\r\n                    type=\"text\"\r\n                    value={label}\r\n                    onChange={(e) => setLabel(e.target.value)}\r\n                    onBlur={handleBlur}\r\n                    onKeyDown={handleKeyDown}\r\n                    className=\"w-full bg-transparent border-none outline-none text-center font-bold text-sm\"\r\n                    style={{ color: textColor }}\r\n                    autoFocus\r\n                    onClick={(e) => e.stopPropagation()}\r\n                />\r\n            ) : (\r\n                <div className=\"font-bold text-sm\" style={{ color: textColor }}>{data.label}</div>\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nconst nodeTypes = {\r\n    default: EditableNode,\r\n    topic: EditableNode,\r\n    subtopic: EditableNode,\r\n    detail: EditableNode,\r\n    example: EditableNode\r\n};\r\n\r\n// MiniMap node color function\r\nconst nodeColor = (node: Node) => {\r\n    return node.data?.color || '#94a3b8';\r\n};\r\n\r\nconst MindMapEditorInner: React.FC<MindMapEditorProps> = ({ content, onChange, onSave }) => {\r\n    const [nodes, setNodes] = useNodesState(content.nodes as Node[]);\r\n    const [edges, setEdges] = useEdgesState(content.edges as Edge[]);\r\n    const [selectedNode, setSelectedNode] = useState<string | null>(null);\r\n    const [showColorPicker, setShowColorPicker] = useState(false);\r\n\r\n    const onNodesChange = useCallback((changes: NodeChange[]) => {\r\n        setNodes((nds) => applyNodeChanges(changes, nds));\r\n    }, [setNodes]);\r\n\r\n    const onEdgesChange = useCallback((changes: EdgeChange[]) => {\r\n        setEdges((eds) => applyEdgeChanges(changes, eds));\r\n    }, [setEdges]);\r\n\r\n    const onConnect = useCallback((params: Connection) => {\r\n        setEdges((eds) => addEdge({\r\n            ...params,\r\n            id: `e-${uuidv4()}`,\r\n            style: { stroke: '#94a3b8', strokeWidth: 2 }\r\n        }, eds));\r\n    }, [setEdges]);\r\n\r\n    const onNodeClick = useCallback((_: React.MouseEvent, node: Node) => {\r\n        setSelectedNode(node.id);\r\n        setShowColorPicker(false);\r\n    }, []);\r\n\r\n    const onPaneClick = useCallback(() => {\r\n        setSelectedNode(null);\r\n        setShowColorPicker(false);\r\n    }, []);\r\n\r\n    const handleAddNode = () => {\r\n        // Find center position or offset from selected node\r\n        let newX = 400;\r\n        let newY = 300;\r\n\r\n        if (selectedNode) {\r\n            const selected = nodes.find(n => n.id === selectedNode);\r\n            if (selected) {\r\n                newX = selected.position.x - 150;\r\n                newY = selected.position.y + 100;\r\n            }\r\n        }\r\n\r\n        const newNode: Node = {\r\n            id: uuidv4(),\r\n            type: 'subtopic',\r\n            data: { label: ' ', color: '#10B981' },\r\n            position: { x: newX, y: newY },\r\n        };\r\n        setNodes((nds) => [...nds, newNode]);\r\n\r\n        // If a node was selected, connect the new node to it\r\n        if (selectedNode) {\r\n            setEdges((eds) => [...eds, {\r\n                id: `e-${uuidv4()}`,\r\n                source: selectedNode,\r\n                target: newNode.id,\r\n                style: { stroke: '#94a3b8', strokeWidth: 2 }\r\n            }]);\r\n        }\r\n\r\n        setSelectedNode(newNode.id);\r\n    };\r\n\r\n    const handleDeleteSelected = () => {\r\n        if (!selectedNode) return;\r\n\r\n        // Don't delete the root node (first node)\r\n        if (nodes.length > 0 && nodes[0].id === selectedNode) {\r\n            alert('     ');\r\n            return;\r\n        }\r\n\r\n        setNodes((nds) => nds.filter((n) => n.id !== selectedNode));\r\n        setEdges((eds) => eds.filter((e) => e.source !== selectedNode && e.target !== selectedNode));\r\n        setSelectedNode(null);\r\n    };\r\n\r\n    const handleColorChange = (color: string) => {\r\n        if (!selectedNode) return;\r\n        setNodes((nds) =>\r\n            nds.map((n) => (n.id === selectedNode ? { ...n, data: { ...n.data, color } } : n))\r\n        );\r\n        setShowColorPicker(false);\r\n    };\r\n\r\n    const handleLabelChange = useCallback((nodeId: string, newLabel: string) => {\r\n        setNodes((nds) =>\r\n            nds.map((n) => (n.id === nodeId ? { ...n, data: { ...n.data, label: newLabel } } : n))\r\n        );\r\n    }, [setNodes]);\r\n\r\n    // Inject onLabelChange into node data\r\n    const nodesWithHandlers = useMemo(() => {\r\n        return nodes.map((n) => ({\r\n            ...n,\r\n            data: { ...n.data, onLabelChange: handleLabelChange },\r\n        }));\r\n    }, [nodes, handleLabelChange]);\r\n\r\n    // Style edges\r\n    const styledEdges = useMemo(() => {\r\n        return edges.map(edge => ({\r\n            ...edge,\r\n            style: { stroke: '#94a3b8', strokeWidth: 2 },\r\n        }));\r\n    }, [edges]);\r\n\r\n    const handleSave = () => {\r\n        const updatedContent: MindMapContent = {\r\n            ...content,\r\n            nodes: nodes as MindMapNode[],\r\n            edges: edges as MindMapEdge[],\r\n        };\r\n        onChange(updatedContent);\r\n        onSave?.();\r\n    };\r\n\r\n    return (\r\n        <div className=\"bg-white rounded-2xl border border-gray-200 overflow-hidden\" dir=\"rtl\">\r\n            <div className=\"h-[500px] relative\">\r\n                <ReactFlow\r\n                    nodes={nodesWithHandlers}\r\n                    edges={styledEdges}\r\n                    nodeTypes={nodeTypes}\r\n                    onNodesChange={onNodesChange}\r\n                    onEdgesChange={onEdgesChange}\r\n                    onConnect={onConnect}\r\n                    onNodeClick={onNodeClick}\r\n                    onPaneClick={onPaneClick}\r\n                    fitView\r\n                    fitViewOptions={{ padding: 0.2 }}\r\n                    proOptions={{ hideAttribution: true }}\r\n                    snapToGrid\r\n                    snapGrid={[15, 15]}\r\n                >\r\n                    <Controls position=\"bottom-left\" />\r\n                    <MiniMap\r\n                        nodeColor={nodeColor}\r\n                        maskColor=\"rgba(240, 240, 240, 0.8)\"\r\n                        position=\"bottom-right\"\r\n                        pannable\r\n                        zoomable\r\n                    />\r\n                    <Background color=\"#e0e7ff\" gap={16} />\r\n\r\n                    {/* Toolbar Panel */}\r\n                    <Panel position=\"top-right\" className=\"flex gap-2 bg-white/95 p-3 rounded-xl shadow-lg border border-gray-200\">\r\n                        <button\r\n                            onClick={handleAddNode}\r\n                            className=\"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors\"\r\n                            title=\" \"\r\n                        >\r\n                            <IconPlus className=\"w-5 h-5\" />\r\n                        </button>\r\n                        <button\r\n                            onClick={handleDeleteSelected}\r\n                            disabled={!selectedNode}\r\n                            className=\"p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed\"\r\n                            title=\"  \"\r\n                        >\r\n                            <IconTrash className=\"w-5 h-5\" />\r\n                        </button>\r\n                        <div className=\"relative\">\r\n                            <button\r\n                                onClick={() => setShowColorPicker(!showColorPicker)}\r\n                                disabled={!selectedNode}\r\n                                className=\"p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed\"\r\n                                title=\" \"\r\n                            >\r\n                                <IconPalette className=\"w-5 h-5\" />\r\n                            </button>\r\n                            {showColorPicker && selectedNode && (\r\n                                <div className=\"absolute top-full left-0 mt-2 p-2 bg-white rounded-xl shadow-xl border border-gray-200 flex flex-wrap gap-1 z-50 w-[140px]\">\r\n                                    {NODE_COLORS.map((c) => (\r\n                                        <button\r\n                                            key={c.value}\r\n                                            onClick={() => handleColorChange(c.value)}\r\n                                            className=\"w-7 h-7 rounded-full border-2 border-white shadow-md hover:scale-110 transition-transform\"\r\n                                            style={{ backgroundColor: c.value }}\r\n                                            title={c.name}\r\n                                        />\r\n                                    ))}\r\n                                    <button\r\n                                        onClick={() => setShowColorPicker(false)}\r\n                                        className=\"w-full mt-1 p-1 text-xs text-gray-500 hover:text-gray-700\"\r\n                                    >\r\n                                        <IconX className=\"w-4 h-4 mx-auto\" />\r\n                                    </button>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                        <div className=\"w-px bg-gray-300 mx-1\" />\r\n                        <button\r\n                            onClick={handleSave}\r\n                            className=\"p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1 px-3\"\r\n                        >\r\n                            <IconCheck className=\"w-5 h-5\" />\r\n                            <span className=\"text-sm font-medium\"></span>\r\n                        </button>\r\n                    </Panel>\r\n                </ReactFlow>\r\n            </div>\r\n            <div className=\"p-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500 text-center\">\r\n                      |     |        \r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n// Wrap with ReactFlowProvider\r\nexport const MindMapEditor: React.FC<MindMapEditorProps> = (props) => {\r\n    return (\r\n        <ReactFlowProvider>\r\n            <MindMapEditorInner {...props} />\r\n        </ReactFlowProvider>\r\n    );\r\n};\r\n\r\nexport default MindMapEditor;\r\n","import { openai, MODEL_NAME } from './geminiApi';\r\n\r\nconst openaiClient = openai;\r\n\r\nexport const generateMindMapFromContent = async (\r\n    sourceText: string,\r\n    topic: string,\r\n    gradeLevel: string,\r\n    maxNodes: number = 12\r\n): Promise<{\r\n    title: string;\r\n    nodes: Array<{\r\n        id: string;\r\n        type: 'topic' | 'subtopic' | 'detail' | 'example';\r\n        data: { label: string; description?: string; color?: string };\r\n        position: { x: number; y: number };\r\n    }>;\r\n    edges: Array<{ id: string; source: string; target: string; type?: string }>;\r\n    suggestedLayout?: string;\r\n} | null> => {\r\n    const trimmedText = sourceText.slice(0, 3000);\r\n    const prompt = `Create a Mind Map for the topic: \"${topic}\"\r\nGrade level: ${gradeLevel}\r\nMaximum nodes: ${maxNodes}\r\n\r\nSource content:\r\n${trimmedText}\r\n\r\nReturn JSON with this structure:\r\n{\r\n    \"title\": \"Map Title\",\r\n    \"nodes\": [\r\n        {\r\n            \"id\": \"node-1\",\r\n            \"type\": \"topic\",\r\n            \"data\": { \"label\": \"Main Topic\", \"description\": \"Short description\", \"color\": \"#4F46E5\" },\r\n            \"position\": { \"x\": 0, \"y\": 0 }\r\n        },\r\n        {\r\n            \"id\": \"node-2\",\r\n            \"type\": \"subtopic\",\r\n            \"data\": { \"label\": \"Subtopic\", \"color\": \"#10B981\" },\r\n            \"position\": { \"x\": 200, \"y\": -100 }\r\n        }\r\n    ],\r\n    \"edges\": [\r\n        { \"id\": \"edge-1\", \"source\": \"node-1\", \"target\": \"node-2\", \"type\": \"smoothstep\" }\r\n    ],\r\n    \"suggestedLayout\": \"RL\"\r\n}\r\n\r\nGuidelines:\r\n- First node (type: \"topic\") is central, positioned at 0,0\r\n- Arrange nodes hierarchically: topic -> subtopic -> detail -> example\r\n- Use different colors for each level\r\n- Create edges between related nodes\r\n- suggestedLayout can be: \"TB\", \"BT\", \"LR\", \"RL\" (right-to-left for Hebrew)`;\r\n\r\n    try {\r\n        const res = await openaiClient.chat.completions.create({\r\n            model: MODEL_NAME,\r\n            messages: [{ role: \"user\", content: prompt }],\r\n            response_format: { type: \"json_object\" },\r\n            temperature: 0.7\r\n        });\r\n        const text = res.choices[0].message.content || \"{}\";\r\n        return JSON.parse(text);\r\n    } catch (e) {\r\n        console.error(\"Mind Map Generation Error\", e);\r\n        return null;\r\n    }\r\n};\r\n","import React, { useState } from 'react';\nimport { createPortal } from 'react-dom';\nimport { generateMindMapFromContent } from '../services/ai/mindMapGenerator';\nimport type { MindMapContent } from '../shared/types/courseTypes';\nimport MindMapViewer from './MindMapViewer';\nimport { IconLoader2, IconSparkles, IconX, IconCheck, IconBrain, IconRefresh } from '@tabler/icons-react';\n\ninterface MindMapGeneratorModalProps {\n    isOpen: boolean;\n    onClose: () => void;\n    onGenerate: (content: MindMapContent) => void;\n    sourceText: string;\n    topic: string;\n    gradeLevel: string;\n}\n\nconst MindMapGeneratorModal: React.FC<MindMapGeneratorModalProps> = ({\n    isOpen,\n    onClose,\n    onGenerate,\n    sourceText,\n    topic,\n    gradeLevel\n}) => {\n    const [isGenerating, setIsGenerating] = useState(false);\n    const [generatedContent, setGeneratedContent] = useState<MindMapContent | null>(null);\n    const [error, setError] = useState<string | null>(null);\n    const [maxNodes, setMaxNodes] = useState(12);\n\n    const handleGenerate = async () => {\n        setIsGenerating(true);\n        setError(null);\n\n        try {\n            const result = await generateMindMapFromContent(sourceText, topic, gradeLevel, maxNodes);\n\n            if (result) {\n                const content: MindMapContent = {\n                    title: result.title,\n                    nodes: result.nodes,\n                    edges: result.edges,\n                    layoutDirection: result.suggestedLayout || 'RL',\n                };\n                setGeneratedContent(content);\n            } else {\n                setError('     .  .');\n            }\n        } catch (err: any) {\n            setError(err.message || '   ');\n        } finally {\n            setIsGenerating(false);\n        }\n    };\n\n    const handleConfirm = () => {\n        if (generatedContent) {\n            onGenerate(generatedContent);\n            handleClose();\n        }\n    };\n\n    const handleClose = () => {\n        setGeneratedContent(null);\n        setError(null);\n        onClose();\n    };\n\n    const handleRegenerate = () => {\n        setGeneratedContent(null);\n        handleGenerate();\n    };\n\n    if (!isOpen) return null;\n\n    return createPortal(\n        <div\n            className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200\"\n            dir=\"rtl\"\n            onClick={(e) => e.target === e.currentTarget && handleClose()}\n        >\n            <div className=\"bg-white rounded-2xl shadow-2xl w-[900px] max-w-[95vw] max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200\">\n                {/* Header */}\n                <div className=\"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-l from-purple-50 to-white\">\n                    <div className=\"flex items-center gap-3\">\n                        <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg\">\n                            <IconBrain className=\"w-6 h-6 text-white\" />\n                        </div>\n                        <div>\n                            <h2 className=\"text-xl font-bold text-gray-800\">  </h2>\n                            <p className=\"text-sm text-gray-500\">   </p>\n                        </div>\n                    </div>\n                    <button\n                        onClick={handleClose}\n                        className=\"p-2 hover:bg-gray-100 rounded-full transition-colors\"\n                    >\n                        <IconX className=\"w-6 h-6 text-gray-500\" />\n                    </button>\n                </div>\n\n                {/* Content */}\n                <div className=\"flex-1 overflow-y-auto p-6\">\n                    {!generatedContent ? (\n                        <div className=\"space-y-6\">\n                            {/* Settings */}\n                            <div className=\"bg-gradient-to-br from-purple-50 to-indigo-50 p-5 rounded-xl border border-purple-100\">\n                                <label className=\"block text-sm font-medium text-gray-700 mb-3\">\n                                      \n                                </label>\n                                <div className=\"flex items-center gap-4\">\n                                    <input\n                                        type=\"range\"\n                                        min=\"6\"\n                                        max=\"20\"\n                                        value={maxNodes}\n                                        onChange={(e) => setMaxNodes(parseInt(e.target.value))}\n                                        className=\"flex-1 h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer accent-purple-600\"\n                                    />\n                                    <div className=\"w-12 h-12 rounded-xl bg-white border-2 border-purple-200 flex items-center justify-center font-bold text-purple-600 text-lg\">\n                                        {maxNodes}\n                                    </div>\n                                </div>\n                                <p className=\"text-xs text-gray-500 mt-2\">\n                                           .       .\n                                </p>\n                            </div>\n\n                            {/* Topic Info */}\n                            {topic && (\n                                <div className=\"bg-blue-50 p-4 rounded-xl border border-blue-100\">\n                                    <div className=\"flex items-center gap-2 text-blue-700\">\n                                        <span className=\"text-lg\"></span>\n                                        <span className=\"font-medium\">:</span>\n                                        <span>{topic}</span>\n                                    </div>\n                                </div>\n                            )}\n\n                            {/* Info */}\n                            <div className=\"text-center py-8\">\n                                <div className=\"text-7xl mb-4\"></div>\n                                <h3 className=\"text-xl font-bold text-gray-800 mb-2\">\n                                       \n                                </h3>\n                                <p className=\"text-gray-500 text-sm max-w-md mx-auto\">\n                                            \n                                        .\n                                </p>\n                            </div>\n\n                            {error && (\n                                <div className=\"bg-red-50 text-red-600 p-4 rounded-xl text-center border border-red-200\">\n                                    <span className=\"text-lg mr-2\"></span>\n                                    {error}\n                                </div>\n                            )}\n\n                            <button\n                                onClick={handleGenerate}\n                                disabled={isGenerating}\n                                className=\"w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold hover:from-purple-700 hover:to-indigo-700 transition-all disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg\"\n                            >\n                                {isGenerating ? (\n                                    <>\n                                        <IconLoader2 className=\"w-5 h-5 animate-spin\" />\n                                          ...\n                                    </>\n                                ) : (\n                                    <>\n                                        <IconSparkles className=\"w-5 h-5\" />\n                                          \n                                    </>\n                                )}\n                            </button>\n                        </div>\n                    ) : (\n                        <div className=\"space-y-4\">\n                            <div className=\"flex items-center justify-between\">\n                                <h3 className=\"font-bold text-lg text-gray-800 flex items-center gap-2\">\n                                    <span className=\"text-2xl\"></span>\n                                     \n                                </h3>\n                                <span className=\"text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full\">\n                                    {generatedContent.nodes.length} \n                                </span>\n                            </div>\n\n                            <MindMapViewer\n                                content={generatedContent}\n                                title={generatedContent.title}\n                                className=\"shadow-lg\"\n                            />\n\n                            <div className=\"bg-amber-50 p-4 rounded-xl border border-amber-200 text-sm text-amber-800\">\n                                <span className=\"font-medium\"> :</span>   ,     -  ,    .\n                            </div>\n\n                            <div className=\"flex gap-3 mt-6\">\n                                <button\n                                    onClick={handleRegenerate}\n                                    disabled={isGenerating}\n                                    className=\"flex-1 py-3 border-2 border-purple-300 text-purple-600 rounded-xl font-bold hover:bg-purple-50 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed\"\n                                >\n                                    {isGenerating ? (\n                                        <>\n                                            <IconLoader2 className=\"w-5 h-5 animate-spin\" />\n                                             ...\n                                        </>\n                                    ) : (\n                                        <>\n                                            <IconRefresh className=\"w-5 h-5\" />\n                                             \n                                        </>\n                                    )}\n                                </button>\n                                <button\n                                    onClick={handleConfirm}\n                                    className=\"flex-1 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold hover:from-purple-700 hover:to-indigo-700 transition-all flex items-center justify-center gap-2 shadow-lg\"\n                                >\n                                    <IconCheck className=\"w-5 h-5\" />\n                                     \n                                </button>\n                            </div>\n                        </div>\n                    )}\n                </div>\n            </div>\n        </div>,\n        document.body\n    );\n};\n\nexport default MindMapGeneratorModal;\n","import React, { useState, useEffect, useRef } from 'react';\r\nimport type { LearningUnit, ActivityBlock } from '../shared/types/courseTypes';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { useCourseStore } from '../context/CourseContext';\r\nimport { AIStarsSpinner } from './ui/Loading/AIStarsSpinner';\r\nimport { TypewriterLoader } from './ui/Loading/TypewriterLoader';\r\nimport { ImageGenerationSkeleton } from './ui/Loading/ImageGenerationSkeleton';\r\nimport {\r\n    refineContentWithPedagogy,\r\n    generateSingleOpenQuestion, generateSingleMultipleChoiceQuestion,\r\n    generateCategorizationQuestion, generateOrderingQuestion, generateFillInBlanksQuestion, generateMemoryGame,\r\n    generateTrueFalseQuestion,\r\n    generateAiImage, BOT_PERSONAS, generateUnitSkeleton, generateStepContent,\r\n    generateInfographicFromText, type InfographicType\r\n} from '../gemini';\r\nimport { mapSystemItemToBlock } from '../shared/utils/geminiParsers';\r\nimport { AudioGenerator } from '../services/audioGenerator'; // AUDIO Feature\r\nimport { PodcastPlayer } from './PodcastPlayer'; // AUDIO Player\r\nimport { SourceViewer } from './SourceViewer';\r\nimport { AiRefineToolbar } from './AiRefineToolbar';\r\nimport { uploadMediaFile } from '../firebaseUtils';\r\nimport { MultimodalService } from '../services/multimodalService'; // Restore Import\r\nimport {\r\n    enrichActivityBlock,\r\n    generateHavanaVariant,\r\n    generateHaamakaVariant\r\n} from '../services/adaptiveContentService';\r\nimport {\r\n    enrichActivityWithImages, isActivityEnriched, generateContextImageBlock, processSuggestedMedia\r\n} from '../services/activityMediaService';\r\nimport { createBlock } from '../shared/config/blockDefinitions'; // DECOUPLER FIX\r\nimport { saveGenerationTiming } from '../services/generationTimingService'; // Speed Analytics\r\nimport { streamActivityContent, isStreamingSupported } from '../services/streamingService'; // NEW: Streaming support\r\nimport { mapSystemItemToBlock as parseStepToBlock } from '../shared/utils/geminiParsers';\r\n\r\n// Feature flag for streaming mode - set to true to use new fast parallel streaming\r\nconst USE_STREAMING_GENERATION = true;\r\n\r\n// ... (existing imports)\r\n\r\n// ... (inside UnitEditor component, after other handlers)\r\n\r\n\r\n\r\n// ... (render logic)\r\n\r\n// Add button in the toolbar (e.g., near Save / Preview)\r\n// Looking at the JSX (not fully visible but inferred placement near header actions)\r\n\r\nimport { ElevenLabsService } from '../services/elevenLabs'; // Added\r\nimport { stripAsterisks } from '../utils/sanitize'; // Clean AI-generated asterisks\r\nimport {\r\n    IconEdit, IconTrash, IconPlus, IconImage, IconVideo, IconText,\r\n    IconChat, IconList, IconSparkles, IconUpload, IconArrowUp,\r\n    IconArrowDown, IconCheck, IconX, IconSave, IconBack,\r\n    IconRobot, IconPalette, IconBalance, IconBrain, IconLink, IconWand, IconEye, IconClock, IconLayer, IconHeadphones, IconBook, IconLoader, IconMicrophone, IconInfographic, IconCopy,\r\n    IconHavana, IconYisum, IconHaamaka, IconRefresh, IconMoreVertical\r\n} from '../icons';\r\nimport { collection, addDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { db } from '../firebase';\r\nimport { createPortal } from 'react-dom';\r\nimport YouTubeSearchModal from './YouTubeSearchModal';\r\nimport type { YouTubeVideoResult } from '../services/youtubeService';\r\nimport MindMapEditor from './MindMapEditor';\r\nimport MindMapGeneratorModal from './MindMapGeneratorModal';\r\nimport type { MindMapContent } from '../shared/types/courseTypes';\r\nimport { RichTextEditor } from './RichTextEditor';\r\n\r\nconst BLOCK_TYPE_MAPPING: Record<string, string> = {\r\n    'text': ' / ',\r\n    'image': '',\r\n    'video': '',\r\n    'multiple-choice': ' ',\r\n    'open-question': ' ',\r\n    'interactive-chat': ' ',\r\n    'fill_in_blanks': ' ',\r\n    'ordering': ' ',\r\n    'categorization': ' ',\r\n    'memory_game': ' ',\r\n    'true_false_speed': '  ',\r\n    'matching': '',\r\n    'highlight': ' ',\r\n    'sentence_builder': ' ',\r\n    'image_labeling': ' ',\r\n    'table_completion': ' ',\r\n    'text_selection': ' ',\r\n    'rating_scale': ' ',\r\n    'matrix': '',\r\n    'audio-response': ' ',\r\n    'mindmap': ' ',\r\n    'activity-intro': '',\r\n    'scenario-image': ' ',\r\n    'infographic': '',\r\n    'podcast': '',\r\n    'loading-placeholder': '...'\r\n};\r\n\r\n// Helper to strip HTML tags for plain text\r\nconst stripHtml = (html: string): string => {\r\n    const div = document.createElement('div');\r\n    div.innerHTML = html;\r\n    return div.textContent || div.innerText || '';\r\n};\r\n\r\n// Generate preview text for collapsed blocks\r\nconst getBlockPreview = (block: any): string => {\r\n    // Helper to extract question text from content object or direct property\r\n    const getQuestionText = () => {\r\n        // First check content.question (new format from parser)\r\n        if (block.content && typeof block.content === 'object' && block.content.question) {\r\n            return block.content.question;\r\n        }\r\n        // Fallback to content.instruction (for ordering, etc.)\r\n        if (block.content && typeof block.content === 'object' && block.content.instruction) {\r\n            return block.content.instruction;\r\n        }\r\n        // Fallback to content.text or content.sentence (for fill_in_blanks)\r\n        if (block.content && typeof block.content === 'object' && (block.content.text || block.content.sentence)) {\r\n            return block.content.text || block.content.sentence;\r\n        }\r\n        // Legacy: direct block.question\r\n        if (block.question) {\r\n            return block.question;\r\n        }\r\n        // Legacy: content as string\r\n        if (typeof block.content === 'string') {\r\n            return block.content;\r\n        }\r\n        return '';\r\n    };\r\n\r\n    switch (block.type) {\r\n        case 'text':\r\n            return stripHtml(typeof block.content === 'string' ? block.content : (block.content?.text || '')).slice(0, 80) || ' ...';\r\n        case 'image':\r\n            return block.content ? ' ' : ' ( )';\r\n        case 'video':\r\n            return block.content ? ' ' : ' ( )';\r\n        case 'multiple-choice':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || ' ';\r\n        case 'open-question':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || ' ';\r\n        case 'interactive-chat':\r\n            return block.content?.systemPrompt?.slice(0, 60) || ' ';\r\n        case 'fill_in_blanks':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || ' ';\r\n        case 'ordering':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || ' ';\r\n        case 'categorization':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || ' ';\r\n        case 'matching':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || '';\r\n        case 'memory_game':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || ' ';\r\n        case 'true_false_speed':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || '  ';\r\n        case 'podcast':\r\n            return '';\r\n        case 'mindmap':\r\n            return ' ';\r\n        case 'audio-response':\r\n            return stripHtml(getQuestionText()).slice(0, 80) || ' ';\r\n        default:\r\n            return BLOCK_TYPE_MAPPING[block.type] || block.type;\r\n    }\r\n};\r\n\r\n// ---   ---\r\nconst IconShield = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z\" />\r\n    </svg>\r\n);\r\n\r\n// Helper to safely extract text from option (string or object)\r\nconst getOptionText = (opt: any): string => {\r\n    if (typeof opt === 'string') return opt;\r\n    if (opt && typeof opt === 'object' && opt.text) return opt.text;\r\n    return '';\r\n};\r\n\r\nconst IconLock = (props: React.SVGProps<SVGSVGElement>) => (\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" {...props}>\r\n        <rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\" />\r\n        <path d=\"M7 11V7a5 5 0 0 1 10 0v4\" />\r\n    </svg>\r\n);\r\n\r\ninterface UnitEditorProps {\r\n    unit: LearningUnit;\r\n    gradeLevel?: string;\r\n    subject?: string;\r\n    onSave: (updatedUnit: any) => void;\r\n    onCancel: () => void;\r\n    onPreview?: (unit: any) => void;\r\n    cancelLabel?: string;\r\n}\r\n\r\nconst getAiActions = (gradeLevel: string) => [\r\n    { label: \" \", prompt: `    ,    ${gradeLevel}` },\r\n    { label: \" \", prompt: \"       \" },\r\n    { label: \" \", prompt: `       ${gradeLevel},   ` },\r\n    { label: \" \", prompt: ` ,    ` },\r\n];\r\n\r\nconst UnitEditor: React.FC<UnitEditorProps> = ({ unit, gradeLevel = \"\", subject, onSave, onCancel, onPreview }) => {\r\n    const { course } = useCourseStore();\r\n    const [editedUnit, setEditedUnit] = useState<LearningUnit>(unit);\r\n    const editedUnitRef = useRef(unit); // Ref to track state for async operations\r\n\r\n    // Sync Ref with State\r\n    useEffect(() => {\r\n        editedUnitRef.current = editedUnit;\r\n    }, [editedUnit]);\r\n\r\n    const [loadingBlockId, setLoadingBlockId] = useState<string | null>(null);\r\n    const [uploadingBlockId, setUploadingBlockId] = useState<string | null>(null);\r\n    const [activeInsertIndex, setActiveInsertIndex] = useState<number | null>(null);\r\n    const [isAutoGenerating, setIsAutoGenerating] = useState(false);\r\n    // const [isGeneratingPodcast, setIsGeneratingPodcast] = useState(false); // Podcast Loading State\r\n    const [showSource, setShowSource] = useState(false); // New: Source Split View State\r\n    const [showHeaderMenu, setShowHeaderMenu] = useState(false); // Dropdown menu state\r\n\r\n    //   :      (image_ai, video_link ')\r\n    const [mediaInputMode, setMediaInputMode] = useState<Record<string, string | null>>({});\r\n    const [mediaInputValue, setMediaInputValue] = useState<Record<string, string>>({});\r\n\r\n    const hasInitialized = useRef(false);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [saveSuccess, setSaveSuccess] = useState(false);\r\n    const [isDirty, setIsDirty] = useState(false);\r\n    // --- Three Levels Editing State ---\r\n    const [blockEditLevel, setBlockEditLevel] = useState<Record<string, '' | '' | ''>>({});\r\n    const [regeneratingVariantBlock, setRegeneratingVariantBlock] = useState<{ blockId: string; level: '' | '' } | null>(null);\r\n\r\n    // --- Podcast Custom Source State ---\r\n    const [podcastSourceMode, setPodcastSourceMode] = useState<Record<string, 'full' | 'custom'>>({});\r\n    const [podcastCustomText, setPodcastCustomText] = useState<Record<string, string>>({});\r\n\r\n    // --- YouTube Search Modal State ---\r\n    const [youtubeSearchOpen, setYoutubeSearchOpen] = useState(false);\r\n    const [youtubeSearchBlockId, setYoutubeSearchBlockId] = useState<string | null>(null);\r\n\r\n    // --- Mind Map Modal State ---\r\n    const [mindMapModalOpen, setMindMapModalOpen] = useState(false);\r\n    const [mindMapBlockId, setMindMapBlockId] = useState<string | null>(null);\r\n\r\n    // --- Block Collapse/Expand State (Google Forms Style) ---\r\n    const [expandedBlockId, setExpandedBlockId] = useState<string | null>(null);\r\n\r\n    const toggleBlockExpand = (blockId: string) => {\r\n        setExpandedBlockId(prev => prev === blockId ? null : blockId);\r\n    };\r\n\r\n    // Handler for YouTube video selection\r\n    const handleYouTubeVideoSelect = async (video: YouTubeVideoResult) => {\r\n        const blockId = youtubeSearchBlockId;\r\n        if (!blockId) return;\r\n\r\n        setLoadingBlockId(blockId);\r\n\r\n        try {\r\n            // Try to get transcript\r\n            let transcript = \"\";\r\n            try {\r\n                const result = await MultimodalService.processYoutubeUrl(video.watchUrl);\r\n                if (result?.text) transcript = result.text;\r\n            } catch (e) {\r\n                console.warn(\"Could not get transcript for YouTube video:\", e);\r\n            }\r\n\r\n            const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n            if (block) {\r\n                updateBlock(blockId, block.content, {\r\n                    media: video.embedUrl,\r\n                    mediaType: 'video',\r\n                    transcript,\r\n                    videoId: video.videoId,\r\n                    videoTitle: video.title,\r\n                    channelTitle: video.channelTitle,\r\n                    duration: video.duration,\r\n                    thumbnailUrl: video.thumbnailUrl,\r\n                    hasCaptions: video.hasCaptions,\r\n                    educationalScore: video.educationalScore,\r\n                    source: 'youtube-search'\r\n                });\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error embedding YouTube video:\", e);\r\n        } finally {\r\n            setLoadingBlockId(null);\r\n            setMediaInputMode({ ...mediaInputMode, [blockId]: null });\r\n        }\r\n    };\r\n\r\n    // Unsaved Changes Protection\r\n    const handleBack = () => {\r\n        if (isDirty) {\r\n            if (window.confirm(\"    .    ?\")) {\r\n                onCancel();\r\n            }\r\n        } else {\r\n            onCancel();\r\n        }\r\n    };\r\n\r\n    // --- Assignment Modal State (Ported) ---\r\n    const [assignmentModalOpen, setAssignmentModalOpen] = useState(false);\r\n    const [assignmentData, setAssignmentData] = useState(() => {\r\n        const defaultDate = new Date();\r\n        defaultDate.setDate(defaultDate.getDate() + 3);\r\n        return {\r\n            title: unit.title || '',\r\n            dueDate: defaultDate.toISOString().split('T')[0],\r\n            dueTime: '23:59',\r\n            instructions: ''\r\n        };\r\n    });\r\n    const [createdAssignmentLink, setCreatedAssignmentLink] = useState<string | null>(null);\r\n\r\n    const handleCopyLinkClick = () => {\r\n        // Warn if there are unsaved changes\r\n        if (isDirty) {\r\n            const proceed = confirm(\r\n                '    !\\n\\n' +\r\n                '   ,      .\\n\\n' +\r\n                '  \"\" ,   \"\"   .'\r\n            );\r\n            if (!proceed) return;\r\n        }\r\n        setAssignmentData(prev => ({ ...prev, title: `: ${unit.title || editedUnit.title}` }));\r\n        setAssignmentModalOpen(true);\r\n    };\r\n\r\n    const handleCreateAssignment = async () => {\r\n        if (!assignmentData.title || !assignmentData.dueDate) return alert(\" \");\r\n        try {\r\n            const combinedDate = new Date(`${assignmentData.dueDate}T${assignmentData.dueTime}`);\r\n            const docRef = await addDoc(collection(db, \"assignments\"), {\r\n                courseId: course.id, // Using current course ID\r\n                title: assignmentData.title,\r\n                dueDate: combinedDate.toISOString(),\r\n                instructions: assignmentData.instructions,\r\n                createdAt: serverTimestamp(),\r\n                teacherId: course.teacherId || \"unknown\"\r\n            });\r\n            const link = `${window.location.origin}/?assignmentId=${docRef.id}`;\r\n            setCreatedAssignmentLink(link);\r\n        } catch (e) {\r\n            console.error(\"Error creating assignment\", e);\r\n            alert(\"  \");\r\n        }\r\n    };\r\n\r\n    const handleCopyCreatedLink = () => {\r\n        if (createdAssignmentLink) {\r\n            navigator.clipboard.writeText(createdAssignmentLink);\r\n        }\r\n    };\r\n\r\n    const handleCloseAssignmentModal = () => {\r\n        setAssignmentModalOpen(false);\r\n        setCreatedAssignmentLink(null);\r\n    };\r\n\r\n    if (!course) return null;\r\n\r\n    const showScoring = course.mode === 'exam' || unit.type === 'test';\r\n    const AI_ACTIONS = getAiActions(gradeLevel);\r\n    const mediaBtnClass = \"cursor-pointer bg-white text-gray-600 hover:text-blue-600 hover:bg-blue-50 border border-gray-200 hover:border-blue-200 px-3 py-1.5 rounded-lg text-xs flex items-center gap-2 transition-all shadow-sm\";\r\n\r\n    // ---     ---\r\n    const totalScore = React.useMemo(() => {\r\n        if (!editedUnit.activityBlocks) return 0;\r\n        return editedUnit.activityBlocks.reduce((sum: number, block: any) => sum + (block.metadata?.score || 0), 0);\r\n    }, [editedUnit.activityBlocks]);\r\n\r\n    useEffect(() => {\r\n        const initContent = async () => {\r\n            // If already filled or initialized, skip\r\n            if ((unit.activityBlocks && unit.activityBlocks.length > 0) || hasInitialized.current) {\r\n                setEditedUnit(unit);\r\n                return;\r\n            }\r\n\r\n            hasInitialized.current = true;\r\n            setIsAutoGenerating(true); // START LOADING STATE\r\n\r\n            const settings = (course as any)?.wizardData?.settings || {};\r\n            const productType = settings.productType || 'lesson'; // Get Product Type\r\n\r\n            //  Initialize timing tracker\r\n            const timer = new (await import('../services/generationTimingService')).GenerationTimer(\r\n                course.id,\r\n                unit.id,\r\n                productType as 'lesson' | 'activity' | 'exam' | 'podcast',\r\n                course\r\n            );\r\n\r\n            try {\r\n                // 1. SKELETON PHASE (Fast)\r\n                console.log(\" Starting Incremental Generation: Skeleton Phase...\");\r\n\r\n                // Add a visual \"Thinking...\" block\r\n                setEditedUnit((prev: any) => ({\r\n                    ...prev,\r\n                    activityBlocks: [\r\n                        { id: 'skeleton-loader', type: 'text', content: '   ,     ...', metadata: { isSkeleton: true } }\r\n                    ]\r\n                }));\r\n\r\n                const targetLength = settings.activityLength || 'medium';\r\n                const safeIncludeBot = settings.includeBot === true;\r\n                const sourceText = course?.fullBookContent || (course as any)?.wizardData?.pastedText || \"\";\r\n\r\n                console.log(\" Source Text Length:\", sourceText?.length || 0);\r\n\r\n                // --- SPECIAL HANDLING FOR PODCAST ---\r\n                if (productType === 'podcast') {\r\n                    console.log(\" Generating Podcast Activity...\");\r\n                    const podcastBlock = {\r\n                        id: uuidv4(),\r\n                        type: 'podcast',\r\n                        content: {\r\n                            title: `: ${unit.title}`,\r\n                            description: \"     .\",\r\n                            // We will trigger script generation via AudioGenerator later or user action\r\n                        },\r\n                        metadata: {\r\n                            autoGenerate: true // Flag to trigger auto-generation in effect if needed\r\n                        }\r\n                    };\r\n\r\n                    setEditedUnit((prev: any) => ({\r\n                        ...prev,\r\n                        activityBlocks: [podcastBlock]\r\n                    }));\r\n\r\n                    // We can also trigger the actual script generation immediately if we have source text\r\n                    if (sourceText) {\r\n                        // Trigger script generation... (We'll rely on the user to click \"Generate\" or do it here)\r\n                        // For now, let's just leave the block so the user sees \"Podcast\"\r\n                    }\r\n\r\n                    setIsAutoGenerating(false);\r\n                    return;\r\n                }\r\n\r\n                // ============================================================\r\n                //  NEW STREAMING PATH - Parallel generation in one call\r\n                // ============================================================\r\n                if (USE_STREAMING_GENERATION && productType === 'activity' && isStreamingSupported()) {\r\n                    console.log(\" Using NEW streaming generation (parallel, faster)...\");\r\n\r\n                    try {\r\n                        const streamStartTime = performance.now();\r\n                        const streamedBlocks: ActivityBlock[] = [];\r\n                        // Track context image block separately to ensure it's not lost during streaming updates\r\n                        let contextImageBlock: ActivityBlock | null = null;\r\n\r\n                        const { result } = await streamActivityContent(\r\n                            {\r\n                                topic: unit.title,\r\n                                gradeLevel,\r\n                                subject: settings.subject || '',\r\n                                sourceText: sourceText,\r\n                                activityLength: targetLength,\r\n                                productType: productType,\r\n                                questionPreferences: settings.questionPreferences,\r\n                                contentTone: settings.contentTone || 'friendly'\r\n                            },\r\n                            {\r\n                                onProgress: (message, metadata) => {\r\n                                    console.log(` [Streaming] ${message}`, metadata);\r\n                                    // Update placeholder with progress\r\n                                    setEditedUnit((prev: any) => ({\r\n                                        ...prev,\r\n                                        activityBlocks: [\r\n                                            { id: 'streaming-progress', type: 'text', content: message, metadata: { isSkeleton: true } }\r\n                                        ]\r\n                                    }));\r\n                                },\r\n                                onSkeletonComplete: (skeleton) => {\r\n                                    console.log(\" [Streaming] Skeleton ready:\", skeleton.steps?.length, \"steps\");\r\n                                    timer.mark('skeleton_complete');\r\n                                    timer.setStepCount(skeleton.steps?.length || 5);\r\n\r\n                                    // Start context image generation in parallel\r\n                                    if (skeleton.context_image_prompt) {\r\n                                        const topic = unit.title || course?.title || '';\r\n                                        const subject = settings.subject || '';\r\n                                        generateContextImageBlock(topic, subject, gradeLevel, skeleton.context_image_prompt)\r\n                                            .then(imgBlock => {\r\n                                                if (imgBlock) {\r\n                                                    console.log(\" [Streaming] Context image ready!\");\r\n                                                    // Store in closure variable so it's preserved across step updates\r\n                                                    contextImageBlock = imgBlock;\r\n                                                    // Also update UI immediately\r\n                                                    setEditedUnit((prev: any) => ({\r\n                                                        ...prev,\r\n                                                        activityBlocks: [imgBlock, ...prev.activityBlocks.filter((b: any) => b.id !== 'streaming-progress' && b.type !== 'activity-intro')]\r\n                                                    }));\r\n                                                }\r\n                                            })\r\n                                            .catch(err => console.warn(\" Context image failed:\", err));\r\n                                    }\r\n                                },\r\n                                onStepComplete: (step, stepNumber, totalSteps) => {\r\n                                    console.log(` [Streaming] Step ${stepNumber}/${totalSteps} complete`);\r\n\r\n                                    // Parse step into blocks\r\n                                    // STUDENT ACTIVITY: Only add teach block if it has actual content\r\n                                    // (teach_content is optional for student activities, required for lessons)\r\n                                    if (step.teach_content && step.teach_content.trim().length > 0) {\r\n                                        const teachBlock: ActivityBlock = {\r\n                                            id: uuidv4(),\r\n                                            type: 'teach',\r\n                                            content: step.teach_content,\r\n                                            metadata: {\r\n                                                stepNumber: step.step_number,\r\n                                                bloomLevel: step.bloom_level\r\n                                            }\r\n                                        };\r\n                                        streamedBlocks.push(teachBlock);\r\n                                    }\r\n\r\n                                    const interactionBlock = mapSystemItemToBlock(step) as ActivityBlock | null;\r\n\r\n                                    console.log(\" [DEBUG] Step from AI:\", JSON.stringify(step, null, 2));\r\n                                    console.log(\" [DEBUG] Parsed block:\", JSON.stringify(interactionBlock, null, 2));\r\n\r\n                                    if (interactionBlock) {\r\n                                        streamedBlocks.push(interactionBlock);\r\n                                    } else {\r\n                                        console.error(\" [DEBUG] Parser returned null for step:\", stepNumber);\r\n                                    }\r\n\r\n                                    // Update UI with new blocks, PRESERVING context image if it exists\r\n                                    setEditedUnit((prev: any) => {\r\n                                        const contentBlocks = streamedBlocks.filter(b => b.id !== 'streaming-progress');\r\n                                        // Prepend context image if available\r\n                                        const allBlocks = contextImageBlock\r\n                                            ? [contextImageBlock, ...contentBlocks]\r\n                                            : contentBlocks;\r\n                                        return {\r\n                                            ...prev,\r\n                                            activityBlocks: allBlocks\r\n                                        };\r\n                                    });\r\n                                },\r\n                                onComplete: (finalResult) => {\r\n                                    const streamDuration = performance.now() - streamStartTime;\r\n                                    console.log(` [Streaming] Complete in ${(streamDuration / 1000).toFixed(1)}s`);\r\n                                    timer.mark('content_complete');\r\n                                },\r\n                                onError: (error) => {\r\n                                    console.error(\" [Streaming] Error:\", error);\r\n                                    throw new Error(error);\r\n                                }\r\n                            }\r\n                        );\r\n\r\n                        // Wait for streaming to complete\r\n                        const finalResult = await result;\r\n                        console.log(\" [Streaming] Final result:\", finalResult.title, \"with\", finalResult.steps?.length, \"steps\");\r\n                        console.log(\" [Streaming] Context image block exists:\", !!contextImageBlock, \"streamedBlocks:\", streamedBlocks.length);\r\n\r\n                        // Ensure all blocks are set (fallback if streaming didn't populate blocks)\r\n                        if (streamedBlocks.length === 0 && finalResult.steps) {\r\n                            // Parse all steps from final result\r\n                            for (const step of finalResult.steps) {\r\n                                // STUDENT ACTIVITY: Only add teach block if it has actual content\r\n                                if (step.teach_content && step.teach_content.trim().length > 0) {\r\n                                    const teachBlock: ActivityBlock = {\r\n                                        id: uuidv4(),\r\n                                        type: 'teach',\r\n                                        content: step.teach_content,\r\n                                        metadata: { stepNumber: step.step_number, bloomLevel: step.bloom_level }\r\n                                    };\r\n                                    streamedBlocks.push(teachBlock);\r\n                                }\r\n\r\n                                const interactionBlock = mapSystemItemToBlock(step) as ActivityBlock | null;\r\n                                if (interactionBlock) {\r\n                                    streamedBlocks.push(interactionBlock);\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        // Final update - preserve context image that was added during streaming\r\n                        const existingContextImage = contextImageBlock || null;\r\n                        console.log(\" [Streaming] Preparing final blocks. contextImageBlock:\", !!contextImageBlock, \"streamedBlocks:\", streamedBlocks.length);\r\n\r\n                        const finalBlocks = existingContextImage\r\n                            ? [existingContextImage, ...streamedBlocks]\r\n                            : streamedBlocks;\r\n\r\n                        console.log(\" [Streaming] Final blocks array created:\", finalBlocks.length, \"with context image:\", !!existingContextImage);\r\n\r\n                        // Update state\r\n                        setEditedUnit((prev: any) => ({\r\n                            ...prev,\r\n                            title: finalResult.title || prev.title,\r\n                            activityBlocks: finalBlocks\r\n                        }));\r\n\r\n                        // Save with the correct blocks directly (don't rely on ref timing)\r\n                        const unitToSave = {\r\n                            ...editedUnitRef.current,\r\n                            title: finalResult.title || editedUnitRef.current.title,\r\n                            activityBlocks: finalBlocks\r\n                        };\r\n                        console.log(\" [Streaming] Saving unit with\", finalBlocks.length, \"blocks\");\r\n                        setTimeout(() => {\r\n                            onSave(unitToSave);\r\n                        }, 100);\r\n\r\n                        // Finish timing\r\n                        await timer.finish(true);\r\n                        setIsAutoGenerating(false);\r\n\r\n                        //  BACKGROUND: Process suggested_media for scenario images/infographics\r\n                        // This runs AFTER the activity is visible to the user\r\n                        if (finalResult.steps?.some((s: any) => s.suggested_media?.needed)) {\r\n                            console.log(\" [Streaming] Processing suggested_media in background...\");\r\n                            const topic = unit.title || course?.title || '';\r\n\r\n                            processSuggestedMedia(finalResult.steps, topic, (step, current, total) => {\r\n                                console.log(` [SuggestedMedia] ${step} (${current}/${total})`);\r\n                            }).then(mediaBlocks => {\r\n                                if (mediaBlocks.size > 0) {\r\n                                    console.log(` [Streaming] Generated ${mediaBlocks.size} media blocks`);\r\n                                    // Insert media blocks before their related questions\r\n                                    setEditedUnit((prev: any) => {\r\n                                        const currentBlocks = [...(prev.activityBlocks || [])];\r\n                                        const newBlocks: ActivityBlock[] = [];\r\n\r\n                                        for (const block of currentBlocks) {\r\n                                            // Check if there's a media block for this step\r\n                                            const stepNumber = block.metadata?.stepNumber;\r\n                                            const mediaBlock = stepNumber ? mediaBlocks.get(stepNumber) : null;\r\n                                            if (mediaBlock) {\r\n                                                newBlocks.push(mediaBlock);\r\n                                            }\r\n                                            newBlocks.push(block);\r\n                                        }\r\n\r\n                                        return { ...prev, activityBlocks: newBlocks };\r\n                                    });\r\n                                    // Save with media\r\n                                    setTimeout(() => onSave(editedUnitRef.current), 100);\r\n                                }\r\n                            }).catch(err => {\r\n                                console.warn(\" [Streaming] suggested_media processing failed:\", err);\r\n                            });\r\n                        }\r\n\r\n                        return; // Exit early - don't run old flow\r\n\r\n                    } catch (streamError: any) {\r\n                        console.warn(\" [Streaming] Failed, falling back to legacy flow:\", streamError.message);\r\n                        // Fall through to legacy flow\r\n                    }\r\n                }\r\n\r\n                // ============================================================\r\n                // LEGACY PATH - Original skeleton + step-by-step generation\r\n                // ============================================================\r\n\r\n                // --- STANDARD SKELETON GENERATION ---\r\n                const skeleton = await generateUnitSkeleton(\r\n                    unit.title,\r\n                    gradeLevel,\r\n                    targetLength,\r\n                    sourceText,\r\n                    course.mode || settings.courseMode || 'learning', // Robust Fallback\r\n                    settings.taxonomy, // Pass Dynamic Bloom Preferences\r\n                    productType as 'lesson' | 'activity' | 'exam' // Pass Product Type for context_image_prompt\r\n                );\r\n\r\n                if (!skeleton || !skeleton.steps) {\r\n                    throw new Error(\"Failed to generate skeleton\");\r\n                }\r\n\r\n                //  Mark skeleton complete\r\n                timer.mark('skeleton_complete');\r\n                timer.setStepCount(skeleton.steps.length);\r\n                console.log(\" Skeleton Ready:\", skeleton.steps.length, \"steps\");\r\n\r\n                //  START CONTEXT IMAGE GENERATION IN PARALLEL (for activities only)\r\n                // This runs concurrently with content generation to reduce total time\r\n                let contextImagePromise: Promise<ActivityBlock | null> | null = null;\r\n                if (productType === 'activity') {\r\n                    const topic = unit.title || course?.title || '';\r\n                    const subject = settings.subject || '';\r\n                    // Use AI-generated context_image_prompt from skeleton if available\r\n                    const customImagePrompt = skeleton.context_image_prompt;\r\n                    console.log(\" [Parallel] Starting context image generation alongside content...\");\r\n                    if (customImagePrompt) {\r\n                        console.log(\" Using AI-generated prompt from skeleton:\", customImagePrompt.substring(0, 100) + \"...\");\r\n                    } else {\r\n                        console.warn(\" No context_image_prompt from skeleton - using generic fallback. Topic:\", topic, \"Subject:\", subject);\r\n                    }\r\n                    contextImagePromise = generateContextImageBlock(topic, subject, gradeLevel, customImagePrompt);\r\n                }\r\n\r\n                // 2. PLACEHOLDER PHASE (Immediate Feedback)\r\n                const placeholderBlocks = skeleton.steps.map((step: any) => ({\r\n                    id: `step-${step.step_number}`, // Temporary ID\r\n                    type: 'loading-placeholder', // Special type for loading state\r\n                    content: {\r\n                        stepNumber: step.step_number,\r\n                        title: step.title,\r\n                        message: ' ...'\r\n                    },\r\n                    metadata: {\r\n                        isLoading: true,\r\n                        stepInfo: step\r\n                    }\r\n                }));\r\n\r\n                const introBlock = {\r\n                    id: uuidv4(),\r\n                    type: 'text',\r\n                    content: `# ! \\n  **${unit.title}**  .\\n   . !`,\r\n                    metadata: {}\r\n                };\r\n\r\n                let botBlock = null;\r\n                if (safeIncludeBot) {\r\n                    const personaId = settings.botPersona || 'socratic';\r\n                    const personaData = BOT_PERSONAS[personaId as keyof typeof BOT_PERSONAS] || BOT_PERSONAS.socratic;\r\n\r\n                    botBlock = {\r\n                        id: uuidv4(),\r\n                        type: 'interactive-chat',\r\n                        content: { title: personaData.name, description: `  ${unit.title}` },\r\n                        metadata: {\r\n                            botPersona: personaId,\r\n                            initialMessage: personaData.initialMessage,\r\n                            systemPrompt: personaData.systemPrompt\r\n                        }\r\n                    };\r\n                }\r\n\r\n                // Update UI with Placeholders\r\n                const finalPlaceholders = [introBlock, ...(botBlock ? [botBlock] : []), ...placeholderBlocks];\r\n                setEditedUnit((prev: any) => ({ ...prev, activityBlocks: finalPlaceholders }));\r\n\r\n                // 3. PARALLEL CONTENT GENERATION (The Magic)\r\n                console.log(\" Triggering Parallel Step Generation...\");\r\n\r\n                // Fire all requests at once (or batch if needed)\r\n                const totalSteps = skeleton.steps.length;\r\n                const promises = skeleton.steps.map(async (step: any) => {\r\n                    const stepContent = await generateStepContent(unit.title, step, gradeLevel, sourceText, undefined, course.mode || 'learning', undefined, totalSteps); // Pass sourceText & totalSteps for scaffolding\r\n\r\n                    console.log(` AI Response for Step ${step.step_number}:`, Object.keys(stepContent || {}));\r\n                    if (stepContent?.teach_content) console.log(`    Found Teach Content for Step ${step.step_number}`);\r\n                    else console.warn(`    NO Teach Content for Step ${step.step_number} (Mode: ${course.mode})`);\r\n\r\n                    if (stepContent) {\r\n                        const newBlocks: any[] = [];\r\n\r\n                        // A. Teach Block\r\n                        if (stepContent.teach_content) {\r\n                            newBlocks.push({\r\n                                id: uuidv4(),\r\n                                type: 'text',\r\n                                content: stepContent.teach_content,\r\n                                metadata: { note: `Step ${step.step_number}` }\r\n                            });\r\n                        }\r\n\r\n                        // B. Interaction Block (Unified Mapper)\r\n                        const interactionBlock = mapSystemItemToBlock(stepContent) as unknown as ActivityBlock | null;\r\n                        if (interactionBlock) {\r\n                            newBlocks.push(interactionBlock);\r\n                        }\r\n\r\n                        // C. Update the SPECIFIC placeholder in state\r\n                        setEditedUnit((currentUnit: any) => {\r\n                            const currentBlocks = [...currentUnit.activityBlocks];\r\n                            const placeholderIndex = currentBlocks.findIndex((b: any) => b.id === `step-${step.step_number}`);\r\n\r\n                            if (placeholderIndex !== -1) {\r\n                                // Replace placeholder with real blocks\r\n                                currentBlocks.splice(placeholderIndex, 1, ...newBlocks);\r\n                            }\r\n                            return { ...currentUnit, activityBlocks: currentBlocks };\r\n                        });\r\n\r\n                        //  BACKGROUND ENRICHMENT (Zero-Click)\r\n                        // This runs AFTER the block is rendered, so the user sees the content immediately.\r\n                        // Then, a few seconds later, the metadata (Bloom, Difficulty) silently updates.\r\n                        if (interactionBlock) {\r\n                            enrichActivityBlock(interactionBlock, unit.title).then(enrichedBlock => {\r\n                                console.log(` Auto-Enriched block ${enrichedBlock.id}`);\r\n                                setEditedUnit((prev: any) => ({\r\n                                    ...prev,\r\n                                    activityBlocks: prev.activityBlocks.map((b: any) =>\r\n                                        b.id === enrichedBlock.id ? enrichedBlock : b\r\n                                    )\r\n                                }));\r\n                            }).catch(err => console.warn(\"Auto-enrichment failed\", err));\r\n                        }\r\n                    }\r\n                });\r\n\r\n                await Promise.all(promises);\r\n\r\n                //  Mark content generation complete\r\n                timer.mark('content_complete');\r\n                console.log(\" All steps generated. Auto-Saving to Firestore...\");\r\n                console.log(\" DEBUG: productType =\", productType, \"| Expected: 'activity'\");\r\n\r\n                //  WAIT FOR CONTEXT IMAGE (started in parallel earlier)\r\n                // This should be ready by now or very soon since it ran alongside content\r\n                let contextImageBlock: ActivityBlock | null = null;\r\n                if (contextImagePromise) {\r\n                    timer.mark('image_start');\r\n                    console.log(\" [Parallel] Waiting for context image to complete...\");\r\n                    contextImageBlock = await contextImagePromise;\r\n                    timer.mark('image_complete');\r\n\r\n                    if (contextImageBlock) {\r\n                        console.log(\" [Parallel] Context image ready! Inserting at beginning...\");\r\n                        // Insert context image as first block\r\n                        setEditedUnit((prev: any) => ({\r\n                            ...prev,\r\n                            activityBlocks: [contextImageBlock, ...prev.activityBlocks]\r\n                        }));\r\n                    } else {\r\n                        console.warn(\" [Parallel] Context image not available, continuing without it\");\r\n                    }\r\n                }\r\n\r\n                // Safe Save: Read from Ref instead of inside setState\r\n                // Small timeout to allow last render to flush\r\n                setTimeout(() => {\r\n                    onSave(editedUnitRef.current);\r\n                }, 100);\r\n\r\n                //  Finish timing and save to Firestore\r\n                await timer.finish(true);\r\n\r\n                // Mark generation as done\r\n                setIsAutoGenerating(false);\r\n\r\n                //  FALLBACK: Only if parallel context image failed\r\n                // We track success with a variable, not by checking state (which is async)\r\n                if (productType === 'activity' && !contextImageBlock) {\r\n                    // Parallel context image failed, try full enrichment as fallback\r\n                    console.log(\" [Fallback] Context image failed, trying full enrichment...\");\r\n                    const topic = unit.title || course?.title || '';\r\n                    const subject = settings.subject || '';\r\n\r\n                    // Use current ref directly - no need for extra delay since we just saved\r\n                    const currentUnit = editedUnitRef.current;\r\n                    if (currentUnit && !isActivityEnriched(currentUnit)) {\r\n                        // Run enrichment in background - don't block\r\n                        enrichActivityWithImages(\r\n                            currentUnit,\r\n                            topic,\r\n                            subject,\r\n                            gradeLevel,\r\n                            (step, current, total) => {\r\n                                console.log(` Media Generation: ${step} (${current}/${total})`);\r\n                            }\r\n                        ).then(enrichedUnit => {\r\n                            console.log(\" Activity enriched with images!\");\r\n                            setEditedUnit(enrichedUnit);\r\n                            onSave(enrichedUnit);\r\n                        }).catch(err => {\r\n                            console.warn(\" Image enrichment failed (activity still works):\", err);\r\n                        });\r\n                    }\r\n                }\r\n\r\n            } catch (error: any) {\r\n                console.error(\"Incremental Auto Generation Failed\", error);\r\n                //  Save timing with error\r\n                await timer.finish(false, error?.message || 'Unknown error');\r\n                setIsAutoGenerating(false);\r\n            }\r\n        };\r\n        initContent();\r\n    }, [unit.id]);\r\n\r\n    // --- Podcast Auto-Trigger ---\r\n    useEffect(() => {\r\n        const pendingPodcast = editedUnit.activityBlocks?.find((b: any) => b.type === 'podcast' && b.metadata?.autoGenerate);\r\n        if (pendingPodcast && !loadingBlockId) {\r\n            console.log(\" Auto-triggering podcast generation for block:\", pendingPodcast.id);\r\n\r\n            // 1. Visually lock immediately to prevent flicker\r\n            setLoadingBlockId(pendingPodcast.id);\r\n\r\n            // 2. Clear the flag to prevent infinite loops (without setting isDirty - this is internal operation)\r\n            setEditedUnit((prev: any) => ({\r\n                ...prev,\r\n                activityBlocks: prev.activityBlocks.map((block: any) =>\r\n                    block.id === pendingPodcast.id\r\n                        ? { ...block, metadata: { ...block.metadata, autoGenerate: false } }\r\n                        : block\r\n                )\r\n            }));\r\n\r\n            // 3. Trigger generation\r\n            handleGeneratePodcastBlock(pendingPodcast.id);\r\n        }\r\n    }, [editedUnit.activityBlocks, loadingBlockId]);\r\n\r\n    const handleSaveWithFeedback = async () => {\r\n        setIsSaving(true);\r\n        try {\r\n            await onSave(editedUnit);\r\n            setTimeout(() => {\r\n                setIsSaving(false);\r\n                setSaveSuccess(true);\r\n                setIsDirty(false); // Reset dirty flag\r\n                setTimeout(() => { setSaveSuccess(false); }, 3000);\r\n            }, 600);\r\n        } catch (error) {\r\n            console.error(\"Save failed\", error);\r\n            setIsSaving(false);\r\n            alert(\" .   .\");\r\n        }\r\n    };\r\n\r\n    const handleAutoDistributePoints = () => {\r\n        const questions = editedUnit.activityBlocks.filter((b: any) => b.type === 'multiple-choice' || b.type === 'open-question');\r\n        const qCount = questions.length;\r\n        if (qCount === 0) return alert(\"     .\");\r\n\r\n        const targetTotalStr = prompt(\"     ?\", \"100\");\r\n        const targetTotal = parseInt(targetTotalStr || \"0\");\r\n        if (!targetTotal || targetTotal <= 0) return;\r\n\r\n        // :  = 2,  = 1\r\n        const totalWeight = questions.reduce((sum: number, block: any) => sum + (block.type === 'open-question' ? 2 : 1), 0);\r\n        const pointPerWeight = Math.floor(targetTotal / totalWeight);\r\n\r\n        let currentSum = 0;\r\n\r\n        // 1.     ( )\r\n        const newBlocks = editedUnit.activityBlocks.map((block: any) => {\r\n            if (block.type === 'multiple-choice' || block.type === 'open-question') {\r\n                const weight = block.type === 'open-question' ? 2 : 1;\r\n                const score = pointPerWeight * weight;\r\n                currentSum += score;\r\n                return { ...block, metadata: { ...block.metadata, score } };\r\n            }\r\n            return block;\r\n        });\r\n\r\n        // 2.   (Round Robin)\r\n        let remainder = targetTotal - currentSum;\r\n        let i = 0;\r\n        while (remainder > 0) {\r\n            const blockIndex = newBlocks.findIndex((b: any, idx: number) => (b.type === 'multiple-choice' || b.type === 'open-question') && idx >= i);\r\n\r\n            //      \r\n            if (blockIndex !== -1) {\r\n                newBlocks[blockIndex].metadata.score += 1;\r\n                remainder -= 1;\r\n                i = blockIndex + 1;\r\n            } else {\r\n                i = 0; //     \r\n            }\r\n        }\r\n\r\n        setEditedUnit({ ...editedUnit, activityBlocks: newBlocks });\r\n    };\r\n\r\n    const moveBlock = (index: number, direction: 'up' | 'down') => {\r\n        const newBlocks = [...editedUnit.activityBlocks];\r\n        if (direction === 'up' && index > 0) {\r\n            [newBlocks[index], newBlocks[index - 1]] = [newBlocks[index - 1], newBlocks[index]];\r\n        } else if (direction === 'down' && index < newBlocks.length - 1) {\r\n            [newBlocks[index], newBlocks[index + 1]] = [newBlocks[index + 1], newBlocks[index]];\r\n        }\r\n        setEditedUnit({ ...editedUnit, activityBlocks: newBlocks });\r\n    };\r\n\r\n    const generatePedagogicalPrompt = (personaId: string, customCharName: string = \"\"): string => {\r\n        const baseInfo = `      : ${gradeLevel}.  : \"${editedUnit.title}\".`;\r\n        const safetyProtocol = `  (): 1.    . 2.       -      .`;\r\n        let specificInstructions = \"\";\r\n\r\n        if (showScoring) {\r\n            specificInstructions = `  (EXAM MODE):      .      .`;\r\n        } else {\r\n            const persona = BOT_PERSONAS[personaId as keyof typeof BOT_PERSONAS] || BOT_PERSONAS.socratic;\r\n            if (personaId === 'historical') {\r\n                specificInstructions = `   ${customCharName || ' '}.`;\r\n            } else {\r\n                specificInstructions = persona.systemPrompt;\r\n            }\r\n        }\r\n        return `${baseInfo}\\n${specificInstructions}\\n${safetyProtocol}`;\r\n    };\r\n\r\n    const addBlockAtIndex = async (type: string, index: number) => {\r\n        // Use course default persona if available, otherwise Socratic\r\n        const initialPersonaId = course.botPersona || 'socratic';\r\n\r\n        // DECOUPLER FIX: Use Factory\r\n        const newBlock = createBlock(type, initialPersonaId);\r\n\r\n        const newBlocks = [...(editedUnit.activityBlocks || [])];\r\n        newBlocks.splice(index, 0, newBlock);\r\n        setEditedUnit({ ...editedUnit, activityBlocks: newBlocks });\r\n        setIsDirty(true);\r\n        setActiveInsertIndex(null);\r\n        // Auto-expand newly added block\r\n        setExpandedBlockId(newBlock.id);\r\n\r\n        // AUTO-GENERATE: For interactive block types, immediately generate content in unit context\r\n        const autoGenerateTypes = ['fill_in_blanks', 'ordering', 'categorization', 'memory_game', 'multiple-choice', 'true_false_speed'];\r\n        if (autoGenerateTypes.includes(type)) {\r\n            // Trigger auto-generation after block is added\r\n            setTimeout(() => {\r\n                switch (type) {\r\n                    case 'fill_in_blanks':\r\n                        handleAutoGenerateFillInBlanks(newBlock.id);\r\n                        break;\r\n                    case 'ordering':\r\n                        handleAutoGenerateOrdering(newBlock.id);\r\n                        break;\r\n                    case 'categorization':\r\n                        handleAutoGenerateCategorization(newBlock.id);\r\n                        break;\r\n                    case 'memory_game':\r\n                        handleAutoGenerateMemoryGame(newBlock.id);\r\n                        break;\r\n                    case 'multiple-choice':\r\n                        handleAutoGenerateMCQuestion(newBlock.id);\r\n                        break;\r\n                    case 'true_false_speed':\r\n                        handleAutoGenerateTrueFalseQuestion(newBlock.id);\r\n                        break;\r\n                }\r\n            }, 100);\r\n        }\r\n    };\r\n\r\n    const deleteBlock = (blockId: string) => {\r\n        if (confirm(\"  ?\")) setEditedUnit({ ...editedUnit, activityBlocks: editedUnit.activityBlocks.filter((b: any) => b.id !== blockId) });\r\n    };\r\n\r\n    const updateBlock = (blockId: string, newContent: any, newMetadata?: any) => {\r\n        setEditedUnit((prev: any) => ({\r\n            ...prev,\r\n            activityBlocks: prev.activityBlocks.map((block: any) =>\r\n                block.id === blockId ? { ...block, content: newContent, metadata: { ...block.metadata, ...newMetadata } } : block\r\n            )\r\n        }));\r\n        setIsDirty(true);\r\n    };\r\n\r\n    // --- Three Levels Helper Functions ---\r\n    const getBlockContentForLevel = (block: any, level: '' | '' | ''): any => {\r\n        let content;\r\n        if (level === '') {\r\n            content = block.content;\r\n        } else {\r\n            const variantKey = level === '' ? 'scaffolding_variant' : 'enrichment_variant';\r\n            const variant = block.metadata?.[variantKey];\r\n            content = variant?.content || block.content;\r\n        }\r\n        // Clean asterisks from text content for display\r\n        if (typeof content === 'string') {\r\n            return stripAsterisks(content);\r\n        }\r\n        return content;\r\n    };\r\n\r\n    const updateBlockForLevel = (blockId: string, content: any, level: '' | '' | '') => {\r\n        if (level === '') {\r\n            updateBlock(blockId, content);\r\n        } else {\r\n            const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n            if (!block) return;\r\n            const variantKey = level === '' ? 'scaffolding_variant' : 'enrichment_variant';\r\n            const existingVariant = block.metadata?.[variantKey] || {};\r\n            updateBlock(blockId, block.content, {\r\n                [variantKey]: { ...existingVariant, content },\r\n                has_variants: true\r\n            });\r\n        }\r\n    };\r\n\r\n    const regenerateVariant = async (blockId: string, level: '' | '') => {\r\n        const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n        if (!block) return;\r\n\r\n        setRegeneratingVariantBlock({ blockId, level });\r\n        try {\r\n            const topic = editedUnit.title || ' ';\r\n            let variant = null;\r\n\r\n            if (level === '') {\r\n                variant = await generateHavanaVariant(block, topic);\r\n            } else {\r\n                variant = await generateHaamakaVariant(block, topic);\r\n            }\r\n\r\n            if (variant) {\r\n                const variantKey = level === '' ? 'scaffolding_variant' : 'enrichment_variant';\r\n                updateBlock(blockId, block.content, {\r\n                    [variantKey]: variant,\r\n                    has_variants: true\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.error(`Failed to regenerate ${level} variant:`, error);\r\n            alert(`   ${level}`);\r\n        } finally {\r\n            setRegeneratingVariantBlock(null);\r\n        }\r\n    };\r\n\r\n    // LevelSelector Component for Three Levels Editing\r\n    const LevelSelector: React.FC<{\r\n        blockId: string;\r\n        hasVariants: boolean;\r\n        currentLevel: '' | '' | '';\r\n        onChange: (level: '' | '' | '') => void;\r\n    }> = ({ blockId, hasVariants, currentLevel, onChange }) => {\r\n        if (!hasVariants) return null;\r\n\r\n        const levels = [\r\n            { key: '' as const, label: '' },\r\n            { key: '' as const, label: '' },\r\n            { key: '' as const, label: '' }\r\n        ];\r\n\r\n        const isRegenerating = regeneratingVariantBlock?.blockId === blockId;\r\n\r\n        return (\r\n            <div className=\"flex items-center gap-2 bg-white border border-gray-200 p-1 rounded-lg\">\r\n                {levels.map(level => (\r\n                    <button\r\n                        key={level.key}\r\n                        onClick={() => onChange(level.key)}\r\n                        className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all\r\n                            ${currentLevel === level.key\r\n                                ? 'bg-gray-700 text-white shadow-sm'\r\n                                : 'text-gray-600 hover:bg-gray-100'}`}\r\n                    >\r\n                        {level.label}\r\n                    </button>\r\n                ))}\r\n                {/* Regenerate button for non- levels */}\r\n                {currentLevel !== '' && (\r\n                    <button\r\n                        onClick={() => regenerateVariant(blockId, currentLevel)}\r\n                        disabled={isRegenerating}\r\n                        className=\"p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors disabled:opacity-50\"\r\n                        title={`   ${currentLevel}`}\r\n                    >\r\n                        {isRegenerating && regeneratingVariantBlock?.level === currentLevel\r\n                            ? <div className=\"w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin\" />\r\n                            : <IconRefresh className=\"w-4 h-4\" />}\r\n                    </button>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const handlePersonaChange = (blockId: string, newPersona: string, currentContent: any) => {\r\n        const newPrompt = generatePedagogicalPrompt(newPersona, \"\");\r\n        updateBlock(blockId, currentContent, { botPersona: newPersona, systemPrompt: newPrompt });\r\n    };\r\n\r\n    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>, blockId: string, field: 'content' | 'metadata' = 'content') => {\r\n        const file = e.target.files?.[0];\r\n        if (!file) return;\r\n\r\n        if (file.type.startsWith('video') && file.size > 50 * 1024 * 1024) {\r\n            alert(\"   .    50MB.\");\r\n            return;\r\n        }\r\n\r\n        setUploadingBlockId(blockId);\r\n        try {\r\n            const url = await uploadMediaFile(file, file.type.startsWith('video') ? 'videos' : 'images');\r\n            if (field === 'content') updateBlock(blockId, url, { fileName: file.name, uploadedFileUrl: url, mediaType: file.type.startsWith('video') ? 'video' : 'image' });\r\n            else {\r\n                const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n                if (block) updateBlock(blockId, block.content, { media: url, mediaType: file.type.startsWith('video') ? 'video' : 'image' });\r\n            }\r\n        } catch (err: any) { alert(err.message || \"\"); } finally { setUploadingBlockId(null); }\r\n    };\r\n\r\n    const handleAiAction = async (blockId: string, text: string, actionPrompt: string) => { if (!text) return; setLoadingBlockId(blockId); try { const res = await refineContentWithPedagogy(text, actionPrompt); updateBlock(blockId, res); } catch (e) { alert(\"\"); } finally { setLoadingBlockId(null); } };\r\n\r\n    const handleAutoGenerateOpenQuestion = async (blockId: string) => {\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            // Context Aggregation: Global Source + Local Video Transcripts\r\n            const videoTranscripts = editedUnit.activityBlocks\r\n                .map((b: any) => b.metadata?.transcript).filter((t: any) => t).join(\"\\n\\n\");\r\n\r\n            const sourceText = (course.fullBookContent || \"\") + (videoTranscripts ? `\\n\\n--- Video Transcripts ---\\n${videoTranscripts}` : \"\");\r\n\r\n            // Fallback if no content at all\r\n            if (!sourceText || sourceText.length < 10) {\r\n                const userTopic = prompt(\"     .     ?\");\r\n                if (!userTopic) return;\r\n                // We'll proceed with the topic as source\r\n                const result = await generateSingleOpenQuestion(editedUnit.title, gradeLevel, {}, userTopic);\r\n                if (result) updateBlock(blockId, { question: result.content.question }, { modelAnswer: result.metadata.modelAnswer });\r\n                return;\r\n            }\r\n\r\n            const result = await generateSingleOpenQuestion(editedUnit.title, gradeLevel, {}, sourceText);\r\n            if (result) {\r\n                updateBlock(blockId, { question: result.content.question }, { modelAnswer: result.metadata.modelAnswer });\r\n            } else {\r\n                alert(\"   .   .\");\r\n            }\r\n        } catch (e) {\r\n            alert(\"\");\r\n        } finally {\r\n            setLoadingBlockId(null);\r\n        }\r\n    };\r\n    const handleAutoGenerateMCQuestion = async (blockId: string) => {\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            // Context Aggregation: Global Source + Local Video Transcripts\r\n            const videoTranscripts = editedUnit.activityBlocks\r\n                .map((b: any) => b.metadata?.transcript).filter((t: any) => t).join(\"\\n\\n\");\r\n\r\n            const sourceText = (course.fullBookContent || \"\") + (videoTranscripts ? `\\n\\n--- Video Transcripts ---\\n${videoTranscripts}` : \"\");\r\n\r\n            if (!sourceText || sourceText.length < 10) {\r\n                const userTopic = prompt(\"     .     ?\");\r\n                if (!userTopic) return;\r\n                const result = await generateSingleMultipleChoiceQuestion(editedUnit.title, gradeLevel, {}, userTopic, subject);\r\n                if (result) updateBlock(blockId, { question: result.content.question, options: result.content.options, correctAnswer: result.content.correctAnswer });\r\n                return;\r\n            }\r\n\r\n            const result = await generateSingleMultipleChoiceQuestion(editedUnit.title, gradeLevel, {}, sourceText, subject);\r\n            if (result) {\r\n                updateBlock(blockId, { question: result.content.question, options: result.content.options, correctAnswer: result.content.correctAnswer });\r\n            } else {\r\n                alert(\"   .   .\");\r\n            }\r\n        } catch (e) {\r\n            alert(\"\");\r\n        } finally {\r\n            setLoadingBlockId(null);\r\n        }\r\n    };\r\n\r\n    // --- NEW GENERATORS ---\r\n    const handleAutoGenerateCategorization = async (blockId: string) => {\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            const sourceText = course.fullBookContent || \"\";\r\n            const result = await generateCategorizationQuestion(editedUnit.title, gradeLevel, sourceText, subject);\r\n            if (result) {\r\n                const { learning_level, ...content } = result;\r\n                updateBlock(blockId, content, { learningLevel: learning_level || '' });\r\n            }\r\n        } catch (e) { alert(\"\"); } finally { setLoadingBlockId(null); }\r\n    };\r\n    const handleAutoGenerateOrdering = async (blockId: string) => {\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            const sourceText = course.fullBookContent || \"\";\r\n            const result = await generateOrderingQuestion(editedUnit.title, gradeLevel, sourceText, subject);\r\n            if (result) {\r\n                const { learning_level, ...content } = result;\r\n                updateBlock(blockId, content, { learningLevel: learning_level || '' });\r\n            }\r\n        } catch (e) { alert(\"\"); } finally { setLoadingBlockId(null); }\r\n    };\r\n    const handleAutoGenerateFillInBlanks = async (blockId: string) => {\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            const sourceText = course.fullBookContent || \"\";\r\n            const result = await generateFillInBlanksQuestion(editedUnit.title, gradeLevel, sourceText, subject);\r\n            if (result) {\r\n                // result can be { text: string, learning_level: string } or just string for backwards compatibility\r\n                const content = typeof result === 'object' ? result.text : result;\r\n                const learningLevel = typeof result === 'object' ? result.learning_level : '';\r\n                // Store as string to maintain backwards compatibility with existing fill_in_blanks blocks\r\n                updateBlock(blockId, content, { learningLevel: learningLevel || '' });\r\n            }\r\n        } catch (e) { alert(\"\"); } finally { setLoadingBlockId(null); }\r\n    };\r\n    const handleAutoGenerateMemoryGame = async (blockId: string) => {\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            const sourceText = course.fullBookContent || \"\";\r\n            const result = await generateMemoryGame(editedUnit.title, gradeLevel, sourceText, subject);\r\n            if (result) {\r\n                const { learning_level, ...content } = result;\r\n                updateBlock(blockId, content, { learningLevel: learning_level || '' });\r\n            }\r\n        } catch (e) { alert(\"\"); } finally { setLoadingBlockId(null); }\r\n    };\r\n    const handleAutoGenerateTrueFalseQuestion = async (blockId: string) => {\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            const sourceText = course.fullBookContent || \"\";\r\n            // Generate a true/false statement based on unit content\r\n            const result = await generateTrueFalseQuestion(editedUnit.title, gradeLevel, sourceText, subject);\r\n            if (result) {\r\n                const { learning_level, ...content } = result;\r\n                updateBlock(blockId, content, { learningLevel: learning_level || '' });\r\n            }\r\n        } catch (e) { alert(\"\"); } finally { setLoadingBlockId(null); }\r\n    };\r\n\r\n    // --- :      ---\r\n    const handleGeneratePodcastBlock = async (blockId: string) => {\r\n        if (!ElevenLabsService.isConfigured()) {\r\n            alert(\"  API  ElevenLabs  .env   .\");\r\n            return;\r\n        }\r\n\r\n        setLoadingBlockId(blockId);\r\n\r\n        // IMMEDIATE FEEDBACK: Update the block to show it's working\r\n        // currently we can't easily use setEditedUnit inside this if called from effect? \r\n        // We can, but need to be careful.\r\n        // Let's use updateBlock which updates state safely.\r\n        updateBlock(blockId, {\r\n            title: \" ...\",\r\n            script: null,\r\n            audioUrl: null,\r\n            description: \"    ...   (    )\"\r\n        });\r\n\r\n        try {\r\n            const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n            const mode = podcastSourceMode[blockId] || 'full';\r\n            let sourceText = \"\";\r\n\r\n            if (mode === 'custom') {\r\n                sourceText = podcastCustomText[blockId] || \"\";\r\n                if (!sourceText || sourceText.length < 50) {\r\n                    alert(\"      50 .\");\r\n                    return;\r\n                }\r\n            } else {\r\n                sourceText = course.fullBookContent || \"\";\r\n\r\n                // FALLBACK: If no course source, aggregate text from the unit's text blocks\r\n                if (!sourceText || sourceText.length < 50) {\r\n                    sourceText = editedUnit.activityBlocks\r\n                        .filter((b: any) => b.type === 'text' && typeof b.content === 'string')\r\n                        .map((b: any) => b.content)\r\n                        .join('\\n\\n');\r\n                }\r\n\r\n                if (!sourceText || sourceText.length < 50) {\r\n                    alert(\"    .\\n\\n     ,      .\\n        ' '.\");\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // setIsGeneratingPodcast(true);\r\n            setLoadingBlockId(blockId);\r\n            console.log(\" Starting Podcast Generation for Grade:\", gradeLevel);\r\n\r\n            try {\r\n                const script = await AudioGenerator.generateScript({\r\n                    sourceText: sourceText.substring(0, 15000), // Safety Cap\r\n                    targetAudience: gradeLevel || \"Student\", // PEDAGOGY FIX: Pass the actual grade level\r\n                    language: \"he\",\r\n                    focusTopic: editedUnit.title\r\n                });\r\n\r\n                if (script) {\r\n                    // 1. Update the Podcast Block with the script\r\n                    const updatedPodcastBlock = {\r\n                        ...editedUnit.activityBlocks.find(b => b.id === blockId),\r\n                        content: {\r\n                            title: \"  \",\r\n                            description: \"        .\",\r\n                            script: script,\r\n                            audioUrl: null\r\n                        },\r\n                        metadata: { autoGenerate: false }\r\n                    };\r\n\r\n                    // 2. Generate Follow-up Questions (Assessment)\r\n                    // We'll use the script itself as the source for the questions!\r\n                    const scriptText = script.lines.map(l => `${l.speaker}: ${l.text}`).join('\\n');\r\n\r\n                    // A. Multiple Choice\r\n                    const mcqBlock = await generateSingleMultipleChoiceQuestion(\r\n                        editedUnit.title,\r\n                        gradeLevel,\r\n                        [],\r\n                        scriptText\r\n                    );\r\n\r\n                    // B. Open Question\r\n                    const openBlock = await generateSingleOpenQuestion(\r\n                        editedUnit.title,\r\n                        gradeLevel,\r\n                        [],\r\n                        scriptText\r\n                    );\r\n\r\n                    // 3. Update State with ALL new blocks\r\n                    setEditedUnit(prev => {\r\n                        const newBlocks = [...prev.activityBlocks];\r\n                        const podcastIndex = newBlocks.findIndex(b => b.id === blockId);\r\n\r\n                        if (podcastIndex !== -1) {\r\n                            newBlocks[podcastIndex] = updatedPodcastBlock as ActivityBlock;\r\n\r\n                            // Insert questions AFTER the podcast\r\n                            if (mcqBlock) {\r\n                                mcqBlock.id = uuidv4(); // Ensure unique\r\n                                newBlocks.splice(podcastIndex + 1, 0, mcqBlock as ActivityBlock);\r\n                            }\r\n                            if (openBlock) {\r\n                                openBlock.id = uuidv4(); // Ensure unique\r\n                                newBlocks.splice(podcastIndex + 2, 0, openBlock as ActivityBlock);\r\n                            }\r\n                        }\r\n                        return { ...prev, activityBlocks: newBlocks };\r\n                    });\r\n\r\n                } else {\r\n                    alert(\"  .  .\");\r\n                }\r\n            } catch (error) {\r\n                console.error(error);\r\n                alert(\"\");\r\n            } finally {\r\n                setLoadingBlockId(null);\r\n            }\r\n        } catch (e: any) {\r\n            console.error(\"Outer error in podcast generation:\", e);\r\n            alert(\"   \");\r\n            setLoadingBlockId(null);\r\n        }\r\n    };\r\n\r\n    // --- :    -AI (     - ) ---\r\n    const handleGenerateAiImage = async (blockId: string, targetField: 'content' | 'metadata' = 'content') => {\r\n        const prompt = mediaInputValue[blockId];\r\n        if (!prompt) return;\r\n\r\n        setLoadingBlockId(blockId);\r\n        try {\r\n            const imageBlob = await generateAiImage(prompt);\r\n            if (!imageBlob) throw new Error(\"Failed to generate image\");\r\n\r\n            const fileName = `ai_gen_${uuidv4()}.png`;\r\n            const file = new File([imageBlob], fileName, { type: \"image/png\" });\r\n            const url = await uploadMediaFile(file, 'images');\r\n\r\n            //    (   -  )\r\n            if (targetField === 'content') {\r\n                updateBlock(blockId, url, { mediaType: 'image', aiPrompt: prompt });\r\n            } else {\r\n                const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n                if (block) updateBlock(blockId, block.content, { media: url, mediaType: 'image', aiPrompt: prompt });\r\n            }\r\n\r\n            setMediaInputMode((prev: any) => ({ ...prev, [blockId]: null }));\r\n        } catch (error) {\r\n            console.error(\"AI Generation Error:\", error);\r\n            alert(\"  .  .\");\r\n        } finally {\r\n            setLoadingBlockId(null);\r\n        }\r\n    };\r\n\r\n    const handleAddRelatedQuestion = (blockId: string, type: 'open-question' | 'multiple-choice') => {\r\n        const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n        if (!block) return;\r\n        const newQuestionData = type === 'multiple-choice'\r\n            ? { type, question: '', options: ['', '', '', ''], correctAnswer: '' }\r\n            : { type, question: '' };\r\n        updateBlock(blockId, block.content, { relatedQuestion: newQuestionData });\r\n    };\r\n\r\n    const updateRelatedQuestion = (blockId: string, updatedData: any) => {\r\n        const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n        if (!block) return;\r\n        updateBlock(blockId, block.content, { relatedQuestion: { ...(block.metadata?.relatedQuestion || {}), ...updatedData } });\r\n    };\r\n\r\n    const removeRelatedQuestion = (blockId: string) => {\r\n        const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n        if (block) updateBlock(blockId, block.content, { relatedQuestion: null });\r\n    };\r\n\r\n    const renderRelatedQuestionEditor = (blockId: string, relatedQ: any) => {\r\n        if (!relatedQ) return null;\r\n        return (\r\n            <div className=\"mt-4 pt-4 border-t border-gray-100 bg-gray-50/50 rounded-xl p-4\">\r\n                <div className=\"flex justify-between items-center mb-2\">\r\n                    <span className=\"text-xs font-bold text-gray-500 uppercase flex items-center gap-1\"><IconSparkles className=\"w-3 h-3\" />  </span>\r\n                    <button onClick={() => removeRelatedQuestion(blockId)} className=\"text-red-400 hover:text-red-600 p-1\"><IconTrash className=\"w-3 h-3\" /></button>\r\n                </div>\r\n                <input type=\"text\" className=\"w-full font-bold p-2 bg-white border border-gray-200 rounded-lg mb-2 focus:border-blue-400 outline-none\" value={relatedQ.question} onChange={(e) => updateRelatedQuestion(blockId, { question: e.target.value })} placeholder=\"   ...\" />\r\n                {relatedQ.type === 'multiple-choice' && (\r\n                    <div className=\"space-y-2\">\r\n                        {relatedQ.options?.map((opt: any, idx: number) => {\r\n                            const optText = getOptionText(opt);\r\n                            return (\r\n                                <div key={idx} className=\"flex items-center gap-2\">\r\n                                    <button onClick={() => updateRelatedQuestion(blockId, { correctAnswer: optText })} className={`w-5 h-5 rounded-full border flex items-center justify-center ${relatedQ.correctAnswer === optText ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-gray-300'}`}>{relatedQ.correctAnswer === optText && <IconCheck className=\"w-3 h-3\" />}</button>\r\n                                    <input type=\"text\" className=\"flex-1 p-1.5 text-sm border border-gray-200 rounded bg-white\" value={optText} onChange={(e) => {\r\n                                        const newOpts = [...relatedQ.options];\r\n                                        if (typeof newOpts[idx] === 'object') newOpts[idx] = { ...newOpts[idx], text: e.target.value };\r\n                                        else newOpts[idx] = e.target.value;\r\n                                        updateRelatedQuestion(blockId, { options: newOpts });\r\n                                    }} placeholder={` ${idx + 1}`} />\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const getEmbedUrl = (url: string) => {\r\n        const regExp = /^.*(youtu.be\\/|v\\/|u\\/\\w\\/|embed\\/|watch\\?v=|&v=)([^#&?]*).*/;\r\n        const match = url.match(regExp);\r\n        return (match && match[2].length === 11) ? `https://www.youtube.com/embed/${match[2]}` : url;\r\n    };\r\n\r\n    // --- New: Unified Media Toolbar for Questions (Upload / AI / Link) ---\r\n    const renderMediaToolbar = (blockId: string) => {\r\n        const mode = mediaInputMode[blockId]; // 'image_select', 'video_select', 'image_ai', 'video_link'\r\n\r\n        // 1.   -    \r\n        if (!mode) {\r\n            return (\r\n                <div className=\"flex gap-2\">\r\n                    <button onClick={() => setMediaInputMode({ ...mediaInputMode, [blockId]: 'image_select' })} className={mediaBtnClass} title=\" \"><IconImage className=\"w-4 h-4\" /> </button>\r\n                    <button onClick={() => setMediaInputMode({ ...mediaInputMode, [blockId]: 'video_select' })} className={mediaBtnClass} title=\" \"><IconVideo className=\"w-4 h-4\" /> </button>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        // 2.    (  AI)\r\n        if (mode === 'image_select') {\r\n            return (\r\n                <div className=\"flex gap-2 bg-blue-50 p-1 rounded-lg animate-scale-in\">\r\n                    <label className={mediaBtnClass}><IconUpload className=\"w-4 h-4\" /> <input type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={(e) => { handleFileUpload(e, blockId, 'metadata'); setMediaInputMode({ ...mediaInputMode, [blockId]: null }); }} /></label>\r\n                    <button onClick={() => {\r\n                        const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n                        let defaultPrompt = '';\r\n                        if (block) {\r\n                            const content = block.content;\r\n                            if (typeof content === 'string') {\r\n                                defaultPrompt = stripHtml(content).substring(0, 100);\r\n                            } else if (content) {\r\n                                const rawText = content.question || content.text || content.title || content.prompt || content.teach_content || '';\r\n                                defaultPrompt = stripHtml(rawText);\r\n                                if (defaultPrompt.length > 100) defaultPrompt = defaultPrompt.substring(0, 100);\r\n                            }\r\n                        }\r\n                        if (defaultPrompt) {\r\n                            setMediaInputValue({ ...mediaInputValue, [blockId]: `  : ${defaultPrompt}` });\r\n                        }\r\n                        setMediaInputMode({ ...mediaInputMode, [blockId]: 'image_ai' });\r\n                    }} className={mediaBtnClass}><IconPalette className=\"w-4 h-4\" />  -AI</button>\r\n                    <button onClick={() => setMediaInputMode({ ...mediaInputMode, [blockId]: null })} className=\"p-1.5 text-gray-400 hover:text-red-500\"><IconX className=\"w-4 h-4\" /></button>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        // 3.    (, ,   YouTube)\r\n        if (mode === 'video_select') {\r\n            return (\r\n                <div className=\"flex gap-2 bg-blue-50 p-1 rounded-lg animate-scale-in\">\r\n                    <button onClick={() => { setYoutubeSearchBlockId(blockId); setYoutubeSearchOpen(true); }} className={`${mediaBtnClass} bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 border-red-200`}><IconVideo className=\"w-4 h-4\" />  YouTube</button>\r\n                    <label className={mediaBtnClass}><IconUpload className=\"w-4 h-4\" /> <input type=\"file\" accept=\"video/*\" className=\"hidden\" onChange={(e) => { handleFileUpload(e, blockId, 'metadata'); setMediaInputMode({ ...mediaInputMode, [blockId]: null }); }} /></label>\r\n                    <button onClick={() => setMediaInputMode({ ...mediaInputMode, [blockId]: 'video_link' })} className={mediaBtnClass}><IconLink className=\"w-4 h-4\" />  </button>\r\n                    <button onClick={() => setMediaInputMode({ ...mediaInputMode, [blockId]: null })} className=\"p-1.5 text-gray-400 hover:text-red-500\"><IconX className=\"w-4 h-4\" /></button>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        // 4.   AI -  null   -renderMediaInputPanel\r\n        if (mode === 'image_ai') {\r\n            return null;\r\n        }\r\n\r\n        // 5.   \r\n        if (mode === 'video_link') {\r\n            return (\r\n                <div className=\"flex flex-col gap-2 w-full bg-blue-50 p-3 rounded-lg border border-blue-100 animate-scale-in mt-2\">\r\n                    <span className=\"text-xs font-bold text-blue-600\"> -YouTube:</span>\r\n                    <div className=\"flex gap-2\">\r\n                        <input type=\"text\" dir=\"ltr\" className=\"flex-1 p-2 border rounded text-sm text-left\" placeholder=\"https://youtube.com/...\" onChange={(e) => setMediaInputValue({ ...mediaInputValue, [blockId]: e.target.value })} />\r\n                        <button onClick={async () => {\r\n                            const url = mediaInputValue[blockId];\r\n                            if (!url) return;\r\n\r\n                            setLoadingBlockId(blockId); // Show loading\r\n                            let transcript = \"\";\r\n\r\n                            // Try to fetch transcript if it's a YouTube URL\r\n                            console.log(\"Checking URL for transcription:\", url);\r\n                            const videoId = MultimodalService.validateYouTubeUrl(url);\r\n                            console.log(\"Validation Result (Video ID):\", videoId);\r\n\r\n                            if (videoId) {\r\n                                try {\r\n                                    console.log(\"Calling processYoutubeUrl...\");\r\n                                    const result = await MultimodalService.processYoutubeUrl(url);\r\n                                    console.log(\"Transcript Result Length:\", result?.text?.length);\r\n\r\n                                    if (result?.text) {\r\n                                        transcript = result.text;\r\n                                    } else {\r\n                                        alert(\"   .     .\");\r\n                                    }\r\n                                } catch (e) {\r\n                                    console.error(\"Transcription Error Full:\", e);\r\n                                    alert(\"  : \" + (e as Error).message);\r\n                                }\r\n                            } else {\r\n                                console.warn(\"URL failed validation for transcription but might still be embeddable.\");\r\n                            }\r\n\r\n                            const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId);\r\n                            if (block) {\r\n                                updateBlock(blockId, block.content, {\r\n                                    media: getEmbedUrl(url),\r\n                                    mediaType: 'video',\r\n                                    transcript: transcript // Store the transcript!\r\n                                });\r\n                            }\r\n\r\n                            setLoadingBlockId(null);\r\n                            setMediaInputMode({ ...mediaInputMode, [blockId]: null });\r\n                        }} className=\"bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap flex items-center gap-2\">\r\n                            {loadingBlockId === blockId ? <IconLoader className=\"w-3 h-3 animate-spin\" /> : null}\r\n                            \r\n                        </button>\r\n                        <button onClick={() => setMediaInputMode({ ...mediaInputMode, [blockId]: null })} className=\"text-gray-400 hover:text-red-500\"><IconX className=\"w-5 h-5\" /></button>\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    //    -     -toolbar\r\n    const renderMediaInputPanel = (blockId: string) => {\r\n        const mode = mediaInputMode[blockId];\r\n\r\n        if (mode === 'image_ai') {\r\n            return (\r\n                <div className=\"w-full bg-blue-50 p-3 rounded-lg border border-blue-100 animate-scale-in mt-2\">\r\n                    <div className=\"flex justify-between items-center mb-2\">\r\n                        <span className=\"text-xs font-bold text-blue-600\">  :</span>\r\n                        <button onClick={() => setMediaInputMode({ ...mediaInputMode, [blockId]: null })} className=\"text-gray-400 hover:text-red-500\"><IconX className=\"w-4 h-4\" /></button>\r\n                    </div>\r\n                    <div className=\"flex gap-2 items-end\">\r\n                        <textarea rows={2} className=\"flex-1 p-2 border rounded text-sm resize-none\" placeholder=\":    ...\" value={mediaInputValue[blockId] || ''} onChange={(e) => setMediaInputValue({ ...mediaInputValue, [blockId]: e.target.value })} />\r\n                        <button onClick={() => handleGenerateAiImage(blockId, 'metadata')} disabled={loadingBlockId === blockId} className=\"bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold whitespace-nowrap flex items-center gap-2\">\r\n                            {loadingBlockId === blockId ? <><div className=\"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div> ...</> : ''}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    const InsertMenu = ({ index }: { index: number }) => (\r\n        <div className=\"relative py-4 flex justify-center z-20\">\r\n            <div className=\"absolute inset-x-0 top-1/2 h-0.5 bg-blue-100/50 -z-10\"></div>\r\n            <div>\r\n                {activeInsertIndex === index ? (\r\n                    <div className=\"glass border border-white/60 shadow-xl rounded-2xl p-4 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 animate-scale-in backdrop-blur-xl bg-white/95 ring-4 ring-blue-50/50 max-w-3xl\">\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('text', index); }} className=\"insert-btn\"><IconText className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['text']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('image', index); }} className=\"insert-btn\"><IconImage className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['image']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('video', index); }} className=\"insert-btn\"><IconVideo className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['video']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('multiple-choice', index); }} className=\"insert-btn\"><IconList className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['multiple-choice']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('open-question', index); }} className=\"insert-btn\"><IconEdit className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['open-question']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('interactive-chat', index); }} className=\"insert-btn\"><IconChat className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['interactive-chat']}</span></button>\r\n\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('fill_in_blanks', index); }} className=\"insert-btn\"><IconEdit className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['fill_in_blanks']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('ordering', index); }} className=\"insert-btn\"><IconList className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['ordering']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('categorization', index); }} className=\"insert-btn\"><IconLayer className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['categorization']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('memory_game', index); }} className=\"insert-btn\"><IconBrain className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['memory_game']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('true_false_speed', index); }} className=\"insert-btn\"><IconSparkles className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['true_false_speed']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('matching', index); }} className=\"insert-btn\"><IconLink className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['matching']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('highlight', index); }} className=\"insert-btn\"><IconEdit className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['highlight']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('sentence_builder', index); }} className=\"insert-btn\"><IconText className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['sentence_builder']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('image_labeling', index); }} className=\"insert-btn\"><IconImage className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['image_labeling']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('table_completion', index); }} className=\"insert-btn\"><IconList className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['table_completion']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('text_selection', index); }} className=\"insert-btn\"><IconCheck className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['text_selection']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('rating_scale', index); }} className=\"insert-btn\"><IconBalance className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['rating_scale']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('matrix', index); }} className=\"insert-btn\"><IconLayer className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['matrix']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('audio-response', index); }} className=\"insert-btn\"><IconMicrophone className=\"w-4 h-4\" /><span>{BLOCK_TYPE_MAPPING['audio-response']}</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('podcast', index); }} className=\"insert-btn\"><IconHeadphones className=\"w-4 h-4\" /><span> AI</span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('infographic', index); }} className=\"insert-btn\"><IconInfographic className=\"w-4 h-4\" /><span></span></button>\r\n                        <button onClick={(e) => { e.stopPropagation(); addBlockAtIndex('mindmap', index); }} className=\"insert-btn bg-gradient-to-r from-purple-50 to-indigo-50 border-purple-200 hover:border-purple-300\"><IconBrain className=\"w-4 h-4 text-purple-600\" /><span className=\"text-purple-700\">{BLOCK_TYPE_MAPPING['mindmap']}</span></button>\r\n\r\n                        <button onClick={(e) => { e.stopPropagation(); setActiveInsertIndex(null); }} className=\"text-gray-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-full transition-colors ml-2\"><IconX className=\"w-5 h-5\" /></button>\r\n                    </div>\r\n                ) : (\r\n                    <button onClick={() => setActiveInsertIndex(index)} className=\"bg-white text-blue-600 border border-blue-200 rounded-full px-4 py-1.5 flex items-center gap-2 shadow-sm hover:shadow-md hover:scale-105 transition-all hover:bg-blue-50 hover:border-blue-300\">\r\n                        <IconPlus className=\"w-4 h-4\" /><span className=\"text-xs font-bold\"> </span>\r\n                    </button>\r\n                )}\r\n            </div>\r\n        </div>\r\n\r\n\r\n\r\n    );\r\n\r\n    const renderEmbeddedMedia = (blockId: string, metadata: any) => {\r\n        if (!metadata?.media) return null;\r\n        return (\r\n            <div className=\"mb-4 relative rounded-xl overflow-hidden border border-gray-200\">\r\n                {metadata.mediaType === 'video' ? <video src={metadata.media} controls className=\"w-full max-h-[300px] bg-black\" /> : <img src={metadata.media} alt=\"\" className=\"w-full max-h-[300px] object-contain bg-gray-50\" loading=\"lazy\" decoding=\"async\" />}\r\n                <button onClick={() => { const block = editedUnit.activityBlocks.find((b: any) => b.id === blockId); if (block) updateBlock(blockId, block.content, { media: null, mediaType: null }); }} className=\"absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 hover:bg-red-50 hover:text-red-600 transition-colors shadow-md border border-red-200\" title=\" \"><IconTrash className=\"w-4 h-4\" /></button>\r\n            </div>\r\n        );\r\n    };\r\n\r\n    // --- Dynamic Loading Text ---\r\n    const productType = (course as any)?.wizardData?.settings?.productType || 'lesson';\r\n    const productTypeHebrew = {\r\n        'lesson': ' ',\r\n        'activity': ' ',\r\n        'exam': '',\r\n        'podcast': ''\r\n    }[productType as string] || '';\r\n\r\n    const productTypeStatusLabel = {\r\n        'lesson': ' ',\r\n        'activity': ' ',\r\n        'exam': ' ',\r\n        'podcast': ' '\r\n    }[productType as string] || ' ';\r\n\r\n    // Map productType to TypewriterLoader contentType\r\n    const typewriterContentType = {\r\n        'lesson': 'lesson',\r\n        'activity': 'activity',\r\n        'exam': 'exam',\r\n        'podcast': 'general'\r\n    }[productType as string] as 'lesson' | 'exam' | 'activity' | 'general' || 'activity';\r\n\r\n    // --- Dynamic Source Text ---\r\n    const sourceMode = (course as any)?.wizardData?.mode || 'topic';\r\n    const sourceTextHebrew = {\r\n        'upload': ' ',\r\n        'text': ' ',\r\n        'multimodal': ' ',\r\n        'topic': '  '\r\n    }[sourceMode as string] || '';\r\n\r\n    if (isAutoGenerating) {\r\n        return (\r\n            <div className=\"flex flex-col items-center justify-center h-screen bg-gray-50\">\r\n                <div className=\"relative mb-6\"><AIStarsSpinner size=\"xl\" color=\"gradient\" /></div>\r\n                <h2 className=\"text-2xl font-bold text-gray-800 mb-4\">{productTypeHebrew} {sourceTextHebrew} ...</h2>\r\n                {/* Typewriter status messages */}\r\n                <div className=\"min-h-[2rem]\">\r\n                    <TypewriterLoader\r\n                        contentType={typewriterContentType}\r\n                        isVisible={true}\r\n                        showSpinner={false}\r\n                        className=\"text-indigo-600\"\r\n                    />\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen p-8 font-sans pb-24 bg-gray-50/50\">\r\n            {/* Header */}\r\n            <div className=\"sticky top-4 z-50 card-glass p-4 flex justify-between items-center mb-10 gap-4\">\r\n                <div className=\"flex-1 min-w-0\">\r\n                    <input type=\"text\" value={editedUnit.title} onChange={(e) => { setEditedUnit({ ...editedUnit, title: e.target.value }); setIsDirty(true); }} className=\"text-2xl font-bold text-gray-800 bg-transparent border-b border-transparent focus:border-blue-500 outline-none px-2 transition-colors placeholder-gray-400 w-full\" placeholder={` ${productTypeHebrew}`} />\r\n                    <div className=\"text-sm text-gray-500 px-2 mt-1 flex items-center gap-2\">\r\n                        <span> : {gradeLevel}</span>\r\n                        {subject && (\r\n                            <>\r\n                                <span className=\"w-1 h-1 bg-gray-400 rounded-full\"></span>\r\n                                <span> : {subject}</span>\r\n                            </>\r\n                        )}\r\n                        <span className=\"w-1 h-1 bg-gray-400 rounded-full\"></span>\r\n                        <span className={`font-bold ${showScoring ? 'text-blue-800' : 'text-green-700'}`}>{showScoring ? ' ' : productTypeStatusLabel}</span>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex gap-3 flex-shrink-0 items-center\">\r\n                    {/* Primary Actions - Always Visible */}\r\n                    {onPreview && (\r\n                        <button onClick={() => onPreview(editedUnit)} className=\"px-5 py-2 rounded-xl text-blue-600 bg-blue-50 hover:bg-blue-100 font-bold transition-colors flex items-center gap-2 border border-blue-200\">\r\n                            <IconEye className=\"w-4 h-4\" />  \r\n                        </button>\r\n                    )}\r\n\r\n                    <button\r\n                        onClick={handleSaveWithFeedback}\r\n                        disabled={isSaving}\r\n                        className={`px-6 py-2 rounded-xl shadow-lg font-bold transition-all hover:-translate-y-0.5 flex items-center gap-2 min-w-[140px] justify-center\r\n                        ${saveSuccess\r\n                                ? 'bg-green-600 text-white shadow-green-200'\r\n                                : 'bg-blue-600 text-white hover:bg-blue-700 shadow-blue-200'}`}\r\n                    >\r\n                        {isSaving ? (\r\n                            <><div className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div> ...</>\r\n                        ) : saveSuccess ? (\r\n                            <><IconCheck className=\"w-4 h-4\" /> !</>\r\n                        ) : (\r\n                            <><IconSave className=\"w-4 h-4\" />  </>\r\n                        )}\r\n                    </button>\r\n\r\n                    {/* Secondary Actions - Dropdown Menu */}\r\n                    <div className=\"relative\">\r\n                        <button\r\n                            onClick={() => setShowHeaderMenu(!showHeaderMenu)}\r\n                            className=\"p-2 rounded-xl text-gray-600 hover:bg-white/80 border border-gray-200 transition-colors\"\r\n                        >\r\n                            <IconMoreVertical className=\"w-5 h-5\" />\r\n                        </button>\r\n\r\n                        {showHeaderMenu && (\r\n                            <>\r\n                                <div className=\"fixed inset-0 z-40\" onClick={() => setShowHeaderMenu(false)} />\r\n                                <div className=\"absolute left-0 top-full mt-2 bg-white rounded-xl shadow-xl border border-gray-200 py-2 min-w-[200px] z-50\">\r\n                                    {/* Source Toggle */}\r\n                                    {(course.fullBookContent || course.pdfSource) && (\r\n                                        <button\r\n                                            onClick={() => { setShowSource(!showSource); setShowHeaderMenu(false); }}\r\n                                            className=\"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700\"\r\n                                        >\r\n                                            <IconBook className=\"w-4 h-4 text-indigo-500\" />\r\n                                            {showSource ? ' ' : ' '}\r\n                                        </button>\r\n                                    )}\r\n\r\n                                    {/* Scoring Distribution */}\r\n                                    {showScoring && (\r\n                                        <button\r\n                                            onClick={() => { handleAutoDistributePoints(); setShowHeaderMenu(false); }}\r\n                                            className=\"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700\"\r\n                                        >\r\n                                            <IconBalance className=\"w-4 h-4 text-yellow-600\" />\r\n                                             \r\n                                        </button>\r\n                                    )}\r\n\r\n                                    {/* Copy Link */}\r\n                                    <button\r\n                                        onClick={() => { handleCopyLinkClick(); setShowHeaderMenu(false); }}\r\n                                        className=\"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700\"\r\n                                    >\r\n                                        <IconLink className={`w-4 h-4 ${isDirty ? 'text-amber-500' : 'text-indigo-500'}`} />\r\n                                        {isDirty ? '  !' : '  '}\r\n                                    </button>\r\n\r\n                                    <div className=\"border-t border-gray-100 my-1\" />\r\n\r\n                                    {/* Back */}\r\n                                    <button\r\n                                        onClick={() => { handleBack(); setShowHeaderMenu(false); }}\r\n                                        className=\"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700\"\r\n                                    >\r\n                                        <IconBack className=\"w-4 h-4 rotate-180 text-gray-500\" />\r\n                                        \r\n                                    </button>\r\n                                </div>\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"flex-1 flex overflow-hidden relative\">\r\n                <div className={`flex-1 overflow-y-auto custom-scrollbar p-8 pb-32 transition-all ${showSource ? 'w-1/2' : 'w-full max-w-4xl mx-auto'}`}>\r\n                    <div className=\"space-y-6\">\r\n                        {/* PODCAST PLAYER AREA - Removed (Moved to Blocks) */}\r\n\r\n                        <InsertMenu index={0} />\r\n\r\n                        {editedUnit.activityBlocks?.map((block: any, index: number) => (\r\n                            <React.Fragment key={block.id}>\r\n                                <div\r\n                                    className=\"card-glass relative group transition-all p-4 pb-14\"\r\n                                >\r\n                                    {/* Top-left corner: Media toolbar (only for blocks that can have embedded media) */}\r\n                                    {!['image', 'video', 'podcast', 'audio-response', 'loading-placeholder', 'activity-intro', 'scenario-image', 'infographic'].includes(block.type) && (\r\n                                        <div className=\"absolute top-2 left-2 z-10 opacity-70 group-hover:opacity-100 transition-opacity\">\r\n                                            {renderMediaToolbar(block.id)}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Bottom-left corner: AI Refine */}\r\n                                    <div className=\"absolute bottom-3 left-2 z-10\">\r\n                                        <AiRefineToolbar\r\n                                            blockId={block.id}\r\n                                            blockType={block.type}\r\n                                            content={block.content}\r\n                                            onUpdate={(newContent) => updateBlock(block.id, newContent)}\r\n                                            unitId={unit.id}\r\n                                        />\r\n                                    </div>\r\n\r\n                                    {/* Bottom-right corner: Controls (move up/down, delete) */}\r\n                                    <div className=\"absolute bottom-3 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 backdrop-blur-sm rounded-lg p-1 shadow-sm border border-gray-100\">\r\n                                        <button onClick={() => moveBlock(index, 'up')} disabled={index === 0} className=\"p-1.5 hover:text-blue-600 disabled:opacity-30 rounded hover:bg-blue-50 transition-colors\"><IconArrowUp className=\"w-4 h-4\" /></button>\r\n                                        <button onClick={() => moveBlock(index, 'down')} disabled={index === editedUnit.activityBlocks.length - 1} className=\"p-1.5 hover:text-blue-600 disabled:opacity-30 rounded hover:bg-blue-50 transition-colors\"><IconArrowDown className=\"w-4 h-4\" /></button>\r\n                                        <button onClick={() => deleteBlock(block.id)} className=\"p-1.5 hover:text-red-500 rounded hover:bg-red-50 transition-colors\"><IconTrash className=\"w-4 h-4\" /></button>\r\n                                    </div>\r\n\r\n                                    {/* Header Row - Block type + Level selector */}\r\n                                    <div className=\"flex items-center gap-2 mb-3\">\r\n                                        <span className=\"text-[10px] font-bold bg-gray-100/80 text-gray-500 px-2 py-0.5 rounded-full uppercase tracking-wide\">\r\n                                            {BLOCK_TYPE_MAPPING[block.type] || block.type}\r\n                                        </span>\r\n                                        {/* Learning Level - badge for interactive/question blocks (default: ) */}\r\n                                        {!['text', 'image', 'video', 'pdf', 'gem-link', 'podcast', 'activity-intro', 'scenario-image', 'infographic', 'loading-placeholder'].includes(block.type) && (\r\n                                            <span className=\"text-[10px] font-medium px-2 py-0.5 rounded-full bg-gray-50 text-gray-500 border border-gray-200\">\r\n                                                {block.metadata?.learningLevel || ''}\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n\r\n                                    {/* Block Content */}\r\n                                    <div>\r\n                                        {/* TEXT BLOCK */}\r\n                                        {block.type === 'text' && (\r\n                                            <div>\r\n                                                {/* Three Levels Selector for blocks with variants */}\r\n                                                {(block.metadata?.has_variants || block.metadata?.scaffolding_variant || block.metadata?.enrichment_variant) && (\r\n                                                    <div className=\"mb-3\">\r\n                                                        <LevelSelector\r\n                                                            blockId={block.id}\r\n                                                            hasVariants={true}\r\n                                                            currentLevel={blockEditLevel[block.id] || ''}\r\n                                                            onChange={(level) => setBlockEditLevel(prev => ({ ...prev, [block.id]: level }))}\r\n                                                        />\r\n                                                    </div>\r\n                                                )}\r\n                                                {/* Desktop: Editor + Sidebar | Mobile: Editor above, toolbar below */}\r\n                                                <div className=\"flex flex-col lg:flex-row-reverse gap-3\">\r\n                                                    {/* Main Editor Area */}\r\n                                                    <div className=\"flex-1 min-w-0\">\r\n                                                        {block.metadata?.isLoading || block.metadata?.isSkeleton ? (\r\n                                                            <div className=\"w-full p-8 border border-indigo-100 bg-gradient-to-br from-indigo-50/50 to-blue-50/50 rounded-2xl flex flex-col items-center justify-center text-center gap-4 min-h-[180px]\">\r\n                                                                <TypewriterLoader contentType={typewriterContentType} isVisible={true} />\r\n                                                            </div>\r\n                                                        ) : (\r\n                                                            <RichTextEditor\r\n                                                                value={getBlockContentForLevel(block, blockEditLevel[block.id] || '') || ''}\r\n                                                                onChange={(html) => updateBlockForLevel(block.id, html, blockEditLevel[block.id] || '')}\r\n                                                                placeholder={`    ${productTypeHebrew}...`}\r\n                                                                minHeight=\"200px\"\r\n                                                                maxHeight=\"400px\"\r\n                                                            />\r\n                                                        )}\r\n                                                        {renderEmbeddedMedia(block.id, block.metadata)}\r\n                                                    </div>\r\n\r\n                                                    {/* AI Sidebar - Desktop: sticky side panel | Mobile: horizontal toolbar */}\r\n                                                    <div className=\"lg:w-28 lg:flex-shrink-0\">\r\n                                                        <div className=\"lg:sticky lg:top-4 bg-blue-50/60 p-2 rounded-xl border border-blue-100/50 backdrop-blur-sm\">\r\n                                                            {/* AI Actions */}\r\n                                                            <div className=\"flex lg:flex-col gap-1.5 flex-wrap\">\r\n                                                                <div className=\"flex items-center gap-1 text-blue-600 px-2 py-1 font-bold text-xs\">\r\n                                                                    <IconSparkles className=\"w-4 h-4\" />\r\n                                                                    <span className=\"lg:hidden\">AI:</span>\r\n                                                                </div>\r\n                                                                {AI_ACTIONS.map(action => (\r\n                                                                    <button\r\n                                                                        key={action.label}\r\n                                                                        onClick={() => handleAiAction(block.id, block.content, action.prompt)}\r\n                                                                        disabled={loadingBlockId === block.id}\r\n                                                                        className=\"text-xs bg-white/80 text-blue-700 border border-blue-100 px-2.5 py-1.5 rounded-lg hover:bg-blue-50 transition-colors font-medium shadow-sm disabled:opacity-50 lg:w-full lg:text-center\"\r\n                                                                    >\r\n                                                                        {loadingBlockId === block.id ? '...' : action.label}\r\n                                                                    </button>\r\n                                                                ))}\r\n                                                            </div>\r\n\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n\r\n                                                {renderMediaInputPanel(block.id)}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* IMAGE BLOCK IMPROVED - REAL AI GENERATION */}\r\n                                        {block.type === 'image' && (\r\n                                            <div className=\"p-2\">\r\n                                                {!block.content ? (\r\n                                                    loadingBlockId === block.id ? (\r\n                                                        // Show beautiful skeleton while generating\r\n                                                        <ImageGenerationSkeleton\r\n                                                            height=\"h-48\"\r\n                                                            prompt={mediaInputValue[block.id]}\r\n                                                        />\r\n                                                    ) : (\r\n                                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 h-48\">\r\n                                                        <label className=\"flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition-all group\">\r\n                                                            <IconUpload className=\"w-8 h-8 text-gray-400 group-hover:text-blue-500 mb-2\" />\r\n                                                            <span className=\"font-bold text-gray-500 group-hover:text-blue-600\"> </span>\r\n                                                            <input type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={(e) => handleFileUpload(e, block.id)} />\r\n                                                        </label>\r\n                                                        <button onClick={() => setMediaInputMode({ ...mediaInputMode, [block.id]: 'ai' })} className=\"flex flex-col items-center justify-center border-2 border-dashed border-blue-200 rounded-xl bg-blue-50/50 hover:bg-blue-50 hover:border-blue-300 transition-all group\">\r\n                                                            <IconPalette className=\"w-8 h-8 text-blue-400 group-hover:text-blue-600 mb-2\" />\r\n                                                            <span className=\"font-bold text-blue-500 group-hover:text-blue-700\"> -AI</span>\r\n                                                        </button>\r\n                                                        {mediaInputMode[block.id] === 'ai' && (\r\n                                                            <div className=\"col-span-2 bg-white p-4 rounded-xl border border-blue-100 shadow-lg absolute inset-0 z-10 flex flex-col justify-center\">\r\n                                                                <h4 className=\"text-sm font-bold text-blue-700 mb-2\">    :</h4>\r\n                                                                <textarea className=\"w-full p-2 border rounded-lg mb-2 text-sm focus:border-blue-400 outline-none\" rows={2} placeholder=\"   ...\" onChange={(e) => setMediaInputValue({ ...mediaInputValue, [block.id]: e.target.value })}></textarea>\r\n                                                                <div className=\"flex gap-2 justify-end\">\r\n                                                                    <button onClick={() => setMediaInputMode({ ...mediaInputMode, [block.id]: null })} className=\"text-gray-500 text-xs hover:bg-gray-100 px-3 py-1 rounded\"></button>\r\n                                                                    <button\r\n                                                                        onClick={() => handleGenerateAiImage(block.id, 'content')}\r\n                                                                        disabled={loadingBlockId === block.id}\r\n                                                                        className=\"bg-blue-600 text-white text-xs px-4 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2\"\r\n                                                                    >\r\n                                                                        {loadingBlockId === block.id ? (\r\n                                                                            <><div className=\"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div> ...</>\r\n                                                                        ) : (\r\n                                                                            <> <IconWand className=\"w-3 h-3\" />  </>\r\n                                                                        )}\r\n                                                                    </button>\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    )\r\n                                                ) : (\r\n                                                    <div className=\"relative\">\r\n                                                        <img src={block.content} className=\"w-full max-h-[400px] object-contain rounded-xl shadow-md bg-gray-100\" alt=\"Block Media\" loading=\"lazy\" decoding=\"async\" />\r\n                                                        <button\r\n                                                            onClick={() => updateBlock(block.id, '', { caption: null, mediaType: null, aiPrompt: null, uploadedFileUrl: null, fileName: null })}\r\n                                                            className=\"absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 hover:bg-red-50 hover:text-red-600 transition-colors shadow-md border border-red-200\"\r\n                                                            title=\" \"\r\n                                                        >\r\n                                                            <IconTrash className=\"w-4 h-4\" />\r\n                                                        </button>\r\n                                                        <div className=\"mt-3\">\r\n                                                            <input type=\"text\" className=\"w-full bg-transparent border-b border-gray-200 focus:border-blue-400 outline-none p-1 text-sm text-center text-gray-600 placeholder-gray-400\" placeholder=\"  ...\" value={block.metadata?.caption || ''} onChange={(e) => updateBlock(block.id, block.content, { caption: e.target.value })} />\r\n                                                        </div>\r\n                                                    </div>\r\n                                                )}\r\n\r\n                                                {block.content && !block.metadata?.relatedQuestion && (\r\n                                                    <div className=\"flex justify-center mt-4\">\r\n                                                        <div className=\"flex gap-2 bg-white border border-gray-200 rounded-full p-1 shadow-sm\">\r\n                                                            <button onClick={() => handleAddRelatedQuestion(block.id, 'open-question')} className=\"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors\">  </button>\r\n                                                            <div className=\"w-px bg-gray-200\"></div>\r\n                                                            <button onClick={() => handleAddRelatedQuestion(block.id, 'multiple-choice')} className=\"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors\">  </button>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                )}\r\n\r\n                                                {renderRelatedQuestionEditor(block.id, block.metadata?.relatedQuestion)}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* VIDEO BLOCK IMPROVED */}\r\n                                        {block.type === 'video' && (\r\n                                            <div className=\"p-2\">\r\n                                                {!block.content ? (\r\n                                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 h-48\">\r\n                                                        <label className=\"flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition-all group\">\r\n                                                            {uploadingBlockId === block.id ? <div className=\"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full\"></div> : <IconUpload className=\"w-8 h-8 text-gray-400 group-hover:text-blue-500 mb-2\" />}\r\n                                                            <span className=\"font-bold text-gray-500 group-hover:text-blue-600\">  ( 50MB)</span>\r\n                                                            <input type=\"file\" accept=\"video/*\" className=\"hidden\" onChange={(e) => handleFileUpload(e, block.id)} />\r\n                                                        </label>\r\n                                                        <button onClick={() => setMediaInputMode({ ...mediaInputMode, [block.id]: 'link' })} className=\"flex flex-col items-center justify-center border-2 border-dashed border-red-200 rounded-xl bg-red-50/50 hover:bg-red-50 hover:border-red-300 transition-all group\">\r\n                                                            <IconLink className=\"w-8 h-8 text-red-400 group-hover:text-red-600 mb-2\" />\r\n                                                            <span className=\"font-bold text-red-500 group-hover:text-red-700\">  (YouTube)</span>\r\n                                                        </button>\r\n                                                        {mediaInputMode[block.id] === 'link' && (\r\n                                                            <div className=\"col-span-2 bg-white p-4 rounded-xl border border-red-100 shadow-lg absolute inset-0 z-10 flex flex-col justify-center\">\r\n                                                                <h4 className=\"text-sm font-bold text-red-700 mb-2\">  (YouTube / Vimeo):</h4>\r\n                                                                <input type=\"text\" dir=\"ltr\" className=\"w-full p-2 border rounded-lg mb-2 text-sm text-left\" placeholder=\"https://www.youtube.com/watch?v=...\" onChange={(e) => setMediaInputValue({ ...mediaInputValue, [block.id]: e.target.value })} />\r\n                                                                <div className=\"flex gap-2 justify-end\">\r\n                                                                    <button onClick={() => setMediaInputMode({ ...mediaInputMode, [block.id]: null })} className=\"text-gray-500 text-xs hover:bg-gray-100 px-3 py-1 rounded\"></button>\r\n                                                                    <div className=\"flex flex-col gap-2 w-full\">\r\n                                                                        <button onClick={async () => {\r\n                                                                            const url = mediaInputValue[block.id];\r\n                                                                            if (!url) return;\r\n\r\n                                                                            setLoadingBlockId(block.id);\r\n                                                                            let transcript = \"\";\r\n\r\n                                                                            const log = (msg: string) => {\r\n                                                                                console.log(msg);\r\n                                                                                const debugEl = document.getElementById(`debug-${block.id}`);\r\n                                                                                if (debugEl) debugEl.innerHTML += `<div class=\"border-b border-gray-800 pb-1 mb-1\">${new Date().toLocaleTimeString()} - ${msg}</div>`;\r\n                                                                            };\r\n\r\n                                                                            // Reset log\r\n                                                                            const debugEl = document.getElementById(`debug-${block.id}`);\r\n                                                                            if (debugEl) debugEl.innerHTML = \"<div>Starting process...</div>\";\r\n\r\n                                                                            log(`URL: ${url}`);\r\n\r\n                                                                            if (MultimodalService.validateYouTubeUrl(url)) {\r\n                                                                                try {\r\n                                                                                    log(\"Valid YouTube URL. Fetching transcript...\");\r\n                                                                                    const result = await MultimodalService.processYoutubeUrl(url);\r\n\r\n                                                                                    if (result?.text) {\r\n                                                                                        log(`Transcript found! Length: ${result.text.length} chars`);\r\n                                                                                        transcript = result.text;\r\n                                                                                    } else {\r\n                                                                                        log(\"Transcript is empty/null from server.\");\r\n                                                                                        alert(\"   .\");\r\n                                                                                    }\r\n                                                                                } catch (e: any) {\r\n                                                                                    log(`Error fetching: ${e.message}`);\r\n                                                                                    console.warn(\"Failed to fetch transcript\", e);\r\n                                                                                    alert(\"  : \" + (e as Error).message);\r\n                                                                                }\r\n                                                                            } else {\r\n                                                                                log(\"Invalid YouTube URL format.\");\r\n                                                                            }\r\n\r\n                                                                            updateBlock(block.id, getEmbedUrl(url), {\r\n                                                                                mediaType: 'video',\r\n                                                                                transcript: transcript\r\n                                                                            });\r\n\r\n                                                                            log(\"Block updated. Finished.\");\r\n                                                                            setLoadingBlockId(null);\r\n                                                                            setMediaInputMode({ ...mediaInputMode, [block.id]: null });\r\n                                                                            setMediaInputValue({ ...mediaInputValue, [block.id]: '' });\r\n\r\n                                                                        }} className=\"bg-red-600 text-white text-xs font-bold px-4 py-2 rounded shadow hover:bg-red-700 transition-colors\">\r\n                                                                             \r\n                                                                        </button>\r\n\r\n                                                                        <div id={`debug-${block.id}`} className=\"text-[10px] font-mono bg-black text-green-400 p-2 rounded h-32 overflow-y-auto w-full text-left ltr border border-gray-700 shadow-inner\">\r\n                                                                            Ready for logs...\r\n                                                                        </div>\r\n                                                                    </div>\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        )}\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <div className=\"relative\">\r\n                                                        {block.content.includes('youtube') || block.content.includes('vimeo') ? (\r\n                                                            <iframe src={block.content} className=\"w-full h-64 rounded-xl shadow-md bg-black\" allowFullScreen title=\"Video Player\"></iframe>\r\n                                                        ) : (\r\n                                                            <video src={block.content} controls className=\"w-full h-64 bg-black rounded-xl shadow-md\" />\r\n                                                        )}\r\n                                                        <button\r\n                                                            onClick={() => updateBlock(block.id, '', { caption: null, mediaType: null, transcript: null, videoId: null, videoTitle: null, channelTitle: null, duration: null, thumbnailUrl: null, hasCaptions: null, educationalScore: null, source: null })}\r\n                                                            className=\"absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 hover:bg-red-50 hover:text-red-600 transition-colors shadow-md border border-red-200\"\r\n                                                            title=\" \"\r\n                                                        >\r\n                                                            <IconTrash className=\"w-4 h-4\" />\r\n                                                        </button>\r\n                                                        <div className=\"mt-3\">\r\n                                                            <input type=\"text\" className=\"w-full bg-transparent border-b border-gray-200 focus:border-blue-400 outline-none p-1 text-sm text-center text-gray-600 placeholder-gray-400\" placeholder=\"  ...\" value={block.metadata?.caption || ''} onChange={(e) => updateBlock(block.id, block.content, { caption: e.target.value })} />\r\n                                                        </div>\r\n                                                    </div>\r\n                                                )}\r\n\r\n                                                {block.metadata?.transcript && (\r\n                                                    <div className=\"mt-2 text-xs text-green-600 bg-green-50 px-2 py-1 rounded-md inline-block font-bold\">\r\n                                                            ({block.metadata.transcript.length} )\r\n                                                    </div>\r\n                                                )}\r\n\r\n                                                {block.content && !block.metadata?.relatedQuestion && (\r\n                                                    <div className=\"flex justify-center mt-4\">\r\n                                                        <div className=\"flex gap-2 bg-white border border-gray-200 rounded-full p-1 shadow-sm\">\r\n                                                            <button onClick={() => handleAddRelatedQuestion(block.id, 'open-question')} className=\"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors\">  </button>\r\n                                                            <div className=\"w-px bg-gray-200\"></div>\r\n                                                            <button onClick={() => handleAddRelatedQuestion(block.id, 'multiple-choice')} className=\"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors\">  </button>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                )}\r\n\r\n                                                {renderRelatedQuestionEditor(block.id, block.metadata?.relatedQuestion)}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* PODCAST BLOCK */}\r\n                                        {block.type === 'podcast' && (\r\n                                            <div className=\"bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-2xl border border-indigo-100 relative overflow-hidden\">\r\n                                                {/* Decorative Background */}\r\n                                                <div className=\"absolute top-0 right-0 w-64 h-64 bg-purple-200/20 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl\"></div>\r\n\r\n                                                <div className=\"relative z-10\">\r\n                                                    <div className=\"flex items-center gap-3 mb-6\">\r\n                                                        <div className=\"bg-white p-3 rounded-xl shadow-sm\">\r\n                                                            <IconHeadphones className=\"w-6 h-6 text-indigo-600\" />\r\n                                                        </div>\r\n                                                        <div>\r\n                                                            <h3 className=\"text-lg font-bold text-indigo-900\"> AI</h3>\r\n                                                            <p className=\"text-xs text-indigo-600 opacity-80\">   </p>\r\n                                                        </div>\r\n                                                    </div>\r\n\r\n                                                    {block.content.script ? (\r\n                                                        <div className=\"animate-fade-in w-full max-w-2xl mx-auto\">\r\n                                                            <PodcastPlayer\r\n                                                                script={block.content.script}\r\n                                                                title={block.content.title}\r\n                                                            // Future: Handle onAudioGenerated to persist blobs?\r\n                                                            />\r\n                                                        </div>\r\n                                                    ) : (\r\n                                                        <div className=\"text-center py-8\">\r\n                                                            {/* Source Selection Toggle */}\r\n                                                            <div className=\"inline-flex bg-white p-1 rounded-xl shadow-sm border border-indigo-100 mb-6\">\r\n                                                                <button\r\n                                                                    onClick={() => setPodcastSourceMode((prev: any) => ({ ...prev, [block.id]: 'full' }))}\r\n                                                                    className={`px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${(!podcastSourceMode[block.id] || podcastSourceMode[block.id] === 'full') ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}\r\n                                                                    disabled={loadingBlockId === block.id}\r\n                                                                >\r\n                                                                    <IconBook className=\"w-4 h-4\" />  \r\n                                                                </button>\r\n                                                                <button\r\n                                                                    onClick={() => setPodcastSourceMode((prev: any) => ({ ...prev, [block.id]: 'custom' }))}\r\n                                                                    className={`px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${podcastSourceMode[block.id] === 'custom' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}\r\n                                                                    disabled={loadingBlockId === block.id}\r\n                                                                >\r\n                                                                    <IconEdit className=\"w-4 h-4\" />  \r\n                                                                </button>\r\n                                                            </div>\r\n\r\n                                                            {/* Custom Text Input */}\r\n                                                            {podcastSourceMode[block.id] === 'custom' && (\r\n                                                                <div className=\"mb-6 animate-scale-in\">\r\n                                                                    <RichTextEditor\r\n                                                                        value={podcastCustomText[block.id] || ''}\r\n                                                                        onChange={(html) => setPodcastCustomText((prev: any) => ({ ...prev, [block.id]: html }))}\r\n                                                                        placeholder=\"      ...\"\r\n                                                                        minHeight=\"120px\"\r\n                                                                        maxHeight=\"300px\"\r\n                                                                        disabled={loadingBlockId === block.id}\r\n                                                                        className=\"border-indigo-200\"\r\n                                                                    />\r\n                                                                    <p className=\"text-right text-xs text-gray-400 mt-1\"> 50 </p>\r\n                                                                </div>\r\n                                                            )}\r\n\r\n                                                            {/* LOADING STATE vs ACTION STATE */}\r\n                                                            {loadingBlockId === block.id ? (\r\n                                                                <div className=\"bg-indigo-50 border border-indigo-100 rounded-xl p-6 flex flex-col items-center animate-pulse\">\r\n                                                                    <IconLoader className=\"w-8 h-8 text-indigo-600 animate-spin mb-3\" />\r\n                                                                    <h4 className=\"text-indigo-800 font-bold mb-1\">  !</h4>\r\n                                                                    <p className=\"text-indigo-600 text-sm\">\r\n                                                                        {block.content.description || \"   ...  .\"}\r\n                                                                    </p>\r\n                                                                </div>\r\n                                                            ) : (\r\n                                                                <>\r\n                                                                    <button\r\n                                                                        onClick={() => handleGeneratePodcastBlock(block.id)}\r\n                                                                        className=\"bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-indigo-700 hover:scale-105 transition-all flex items-center gap-2 mx-auto\"\r\n                                                                    >\r\n                                                                        <IconSparkles className=\"w-5 h-5\" />\r\n                                                                          \r\n                                                                    </button>\r\n                                                                    <p className=\"text-xs text-indigo-400 mt-3 max-w-xs mx-auto\">\r\n                                                                           {(!podcastSourceMode[block.id] || podcastSourceMode[block.id] === 'full') ? '  ' : ' '}       .\r\n                                                                    </p>\r\n                                                                </>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* MINDMAP BLOCK */}\r\n                                        {block.type === 'mindmap' && (\r\n                                            <div className=\"bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-2xl border border-purple-100 relative overflow-hidden\">\r\n                                                {/* Decorative Background */}\r\n                                                <div className=\"absolute top-0 left-0 w-64 h-64 bg-purple-200/20 rounded-full -translate-y-1/2 -translate-x-1/2 blur-3xl\"></div>\r\n\r\n                                                <div className=\"relative z-10\">\r\n                                                    <div className=\"flex items-center justify-between mb-4\">\r\n                                                        <div className=\"flex items-center gap-3\">\r\n                                                            <div className=\"bg-white p-3 rounded-xl shadow-sm\">\r\n                                                                <IconBrain className=\"w-6 h-6 text-purple-600\" />\r\n                                                            </div>\r\n                                                            <div>\r\n                                                                <h3 className=\"text-lg font-bold text-purple-900\">{block.content.title || ' '}</h3>\r\n                                                                <p className=\"text-xs text-purple-600 opacity-80\">   </p>\r\n                                                            </div>\r\n                                                        </div>\r\n                                                        <button\r\n                                                            onClick={() => {\r\n                                                                setMindMapBlockId(block.id);\r\n                                                                setMindMapModalOpen(true);\r\n                                                            }}\r\n                                                            className=\"px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700 transition-colors flex items-center gap-2 shadow-md\"\r\n                                                        >\r\n                                                            <IconSparkles className=\"w-4 h-4\" />\r\n                                                            {block.content.nodes && block.content.nodes.length > 1 ? ' ' : ' '}\r\n                                                        </button>\r\n                                                    </div>\r\n\r\n                                                    {block.content.nodes && block.content.nodes.length > 1 ? (\r\n                                                        <MindMapEditor\r\n                                                            content={block.content}\r\n                                                            onChange={(newContent: MindMapContent) => updateBlock(block.id, newContent)}\r\n                                                            onSave={() => setIsDirty(true)}\r\n                                                        />\r\n                                                    ) : (\r\n                                                        <div className=\"text-center py-12 bg-white/50 rounded-xl border border-purple-100\">\r\n                                                            <div className=\"text-7xl mb-4\"></div>\r\n                                                            <h4 className=\"text-purple-800 font-bold text-lg mb-2\">   </h4>\r\n                                                            <p className=\"text-purple-600 text-sm mb-6 max-w-md mx-auto\">\r\n                                                                  \" \"       \r\n                                                            </p>\r\n                                                            <button\r\n                                                                onClick={() => {\r\n                                                                    setMindMapBlockId(block.id);\r\n                                                                    setMindMapModalOpen(true);\r\n                                                                }}\r\n                                                                className=\"px-8 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full font-bold shadow-lg hover:from-purple-700 hover:to-indigo-700 hover:scale-105 transition-all flex items-center gap-2 mx-auto\"\r\n                                                            >\r\n                                                                <IconSparkles className=\"w-5 h-5\" />\r\n                                                                  \r\n                                                            </button>\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* AUDIO RESPONSE BLOCK */}\r\n                                        {block.type === 'audio-response' && (\r\n                                            <div className=\"space-y-2\">\r\n                                                <div>\r\n                                                    <label className=\"text-xs text-gray-500 mb-1 block\"> / </label>\r\n                                                    <RichTextEditor\r\n                                                        value={(block.content && block.content.question) || ''}\r\n                                                        onChange={(html) => updateBlock(block.id, { ...block.content, question: html })}\r\n                                                        placeholder=\":   ...\"\r\n                                                        minHeight=\"40px\"\r\n                                                        maxHeight=\"150px\"\r\n                                                        collapsible={true}\r\n                                                    />\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs text-gray-500 mb-1 block\">  ()</label>\r\n                                                    <RichTextEditor\r\n                                                        value={(block.content && block.content.description) || ''}\r\n                                                        onChange={(html) => updateBlock(block.id, { ...block.content, description: html })}\r\n                                                        placeholder=\" ...\"\r\n                                                        minHeight=\"40px\"\r\n                                                        maxHeight=\"100px\"\r\n                                                        collapsible={true}\r\n                                                    />\r\n                                                </div>\r\n                                                <div className=\"flex items-center gap-3\">\r\n                                                    <div className=\"flex-1\">\r\n                                                        <label className=\"text-xs text-gray-500 mb-1 block\">  ' ()</label>\r\n                                                        <input type=\"number\" min=\"10\" max=\"300\" className=\"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm\" value={(block.content && block.content.maxDuration) || 60} onChange={(e) => updateBlock(block.id, { ...block.content, maxDuration: parseInt(e.target.value) })} />\r\n                                                    </div>\r\n                                                    <div className=\"flex-1 text-xs text-gray-400 pt-4\">\r\n                                                            .\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* CHAT BLOCK */}\r\n                                        {block.type === 'interactive-chat' && (\r\n                                            <div className=\"space-y-3\">\r\n                                                {/* Status Banner - compact */}\r\n                                                {showScoring && (\r\n                                                    <div className=\"flex items-center gap-2 text-gray-500 text-xs\">\r\n                                                        <IconShield className=\"w-4 h-4\" />\r\n                                                        <span>  -  </span>\r\n                                                    </div>\r\n                                                )}\r\n                                                <div>\r\n                                                    <label className=\"text-xs text-gray-500 mb-1 block\"> </label>\r\n                                                    <input type=\"text\" className=\"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm\" value={block.content.title || ''} onChange={(e) => updateBlock(block.id, { ...block.content, title: e.target.value })} placeholder=\":   \" />\r\n                                                </div>\r\n                                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                                                    <div className={showScoring ? 'opacity-50 pointer-events-none' : ''}>\r\n                                                        <label className=\"text-xs text-gray-500 mb-1 block\"> </label>\r\n                                                        <select className=\"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm\" value={block.metadata?.botPersona || 'socratic'} onChange={(e) => handlePersonaChange(block.id, e.target.value, block.content)} disabled={showScoring}>\r\n                                                            <option value=\"socratic\"> </option>\r\n                                                            <option value=\"teacher\"> </option>\r\n                                                            <option value=\"concise\"></option>\r\n                                                            <option value=\"coach\"> </option>\r\n                                                            <option value=\"historical\"> </option>\r\n                                                            <option value=\"debate\"> </option>\r\n                                                        </select>\r\n                                                    </div>\r\n                                                    {block.metadata?.botPersona === 'historical' && !showScoring && (\r\n                                                        <div>\r\n                                                            <label className=\"text-xs text-gray-500 mb-1 block\"> </label>\r\n                                                            <input type=\"text\" className=\"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm\" placeholder=\": ...\" onChange={(e) => updateBlock(block.id, block.content, { systemPrompt: ` ${e.target.value}.   .` })} />\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                                <div>\r\n                                                    <label className=\"text-xs text-gray-500 mb-1 block\"> </label>\r\n                                                    <input type=\"text\" className=\"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm\" value={block.metadata?.initialMessage || ''} onChange={(e) => updateBlock(block.id, block.content, { initialMessage: e.target.value })} />\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* QUESTIONS */}\r\n                                        {(block.type === 'multiple-choice' || block.type === 'open-question') && (\r\n                                            <div>\r\n                                                {/* Three Levels Selector for question blocks with variants */}\r\n                                                {(block.metadata?.has_variants || block.metadata?.scaffolding_variant || block.metadata?.enrichment_variant) && (\r\n                                                    <div className=\"mb-2\">\r\n                                                        <LevelSelector\r\n                                                            blockId={block.id}\r\n                                                            hasVariants={true}\r\n                                                            currentLevel={blockEditLevel[block.id] || ''}\r\n                                                            onChange={(level) => setBlockEditLevel(prev => ({ ...prev, [block.id]: level }))}\r\n                                                        />\r\n                                                    </div>\r\n                                                )}\r\n                                                <div className=\"flex justify-between items-start mb-3\">\r\n                                                    <div className=\"flex-1\">\r\n                                                        <RichTextEditor\r\n                                                            value={stripAsterisks((block.content && block.content.question) || '')}\r\n                                                            onChange={(html) => updateBlock(block.id, { ...block.content, question: html })}\r\n                                                            placeholder={block.type === 'multiple-choice' ? \"  ...\" : \"  ...\"}\r\n                                                            minHeight=\"40px\"\r\n                                                            maxHeight=\"150px\"\r\n                                                            collapsible={true}\r\n                                                        />\r\n                                                    </div>\r\n                                                    {showScoring && (<div className=\"flex items-center gap-1 mr-2\"><span className=\"text-xs text-gray-400\">:</span><input type=\"number\" className=\"w-12 text-center p-1 rounded border border-gray-200 text-sm\" value={block.metadata?.score || 0} onChange={(e) => updateBlock(block.id, block.content, { score: Number(e.target.value) })} /></div>)}\r\n                                                </div>\r\n                                                {renderEmbeddedMedia(block.id, block.metadata)}\r\n\r\n                                                {block.type === 'multiple-choice' && (\r\n                                                    <div className=\"space-y-1.5\">\r\n                                                        {!(block.content && block.content.question) && (<div className=\"flex justify-end mb-2\"><button onClick={() => handleAutoGenerateMCQuestion(block.id)} disabled={loadingBlockId === block.id} className=\"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium flex items-center gap-1\"><IconSparkles className=\"w-3 h-3\" />  </button></div>)}\r\n                                                        {(block.content?.options || []).map((opt: any, idx: number) => {\r\n                                                            const optText = getOptionText(opt);\r\n                                                            return (\r\n                                                                <div key={idx} className=\"flex items-center gap-2\">\r\n                                                                    <button onClick={() => updateBlock(block.id, { ...block.content, correctAnswer: optText })} className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${block.content?.correctAnswer === optText ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-gray-300'}`}>{block.content?.correctAnswer === optText && <IconCheck className=\"w-3 h-3\" />}</button>\r\n                                                                    <input type=\"text\" className=\"flex-1 p-2 text-sm border border-gray-200 rounded-lg bg-white\"\r\n                                                                        value={optText}\r\n                                                                        onChange={(e) => {\r\n                                                                            const newOptions = [...(block.content?.options || [])];\r\n                                                                            if (typeof newOptions[idx] === 'object') newOptions[idx] = { ...newOptions[idx], text: e.target.value };\r\n                                                                            else newOptions[idx] = e.target.value;\r\n                                                                            updateBlock(block.id, { ...block.content, options: newOptions });\r\n                                                                        }}\r\n                                                                        placeholder={` ${idx + 1}`}\r\n                                                                    />\r\n                                                                </div>\r\n                                                            );\r\n                                                        })}\r\n                                                    </div>\r\n                                                )}\r\n                                                {block.type === 'open-question' && (\r\n                                                    <div>\r\n                                                        {!(block.content && block.content.question) && (<div className=\"flex justify-end mb-2\"><button onClick={() => handleAutoGenerateOpenQuestion(block.id)} disabled={loadingBlockId === block.id} className=\"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium flex items-center gap-1\"><IconSparkles className=\"w-3 h-3\" />  </button></div>)}\r\n                                                        <label className=\"text-xs text-gray-500 mb-1 block\"> :</label>\r\n                                                        <RichTextEditor\r\n                                                            value={stripAsterisks(block.metadata?.modelAnswer || '')}\r\n                                                            onChange={(html) => updateBlock(block.id, block.content, { modelAnswer: html })}\r\n                                                            placeholder=\"    ...\"\r\n                                                            minHeight=\"80px\"\r\n                                                            maxHeight=\"200px\"\r\n                                                            collapsible={true}\r\n                                                        />\r\n                                                    </div>\r\n                                                )}\r\n                                                {renderMediaInputPanel(block.id)}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* FILL IN BLANKS */}\r\n                                        {block.type === 'fill_in_blanks' && (\r\n                                            <div>\r\n                                                {!block.content && (\r\n                                                    <div className=\"flex justify-end mb-2\">\r\n                                                        <button onClick={() => handleAutoGenerateFillInBlanks(block.id)} disabled={loadingBlockId === block.id} className=\"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1\"><IconSparkles className=\"w-3 h-3\" /> {loadingBlockId === block.id ? '...' : ' -AI'}</button>\r\n                                                    </div>\r\n                                                )}\r\n                                                <p className=\"text-xs text-gray-500 mb-2\">   -[ ]. : \"   []\".</p>\r\n                                                <RichTextEditor\r\n                                                    value={stripAsterisks(typeof block.content === 'object' ? (block.content.sentence || block.content.text || '') : (block.content || ''))}\r\n                                                    onChange={(html) => updateBlock(block.id, html)}\r\n                                                    placeholder=\"     [ ]...\"\r\n                                                    minHeight=\"120px\"\r\n                                                    maxHeight=\"300px\"\r\n                                                    collapsible={true}\r\n                                                />\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* ORDERING */}\r\n                                        {block.type === 'ordering' && (\r\n                                            <div>\r\n                                                {!(block.content?.instruction || block.content?.correct_order?.length > 0) && (\r\n                                                    <div className=\"flex justify-end mb-2\">\r\n                                                        <button onClick={() => handleAutoGenerateOrdering(block.id)} disabled={loadingBlockId === block.id} className=\"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1\"><IconSparkles className=\"w-3 h-3\" /> {loadingBlockId === block.id ? '...' : ' -AI'}</button>\r\n                                                    </div>\r\n                                                )}\r\n                                                <RichTextEditor\r\n                                                    value={(block.content && block.content.instruction) || ''}\r\n                                                    onChange={(html) => updateBlock(block.id, { ...block.content, instruction: html })}\r\n                                                    placeholder=\" /  (:   ...)\"\r\n                                                    minHeight=\"40px\"\r\n                                                    maxHeight=\"150px\"\r\n                                                    collapsible={true}\r\n                                                />\r\n                                                <div className=\"space-y-1.5\">\r\n                                                    {(block.content?.correct_order || []).map((item: string, idx: number) => (\r\n                                                        <div key={idx} className=\"flex gap-2 items-center\">\r\n                                                            <span className=\"font-medium text-gray-400 w-5 text-sm\">{idx + 1}.</span>\r\n                                                            <input type=\"text\" className=\"flex-1 p-2 border border-gray-200 rounded-lg bg-white text-sm\" value={item || ''} onChange={(e) => { const newItems = [...(block.content?.correct_order || [])]; newItems[idx] = e.target.value; updateBlock(block.id, { ...block.content, correct_order: newItems }); }} />\r\n                                                            <button onClick={() => { const newItems = (block.content?.correct_order || []).filter((_: any, i: number) => i !== idx); updateBlock(block.id, { ...block.content, correct_order: newItems }); }} className=\"text-gray-400 hover:text-red-500\"><IconTrash className=\"w-4 h-4\" /></button>\r\n                                                        </div>\r\n                                                    ))}\r\n                                                    <button onClick={() => updateBlock(block.id, { ...block.content, correct_order: [...(block.content?.correct_order || []), \" \"] })} className=\"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg mt-1\">+  </button>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* CATEGORIZATION */}\r\n                                        {block.type === 'categorization' && (\r\n                                            <div>\r\n                                                {!(block.content?.question || block.content?.categories?.length > 0 || block.content?.items?.length > 0) && (\r\n                                                    <div className=\"flex justify-end mb-2\">\r\n                                                        <button onClick={() => handleAutoGenerateCategorization(block.id)} disabled={loadingBlockId === block.id} className=\"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1\"><IconSparkles className=\"w-3 h-3\" /> {loadingBlockId === block.id ? '...' : ' -AI'}</button>\r\n                                                    </div>\r\n                                                )}\r\n                                                <RichTextEditor\r\n                                                    value={(block.content && block.content.question) || ''}\r\n                                                    onChange={(html) => updateBlock(block.id, { ...block.content, question: html })}\r\n                                                    placeholder=\"...\"\r\n                                                    minHeight=\"40px\"\r\n                                                    maxHeight=\"150px\"\r\n                                                    collapsible={true}\r\n                                                />\r\n                                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                                                    <div>\r\n                                                        <h4 className=\"text-xs font-medium text-gray-500 mb-2\"></h4>\r\n                                                        <div className=\"space-y-1.5\">\r\n                                                            {(Array.isArray(block.content?.categories) ? block.content.categories : []).map((cat: string, idx: number) => (\r\n                                                                <div key={idx} className=\"flex gap-2\">\r\n                                                                    <input type=\"text\" className=\"flex-1 p-2 border border-gray-200 rounded-lg bg-white text-sm\" value={cat || ''} onChange={(e) => { const newCats = [...(block.content?.categories || [])]; newCats[idx] = e.target.value; updateBlock(block.id, { ...block.content, categories: newCats }); }} placeholder={` ${idx + 1}`} />\r\n                                                                    <button onClick={() => { const newCats = (block.content?.categories || []).filter((_: any, i: number) => i !== idx); updateBlock(block.id, { ...block.content, categories: newCats }); }} className=\"text-gray-400 hover:text-red-500\"><IconTrash className=\"w-4 h-4\" /></button>\r\n                                                                </div>\r\n                                                            ))}\r\n                                                            <button onClick={() => updateBlock(block.id, { ...block.content, categories: [...(block.content?.categories || []), \" \"] })} className=\"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg\">+ </button>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                    <div>\r\n                                                        <h4 className=\"text-xs font-medium text-gray-500 mb-2\"> </h4>\r\n                                                        <div className=\"space-y-1.5\">\r\n                                                            {(block.content?.items || []).map((item: any, idx: number) => (\r\n                                                                <div key={idx} className=\"flex gap-2 items-center\">\r\n                                                                    <input type=\"text\" className=\"flex-1 p-2 text-sm border border-gray-200 rounded-lg\" value={item?.text || ''} onChange={(e) => { const newItems = [...(block.content?.items || [])]; newItems[idx].text = e.target.value; updateBlock(block.id, { ...block.content, items: newItems }); }} placeholder=\" \" />\r\n                                                                    <select className=\"text-xs p-1.5 bg-gray-50 rounded-lg border border-gray-200\" value={item?.category || ''} onChange={(e) => { const newItems = [...(block.content?.items || [])]; newItems[idx].category = e.target.value; updateBlock(block.id, { ...block.content, items: newItems }); }}>\r\n                                                                        <option value=\"\" disabled></option>\r\n                                                                        {(block.content?.categories || []).map((c: string) => <option key={c} value={c}>{c}</option>)}\r\n                                                                    </select>\r\n                                                                    <button onClick={() => { const newItems = (block.content?.items || []).filter((_: any, i: number) => i !== idx); updateBlock(block.id, { ...block.content, items: newItems }); }} className=\"text-gray-400 hover:text-red-500\"><IconTrash className=\"w-3 h-3\" /></button>\r\n                                                                </div>\r\n                                                            ))}\r\n                                                            <button onClick={() => updateBlock(block.id, { ...block.content, items: [...(block.content?.items || []), { text: \" \", category: block.content?.categories?.[0] || \"\" }] })} className=\"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg\">+ </button>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* MEMORY GAME */}\r\n                                        {block.type === 'memory_game' && (\r\n                                            <div>\r\n                                                {!(block.content?.pairs?.length > 0) && (\r\n                                                    <div className=\"flex justify-end mb-2\">\r\n                                                        <button onClick={() => handleAutoGenerateMemoryGame(block.id)} disabled={loadingBlockId === block.id} className=\"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1\"><IconSparkles className=\"w-3 h-3\" /> {loadingBlockId === block.id ? '...' : ' -AI'}</button>\r\n                                                    </div>\r\n                                                )}\r\n                                                <RichTextEditor\r\n                                                    value={(block.content && block.content.instruction) || ''}\r\n                                                    onChange={(html) => updateBlock(block.id, { ...block.content, instruction: html })}\r\n                                                    placeholder=\" (:    ...)\"\r\n                                                    minHeight=\"40px\"\r\n                                                    maxHeight=\"150px\"\r\n                                                    collapsible={true}\r\n                                                />\r\n                                                <p className=\"text-xs text-gray-500 mb-2 mt-3\">  .     .</p>\r\n                                                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3\">\r\n                                                    {(block.content?.pairs || []).map((pair: any, idx: number) => (\r\n                                                        <div key={idx} className=\"p-2 rounded-lg border border-gray-200 relative group/pair\">\r\n                                                            <div className=\"mb-1.5\">\r\n                                                                <label className=\"text-[10px] text-gray-400 block mb-0.5\"> '</label>\r\n                                                                <input type=\"text\" className=\"w-full p-2 border border-gray-200 rounded-lg text-sm\" value={pair?.card_a || ''} onChange={(e) => { const newPairs = [...(block.content?.pairs || [])]; newPairs[idx].card_a = e.target.value; updateBlock(block.id, { ...block.content, pairs: newPairs }); }} />\r\n                                                            </div>\r\n                                                            <div>\r\n                                                                <label className=\"text-[10px] text-gray-400 block mb-0.5\"> '</label>\r\n                                                                <input type=\"text\" className=\"w-full p-2 border border-gray-200 rounded-lg text-sm\" value={pair?.card_b || ''} onChange={(e) => { const newPairs = [...(block.content?.pairs || [])]; newPairs[idx].card_b = e.target.value; updateBlock(block.id, { ...block.content, pairs: newPairs }); }} />\r\n                                                            </div>\r\n                                                            <button onClick={() => { const newPairs = (block.content?.pairs || []).filter((_: any, i: number) => i !== idx); updateBlock(block.id, { ...block.content, pairs: newPairs }); }} className=\"absolute -top-1 -left-1 bg-white text-gray-400 hover:text-red-500 p-0.5 rounded-full shadow border border-gray-200 opacity-0 group-hover/pair:opacity-100 transition-opacity\"><IconX className=\"w-3 h-3\" /></button>\r\n                                                        </div>\r\n                                                    ))}\r\n                                                    <button onClick={() => updateBlock(block.id, { ...block.content, pairs: [...(block.content?.pairs || []), { card_a: \"\", card_b: \"\" }] })} className=\"min-h-[100px] border border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 hover:border-gray-400 transition-all\">\r\n                                                        <IconPlus className=\"w-5 h-5 mb-1\" />\r\n                                                        <span className=\"text-xs\"> </span>\r\n                                                    </button>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* TRUE/FALSE SPEED */}\r\n                                        {block.type === 'true_false_speed' && (\r\n                                            <div>\r\n                                                <RichTextEditor\r\n                                                    value={(block.content && block.content.instruction) || ''}\r\n                                                    onChange={(html) => updateBlock(block.id, { ...block.content, instruction: html })}\r\n                                                    placeholder=\" (:       ...)\"\r\n                                                    minHeight=\"40px\"\r\n                                                    maxHeight=\"150px\"\r\n                                                    collapsible={true}\r\n                                                />\r\n                                                <p className=\"text-xs text-gray-500 mb-2 mt-3\"> :         .</p>\r\n                                                <div className=\"space-y-1.5\">\r\n                                                    {(block.content?.statements || []).map((item: any, idx: number) => (\r\n                                                        <div key={idx} className=\"flex items-center gap-2\">\r\n                                                            <span className=\"font-medium text-gray-400 w-5 text-sm\">{idx + 1}.</span>\r\n                                                            <input type=\"text\" className=\"flex-1 p-2 text-sm border border-gray-200 rounded-lg\" value={item?.text || ''} onChange={(e) => { const newStmts = [...(block.content?.statements || [])]; newStmts[idx].text = e.target.value; updateBlock(block.id, { ...block.content, statements: newStmts }); }} placeholder=\" ...\" />\r\n                                                            <button onClick={() => { const newStmts = [...(block.content?.statements || [])]; newStmts[idx].is_true = !newStmts[idx].is_true; updateBlock(block.id, { ...block.content, statements: newStmts }); }} className={`px-2 py-1 rounded text-xs font-medium transition-colors ${item?.is_true ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>\r\n                                                                {item?.is_true ? '' : ''}\r\n                                                            </button>\r\n                                                            <button onClick={() => { const newStmts = (block.content?.statements || []).filter((_: any, i: number) => i !== idx); updateBlock(block.id, { ...block.content, statements: newStmts }); }} className=\"text-gray-400 hover:text-red-500\"><IconTrash className=\"w-4 h-4\" /></button>\r\n                                                        </div>\r\n                                                    ))}\r\n                                                    <button onClick={() => updateBlock(block.id, { ...block.content, statements: [...(block.content?.statements || []), { text: \"\", is_true: true }] })} className=\"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg\">+  </button>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* LOADING PLACEHOLDER - Shows during content generation */}\r\n                                        {block.type === 'loading-placeholder' && (\r\n                                            <div className=\"p-8 bg-gradient-to-br from-indigo-50/50 to-blue-50/50 rounded-2xl border border-indigo-100 flex flex-col items-center justify-center min-h-[180px]\">\r\n                                                <TypewriterLoader contentType={typewriterContentType} isVisible={true} />\r\n                                                {(block.content as any)?.title && (\r\n                                                    <div className=\"mt-4 text-indigo-600 text-sm font-medium\">\r\n                                                        {(block.content as any)?.title}\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* ACTIVITY INTRO - Opening context image */}\r\n                                        {block.type === 'activity-intro' && (\r\n                                            <div>\r\n                                                {(block.content as any)?.imageUrl ? (\r\n                                                    <div className=\"relative\">\r\n                                                        <img\r\n                                                            src={(block.content as any).imageUrl}\r\n                                                            alt={(block.content as any)?.title || ' '}\r\n                                                            className=\"w-full max-h-[400px] object-contain rounded-lg bg-gray-50\"\r\n                                                            loading=\"lazy\"\r\n                                                        />\r\n                                                        <div className=\"mt-2 p-2\">\r\n                                                            <h3 className=\"text-gray-800 font-medium text-sm\">{(block.content as any)?.title}</h3>\r\n                                                            {(block.content as any)?.description && (\r\n                                                                <p className=\"text-gray-500 text-xs mt-1\">{(block.content as any).description}</p>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <div className=\"h-32 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400\">\r\n                                                        <div className=\"text-center text-sm\">\r\n                                                            <IconSparkles className=\"w-5 h-5 mx-auto mb-1 animate-pulse\" />\r\n                                                            <span> ...</span>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* SCENARIO IMAGE - Dilemma/situation image before question */}\r\n                                        {block.type === 'scenario-image' && (\r\n                                            <div>\r\n                                                {(block.content as any)?.imageUrl ? (\r\n                                                    <div className=\"relative\">\r\n                                                        <img\r\n                                                            src={(block.content as any).imageUrl}\r\n                                                            alt={(block.content as any)?.caption || ' '}\r\n                                                            className=\"w-full max-h-[400px] object-contain rounded-lg bg-gray-50\"\r\n                                                            loading=\"lazy\"\r\n                                                        />\r\n                                                        {(block.content as any)?.caption && (\r\n                                                            <p className=\"mt-1 text-center text-gray-600 text-xs\">{(block.content as any).caption}</p>\r\n                                                        )}\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <div className=\"h-24 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm\">\r\n                                                        <span className=\"animate-pulse\"> ...</span>\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* INFOGRAPHIC BLOCK */}\r\n                                        {block.type === 'infographic' && (\r\n                                            <div>\r\n                                                {(block.content as any)?.imageUrl ? (\r\n                                                    <div>\r\n                                                        <img\r\n                                                            src={(block.content as any).imageUrl}\r\n                                                            alt={(block.content as any)?.title || ''}\r\n                                                            className=\"w-full rounded-lg bg-white\"\r\n                                                            loading=\"lazy\"\r\n                                                        />\r\n                                                        <div className=\"mt-2 space-y-1.5\">\r\n                                                            <input\r\n                                                                type=\"text\"\r\n                                                                className=\"w-full border border-gray-200 rounded-lg p-2 text-sm\"\r\n                                                                placeholder=\"...\"\r\n                                                                value={(block.content as any)?.title || ''}\r\n                                                                onChange={(e) => updateBlock(block.id, { ...(block.content as any), title: e.target.value })}\r\n                                                            />\r\n                                                            <input\r\n                                                                type=\"text\"\r\n                                                                className=\"w-full border border-gray-200 rounded-lg p-2 text-sm\"\r\n                                                                placeholder=\" ()...\"\r\n                                                                value={(block.content as any)?.caption || ''}\r\n                                                                onChange={(e) => updateBlock(block.id, { ...(block.content as any), caption: e.target.value })}\r\n                                                            />\r\n                                                        </div>\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <div className=\"space-y-3\">\r\n                                                        <div>\r\n                                                            <label className=\"block text-xs text-gray-500 mb-1\">:</label>\r\n                                                            <div className=\"flex flex-wrap gap-1.5\">\r\n                                                                {[\r\n                                                                    { type: 'flowchart', label: ' ' },\r\n                                                                    { type: 'timeline', label: ' ' },\r\n                                                                    { type: 'comparison', label: '' },\r\n                                                                    { type: 'cycle', label: '' }\r\n                                                                ].map(({ type, label }) => (\r\n                                                                    <button\r\n                                                                        key={type}\r\n                                                                        onClick={() => updateBlock(block.id, { ...(block.content as any), visualType: type })}\r\n                                                                        className={`px-2 py-1 rounded-lg border text-xs transition-all ${\r\n                                                                            (block.content as any)?.visualType === type\r\n                                                                                ? 'bg-gray-700 border-gray-700 text-white'\r\n                                                                                : 'bg-white border-gray-200 text-gray-600 hover:border-gray-300'\r\n                                                                        }`}\r\n                                                                    >\r\n                                                                        {label}\r\n                                                                    </button>\r\n                                                                ))}\r\n                                                            </div>\r\n                                                        </div>\r\n                                                        <div>\r\n                                                            <label className=\"block text-xs text-gray-500 mb-1\">:</label>\r\n                                                            <textarea\r\n                                                                className=\"w-full border border-gray-200 rounded-lg p-2 text-sm resize-none\"\r\n                                                                rows={3}\r\n                                                                placeholder=\"    ...\"\r\n                                                                value={mediaInputValue[block.id] || ''}\r\n                                                                onChange={(e) => setMediaInputValue({ ...mediaInputValue, [block.id]: e.target.value })}\r\n                                                            />\r\n                                                        </div>\r\n                                                        <button\r\n                                                            onClick={async () => {\r\n                                                                const text = mediaInputValue[block.id];\r\n                                                                if (!text || text.trim().length < 10) {\r\n                                                                    alert('   ( 10 )');\r\n                                                                    return;\r\n                                                                }\r\n                                                                setLoadingBlockId(block.id);\r\n                                                                try {\r\n                                                                    const visualType = (block.content as any)?.visualType || 'flowchart';\r\n                                                                    const imageBlob = await generateInfographicFromText(text, visualType as InfographicType, unit?.title);\r\n                                                                    if (imageBlob) {\r\n                                                                        const imageUrl = await uploadMediaFile(imageBlob, `infographic_${block.id}.png`, 'image/png');\r\n                                                                        updateBlock(block.id, {\r\n                                                                            imageUrl,\r\n                                                                            title: unit?.title || '',\r\n                                                                            caption: '',\r\n                                                                            visualType\r\n                                                                        }, { infographicType: visualType });\r\n                                                                        setMediaInputValue({ ...mediaInputValue, [block.id]: '' });\r\n                                                                    } else {\r\n                                                                        alert('  ');\r\n                                                                    }\r\n                                                                } catch (err) {\r\n                                                                    console.error('Infographic generation error:', err);\r\n                                                                    alert('  ');\r\n                                                                } finally {\r\n                                                                    setLoadingBlockId(null);\r\n                                                                }\r\n                                                            }}\r\n                                                            disabled={loadingBlockId === block.id || !mediaInputValue[block.id]?.trim()}\r\n                                                            className=\"w-full bg-gray-700 text-white py-2 px-3 rounded-lg text-sm font-medium hover:bg-gray-800 transition-all disabled:opacity-50 flex items-center justify-center gap-2\"\r\n                                                        >\r\n                                                            {loadingBlockId === block.id ? (\r\n                                                                <>\r\n                                                                    <div className=\"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin\"></div>\r\n                                                                    ...\r\n                                                                </>\r\n                                                            ) : (\r\n                                                                <>\r\n                                                                    <IconWand className=\"w-3 h-3\" />\r\n                                                                     \r\n                                                                </>\r\n                                                            )}\r\n                                                        </button>\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* MATCHING -  */}\r\n                                        {block.type === 'matching' && (\r\n                                            <div className=\"bg-violet-50/50 p-5 rounded-xl border border-violet-100\">\r\n                                                <div className=\"flex items-center gap-2 mb-4 text-violet-700 font-bold justify-between\">\r\n                                                    <div className=\"flex items-center gap-2\"><IconLink className=\"w-5 h-5\" /> </div>\r\n                                                </div>\r\n\r\n                                                <RichTextEditor\r\n                                                    value={(block.content && block.content.instruction) || ''}\r\n                                                    onChange={(html) => updateBlock(block.id, { ...block.content, instruction: html })}\r\n                                                    placeholder=\" (:    )\"\r\n                                                    minHeight=\"40px\"\r\n                                                    maxHeight=\"150px\"\r\n                                                    collapsible={true}\r\n                                                />\r\n\r\n                                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                                                    {/* Left Items Column */}\r\n                                                    <div>\r\n                                                        <h4 className=\"text-xs font-bold text-violet-400 uppercase mb-2\">  ()</h4>\r\n                                                        <div className=\"space-y-2\">\r\n                                                            {(block.content?.leftItems || []).map((item: any, idx: number) => (\r\n                                                                <div key={item.id || idx} className=\"flex gap-2 items-center bg-white p-2 rounded border border-violet-100\">\r\n                                                                    <span className=\"text-xs text-violet-300 font-mono w-6\">{item.id}</span>\r\n                                                                    <input type=\"text\" className=\"flex-1 p-2 text-base border-b border-gray-200 focus:border-violet-400 outline-none\" value={item?.text || ''} onChange={(e) => { const newItems = [...(block.content?.leftItems || [])]; newItems[idx] = { ...newItems[idx], text: e.target.value }; updateBlock(block.id, { ...block.content, leftItems: newItems }); }} placeholder=\" \" />\r\n                                                                    <button onClick={() => {\r\n                                                                        const removedId = block.content?.leftItems?.[idx]?.id;\r\n                                                                        const newItems = (block.content?.leftItems || []).filter((_: any, i: number) => i !== idx);\r\n                                                                        const newMatches = (block.content?.correctMatches || []).filter((m: any) => m.left !== removedId);\r\n                                                                        updateBlock(block.id, { ...block.content, leftItems: newItems, correctMatches: newMatches });\r\n                                                                    }} className=\"text-red-400 hover:text-red-600\"><IconTrash className=\"w-3 h-3\" /></button>\r\n                                                                </div>\r\n                                                            ))}\r\n                                                            <button onClick={() => {\r\n                                                                const nextId = `l${(block.content?.leftItems?.length || 0) + 1}`;\r\n                                                                updateBlock(block.id, { ...block.content, leftItems: [...(block.content?.leftItems || []), { id: nextId, text: \"\" }] });\r\n                                                            }} className=\"text-xs font-bold text-violet-600 bg-violet-100 hover:bg-violet-200 px-3 py-1 rounded-full\">+  </button>\r\n                                                        </div>\r\n                                                    </div>\r\n\r\n                                                    {/* Right Items Column */}\r\n                                                    <div>\r\n                                                        <h4 className=\"text-xs font-bold text-violet-400 uppercase mb-2\">  ()</h4>\r\n                                                        <div className=\"space-y-2\">\r\n                                                            {(block.content?.rightItems || []).map((item: any, idx: number) => (\r\n                                                                <div key={item.id || idx} className=\"flex gap-2 items-center bg-white p-2 rounded border border-violet-100\">\r\n                                                                    <span className=\"text-xs text-violet-300 font-mono w-6\">{item.id}</span>\r\n                                                                    <input type=\"text\" className=\"flex-1 p-2 text-base border-b border-gray-200 focus:border-violet-400 outline-none\" value={item?.text || ''} onChange={(e) => { const newItems = [...(block.content?.rightItems || [])]; newItems[idx] = { ...newItems[idx], text: e.target.value }; updateBlock(block.id, { ...block.content, rightItems: newItems }); }} placeholder=\" \" />\r\n                                                                    <button onClick={() => {\r\n                                                                        const removedId = block.content?.rightItems?.[idx]?.id;\r\n                                                                        const newItems = (block.content?.rightItems || []).filter((_: any, i: number) => i !== idx);\r\n                                                                        const newMatches = (block.content?.correctMatches || []).filter((m: any) => m.right !== removedId);\r\n                                                                        updateBlock(block.id, { ...block.content, rightItems: newItems, correctMatches: newMatches });\r\n                                                                    }} className=\"text-red-400 hover:text-red-600\"><IconTrash className=\"w-3 h-3\" /></button>\r\n                                                                </div>\r\n                                                            ))}\r\n                                                            <button onClick={() => {\r\n                                                                const nextId = `r${(block.content?.rightItems?.length || 0) + 1}`;\r\n                                                                updateBlock(block.id, { ...block.content, rightItems: [...(block.content?.rightItems || []), { id: nextId, text: \"\" }] });\r\n                                                            }} className=\"text-xs font-bold text-violet-600 bg-violet-100 hover:bg-violet-200 px-3 py-1 rounded-full\">+  </button>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n\r\n                                                {/* Correct Matches */}\r\n                                                <div className=\"mt-6 p-4 bg-violet-100/50 rounded-lg\">\r\n                                                    <h4 className=\"text-xs font-bold text-violet-500 uppercase mb-3\"> </h4>\r\n                                                    <div className=\"space-y-2\">\r\n                                                        {(block.content?.correctMatches || []).map((match: any, idx: number) => (\r\n                                                            <div key={idx} className=\"flex gap-2 items-center bg-white p-2 rounded border border-violet-200\">\r\n                                                                <select className=\"flex-1 p-2 bg-gray-50 rounded border border-gray-200 text-sm\" value={match?.left || ''} onChange={(e) => { const newMatches = [...(block.content?.correctMatches || [])]; newMatches[idx] = { ...newMatches[idx], left: e.target.value }; updateBlock(block.id, { ...block.content, correctMatches: newMatches }); }}>\r\n                                                                    <option value=\"\" disabled>  </option>\r\n                                                                    {(block.content?.leftItems || []).map((item: any) => <option key={item.id} value={item.id}>{item.text || item.id}</option>)}\r\n                                                                </select>\r\n                                                                <span className=\"text-violet-400 font-bold\"></span>\r\n                                                                <select className=\"flex-1 p-2 bg-gray-50 rounded border border-gray-200 text-sm\" value={match?.right || ''} onChange={(e) => { const newMatches = [...(block.content?.correctMatches || [])]; newMatches[idx] = { ...newMatches[idx], right: e.target.value }; updateBlock(block.id, { ...block.content, correctMatches: newMatches }); }}>\r\n                                                                    <option value=\"\" disabled>  </option>\r\n                                                                    {(block.content?.rightItems || []).map((item: any) => <option key={item.id} value={item.id}>{item.text || item.id}</option>)}\r\n                                                                </select>\r\n                                                                <button onClick={() => { const newMatches = (block.content?.correctMatches || []).filter((_: any, i: number) => i !== idx); updateBlock(block.id, { ...block.content, correctMatches: newMatches }); }} className=\"text-red-400 hover:text-red-600\"><IconTrash className=\"w-4 h-4\" /></button>\r\n                                                            </div>\r\n                                                        ))}\r\n                                                        <button onClick={() => updateBlock(block.id, { ...block.content, correctMatches: [...(block.content?.correctMatches || []), { left: \"\", right: \"\" }] })} className=\"text-xs font-bold text-violet-600 bg-violet-200 hover:bg-violet-300 px-3 py-1 rounded-full\">+  </button>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {/* Generic Question Types (highlight, sentence_builder, etc.) */}\r\n                                        {['highlight', 'sentence_builder', 'image_labeling', 'table_completion', 'text_selection', 'rating_scale', 'matrix', 'drag_and_drop', 'hotspot'].includes(block.type) && (\r\n                                            <div className=\"bg-slate-50/50 p-5 rounded-xl border border-slate-200\">\r\n                                                <div className=\"flex items-center gap-2 mb-4 text-slate-700 font-bold\">\r\n                                                    <IconEdit className=\"w-5 h-5\" /> {BLOCK_TYPE_MAPPING[block.type] || block.type}\r\n                                                </div>\r\n                                                <p className=\"text-xs text-gray-500 mb-4\">    .     -JSON   -AI  .</p>\r\n                                                <pre className=\"bg-white p-3 rounded-lg border text-xs overflow-auto max-h-40 text-left\" dir=\"ltr\">\r\n                                                    {JSON.stringify(block.content, null, 2)}\r\n                                                </pre>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                <InsertMenu index={index + 1} />\r\n                            </React.Fragment>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Source Viewer Column */}\r\n                {\r\n                    showSource && (\r\n                        <div className=\"w-1/2 border-r border-gray-200 bg-white shadow-xl z-20 animate-slide-in-left relative overflow-hidden flex flex-col h-full bg-slate-50\">\r\n                            <SourceViewer\r\n                                content={course.fullBookContent || \"  .\"}\r\n                                pdfSource={course.pdfSource || undefined}\r\n                                onClose={() => setShowSource(false)}\r\n                            />\r\n                        </div>\r\n                    )\r\n                }\r\n            </div >\r\n            {/* Sticky Score Footer */}\r\n            {\r\n                showScoring && (\r\n                    <div className={`fixed bottom-0 left-0 right-0 p-3 flex justify-between items-center px-10 transition-colors shadow-[0_-5px_20px_rgba(0,0,0,0.1)] backdrop-blur-md border-t z-50 animate-slide-up\r\n                    ${totalScore === 100 ? 'bg-green-50/90 border-green-200 text-green-900' : 'bg-white/90 border-red-200 text-slate-800'}`}>\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className={`text-2xl font-black flex items-center gap-2 ${totalScore === 100 ? 'text-green-600' : 'text-red-500'}`}>\r\n                                <IconBalance className=\"w-6 h-6\" />\r\n                                {totalScore} / 100\r\n                            </div>\r\n                            {totalScore !== 100 && (\r\n                                <div className=\"text-sm font-bold text-red-500 bg-red-100 px-3 py-1 rounded-full animate-pulse\">\r\n                                    {totalScore < 100 ? ` ${100 - totalScore} ` : `  ${totalScore - 100} `}\r\n                                </div>\r\n                            )}\r\n                            {totalScore === 100 && (\r\n                                <div className=\"text-sm font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full flex items-center gap-1\">\r\n                                    <IconCheck className=\"w-4 h-4\" />   \r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                        <div className=\"flex gap-2\">\r\n                            <button onClick={handleAutoDistributePoints} className=\"text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-bold shadow-sm transition-colors\">\r\n                                  ()\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )\r\n            }\r\n\r\n            <style>{`\r\n                .insert-btn { @apply w-20 h-20 p-2 bg-white/50 border border-white/60 rounded-xl text-[10px] font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all flex flex-col items-center justify-center gap-1.5 shadow-sm text-center leading-tight; }\r\n                .insert-btn svg { @apply w-6 h-6 flex-shrink-0; }\r\n                .animate-scale-in { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; transform-origin: bottom center; }\r\n                @keyframes scaleIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }\r\n            `}</style>\r\n\r\n            {/* Assignment Creation Modal (Portal) */}\r\n            {\r\n                assignmentModalOpen && createPortal(\r\n                    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4 text-right\" dir=\"rtl\">\r\n                        <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in\">\r\n                            <div className=\"bg-indigo-600 p-4 text-white flex justify-between items-center\">\r\n                                <h3 className=\"font-bold text-lg flex items-center gap-2\"><IconLink className=\"w-5 h-5\" /> {createdAssignmentLink ? ' !' : '  '}</h3>\r\n                                <button onClick={handleCloseAssignmentModal} className=\"hover:bg-indigo-700 p-1 rounded-full text-indigo-100\"><IconX className=\"w-5 h-5\" /></button>\r\n                            </div>\r\n                            <div className=\"p-6 space-y-4\">\r\n                                {createdAssignmentLink ? (\r\n                                    <>\r\n                                        <div className=\"text-center py-4\">\r\n                                            <div className=\"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                                                <IconCheck className=\"w-8 h-8 text-green-600\" />\r\n                                            </div>\r\n                                            <p className=\"text-lg font-bold text-slate-700 mb-2\">  !</p>\r\n                                            <p className=\"text-sm text-slate-500\">   </p>\r\n                                        </div>\r\n                                        <div className=\"bg-slate-50 border border-slate-200 rounded-xl p-3\">\r\n                                            <label className=\"block text-xs font-bold text-slate-500 mb-2\"> :</label>\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <input\r\n                                                    type=\"text\"\r\n                                                    readOnly\r\n                                                    value={createdAssignmentLink}\r\n                                                    className=\"flex-1 bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-600 select-all\"\r\n                                                    onClick={e => (e.target as HTMLInputElement).select()}\r\n                                                />\r\n                                                <button\r\n                                                    onClick={handleCopyCreatedLink}\r\n                                                    className=\"px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors flex items-center gap-1 text-sm\"\r\n                                                >\r\n                                                    <IconCopy className=\"w-4 h-4\" /> \r\n                                                </button>\r\n                                            </div>\r\n                                        </div>\r\n                                        <button\r\n                                            onClick={handleCloseAssignmentModal}\r\n                                            className=\"w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition-colors mt-2\"\r\n                                        >\r\n                                            \r\n                                        </button>\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <div>\r\n                                            <label className=\"block text-sm font-bold text-slate-700 mb-1\">  / </label>\r\n                                            <input type=\"text\" className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none\"\r\n                                                value={assignmentData.title} onChange={e => setAssignmentData({ ...assignmentData, title: e.target.value })}\r\n                                                placeholder=\":    -  \"\r\n                                            />\r\n                                        </div>\r\n                                        <div className=\"grid grid-cols-2 gap-4\">\r\n                                            <div>\r\n                                                <label className=\"block text-sm font-bold text-slate-700 mb-1\"> </label>\r\n                                                <input type=\"date\" className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 outline-none\"\r\n                                                    value={assignmentData.dueDate} onChange={e => setAssignmentData({ ...assignmentData, dueDate: e.target.value })}\r\n                                                />\r\n                                            </div>\r\n                                            <div>\r\n                                                <label className=\"block text-sm font-bold text-slate-700 mb-1\"></label>\r\n                                                <input type=\"time\" className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 outline-none\"\r\n                                                    value={assignmentData.dueTime} onChange={e => setAssignmentData({ ...assignmentData, dueTime: e.target.value })}\r\n                                                />\r\n                                            </div>\r\n                                        </div>\r\n                                        <div>\r\n                                            <label className=\"block text-sm font-bold text-slate-700 mb-1\">  ()</label>\r\n                                            <textarea className=\"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 outline-none h-20 resize-none\"\r\n                                                value={assignmentData.instructions} onChange={e => setAssignmentData({ ...assignmentData, instructions: e.target.value })}\r\n                                                placeholder=\" ,  , '...\"\r\n                                            />\r\n                                        </div>\r\n\r\n                                        <button onClick={handleCreateAssignment} className=\"w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors flex justify-center items-center gap-2 mt-2\">\r\n                                            <IconLink className=\"w-5 h-5\" />  \r\n                                        </button>\r\n                                        <p className=\"text-xs text-center text-slate-400\">     </p>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>,\r\n                    document.body\r\n                )\r\n            }\r\n\r\n            {/* YouTube Search Modal */}\r\n            <YouTubeSearchModal\r\n                isOpen={youtubeSearchOpen}\r\n                onClose={() => { setYoutubeSearchOpen(false); setYoutubeSearchBlockId(null); }}\r\n                onSelectVideo={handleYouTubeVideoSelect}\r\n                gradeLevel={gradeLevel}\r\n                subject={subject}\r\n                initialQuery={editedUnit.title || ''}\r\n            />\r\n\r\n            {/* Mind Map Generator Modal */}\r\n            <MindMapGeneratorModal\r\n                isOpen={mindMapModalOpen}\r\n                onClose={() => {\r\n                    setMindMapModalOpen(false);\r\n                    setMindMapBlockId(null);\r\n                }}\r\n                onGenerate={(content: MindMapContent) => {\r\n                    if (mindMapBlockId) {\r\n                        updateBlock(mindMapBlockId, content);\r\n                        setIsDirty(true);\r\n                    }\r\n                }}\r\n                sourceText={course?.fullBookContent || editedUnit.baseContent || ''}\r\n                topic={editedUnit.title}\r\n                gradeLevel={gradeLevel}\r\n            />\r\n        </div >\r\n    );\r\n};\r\n\r\nexport default UnitEditor;","/**\r\n * useStreamingGeneration Hook\r\n *\r\n * React hook for streaming content generation with real-time UI updates.\r\n * Provides state management and callbacks for streaming responses.\r\n */\r\n\r\nimport { useState, useCallback, useRef } from 'react';\r\nimport {\r\n  streamContent,\r\n  streamDifferentiatedContent,\r\n  streamLessonContent,\r\n  streamPodcastContent,\r\n  streamActivityContent\r\n} from '../services/streamingService';\r\nimport type {\r\n  StreamContentOptions,\r\n  DifferentiatedResult,\r\n  ActivityStreamResult\r\n} from '../services/streamingService';\r\n\r\n// ============================================================\r\n// TYPES\r\n// ============================================================\r\n\r\nexport interface StreamingState {\r\n  isStreaming: boolean;\r\n  progress: string;\r\n  currentLevel?: string;\r\n  currentPart?: string;\r\n  currentStep?: number;\r\n  totalSteps?: number;\r\n  streamedText: string;\r\n  error: string | null;\r\n}\r\n\r\nexport interface UseStreamingGenerationResult {\r\n  // State\r\n  state: StreamingState;\r\n\r\n  // Actions\r\n  startStreaming: (\r\n    prompt: string,\r\n    systemPrompt?: string,\r\n    options?: StreamContentOptions\r\n  ) => Promise<string | any>;\r\n\r\n  startDifferentiatedStreaming: (\r\n    options: StreamContentOptions\r\n  ) => Promise<DifferentiatedResult>;\r\n\r\n  startLessonStreaming: (\r\n    options: StreamContentOptions & { lessonParts?: string[] }\r\n  ) => Promise<Record<string, any>>;\r\n\r\n  startPodcastStreaming: (\r\n    options: StreamContentOptions\r\n  ) => Promise<any>;\r\n\r\n  startActivityStreaming: (\r\n    options: StreamContentOptions,\r\n    onStepComplete?: (step: any, stepNumber: number, totalSteps: number) => void,\r\n    onSkeletonComplete?: (skeleton: any) => void\r\n  ) => Promise<ActivityStreamResult>;\r\n\r\n  cancelStreaming: () => void;\r\n\r\n  // Reset\r\n  resetState: () => void;\r\n}\r\n\r\n// ============================================================\r\n// INITIAL STATE\r\n// ============================================================\r\n\r\nconst initialState: StreamingState = {\r\n  isStreaming: false,\r\n  progress: '',\r\n  currentLevel: undefined,\r\n  currentPart: undefined,\r\n  currentStep: undefined,\r\n  totalSteps: undefined,\r\n  streamedText: '',\r\n  error: null\r\n};\r\n\r\n// ============================================================\r\n// HOOK\r\n// ============================================================\r\n\r\nexport function useStreamingGeneration(): UseStreamingGenerationResult {\r\n  const [state, setState] = useState<StreamingState>(initialState);\r\n  const abortControllerRef = useRef<AbortController | null>(null);\r\n\r\n  /**\r\n   * Reset state to initial values\r\n   */\r\n  const resetState = useCallback(() => {\r\n    setState(initialState);\r\n    abortControllerRef.current = null;\r\n  }, []);\r\n\r\n  /**\r\n   * Cancel ongoing streaming\r\n   */\r\n  const cancelStreaming = useCallback(() => {\r\n    if (abortControllerRef.current) {\r\n      abortControllerRef.current.abort();\r\n      abortControllerRef.current = null;\r\n      setState(prev => ({\r\n        ...prev,\r\n        isStreaming: false,\r\n        progress: ''\r\n      }));\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Start generic content streaming\r\n   */\r\n  const startStreaming = useCallback(async (\r\n    prompt: string,\r\n    systemPrompt?: string,\r\n    options?: StreamContentOptions\r\n  ): Promise<string | any> => {\r\n    resetState();\r\n\r\n    setState(prev => ({\r\n      ...prev,\r\n      isStreaming: true,\r\n      progress: ' ...'\r\n    }));\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        let fullContent = '';\r\n\r\n        const controller = await streamContent(\r\n          prompt,\r\n          systemPrompt,\r\n          options || {},\r\n          {\r\n            onChunk: (chunk) => {\r\n              fullContent += chunk;\r\n              setState(prev => ({\r\n                ...prev,\r\n                streamedText: fullContent\r\n              }));\r\n            },\r\n            onProgress: (message) => {\r\n              setState(prev => ({\r\n                ...prev,\r\n                progress: message\r\n              }));\r\n            },\r\n            onComplete: (content) => {\r\n              setState(prev => ({\r\n                ...prev,\r\n                isStreaming: false,\r\n                progress: '!'\r\n              }));\r\n              resolve(content);\r\n            },\r\n            onError: (error) => {\r\n              setState(prev => ({\r\n                ...prev,\r\n                isStreaming: false,\r\n                error\r\n              }));\r\n              reject(new Error(error));\r\n            }\r\n          }\r\n        );\r\n\r\n        abortControllerRef.current = controller;\r\n\r\n      } catch (error: any) {\r\n        setState(prev => ({\r\n          ...prev,\r\n          isStreaming: false,\r\n          error: error.message\r\n        }));\r\n        reject(error);\r\n      }\r\n    });\r\n  }, [resetState]);\r\n\r\n  /**\r\n   * Start differentiated content streaming (3 levels)\r\n   */\r\n  const startDifferentiatedStreaming = useCallback(async (\r\n    options: StreamContentOptions\r\n  ): Promise<DifferentiatedResult> => {\r\n    resetState();\r\n\r\n    setState(prev => ({\r\n      ...prev,\r\n      isStreaming: true,\r\n      progress: '   ...'\r\n    }));\r\n\r\n    try {\r\n      const { controller, result } = await streamDifferentiatedContent(\r\n        options,\r\n        {\r\n          onChunk: (chunk, metadata) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              streamedText: prev.streamedText + chunk,\r\n              currentLevel: metadata?.level\r\n            }));\r\n          },\r\n          onProgress: (message, metadata) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: message,\r\n              currentLevel: metadata?.level\r\n            }));\r\n          },\r\n          onLevelStart: (level) => {\r\n            const levelNames: Record<string, string> = {\r\n              support: '',\r\n              core: '',\r\n              enrichment: ''\r\n            };\r\n            setState(prev => ({\r\n              ...prev,\r\n              currentLevel: level,\r\n              progress: ` ${levelNames[level] || level}...`,\r\n              streamedText: '' // Reset for new level\r\n            }));\r\n          },\r\n          onLevelComplete: (level) => {\r\n            const levelNames: Record<string, string> = {\r\n              support: '',\r\n              core: '',\r\n              enrichment: ''\r\n            };\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: ` ${levelNames[level] || level} `\r\n            }));\r\n          },\r\n          onComplete: () => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              progress: '  !',\r\n              currentLevel: undefined\r\n            }));\r\n          },\r\n          onError: (error) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              error\r\n            }));\r\n          }\r\n        }\r\n      );\r\n\r\n      abortControllerRef.current = controller;\r\n      return await result;\r\n\r\n    } catch (error: any) {\r\n      setState(prev => ({\r\n        ...prev,\r\n        isStreaming: false,\r\n        error: error.message\r\n      }));\r\n      throw error;\r\n    }\r\n  }, [resetState]);\r\n\r\n  /**\r\n   * Start lesson content streaming\r\n   */\r\n  const startLessonStreaming = useCallback(async (\r\n    options: StreamContentOptions & { lessonParts?: string[] }\r\n  ): Promise<Record<string, any>> => {\r\n    resetState();\r\n\r\n    setState(prev => ({\r\n      ...prev,\r\n      isStreaming: true,\r\n      progress: '   ...'\r\n    }));\r\n\r\n    try {\r\n      const { controller, result } = await streamLessonContent(\r\n        options,\r\n        {\r\n          onChunk: (chunk, metadata) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              streamedText: prev.streamedText + chunk,\r\n              currentPart: metadata?.itemType\r\n            }));\r\n          },\r\n          onProgress: (message, metadata) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: message,\r\n              currentPart: metadata?.itemType\r\n            }));\r\n          },\r\n          onPartStart: (part) => {\r\n            const partNames: Record<string, string> = {\r\n              hook: '',\r\n              instruction: '',\r\n              practice: '',\r\n              summary: ''\r\n            };\r\n            setState(prev => ({\r\n              ...prev,\r\n              currentPart: part,\r\n              progress: ` ${partNames[part] || part}...`,\r\n              streamedText: '' // Reset for new part\r\n            }));\r\n          },\r\n          onPartComplete: (part) => {\r\n            const partNames: Record<string, string> = {\r\n              hook: '',\r\n              instruction: '',\r\n              practice: '',\r\n              summary: ''\r\n            };\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: ` ${partNames[part] || part} `\r\n            }));\r\n          },\r\n          onComplete: () => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              progress: '  !',\r\n              currentPart: undefined\r\n            }));\r\n          },\r\n          onError: (error) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              error\r\n            }));\r\n          }\r\n        }\r\n      );\r\n\r\n      abortControllerRef.current = controller;\r\n      return await result;\r\n\r\n    } catch (error: any) {\r\n      setState(prev => ({\r\n        ...prev,\r\n        isStreaming: false,\r\n        error: error.message\r\n      }));\r\n      throw error;\r\n    }\r\n  }, [resetState]);\r\n\r\n  /**\r\n   * Start podcast content streaming\r\n   */\r\n  const startPodcastStreaming = useCallback(async (\r\n    options: StreamContentOptions\r\n  ): Promise<any> => {\r\n    resetState();\r\n\r\n    setState(prev => ({\r\n      ...prev,\r\n      isStreaming: true,\r\n      progress: '  ...'\r\n    }));\r\n\r\n    try {\r\n      const { controller, result } = await streamPodcastContent(\r\n        options,\r\n        {\r\n          onChunk: (chunk) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              streamedText: prev.streamedText + chunk\r\n            }));\r\n          },\r\n          onProgress: (message) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: message\r\n            }));\r\n          },\r\n          onComplete: () => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              progress: ' !'\r\n            }));\r\n          },\r\n          onError: (error) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              error\r\n            }));\r\n          }\r\n        }\r\n      );\r\n\r\n      abortControllerRef.current = controller;\r\n      return await result;\r\n\r\n    } catch (error: any) {\r\n      setState(prev => ({\r\n        ...prev,\r\n        isStreaming: false,\r\n        error: error.message\r\n      }));\r\n      throw error;\r\n    }\r\n  }, [resetState]);\r\n\r\n  /**\r\n   * Start activity content streaming (single activity with parallel steps)\r\n   */\r\n  const startActivityStreaming = useCallback(async (\r\n    options: StreamContentOptions,\r\n    onStepComplete?: (step: any, stepNumber: number, totalSteps: number) => void,\r\n    onSkeletonComplete?: (skeleton: any) => void\r\n  ): Promise<ActivityStreamResult> => {\r\n    resetState();\r\n\r\n    setState(prev => ({\r\n      ...prev,\r\n      isStreaming: true,\r\n      progress: '  ...'\r\n    }));\r\n\r\n    try {\r\n      const { controller, result } = await streamActivityContent(\r\n        options,\r\n        {\r\n          onProgress: (message, metadata) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: message,\r\n              currentStep: metadata?.stepNumber,\r\n              totalSteps: metadata?.totalSteps\r\n            }));\r\n          },\r\n          onSkeletonComplete: (skeleton) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: `   - ${skeleton.steps?.length || 5} `,\r\n              totalSteps: skeleton.steps?.length || 5\r\n            }));\r\n            onSkeletonComplete?.(skeleton);\r\n          },\r\n          onStepComplete: (step, stepNumber, totalSteps) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              progress: ` ${stepNumber}/${totalSteps} `,\r\n              currentStep: stepNumber,\r\n              totalSteps: totalSteps\r\n            }));\r\n            onStepComplete?.(step, stepNumber, totalSteps);\r\n          },\r\n          onComplete: () => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              progress: ' !',\r\n              currentStep: undefined,\r\n              totalSteps: undefined\r\n            }));\r\n          },\r\n          onError: (error) => {\r\n            setState(prev => ({\r\n              ...prev,\r\n              isStreaming: false,\r\n              error\r\n            }));\r\n          }\r\n        }\r\n      );\r\n\r\n      abortControllerRef.current = controller;\r\n      return await result;\r\n\r\n    } catch (error: any) {\r\n      setState(prev => ({\r\n        ...prev,\r\n        isStreaming: false,\r\n        error: error.message\r\n      }));\r\n      throw error;\r\n    }\r\n  }, [resetState]);\r\n\r\n  return {\r\n    state,\r\n    startStreaming,\r\n    startDifferentiatedStreaming,\r\n    startLessonStreaming,\r\n    startPodcastStreaming,\r\n    startActivityStreaming,\r\n    cancelStreaming,\r\n    resetState\r\n  };\r\n}\r\n","/**\r\n * StreamingProgress Component\r\n *\r\n * Visual component for showing real-time streaming progress.\r\n * Displays:\r\n * - Current progress message\r\n * - Level/Part indicators for differentiated/lesson content\r\n * - Animated text streaming effect\r\n * - Cancel button\r\n */\r\n\r\nimport React from 'react';\r\nimport { IconLoader, IconCircleX, IconCircleCheck, IconSparkles } from '@tabler/icons-react';\r\nimport type { StreamingState } from '../hooks/useStreamingGeneration';\r\n\r\n// ============================================================\r\n// TYPES\r\n// ============================================================\r\n\r\ninterface StreamingProgressProps {\r\n  state: StreamingState;\r\n  onCancel?: () => void;\r\n  showStreamedText?: boolean;\r\n  className?: string;\r\n}\r\n\r\ninterface LevelIndicatorProps {\r\n  currentLevel?: string;\r\n  completedLevels?: string[];\r\n}\r\n\r\n// ============================================================\r\n// SUBCOMPONENTS\r\n// ============================================================\r\n\r\n/**\r\n * Level progress indicator for differentiated content\r\n */\r\nconst LevelIndicator: React.FC<LevelIndicatorProps> = ({\r\n  currentLevel,\r\n  completedLevels = []\r\n}) => {\r\n  const levels = [\r\n    { key: 'support', name: '', color: 'bg-green-500' },\r\n    { key: 'core', name: '', color: 'bg-blue-500' },\r\n    { key: 'enrichment', name: '', color: 'bg-purple-500' }\r\n  ];\r\n\r\n  return (\r\n    <div className=\"flex gap-2 items-center justify-center mt-3\">\r\n      {levels.map((level, index) => {\r\n        const isCompleted = completedLevels.includes(level.key);\r\n        const isCurrent = currentLevel === level.key;\r\n\r\n        return (\r\n          <React.Fragment key={level.key}>\r\n            {index > 0 && (\r\n              <div className={`h-0.5 w-8 transition-colors duration-300 ${\r\n                isCompleted || isCurrent ? 'bg-gray-400' : 'bg-gray-200'\r\n              }`} />\r\n            )}\r\n            <div className=\"flex flex-col items-center gap-1\">\r\n              <div\r\n                className={`\r\n                  w-8 h-8 rounded-full flex items-center justify-center\r\n                  transition-all duration-300\r\n                  ${isCompleted ? `${level.color} text-white` : ''}\r\n                  ${isCurrent ? `${level.color} text-white animate-pulse ring-2 ring-offset-2 ring-${level.color}` : ''}\r\n                  ${!isCompleted && !isCurrent ? 'bg-gray-200 text-gray-400' : ''}\r\n                `}\r\n              >\r\n                {isCompleted ? (\r\n                  <IconCircleCheck className=\"w-5 h-5\" />\r\n                ) : isCurrent ? (\r\n                  <IconLoader className=\"w-5 h-5 animate-spin\" />\r\n                ) : (\r\n                  <span className=\"text-xs font-medium\">{index + 1}</span>\r\n                )}\r\n              </div>\r\n              <span className={`text-xs font-medium ${\r\n                isCurrent ? 'text-gray-900' : 'text-gray-500'\r\n              }`}>\r\n                {level.name}\r\n              </span>\r\n            </div>\r\n          </React.Fragment>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n};\r\n\r\n/**\r\n * Typing animation for streamed text\r\n */\r\nconst StreamedText: React.FC<{ text: string }> = ({ text }) => {\r\n  if (!text) return null;\r\n\r\n  return (\r\n    <div className=\"mt-4 p-4 bg-gray-50 rounded-lg max-h-48 overflow-y-auto\">\r\n      <div className=\"font-mono text-sm text-gray-700 whitespace-pre-wrap break-words\">\r\n        {text}\r\n        <span className=\"inline-block w-2 h-4 bg-blue-500 animate-pulse ml-0.5\" />\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// ============================================================\r\n// MAIN COMPONENT\r\n// ============================================================\r\n\r\nexport const StreamingProgress: React.FC<StreamingProgressProps> = ({\r\n  state,\r\n  onCancel,\r\n  showStreamedText = false,\r\n  className = ''\r\n}) => {\r\n  const { isStreaming, progress, currentLevel, currentPart, streamedText, error } = state;\r\n\r\n  // Don't render if not streaming and no error\r\n  if (!isStreaming && !error && !progress) {\r\n    return null;\r\n  }\r\n\r\n  // Determine completed levels based on progress message\r\n  const completedLevels: string[] = [];\r\n  if (progress.includes('  ')) completedLevels.push('support');\r\n  if (progress.includes('  ')) completedLevels.push('core');\r\n  if (progress.includes('  ')) completedLevels.push('enrichment');\r\n\r\n  return (\r\n    <div className={`rounded-xl border bg-white shadow-lg p-6 ${className}`}>\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-3\">\r\n          {isStreaming ? (\r\n            <div className=\"relative\">\r\n              <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center\">\r\n                <IconSparkles className=\"w-5 h-5 text-white animate-pulse\" />\r\n              </div>\r\n              <div className=\"absolute -inset-1 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 opacity-30 animate-ping\" />\r\n            </div>\r\n          ) : error ? (\r\n            <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\r\n              <IconCircleX className=\"w-5 h-5 text-red-500\" />\r\n            </div>\r\n          ) : (\r\n            <div className=\"w-10 h-10 rounded-full bg-green-100 flex items-center justify-center\">\r\n              <IconCircleCheck className=\"w-5 h-5 text-green-500\" />\r\n            </div>\r\n          )}\r\n          <div>\r\n            <h3 className=\"font-semibold text-gray-900\">\r\n              {isStreaming ? ' ...' : error ? '' : '!'}\r\n            </h3>\r\n            <p className=\"text-sm text-gray-500\">{progress}</p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Cancel button */}\r\n        {isStreaming && onCancel && (\r\n          <button\r\n            onClick={onCancel}\r\n            className=\"px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors\"\r\n          >\r\n            \r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Error message */}\r\n      {error && (\r\n        <div className=\"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm\">\r\n          {error}\r\n        </div>\r\n      )}\r\n\r\n      {/* Level indicator for differentiated content */}\r\n      {currentLevel && (\r\n        <LevelIndicator\r\n          currentLevel={currentLevel}\r\n          completedLevels={completedLevels}\r\n        />\r\n      )}\r\n\r\n      {/* Part indicator for lesson content */}\r\n      {currentPart && !currentLevel && (\r\n        <div className=\"mt-3 text-center\">\r\n          <span className=\"inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium\">\r\n            <IconLoader className=\"w-4 h-4 animate-spin\" />\r\n            {currentPart === 'hook' && ''}\r\n            {currentPart === 'instruction' && ''}\r\n            {currentPart === 'practice' && ''}\r\n            {currentPart === 'summary' && ''}\r\n          </span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Progress bar */}\r\n      {isStreaming && (\r\n        <div className=\"mt-4 h-1.5 bg-gray-200 rounded-full overflow-hidden\">\r\n          <div className=\"h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full animate-streaming-progress\" />\r\n        </div>\r\n      )}\r\n\r\n      {/* Streamed text preview */}\r\n      {showStreamedText && streamedText && <StreamedText text={streamedText} />}\r\n    </div>\r\n  );\r\n};\r\n\r\n// ============================================================\r\n// COMPACT VERSION\r\n// ============================================================\r\n\r\ninterface StreamingBadgeProps {\r\n  isStreaming: boolean;\r\n  progress: string;\r\n  currentLevel?: string;\r\n}\r\n\r\nexport const StreamingBadge: React.FC<StreamingBadgeProps> = ({\r\n  isStreaming,\r\n  progress,\r\n  currentLevel\r\n}) => {\r\n  if (!isStreaming) return null;\r\n\r\n  const levelColors: Record<string, string> = {\r\n    support: 'from-green-500 to-green-600',\r\n    core: 'from-blue-500 to-blue-600',\r\n    enrichment: 'from-purple-500 to-purple-600'\r\n  };\r\n\r\n  const gradientClass = currentLevel\r\n    ? levelColors[currentLevel] || 'from-blue-500 to-purple-600'\r\n    : 'from-blue-500 to-purple-600';\r\n\r\n  return (\r\n    <div className={`\r\n      inline-flex items-center gap-2 px-3 py-1.5\r\n      bg-gradient-to-r ${gradientClass}\r\n      text-white text-sm font-medium rounded-full\r\n      shadow-lg\r\n    `}>\r\n      <IconLoader className=\"w-4 h-4 animate-spin\" />\r\n      <span>{progress || '...'}</span>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default StreamingProgress;\r\n","import React, { useState } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport type { Course, Module, LearningUnit } from '../shared/types/courseTypes';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport {\r\n    IconPlus, IconEdit, IconTrash, IconArrowUp, IconArrowDown,\r\n    IconRobot, IconEye, IconShare, IconPlayerPlay, IconBook,\r\n    IconClock, IconChat, IconJoystick, IconFlag, IconSparkles,\r\n    IconArrowRight\r\n} from '../icons';\r\n// import { useCourseStore } from '../context/CourseContext'; // Remove unused import if not needed\r\nimport { ShareModal } from './ShareModal';\r\nimport TeacherCockpit from './TeacherCockpit'; // Import Cockpit\r\n\r\ninterface LessonPlanOverviewProps {\r\n    course: Course;\r\n    onUpdateCourse: (updatedCourse: Course) => void;\r\n    onSelectUnit: (unitId: string) => void;\r\n    onUnitUpdate?: (unit: LearningUnit) => void;\r\n    onGenerateWithAI?: (type: 'unit' | 'module', id: string, instruction?: string) => void;\r\n    onBack?: () => void;\r\n}\r\n\r\nexport const LessonPlanOverview: React.FC<LessonPlanOverviewProps> = ({\r\n    course,\r\n    onUpdateCourse,\r\n    onSelectUnit,\r\n    onUnitUpdate,\r\n    onGenerateWithAI,\r\n    onBack\r\n}) => {\r\n    const navigate = useNavigate();\r\n\r\n    // Local state for inline accordion expansion\r\n    const [expandedUnits, setExpandedUnits] = useState<Set<string>>(new Set());\r\n\r\n    // Presentation/View mode state\r\n    const [viewingUnit, setViewingUnit] = useState<LearningUnit | null>(null);\r\n\r\n    const toggleUnitExpansion = (unitId: string) => {\r\n        const newSet = new Set(expandedUnits);\r\n        if (newSet.has(unitId)) {\r\n            newSet.delete(unitId);\r\n        } else {\r\n            newSet.add(unitId);\r\n        }\r\n        setExpandedUnits(newSet);\r\n    };\r\n\r\n    const handleBlockUpdateInUnit = (unit: LearningUnit, blockId: string, newContent: any) => {\r\n        if (!onUnitUpdate) return;\r\n\r\n        const updatedBlocks = unit.activityBlocks?.map(b =>\r\n            b.id === blockId ? { ...b, content: newContent } : b\r\n        ) || [];\r\n\r\n        const updatedUnit = { ...unit, activityBlocks: updatedBlocks };\r\n        onUnitUpdate(updatedUnit);\r\n    };\r\n\r\n    // --- Actions ---\r\n\r\n    const handleAddModule = () => {\r\n        const newModule: Module = {\r\n            id: uuidv4(),\r\n            title: `New Phase ${course.syllabus.length + 1}`,\r\n            learningUnits: []\r\n        };\r\n        const updatedCourse = { ...course, syllabus: [...course.syllabus, newModule] };\r\n        onUpdateCourse(updatedCourse);\r\n    };\r\n\r\n    const handleDeleteModule = (moduleId: string) => {\r\n        if (!confirm('Are you sure you want to delete this phase and all its units?')) return;\r\n        const updatedSyllabus = course.syllabus.filter(m => m.id !== moduleId);\r\n        onUpdateCourse({ ...course, syllabus: updatedSyllabus });\r\n    };\r\n\r\n    const handleMoveModule = (index: number, direction: 'up' | 'down') => {\r\n        const newSyllabus = [...course.syllabus];\r\n        if (direction === 'up' && index > 0) {\r\n            [newSyllabus[index - 1], newSyllabus[index]] = [newSyllabus[index], newSyllabus[index - 1]];\r\n        } else if (direction === 'down' && index < newSyllabus.length - 1) {\r\n            [newSyllabus[index + 1], newSyllabus[index]] = [newSyllabus[index], newSyllabus[index + 1]];\r\n        }\r\n        onUpdateCourse({ ...course, syllabus: newSyllabus });\r\n    };\r\n\r\n    const handleAddUnit = (moduleId: string) => {\r\n        const newUnit: LearningUnit = {\r\n            id: uuidv4(),\r\n            title: 'New Activity',\r\n            type: 'practice',\r\n            baseContent: '',\r\n            activityBlocks: []\r\n        };\r\n\r\n        const updatedSyllabus = course.syllabus.map(m => {\r\n            if (m.id === moduleId) {\r\n                return { ...m, learningUnits: [...m.learningUnits, newUnit] };\r\n            }\r\n            return m;\r\n        });\r\n\r\n        onUpdateCourse({ ...course, syllabus: updatedSyllabus });\r\n    };\r\n\r\n    const handleDeleteUnit = (moduleId: string, unitId: string) => {\r\n        if (!confirm('Delete this activity?')) return;\r\n        const updatedSyllabus = course.syllabus.map(m => {\r\n            if (m.id === moduleId) {\r\n                return { ...m, learningUnits: m.learningUnits.filter(u => u.id !== unitId) };\r\n            }\r\n            return m;\r\n        });\r\n        onUpdateCourse({ ...course, syllabus: updatedSyllabus });\r\n    };\r\n\r\n    const handleMoveUnit = (moduleId: string, unitIndex: number, direction: 'up' | 'down') => {\r\n        const updatedSyllabus = course.syllabus.map(m => {\r\n            if (m.id === moduleId) {\r\n                const newUnits = [...m.learningUnits];\r\n                if (direction === 'up' && unitIndex > 0) {\r\n                    [newUnits[unitIndex - 1], newUnits[unitIndex]] = [newUnits[unitIndex], newUnits[unitIndex - 1]];\r\n                } else if (direction === 'down' && unitIndex < newUnits.length - 1) {\r\n                    [newUnits[unitIndex + 1], newUnits[unitIndex]] = [newUnits[unitIndex], newUnits[unitIndex + 1]];\r\n                }\r\n                return { ...m, learningUnits: newUnits };\r\n            }\r\n            return m;\r\n        });\r\n        onUpdateCourse({ ...course, syllabus: updatedSyllabus });\r\n    };\r\n\r\n    const [shareOptions, setShareOptions] = useState<{\r\n        courseTitle: string;\r\n        courseId: string;\r\n        unitId?: string;\r\n        unitTitle?: string;\r\n        initialTab?: 'link' | 'assign' | 'classroom' | 'collab';\r\n    } | null>(null);\r\n\r\n    // --- Toolbar Actions ---\r\n    const handleShare = (unitId?: string, unitTitle?: string, initialTab: 'link' | 'assign' | 'classroom' | 'collab' = 'assign') => {\r\n        setShareOptions({\r\n            courseTitle: course.title,\r\n            courseId: course.id,\r\n            unitId,\r\n            unitTitle,\r\n            initialTab\r\n        });\r\n    };\r\n\r\n    // Get all units in order for presentation mode\r\n    const getAllUnitsInOrder = (): LearningUnit[] => {\r\n        return course.syllabus.flatMap(module => module.learningUnits);\r\n    };\r\n\r\n    const handlePreview = (unit?: LearningUnit) => {\r\n        // If specific unit passed, view that unit\r\n        // Otherwise, view the first unit in presentation mode\r\n        if (unit) {\r\n            setViewingUnit(unit);\r\n        } else {\r\n            const allUnits = getAllUnitsInOrder();\r\n            if (allUnits.length > 0) {\r\n                setViewingUnit(allUnits[0]);\r\n            }\r\n        }\r\n    };\r\n\r\n    // Navigate to next/previous unit in presentation mode\r\n    const handleNextUnit = () => {\r\n        if (!viewingUnit) return;\r\n        const allUnits = getAllUnitsInOrder();\r\n        const currentIndex = allUnits.findIndex(u => u.id === viewingUnit.id);\r\n        if (currentIndex < allUnits.length - 1) {\r\n            setViewingUnit(allUnits[currentIndex + 1]);\r\n        }\r\n    };\r\n\r\n    const handlePrevUnit = () => {\r\n        if (!viewingUnit) return;\r\n        const allUnits = getAllUnitsInOrder();\r\n        const currentIndex = allUnits.findIndex(u => u.id === viewingUnit.id);\r\n        if (currentIndex > 0) {\r\n            setViewingUnit(allUnits[currentIndex - 1]);\r\n        }\r\n    };\r\n\r\n\r\n\r\n    // --- Teacher Cockpit Helpers ---\r\n    const getPhaseIcon = (index: number, total: number) => {\r\n        // Specific mapping based on User Spec\r\n        // Phase 1: Opening (Clock)\r\n        // Phase 2: Teaching (Speech)\r\n        // Phase 3: Practice (Joystick)\r\n        // Phase 4: Summary (Flag)\r\n\r\n        // If we have more or fewer, we adapt best effort\r\n        if (index === 0) return <IconClock className=\"w-6 h-6 text-indigo-600\" />;\r\n        if (index === total - 1) return <IconFlag className=\"w-6 h-6 text-red-600\" />;\r\n\r\n        // Middle items\r\n        if (index === 1) return <IconChat className=\"w-6 h-6 text-blue-600\" />;\r\n        return <IconJoystick className=\"w-6 h-6 text-purple-600\" />;\r\n    };\r\n\r\n    return (\r\n        <div className=\"p-4 md:p-8 max-w-5xl mx-auto h-full overflow-y-auto custom-scrollbar print:p-0 print:overflow-visible\" dir=\"rtl\">\r\n            {/* Header */}\r\n            <header className=\"sticky top-4 z-40 card-glass p-6 mb-8 print:mb-4 print:static print:shadow-none print:bg-white\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-4\">\r\n                        {/* Back Button */}\r\n                        <button\r\n                            onClick={() => {\r\n                                console.log(' LessonPlanOverview back clicked, onBack:', typeof onBack);\r\n                                if (onBack) {\r\n                                    console.log(' Calling onBack...');\r\n                                    onBack();\r\n                                } else {\r\n                                    console.log(' No onBack, reloading to home...');\r\n                                    window.location.href = '/';\r\n                                }\r\n                            }}\r\n                            className=\"flex items-center justify-center w-10 h-10 rounded-full bg-white/80 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 text-gray-600 hover:text-blue-600 transition-all shadow-sm print:hidden\"\r\n                            title=\"  \"\r\n                        >\r\n                            <IconArrowRight className=\"w-5 h-5\" />\r\n                        </button>\r\n                        <div>\r\n                            <h1 className=\"text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 print:text-black\">\r\n                                {course.title || \"   \"}\r\n                            </h1>\r\n                            <div className=\"flex gap-4 mt-2 text-gray-500 font-medium print:text-sm\">\r\n                                <span className=\"px-3 py-1 bg-white/60 backdrop-blur-sm rounded-full text-sm border border-white/40 shadow-sm print:border print:border-gray-300\">\r\n                                    {course.gradeLevel || \"  \"}\r\n                                </span>\r\n                                <span className=\"px-3 py-1 bg-white/60 backdrop-blur-sm rounded-full text-sm border border-white/40 shadow-sm print:border print:border-gray-300\">\r\n                                    {course.subject || \"\"}\r\n                                </span>\r\n                                {(course.mode === 'lesson' || course.wizardData?.settings?.productType === 'lesson') && <span className=\"px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-sm print:hidden\"> </span>}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Toolbar Actions */}\r\n                    <div className=\"flex items-center gap-3 print:hidden\">\r\n                        <button\r\n                            onClick={() => handlePreview()}\r\n                            className=\"flex items-center gap-2 px-3 py-2 text-gray-600 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors shadow-sm border border-white/60 bg-white/50\"\r\n                            title=\"  -    \"\r\n                        >\r\n                            <IconEye className=\"w-[22px] h-[22px]\" />\r\n                            <span className=\"text-sm font-medium hidden md:inline\"></span>\r\n                        </button>\r\n                        <button\r\n                            onClick={() => handleShare(undefined, undefined, 'collab')}\r\n                            className=\"p-2 text-gray-600 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors shadow-sm border border-white/60 bg-white/50\"\r\n                            title=\"  \"\r\n                        >\r\n                            <IconShare className=\"w-[22px] h-[22px]\" />\r\n                        </button>\r\n\r\n                        <div className=\"h-6 w-px bg-gray-200 mx-2\" />\r\n\r\n                        {/* Course Level AI Actions */}\r\n                        <button\r\n                            onClick={() => onGenerateWithAI?.('module', 'course', 'Expand entire syllabus')}\r\n                            className=\"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-100 to-purple-100 text-purple-700 rounded-xl hover:from-violet-200 hover:to-purple-200 border border-purple-200 shadow-sm transition-colors\"\r\n                        >\r\n                            <IconRobot className=\"w-5 h-5\" />\r\n                            <span> AI</span>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </header>\r\n\r\n            {/* Timeline / Modules */}\r\n            <div className=\"space-y-6 relative print:space-y-4\">\r\n                {/* Vertical Line for Timeline Effect (Hidden in Print) */}\r\n                <div className=\"absolute right-6 top-4 bottom-4 w-0.5 bg-gray-200 -z-10 print:hidden\" />\r\n\r\n                {course.syllabus.map((module, mIndex) => (\r\n                    <div key={module.id} className=\"relative pr-4 md:pr-14 group print:pr-0\">\r\n                        {/* Timeline Icon (Replaces Dot) */}\r\n                        <div className=\"absolute right-3 top-6 w-10 h-10 rounded-full bg-white/80 backdrop-blur-sm border-2 border-blue-200 z-10 shadow-md flex items-center justify-center print:hidden\">\r\n                            {getPhaseIcon(mIndex, course.syllabus.length)}\r\n                        </div>\r\n\r\n                        <div className=\"card-glass hover:shadow-lg transition-all p-6 relative overflow-hidden print:shadow-none print:border-gray-300 print:break-inside-avoid print:bg-white\">\r\n                            {/* Glassmorphism Background Accent (Hidden in Print) */}\r\n                            <div className=\"absolute top-0 left-0 w-64 h-64 bg-gradient-to-br from-blue-50 to-transparent opacity-50 rounded-br-full -z-0 pointer-events-none print:hidden\" />\r\n\r\n                            {/* Module Header */}\r\n                            <div className=\"flex items-center justify-between mb-4 relative z-10\">\r\n                                <div className=\"flex items-center gap-3\">\r\n                                    <h2 className=\"text-xl font-bold text-gray-800\">\r\n                                        {module.title}\r\n                                    </h2>\r\n                                    <button className=\"text-gray-400 hover:text-blue-600 transition-colors print:hidden p-1 hover:bg-blue-50 rounded shadow-sm border border-white/60 bg-white/50\">\r\n                                        <IconEdit className=\"w-4 h-4\" />\r\n                                    </button>\r\n                                </div>\r\n\r\n                                <div className=\"flex items-center gap-2 print:hidden\">\r\n                                    {onGenerateWithAI && (\r\n                                        <button\r\n                                            onClick={() => onGenerateWithAI('module', module.id)}\r\n                                            className=\"flex items-center gap-1 px-2 py-1 text-xs text-purple-600 bg-gradient-to-r from-violet-50 to-purple-50 rounded-lg hover:from-violet-100 hover:to-purple-100 border border-purple-100 shadow-sm\"\r\n                                            title=\"   AI\"\r\n                                        >\r\n                                            <IconRobot className=\"w-3.5 h-3.5\" /> AI \r\n                                        </button>\r\n                                    )}\r\n                                    <div className=\"h-4 w-px bg-gray-300 mx-1\" />\r\n                                    <button onClick={() => handleMoveModule(mIndex, 'up')} disabled={mIndex === 0} className=\"p-1 hover:bg-blue-50 hover:text-blue-600 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm\">\r\n                                        <IconArrowUp className=\"w-4 h-4\" />\r\n                                    </button>\r\n                                    <button onClick={() => handleMoveModule(mIndex, 'down')} disabled={mIndex === course.syllabus.length - 1} className=\"p-1 hover:bg-blue-50 hover:text-blue-600 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm\">\r\n                                        <IconArrowDown className=\"w-4 h-4\" />\r\n                                    </button>\r\n                                    <button onClick={() => handleDeleteModule(module.id)} className=\"p-1 text-red-500 hover:bg-red-50 rounded ml-2 bg-white/50 border border-white/60 shadow-sm\">\r\n                                        <IconTrash className=\"w-4 h-4\" />\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Units List */}\r\n                            <div className=\"space-y-3 relative z-10\">\r\n                                {module.learningUnits.length === 0 ? (\r\n                                    <div className=\"text-center py-6 border-2 border-dashed border-blue-100 rounded-xl bg-blue-50/30 backdrop-blur-sm print:hidden\">\r\n                                        <p className=\"text-gray-400 text-sm mb-2\">    .</p>\r\n                                        <button\r\n                                            onClick={() => handleAddUnit(module.id)}\r\n                                            className=\"text-blue-600 text-sm hover:underline font-medium\"\r\n                                        >\r\n                                            +  \r\n                                        </button>\r\n                                    </div>\r\n                                ) : (\r\n                                    module.learningUnits.map((unit, uIndex) => {\r\n                                        // DEBUG LOG\r\n                                        console.log(`[LPO Render] Unit: ${unit.title} (${unit.id}) | Status: ${unit.metadata?.status} | Blocks: ${unit.activityBlocks?.length}`);\r\n\r\n                                        const isBuilding = unit.metadata?.status === 'generating' || unit.metadata?.status === 'pending' || (unit.activityBlocks?.length === 0 && unit.baseContent === \"PENDING_GENERATION\");\r\n\r\n                                        if (isBuilding) {\r\n                                            return (\r\n                                                <div key={unit.id} className=\"p-4 bg-white rounded-xl border border-indigo-100 shadow-sm relative overflow-hidden\">\r\n                                                    <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-indigo-50/50 to-transparent w-full animate-shimmer\" style={{ backgroundSize: '200% 100%' }}></div>\r\n                                                    <div className=\"flex items-center gap-4 relative z-10\">\r\n                                                        <div className=\"w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-400\">\r\n                                                            <IconSparkles className=\"w-5 h-5 animate-pulse\" />\r\n                                                        </div>\r\n                                                        <div className=\"flex-1 space-y-2\">\r\n                                                            <div className=\"h-5 bg-slate-100 rounded-md w-1/3 animate-pulse\"></div>\r\n                                                            <div className=\"h-3 bg-slate-50 rounded-md w-1/4 animate-pulse\"></div>\r\n                                                        </div>\r\n                                                        <div className=\"px-3 py-1 bg-indigo-50 text-indigo-600 text-xs font-bold rounded-full animate-pulse\">\r\n                                                            {unit.title || \" ...\"}\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n                                            );\r\n                                        }\r\n\r\n                                        const isExpanded = expandedUnits.has(unit.id);\r\n\r\n                                        return (\r\n                                            <div\r\n                                                key={unit.id}\r\n                                                className={`flex flex-col rounded-xl border transition-all group/unit\r\n                                                    ${isExpanded ? 'card-glass border-blue-200 shadow-lg ring-2 ring-blue-50/50' : 'bg-white/60 border-white/60 backdrop-blur-sm hover:bg-white/80 hover:border-blue-200 shadow-sm'}\r\n                                                `}\r\n                                            >\r\n                                                {/* Unit Header (Click to Expand) */}\r\n                                                <div\r\n                                                    className=\"flex flex-col md:flex-row items-start md:items-center justify-between p-4 cursor-pointer\"\r\n                                                    onClick={() => toggleUnitExpansion(unit.id)}\r\n                                                >\r\n                                                    <div className=\"flex items-center gap-4\">\r\n                                                        <div className={`\r\n                                                            w-10 h-10 rounded-lg flex items-center justify-center transition-colors\r\n                                                            ${unit.type === 'test' ? 'bg-red-100 text-red-600' :\r\n                                                                unit.type === 'acquisition' ? 'bg-green-100 text-green-600' :\r\n                                                                    isExpanded ? 'bg-indigo-600 text-white' : 'bg-blue-100 text-blue-600'}\r\n                                                        `}>\r\n                                                            {unit.type === 'test' ? <IconBook className=\"w-5 h-5\" /> : <IconPlayerPlay className=\"w-5 h-5\" />}\r\n                                                        </div>\r\n                                                        <div>\r\n                                                            <h3 className={`font-semibold ${isExpanded ? 'text-indigo-900' : 'text-gray-800'}`}>{unit.title}</h3>\r\n                                                            <p className=\"text-xs text-gray-500 capitalize flex items-center gap-2\">\r\n                                                                <span>{unit.activityBlocks?.length || 0} </span>\r\n                                                                <span className=\"w-1 h-1 rounded-full bg-gray-300\"></span>\r\n                                                                <span>{unit.type === 'practice' ? '' : unit.type === 'test' ? '' : ''}</span>\r\n                                                            </p>\r\n                                                        </div>\r\n                                                    </div>\r\n\r\n                                                    <div className=\"flex items-center gap-2 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end print:hidden\">\r\n                                                        <div className=\"flex items-center gap-1 mx-2\">\r\n                                                            <button\r\n                                                                onClick={(e) => { e.stopPropagation(); handleMoveUnit(module.id, uIndex, 'up'); }}\r\n                                                                disabled={uIndex === 0}\r\n                                                                className=\"p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm\"\r\n                                                            >\r\n                                                                <IconArrowUp className=\"w-4 h-4\" />\r\n                                                            </button>\r\n                                                            <button\r\n                                                                onClick={(e) => { e.stopPropagation(); handleMoveUnit(module.id, uIndex, 'down'); }}\r\n                                                                disabled={uIndex === module.learningUnits.length - 1}\r\n                                                                className=\"p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm\"\r\n                                                            >\r\n                                                                <IconArrowDown className=\"w-4 h-4\" />\r\n                                                            </button>\r\n                                                        </div>\r\n\r\n                                                        <button\r\n                                                            onClick={(e) => { e.stopPropagation(); handlePreview(unit); }}\r\n                                                            className=\"p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors bg-white/50 border border-white/60 shadow-sm\"\r\n                                                            title=\" \"\r\n                                                        >\r\n                                                            <IconEye className=\"w-[18px] h-[18px]\" />\r\n                                                        </button>\r\n\r\n                                                        <button\r\n                                                            onClick={(e) => { e.stopPropagation(); handleDeleteUnit(module.id, unit.id); }}\r\n                                                            className=\"p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors bg-white/50 border border-white/60 shadow-sm\"\r\n                                                            title=\" \"\r\n                                                        >\r\n                                                            <IconTrash className=\"w-[18px] h-[18px]\" />\r\n                                                        </button>\r\n\r\n                                                        <div className={`transform transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`}>\r\n                                                            <IconArrowDown className=\"w-5 h-5 text-gray-400\" />\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n\r\n                                                {/* Inline Editor (Accordion Body) */}\r\n                                                {isExpanded && (\r\n                                                    <div className=\"border-t border-blue-100\" onClick={(e) => e.stopPropagation()}>\r\n                                                        <TeacherCockpit\r\n                                                            unit={unit}\r\n                                                            courseId={course.id}\r\n                                                            embedded={true}\r\n                                                            onExit={() => toggleUnitExpansion(unit.id)}\r\n                                                            onUnitUpdate={onUnitUpdate}\r\n                                                            onUpdateBlock={(blockId, content) => handleBlockUpdateInUnit(unit, blockId, content)}\r\n                                                        // onEdit removed to prevent redundant \"Advanced Settings\" button\r\n                                                        />\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        );\r\n                                    })\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Add Unit Bottom Action */}\r\n                            <div className=\"mt-4 pt-4 border-t border-blue-50 flex justify-center print:hidden\">\r\n                                <button\r\n                                    onClick={() => handleAddUnit(module.id)}\r\n                                    className=\"flex items-center gap-2 text-sm text-blue-500 hover:text-blue-600 transition-colors px-4 py-1.5 rounded-full hover:bg-blue-50 bg-white/50 border border-white/60 shadow-sm\"\r\n                                >\r\n                                    <IconPlus className=\"w-3.5 h-3.5\" />   \r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n\r\n                {/* Add Phase Main Button */}\r\n                <div className=\"pr-4 md:pr-14 print:hidden\">\r\n                    <button\r\n                        onClick={handleAddModule}\r\n                        className=\"w-full py-4 border-2 border-dashed border-blue-200 rounded-2xl text-blue-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50/50 backdrop-blur-sm bg-white/40 transition-all flex items-center justify-center gap-2 group\"\r\n                    >\r\n                        <div className=\"w-8 h-8 rounded-full bg-blue-50 group-hover:bg-blue-100 flex items-center justify-center transition-colors shadow-sm\">\r\n                            <IconPlus className=\"w-[18px] h-[18px]\" />\r\n                        </div>\r\n                        <span className=\"font-semibold\">  </span>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"h-20\" /> {/* Bottom spacer */}\r\n\r\n            <ShareModal\r\n                isOpen={shareOptions !== null}\r\n                onClose={() => setShareOptions(null)}\r\n                courseId={course.id}\r\n                courseTitle={course.title}\r\n                unitId={shareOptions?.unitId}\r\n                unitTitle={shareOptions?.unitTitle}\r\n                initialTab={shareOptions?.initialTab}\r\n            />\r\n\r\n            {/* Presentation/View Mode - TeacherCockpit Full Screen */}\r\n            {viewingUnit && (\r\n                <TeacherCockpit\r\n                    unit={viewingUnit}\r\n                    courseId={course.id}\r\n                    embedded={false}\r\n                    onExit={() => setViewingUnit(null)}\r\n                    onUnitUpdate={(updatedUnit) => {\r\n                        // Update the unit in the course\r\n                        if (onUnitUpdate) {\r\n                            onUnitUpdate(updatedUnit);\r\n                        }\r\n                        // Also update local state to reflect changes\r\n                        setViewingUnit(updatedUnit);\r\n                    }}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n","import React, { useState, useEffect, useRef } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { useCourseStore } from '../context/CourseContext';\r\nimport * as pdfjsLib from 'pdfjs-dist';\r\nimport CoursePlayer from './CoursePlayer';\r\nimport UnitEditor from './UnitEditor';\r\nimport TeacherCockpit from './TeacherCockpit';\r\nimport { IconEye, IconX } from '../icons';\r\nimport { AIStarsSpinner } from './ui/Loading/AIStarsSpinner';\r\nimport { TypewriterLoaderInline } from './ui/Loading/TypewriterLoader';\r\nimport IngestionWizard from './IngestionWizard';\r\nimport { generateCoursePlan, generateFullUnitContent, generateFullUnitContentWithVariants, generateCourseSyllabus, generateUnitSkeleton, generateStepContent, generatePodcastScript, generateTeacherStepContent, generateLessonVisuals, generateInteractiveBlocks, generateLessonPart1, generateLessonPart2, generateTeacherLessonParallel, extractTopicFromText } from '../gemini';\r\nimport { useStreamingGeneration } from '../hooks/useStreamingGeneration';\r\nimport { StreamingProgress, StreamingBadge } from './StreamingProgress';\r\nimport { isStreamingSupported } from '../services/streamingService';\r\n// import { generateUnitSkeleton, generateStepContent, generatePodcastScript } from '../services/ai/geminiApi';\r\nimport { mapSystemItemToBlock } from '../shared/utils/geminiParsers';\r\nimport { doc, updateDoc } from 'firebase/firestore';\r\nimport { db } from '../firebase'; // Keep db for direct doc updates if needed\r\nimport { saveCourseToFirestore, saveCourseToFirestoreImmediate, saveUnitToFirestore } from '../firebaseUtils';\r\nimport type { LearningUnit, ActivityBlock, Module } from '../shared/types/courseTypes';\r\nimport { activityTimer } from '../utils/monitoring';\r\n\r\n//  -Worker  PDF.js (  Vite)\r\npdfjsLib.GlobalWorkerOptions.workerSrc = new URL(\r\n    'pdfjs-dist/build/pdf.worker.min.mjs',\r\n    import.meta.url\r\n).toString();\r\n\r\nconst fileToBase64 = (file: File): Promise<{ base64: string, mimeType: string }> => {\r\n    return new Promise((resolve, reject) => {\r\n        const reader = new FileReader();\r\n        reader.readAsDataURL(file);\r\n        reader.onload = () => {\r\n            const result = reader.result as string;\r\n            const base64 = result.split(',')[1];\r\n            resolve({ base64, mimeType: file.type });\r\n        };\r\n        reader.onerror = error => reject(error);\r\n    });\r\n};\r\n\r\nconst extractTextFromPDF = async (file: File): Promise<string> => {\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;\r\n    let fullText = \"\";\r\n    const maxPages = Math.min(pdf.numPages, 5);\r\n    for (let i = 1; i <= maxPages; i++) {\r\n        const page = await pdf.getPage(i);\r\n        const textContent = await page.getTextContent();\r\n        const pageText = textContent.items.map((item: any) => item.str).join(' ');\r\n        fullText += `--- Page ${i} ---\\n${pageText}\\n\\n`;\r\n    }\r\n    return fullText;\r\n};\r\n\r\n/**\r\n *  PROGRESSIVE LOADING: Creates skeleton blocks for immediate display\r\n * Shows the lesson structure immediately while content loads in the background\r\n * Enhanced with clear visual feedback for the teacher\r\n */\r\nconst createLessonSkeletonBlocks = (lessonTitle: string): ActivityBlock[] => {\r\n    const skeletonStyle = `\r\n        <style>\r\n            @keyframes shimmer {\r\n                0% { background-position: -200% 0; }\r\n                100% { background-position: 200% 0; }\r\n            }\r\n            @keyframes pulse-glow {\r\n                0%, 100% { box-shadow: 0 0 8px rgba(99, 102, 241, 0.4); }\r\n                50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.7); }\r\n            }\r\n            @keyframes float {\r\n                0%, 100% { transform: translateY(0); }\r\n                50% { transform: translateY(-3px); }\r\n            }\r\n            @keyframes progress-flow {\r\n                0% { background-position: 0% 50%; }\r\n                100% { background-position: 200% 50%; }\r\n            }\r\n            .skeleton-loading {\r\n                background: linear-gradient(90deg, #e5e7eb 25%, #d1d5db 50%, #e5e7eb 75%);\r\n                background-size: 200% 100%;\r\n                animation: shimmer 1.5s ease-in-out infinite;\r\n                border-radius: 8px;\r\n            }\r\n            .skeleton-line {\r\n                height: 14px;\r\n                margin: 10px 0;\r\n            }\r\n            .skeleton-paragraph {\r\n                height: 50px;\r\n            }\r\n            .building-container {\r\n                background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);\r\n                border: 2px solid #c7d2fe;\r\n                border-radius: 16px;\r\n                padding: 20px;\r\n                margin: 12px 0;\r\n                position: relative;\r\n                overflow: hidden;\r\n            }\r\n            .building-container::before {\r\n                content: '';\r\n                position: absolute;\r\n                top: 0;\r\n                left: 0;\r\n                right: 0;\r\n                height: 4px;\r\n                background: linear-gradient(90deg, #818cf8, #6366f1, #4f46e5, #6366f1, #818cf8);\r\n                background-size: 200% 100%;\r\n                animation: progress-flow 2s linear infinite;\r\n            }\r\n            .building-header {\r\n                display: flex;\r\n                align-items: center;\r\n                gap: 12px;\r\n                margin-bottom: 16px;\r\n            }\r\n            .building-icon {\r\n                width: 48px;\r\n                height: 48px;\r\n                background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);\r\n                border-radius: 12px;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                animation: float 2s ease-in-out infinite;\r\n                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);\r\n            }\r\n            .building-icon svg {\r\n                width: 24px;\r\n                height: 24px;\r\n                color: white;\r\n            }\r\n            .building-text {\r\n                flex: 1;\r\n            }\r\n            .building-title {\r\n                font-size: 18px;\r\n                font-weight: 700;\r\n                color: #3730a3;\r\n                margin: 0 0 4px 0;\r\n            }\r\n            .building-subtitle {\r\n                font-size: 14px;\r\n                color: #6366f1;\r\n                margin: 0;\r\n            }\r\n            .building-badge {\r\n                display: inline-flex;\r\n                align-items: center;\r\n                gap: 8px;\r\n                background: white;\r\n                border: 2px solid #a5b4fc;\r\n                border-radius: 24px;\r\n                padding: 8px 16px;\r\n                font-size: 14px;\r\n                font-weight: 600;\r\n                color: #4f46e5;\r\n                animation: pulse-glow 2s ease-in-out infinite;\r\n            }\r\n            .building-badge .spinner {\r\n                width: 16px;\r\n                height: 16px;\r\n                border: 3px solid #c7d2fe;\r\n                border-top-color: #4f46e5;\r\n                border-radius: 50%;\r\n                animation: spin 0.8s linear infinite;\r\n            }\r\n            @keyframes spin {\r\n                to { transform: rotate(360deg); }\r\n            }\r\n            .section-preview {\r\n                display: flex;\r\n                gap: 8px;\r\n                flex-wrap: wrap;\r\n                margin-top: 12px;\r\n            }\r\n            .preview-chip {\r\n                background: white;\r\n                border: 1px solid #e0e7ff;\r\n                border-radius: 8px;\r\n                padding: 6px 12px;\r\n                font-size: 12px;\r\n                color: #6b7280;\r\n            }\r\n        </style>\r\n    `;\r\n\r\n    const buildingIcon = `<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z\" /></svg>`;\r\n\r\n    const magicIcon = `<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z\" /></svg>`;\r\n\r\n    // Main loading block with enhanced visual feedback\r\n    const mainLoadingBlock = `\r\n        <div class=\"building-container\">\r\n            ${skeletonStyle}\r\n            <div class=\"building-header\">\r\n                <div class=\"building-icon\">${magicIcon}</div>\r\n                <div class=\"building-text\">\r\n                    <h3 class=\"building-title\">     </h3>\r\n                    <p class=\"building-subtitle\">     </p>\r\n                </div>\r\n                <div class=\"building-badge\">\r\n                    <div class=\"spinner\"></div>\r\n                      ...\r\n                </div>\r\n            </div>\r\n            <div class=\"section-preview\">\r\n                <span class=\"preview-chip\">  </span>\r\n                <span class=\"preview-chip\">  </span>\r\n                <span class=\"preview-chip\">  </span>\r\n                <span class=\"preview-chip\">  </span>\r\n                <span class=\"preview-chip\"> </span>\r\n                <span class=\"preview-chip\"> </span>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    const buildingBadge = `<div class=\"building-badge\"><div class=\"spinner\"></div>...</div>`;\r\n\r\n    return [\r\n        {\r\n            id: crypto.randomUUID(),\r\n            type: 'text',\r\n            content: mainLoadingBlock,\r\n            metadata: { time: '5 min', bloomLevel: 'remember', isLoading: true, isMainLoader: true }\r\n        },\r\n        {\r\n            id: crypto.randomUUID(),\r\n            type: 'text',\r\n            content: `<div class=\"lesson-section hook\">${skeletonStyle}<h3>  (The Hook)</h3>${buildingBadge}<div class=\"skeleton-loading skeleton-paragraph\"></div><div class=\"skeleton-loading skeleton-line\" style=\"width: 60%;\"></div></div>`,\r\n            metadata: { time: '5 min', bloomLevel: 'remember', isLoading: true }\r\n        },\r\n        {\r\n            id: crypto.randomUUID(),\r\n            type: 'text',\r\n            content: `<div class=\"lesson-section instruction\"><h3>   (Direct Instruction)</h3>${buildingBadge}<div class=\"skeleton-loading skeleton-paragraph\"></div><div class=\"skeleton-loading skeleton-line\" style=\"width: 80%;\"></div><div class=\"skeleton-loading skeleton-line\" style=\"width: 65%;\"></div></div>`,\r\n            metadata: { time: '15 min', bloomLevel: 'understand', isLoading: true }\r\n        },\r\n        {\r\n            id: crypto.randomUUID(),\r\n            type: 'text',\r\n            content: `<div class=\"lesson-section practice\"><h3>   (Guided Practice)</h3>${buildingBadge}<div class=\"skeleton-loading skeleton-paragraph\"></div></div>`,\r\n            metadata: { time: '10 min', bloomLevel: 'apply', isLoading: true }\r\n        },\r\n        {\r\n            id: crypto.randomUUID(),\r\n            type: 'text',\r\n            content: `<div class=\"lesson-section independent-practice\"><h3>   (Independent Practice)</h3>${buildingBadge}<div class=\"skeleton-loading skeleton-paragraph\"></div></div>`,\r\n            metadata: { time: '10 min', bloomLevel: 'apply', isLoading: true }\r\n        },\r\n        {\r\n            id: crypto.randomUUID(),\r\n            type: 'text',\r\n            content: `<div class=\"lesson-section discussion\"><h3>   (Discussion)</h3>${buildingBadge}<div class=\"skeleton-loading skeleton-line\" style=\"width: 85%;\"></div><div class=\"skeleton-loading skeleton-line\" style=\"width: 75%;\"></div></div>`,\r\n            metadata: { time: '5 min', bloomLevel: 'evaluate', isLoading: true }\r\n        },\r\n        {\r\n            id: crypto.randomUUID(),\r\n            type: 'text',\r\n            content: `<div class=\"lesson-section summary\"><h3>  (Summary)</h3>${buildingBadge}<div class=\"skeleton-loading skeleton-line\" style=\"width: 70%;\"></div><div class=\"skeleton-loading\" style=\"height: 120px; margin-top: 12px;\"></div></div>`,\r\n            metadata: { time: '5 min', bloomLevel: 'remember', isLoading: true }\r\n        }\r\n    ];\r\n};\r\n\r\n\r\n// ---    -   (Flex Shell) ---\r\nconst UnitPreviewModal: React.FC<{ unit: any, onClose: () => void }> = ({ unit, onClose }) => {\r\n    //     \r\n    useEffect(() => {\r\n        document.body.style.overflow = 'hidden';\r\n        return () => { document.body.style.overflow = 'unset'; };\r\n    }, []);\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[100] bg-gray-50 h-screen w-full flex flex-col animate-fade-in\" dir=\"rtl\">\r\n            <style>{`\r\n                .preview-scroll::-webkit-scrollbar {\r\n                    width: 16px;\r\n                    display: block; /* Force display */\r\n                }\r\n                .preview-scroll::-webkit-scrollbar-track {\r\n                    background: #f1f1f1;\r\n                    border-left: 1px solid #e5e7eb;\r\n                }\r\n                .preview-scroll::-webkit-scrollbar-thumb {\r\n                    background-color: #9ca3af;\r\n                    border-radius: 4px;\r\n                    border: 3px solid #f1f1f1;\r\n                }\r\n                .preview-scroll::-webkit-scrollbar-thumb:hover {\r\n                    background-color: #6b7280;\r\n                }\r\n            `}</style>\r\n\r\n            {/*   ( ) */}\r\n            <div className=\"relative flex-none h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shadow-sm z-[200]\">\r\n                <h3 className=\"text-gray-900 font-bold text-lg flex items-center gap-2\">\r\n                    <IconEye className=\"w-5 h-5 text-indigo-600\" />\r\n                     : {unit.title}\r\n                </h3>\r\n                <button\r\n                    onClick={onClose}\r\n                    className=\"flex items-center justify-center w-10 h-10 bg-gray-900 hover:bg-black text-white rounded-full transition-transform hover:scale-110 shadow-lg\"\r\n                    title=\" \"\r\n                >\r\n                    <span className=\"font-bold text-lg\">X</span>\r\n                </button>\r\n            </div>\r\n\r\n            {/*   -        */}\r\n            <div className=\"flex-1 w-full overflow-y-scroll preview-scroll bg-gray-50 relative\">\r\n                <div className=\"w-full max-w-5xl mx-auto pb-32 pt-8 px-4 min-h-full\">\r\n                    <CoursePlayer\r\n                        reviewMode={true}\r\n                        studentData={{\r\n                            studentName: \" \",\r\n                            answers: {}\r\n                        }}\r\n                        onExitReview={onClose}\r\n                        forcedUnitId={unit.id}\r\n                        unitOverride={unit} // Inject the specific unit object (saved or unsaved)\r\n                        hideReviewHeader={true}\r\n                    />\r\n                    {/*   */}\r\n                    <div className=\"h-20 w-full\" />\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\n\r\n\r\n\r\nimport { LessonPlanOverview } from './LessonPlanOverview';\r\n\r\n// ... existing imports ...\r\n\r\ninterface CourseEditorProps {\r\n    onBack?: () => void;\r\n}\r\n\r\nconst CourseEditor: React.FC<CourseEditorProps> = ({ onBack }) => {\r\n    const navigate = useNavigate();\r\n    const { course, setCourse } = useCourseStore();\r\n    const [selectedUnitId, setSelectedUnitId] = useState<string | null>(null);\r\n    const [previewUnit, setPreviewUnit] = useState<LearningUnit | null>(null);\r\n    const [showWizard, setShowWizard] = useState(false);\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n    // Loader removed by user request\r\n    // const [showLoader, setShowLoader] = useState(false);\r\n\r\n    //  STREAMING: Hook for real-time content generation\r\n    const {\r\n        state: streamingState,\r\n        startDifferentiatedStreaming,\r\n        startLessonStreaming,\r\n        startPodcastStreaming,\r\n        startActivityStreaming,  // V5: Parallel activity generation\r\n        cancelStreaming,\r\n        resetState: resetStreamingState\r\n    } = useStreamingGeneration();\r\n\r\n    //   \r\n    const [forcedGrade, setForcedGrade] = useState<string>(\"\");\r\n\r\n    const wizardHasRun = useRef(false);\r\n    const hasAutoSelected = useRef(false);\r\n\r\n    // ---    429  ---\r\n    // ---    429  ---\r\n    useEffect(() => {\r\n        //  :        , \r\n        if (wizardHasRun.current || isGenerating) return;\r\n\r\n        //  :       \r\n        if (!course || course.id === 'loading') return;\r\n\r\n        //     \r\n        const hasSyllabus = course.syllabus && course.syllabus.length > 0;\r\n\r\n        // Detect Lesson Mode\r\n        const isLessonMode = course.wizardData?.settings?.productType === 'lesson' || course.mode === 'lesson';\r\n\r\n        // Detect Differentiated Mode (3 levels)\r\n        const isDifferentiatedMode = course.wizardData?.settings?.isDifferentiated === true;\r\n\r\n        //  AUTO-GENERATION TRIGGER FOR FRESH SHELLS\r\n        // If we have a shell syllabus (from App.tsx) but it's empty, AND we have wizard data -> GENERATE!\r\n        const firstUnit = course.syllabus?.[0]?.learningUnits?.[0];\r\n        const isFreshShell = hasSyllabus && firstUnit && (!firstUnit.activityBlocks || firstUnit.activityBlocks.length === 0);\r\n\r\n        if (isFreshShell && course.wizardData && isLessonMode) {\r\n            // console.log(\" Detected Fresh Lesson Shell. Triggering V4 Auto-Generation...\");\r\n            handleWizardComplete(course.wizardData);\r\n            return;\r\n        }\r\n\r\n        //  AUTO-GENERATION TRIGGER FOR DIFFERENTIATED MODE\r\n        // If we have wizard data with isDifferentiated and a fresh shell -> GENERATE 3 UNITS!\r\n        if (isFreshShell && course.wizardData && isDifferentiatedMode) {\r\n            console.log(\" Detected Fresh Shell with Differentiated Mode. Triggering 3-Level Generation...\");\r\n            handleWizardComplete(course.wizardData);\r\n            return;\r\n        }\r\n\r\n        if (hasSyllabus && !hasAutoSelected.current) {\r\n            if (firstUnit && !selectedUnitId) {\r\n                // CRITICAL: Prevent auto-select for Lesson Plans AND Differentiated Mode\r\n                // In differentiated mode, CourseEditor needs to create 3 units first before UnitEditor loads\r\n                if (!isLessonMode && !isDifferentiatedMode) {\r\n                    setSelectedUnitId(firstUnit.id);\r\n                    hasAutoSelected.current = true;\r\n                }\r\n            }\r\n        }\r\n        else if (!hasSyllabus) {\r\n            //    -     \r\n            if (!showWizard && !isGenerating) {\r\n                setShowWizard(true);\r\n            }\r\n        }\r\n    }, [course, showWizard, isGenerating, selectedUnitId]);\r\n\r\n    const handleGenerateWithAI = async (type: 'unit' | 'module', id: string, _instruction?: string) => {\r\n        if (type === 'unit') {\r\n            const unit = course.syllabus.flatMap((m: Module) => m.learningUnits).find((u: LearningUnit) => u.id === id);\r\n            if (!unit) return;\r\n\r\n            // V5 STREAMING: Try streaming first, fallback to legacy\r\n            const useStreaming = isStreamingSupported();\r\n\r\n            if (useStreaming) {\r\n                try {\r\n                    console.log(\" Manual regeneration using V5 streaming...\");\r\n                    await handleStreamingActivityGeneration(\r\n                        unit,\r\n                        course.fullBookContent || '',\r\n                        course.gradeLevel || \"General\",\r\n                        course.activityLength || 'medium',\r\n                        course.wizardData?.settings?.productType || 'activity',\r\n                        course.wizardData?.settings?.questionPreferences\r\n                    );\r\n                    return; // Streaming handles everything\r\n                } catch (streamError) {\r\n                    console.warn(\" Streaming failed, falling back to legacy:\", streamError);\r\n                    // Fall through to legacy code\r\n                }\r\n            }\r\n\r\n            // FALLBACK: Legacy Sequential Flow\r\n            console.log(\" Manual regeneration using legacy flow...\");\r\n\r\n            // 1. Set Generating State\r\n            setCourse((prev: any) => {\r\n                const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                    ...m,\r\n                    learningUnits: m.learningUnits.map((u: LearningUnit) => u.id === id ? { ...u, metadata: { ...u.metadata, status: 'generating' } } : u)\r\n                }));\r\n                return { ...prev, syllabus: newSyllabus };\r\n            });\r\n\r\n            // 2. Generate Content\r\n            try {\r\n                const skeleton = await generateUnitSkeleton(\r\n                    unit.title,\r\n                    course.gradeLevel || \"General\",\r\n                    course.activityLength || 'medium',\r\n                    course.fullBookContent,\r\n                    course.mode === 'lesson' ? 'learning' : course.mode,\r\n                    undefined,\r\n                    course.wizardData?.settings?.productType\r\n                );\r\n\r\n                if (skeleton && skeleton.steps) {\r\n                    const totalSteps = skeleton.steps.length;\r\n                    const stepPromises = skeleton.steps.map(async (step: any) => {\r\n                        const content = await generateStepContent(unit.title, step, course.gradeLevel || \"General\", course.fullBookContent, undefined, 'learning', undefined, totalSteps);\r\n                        return mapSystemItemToBlock(content);\r\n                    });\r\n                    const newBlocksRaw = await Promise.all(stepPromises);\r\n                    let newBlocks = newBlocksRaw.filter((b: any) => b !== null);\r\n\r\n                    if (newBlocks.length === 0) {\r\n                        newBlocks = [{\r\n                            id: crypto.randomUUID(),\r\n                            type: 'text',\r\n                            content: \" **  **\\n\\n       .     -AI     .\\n\\n      '  AI'    .\",\r\n                            metadata: { score: 0, bloomLevel: 'evaluation' }\r\n                        }];\r\n                    }\r\n\r\n                    setCourse((prev: any) => {\r\n                        const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                            ...m,\r\n                            learningUnits: m.learningUnits.map((u: LearningUnit) => u.id === id ? { ...u, activityBlocks: newBlocks, metadata: { ...u.metadata, status: 'ready' } } : u)\r\n                        }));\r\n                        const final = { ...prev, syllabus: newSyllabus };\r\n                        saveCourseToFirestore(final);\r\n                        return final;\r\n                    });\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Manual Gen Error\", e);\r\n                alert(\"Generation failed\");\r\n                setCourse((prev: any) => {\r\n                    const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                        ...m,\r\n                        learningUnits: m.learningUnits.map((u: LearningUnit) => u.id === id ? { ...u, metadata: { ...u.metadata, status: 'error' } } : u)\r\n                    }));\r\n                    return { ...prev, syllabus: newSyllabus };\r\n                });\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     *  V5 STREAMING: Generate student activity using parallel streaming\r\n     * Performance: ~20s vs old sequential ~27s\r\n     * Falls back to legacy flow on error\r\n     */\r\n    const handleStreamingActivityGeneration = async (\r\n        unit: LearningUnit,\r\n        sourceText: string,\r\n        grade: string,\r\n        activityLength: 'short' | 'medium' | 'long',\r\n        productType: string,\r\n        questionPreferences?: any\r\n    ): Promise<ActivityBlock[]> => {\r\n        console.log(\" V5 Streaming: Starting parallel activity generation...\");\r\n\r\n        // 1. Mark unit as generating\r\n        setCourse((prev: any) => {\r\n            if (!prev) return prev;\r\n            const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                ...m,\r\n                learningUnits: m.learningUnits.map((u: LearningUnit) =>\r\n                    u.id === unit.id ? { ...u, metadata: { ...u.metadata, status: 'generating' } } : u\r\n                )\r\n            }));\r\n            return { ...prev, syllabus: newSyllabus };\r\n        });\r\n\r\n        try {\r\n            // 2. Call streaming endpoint (parallel generation)\r\n            const result = await startActivityStreaming(\r\n                {\r\n                    topic: unit.title,\r\n                    gradeLevel: grade,\r\n                    subject: course?.subject || '',\r\n                    sourceText: sourceText || undefined,\r\n                    activityLength: activityLength,\r\n                    productType: productType === 'exam' ? 'exam' : 'activity',\r\n                    questionPreferences: questionPreferences\r\n                },\r\n                // onStepComplete callback - progressive UI updates\r\n                (step, stepNumber, totalSteps) => {\r\n                    console.log(` Step ${stepNumber}/${totalSteps} complete`);\r\n                },\r\n                // onSkeletonComplete callback\r\n                (skeleton) => {\r\n                    console.log(` Skeleton complete: ${skeleton.steps?.length || 0} steps`);\r\n                }\r\n            );\r\n\r\n            // 3. Map steps to UI blocks using existing parser\r\n            const newBlocks = result.steps\r\n                .map((step: any) => mapSystemItemToBlock(step))\r\n                .filter((block: any): block is ActivityBlock => block !== null);\r\n\r\n            // 4. Fallback if mapping failed\r\n            if (newBlocks.length === 0) {\r\n                newBlocks.push({\r\n                    id: crypto.randomUUID(),\r\n                    type: 'text',\r\n                    content: \" **  **\\n\\n    .   .\",\r\n                    metadata: { score: 0, bloomLevel: 'evaluation' }\r\n                });\r\n            }\r\n\r\n            // 5. Save to state and Firestore\r\n            setCourse((prev: any) => {\r\n                if (!prev) return prev;\r\n                const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                    ...m,\r\n                    learningUnits: m.learningUnits.map((u: LearningUnit) =>\r\n                        u.id === unit.id ? { ...u, activityBlocks: newBlocks, metadata: { ...u.metadata, status: 'ready' } } : u\r\n                    )\r\n                }));\r\n                const newCourse = { ...prev, syllabus: newSyllabus };\r\n                saveCourseToFirestore(newCourse);\r\n                return newCourse;\r\n            });\r\n\r\n            console.log(` V5 Streaming: Activity generation complete (${newBlocks.length} blocks)`);\r\n            return newBlocks;\r\n\r\n        } catch (error: any) {\r\n            console.error(\" V5 Streaming failed:\", error);\r\n\r\n            // Mark as error (will trigger fallback in calling code)\r\n            setCourse((prev: any) => {\r\n                if (!prev) return prev;\r\n                const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                    ...m,\r\n                    learningUnits: m.learningUnits.map((u: LearningUnit) =>\r\n                        u.id === unit.id ? { ...u, metadata: { ...u.metadata, status: 'error' } } : u\r\n                    )\r\n                }));\r\n                return { ...prev, syllabus: newSyllabus };\r\n            });\r\n\r\n            throw error; // Re-throw to trigger fallback\r\n        }\r\n    };\r\n\r\n    if (!course) return <div className=\"flex items-center justify-center h-screen text-gray-500\">  ...</div>;\r\n\r\n    const displayGrade = forcedGrade || course.gradeLevel || course.targetAudience || \"\";\r\n\r\n\r\n    // --- Progressive Generation Helper ---\r\n    const processLessonPlanQueue = async (\r\n        initialSyllabus: Module[],\r\n        sourceText: string,\r\n        grade: string,\r\n        activityLength: 'short' | 'medium' | 'long',\r\n        mode: 'learning' | 'exam' | 'lesson',\r\n        taxonomy?: any,\r\n        productType?: any\r\n    ) => {\r\n        // We iterate sequentially to manage rate limits and UX flow\r\n        const flatUnits = initialSyllabus.flatMap(m => m.learningUnits).filter(u => !u.activityBlocks || u.activityBlocks.length === 0);\r\n\r\n        for (const unit of flatUnits) {\r\n            // 1. Mark as Generating\r\n            setCourse((currentCourse: any) => {\r\n                if (!currentCourse) return currentCourse;\r\n                const updatedSyllabus = currentCourse.syllabus.map((m: Module) => ({\r\n                    ...m,\r\n                    learningUnits: m.learningUnits.map((u: LearningUnit) =>\r\n                        u.id === unit.id ? { ...u, metadata: { ...u.metadata, status: 'generating' } } : u\r\n                    )\r\n                }));\r\n                return { ...currentCourse, syllabus: updatedSyllabus };\r\n            });\r\n\r\n            try {\r\n                // === TEACHER LESSON MODE (Master Teacher V2) ===\r\n                if (mode === 'lesson' || productType === 'lesson') {\r\n                    // 1. Determine Source Type\r\n                    let sourceType: 'YOUTUBE' | 'TEXT_FILE' | 'TOPIC_ONLY' = 'TOPIC_ONLY';\r\n                    const wizardData = course?.wizardData;\r\n\r\n                    if (wizardData) {\r\n                        // Check for Youtube (mediaType or transcript marker in text)\r\n                        if (wizardData.mediaType === 'youtube' || (wizardData.pastedText && wizardData.pastedText.includes(\"TRANSCRIPT:\"))) {\r\n                            sourceType = 'YOUTUBE';\r\n                        }\r\n                        // Check for Text File - use pastedText from wizard (not sourceText)\r\n                        // Also check the sourceText parameter passed to this function\r\n                        else if ((wizardData.pastedText && wizardData.pastedText.length > 100) || (sourceText && sourceText.length > 100)) {\r\n                            sourceType = 'TEXT_FILE';\r\n                        }\r\n                    } else if (sourceText && sourceText.length > 100) {\r\n                        // Fallback: if no wizardData but sourceText was passed\r\n                        sourceType = 'TEXT_FILE';\r\n                    }\r\n\r\n                    //  PROGRESSIVE LOADING STEP 1: Show skeleton blocks IMMEDIATELY\r\n                    console.log(\" Progressive Loading: Creating skeleton blocks...\");\r\n                    const skeletonBlocks = createLessonSkeletonBlocks(unit.title);\r\n\r\n                    // Update UI immediately with skeleton\r\n                    setCourse((currentCourse: any) => {\r\n                        if (!currentCourse) return currentCourse;\r\n                        const updatedSyllabus = currentCourse.syllabus.map((m: Module) => ({\r\n                            ...m,\r\n                            learningUnits: m.learningUnits.map((u: LearningUnit) =>\r\n                                u.id === unit.id ? {\r\n                                    ...u,\r\n                                    activityBlocks: skeletonBlocks,\r\n                                    metadata: { ...u.metadata, status: 'loading-content' }\r\n                                } : u\r\n                            )\r\n                        }));\r\n                        return { ...currentCourse, syllabus: updatedSyllabus };\r\n                    });\r\n\r\n                    //  PERFORMANCE OPTIMIZATION: Generate content with PARALLEL API calls\r\n                    // Part 1 (Hook + Direct Instruction) and Part 2 (Practice + Summary) run simultaneously\r\n                    // This reduces total generation time from 8-15s to ~5-7s\r\n                    // Falls back to sequential generation if parallel fails\r\n\r\n                    let lessonPlan = null;\r\n                    let useParallel = true; // Can be toggled for debugging\r\n\r\n                    // Helper to build Part 1 blocks (Hook + Direct Instruction)\r\n                    const buildPart1Blocks = (part1: any): ActivityBlock[] => {\r\n                        const hookBlock: ActivityBlock = {\r\n                            id: crypto.randomUUID(),\r\n                            type: 'text',\r\n                            content: `\r\n                                <div class=\"lesson-section hook\">\r\n                                    <h3>  (The Hook)</h3>\r\n                                    ${part1.lesson_metadata?.learning_objectives ? `\r\n                                        <div class=\"learning-objectives\">\r\n                                            <strong>  :</strong>\r\n                                            <ul>${part1.lesson_metadata.learning_objectives.map((obj: string) => `<li>${obj}</li>`).join('')}</ul>\r\n                                        </div>\r\n                                    ` : ''}\r\n                                    <p class=\"teacher-script\">${part1.hook.script_for_teacher}</p>\r\n                                    ${part1.hook.classroom_management_tip ? `<div class=\"management-tip\"> ${part1.hook.classroom_management_tip}</div>` : ''}\r\n                                    <div class=\"visual-placeholder\">  ...</div>\r\n                                </div>\r\n                            `,\r\n                            metadata: { time: '5 min', bloomLevel: 'remember' }\r\n                        };\r\n\r\n                        const slideBlocks: ActivityBlock[] = part1.direct_instruction.slides.map((slide: any) => ({\r\n                            id: crypto.randomUUID(),\r\n                            type: 'text' as const,\r\n                            content: `\r\n                                <div class=\"lesson-section instruction\">\r\n                                    <h3>  : ${slide.slide_title}</h3>\r\n                                    <div class=\"board-points\">\r\n                                        <strong>  :</strong>\r\n                                        <ul>${slide.bullet_points_for_board.map((p: string) => `<li>${p}</li>`).join('')}</ul>\r\n                                    </div>\r\n                                    <p class=\"teacher-script\"><strong> :</strong> ${slide.script_to_say}</p>\r\n                                    ${slide.differentiation_note ? `<div class=\"diff-note\"> ${slide.differentiation_note}</div>` : ''}\r\n                                </div>\r\n                            `,\r\n                            metadata: { time: slide.timing_estimate || '5 min', bloomLevel: 'understand' }\r\n                        }));\r\n\r\n                        return [hookBlock, ...slideBlocks];\r\n                    };\r\n\r\n                    // Try parallel generation first, fallback to sequential if it fails\r\n                    if (useParallel) {\r\n                        try {\r\n                            console.log(\" Trying parallel generation...\");\r\n                            lessonPlan = await generateTeacherLessonParallel(\r\n                                unit.title,\r\n                                sourceText,\r\n                                grade,\r\n                                sourceType,\r\n                                //  This callback fires when Part1 is ready (~3-4 seconds)\r\n                                (part1) => {\r\n                                    if (!part1) return;\r\n                                    console.log(\" Part1 ready! Updating UI immediately...\");\r\n\r\n                                    const part1Blocks = buildPart1Blocks(part1);\r\n\r\n                                    // Update UI with Part1 content immediately\r\n                                    // Keep skeleton placeholders for Part2 sections\r\n                                    setCourse((currentCourse: any) => {\r\n                                        if (!currentCourse) return currentCourse;\r\n                                        const updatedSyllabus = currentCourse.syllabus.map((m: Module) => ({\r\n                                            ...m,\r\n                                            learningUnits: m.learningUnits.map((u: LearningUnit) =>\r\n                                                u.id === unit.id ? {\r\n                                                    ...u,\r\n                                                    activityBlocks: [\r\n                                                        ...part1Blocks,\r\n                                                        // Keep skeleton placeholders for Part2 sections\r\n                                                        {\r\n                                                            id: crypto.randomUUID(),\r\n                                                            type: 'text',\r\n                                                            content: `<div class=\"lesson-section practice\"><h3>   (Guided Practice)</h3><div class=\"building-badge\"><div class=\"spinner\"></div>...</div></div>`,\r\n                                                            metadata: { time: '10 min', bloomLevel: 'apply', isLoading: true }\r\n                                                        },\r\n                                                        {\r\n                                                            id: crypto.randomUUID(),\r\n                                                            type: 'text',\r\n                                                            content: `<div class=\"lesson-section independent-practice\"><h3>  </h3><div class=\"building-badge\"><div class=\"spinner\"></div>...</div></div>`,\r\n                                                            metadata: { time: '10 min', bloomLevel: 'apply', isLoading: true }\r\n                                                        },\r\n                                                        {\r\n                                                            id: crypto.randomUUID(),\r\n                                                            type: 'text',\r\n                                                            content: `<div class=\"lesson-section summary\"><h3> </h3><div class=\"building-badge\"><div class=\"spinner\"></div>...</div></div>`,\r\n                                                            metadata: { time: '5 min', bloomLevel: 'remember', isLoading: true }\r\n                                                        }\r\n                                                    ],\r\n                                                    metadata: { ...u.metadata, status: 'loading-part2' }\r\n                                                } : u\r\n                                            )\r\n                                        }));\r\n                                        return { ...currentCourse, syllabus: updatedSyllabus };\r\n                                    });\r\n                                }\r\n                            );\r\n                        } catch (parallelError) {\r\n                            console.warn(\" Parallel generation failed, falling back to sequential:\", parallelError);\r\n                            lessonPlan = null;\r\n                        }\r\n                    }\r\n\r\n                    // Fallback to sequential generation if parallel failed or disabled\r\n                    if (!lessonPlan) {\r\n                        console.log(\" Using sequential generation (fallback)...\");\r\n                        lessonPlan = await generateTeacherStepContent(\r\n                            unit.title,\r\n                            sourceText,\r\n                            grade,\r\n                            sourceType,\r\n                            wizardData?.fileData\r\n                        );\r\n                    }\r\n\r\n                    if (lessonPlan) {\r\n                        // 2.5  Generate AI Images ASYNCHRONOUSLY (don't block content display!)\r\n                        // Start visual generation in background - don't await it!\r\n                        const visualPromise = generateLessonVisuals(lessonPlan).then(async (planWithVisuals) => {\r\n                            console.log(\" Visual assets generation completed (background)\");\r\n                            // Update the visual_summary URL in the existing blocks\r\n                            setCourse((currentCourse: any) => {\r\n                                if (!currentCourse?.syllabus) return currentCourse;\r\n                                const updatedSyllabus = currentCourse.syllabus.map((m: Module) => {\r\n                                    if (!m?.learningUnits) return m;\r\n                                    return {\r\n                                        ...m,\r\n                                        learningUnits: m.learningUnits.map((u: LearningUnit) => {\r\n                                            if (!u || u.id !== unit.id) return u;\r\n                                            if (!u.activityBlocks?.length) return u;\r\n                                            // Find and update both Hook and Summary blocks with visual URLs\r\n                                            const updatedBlocks = u.activityBlocks\r\n                                                .filter(block => block !== null)\r\n                                                .map(block => {\r\n                                                    // Update Hook block with curiosity image\r\n                                                    if (block?.type === 'text' && block?.content?.includes('lesson-section hook')) {\r\n                                                        const hookUrl = planWithVisuals.hook?.media_asset?.url;\r\n                                                        if (hookUrl) {\r\n                                                            // Replace the media-badge placeholder with actual image\r\n                                                            let updatedContent = block.content.replace(\r\n                                                                /<div class=\"media-badge\">[^<]*<\\/div>/,\r\n                                                                `<div class=\"generated-visual\"><img src=\"${hookUrl}\" alt=\"Hook Visual\" style=\"max-width: 100%; border-radius: 8px; margin-top: 1rem;\" /></div>`\r\n                                                            );\r\n                                                            // Also handle case where there's a visual-placeholder\r\n                                                            updatedContent = updatedContent.replace(\r\n                                                                '<div class=\"visual-placeholder\">  ...</div>',\r\n                                                                `<div class=\"generated-visual\"><img src=\"${hookUrl}\" alt=\"Hook Visual\" style=\"max-width: 100%; border-radius: 8px; margin-top: 1rem;\" /></div>`\r\n                                                            );\r\n                                                            return { ...block, content: updatedContent };\r\n                                                        }\r\n                                                    }\r\n                                                    // Update Summary block with infographic\r\n                                                    if (block?.type === 'text' && block?.content?.includes('lesson-section summary')) {\r\n                                                        // Inject the visual URL into the summary block\r\n                                                        const visualUrl = planWithVisuals.summary.visual_summary?.url;\r\n                                                        if (visualUrl) {\r\n                                                            const updatedContent = block.content.replace(\r\n                                                                '<div class=\"visual-placeholder\">  ...</div>',\r\n                                                                `<div class=\"generated-visual\"><img src=\"${visualUrl}\" alt=\"Summary Visual\" style=\"max-width: 100%; border-radius: 8px; margin-top: 1rem;\" /></div>`\r\n                                                            );\r\n                                                            return { ...block, content: updatedContent };\r\n                                                        }\r\n                                                    }\r\n                                                    return block;\r\n                                                });\r\n                                            return { ...u, activityBlocks: updatedBlocks };\r\n                                        })\r\n                                    };\r\n                                });\r\n                                return { ...currentCourse, syllabus: updatedSyllabus };\r\n                            });\r\n                        }).catch(e => console.error(\"Background visual generation error:\", e));\r\n\r\n                        console.log(\" Visual generation started in background (not blocking content display)\");\r\n\r\n                        // 2.6 Process Independent Practice Interactive Blocks (NEW!)\r\n                        let independentPracticeBlocks: any[] = [];\r\n                        if (lessonPlan.independent_practice?.interactive_blocks && lessonPlan.independent_practice.interactive_blocks.length > 0) {\r\n                            console.log(\" Processing independent practice interactive blocks...\");\r\n                            // Map the AI-generated blocks to ActivityBlocks format and filter out nulls\r\n                            independentPracticeBlocks = lessonPlan.independent_practice.interactive_blocks\r\n                                .map((block: any) => {\r\n                                    return mapSystemItemToBlock({\r\n                                        type: block.type,\r\n                                        selected_interaction: block.type,\r\n                                        ...block.data\r\n                                    });\r\n                                })\r\n                                .filter((block: any) => block !== null && block !== undefined);\r\n                            console.log(` Processed ${independentPracticeBlocks.length} independent practice blocks`);\r\n                        }\r\n\r\n                        // 3. Map to Blocks (Visual Guide)\r\n                        const newBlocks = [\r\n                            {\r\n                                id: crypto.randomUUID(),\r\n                                type: 'text',\r\n                                content: `\r\n                                    <div class=\"lesson-section hook\">\r\n                                        <h3>  (The Hook)</h3>\r\n                                        ${lessonPlan.lesson_metadata.learning_objectives ? `\r\n                                            <div class=\"learning-objectives\">\r\n                                                <strong>  :</strong>\r\n                                                <ul>${lessonPlan.lesson_metadata.learning_objectives.map(obj => `<li>${obj}</li>`).join('')}</ul>\r\n                                            </div>\r\n                                        ` : ''}\r\n                                        <p class=\"teacher-script\">${lessonPlan.hook.script_for_teacher}</p>\r\n                                        ${lessonPlan.hook.classroom_management_tip ? `<div class=\"management-tip\"> ${lessonPlan.hook.classroom_management_tip}</div>` : ''}\r\n                                        ${lessonPlan.hook.media_asset?.url ? `\r\n                                            <div class=\"generated-visual\">\r\n                                                <img src=\"${lessonPlan.hook.media_asset.url}\" alt=\"Hook Visual\" style=\"max-width: 100%; border-radius: 8px; margin-top: 1rem;\" />\r\n                                            </div>\r\n                                        ` : lessonPlan.hook.media_asset ? `<div class=\"visual-placeholder\">  ...</div>` : ''}\r\n                                    </div>\r\n                                `,\r\n                                metadata: { time: '5 min', bloomLevel: 'remember' }\r\n                            },\r\n                            // DIRECT INSTRUCTION - Each slide as separate block\r\n                            ...lessonPlan.direct_instruction.slides.map((slide, idx) => ({\r\n                                id: crypto.randomUUID(),\r\n                                type: 'text' as const,\r\n                                content: `\r\n                                    <div class=\"lesson-section instruction\">\r\n                                        <h3>  : ${slide.slide_title}</h3>\r\n                                        <div class=\"board-points\">\r\n                                            <strong>  :</strong>\r\n                                            <ul>${slide.bullet_points_for_board.map(p => `<li>${p}</li>`).join('')}</ul>\r\n                                        </div>\r\n                                        <p class=\"teacher-script\"><strong> :</strong> ${slide.script_to_say}</p>\r\n                                        ${slide.differentiation_note ? `<div class=\"diff-note\"> ${slide.differentiation_note}</div>` : ''}\r\n                                        ${slide.media_asset?.url ? `\r\n                                            <div class=\"generated-visual\">\r\n                                                <img src=\"${slide.media_asset.url}\" alt=\"${slide.slide_title}\" style=\"max-width: 100%; border-radius: 8px; margin-top: 1rem;\" />\r\n                                            </div>\r\n                                        ` : slide.media_asset ? `<div class=\"media-badge\"> ${slide.media_asset.content}</div>` : ''}\r\n                                    </div>\r\n                                `,\r\n                                metadata: { time: slide.timing_estimate || '5 min', bloomLevel: 'understand' }\r\n                            })),\r\n                            {\r\n                                id: crypto.randomUUID(),\r\n                                type: 'text',\r\n                                content: `\r\n                                    <div class=\"lesson-section practice\">\r\n                                        <h3>   (Guided Practice - In-Class)</h3>\r\n                                        <p><strong>   :</strong> ${lessonPlan.guided_practice.teacher_facilitation_script}</p>\r\n\r\n                                        ${lessonPlan.guided_practice.example_questions && lessonPlan.guided_practice.example_questions.length > 0 ? `\r\n                                            <div class=\"example-questions\" style=\"margin: 15px 0; background: #EFF6FF; padding: 15px; border-radius: 8px; border-right: 4px solid #2B59C3;\">\r\n                                                <strong style=\"color: #2B59C3; font-size: 16px;\">   :</strong>\r\n                                                ${lessonPlan.guided_practice.example_questions.map((q: any, i: number) => `\r\n                                                    <div style=\"margin: 12px 0; padding: 12px; background: white; border-radius: 5px;\">\r\n                                                        <p style=\"margin: 0; font-weight: bold; color: #1E40AF;\"> ${i + 1}: ${q.question_text}</p>\r\n                                                        <p style=\"margin: 8px 0 5px 0; color: #166534;\"> <strong> :</strong> ${q.expected_answer}</p>\r\n                                                        ${q.common_mistakes && q.common_mistakes.length > 0 ? `<p style=\"margin: 5px 0; color: #DC2626;\"> <strong> :</strong> ${q.common_mistakes.join(' | ')}</p>` : ''}\r\n                                                        ${q.follow_up_prompt ? `<p style=\"margin: 5px 0; color: #7C3AED;\"> <strong> :</strong> ${q.follow_up_prompt}</p>` : ''}\r\n                                                    </div>\r\n                                                `).join('')}\r\n                                            </div>\r\n                                        ` : ''}\r\n\r\n                                        ${lessonPlan.guided_practice.worked_example ? `\r\n                                            <div class=\"worked-example\" style=\"margin: 15px 0; background: #FEF3C7; padding: 15px; border-radius: 8px; border: 2px solid #F59E0B;\">\r\n                                                <strong style=\"color: #B45309; font-size: 16px;\">   (  ):</strong>\r\n                                                <p style=\"margin: 10px 0; font-weight: bold;\">${lessonPlan.guided_practice.worked_example.problem}</p>\r\n                                                <div style=\"background: white; padding: 12px; border-radius: 5px; margin: 10px 0;\">\r\n                                                    <strong> :</strong>\r\n                                                    <ol style=\"margin: 8px 0;\">${lessonPlan.guided_practice.worked_example.solution_steps.map((step: string) => `<li style=\"margin: 5px 0;\">${step}</li>`).join('')}</ol>\r\n                                                </div>\r\n                                                ${lessonPlan.guided_practice.worked_example.key_points && lessonPlan.guided_practice.worked_example.key_points.length > 0 ? `\r\n                                                    <div style=\"margin-top: 10px;\">\r\n                                                        <strong style=\"color: #B45309;\">  :</strong>\r\n                                                        <ul style=\"margin: 5px 0;\">${lessonPlan.guided_practice.worked_example.key_points.map((point: string) => `<li>${point}</li>`).join('')}</ul>\r\n                                                    </div>\r\n                                                ` : ''}\r\n                                            </div>\r\n                                        ` : ''}\r\n\r\n                                        ${lessonPlan.guided_practice.differentiation_strategies ? `\r\n                                            <div class=\"differentiation\">\r\n                                                <strong> :</strong>\r\n                                                <p> <strong> :</strong> ${lessonPlan.guided_practice.differentiation_strategies.for_struggling_students}</p>\r\n                                                <p> <strong> :</strong> ${lessonPlan.guided_practice.differentiation_strategies.for_advanced_students}</p>\r\n                                            </div>\r\n                                        ` : ''}\r\n                                        ${lessonPlan.guided_practice.assessment_tips && lessonPlan.guided_practice.assessment_tips.length > 0 ? `\r\n                                            <div class=\"assessment-tips\">\r\n                                                <strong>      :</strong>\r\n                                                <ul>${lessonPlan.guided_practice.assessment_tips.map(tip => `<li>${tip}</li>`).join('')}</ul>\r\n                                            </div>\r\n                                        ` : ''}\r\n                                    </div>\r\n                                `,\r\n                                metadata: { time: '10 min', bloomLevel: 'apply' }\r\n                            },\r\n                            // INDEPENDENT PRACTICE - Header block\r\n                            {\r\n                                id: crypto.randomUUID(),\r\n                                type: 'text',\r\n                                content: `\r\n                                    <div class=\"lesson-section independent-practice\">\r\n                                        <h3>   (Independent Practice)</h3>\r\n                                        <p><strong> :</strong> ${lessonPlan.independent_practice?.introduction_text || '    '}</p>\r\n                                        ${lessonPlan.independent_practice?.estimated_duration ? `<div class=\"duration-badge\">  : ${lessonPlan.independent_practice.estimated_duration}</div>` : ''}\r\n                                    </div>\r\n                                `,\r\n                                metadata: { time: '10 min', bloomLevel: 'apply' }\r\n                            },\r\n                            // INTERACTIVE BLOCKS - Each as separate component!\r\n                            ...independentPracticeBlocks,\r\n                            {\r\n                                id: crypto.randomUUID(),\r\n                                type: 'text',\r\n                                content: `\r\n                                    <div class=\"lesson-section discussion\">\r\n                                        <h3>   (Discussion)</h3>\r\n                                        <div class=\"discussion-questions\">\r\n                                            <ul>${lessonPlan.discussion.questions.map(q => {\r\n                                                // Handle both string and object formats\r\n                                                if (typeof q === 'string') return `<li> ${q}</li>`;\r\n                                                if (typeof q === 'object' && q !== null) {\r\n                                                    const questionText = q.question || q.text || q.question_text || JSON.stringify(q);\r\n                                                    return `<li> ${questionText}</li>`;\r\n                                                }\r\n                                                return '';\r\n                                            }).join('')}</ul>\r\n                                        </div>\r\n                                        ${lessonPlan.discussion.facilitation_tips ? `\r\n                                            <div class=\"facilitation-tips\">\r\n                                                <strong>  :</strong>\r\n                                                <ul>${lessonPlan.discussion.facilitation_tips.map(tip => `<li>${typeof tip === 'string' ? tip : (tip?.text || tip?.tip || '')}</li>`).join('')}</ul>\r\n                                            </div>\r\n                                        ` : ''}\r\n                                    </div>\r\n                                `,\r\n                                metadata: { time: '5 min', bloomLevel: 'evaluate' }\r\n                            },\r\n                            {\r\n                                id: crypto.randomUUID(),\r\n                                type: 'text',\r\n                                content: `\r\n                                    <div class=\"lesson-section summary\">\r\n                                        <h3>  (Summary)</h3>\r\n                                        <p class=\"takeaway\"><strong>   :</strong> \"${lessonPlan.summary.takeaway_sentence}\"</p>\r\n                                        <div class=\"visual-placeholder\">  ...</div>\r\n                                        ${lessonPlan.summary.homework_suggestion ? `\r\n                                            <div class=\"homework\">\r\n                                                <strong>   :</strong> ${lessonPlan.summary.homework_suggestion}\r\n                                            </div>\r\n                                        ` : ''}\r\n                                    </div>\r\n                                `,\r\n                                metadata: { time: '5 min', bloomLevel: 'remember' }\r\n                            }\r\n                        ];\r\n\r\n                        // 4. Save\r\n                        setCourse((prev: any) => {\r\n                            if (!prev) return prev;\r\n                            const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                                ...m,\r\n                                learningUnits: m.learningUnits.map((u: LearningUnit) =>\r\n                                    u.id === unit.id ? { ...u, activityBlocks: newBlocks, metadata: { ...u.metadata, status: 'ready' } } : u\r\n                                )\r\n                            }));\r\n                            const newCourse = { ...prev, syllabus: newSyllabus };\r\n                            saveCourseToFirestore(newCourse);\r\n                            return newCourse;\r\n                        });\r\n\r\n                        continue; // Skip the rest of the loop (Skeleton generation)\r\n                    }\r\n                }\r\n\r\n                // === STUDENT ACTIVITY MODE (V5 Streaming with Fallback) ===\r\n                // Try streaming first, fallback to legacy if fails\r\n                const useStreaming = isStreamingSupported();\r\n\r\n                if (useStreaming) {\r\n                    try {\r\n                        console.log(\" Using V5 streaming activity generation...\");\r\n                        await handleStreamingActivityGeneration(\r\n                            unit,\r\n                            sourceText,\r\n                            grade,\r\n                            activityLength,\r\n                            productType || 'activity',\r\n                            course?.wizardData?.settings?.questionPreferences\r\n                        );\r\n                        continue; // Move to next unit in queue\r\n                    } catch (streamError) {\r\n                        console.warn(\" Streaming failed, falling back to sequential:\", streamError);\r\n                        // Fall through to legacy code below\r\n                    }\r\n                }\r\n\r\n                // === FALLBACK: Legacy Sequential Flow ===\r\n                console.log(\" Using legacy sequential generation...\");\r\n                const skeleton = await generateUnitSkeleton(\r\n                    unit.title,\r\n                    grade,\r\n                    activityLength,\r\n                    sourceText,\r\n                    mode === 'lesson' ? 'learning' : mode,\r\n                    taxonomy,\r\n                    productType\r\n                );\r\n\r\n                if (skeleton && skeleton.steps) {\r\n                    const totalSteps = skeleton.steps.length;\r\n\r\n                    const stepPromises = skeleton.steps.map(async (step: any) => {\r\n\r\n                        const content = await generateStepContent(\r\n                            unit.title,\r\n                            step,\r\n                            grade,\r\n                            sourceText,\r\n                            undefined,\r\n                            'learning',\r\n                            undefined,\r\n                            totalSteps\r\n                        );\r\n\r\n\r\n                        const mapped = mapSystemItemToBlock(content);\r\n                        return mapped;\r\n                    });\r\n\r\n                    const newBlocksRaw = await Promise.all(stepPromises);\r\n                    let newBlocks = newBlocksRaw.map((b: any, idx) => {\r\n                        if (b === null) {\r\n                            return {\r\n                                id: crypto.randomUUID(),\r\n                                type: 'text',\r\n                                content: ` **Debug: Block Generation Failed for Step ${idx + 1}**\\n\\nCheck console logs for 'step content' or 'mapping' errors.`,\r\n                                metadata: { score: 0, bloomLevel: 'evaluation' }\r\n                            };\r\n                        }\r\n                        return b;\r\n                    });\r\n\r\n                    if (newBlocks.length === 0) {\r\n                        console.warn(\"Generation yielded 0 blocks. Inserting Error Block.\");\r\n                        newBlocks = [{\r\n                            id: crypto.randomUUID(),\r\n                            type: 'text',\r\n                            content: \" ** **\\n\\n       .     .\\n\\n(Debug Info: API returned null or empty blocks)\",\r\n                            metadata: { score: 0, bloomLevel: 'evaluation' }\r\n                        }];\r\n                    }\r\n\r\n                    // Save Ready Unit\r\n                    setCourse((prev: any) => {\r\n                        if (!prev) return prev;\r\n                        let updateFound = false;\r\n                        const newSyllabus = prev.syllabus.map((m: Module) => ({\r\n                            ...m,\r\n                            learningUnits: m.learningUnits.map((u: LearningUnit) => {\r\n                                if (u.id === unit.id) {\r\n                                    updateFound = true;\r\n                                    return { ...u, activityBlocks: newBlocks, metadata: { ...u.metadata, status: 'ready' } };\r\n                                }\r\n                                return u;\r\n                            })\r\n                        }));\r\n\r\n                        if (!updateFound) console.error(` [State Update] Unit ${unit.id} NOT FOUND in current state! IDs mismatch.`);\r\n\r\n                        const newCourse = { ...prev, syllabus: newSyllabus };\r\n                        saveCourseToFirestore(newCourse).catch((e: any) => console.error(\"Auto-save failed\", e));\r\n                        return newCourse;\r\n                    });\r\n\r\n                } else {\r\n                    console.warn(\"Skeleton generation failed for\", unit.title);\r\n                }\r\n\r\n            } catch (err) {\r\n                console.error(\"Error building unit\", unit.title, err);\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleWizardComplete = async (data: any) => {\r\n        if (isGenerating) return; //   \r\n\r\n        //  Performance timing\r\n        activityTimer.startStep('CourseEditor: Initial setup');\r\n\r\n        wizardHasRun.current = true;\r\n        setShowWizard(false);\r\n        // setShowLoader(true); // Removed by user request\r\n        setIsGenerating(true);\r\n\r\n        // console.log(\" Full Wizard Data Output:\", JSON.stringify(data, null, 2));\r\n\r\n        try {\r\n            const extractedGrade =\r\n                (Array.isArray(data.targetAudience) ? data.targetAudience[0] : data.targetAudience) ||\r\n                (Array.isArray(data.gradeLevel) ? data.gradeLevel[0] : data.gradeLevel) ||\r\n                (Array.isArray(data.grade) ? data.grade[0] : data.grade) ||\r\n                (data.settings?.targetAudience) ||\r\n                (data.settings?.gradeLevel) ||\r\n                (data.settings?.grade) ||\r\n                \"\";\r\n\r\n            // console.log(\" FINAL GRADE DETECTED:\", extractedGrade);\r\n\r\n            const userSubject = data.settings?.subject || data.subject || \"\";\r\n\r\n            setForcedGrade(extractedGrade);\r\n            activityTimer.endStep();\r\n\r\n            // ---     (    -DB) ---\r\n            activityTimer.startStep('File/Text processing');\r\n            let processedFileData = undefined; //  \r\n            let processedSourceText = undefined; //  /PDF\r\n\r\n            if (data.file) {\r\n                const file = data.file;\r\n                activityTimer.checkpoint(`Processing file: ${file.name}`);\r\n\r\n                try {\r\n                    if (file.type === 'application/pdf') {\r\n                        //   -PDF\r\n                        processedSourceText = await extractTextFromPDF(file);\r\n                        activityTimer.checkpoint('PDF text extracted');\r\n                    } else if (file.type.startsWith('image/')) {\r\n                        //  -Base64  \r\n                        processedFileData = await fileToBase64(file);\r\n                        activityTimer.checkpoint('Image converted to base64');\r\n                    } else if (file.type === 'text/plain') {\r\n                        //   \r\n                        processedSourceText = await file.text();\r\n                        activityTimer.checkpoint('Text file read');\r\n                    } else {\r\n                        console.warn(\"Unsupported file type for AI analysis, using metadata solely.\");\r\n                    }\r\n                } catch (fileError) {\r\n                    console.error(\"File processing failed:\", fileError);\r\n                    alert(\"  .      .\");\r\n                }\r\n            } else if (data.pastedText) {\r\n                processedSourceText = data.pastedText;\r\n                activityTimer.checkpoint(`Pasted text: ${data.pastedText.length} chars`);\r\n            }\r\n            activityTimer.endStep();\r\n\r\n            // ---         ---\r\n            let topicToUse = data.topic || data.title || course.title;\r\n            if ((!topicToUse || topicToUse === \"  \" || topicToUse === \" \") && processedSourceText && processedSourceText.length > 100) {\r\n                activityTimer.startStep('AI: Extract topic from text');\r\n                topicToUse = await extractTopicFromText(processedSourceText);\r\n                activityTimer.endStep();\r\n            }\r\n            topicToUse = topicToUse || \" \";\r\n\r\n            activityTimer.startStep('Firestore: Save course metadata');\r\n            const updatedCourseState = {\r\n                ...course,\r\n                title: topicToUse,\r\n                subject: userSubject,\r\n                gradeLevel: extractedGrade,\r\n                mode: data.settings?.courseMode || 'learning',\r\n                activityLength: data.settings?.activityLength || 'medium',\r\n                botPersona: data.settings?.botPersona || null,\r\n                showSourceToStudent: data.settings?.showSourceToStudent || false,\r\n                fullBookContent: processedSourceText || course.fullBookContent || \"\", //   \r\n                wizardData: data // CRITICAL: Save full wizard data including settings.productType\r\n            };\r\n\r\n            setCourse(updatedCourseState);\r\n\r\n            // SANITIZE FOR FIRESTORE (Remove undefined)\r\n            const cleanDataForFirestore = JSON.parse(JSON.stringify({\r\n                title: topicToUse,\r\n                subject: userSubject,\r\n                gradeLevel: extractedGrade,\r\n                mode: updatedCourseState.mode,\r\n                activityLength: updatedCourseState.activityLength,\r\n                botPersona: updatedCourseState.botPersona,\r\n                showSourceToStudent: updatedCourseState.showSourceToStudent,\r\n                fullBookContent: updatedCourseState.fullBookContent,\r\n                wizardData: data // CRITICAL: Persist to DB\r\n            }));\r\n\r\n            await updateDoc(doc(db, \"courses\", course.id), cleanDataForFirestore);\r\n            activityTimer.endStep();\r\n\r\n            //   (    ,   )\r\n            let syllabus: Module[] = [];\r\n\r\n            if (data.settings?.productType === 'lesson') {\r\n                // progressive loading strategy\r\n                activityTimer.startStep('AI: Generate lesson syllabus');\r\n                syllabus = await generateCourseSyllabus(\r\n                    topicToUse,\r\n                    extractedGrade,\r\n                    data.settings?.activityLength || 'medium',\r\n                    userSubject,\r\n                    processedSourceText,\r\n                    data.settings?.productType\r\n                );\r\n                activityTimer.endStep();\r\n\r\n\r\n                // --- PROGRESSIVE QUEUE TRIGGER ---\r\n                processLessonPlanQueue(\r\n                    syllabus,\r\n                    processedSourceText || topicToUse,\r\n                    extractedGrade,\r\n                    data.settings?.activityLength || 'medium',\r\n                    'lesson',\r\n                    null,\r\n                    data.settings?.productType\r\n                ).catch(e => console.error(\"Queue Error:\", e));\r\n\r\n            } else {\r\n                // legacy / cloud function strategy (games, exams)\r\n                activityTimer.startStep('AI: Generate course plan');\r\n                syllabus = await generateCoursePlan(\r\n                    topicToUse,\r\n                    extractedGrade,\r\n                    processedFileData,\r\n                    userSubject,\r\n                    processedSourceText,\r\n                    data.settings?.includeBot !== false, // includeBot\r\n                    data.settings?.productType, //  Product Type (will route to exam_generation_queue if 'exam')\r\n                    data.settings?.activityLength, //  Activity Length\r\n                    data.settings?.taxonomy, //  Taxonomy\r\n                    data.settings?.questionPreferences //     \r\n                );\r\n                activityTimer.endStep();\r\n            }\r\n\r\n            activityTimer.startStep('Firestore: Save syllabus');\r\n            const courseWithSyllabus = { ...updatedCourseState, syllabus };\r\n            setCourse(courseWithSyllabus);\r\n\r\n            // ARCHITECT FIX: Use immediate save for wizard completion (critical checkpoint)\r\n            await saveCourseToFirestoreImmediate(courseWithSyllabus);\r\n            activityTimer.endStep();\r\n\r\n            if (syllabus.length > 0 && syllabus[0].learningUnits.length > 0) {\r\n                const firstUnit = syllabus[0].learningUnits[0];\r\n\r\n                // --- PODCAST PRODUCT HANDLER ---\r\n                if (data.settings?.productType === 'podcast') {\r\n                    activityTimer.startStep('AI: Generate podcast script');\r\n\r\n                    //  STREAMING: Use streaming for podcast content\r\n                    const useStreaming = isStreamingSupported();\r\n                    let script: any = null;\r\n\r\n                    if (useStreaming) {\r\n                        try {\r\n                            script = await startPodcastStreaming({\r\n                                topic: topicToUse,\r\n                                gradeLevel: extractedGrade,\r\n                                sourceText: processedSourceText || '',\r\n                                activityLength: data.settings?.activityLength || 'medium'\r\n                            });\r\n                            console.log(\" Podcast streaming completed:\", script);\r\n                        } catch (streamError) {\r\n                            console.error(\" Podcast streaming failed, falling back:\", streamError);\r\n                            // Fallback to original method\r\n                            script = await generatePodcastScript(\r\n                                processedSourceText || '',\r\n                                topicToUse,\r\n                                extractedGrade,\r\n                                data.settings?.activityLength || 'medium'\r\n                            );\r\n                        }\r\n                    } else {\r\n                        // Non-streaming fallback\r\n                        script = await generatePodcastScript(\r\n                            processedSourceText || '',\r\n                            topicToUse,\r\n                            extractedGrade,\r\n                            data.settings?.activityLength || 'medium'\r\n                        );\r\n                    }\r\n\r\n                    if (script) {\r\n                        const podcastBlock: ActivityBlock = {\r\n                            id: crypto.randomUUID(),\r\n                            type: 'podcast',\r\n                            content: {\r\n                                title: `: ${topicToUse}`,\r\n                                script: script,\r\n                                audioUrl: null // Generated later\r\n                            },\r\n                            metadata: {\r\n                                bloomLevel: 'synthesis',\r\n                                score: 100,\r\n                                difficultyLevel: 3,\r\n                                generatedBy: 'wizdi-wizard-v4'\r\n                            }\r\n                        };\r\n\r\n                        const syllabusWithPodcast = syllabus.map((mod: any) => ({\r\n                            ...mod,\r\n                            learningUnits: mod.learningUnits.map((u: any) =>\r\n                                u.id === firstUnit.id ? { ...u, activityBlocks: [podcastBlock] } : u\r\n                            )\r\n                        }));\r\n\r\n\r\n                        const finalCourse = { ...courseWithSyllabus, syllabus: syllabusWithPodcast };\r\n                        setCourse(finalCourse);\r\n                        // ARCHITECT FIX: Use immediate save for podcast completion\r\n                        await saveCourseToFirestoreImmediate(finalCourse);\r\n                        setSelectedUnitId(firstUnit.id);\r\n                        activityTimer.endStep();\r\n                    } else {\r\n                        activityTimer.endStep();\r\n                        alert(\"  .  .\");\r\n                    }\r\n                    activityTimer.endSession();\r\n                }\r\n                // --- DIFFERENTIATED INSTRUCTION HANDLER ---\r\n                else if (data.settings?.isDifferentiated) {\r\n                    activityTimer.startStep('AI: Generate differentiated content');\r\n\r\n                    let diffContent: { support: any[]; core: any[]; enrichment: any[] } | null = null;\r\n\r\n                    // Helper to create a unit from raw items\r\n                    const isExam = data.settings?.productType === 'exam';\r\n                    const createDiffUnit = (levelName: string, items: any[]) => {\r\n                        const blocks = items.map(item => mapSystemItemToBlock({ data: item } as any)).filter(b => b !== null);\r\n                        return {\r\n                            id: crypto.randomUUID(),\r\n                            title: `${firstUnit.title} (${levelName})`,\r\n                            baseContent: processedSourceText || \"\",\r\n                            activityBlocks: blocks,\r\n                            type: isExam ? 'test' : 'practice'\r\n                        } as LearningUnit;\r\n                    };\r\n\r\n                    // Unit IDs for progressive updates\r\n                    const unitSupportId = crypto.randomUUID();\r\n                    const unitCoreId = crypto.randomUUID();\r\n                    const unitEnrichmentId = crypto.randomUUID();\r\n\r\n                    //  STREAMING with Gemini 3 Pro (only path - no GPT fallback)\r\n                    try {\r\n                        // Create skeleton units immediately\r\n                        const skeletonUnits = [\r\n                            { id: unitSupportId, title: `${firstUnit.title} ()`, baseContent: processedSourceText || \"\", activityBlocks: [], type: isExam ? 'test' : 'practice' } as LearningUnit,\r\n                            { id: unitCoreId, title: `${firstUnit.title} ()`, baseContent: processedSourceText || \"\", activityBlocks: [], type: isExam ? 'test' : 'practice' } as LearningUnit,\r\n                            { id: unitEnrichmentId, title: `${firstUnit.title} ()`, baseContent: processedSourceText || \"\", activityBlocks: [], type: isExam ? 'test' : 'practice' } as LearningUnit\r\n                        ];\r\n\r\n                        // Show skeleton immediately\r\n                        const syllabusWithSkeleton = syllabus.map((mod: any) => ({\r\n                            ...mod,\r\n                            learningUnits: mod.learningUnits.map((u: any) =>\r\n                                u.id === firstUnit.id ? skeletonUnits : u\r\n                            ).flat()\r\n                        }));\r\n                        setCourse({ ...courseWithSyllabus, syllabus: syllabusWithSkeleton });\r\n                        setSelectedUnitId(unitCoreId); // Select Core by default\r\n\r\n                        // Start streaming (Gemini 3 Pro)\r\n                        diffContent = await startDifferentiatedStreaming({\r\n                            topic: topicToUse,\r\n                            gradeLevel: extractedGrade,\r\n                            subject: userSubject,\r\n                            sourceText: processedSourceText || course.title,\r\n                            productType: data.settings?.productType || 'activity',\r\n                            activityLength: data.settings?.activityLength || 'medium',\r\n                            questionPreferences: data.settings?.questionPreferences\r\n                        });\r\n                        console.log(\" Streaming completed:\", diffContent);\r\n\r\n                    } catch (streamError) {\r\n                        console.error(\" Differentiated generation failed:\", streamError);\r\n                        alert(\"   .  .\");\r\n                        setIsGenerating(false);\r\n                        return;\r\n                    }\r\n\r\n                    if (diffContent) {\r\n                        const unitSupport = createDiffUnit(\"\", diffContent.support);\r\n                        unitSupport.id = unitSupportId; // Keep consistent ID\r\n                        const unitCore = createDiffUnit(\"\", diffContent.core);\r\n                        unitCore.id = unitCoreId;\r\n                        const unitEnrichment = createDiffUnit(\"\", diffContent.enrichment);\r\n                        unitEnrichment.id = unitEnrichmentId;\r\n\r\n                        // Replace the single placeholder unit with our 3 new units\r\n                        const syllabusWithDiff = syllabus.map((mod: any) => ({\r\n                            ...mod,\r\n                            learningUnits: mod.learningUnits.map((u: any) =>\r\n                                u.id === firstUnit.id ? [unitSupport, unitCore, unitEnrichment] : u\r\n                            ).flat()\r\n                        }));\r\n\r\n                        const finalCourse = { ...courseWithSyllabus, syllabus: syllabusWithDiff };\r\n                        setCourse(finalCourse);\r\n                        await saveCourseToFirestoreImmediate(finalCourse);\r\n\r\n                        setSelectedUnitId(unitCore.id);\r\n\r\n                        if (data.settings?.productType === 'lesson') {\r\n                            setPreviewUnit(unitCore);\r\n                        }\r\n                        activityTimer.endStep();\r\n                    } else {\r\n                        activityTimer.endStep();\r\n                        alert(\"   .\");\r\n                    }\r\n                    activityTimer.endSession();\r\n                }\r\n                // --- STANDARD UNIT HANDLER ---\r\n                else {\r\n                    // CHECK FOR LESSON MODE -> PROGRESSIVE BUILD\r\n                    if (data.settings?.productType === 'lesson' || updatedCourseState.mode === 'lesson') {\r\n                        // Lesson Mode: We want to build the WHOLE plan progressively.\r\n                        // 1. We already have the Syllabus (Schema) saved above.\r\n                        // 2. Close the loader immediately so user sees the \"Schema\" in Overview.\r\n                        // setShowLoader(false);\r\n                        setSelectedUnitId(null); // Ensure Overview is shown\r\n\r\n                        // 3. Trigger Background Progressive Build\r\n                        activityTimer.startStep('Background: Lesson plan queue');\r\n                        processLessonPlanQueue(\r\n                            syllabus, // Use the fresh syllabus\r\n                            processedSourceText || updatedCourseState.fullBookContent,\r\n                            extractedGrade,\r\n                            updatedCourseState.activityLength || 'medium',\r\n                            updatedCourseState.mode || 'learning',\r\n                            data.settings?.taxonomy,\r\n                            data.settings?.productType\r\n                        );\r\n                        activityTimer.endStep();\r\n                        activityTimer.endSession();\r\n                        return; // Exit here, queue runs in background\r\n                    }\r\n\r\n                    // V5 STREAMING: Single Unit Generation with Fallback\r\n                    const useStreaming = isStreamingSupported();\r\n\r\n                    if (useStreaming) {\r\n                        try {\r\n                            activityTimer.startStep('AI: V5 Streaming activity generation');\r\n                            console.log(\" Using V5 streaming for initial activity generation...\");\r\n\r\n                            await handleStreamingActivityGeneration(\r\n                                firstUnit,\r\n                                processedSourceText || updatedCourseState.fullBookContent || '',\r\n                                extractedGrade,\r\n                                updatedCourseState.activityLength || 'medium',\r\n                                data.settings?.productType || 'activity',\r\n                                data.settings?.questionPreferences\r\n                            );\r\n\r\n                            activityTimer.endStep();\r\n                            setSelectedUnitId(firstUnit.id);\r\n                            activityTimer.endSession();\r\n                            return; // Exit early, streaming handles everything\r\n                        } catch (streamError) {\r\n                            console.warn(\" Streaming failed, falling back to sequential:\", streamError);\r\n                            // Fall through to legacy code\r\n                        }\r\n                    }\r\n\r\n                    // FALLBACK: Legacy Sequential Flow\r\n                    activityTimer.startStep('AI: Generate unit skeleton (fallback)');\r\n                    console.log(\" Using legacy sequential generation...\");\r\n\r\n                    const skeleton = await generateUnitSkeleton(\r\n                        firstUnit.title,\r\n                        extractedGrade,\r\n                        updatedCourseState.activityLength || 'medium',\r\n                        processedSourceText || updatedCourseState.fullBookContent,\r\n                        updatedCourseState.mode || 'learning',\r\n                        data.settings?.taxonomy,\r\n                        data.settings?.productType\r\n                    );\r\n                    activityTimer.endStep();\r\n\r\n                    if (skeleton && skeleton.steps) {\r\n                        activityTimer.startStep(`AI: Generate ${skeleton.steps.length} steps (parallel)`);\r\n                        const totalSteps = skeleton.steps.length;\r\n                        const stepPromises = skeleton.steps.map(async (step: any) => {\r\n                            const stepContent = await generateStepContent(\r\n                                firstUnit.title,\r\n                                step,\r\n                                extractedGrade,\r\n                                processedSourceText || updatedCourseState.fullBookContent,\r\n                                processedFileData,\r\n                                'learning',\r\n                                undefined,\r\n                                totalSteps\r\n                            );\r\n                            return mapSystemItemToBlock(stepContent);\r\n                        });\r\n\r\n                        const newBlocksRaw = await Promise.all(stepPromises);\r\n                        activityTimer.endStep();\r\n\r\n                        const newBlocks = newBlocksRaw.filter((b: any) => b !== null);\r\n\r\n                        activityTimer.startStep('Firestore: Save final content');\r\n                        const syllabusWithContent = syllabus.map((mod: any) => ({\r\n                            ...mod,\r\n                            learningUnits: mod.learningUnits.map((u: any) =>\r\n                                u.id === firstUnit.id ? { ...u, activityBlocks: newBlocks } : u\r\n                            )\r\n                        }));\r\n\r\n                        const finalCourse = { ...courseWithSyllabus, syllabus: syllabusWithContent };\r\n                        setCourse(finalCourse);\r\n                        await saveCourseToFirestoreImmediate(finalCourse);\r\n                        activityTimer.endStep();\r\n\r\n                        setSelectedUnitId(firstUnit.id);\r\n                    } else {\r\n                        console.error(\" Skeleton Generation Failed\");\r\n                        setSelectedUnitId(firstUnit.id);\r\n                    }\r\n                    activityTimer.endSession();\r\n                }\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error(\"Error generating content:\", error);\r\n            activityTimer.endSession();\r\n            // CRITICAL FIX: Close loader IMMEDIATELY before alert\r\n            // setShowLoader(false);\r\n            // Small timeout to allow React to render the closed state before alert blocks thread\r\n            setTimeout(() => {\r\n                alert(\"   .     .\");\r\n            }, 100);\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n\r\n\r\n\r\n    const handleSaveUnit = async (updatedUnit: LearningUnit) => {\r\n        console.log('[handleSaveUnit] Called with unit:', updatedUnit.id, updatedUnit.title);\r\n        console.log('[handleSaveUnit] isGenerating:', isGenerating);\r\n        console.log('[handleSaveUnit] activityBlocks:', updatedUnit.activityBlocks?.length);\r\n\r\n        // Note: We no longer block on isGenerating to allow manual block additions\r\n        // during AI generation. Only automatic next-unit generation is blocked.\r\n\r\n        const newSyllabus = course.syllabus.map((mod: any) => ({\r\n            ...mod,\r\n            learningUnits: mod.learningUnits.map((u: any) => u.id === updatedUnit.id ? updatedUnit : u)\r\n        }));\r\n\r\n        let nextUnitToGenerate = null;\r\n        let foundCurrent = false;\r\n\r\n        // Only look for next unit to auto-generate if not currently generating\r\n        if (!isGenerating) {\r\n            for (const mod of newSyllabus) {\r\n                for (const unit of mod.learningUnits) {\r\n                    if (foundCurrent && (!unit.activityBlocks || unit.activityBlocks.length === 0)) {\r\n                        nextUnitToGenerate = unit;\r\n                        break;\r\n                    }\r\n                    if (unit.id === updatedUnit.id) foundCurrent = true;\r\n                }\r\n                if (nextUnitToGenerate) break;\r\n            }\r\n        }\r\n\r\n        if (nextUnitToGenerate) {\r\n            const currentSubject = course.subject || \"\";\r\n\r\n            // Use the variant-enabled generator for adaptive content\r\n            generateFullUnitContentWithVariants(\r\n                nextUnitToGenerate.title,\r\n                course.title,\r\n                displayGrade,\r\n                undefined,\r\n                currentSubject,\r\n                undefined, // sourceText\r\n                undefined, // taxonomy\r\n                true, // includeBot (default)\r\n                course.mode || 'learning', // Pass course mode\r\n                course.activityLength || 'medium',\r\n                true // generateVariants - enable adaptive variants\r\n            ).then((newBlocks: ActivityBlock[]) => {\r\n                if (newBlocks.length > 0) {\r\n                    const backgroundSyllabus = newSyllabus.map((m: any) => ({\r\n                        ...m,\r\n                        learningUnits: m.learningUnits.map((u: any) =>\r\n                            u.id === nextUnitToGenerate!.id ? { ...u, activityBlocks: newBlocks } : u\r\n                        )\r\n                    }));\r\n                    // ARCHITECT FIX: Save only the specific generated unit\r\n                    const unitToSave = backgroundSyllabus\r\n                        .flatMap((m: any) => m.learningUnits)\r\n                        .find((u: any) => u.id === nextUnitToGenerate!.id);\r\n\r\n                    if (unitToSave) {\r\n                        saveUnitToFirestore(course.id, unitToSave).catch(e => console.error(\"Background unit save failed\", e));\r\n                    }\r\n\r\n                    // Update state\r\n                    setCourse({ ...course, syllabus: backgroundSyllabus });\r\n                }\r\n            });\r\n        }\r\n\r\n        const updatedCourse = { ...course, syllabus: newSyllabus };\r\n        setCourse(updatedCourse);\r\n\r\n        try {\r\n            // ARCHITECT FIX: Save specific unit instead of full doc\r\n            await saveUnitToFirestore(course.id, updatedUnit);\r\n        }\r\n        catch (e) { console.error(\"Save error:\", e); }\r\n    };\r\n\r\n\r\n\r\n    const activeUnit = course.syllabus?.flatMap((m: any) => m.learningUnits).find((u: any) => u.id === selectedUnitId);\r\n\r\n    // --- Single Activity Logic ---\r\n    // Fallback: If no unit is selected but units exist, default to the first one immediately ONLY IF NOT LESSON MODE.\r\n    const defaultUnit = course.syllabus?.[0]?.learningUnits?.[0];\r\n    const isLessonMode = course.wizardData?.settings?.productType === 'lesson' || course.mode === 'lesson';\r\n    // FIX: Lesson Mode should ALWAYS show the unit (Single Unit). Legacy modes might vary.\r\n    // For now, we restrict the \"Always Open\" behavior to Lesson Mode to avoid trapping Game Mode users.\r\n    const unitToRender = activeUnit || (isLessonMode ? defaultUnit : null);\r\n\r\n    // console.log(\"DEBUG: Editor Render. active:\", !!activeUnit, \"default:\", !!defaultUnit, \"isLesson:\", isLessonMode, \"RENDER:\", unitToRender ? \"UnitEditor\" : \"Overview\");\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-gray-50 font-sans\">\r\n            {/* Wizard Overlay - ALWAYS available on top */}\r\n            {showWizard && !isGenerating && (\r\n                <IngestionWizard\r\n                    onComplete={handleWizardComplete}\r\n                    onCancel={() => {\r\n                        setShowWizard(false);\r\n                        //     ,  \r\n                        if (!course?.syllabus?.length) {\r\n                            navigate('/');\r\n                        }\r\n                    }}\r\n                    initialTopic={course.title}\r\n                    title=\" \"\r\n                    cancelLabel=\"\"\r\n                    cancelIcon={<IconX className=\"w-6 h-6\" />}\r\n                />\r\n            )}\r\n\r\n            {/* Global Loading Overlay (Tic-Tac-Toe Zen Mode) */}\r\n            {/* Global Loading Overlay Removed by User Request */}\r\n            {/* {showLoader && (\r\n                <TicTacToeLoader\r\n                    isLoading={isGenerating}\r\n                    onContinue={() => setShowLoader(false)}\r\n                />\r\n            )} */}\r\n\r\n            {/*  STREAMING: Real-time progress indicator */}\r\n            {streamingState.isStreaming && (\r\n                <div className=\"fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50\">\r\n                    <StreamingProgress\r\n                        state={streamingState}\r\n                        onCancel={cancelStreaming}\r\n                        showStreamedText={false}\r\n                    />\r\n                </div>\r\n            )}\r\n\r\n            {/* Preview Modal */}\r\n            {previewUnit && (\r\n                <UnitPreviewModal\r\n                    unit={previewUnit}\r\n                    onClose={() => setPreviewUnit(null)}\r\n                />\r\n            )}\r\n\r\n            {/* Main Content Area */}\r\n            {/* Main Content Area */}\r\n            {unitToRender ? (\r\n                // Logic: Check if we should show TeacherCockpit (Lesson Mode) or UnitEditor (Builder Mode)\r\n                (course.wizardData?.settings?.productType === 'lesson' || course.mode === 'lesson') ? (\r\n                    <TeacherCockpit\r\n                        unit={unitToRender}\r\n                        courseId={course.id}\r\n                        onExit={() => {\r\n                            if (onBack) {\r\n                                onBack();\r\n                            } else {\r\n                                window.location.href = '/';\r\n                            }\r\n                        }}\r\n                        onUnitUpdate={handleSaveUnit}\r\n                        onUpdateBlock={async (blockId: string, content: any) => {\r\n                            // Handle AI Refinement Updates from Cockpit\r\n                            const updatedUnit = {\r\n                                ...unitToRender,\r\n                                activityBlocks: unitToRender.activityBlocks.map((b: any) => b.id === blockId ? { ...b, content } : b)\r\n                            };\r\n                            handleSaveUnit(updatedUnit);\r\n                        }}\r\n                    />\r\n                ) : (\r\n                    <UnitEditor\r\n                        unit={unitToRender}\r\n                        gradeLevel={displayGrade}\r\n                        subject={course.subject}\r\n                        onSave={handleSaveUnit}\r\n                        onCancel={() => {\r\n                            navigate('/'); //   \r\n                        }}\r\n                        onPreview={(unitData) => setPreviewUnit(unitData || unitToRender)}\r\n                        cancelLabel=\"\"\r\n                    />\r\n                )\r\n            ) : (\r\n                // Empty State OR Lesson Plan Overview\r\n                (course.wizardData?.settings?.productType === 'lesson' || course.mode === 'lesson') ? (\r\n                    <LessonPlanOverview\r\n                        course={course}\r\n                        onUpdateCourse={(updated) => {\r\n                            setCourse(updated);\r\n                            saveCourseToFirestore(updated).catch(console.error);\r\n                        }}\r\n                        onSelectUnit={(id) => setSelectedUnitId(id)}\r\n                        onUnitUpdate={(unit) => handleSaveUnit(unit)}\r\n                        onGenerateWithAI={handleGenerateWithAI}\r\n                        onBack={onBack}\r\n                    />\r\n                ) : (\r\n                    // Classic Loading State with Typewriter effect\r\n                    <div className=\"flex flex-col items-center justify-center h-screen bg-gray-50 text-center px-4\">\r\n                        <AIStarsSpinner size=\"xl\" color=\"primary\" className=\"mb-4\" />\r\n                        <p className=\"text-gray-600 font-medium text-lg mb-3\">  ...</p>\r\n                        {/* Typewriter status messages */}\r\n                        <div className=\"min-h-[1.5rem] mb-3\">\r\n                            <TypewriterLoaderInline\r\n                                contentType={\r\n                                    course.wizardData?.settings?.productType === 'exam' ? 'exam' :\r\n                                    course.wizardData?.settings?.productType === 'lesson' ? 'lesson' :\r\n                                    'activity'\r\n                                }\r\n                                isVisible={true}\r\n                                className=\"text-indigo-600 font-medium\"\r\n                            />\r\n                        </div>\r\n                        <p className=\"text-gray-400 text-sm mt-2 max-w-md\">  .     ,  .</p>\r\n                        <button onClick={() => window.location.reload()} className=\"mt-6 text-indigo-600 hover:text-indigo-800 text-sm font-bold underline\">\r\n                             \r\n                        </button>\r\n                    </div>\r\n                )\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default CourseEditor;"],"file":"assets/CourseEditor-DgLQTIpt.js"}