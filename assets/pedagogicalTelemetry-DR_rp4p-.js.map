{"version":3,"file":"pedagogicalTelemetry-DR_rp4p-.js","sources":["../../src/services/pedagogicalTelemetry.ts"],"sourcesContent":["import { db } from '../firebase';\r\nimport { collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from 'firebase/firestore';\r\nimport type { AuditResult } from '../utils/pedagogicalValidator';\r\n\r\nconst COLLECTION_NAME = 'pedagogical_audits';\r\n\r\nexport interface AuditSessionLog {\r\n    unitId: string;\r\n    unitTitle: string;\r\n    mode: 'learning' | 'exam';\r\n    avgScore: number;\r\n    timestamp: any;\r\n    failedRules: {\r\n        ruleId: string;\r\n        ruleName: string;\r\n        blockId: string;\r\n        blockType: string;\r\n        message: string;\r\n    }[];\r\n}\r\n\r\nexport const PedagogicalTelemetry = {\r\n    /**\r\n     * Upload an audit session to Firestore\r\n     */\r\n    logAuditSession: async (\r\n        unitId: string,\r\n        unitTitle: string,\r\n        mode: 'learning' | 'exam',\r\n        results: AuditResult[]\r\n    ) => {\r\n        try {\r\n            const avgScore = Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length);\r\n\r\n            // Extract only the failures/warnings\r\n            const failedRules = results.flatMap(r =>\r\n                r.rules\r\n                    .filter(rule => rule.status !== 'PASS')\r\n                    .map(rule => ({\r\n                        ruleId: rule.id,\r\n                        ruleName: rule.name,\r\n                        blockId: r.blockId,\r\n                        blockType: 'unknown', // Ideally passed from caller, but validator result doesn't have it yet easily\r\n                        message: rule.message\r\n                    }))\r\n            );\r\n\r\n            const logData: Omit<AuditSessionLog, 'timestamp'> & { timestamp: any } = {\r\n                unitId,\r\n                unitTitle,\r\n                mode,\r\n                avgScore,\r\n                timestamp: serverTimestamp(),\r\n                failedRules\r\n            };\r\n\r\n            await addDoc(collection(db, COLLECTION_NAME), logData);\r\n\r\n            return true;\r\n        } catch (error) {\r\n            console.error(\"❌ Failed to log pedagogical audit:\", error);\r\n            return false;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Get recent audits for the Insights Dashboard\r\n     */\r\n    getRecentAudits: async (limitCount = 20): Promise<AuditSessionLog[]> => {\r\n        try {\r\n            const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'), limit(limitCount));\r\n            const snapshot = await getDocs(q);\r\n            return snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id } as unknown as AuditSessionLog));\r\n        } catch (error) {\r\n            console.error(\"❌ Failed to fetch audits:\", error);\r\n            return [];\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Analyze common failures from recent data\r\n     */\r\n    getCommonFailures: async () => {\r\n        const logs = await PedagogicalTelemetry.getRecentAudits(50);\r\n        const failureCounts: Record<string, number> = {};\r\n\r\n        logs.forEach(log => {\r\n            log.failedRules.forEach(f => {\r\n                failureCounts[f.ruleName] = (failureCounts[f.ruleName] || 0) + 1;\r\n            });\r\n        });\r\n\r\n        return Object.entries(failureCounts)\r\n            .sort(([, a], [, b]) => b - a)\r\n            .map(([name, count]) => ({ name, count }));\r\n    }\r\n};\r\n"],"names":["COLLECTION_NAME","PedagogicalTelemetry","unitId","unitTitle","mode","results","avgScore","sum","r","failedRules","rule","logData","serverTimestamp","addDoc","collection","db","error","limitCount","q","query","orderBy","limit","getDocs","doc","logs","failureCounts","log","f","a","b","name","count"],"mappings":"gGAIA,MAAMA,EAAkB,qBAiBXC,EAAuB,CAIhC,gBAAiB,MACbC,EACAC,EACAC,EACAC,IACC,CACD,GAAI,CACA,MAAMC,EAAW,KAAK,MAAMD,EAAQ,OAAO,CAACE,EAAKC,IAAMD,EAAMC,EAAE,MAAO,CAAC,EAAIH,EAAQ,MAAM,EAGnFI,EAAcJ,EAAQ,QAAQ,GAChC,EAAE,MACG,OAAOK,GAAQA,EAAK,SAAW,MAAM,EACrC,IAAIA,IAAS,CACV,OAAQA,EAAK,GACb,SAAUA,EAAK,KACf,QAAS,EAAE,QACX,UAAW,UACX,QAASA,EAAK,OAAA,EAChB,CAAA,EAGJC,EAAmE,CACrE,OAAAT,EACA,UAAAC,EACA,KAAAC,EACA,SAAAE,EACA,UAAWM,EAAA,EACX,YAAAH,CAAA,EAGJ,aAAMI,EAAOC,EAAWC,EAAIf,CAAe,EAAGW,CAAO,EAE9C,EACX,OAASK,EAAO,CACZ,eAAQ,MAAM,qCAAsCA,CAAK,EAClD,EACX,CACJ,EAKA,gBAAiB,MAAOC,EAAa,KAAmC,CACpE,GAAI,CACA,MAAMC,EAAIC,EAAML,EAAWC,EAAIf,CAAe,EAAGoB,EAAQ,YAAa,MAAM,EAAGC,EAAMJ,CAAU,CAAC,EAEhG,OADiB,MAAMK,EAAQJ,CAAC,GAChB,KAAK,IAAIK,IAAQ,CAAE,GAAGA,EAAI,KAAA,EAAQ,GAAIA,EAAI,EAAA,EAAmC,CACjG,OAASP,EAAO,CACZ,eAAQ,MAAM,4BAA6BA,CAAK,EACzC,CAAA,CACX,CACJ,EAKA,kBAAmB,SAAY,CAC3B,MAAMQ,EAAO,MAAMvB,EAAqB,gBAAgB,EAAE,EACpDwB,EAAwC,CAAA,EAE9C,OAAAD,EAAK,QAAQE,GAAO,CAChBA,EAAI,YAAY,QAAQC,GAAK,CACzBF,EAAcE,EAAE,QAAQ,GAAKF,EAAcE,EAAE,QAAQ,GAAK,GAAK,CACnE,CAAC,CACL,CAAC,EAEM,OAAO,QAAQF,CAAa,EAC9B,KAAK,CAAC,CAAA,CAAGG,CAAC,EAAG,CAAA,CAAGC,CAAC,IAAMA,EAAID,CAAC,EAC5B,IAAI,CAAC,CAACE,EAAMC,CAAK,KAAO,CAAE,KAAAD,EAAM,MAAAC,CAAA,EAAQ,CACjD,CACJ"}