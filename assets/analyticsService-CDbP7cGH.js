import{aw as q,p as m,bz as w,bA as A,bJ as E,n as p,bl as f,c1 as P,bZ as U}from"./index-1x3sw4DL.js";const B=(a,e,r)=>a<.4||e>.7||r<.3?"high":a<.7||e>.4||r<.6?"medium":"low",I=a=>{const e=[];return a.forEach(r=>{r.interactions&&r.interactions.forEach(t=>{let o="question";t.type==="text"||t.type==="video"||t.type==="pdf"?o="content":t.isRemediation?o="":t.wasSkipped&&(o="skipped");let s="viewed";t.isCorrect===!0?s="success":t.isCorrect===!1?s="failure":t.wasSkipped&&(s="skipped"),e.push({id:t.questionId||`node-${e.length}`,type:o,status:s,timestamp:t.timestamp||r.startTime,blockId:t.questionId,blockType:t.type,variantUsed:t.variantUsed,connection:t.isRemediation?"branched":"direct",metadata:{responseTime:t.responseTime,hintsUsed:t.hintsUsed,attemptCount:t.attemptCount}})})}),e.sort((r,t)=>r.timestamp-t.timestamp)},Z=async a=>{try{const e=q(m,"enrollments"),r=w(e,A("courseId","==",a)),t=await E(r);if(t.empty)return console.log(`No enrollments found for course ${a}`),[];const s=t.docs.map(i=>i.data().studentId).map(i=>G(i,a));return(await Promise.all(s)).filter(i=>i!==null)}catch(e){return console.error("Error fetching course analytics:",e),[]}},G=async(a,e)=>{var r,t,o,s,c,i,l,S,b,T,_;try{const y=p(m,"users",a),R=await f(y);if(!R.exists())return console.warn(`User ${a} not found`),null;const d=R.data(),L=p(m,"users",a,"profile","stats"),D=await f(L),n=D.exists()?D.data():null,Q=p(m,"users",a,"profile","proficiency_vector"),k=await f(Q),g=k.exists()?k.data():null,j=p(m,"users",a,"profile","error_fingerprint"),x=await f(j),h=x.exists()?x.data():null,M=q(m,"users",a,"sessions");let $=w(M,P("startTime","desc"),U(20));e&&($=w(M,A("courseId","==",e),P("startTime","desc"),U(20)));const V=(await E($)).docs.map(v=>v.data()),u=(g==null?void 0:g.topics)||{},z=Object.values(u).length>0?Object.values(u).reduce((v,K)=>v+K,0)/Object.values(u).length:.5,C=((r=n==null?void 0:n.performance)==null?void 0:r.global_accuracy_rate)||.5,O=((t=n==null?void 0:n.behavioral)==null?void 0:t.hint_dependency_score)||0,N=B(C,O,z),J=I(V);return{id:a,name:d.displayName||d.name||"转",email:d.email,avatar:d.photoURL||`https://api.dicebear.com/7.x/avataaars/svg?seed=${a}`,mastery:u,lastActive:((i=(c=(s=(o=n==null?void 0:n.engagement)==null?void 0:o.last_active_at)==null?void 0:s.toDate)==null?void 0:c.call(s))==null?void 0:i.toISOString())||((b=(S=(l=d.lastLogin)==null?void 0:l.toDate)==null?void 0:S.call(l))==null?void 0:b.toISOString())||new Date().toISOString(),riskLevel:N,journey:J,performance:{accuracy:C,avgResponseTime:((T=n==null?void 0:n.performance)==null?void 0:T.average_response_time_sec)||0,totalQuestions:((_=n==null?void 0:n.performance)==null?void 0:_.total_questions_attempted)||0,hintDependency:O},errorPatterns:(h==null?void 0:h.errorTags)||{}}}catch(y){return console.error(`Error fetching analytics for student ${a}:`,y),null}},H=["砖专 驻砖","砖专 专","注砖专","","住 驻专驻专爪"],W=[{id:"demo-struggling",name:" ",email:"dani@demo.wizdi.co",risk:"high",profile:"struggling",expectedVariant:"",mastery:{base:.28,variance:.1},performance:{accuracy:.35,avgResponseTime:38,totalQuestions:42,hintDependency:.72},errorPatterns:{"砖转 砖":15,"砖转 住":8," 转 砖":6,"专 砖专   砖转祝":4}},{id:"demo-average",name:" ",email:"michal@demo.wizdi.co",risk:"medium",profile:"average",expectedVariant:"砖",mastery:{base:.58,variance:.15},performance:{accuracy:.67,avgResponseTime:22,totalQuestions:65,hintDependency:.28},errorPatterns:{"砖转 砖":5,"砖转 专砖转":3,"砖转 住":2}},{id:"demo-advanced",name:"住 驻专抓",email:"yossi@demo.wizdi.co",risk:"low",profile:"advanced",expectedVariant:"注拽",mastery:{base:.91,variance:.05},performance:{accuracy:.94,avgResponseTime:11,totalQuestions:85,hintDependency:.03},errorPatterns:{"砖转 专砖转":2}}],X=a=>{const e=[];let t=Date.now()-1e3*60*60;const o=a==="high"?"":a==="low"?"注拽":"砖";for(let s=1;s<=8;s++){const c=a==="low"?Math.random()>.1:a==="medium"?Math.random()>.4:Math.random()>.7;s%2===1&&(e.push({id:`content-${s}`,type:"content",status:"viewed",timestamp:t,connection:"direct",variantUsed:o}),t+=1e3*60*2);let i=o;if((a==="high"&&s>4&&Math.random()>.7||a==="low"&&!c)&&(i="砖"),e.push({id:`step-${s}`,type:"question",status:c?"success":"failure",timestamp:t,connection:"direct",variantUsed:i}),t+=1e3*60*5,!c){const l=Math.random()>.2;e.push({id:`remedial-${s}`,type:"",status:l?"success":"failure",timestamp:t,connection:"branched",variantUsed:""}),t+=1e3*60*3}}return e},Y=async a=>(await new Promise(e=>setTimeout(e,300)),W.map(e=>{const r={};return H.forEach(t=>{const o=(Math.random()-.5)*e.mastery.variance*2;r[t]=Math.min(1,Math.max(0,e.mastery.base+o))}),{id:e.id,name:e.name,email:e.email,avatar:`https://api.dicebear.com/7.x/avataaars/svg?seed=${e.id}`,mastery:r,lastActive:new Date().toISOString(),riskLevel:e.risk,journey:X(e.risk),performance:e.performance,errorPatterns:e.errorPatterns}})),te=async a=>{const e=await Z(a);return e.length>0?(console.log(` Loaded ${e.length} real students for course ${a}`),e):(console.log(` No real data found, using mock data for course ${a}`),Y())};export{te as g};
//# sourceMappingURL=analyticsService-CDbP7cGH.js.map
