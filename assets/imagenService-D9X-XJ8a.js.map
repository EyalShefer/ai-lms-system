{"version":3,"file":"imagenService-D9X-XJ8a.js","sources":["../../src/services/ai/imagenService.ts"],"sourcesContent":["/**\r\n * Gemini Image Generation Service\r\n * Uses Gemini 3 Pro Image for high-quality Hebrew infographics\r\n * Falls back to DALL-E 3 if Gemini fails\r\n *\r\n * Setup Instructions:\r\n * 1. Enable Vertex AI in Google Cloud Console\r\n * 2. Deploy Cloud Function: firebase deploy --only functions:generateGeminiImage\r\n * 3. Set VITE_ENABLE_GEMINI_IMAGE=true in .env\r\n *\r\n * ============================================================\r\n * IMPORTANT: DO NOT CHANGE THE MODEL WITHOUT EXPLICIT APPROVAL\r\n * See AI_MODELS_POLICY.md for approved models.\r\n * Approved: gemini-3-pro-preview (text), gemini-3-pro-image-preview (images)\r\n * ============================================================\r\n */\r\n\r\nimport { auth } from '../../firebase';\r\n\r\n/**\r\n * Gemini Image configuration\r\n * WARNING: Do not change model without approval - see AI_MODELS_POLICY.md\r\n */\r\nexport const GEMINI_IMAGE_CONFIG = {\r\n    model: 'gemini-3-pro-image-preview',\r\n    endpoint: 'generateGeminiImage'\r\n};\r\n\r\n// Legacy export for backwards compatibility\r\nexport const IMAGEN_CONFIG = GEMINI_IMAGE_CONFIG;\r\n\r\n/**\r\n * Check if Gemini Image is available and configured\r\n */\r\nexport const isImagenAvailable = (): boolean => {\r\n    return import.meta.env.VITE_ENABLE_GEMINI_IMAGE === 'true' ||\r\n           import.meta.env.VITE_ENABLE_IMAGEN === 'true' ||\r\n           false;\r\n};\r\n\r\n// Alias for clarity\r\nexport const isGeminiImageAvailable = isImagenAvailable;\r\n\r\n/**\r\n * Generate image using Gemini 3 Pro Image\r\n * Best for Hebrew text and educational infographics\r\n *\r\n * @param prompt - Image generation prompt\r\n * @returns Promise<Blob | null> - PNG image blob or null on failure\r\n */\r\nexport const generateGeminiImage = async (\r\n    prompt: string\r\n): Promise<Blob | null> => {\r\n    if (!isGeminiImageAvailable()) {\r\n        console.warn('âš ï¸ Gemini Image is not configured. Set VITE_ENABLE_GEMINI_IMAGE=true');\r\n        return null;\r\n    }\r\n\r\n    try {\r\n        console.log(`ğŸ¨ Generating image with Gemini 3 Pro Image...`);\r\n\r\n        // Get Firebase auth token for authentication\r\n        const user = auth.currentUser;\r\n        if (!user) {\r\n            console.error('âŒ User not authenticated');\r\n            return null;\r\n        }\r\n\r\n        const idToken = await user.getIdToken();\r\n\r\n        // Build Cloud Function URL\r\n        const projectId = import.meta.env.VITE_FIREBASE_PROJECT_ID;\r\n        const functionUrl = import.meta.env.VITE_GEMINI_IMAGE_FUNCTION_URL ||\r\n            `https://us-central1-${projectId}.cloudfunctions.net/generateGeminiImage`;\r\n\r\n        const response = await fetch(functionUrl, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Bearer ${idToken}`\r\n            },\r\n            body: JSON.stringify({ prompt })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorData = await response.json().catch(() => ({ error: response.statusText }));\r\n\r\n            // Handle specific error codes\r\n            if (response.status === 429) {\r\n                console.warn('âš ï¸ Rate limited, will fall back to DALL-E');\r\n                return null;\r\n            }\r\n\r\n            throw new Error(`Gemini Image API error: ${errorData.error || response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n\r\n        // Extract base64 image from response\r\n        if (data.success && data.image?.base64) {\r\n            const base64Data = data.image.base64;\r\n            const byteCharacters = atob(base64Data);\r\n            const byteNumbers = new Array(byteCharacters.length);\r\n            for (let i = 0; i < byteCharacters.length; i++) {\r\n                byteNumbers[i] = byteCharacters.charCodeAt(i);\r\n            }\r\n            const byteArray = new Uint8Array(byteNumbers);\r\n\r\n            console.log(`âœ… Gemini Image generation successful (${data.metadata?.generationTime}ms, model: ${data.metadata?.model})`);\r\n\r\n            return new Blob([byteArray], { type: data.image.mimeType || 'image/png' });\r\n        }\r\n\r\n        console.warn('âš ï¸ Gemini returned success but no image data');\r\n        return null;\r\n\r\n    } catch (error) {\r\n        console.error('âŒ Gemini Image generation failed:', error);\r\n        return null;\r\n    }\r\n};\r\n\r\n// Legacy alias for backwards compatibility\r\nexport const generateImagenImage = generateGeminiImage;\r\n\r\n/**\r\n * Cost helper - Gemini 3 Pro Image only\r\n */\r\nexport const getImageGenerationCost = (): {\r\n    perImage: number;\r\n    per1000: number;\r\n    currency: string;\r\n} => {\r\n    return { perImage: 0.040, per1000: 40, currency: 'USD' };\r\n};\r\n\r\n/**\r\n * Setup guide for educators\r\n */\r\nexport const GEMINI_IMAGE_SETUP_GUIDE = `\r\n# ×”×’×“×¨×ª Gemini Image (××™×›×•×ª ×¢×‘×¨×™×ª ××¢×•×œ×”!)\r\n\r\n## ×©×œ×‘ 1: Google Cloud Console\r\n1. ×’×© ×œ-https://console.cloud.google.com\r\n2. ×”×¤×¢×œ Vertex AI API\r\n3. ×•×•×“× ×©×”-Firebase project ××—×•×‘×¨\r\n\r\n## ×©×œ×‘ 2: Deploy Cloud Function\r\n\\`\\`\\`bash\r\ncd functions\r\nnpm install\r\nfirebase deploy --only functions:generateGeminiImage\r\n\\`\\`\\`\r\n\r\n## ×©×œ×‘ 3: ×”×’×“×¨×ª ××©×ª× ×™ ×¡×‘×™×‘×”\r\n×‘×§×•×‘×¥ .env:\r\n\\`\\`\\`\r\nVITE_ENABLE_GEMINI_IMAGE=true\r\n\\`\\`\\`\r\n\r\n## ×™×ª×¨×•× ×•×ª Gemini 3 Pro Image:\r\n- ×ª××™×›×” ××¢×•×œ×” ×‘×¢×‘×¨×™×ª ×•-RTL\r\n- ××™×›×•×ª ×ª××•× ×” ×’×‘×•×”×”\r\n- ×˜×§×¡×˜ ×§×¨×™× ×•×‘×¨×•×¨\r\n- ××™×“×™××œ×™ ×œ××™× ×¤×•×’×¨×¤×™×§×•×ª ×—×™× ×•×›×™×•×ª\r\n`;\r\n\r\n// Legacy export\r\nexport const IMAGEN_SETUP_GUIDE = GEMINI_IMAGE_SETUP_GUIDE;\r\n"],"names":["isImagenAvailable","isGeminiImageAvailable","generateGeminiImage","prompt","user","auth","idToken","response","errorData","data","_a","base64Data","byteCharacters","byteNumbers","i","byteArray","_b","_c","error"],"mappings":"wCAkCO,MAAMA,EAAoB,IACtB,GAMEC,EAAyBD,EASzBE,EAAsB,MAC/BC,GACuB,WAMvB,GAAI,CACA,QAAQ,IAAI,gDAAgD,EAG5D,MAAMC,EAAOC,EAAK,YAClB,GAAI,CAACD,EACD,eAAQ,MAAM,0BAA0B,EACjC,KAGX,MAAME,EAAU,MAAMF,EAAK,WAAA,EAOrBG,EAAW,MAAM,MAFnB,wEAEsC,CACtC,OAAQ,OACR,QAAS,CACL,eAAgB,mBAChB,cAAiB,UAAUD,CAAO,EAAA,EAEtC,KAAM,KAAK,UAAU,CAAE,OAAAH,EAAQ,CAAA,CAClC,EAED,GAAI,CAACI,EAAS,GAAI,CACd,MAAMC,EAAY,MAAMD,EAAS,OAAO,MAAM,KAAO,CAAE,MAAOA,EAAS,UAAA,EAAa,EAGpF,GAAIA,EAAS,SAAW,IACpB,eAAQ,KAAK,2CAA2C,EACjD,KAGX,MAAM,IAAI,MAAM,2BAA2BC,EAAU,OAASD,EAAS,UAAU,EAAE,CACvF,CAEA,MAAME,EAAO,MAAMF,EAAS,KAAA,EAG5B,GAAIE,EAAK,WAAWC,EAAAD,EAAK,QAAL,MAAAC,EAAY,QAAQ,CACpC,MAAMC,EAAaF,EAAK,MAAM,OACxBG,EAAiB,KAAKD,CAAU,EAChCE,EAAc,IAAI,MAAMD,EAAe,MAAM,EACnD,QAASE,EAAI,EAAGA,EAAIF,EAAe,OAAQE,IACvCD,EAAYC,CAAC,EAAIF,EAAe,WAAWE,CAAC,EAEhD,MAAMC,EAAY,IAAI,WAAWF,CAAW,EAE5C,eAAQ,IAAI,0CAAyCG,EAAAP,EAAK,WAAL,YAAAO,EAAe,cAAc,eAAcC,EAAAR,EAAK,WAAL,YAAAQ,EAAe,KAAK,GAAG,EAEhH,IAAI,KAAK,CAACF,CAAS,EAAG,CAAE,KAAMN,EAAK,MAAM,UAAY,YAAa,CAC7E,CAEA,eAAQ,KAAK,8CAA8C,EACpD,IAEX,OAASS,EAAO,CACZ,eAAQ,MAAM,oCAAqCA,CAAK,EACjD,IACX,CACJ"}