{"version":3,"file":"generationTimingService-B4dIuwqG.js","sources":["../../src/services/generationTimingService.ts"],"sourcesContent":["/**\r\n * Generation Timing Service\r\n * Tracks and stores timing data for content generation analytics\r\n */\r\n\r\nimport { collection, addDoc, Timestamp } from 'firebase/firestore';\r\nimport { db, auth } from '../firebase';\r\n\r\nexport interface GenerationTimingData {\r\n    userId: string;\r\n    userEmail?: string;\r\n    courseId: string;\r\n    unitId: string;\r\n    productType: 'lesson' | 'activity' | 'exam' | 'podcast';\r\n    sourceType: 'text' | 'youtube' | 'pdf' | 'url' | 'manual';\r\n    sourceLength: number;\r\n    stepCount: number;\r\n    timings: {\r\n        total: number;\r\n        skeleton: number;\r\n        contentGeneration: number;\r\n        perStepAverage: number;\r\n        imageGeneration?: number;\r\n        enrichment?: number;\r\n    };\r\n    success: boolean;\r\n    errorMessage?: string;\r\n    model?: string;\r\n}\r\n\r\n/**\r\n * Detect source type from course/wizard data\r\n */\r\nexport const detectSourceType = (course: any): 'text' | 'youtube' | 'pdf' | 'url' | 'manual' => {\r\n    const wizardData = course?.wizardData;\r\n\r\n    if (wizardData?.youtubeUrl || wizardData?.youtubeVideoId) {\r\n        return 'youtube';\r\n    }\r\n\r\n    if (wizardData?.uploadedFileName?.toLowerCase().endsWith('.pdf') || course?.sourceFileName?.toLowerCase().endsWith('.pdf')) {\r\n        return 'pdf';\r\n    }\r\n\r\n    if (wizardData?.sourceUrl || wizardData?.webUrl) {\r\n        return 'url';\r\n    }\r\n\r\n    if (wizardData?.pastedText || course?.fullBookContent) {\r\n        return 'text';\r\n    }\r\n\r\n    return 'manual';\r\n};\r\n\r\n/**\r\n * Get source content length\r\n */\r\nexport const getSourceLength = (course: any): number => {\r\n    const wizardData = course?.wizardData;\r\n\r\n    // For YouTube, return video duration if available (in seconds)\r\n    if (wizardData?.videoDuration) {\r\n        return wizardData.videoDuration;\r\n    }\r\n\r\n    // For text content, return character count\r\n    const textContent = course?.fullBookContent || wizardData?.pastedText || '';\r\n    return textContent.length;\r\n};\r\n\r\n/**\r\n * Save generation timing data to Firestore\r\n */\r\nexport const saveGenerationTiming = async (data: GenerationTimingData): Promise<void> => {\r\n    try {\r\n        const timingsRef = collection(db, 'generationTimings');\r\n\r\n        await addDoc(timingsRef, {\r\n            ...data,\r\n            createdAt: Timestamp.now(),\r\n            model: data.model || 'gemini-3-pro-preview',\r\n        });\r\n\r\n        console.log('⏱️ [Timing] Saved generation timing:', {\r\n            productType: data.productType,\r\n            total: `${(data.timings.total / 1000).toFixed(1)}s`,\r\n            skeleton: `${(data.timings.skeleton / 1000).toFixed(1)}s`,\r\n            content: `${(data.timings.contentGeneration / 1000).toFixed(1)}s`,\r\n        });\r\n    } catch (error) {\r\n        // Don't throw - timing is non-critical\r\n        console.warn('⏱️ [Timing] Failed to save timing data:', error);\r\n    }\r\n};\r\n\r\n/**\r\n * Helper class to track timing during generation\r\n */\r\nexport class GenerationTimer {\r\n    private startTime: number;\r\n    private marks: Record<string, number> = {};\r\n    private courseId: string;\r\n    private unitId: string;\r\n    private productType: 'lesson' | 'activity' | 'exam' | 'podcast';\r\n    private sourceType: 'text' | 'youtube' | 'pdf' | 'url' | 'manual';\r\n    private sourceLength: number;\r\n    private stepCount: number = 0;\r\n\r\n    constructor(\r\n        courseId: string,\r\n        unitId: string,\r\n        productType: 'lesson' | 'activity' | 'exam' | 'podcast',\r\n        course: any\r\n    ) {\r\n        this.startTime = performance.now();\r\n        this.courseId = courseId;\r\n        this.unitId = unitId;\r\n        this.productType = productType;\r\n        this.sourceType = detectSourceType(course);\r\n        this.sourceLength = getSourceLength(course);\r\n\r\n        console.log(`⏱️ [Timing] Started timer for ${productType} generation`);\r\n    }\r\n\r\n    /**\r\n     * Mark a checkpoint\r\n     */\r\n    mark(name: string): void {\r\n        this.marks[name] = performance.now();\r\n        const elapsed = this.marks[name] - this.startTime;\r\n        console.log(`⏱️ [Timing] ${name}: ${(elapsed / 1000).toFixed(2)}s`);\r\n    }\r\n\r\n    /**\r\n     * Get duration between two marks (or from start)\r\n     */\r\n    getDuration(fromMark?: string, toMark?: string): number {\r\n        const from = fromMark ? this.marks[fromMark] : this.startTime;\r\n        const to = toMark ? this.marks[toMark] : performance.now();\r\n        return to - from;\r\n    }\r\n\r\n    /**\r\n     * Set step count\r\n     */\r\n    setStepCount(count: number): void {\r\n        this.stepCount = count;\r\n    }\r\n\r\n    /**\r\n     * Finish and save timing data\r\n     */\r\n    async finish(success: boolean, errorMessage?: string): Promise<void> {\r\n        const endTime = performance.now();\r\n        const total = endTime - this.startTime;\r\n\r\n        const skeletonEnd = this.marks['skeleton_complete'] || this.marks['placeholders_ready'] || this.startTime;\r\n        const contentEnd = this.marks['content_complete'] || endTime;\r\n\r\n        const skeleton = skeletonEnd - this.startTime;\r\n        const contentGeneration = contentEnd - skeletonEnd;\r\n        const imageGeneration = this.marks['image_complete'] ?\r\n            this.marks['image_complete'] - (this.marks['image_start'] || skeletonEnd) : undefined;\r\n\r\n        const user = auth.currentUser;\r\n\r\n        // Build timing data - filter out undefined values for Firestore compatibility\r\n        const timingData: GenerationTimingData = {\r\n            userId: user?.uid || 'anonymous',\r\n            ...(user?.email && { userEmail: user.email }),\r\n            courseId: this.courseId,\r\n            unitId: this.unitId,\r\n            productType: this.productType,\r\n            sourceType: this.sourceType,\r\n            sourceLength: this.sourceLength,\r\n            stepCount: this.stepCount,\r\n            timings: {\r\n                total,\r\n                skeleton,\r\n                contentGeneration,\r\n                perStepAverage: this.stepCount > 0 ? contentGeneration / this.stepCount : 0,\r\n                ...(imageGeneration !== undefined && { imageGeneration }),\r\n            },\r\n            success,\r\n            ...(errorMessage && { errorMessage }),\r\n        };\r\n\r\n        // Log summary to console\r\n        console.log(`⏱️ [Timing] === Generation Complete ===`);\r\n        console.log(`⏱️ [Timing] Product: ${this.productType}`);\r\n        console.log(`⏱️ [Timing] Source: ${this.sourceType} (${this.sourceLength} chars)`);\r\n        console.log(`⏱️ [Timing] Steps: ${this.stepCount}`);\r\n        console.log(`⏱️ [Timing] Total: ${(total / 1000).toFixed(2)}s`);\r\n        console.log(`⏱️ [Timing] - Skeleton: ${(skeleton / 1000).toFixed(2)}s`);\r\n        console.log(`⏱️ [Timing] - Content: ${(contentGeneration / 1000).toFixed(2)}s`);\r\n        if (imageGeneration) {\r\n            console.log(`⏱️ [Timing] - Images: ${(imageGeneration / 1000).toFixed(2)}s`);\r\n        }\r\n        console.log(`⏱️ [Timing] - Per Step Avg: ${(timingData.timings.perStepAverage / 1000).toFixed(2)}s`);\r\n        console.log(`⏱️ [Timing] Success: ${success}`);\r\n        console.log(`⏱️ [Timing] ========================`);\r\n\r\n        // Save to Firestore\r\n        await saveGenerationTiming(timingData);\r\n    }\r\n}\r\n"],"names":["detectSourceType","course","wizardData","_a","_b","getSourceLength","saveGenerationTiming","data","timingsRef","collection","db","addDoc","Timestamp","error","GenerationTimer","courseId","unitId","productType","__publicField","name","elapsed","fromMark","toMark","from","count","success","errorMessage","endTime","total","skeletonEnd","contentEnd","skeleton","contentGeneration","imageGeneration","user","auth","timingData"],"mappings":"2OAiCO,MAAMA,EAAoBC,GAA+D,SAC5F,MAAMC,EAAaD,GAAA,YAAAA,EAAQ,WAE3B,OAAIC,GAAA,MAAAA,EAAY,YAAcA,GAAA,MAAAA,EAAY,eAC/B,WAGPC,EAAAD,GAAA,YAAAA,EAAY,mBAAZ,MAAAC,EAA8B,cAAc,SAAS,UAAWC,EAAAH,GAAA,YAAAA,EAAQ,iBAAR,MAAAG,EAAwB,cAAc,SAAS,QACxG,MAGPF,GAAA,MAAAA,EAAY,WAAaA,GAAA,MAAAA,EAAY,OAC9B,MAGPA,GAAA,MAAAA,EAAY,YAAcD,GAAA,MAAAA,EAAQ,gBAC3B,OAGJ,QACX,EAKaI,EAAmBJ,GAAwB,CACpD,MAAMC,EAAaD,GAAA,YAAAA,EAAQ,WAG3B,OAAIC,GAAA,MAAAA,EAAY,cACLA,EAAW,gBAIFD,GAAA,YAAAA,EAAQ,mBAAmBC,GAAA,YAAAA,EAAY,aAAc,IACtD,MACvB,EAKaI,EAAuB,MAAOC,GAA8C,CACrF,GAAI,CACA,MAAMC,EAAaC,EAAWC,EAAI,mBAAmB,EAErD,MAAMC,EAAOH,EAAY,CACrB,GAAGD,EACH,UAAWK,EAAU,IAAA,EACrB,MAAOL,EAAK,OAAS,sBAAA,CACxB,EAED,QAAQ,IAAI,uCAAwC,CAChD,YAAaA,EAAK,YAClB,MAAO,IAAIA,EAAK,QAAQ,MAAQ,KAAM,QAAQ,CAAC,CAAC,IAChD,SAAU,IAAIA,EAAK,QAAQ,SAAW,KAAM,QAAQ,CAAC,CAAC,IACtD,QAAS,IAAIA,EAAK,QAAQ,kBAAoB,KAAM,QAAQ,CAAC,CAAC,GAAA,CACjE,CACL,OAASM,EAAO,CAEZ,QAAQ,KAAK,0CAA2CA,CAAK,CACjE,CACJ,EAKO,MAAMC,CAAgB,CAUzB,YACIC,EACAC,EACAC,EACAhB,EACF,CAdMiB,EAAA,kBACAA,EAAA,aAAgC,CAAA,GAChCA,EAAA,iBACAA,EAAA,eACAA,EAAA,oBACAA,EAAA,mBACAA,EAAA,qBACAA,EAAA,iBAAoB,GAQxB,KAAK,UAAY,YAAY,IAAA,EAC7B,KAAK,SAAWH,EAChB,KAAK,OAASC,EACd,KAAK,YAAcC,EACnB,KAAK,WAAajB,EAAiBC,CAAM,EACzC,KAAK,aAAeI,EAAgBJ,CAAM,EAE1C,QAAQ,IAAI,iCAAiCgB,CAAW,aAAa,CACzE,CAKA,KAAKE,EAAoB,CACrB,KAAK,MAAMA,CAAI,EAAI,YAAY,IAAA,EAC/B,MAAMC,EAAU,KAAK,MAAMD,CAAI,EAAI,KAAK,UACxC,QAAQ,IAAI,eAAeA,CAAI,MAAMC,EAAU,KAAM,QAAQ,CAAC,CAAC,GAAG,CACtE,CAKA,YAAYC,EAAmBC,EAAyB,CACpD,MAAMC,EAAOF,EAAW,KAAK,MAAMA,CAAQ,EAAI,KAAK,UAEpD,OADWC,EAAS,KAAK,MAAMA,CAAM,EAAI,YAAY,IAAA,GACzCC,CAChB,CAKA,aAAaC,EAAqB,CAC9B,KAAK,UAAYA,CACrB,CAKA,MAAM,OAAOC,EAAkBC,EAAsC,CACjE,MAAMC,EAAU,YAAY,IAAA,EACtBC,EAAQD,EAAU,KAAK,UAEvBE,EAAc,KAAK,MAAM,mBAAwB,KAAK,MAAM,oBAAyB,KAAK,UAC1FC,EAAa,KAAK,MAAM,kBAAuBH,EAE/CI,EAAWF,EAAc,KAAK,UAC9BG,EAAoBF,EAAaD,EACjCI,EAAkB,KAAK,MAAM,eAC/B,KAAK,MAAM,gBAAqB,KAAK,MAAM,aAAkBJ,GAAe,OAE1EK,EAAOC,EAAK,YAGZC,EAAmC,CACrC,QAAQF,GAAA,YAAAA,EAAM,MAAO,YACrB,IAAIA,GAAA,YAAAA,EAAM,QAAS,CAAE,UAAWA,EAAK,KAAA,EACrC,SAAU,KAAK,SACf,OAAQ,KAAK,OACb,YAAa,KAAK,YAClB,WAAY,KAAK,WACjB,aAAc,KAAK,aACnB,UAAW,KAAK,UAChB,QAAS,CACL,MAAAN,EACA,SAAAG,EACA,kBAAAC,EACA,eAAgB,KAAK,UAAY,EAAIA,EAAoB,KAAK,UAAY,EAC1E,GAAIC,IAAoB,QAAa,CAAE,gBAAAA,CAAA,CAAgB,EAE3D,QAAAR,EACA,GAAIC,GAAgB,CAAE,aAAAA,CAAA,CAAa,EAIvC,QAAQ,IAAI,yCAAyC,EACrD,QAAQ,IAAI,wBAAwB,KAAK,WAAW,EAAE,EACtD,QAAQ,IAAI,uBAAuB,KAAK,UAAU,KAAK,KAAK,YAAY,SAAS,EACjF,QAAQ,IAAI,sBAAsB,KAAK,SAAS,EAAE,EAClD,QAAQ,IAAI,uBAAuBE,EAAQ,KAAM,QAAQ,CAAC,CAAC,GAAG,EAC9D,QAAQ,IAAI,4BAA4BG,EAAW,KAAM,QAAQ,CAAC,CAAC,GAAG,EACtE,QAAQ,IAAI,2BAA2BC,EAAoB,KAAM,QAAQ,CAAC,CAAC,GAAG,EAC1EC,GACA,QAAQ,IAAI,0BAA0BA,EAAkB,KAAM,QAAQ,CAAC,CAAC,GAAG,EAE/E,QAAQ,IAAI,gCAAgCG,EAAW,QAAQ,eAAiB,KAAM,QAAQ,CAAC,CAAC,GAAG,EACnG,QAAQ,IAAI,wBAAwBX,CAAO,EAAE,EAC7C,QAAQ,IAAI,sCAAsC,EAGlD,MAAMnB,EAAqB8B,CAAU,CACzC,CACJ"}