{"version":3,"mappings":"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","names":["ALLOWED_WIZDI_ORIGINS","validatedParentOrigin","isAllowedOrigin","origin","url","getTargetOrigin","referrer","referrerOrigin","isEmbeddedInWizdi","getWizdiParams","params","sendToWizdi","type","payload","event","targetOrigin","error","notifyApplicationLoaded","userId","isTeacher","notifyError","code","message","context","commandHandlers","onWizdiCommand","handler","h","initWizdiListener","handleMessage","data","React","__vitePreload","n","WizdiEmbed","view","loading","setLoading","useState","setError","userData","setUserData","isAuthenticated","setIsAuthenticated","useEffect","token","locale","cleanupListener","unsubscribeCommands","command","handleWizdiCommand","authenticateUser","signInWithCustomToken","auth","wizdiUserDoc","getDoc","doc","db","userDoc","err","jsx","jsxs","WizdiTeacherView","WizdiStudentView","StatCard","title","value","icon","WizdiRoutes","Routes","Route","WizdiTaskView","WizdiCourseView","Navigate","taskId","pathParts","courseId"],"ignoreList":[],"sources":["../../src/services/wizdiIntegration.ts","../../src/components/wizdi/WizdiEmbed.tsx","../../src/components/wizdi/WizdiRouter.tsx"],"sourcesContent":["/**\r\n * Wizdi Integration Service\r\n * Handles postMessage communication with Wizdi parent window\r\n *\r\n * SECURITY: This module implements secure postMessage communication\r\n * with origin validation to prevent cross-origin attacks.\r\n */\r\n\r\n// Allowed origins for Wizdi communication\r\n// IMPORTANT: Update this list with actual Wizdi production domains\r\nconst ALLOWED_WIZDI_ORIGINS: string[] = [\r\n  'https://wizdi.co.il',\r\n  'https://www.wizdi.co.il',\r\n  'https://app.wizdi.co.il',\r\n  'https://staging.wizdi.co.il',\r\n  // Development origins (remove in production)\r\n  'http://localhost:3000',\r\n  'http://localhost:5173',\r\n];\r\n\r\n// Cache the parent origin after first successful validation\r\nlet validatedParentOrigin: string | null = null;\r\n\r\n/**\r\n * Validate if an origin is allowed for Wizdi communication\r\n */\r\nfunction isAllowedOrigin(origin: string): boolean {\r\n  // Check exact match first\r\n  if (ALLOWED_WIZDI_ORIGINS.includes(origin)) {\r\n    return true;\r\n  }\r\n\r\n  // Allow any wizdi.co.il subdomain\r\n  try {\r\n    const url = new URL(origin);\r\n    if (url.hostname.endsWith('.wizdi.co.il') || url.hostname === 'wizdi.co.il') {\r\n      return true;\r\n    }\r\n  } catch {\r\n    return false;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Get the target origin for postMessage\r\n * Returns the validated parent origin or throws if not validated\r\n */\r\nfunction getTargetOrigin(): string {\r\n  if (validatedParentOrigin) {\r\n    return validatedParentOrigin;\r\n  }\r\n\r\n  // If we haven't validated yet, try to get referrer\r\n  try {\r\n    const referrer = document.referrer;\r\n    if (referrer) {\r\n      const referrerOrigin = new URL(referrer).origin;\r\n      if (isAllowedOrigin(referrerOrigin)) {\r\n        validatedParentOrigin = referrerOrigin;\r\n        return referrerOrigin;\r\n      }\r\n    }\r\n  } catch {\r\n    // Referrer parsing failed\r\n  }\r\n\r\n  // Fallback: use wildcard but log warning\r\n  // This is less secure but prevents breaking existing integrations\r\n  console.warn('[Wizdi Security] Could not validate parent origin, using wildcard. Please ensure ALLOWED_WIZDI_ORIGINS is configured correctly.');\r\n  return '*';\r\n}\r\n\r\n// Event types that we send to Wizdi\r\nexport type WizdiEventType =\r\n  | 'APPLICATION_LOADED'\r\n  | 'TASK_STARTED'\r\n  | 'TASK_PROGRESS'\r\n  | 'TASK_COMPLETED'\r\n  | 'TASK_SUBMITTED'\r\n  | 'GRADE_UPDATED'\r\n  | 'XP_EARNED'\r\n  | 'ACHIEVEMENT_UNLOCKED'\r\n  | 'COURSE_CREATED'\r\n  | 'TASK_ASSIGNED'\r\n  | 'CLOSE_EVENT'\r\n  | 'ERROR';\r\n\r\n// Command types that we receive from Wizdi\r\nexport type WizdiCommandType =\r\n  | 'NAVIGATE_TO_TASK'\r\n  | 'NAVIGATE_TO_COURSE'\r\n  | 'REFRESH_DATA';\r\n\r\nexport interface WizdiEvent<T = any> {\r\n  source: 'ai-lms-system';\r\n  type: WizdiEventType;\r\n  payload: T;\r\n}\r\n\r\nexport interface WizdiCommand {\r\n  type: WizdiCommandType;\r\n  taskId?: string;\r\n  courseId?: string;\r\n  unitId?: string;\r\n}\r\n\r\n// Payload types\r\nexport interface ApplicationLoadedPayload {\r\n  userId: string;\r\n  isTeacher: boolean;\r\n  timestamp: string;\r\n}\r\n\r\nexport interface TaskStartedPayload {\r\n  taskId: string;\r\n  studentId: string;\r\n  courseId: string;\r\n  courseName: string;\r\n  taskTitle: string;\r\n  startedAt: string;\r\n}\r\n\r\nexport interface TaskProgressPayload {\r\n  taskId: string;\r\n  studentId: string;\r\n  progress: number;\r\n  currentStep: number;\r\n  totalSteps: number;\r\n  timeSpentSeconds: number;\r\n}\r\n\r\nexport interface TaskCompletedPayload {\r\n  taskId: string;\r\n  studentId: string;\r\n  submissionId: string;\r\n  score: number;\r\n  maxScore: number;\r\n  timeSpentSeconds: number;\r\n  completedAt: string;\r\n  analytics: {\r\n    correctAnswers: number;\r\n    totalQuestions: number;\r\n    hintsUsed: number;\r\n    averageTimePerQuestion: number;\r\n  };\r\n}\r\n\r\nexport interface GradeUpdatedPayload {\r\n  taskId: string;\r\n  studentId: string;\r\n  teacherId: string;\r\n  grade: number;\r\n  maxGrade: number;\r\n  feedback?: string;\r\n  gradedAt: string;\r\n}\r\n\r\nexport interface XpEarnedPayload {\r\n  studentId: string;\r\n  xpAmount: number;\r\n  totalXp: number;\r\n  reason: string;\r\n  level: number;\r\n}\r\n\r\nexport interface ErrorPayload {\r\n  code: string;\r\n  message: string;\r\n  context?: Record<string, any>;\r\n}\r\n\r\n/**\r\n * Check if we're running inside an iframe (embedded in Wizdi)\r\n */\r\nexport function isEmbeddedInWizdi(): boolean {\r\n  try {\r\n    return window.self !== window.top;\r\n  } catch (e) {\r\n    // If we can't access window.top, we're probably in an iframe\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if URL has Wizdi parameters\r\n */\r\nexport function hasWizdiParams(): boolean {\r\n  const params = new URLSearchParams(window.location.search);\r\n  return params.has('ctoken') && params.has('userId');\r\n}\r\n\r\n/**\r\n * Get Wizdi parameters from URL\r\n */\r\nexport function getWizdiParams(): { userId: string | null; token: string | null; locale: string } {\r\n  const params = new URLSearchParams(window.location.search);\r\n  return {\r\n    userId: params.get('userId'),\r\n    token: params.get('ctoken'),\r\n    locale: params.get('locale') || 'he'\r\n  };\r\n}\r\n\r\n/**\r\n * Send event to Wizdi parent window\r\n */\r\nexport function sendToWizdi<T>(type: WizdiEventType, payload: T): void {\r\n  if (!isEmbeddedInWizdi()) {\r\n    console.log('[Wizdi] Not embedded, skipping postMessage:', type, payload);\r\n    return;\r\n  }\r\n\r\n  const event: WizdiEvent<T> = {\r\n    source: 'ai-lms-system',\r\n    type,\r\n    payload\r\n  };\r\n\r\n  try {\r\n    const targetOrigin = getTargetOrigin();\r\n    window.parent.postMessage(event, targetOrigin);\r\n    console.log('[Wizdi] Sent event:', type, 'to origin:', targetOrigin);\r\n  } catch (error) {\r\n    console.error('[Wizdi] Failed to send event:', error);\r\n  }\r\n}\r\n\r\n// Convenience functions for each event type\r\n\r\nexport function notifyApplicationLoaded(userId: string, isTeacher: boolean): void {\r\n  sendToWizdi<ApplicationLoadedPayload>('APPLICATION_LOADED', {\r\n    userId,\r\n    isTeacher,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n}\r\n\r\nexport function notifyTaskStarted(\r\n  taskId: string,\r\n  studentId: string,\r\n  courseId: string,\r\n  courseName: string,\r\n  taskTitle: string\r\n): void {\r\n  sendToWizdi<TaskStartedPayload>('TASK_STARTED', {\r\n    taskId,\r\n    studentId,\r\n    courseId,\r\n    courseName,\r\n    taskTitle,\r\n    startedAt: new Date().toISOString()\r\n  });\r\n}\r\n\r\nexport function notifyTaskProgress(\r\n  taskId: string,\r\n  studentId: string,\r\n  progress: number,\r\n  currentStep: number,\r\n  totalSteps: number,\r\n  timeSpentSeconds: number\r\n): void {\r\n  sendToWizdi<TaskProgressPayload>('TASK_PROGRESS', {\r\n    taskId,\r\n    studentId,\r\n    progress,\r\n    currentStep,\r\n    totalSteps,\r\n    timeSpentSeconds\r\n  });\r\n}\r\n\r\nexport function notifyTaskCompleted(\r\n  taskId: string,\r\n  studentId: string,\r\n  submissionId: string,\r\n  score: number,\r\n  maxScore: number,\r\n  timeSpentSeconds: number,\r\n  analytics: TaskCompletedPayload['analytics']\r\n): void {\r\n  sendToWizdi<TaskCompletedPayload>('TASK_COMPLETED', {\r\n    taskId,\r\n    studentId,\r\n    submissionId,\r\n    score,\r\n    maxScore,\r\n    timeSpentSeconds,\r\n    completedAt: new Date().toISOString(),\r\n    analytics\r\n  });\r\n}\r\n\r\nexport function notifyTaskSubmitted(taskId: string, studentId: string, submissionId: string): void {\r\n  sendToWizdi('TASK_SUBMITTED', {\r\n    taskId,\r\n    studentId,\r\n    submissionId,\r\n    submittedAt: new Date().toISOString()\r\n  });\r\n}\r\n\r\nexport function notifyGradeUpdated(\r\n  taskId: string,\r\n  studentId: string,\r\n  teacherId: string,\r\n  grade: number,\r\n  maxGrade: number,\r\n  feedback?: string\r\n): void {\r\n  sendToWizdi<GradeUpdatedPayload>('GRADE_UPDATED', {\r\n    taskId,\r\n    studentId,\r\n    teacherId,\r\n    grade,\r\n    maxGrade,\r\n    feedback,\r\n    gradedAt: new Date().toISOString()\r\n  });\r\n}\r\n\r\nexport function notifyXpEarned(\r\n  studentId: string,\r\n  xpAmount: number,\r\n  totalXp: number,\r\n  reason: string,\r\n  level: number\r\n): void {\r\n  sendToWizdi<XpEarnedPayload>('XP_EARNED', {\r\n    studentId,\r\n    xpAmount,\r\n    totalXp,\r\n    reason,\r\n    level\r\n  });\r\n}\r\n\r\nexport function notifyAchievementUnlocked(\r\n  studentId: string,\r\n  achievementId: string,\r\n  achievementName: string,\r\n  description: string\r\n): void {\r\n  sendToWizdi('ACHIEVEMENT_UNLOCKED', {\r\n    studentId,\r\n    achievementId,\r\n    achievementName,\r\n    description\r\n  });\r\n}\r\n\r\nexport function notifyCourseCreated(\r\n  courseId: string,\r\n  teacherId: string,\r\n  title: string,\r\n  subject?: string,\r\n  gradeLevel?: string\r\n): void {\r\n  sendToWizdi('COURSE_CREATED', {\r\n    courseId,\r\n    teacherId,\r\n    title,\r\n    subject,\r\n    gradeLevel,\r\n    createdAt: new Date().toISOString()\r\n  });\r\n}\r\n\r\nexport function notifyTaskAssigned(\r\n  taskId: string,\r\n  teacherId: string,\r\n  courseId: string,\r\n  title: string,\r\n  assignedTo: 'all' | 'class' | 'group' | 'individual',\r\n  studentCount: number,\r\n  dueDate?: string\r\n): void {\r\n  sendToWizdi('TASK_ASSIGNED', {\r\n    taskId,\r\n    teacherId,\r\n    courseId,\r\n    title,\r\n    assignedTo,\r\n    studentCount,\r\n    dueDate\r\n  });\r\n}\r\n\r\nexport function notifyCloseEvent(userId: string, lastView: string, taskId?: string): void {\r\n  sendToWizdi('CLOSE_EVENT', {\r\n    userId,\r\n    lastView,\r\n    taskId\r\n  });\r\n}\r\n\r\nexport function notifyError(code: string, message: string, context?: Record<string, any>): void {\r\n  sendToWizdi<ErrorPayload>('ERROR', {\r\n    code,\r\n    message,\r\n    context\r\n  });\r\n}\r\n\r\n/**\r\n * Command handler type\r\n */\r\ntype CommandHandler = (command: WizdiCommand) => void;\r\n\r\nlet commandHandlers: CommandHandler[] = [];\r\n\r\n/**\r\n * Subscribe to commands from Wizdi\r\n */\r\nexport function onWizdiCommand(handler: CommandHandler): () => void {\r\n  commandHandlers.push(handler);\r\n\r\n  // Return unsubscribe function\r\n  return () => {\r\n    commandHandlers = commandHandlers.filter(h => h !== handler);\r\n  };\r\n}\r\n\r\n/**\r\n * Initialize Wizdi message listener\r\n * Call this once at app startup\r\n *\r\n * SECURITY: This listener validates the origin of incoming messages\r\n * to prevent cross-origin attacks from malicious websites.\r\n */\r\nexport function initWizdiListener(): () => void {\r\n  const handleMessage = (event: MessageEvent) => {\r\n    // SECURITY: Validate origin before processing any message\r\n    if (!isAllowedOrigin(event.origin)) {\r\n      // Silently ignore messages from unknown origins\r\n      // Don't log to avoid console spam from legitimate browser extensions etc.\r\n      return;\r\n    }\r\n\r\n    // Cache the validated origin for outbound messages\r\n    if (!validatedParentOrigin && event.origin) {\r\n      validatedParentOrigin = event.origin;\r\n      console.log('[Wizdi] Validated parent origin:', event.origin);\r\n    }\r\n\r\n    const data = event.data as WizdiCommand;\r\n\r\n    // Validate message structure\r\n    if (!data || typeof data !== 'object' || !data.type) {\r\n      return;\r\n    }\r\n\r\n    // Check if it's a command we recognize\r\n    const validCommands: WizdiCommandType[] = [\r\n      'NAVIGATE_TO_TASK',\r\n      'NAVIGATE_TO_COURSE',\r\n      'REFRESH_DATA'\r\n    ];\r\n\r\n    if (validCommands.includes(data.type as WizdiCommandType)) {\r\n      console.log('[Wizdi] Received command:', data.type, 'from:', event.origin);\r\n\r\n      // Additional validation for navigation commands\r\n      if (data.type === 'NAVIGATE_TO_TASK' && data.taskId) {\r\n        // Validate taskId format (alphanumeric and common ID chars only)\r\n        if (!/^[a-zA-Z0-9_-]{1,100}$/.test(data.taskId)) {\r\n          console.warn('[Wizdi Security] Invalid taskId format received');\r\n          return;\r\n        }\r\n      }\r\n\r\n      if (data.type === 'NAVIGATE_TO_COURSE') {\r\n        if (data.courseId && !/^[a-zA-Z0-9_-]{1,100}$/.test(data.courseId)) {\r\n          console.warn('[Wizdi Security] Invalid courseId format received');\r\n          return;\r\n        }\r\n        if (data.unitId && !/^[a-zA-Z0-9_-]{1,100}$/.test(data.unitId)) {\r\n          console.warn('[Wizdi Security] Invalid unitId format received');\r\n          return;\r\n        }\r\n      }\r\n\r\n      commandHandlers.forEach(handler => handler(data));\r\n    }\r\n  };\r\n\r\n  window.addEventListener('message', handleMessage);\r\n\r\n  console.log('[Wizdi] Message listener initialized with origin validation');\r\n\r\n  // Return cleanup function\r\n  return () => {\r\n    window.removeEventListener('message', handleMessage);\r\n    validatedParentOrigin = null; // Reset on cleanup\r\n  };\r\n}\r\n\r\n/**\r\n * Wizdi context for React components\r\n */\r\nexport interface WizdiContext {\r\n  isEmbedded: boolean;\r\n  userId: string | null;\r\n  token: string | null;\r\n  locale: string;\r\n}\r\n\r\nexport function getWizdiContext(): WizdiContext {\r\n  const params = getWizdiParams();\r\n  return {\r\n    isEmbedded: isEmbeddedInWizdi() && hasWizdiParams(),\r\n    userId: params.userId,\r\n    token: params.token,\r\n    locale: params.locale\r\n  };\r\n}\r\n","/**\r\n * Wizdi Embed Component\r\n * Wrapper component for embedding our app in Wizdi's iframe\r\n */\r\n\r\nimport React, { useEffect, useState } from 'react';\r\nimport { signInWithCustomToken } from 'firebase/auth';\r\nimport { auth, db } from '../../firebase';\r\nimport { doc, getDoc } from 'firebase/firestore';\r\nimport {\r\n  getWizdiParams,\r\n  initWizdiListener,\r\n  notifyApplicationLoaded,\r\n  notifyError,\r\n  onWizdiCommand\r\n} from '../../services/wizdiIntegration';\r\nimport type { WizdiCommand } from '../../services/wizdiIntegration';\r\n\r\n// Lazy load the actual components\r\nconst StudentHome = React.lazy(() => import('../StudentHome'));\r\nconst TeacherDashboard = React.lazy(() => import('../TeacherDashboard'));\r\n\r\ninterface WizdiEmbedProps {\r\n  view: 'teacher' | 'student';\r\n}\r\n\r\ninterface WizdiUserData {\r\n  id: string;\r\n  isTeacher: boolean;\r\n  displayName?: string;\r\n  locale: string;\r\n  schoolId?: string;\r\n  classes: Array<{ id: string; name: string }>;\r\n}\r\n\r\nexport const WizdiEmbed: React.FC<WizdiEmbedProps> = ({ view }) => {\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [userData, setUserData] = useState<WizdiUserData | null>(null);\r\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const { userId, token, locale } = getWizdiParams();\r\n\r\n    if (!userId || !token) {\r\n      setError('住专 驻专专 专砖 (userId, ctoken)');\r\n      setLoading(false);\r\n      notifyError('MISSING_PARAMS', 'Missing userId or ctoken');\r\n      return;\r\n    }\r\n\r\n    // Initialize Wizdi message listener\r\n    const cleanupListener = initWizdiListener();\r\n\r\n    // Subscribe to commands from Wizdi\r\n    const unsubscribeCommands = onWizdiCommand((command: WizdiCommand) => {\r\n      handleWizdiCommand(command);\r\n    });\r\n\r\n    // Authenticate with Firebase\r\n    authenticateUser(token, userId, locale);\r\n\r\n    return () => {\r\n      cleanupListener();\r\n      unsubscribeCommands();\r\n    };\r\n  }, []);\r\n\r\n  const authenticateUser = async (token: string, userId: string, locale: string) => {\r\n    try {\r\n      // Try to sign in with the custom token from Wizdi\r\n      await signInWithCustomToken(auth, token);\r\n\r\n      // Get user data from Firestore\r\n      const wizdiUserDoc = await getDoc(doc(db, 'wizdi_users', userId));\r\n\r\n      if (wizdiUserDoc.exists()) {\r\n        const data = wizdiUserDoc.data();\r\n        setUserData({\r\n          id: userId,\r\n          isTeacher: data.isTeacher,\r\n          displayName: data.displayName,\r\n          locale: data.locale || locale,\r\n          schoolId: data.schoolId,\r\n          classes: data.classes || []\r\n        });\r\n      } else {\r\n        // Fallback: try regular users collection\r\n        const userDoc = await getDoc(doc(db, 'users', userId));\r\n        if (userDoc.exists()) {\r\n          const data = userDoc.data();\r\n          setUserData({\r\n            id: userId,\r\n            isTeacher: view === 'teacher',\r\n            displayName: data.displayName,\r\n            locale,\r\n            classes: []\r\n          });\r\n        } else {\r\n          // User not found but token is valid - create minimal user data\r\n          setUserData({\r\n            id: userId,\r\n            isTeacher: view === 'teacher',\r\n            locale,\r\n            classes: []\r\n          });\r\n        }\r\n      }\r\n\r\n      setIsAuthenticated(true);\r\n      setLoading(false);\r\n\r\n      // Notify Wizdi that we're loaded\r\n      notifyApplicationLoaded(userId, view === 'teacher');\r\n\r\n    } catch (err: any) {\r\n      console.error('Wizdi auth error:', err);\r\n\r\n      // Check if it's a token error\r\n      if (err.code === 'auth/invalid-custom-token' || err.code === 'auth/custom-token-mismatch') {\r\n        setError('拽  转拽  驻 转拽祝');\r\n        notifyError('TOKEN_EXPIRED', 'Invalid or expired token');\r\n      } else {\r\n        setError('砖 转: ' + err.message);\r\n        notifyError('INTERNAL_ERROR', err.message);\r\n      }\r\n\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleWizdiCommand = (command: WizdiCommand) => {\r\n    console.log('[WizdiEmbed] Received command:', command);\r\n\r\n    switch (command.type) {\r\n      case 'NAVIGATE_TO_TASK':\r\n        if (command.taskId) {\r\n          // Navigate to specific task - this would need routing integration\r\n          window.location.hash = `#task=${command.taskId}`;\r\n        }\r\n        break;\r\n\r\n      case 'NAVIGATE_TO_COURSE':\r\n        if (command.courseId) {\r\n          window.location.hash = `#course=${command.courseId}`;\r\n        }\r\n        break;\r\n\r\n      case 'REFRESH_DATA':\r\n        // Trigger a refresh - could use a context or state update\r\n        window.location.reload();\r\n        break;\r\n    }\r\n  };\r\n\r\n  // Loading state\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-slate-50\" dir=\"rtl\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\r\n          <p className=\"text-slate-600\">注...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Error state\r\n  if (error) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-slate-50\" dir=\"rtl\">\r\n        <div className=\"bg-white p-8 rounded-xl shadow-lg max-w-md text-center\">\r\n          <div className=\"text-red-500 text-5xl mb-4\">锔</div>\r\n          <h2 className=\"text-xl font-bold text-slate-800 mb-2\">砖</h2>\r\n          <p className=\"text-slate-600 mb-4\">{error}</p>\r\n          <p className=\"text-sm text-slate-400\">\r\n             住 注 砖  驻 转\r\n          </p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Not authenticated\r\n  if (!isAuthenticated || !userData) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-slate-50\" dir=\"rtl\">\r\n        <div className=\"bg-white p-8 rounded-xl shadow-lg max-w-md text-center\">\r\n          <div className=\"text-yellow-500 text-5xl mb-4\"></div>\r\n          <h2 className=\"text-xl font-bold text-slate-800 mb-2\">转 专砖</h2>\r\n          <p className=\"text-slate-600\">\r\n             转专 专 Wizdi  砖转 注专转\r\n          </p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Render the appropriate view\r\n  return (\r\n    <div className=\"wizdi-embed-container\" dir=\"rtl\">\r\n      <React.Suspense\r\n        fallback={\r\n          <div className=\"min-h-screen flex items-center justify-center\">\r\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n          </div>\r\n        }\r\n      >\r\n        {view === 'teacher' ? (\r\n          <WizdiTeacherView userData={userData} />\r\n        ) : (\r\n          <WizdiStudentView userData={userData} />\r\n        )}\r\n      </React.Suspense>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Teacher view wrapper\r\nconst WizdiTeacherView: React.FC<{ userData: WizdiUserData }> = ({ userData }) => {\r\n  return (\r\n    <div className=\"wizdi-teacher-view\">\r\n      {/*\r\n        Here we would render the TeacherDashboard with Wizdi context\r\n        For now, showing a placeholder that explains what will be shown\r\n      */}\r\n      <div className=\"p-6\">\r\n        <div className=\"bg-white rounded-xl shadow-lg p-6 mb-6\">\r\n          <h1 className=\"text-2xl font-bold text-slate-800 mb-2\">\r\n            砖, {userData.displayName || '专'}\r\n          </h1>\r\n          <p className=\"text-slate-600\">\r\n            专  注专转  \r\n          </p>\r\n        </div>\r\n\r\n        {/* Quick stats for teacher */}\r\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\r\n          <StatCard title=\"拽专住\" value=\"-\" icon=\"\" />\r\n          <StatCard title=\"转\" value=\"-\" icon=\"\" />\r\n          <StatCard title=\"砖转 砖注\" value=\"-\" icon=\"\" />\r\n          <StatCard title=\"砖转 转转\" value=\"-\" icon=\"\" />\r\n        </div>\r\n\r\n        {/*\r\n          In full implementation, render:\r\n          <TeacherDashboard wizdiMode={true} wizdiUser={userData} />\r\n        */}\r\n        <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4 text-center\">\r\n          <p className=\"text-blue-700\">\r\n            砖专  爪  -   拽专住, 注拽 转, 转 住住\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Student view wrapper\r\nconst WizdiStudentView: React.FC<{ userData: WizdiUserData }> = ({ userData }) => {\r\n  return (\r\n    <div className=\"wizdi-student-view\">\r\n      <div className=\"p-6\">\r\n        <div className=\"bg-white rounded-xl shadow-lg p-6 mb-6\">\r\n          <h1 className=\"text-2xl font-bold text-slate-800 mb-2\">\r\n            砖, {userData.displayName || '转'}\r\n          </h1>\r\n          <p className=\"text-slate-600\">\r\n            砖转 砖 转转 \r\n          </p>\r\n        </div>\r\n\r\n        {/* Quick stats for student */}\r\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\r\n          <StatCard title=\"砖转 驻转转\" value=\"-\" icon=\"\" />\r\n          <StatCard title=\"爪 爪注\" value=\"-\" icon=\"猸\" />\r\n          <StatCard title=\"拽转 XP\" value=\"-\" icon=\"\" />\r\n          <StatCard title=\" 专爪祝\" value=\"-\" icon=\"\" />\r\n        </div>\r\n\r\n        {/*\r\n          In full implementation, render:\r\n          <StudentHome wizdiMode={true} wizdiUser={userData} />\r\n        */}\r\n        <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 text-center\">\r\n          <p className=\"text-green-700\">\r\n            专砖转 砖转 砖 转爪  -  砖转 驻转转, 转拽转, 爪\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Reusable stat card component\r\nconst StatCard: React.FC<{ title: string; value: string; icon: string }> = ({ title, value, icon }) => (\r\n  <div className=\"bg-white rounded-lg shadow p-4 text-center\">\r\n    <div className=\"text-2xl mb-1\">{icon}</div>\r\n    <div className=\"text-2xl font-bold text-slate-800\">{value}</div>\r\n    <div className=\"text-sm text-slate-500\">{title}</div>\r\n  </div>\r\n);\r\n\r\nexport default WizdiEmbed;\r\n","/**\n * Wizdi Router Component\n * Handles routing for Wizdi embed pages\n */\n\nimport React from 'react';\nimport { Routes, Route, Navigate } from 'react-router-dom';\nimport WizdiEmbed from './WizdiEmbed';\n\n/**\n * Wizdi Routes\n *\n * /wizdi/teacher - Teacher dashboard embed\n * /wizdi/student - Student dashboard embed\n * /wizdi/task/:taskId - Specific task view\n * /wizdi/course/:courseId - Course viewer\n */\nexport const WizdiRoutes: React.FC = () => {\n  return (\n    <Routes>\n      {/* Teacher view */}\n      <Route path=\"teacher\" element={<WizdiEmbed view=\"teacher\" />} />\n\n      {/* Student view */}\n      <Route path=\"student\" element={<WizdiEmbed view=\"student\" />} />\n\n      {/* Task view - shows specific task */}\n      <Route path=\"task/:taskId\" element={<WizdiTaskView />} />\n\n      {/* Course view */}\n      <Route path=\"course/:courseId\" element={<WizdiCourseView />} />\n\n      {/* Default redirect */}\n      <Route path=\"*\" element={<Navigate to=\"student\" replace />} />\n    </Routes>\n  );\n};\n\n/**\n * Task View for Wizdi\n * Shows a specific task in embed mode\n */\nconst WizdiTaskView: React.FC = () => {\n  // Get taskId from URL params\n  const taskId = window.location.pathname.split('/').pop();\n\n  return (\n    <div className=\"wizdi-task-view\" dir=\"rtl\">\n      <div className=\"min-h-screen bg-slate-50 p-6\">\n        <div className=\"bg-white rounded-xl shadow-lg p-6\">\n          <h2 className=\"text-xl font-bold text-slate-800 mb-4\">\n            砖: {taskId}\n          </h2>\n          <p className=\"text-slate-600\">\n            转爪转 砖 转注 \n          </p>\n          {/*\n            In full implementation:\n            <TaskPlayer taskId={taskId} wizdiMode={true} />\n          */}\n        </div>\n      </div>\n    </div>\n  );\n};\n\n/**\n * Course View for Wizdi\n * Shows course content in embed mode\n */\nconst WizdiCourseView: React.FC = () => {\n  const pathParts = window.location.pathname.split('/');\n  const courseId = pathParts[pathParts.indexOf('course') + 1];\n\n  return (\n    <div className=\"wizdi-course-view\" dir=\"rtl\">\n      <div className=\"min-h-screen bg-slate-50 p-6\">\n        <div className=\"bg-white rounded-xl shadow-lg p-6\">\n          <h2 className=\"text-xl font-bold text-slate-800 mb-4\">\n            拽专住: {courseId}\n          </h2>\n          <p className=\"text-slate-600\">\n            转 拽专住 注 \n          </p>\n          {/*\n            In full implementation:\n            <CoursePlayer courseId={courseId} wizdiMode={true} />\n          */}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default WizdiRoutes;\n"],"file":"assets/WizdiRouter-CAcOvrr7.js"}