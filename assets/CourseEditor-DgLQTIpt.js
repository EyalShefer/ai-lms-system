const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/generationTimingService-B4dIuwqG.js","assets/index-1x3sw4DL.js","assets/index-D5UJlrDR.css"])))=>i.map(i=>d[i]);
import{c as Vs,o as Hs,M as Ws,a as Mn,r as S,j as e,I as Ns,b as Xe,d as Ct,e as Os,f as sr,g as nr,h as rr,i as Rs,k as At,l as ar,m as ir,w as or,n as Cs,p as zt,s as lr,q as cr,t as dr,u as ur,v as mr,_ as Dn,x as ze,y as gr,z as pr,A as xr,B as hr,C as Js,D as Fn,E as On,F as vn,G as Rn,H as fr,J as zn,R as zs,K as yr,L as $s,N as Bs,O as Gn,T as Us,P as Ss,Q as vr,S as br,U as Ps,V as Lt,W as wr,X as Gs,Y as vs,Z as ct,$ as xt,a0 as jr,a1 as gs,a2 as bn,a3 as wn,a4 as Nr,a5 as Rt,a6 as Es,a7 as ps,a8 as _s,a9 as Cr,aa as Sr,ab as It,ac as bs,ad as xs,ae as ws,af as _r,ag as jn,ah as Ls,ai as As,aj as Ms,ak as kn,al as Nn,am as Tr,an as Ir,ao as $r,ap as Br,aq as Ur,ar as Pr,as as Er,at as Lr,au as Ar,av as Mr,aw as Dr,ax as Fr,ay as Or,az as Rr,aA as zr,aB as Gr,aC as qn,aD as kr,aE as qr,aF as Cn,aG as Vr,aH as ks,aI as Hr,aJ as Wr,aK as Jr,aL as Yr,aM as Qr,aN as Xr,aO as Kr,aP as Sn,aQ as Zr,aR as ea,aS as ta,aT as sa,aU as na,aV as ra,aW as aa}from"./index-1x3sw4DL.js";import{C as Vn,R as ia,u as oa,a as la,b as ca,c as da,d as ua,e as ma,f as ga,M as pa,B as xa,P as ha,H as hs,g as fs,h as fa,i as ya}from"./CoursePlayer-Bq7ZKb2I.js";import{M as Yt}from"./multimodalService-BOWYif01.js";import{generateGeminiImage as va}from"./imagenService-D9X-XJ8a.js";import{I as ba}from"./IconPlus-h8B_XGoY.js";import{I as wa}from"./IconTrash-CoaUmbon.js";import{I as ja}from"./IconBrain-B9doffEc.js";import{a as W,I as Na}from"./IngestionWizard-C4rhXKDf.js";import{I as Hn}from"./IconLoader-C6Kee0ah.js";import{S as Ca}from"./ShareModal-DLbWhIEc.js";import"./IconCalendar-DSCrS-DW.js";import"./IconUsers-Br9myKfl.js";import"./IconCopy-BTB5ujr3.js";/**
 * @license @tabler/icons-react v3.36.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=[["path",{d:"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0",key:"svg-0"}],["path",{d:"M9 12l2 2l4 -4",key:"svg-1"}]],Wn=Vs("outline","circle-check","CircleCheck",Sa);/**
 * @license @tabler/icons-react v3.36.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const _a=[["path",{d:"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0",key:"svg-0"}],["path",{d:"M10 10l4 4m0 -4l-4 4",key:"svg-1"}]],Ta=Vs("outline","circle-x","CircleX",_a);/**
 * @license @tabler/icons-react v3.36.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ia=[["path",{d:"M12 21a9 9 0 0 1 0 -18c4.97 0 9 3.582 9 8c0 1.06 -.474 2.078 -1.318 2.828c-.844 .75 -1.989 1.172 -3.182 1.172h-2.5a2 2 0 0 0 -1 3.75a1.3 1.3 0 0 1 -1 2.25",key:"svg-0"}],["path",{d:"M8.5 10.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0",key:"svg-1"}],["path",{d:"M12.5 7.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0",key:"svg-2"}],["path",{d:"M16.5 10.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0",key:"svg-3"}]],$a=Vs("outline","palette","Palette",Ia),Ba=`
Role: Specialized Podcast Producer & Scriptwriter.
Task: Convert the provided academic/learning material into an engaging "Deep Dive" podcast script.
Format: A dialogue between two hosts: "Dan" and "Noa".

PHASE 1: THE HOSTS
1. **Dan (The Expert):**
   - Tone: Analytical, slightly cynical, precise.
   - Role: Grounds the conversation in facts. Loves structure.
   - Signature: Uses analogies, corrects misconceptions.

2. **Noa (The Curious Host):**
   - Tone: Enthusiastic, relatable, asks the "stupid questions" everyone is thinking.
   - Role: Moves the narrative forward, reacts emotionally ("Wait, really?").
   - Signature: Summarizes complex points in simple terms.

PHASE 2: THE STYLE
- **Format:** Informal conversation. NOT a lecture.
- **Micro-Hooks:** Start with a "Cold Open" (a surprising fact or question).
- **Interactions:** Use interruptions ("Wait, hang on..."), agreement sounds ("Right, right"), and humor.
- **Language:** Hebrew (Fluent, Conversational, Modern).

PHASE 3: STRICT GROUNDING (Anti-Hallucination)
- **Source:** You must base the script ONLY on the provided Source Text.
- **Constraint:** Do not make up facts. If the text doesn't say it, don't say it.
- **Citations:** If describing a specific claim, implicitly reference it ("As the text mentions...").

PHASE 4: OUTPUT STRUCTURE (JSON ONLY)
Return a VALID JSON object:
{
  "title": "Catchy Podcast Title",
  "lines": [
    { "speaker": "Noa", "text": "Wait, so you're telling me [Fact]?", "emotion": "Skeptical" },
    { "speaker": "Dan", "text": "Exactly. And it gets weirder...", "emotion": "Neutral" }
  ]
}
`,Ua={isConfigured:()=>!0,generateScript:async n=>{try{const s=`
        ${Ba}

        ---
        TARGET AUDIENCE: ${n.targetAudience}
        LANGUAGE: ${n.language==="he"?"Hebrew":"English"}
        FOCUS TOPIC: ${n.focusTopic||"General Overview"}
        
        SOURCE TEXT:
        """
        ${n.sourceText.substring(0,5e4)} 
        """
        // Note: GPT-4o-mini has 128k context, keeping safe buffer.
      `;let a=(await Hs.chat.completions.create({model:Ws,messages:[{role:"user",content:s}],response_format:{type:"json_object"},temperature:.7})).choices[0].message.content||"{}";a=Mn(a);const d=JSON.parse(a);return!d.lines||!Array.isArray(d.lines)||d.lines.length<2?(console.warn("Generated script is too short or invalid."),null):d}catch(s){return console.error("AudioGenerator.generateScript Failed:",s),null}},synthesizeAudio:async n=>null},Pa={generateGuide:async n=>{if(!n||n.length<50)return null;const a=`
        Role: Pedagogical Expert.
        Task: Create a "Source Guide" for the following learning material.
        Constraint: Refer to the content as "The Text" (×”×˜×§×¡×˜) and NOT "The Article" (×”×ž××ž×¨).
        
        Input Text (Numbered Chunks):
        """
        ${Vn.chunkText(n).map(d=>`[${d.id}] ${d.text}`).join(`

`).substring(0,5e4)} 
        """
        (Text truncated if too long)

        Output Requirements (JSON):
        1. "summary": A concise briefing (3-4 sentences) summarizing the main point. MUST include citations like [1].
        2. "topics": An array of 5 key terms/concepts defined in the text.
        3. "faq": An array of 3 questions a student might ask, with brief answers.

        Language: Hebrew.
        
        Format:
        {
            "summary": "...",
            "topics": [{ "term": "...", "definition": "..." }],
            "faq": [{ "question": "...", "answer": "..." }]
        }
        `;try{const p=(await Hs.chat.completions.create({model:Ws,messages:[{role:"user",content:a}],response_format:{type:"json_object"}})).choices[0].message.content||"{}";return JSON.parse(Mn(p))}catch(d){return console.error("Failed to generate Source Guide:",d),null}}},Ea=({content:n,onClose:s,pdfSource:r})=>{const[a,d]=S.useState("text"),[p,l]=S.useState(null),[c,v]=S.useState(!1);S.useEffect(()=>{const g=()=>{const x=window.location.hash;if(x.startsWith("#chunk-")){const T=x.replace("#",""),h=document.getElementById(T);h&&(d("text"),setTimeout(()=>{h.scrollIntoView({behavior:"smooth",block:"center"}),h.classList.add("bg-yellow-200"),setTimeout(()=>h.classList.remove("bg-yellow-200"),2e3)},100))}};return window.addEventListener("hashchange",g),()=>window.removeEventListener("hashchange",g)},[]);const B=async()=>{if(p)return;v(!0);const g=await Pa.generateGuide(n);l(g),v(!1)};return S.useEffect(()=>{a==="guide"&&!p&&!c&&B()},[a]),e.jsxs("div",{className:"flex flex-col h-full bg-gray-50 border-l border-gray-200 shadow-xl relative",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-white border-b sticky top-0 z-10",children:[e.jsxs("div",{className:"flex gap-1 bg-gray-100 p-1 rounded-lg",children:[e.jsxs("button",{onClick:()=>d("text"),className:`px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${a==="text"?"bg-white text-blue-600 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(Ns,{className:"w-4 h-4"})," ×˜×§×¡×˜ ×ž×œ×"]}),e.jsxs("button",{onClick:()=>d("guide"),className:`px-4 py-1.5 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${a==="guide"?"bg-white text-purple-600 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(Xe,{className:"w-4 h-4"})," ×ž×“×¨×™×š ×œ×•×ž×“"]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-full text-gray-500",children:e.jsx(Ct,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 relative",children:[a==="text"&&e.jsx("div",{className:"prose max-w-none prose-sm prose-indigo leading-relaxed font-serif text-gray-800",children:r?e.jsx("iframe",{src:r,className:"w-full h-[800px] border-none",title:"PDF Source"}):Vn.chunkText(n).map(g=>e.jsxs("span",{id:`chunk-${g.id}`,className:"relative py-1 px-1 rounded transition-colors duration-1000 block md:inline hover:bg-yellow-50/50",children:[e.jsxs("sup",{className:"text-gray-400 text-[10px] select-none pr-1",children:["[",g.id,"]"]}),g.text+" "]},g.id))}),a==="guide"&&e.jsx("div",{className:"space-y-8 animate-fade-in",children:c?e.jsxs("div",{className:"text-center py-20 text-purple-600",children:[e.jsx(Os,{className:"w-10 h-10 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"font-bold",children:"×ž×™×™×¦×¨ ×ª×•×‘× ×•×ª ×ž×”×˜×§×¡×˜..."})]}):p?e.jsxs(e.Fragment,{children:[e.jsxs("section",{children:[e.jsx("h3",{className:"text-xs font-bold uppercase tracking-widest text-gray-400 mb-3",children:"×ª×§×¦×™×¨ ×œ×œ×•×ž×“"}),e.jsx("div",{className:"bg-white p-5 rounded-2xl shadow-sm border border-purple-100 text-gray-800 text-sm leading-7",children:e.jsx(sr,{children:p.summary.replace(/\[(\d+)\]/g,"[$1](#chunk-$1)"),components:{a:({href:g,children:x})=>e.jsx("a",{href:g,onClick:T=>{T.preventDefault(),d("text"),window.location.hash=g||""},className:"inline-flex items-center justify-center w-4 h-4 mx-1 text-[9px] font-bold text-purple-600 bg-purple-50 border border-purple-200 rounded-full hover:bg-purple-100 hover:scale-110 transition-all align-middle no-underline",children:x})}})})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"text-xs font-bold uppercase tracking-widest text-gray-400 mb-3",children:"×ž×•×©×’×™ ×ž×¤×ª×—"}),e.jsx("div",{className:"grid grid-cols-1 gap-3",children:p.topics.map((g,x)=>e.jsxs("div",{className:"bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex gap-3 items-start",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-blue-50 text-blue-600 flex-shrink-0 flex items-center justify-center text-xs font-bold mt-0.5",children:x+1}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold text-gray-900 text-sm mb-1",children:g.term}),e.jsx("div",{className:"text-xs text-gray-500",children:g.definition})]})]},x))})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"text-xs font-bold uppercase tracking-widest text-gray-400 mb-3",children:"×©××œ×•×ª × ×¤×•×¦×•×ª"}),e.jsx("div",{className:"space-y-3",children:p.faq.map((g,x)=>e.jsxs("details",{className:"group bg-white rounded-xl border border-gray-100 overflow-hidden",children:[e.jsxs("summary",{className:"p-4 cursor-pointer font-bold text-sm text-gray-800 flex justify-between items-center hover:bg-gray-50",children:[g.question,e.jsx("span",{className:"group-open:rotate-180 transition-transform",children:"â–¼"})]}),e.jsx("div",{className:"p-4 pt-0 text-sm text-gray-600 leading-relaxed border-t border-gray-50",children:g.answer})]},x))})]})]}):e.jsxs("div",{className:"text-center py-10",children:[e.jsx("p",{className:"text-red-500",children:"×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ž×“×¨×™×š."}),e.jsx("button",{onClick:B,className:"mt-4 text-blue-600 underline",children:"× ×¡×” ×©×•×‘"})]})})]})]})},_n=5,La="ai-refine-history";function Aa(n,s,r,a){const[d,p]=S.useState(null),l=S.useRef(!1),c=`${La}:${n}:${s}`;S.useEffect(()=>{if(!l.current){l.current=!0;try{const M=localStorage.getItem(c);if(M){const R=JSON.parse(M);p(R)}}catch(M){console.error("Failed to load version history:",M)}}},[c]),S.useEffect(()=>{if(d)try{localStorage.setItem(c,JSON.stringify(d))}catch(M){console.error("Failed to save version history:",M)}},[d,c]);const v=S.useCallback((M,R)=>{p(U=>{const J={id:crypto.randomUUID(),content:JSON.parse(JSON.stringify(M)),timestamp:Date.now(),prompt:R};if(!U)return{blockId:s,unitId:n,versions:[J],currentIndex:0};let k=[...U.versions.slice(0,U.currentIndex+1),J];return k.length>_n&&(k=k.slice(k.length-_n)),{...U,versions:k,currentIndex:k.length-1}})},[s,n]),B=S.useCallback(()=>{if(!d||d.currentIndex<=0)return;const M=d.currentIndex-1,R=d.versions[M];p(U=>U?{...U,currentIndex:M}:null),a(JSON.parse(JSON.stringify(R.content)))},[d,a]),g=S.useCallback(()=>{if(!d||d.currentIndex>=d.versions.length-1)return;const M=d.currentIndex+1,R=d.versions[M];p(U=>U?{...U,currentIndex:M}:null),a(JSON.parse(JSON.stringify(R.content)))},[d,a]),x=d?d.currentIndex>0:!1,T=d?d.currentIndex<d.versions.length-1:!1,h=d?d.currentIndex+1:0,_=d?d.versions.length:0,E=_>0;return{saveVersion:v,goToPrevious:B,goToNext:g,canGoBack:x,canGoForward:T,currentVersionNumber:h,totalVersions:_,hasHistory:E}}const Ma=(n,s)=>{if(!(()=>{var a,d,p;return s?typeof s=="string"?s.trim().length>0:s.question?s.question.trim().length>0:s.text?s.text.trim().length>0:((a=s.pairs)==null?void 0:a.length)>0||((d=s.items)==null?void 0:d.length)>0||((p=s.correct_order)==null?void 0:p.length)>0:!1})())switch(n){case"multiple_choice":case"multipleChoice":case"multiple-choice":return"×¦×•×¨ ×©××œ×ª ×¨×‘-×‘×¨×™×¨×” ×¢× 4 ×ª×©×•×‘×•×ª";case"open_question":case"openQuestion":case"open-question":return"×¦×•×¨ ×©××œ×” ×¤×ª×•×—×”";case"matching":return"×¦×•×¨ 5 ×–×•×’×•×ª ×”×ª××ž×”";case"sorting":case"ordering":return"×¦×•×¨ ×¨×¦×£ ×©×œ 5 ×©×œ×‘×™×";case"fill_blanks":case"fillBlanks":case"fill_in_blanks":return"×¦×•×¨ ×ž×©×¤×˜ ×¢× ×ž×™×œ×™× ×—×¡×¨×•×ª";case"categorization":return"×¦×•×¨ 2 ×§×˜×’×•×¨×™×•×ª ×¢× ×¤×¨×™×˜×™×";case"memory_game":return"×¦×•×¨ 6 ×–×•×’×•×ª ×œ×ž×©×—×§ ×–×™×›×¨×•×Ÿ";case"true_false_speed":return"×¦×•×¨ 5 ×ž×©×¤×˜×™× ×œ××ž×ª/×©×§×¨";default:return"×¦×•×¨ ×ª×•×›×Ÿ ×¢×œ ×”× ×•×©×"}return""},Da=({blockId:n,blockType:s,content:r,onUpdate:a,className:d,unitId:p})=>{const[l,c]=S.useState(!1),[v,B]=S.useState(""),[g,x]=S.useState(!1),[T,h]=S.useState(null),[_,E]=S.useState(!1),M=S.useRef(null),{saveVersion:R,goToPrevious:U,goToNext:J,canGoBack:X,canGoForward:k,currentVersionNumber:G,totalVersions:f,hasHistory:I}=Aa(p||"",n,r,a);S.useEffect(()=>{l&&v===""&&(M.current!==null?B(M.current):B(Ma(s,r)))},[l,s,r]);const F=C=>{B(C),M.current=C},j=async()=>{if(v.trim()){x(!0),h(null);try{console.log(`ðŸš€ Refining block ${n} (${s})...`);let C;if(s==="activity-intro"){if(C=await ar(r,v),!C)throw new Error("Failed to generate new image")}else C=await ir(s,r,v);if(JSON.stringify(C)===JSON.stringify(r)){h("×”×ª×•×›×Ÿ ×œ× ×”×©×ª× ×”. × ×¡×” ×”×•×¨××” ××—×¨×ª ××• ×”×•×¡×£ ×¤×¨×˜×™× × ×•×¡×¤×™×.");return}p&&R(C,v),a(C),E(!0),setTimeout(()=>{E(!1),c(!1)},1e3)}catch(C){console.error("Refine failed",C),h("×©×’×™××” ×‘×©×™×¤×•×¨ ×”×ª×•×›×Ÿ. × ×¡×” ×©×•×‘.")}finally{x(!1)}}};return l?e.jsxs("div",{className:`mt-2 p-3 bg-gradient-to-br from-violet-50 to-white rounded-xl border border-purple-100 shadow-lg animate-scale-in relative ${d||""}`,children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-purple-700 font-bold text-xs",children:[e.jsx(Rs,{className:"w-3 h-3"}),e.jsx("span",{children:"×ž×” ×œ×©×¤×¨ ×‘×ª×•×›×Ÿ?"})]}),e.jsx("button",{onClick:()=>c(!1),className:"text-gray-400 hover:text-red-500 hover:bg-red-50 p-1 rounded-full transition-colors",children:e.jsx(Ct,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:v,onChange:C=>F(C.target.value),placeholder:"×›×ª×‘×• ×‘×©×¤×” ×—×•×¤×©×™×ª ×ž×” ×œ×©× ×•×ª, ×œ×ž×©×œ: '× ×¡×— ×‘×˜×•×Ÿ ×™×•×ª×¨ ×ž×§×¦×•×¢×™', '×§×¦×¨ ××ª ×”×˜×§×¡×˜', '×”×•×¡×£ ×“×•×’×ž×” ××—×ª'...",className:"w-full min-w-[350px] text-sm p-3 pr-2 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-200 focus:border-purple-300 min-h-[100px] resize-y bg-white/80",disabled:g,autoFocus:!0,onKeyDown:C=>{C.key==="Enter"&&!C.shiftKey&&(C.preventDefault(),j())}}),e.jsx("div",{className:"text-[10px] text-gray-400 mt-1",children:"×˜×™×¤: ×›×›×œ ×©×”×”×•×¨××” ×ž×ž×•×§×“×ª ×™×•×ª×¨, ×›×š ×”×ª×•×¦××” ×ª×”×™×” ×§×¨×•×‘×” ×™×•×ª×¨ ×œ×¦×™×¤×™×•×ª"})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsxs("div",{className:"text-xs",children:[T&&e.jsx("span",{className:"text-red-500 font-medium",children:T}),_&&e.jsxs("span",{className:"text-green-600 font-bold flex items-center gap-1",children:[e.jsx(At,{className:"w-3 h-3"})," ×‘×•×¦×¢ ×‘×”×¦×œ×—×”!"]})]}),e.jsx("button",{onClick:j,disabled:!v.trim()||g,className:`px-4 py-1.5 rounded-lg text-xs font-bold text-white shadow-sm flex items-center gap-2 transition-all
                    ${_?"bg-green-500":"bg-purple-600 hover:bg-purple-700"} 
                    ${!v.trim()||g?"opacity-50 cursor-not-allowed":"hover:-translate-y-0.5"}`,children:g?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"×—×•×©×‘..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"w-3 h-3"}),_?"× ×©×ž×¨":"×‘×¦×¢"]})})]}),e.jsx("div",{className:"absolute -top-1 right-6 w-3 h-3 bg-violet-50 border-t border-l border-purple-100 transform rotate-45 -translate-y-1/2"})]}):e.jsxs("div",{className:`flex items-center gap-2 justify-end ${d||""}`,children:[e.jsxs("button",{onClick:()=>c(!0),className:`flex items-center gap-2 text-xs font-bold px-3 py-1.5 rounded-lg border transition-all shadow-sm\r
                    bg-gradient-to-r from-violet-100 to-fuchsia-100 text-purple-700 border-purple-200 hover:from-violet-200 hover:to-fuchsia-200`,title:"×©×¤×¨ ××• ×©× ×” ××ª ×”×ª×•×›×Ÿ ×‘××ž×¦×¢×•×ª ×”×•×¨××•×ª ×—×•×¤×©×™×•×ª",children:[e.jsx(Xe,{className:"w-3 h-3 text-purple-600"}),"×©×¤×¨×• ×¢× AI"]}),I&&f>1&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500 bg-gray-100 rounded-full px-2 py-1",children:[e.jsx("button",{onClick:U,disabled:!X,className:`p-1 rounded-full transition-colors ${X?"hover:bg-gray-200 text-gray-600":"text-gray-300 cursor-not-allowed"}`,title:"×’×¨×¡×” ×§×•×“×ž×ª",children:e.jsx(nr,{className:"w-3 h-3"})}),e.jsxs("span",{className:"font-medium min-w-[32px] text-center text-gray-600",children:[G,"/",f]}),e.jsx("button",{onClick:J,disabled:!k,className:`p-1 rounded-full transition-colors ${k?"hover:bg-gray-200 text-gray-600":"text-gray-300 cursor-not-allowed"}`,title:"×’×¨×¡×” ×”×‘××”",children:e.jsx(rr,{className:"w-3 h-3"})})]})]})},Fa=2500;let Gt=null,js=null;const Zt=n=>{try{return JSON.parse(JSON.stringify(n,(s,r)=>{if(r===void 0)return null;if(r instanceof Date)return r.toISOString();if(typeof r!="function")return r}))}catch(s){return console.warn("cleanDataForFirestore fallback used:",s),Array.isArray(n)?n.map(Zt):n!==null&&typeof n=="object"?n instanceof Date?n.toISOString():Object.entries(n).reduce((r,[a,d])=>(d!==void 0&&typeof d!="function"&&(r[a]=Zt(d)),r),{}):n}},Jn=async n=>{const s=or(zt),r=Cs(zt,"courses",n.id),a=n.syllabus.map(p=>({...p,learningUnits:p.learningUnits.map(l=>({id:l.id,title:l.title,type:l.type,isLazy:!0,baseContent:null,activityBlocks:[],audioOverview:null}))})),d=Zt({...n,syllabus:a,updatedAt:new Date().toISOString()});s.set(r,d,{merge:!0}),n.syllabus.forEach(p=>{p.learningUnits.forEach(l=>{if(l.id){const c=Cs(zt,"courses",n.id,"units",l.id),v=Zt(l);s.set(c,v,{merge:!0})}})}),await s.commit(),console.log("âœ… Lesson plan (split) saved successfully:",n.id)},Qt=async n=>{if(!n.id)throw new Error("Course ID is missing");return js=n,new Promise((s,r)=>{Gt&&clearTimeout(Gt),Gt=setTimeout(async()=>{const a=js;if(!a){s();return}try{await Jn(a),js=null,s()}catch(d){console.error("Error saving lesson plan:",d),r(d)}},Fa)})},ys=async n=>{if(!n.id)throw new Error("Course ID is missing");Gt&&(clearTimeout(Gt),Gt=null),js=null;try{await Jn(n)}catch(s){throw console.error("Error saving lesson plan:",s),s}},Tn=async(n,s)=>{if(!n||!s.id)throw new Error("Missing Course ID or Unit ID");const r=Cs(zt,"courses",n,"units",s.id),a=Zt(s);try{await lr(r,a,{merge:!0}),console.log(`Unit ${s.id} saved to sub-collection.`)}catch(d){throw console.error(`Error saving unit ${s.id}:`,d),d}},Ds=async(n,s="media")=>{if(!n)throw new Error("No file provided");const r=n.type.startsWith("video/"),a=r?50*1024*1024:5*1024*1024;if(n.size>a)throw new Error(`×”×§×•×‘×¥ ×’×“×•×œ ×ž×“×™. ×ž×§×¡×™×ž×•× ×ž×•×ª×¨: ${r?"50MB":"5MB"}`);const d=`course_assets/${s}/${Date.now()}_${n.name}`,p=cr(dr,d),l={contentType:n.type||"application/octet-stream"};try{const c=await ur(p,n,l);return await mr(c.ref)}catch(c){throw console.error("Upload failed:",c),c}},qs={maxScenarioImages:2,totalMaxImages:3},Oa=["application","analysis","evaluation","creation"],Ra=["multiple-choice","open-question"],Yn=(n,s,r={contextImages:0,scenarioImages:0},a)=>!(r.scenarioImages>=qs.maxScenarioImages||r.contextImages+r.scenarioImages>=qs.totalMaxImages||!s||!Oa.includes(s.toLowerCase())||a&&!Ra.includes(a)),Qn=(n,s,r)=>`Create an educational illustration showing a ${{×ž×ª×ž×˜×™×§×”:"××“×¨×™×›×œ, ×ž×”× ×“×¡, ××• ×—×•×§×¨ ×ž×“×¢×™",×œ×©×•×Ÿ:"×¢×™×ª×•× ××™, ×¡×•×¤×¨, ××• ×ž× ×”×œ ×ª×§×©×•×¨×ª",×ž×“×¢×™×:"×ž×“×¢×Ÿ ×‘×ž×¢×‘×“×”, ×—×•×§×¨ ×‘×©×˜×—, ××• ×¨×•×¤×",×”×™×¡×˜×•×¨×™×”:"××¨×›×™××•×œ×•×’, ×”×™×¡×˜×•×¨×™×•×Ÿ, ××• ×ž× ×”×™×’",×× ×’×œ×™×ª:"×“×™×¤×œ×•×ž×˜, ×ž×ª×•×¨×’×ž×Ÿ, ××• ××™×© ×¢×¡×§×™× ×‘×™× ×œ××•×ž×™",×’×™××•×’×¨×¤×™×”:"×—×•×§×¨, × ×•×•×˜, ××• ×ž×ª×›× ×Ÿ ×¢×¨×™×",××–×¨×—×•×ª:"×¢×•×¨×š ×“×™×Ÿ, ×¤×•×œ×™×˜×™×§××™, ××• ×¤×¢×™×œ ×—×‘×¨×ª×™",'×ª× "×š':"××¨×›×™××•×œ×•×’, ×—×•×§×¨ ×›×ª×‘×™× ×¢×ª×™×§×™×, ××• ×ž×•×¨×” ×“×¨×š"}[s]||"×ž×•×ž×—×” ×‘×ª×—×•×"} in a realistic professional setting related to "${n}".
The scene should:
- Show a person actively working (not posed)
- Include relevant professional tools or environment
- Be age-appropriate for grade ${r} students
- Convey "you are the expert" feeling
- CRITICAL: NO TEXT AT ALL - no labels, no signs, no writing, no letters, no words in any language
- Warm, inviting colors
- Semi-realistic style (not cartoon, not photorealistic)`,Xn=(n,s)=>`Create an educational illustration showing a problem situation related to "${s}".
The scene should:
- Depict a moment BEFORE resolution (the problem state)
- Show visual tension or something that needs fixing
- Be clear enough that students can identify what's wrong
- CRITICAL: NO TEXT AT ALL - no labels, no signs, no writing, no letters, no words in any language
- Related to this question context: "${n.slice(0,100)}..."
- Semi-realistic educational style`,Kn=(n,s,r,a)=>{const d={contextImages:1,scenarioImages:0},p={prompt:Qn(n,s,r),description:`×ª×ž×•× ×ª ×¤×ª×™×—×”: ${s} - ${n}`},l=[];for(const c of a)Yn(c.text,c.taxonomy,d,c.type)&&(l.push({blockId:c.id,prompt:Xn(c.text,n),description:`×ª×ž×•× ×ª ×“×™×œ×ž×” ×œ×©××œ×”: ${c.text.slice(0,50)}...`}),d.scenarioImages++);return{contextImage:p,scenarioImages:l}},za=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_ACTIVITY_MEDIA_BUDGET:qs,createActivityMediaPlan:Kn,createContextImagePrompt:Qn,createScenarioImagePrompt:Xn,shouldAddScenarioImage:Yn},Symbol.toStringTag,{value:"Module"})),Ga=async(n,s,r,a,d)=>{const p=n.activityBlocks||[];if(p.length===0)return n;const l=p.filter(T=>["multiple-choice","open-question","categorization"].includes(T.type)).map(T=>{var _;const h=T.content;return{id:T.id,text:(h==null?void 0:h.question)||(h==null?void 0:h.text)||"",taxonomy:(_=T.metadata)==null?void 0:_.bloomLevel,type:T.type}}),c=Kn(s,r,a,l),v=1+c.scenarioImages.length;let B=0;const g=[];d==null||d("×™×•×¦×¨ ×ª×ž×•× ×ª ×¤×ª×™×—×”...",++B,v);try{const T=await es(c.contextImage.prompt,"ai-image");if(T){const h={id:ze(),type:"activity-intro",content:{imageUrl:T,title:Zn(r,s),description:c.contextImage.description,imagePrompt:c.contextImage.prompt}};g.push(h)}}catch(T){console.warn("Failed to generate context image:",T)}const x=new Map(c.scenarioImages.map(T=>[T.blockId,T]));for(const T of p){const h=x.get(T.id);if(h){d==null||d("×™×•×¦×¨ ×ª×ž×•× ×ª ×“×™×œ×ž×”...",++B,v);try{const _=await es(h.prompt,"ai-image");if(_){const E={id:ze(),type:"scenario-image",content:{imageUrl:_,caption:ka(T),imagePrompt:h.prompt,relatedBlockId:T.id}};g.push(E)}}catch(_){console.warn("Failed to generate scenario image:",_)}}g.push(T)}return{...n,activityBlocks:g}},es=async(n,s)=>{try{console.log(`ðŸŽ¨ [ActivityMedia] Generating image... (prompt: ${n.substring(0,50)}...)`);const r=await va(n);if(!r)return console.warn("ðŸŽ¨ [ActivityMedia] Gemini returned no image blob"),null;console.log(`ðŸŽ¨ [ActivityMedia] Image generated, size: ${(r.size/1024).toFixed(1)}KB`),console.log("ðŸ“¤ [ActivityMedia] Uploading to Firebase Storage...");const a=await gr(r,s);return console.log(`âœ… [ActivityMedia] Image uploaded successfully: ${a.substring(0,80)}...`),a}catch(r){return console.error("âŒ [ActivityMedia] Image generation/upload failed:",r),null}},Zn=(n,s)=>({×ž×ª×ž×˜×™×§×”:"××ª×” ×”×ž×”× ×“×¡!",×œ×©×•×Ÿ:"××ª×” ×”×¢×™×ª×•× ××™!",×ž×“×¢×™×:"××ª×” ×”×ž×“×¢×Ÿ!",×”×™×¡×˜×•×¨×™×”:"××ª×” ×”×—×•×§×¨!",×× ×’×œ×™×ª:"××ª×” ×”×©×’×¨×™×¨!",×’×™××•×’×¨×¤×™×”:"××ª×” ×”× ×•×•×˜!",××–×¨×—×•×ª:"××ª×” ×¢×•×¨×š ×”×“×™×Ÿ!",'×ª× "×š':"××ª×” ×”××¨×›×™××•×œ×•×’!"})[n]||`×ž×©×™×ž×”: ${s}`,ka=n=>{const s=n.content,r=(s==null?void 0:s.question)||(s==null?void 0:s.text)||"";return r.includes("×ž×” ×™×§×¨×”")?"×ž×” ×œ×“×¢×ª×š ×™×§×¨×” ×›××Ÿ?":r.includes("××™×š × ×¤×ª×•×¨")?"××™×š ×ª×¤×ª×•×¨ ××ª ×”×‘×¢×™×”?":r.includes("×ž×” ×”×‘×¢×™×”")?"×ž×¦× ××ª ×”×‘×¢×™×” ×‘×ª×ž×•× ×”":r.includes("×œ×ž×”")?"×”×¡×ª×›×œ ×‘×ª×ž×•× ×” - ×ž×” ×”×”×¡×‘×¨?":"×”×ª×‘×•× ×Ÿ ×‘×ª×ž×•× ×” ×•×‘×—×¨ ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”"},qa=n=>(n.activityBlocks||[]).some(r=>r.type==="activity-intro"||r.type==="scenario-image"),In=async(n,s,r,a,d)=>{const{createContextImagePrompt:p}=await Dn(async()=>{const{createContextImagePrompt:v}=await Promise.resolve().then(()=>za);return{createContextImagePrompt:v}},void 0),l=a||p(n,s,r);console.log(`ðŸ–¼ï¸ [Parallel] Starting context image generation for: ${n}`),a&&console.log("ðŸŽ¯ [Parallel] Using AI-generated prompt from skeleton");const c=Date.now();try{const v=await es(l,"ai-image");if(v){const B=Date.now()-c;return console.log(`âœ… [Parallel] Context image ready in ${(B/1e3).toFixed(1)}s`),{id:ze(),type:"activity-intro",content:{imageUrl:v,title:Zn(s,n),description:`×ª×ž×•× ×ª ×¤×ª×™×—×”: ${s} - ${n}`,imagePrompt:l}}}}catch(v){console.warn("âŒ [Parallel] Context image generation failed:",v)}return null},Va=async(n,s,r)=>{const a=new Map,d=n.filter(v=>{var B,g;return((B=v.suggested_media)==null?void 0:B.needed)&&((g=v.suggested_media)==null?void 0:g.type)==="scenario_image"});if(d.length===0)return console.log("ðŸ“· [SuggestedMedia] No steps need scenario images"),a;const p=d.slice(0,2);console.log(`ðŸ“· [SuggestedMedia] Processing ${p.length} media requests`);let l=0;const c=p.length;for(const v of p){const B=v.suggested_media;l++,r==null||r(`×™×•×¦×¨ ×ž×“×™×” ×œ×¦×¢×“ ${v.step_number}...`,l,c);try{if(B.type==="scenario_image"){const g=B.prompt_hint?`Create an educational illustration: ${B.prompt_hint}.
                       Style: Semi-realistic, warm colors.
                       CRITICAL: NO TEXT AT ALL in the image.`:`Create an educational problem-solving scenario image related to "${s}".
                       Show a moment that requires student decision-making.
                       Style: Semi-realistic, warm colors.
                       CRITICAL: NO TEXT AT ALL in the image.`;console.log(`ðŸ–¼ï¸ [SuggestedMedia] Generating scenario image for step ${v.step_number}`);const x=await es(g,"ai-image");if(x){const T={id:ze(),type:"scenario-image",content:{imageUrl:x,caption:"×”×ª×‘×•× ×Ÿ ×‘×ª×ž×•× ×” ×•×‘×—×¨ ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”",imagePrompt:g,relatedBlockId:`step-${v.step_number}`}};a.set(v.step_number,T),console.log(`âœ… [SuggestedMedia] Scenario image ready for step ${v.step_number}`)}}else if(B.type==="infographic"){const g=Ha(v.teach_content||s,B.infographic_type||"flowchart",B.prompt_hint);console.log(`ðŸ“Š [SuggestedMedia] Generating ${B.infographic_type} infographic for step ${v.step_number}`);const x=await es(g,"infographic");if(x){const T={id:ze(),type:"scenario-image",content:{imageUrl:x,caption:Wa(B.infographic_type),imagePrompt:g,relatedBlockId:`step-${v.step_number}`}};a.set(v.step_number,T),console.log(`âœ… [SuggestedMedia] Infographic ready for step ${v.step_number}`)}}}catch(g){console.warn(`âš ï¸ [SuggestedMedia] Failed to generate media for step ${v.step_number}:`,g)}}return a},Ha=(n,s,r)=>`Create an educational infographic in Hebrew.
${{flowchart:"Create a clean flowchart diagram showing the process steps with arrows connecting them.",timeline:"Create a horizontal timeline showing events/stages in chronological order.",comparison:"Create a side-by-side comparison diagram with clear visual differences.",cycle:"Create a circular diagram showing a recurring process with arrows indicating flow."}[s]}
Content to visualize: ${r||n.substring(0,500)}
Style: Clean, professional, educational. Use warm colors.
CRITICAL: Include Hebrew text labels. Make it easy to read.
Age-appropriate for students.`,Wa=n=>({flowchart:"×ª×¨×©×™× ×–×¨×™×ž×” ×©×œ ×”×ª×”×œ×™×š",timeline:"×¦×™×¨ ×–×ž×Ÿ ×©×œ ×”××™×¨×•×¢×™×",comparison:"×”×©×•×•××” ×‘×™×Ÿ ×”×ž×•×©×’×™×",cycle:"×ž×—×–×•×¨ ×”×ª×”×œ×™×š"})[n||"flowchart"]||"×ª×¨×©×™× ×œ×”×ž×—×©×”",ts="https://us-central1-ai-lms-pro.cloudfunctions.net/streamingServer";async function ss(){const n=pr.currentUser;if(!n)throw new Error("User not authenticated");return n.getIdToken()}function $t(n){if(!n.startsWith("data: "))return null;try{const s=n.slice(6);return JSON.parse(s)}catch{return console.warn("Failed to parse SSE data:",n),null}}async function Ja(n,s,r,a){var x,T;const d=await ss(),p=new AbortController,l=await fetch(`${ts}/stream/content`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({type:r.productType||"activity",prompt:n,systemPrompt:s,options:r}),signal:p.signal});if(!l.ok){const h=await l.text();throw(x=a.onError)==null||x.call(a,h),new Error(h)}const c=(T=l.body)==null?void 0:T.getReader();if(!c)throw new Error("No response body");const v=new TextDecoder;let B="",g="";return(async()=>{var h,_,E,M,R,U,J;try{for(;;){const{done:X,value:k}=await c.read();if(X)break;B+=v.decode(k,{stream:!0});const G=B.split(`
`);B=G.pop()||"";for(const f of G){if(f.startsWith("event: "))continue;const I=$t(f);if(I)switch(I.type){case"text":g+=I.content,(h=a.onChunk)==null||h.call(a,I.content,I.metadata);break;case"progress":(_=a.onProgress)==null||_.call(a,I.content,I.metadata);break;case"json_complete":try{const F=JSON.parse(I.content);(E=a.onComplete)==null||E.call(a,F)}catch{(M=a.onComplete)==null||M.call(a,I.content)}break;case"done":(R=a.onComplete)==null||R.call(a,g);break;case"error":(U=a.onError)==null||U.call(a,I.content);break}}}}catch(X){X.name!=="AbortError"&&((J=a.onError)==null||J.call(a,X.message||"Stream failed"))}})(),p}async function Ya(n,s){const r=await ss(),a=new AbortController,d=new Promise(async(p,l)=>{var c,v,B,g,x,T,h,_,E,M,R,U,J,X;try{const k=await fetch(`${ts}/stream/differentiated`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({topic:n.topic,gradeLevel:n.gradeLevel,subject:n.subject,sourceText:n.sourceText,productType:n.productType,activityLength:n.activityLength,questionPreferences:n.questionPreferences}),signal:a.signal});if(!k.ok){const j=await k.text();(c=s.onError)==null||c.call(s,j),l(new Error(j));return}const G=(v=k.body)==null?void 0:v.getReader();if(!G){l(new Error("No response body"));return}const f=new TextDecoder;let I="";const F={support:[],core:[],enrichment:[]};for(;;){const{done:j,value:C}=await G.read();if(j)break;I+=f.decode(C,{stream:!0});const $=I.split(`
`);I=$.pop()||"";for(const V of $){if(V.startsWith("event: ")){const Y=V.slice(7).trim(),se=$.indexOf(V)+1;if(se<$.length){const ne=$[se],fe=$t(ne);if(!fe)continue;switch(Y){case"level_start":(g=s.onLevelStart)==null||g.call(s,((B=fe.metadata)==null?void 0:B.level)||""),(x=s.onProgress)==null||x.call(s,fe.content,fe.metadata);break;case"level_complete":const je=(T=fe.metadata)==null?void 0:T.level;if(je&&F[je]!==void 0){try{const Ne=JSON.parse(fe.content);F[je]=Array.isArray(Ne)?Ne:[Ne]}catch{F[je]=[]}(h=s.onLevelComplete)==null||h.call(s,je,F[je])}break;case"chunk":(_=s.onChunk)==null||_.call(s,fe.content,fe.metadata);break;case"done":(E=s.onComplete)==null||E.call(s,F),p(F);return;case"error":(M=s.onError)==null||M.call(s,fe.content),l(new Error(fe.content));return}}continue}const Q=$t(V);if(Q){if(Q.type==="text")(R=s.onChunk)==null||R.call(s,Q.content,Q.metadata);else if(Q.type==="done"){(U=s.onComplete)==null||U.call(s,F),p(F);return}else if(Q.type==="error"){(J=s.onError)==null||J.call(s,Q.content),l(new Error(Q.content));return}}}}p(F)}catch(k){k.name!=="AbortError"&&((X=s.onError)==null||X.call(s,k.message||"Stream failed"),l(k))}});return{controller:a,result:d}}async function Qa(n,s){const r=await ss(),a=new AbortController,d=new Promise(async(p,l)=>{var c,v,B,g,x,T,h,_,E,M,R,U,J;try{const X=await fetch(`${ts}/stream/lesson`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({topic:n.topic,gradeLevel:n.gradeLevel,subject:n.subject,sourceText:n.sourceText,lessonParts:n.lessonParts||["hook","instruction","practice","summary"]}),signal:a.signal});if(!X.ok){const F=await X.text();(c=s.onError)==null||c.call(s,F),l(new Error(F));return}const k=(v=X.body)==null?void 0:v.getReader();if(!k){l(new Error("No response body"));return}const G=new TextDecoder;let f="";const I={};for(;;){const{done:F,value:j}=await k.read();if(F)break;f+=G.decode(j,{stream:!0});const C=f.split(`
`);f=C.pop()||"";for(const $ of C){if($.startsWith("event: ")){const Q=$.slice(7).trim(),Y=C.indexOf($)+1;if(Y<C.length){const se=C[Y],ne=$t(se);if(!ne)continue;switch(Q){case"part_start":(g=s.onPartStart)==null||g.call(s,((B=ne.metadata)==null?void 0:B.itemType)||""),(x=s.onProgress)==null||x.call(s,ne.content,ne.metadata);break;case"part_complete":const fe=(T=ne.metadata)==null?void 0:T.itemType;if(fe){try{I[fe]=JSON.parse(ne.content)}catch{I[fe]=ne.content}(h=s.onPartComplete)==null||h.call(s,fe,I[fe])}break;case"chunk":(_=s.onChunk)==null||_.call(s,ne.content,ne.metadata);break;case"done":(E=s.onComplete)==null||E.call(s,I),p(I);return;case"error":(M=s.onError)==null||M.call(s,ne.content),l(new Error(ne.content));return}}continue}const V=$t($);if(V){if(V.type==="done"){(R=s.onComplete)==null||R.call(s,I),p(I);return}else if(V.type==="error"){(U=s.onError)==null||U.call(s,V.content),l(new Error(V.content));return}}}}p(I)}catch(X){X.name!=="AbortError"&&((J=s.onError)==null||J.call(s,X.message||"Stream failed"),l(X))}});return{controller:a,result:d}}async function Xa(n,s){const r=await ss(),a=new AbortController,d=new Promise(async(p,l)=>{var c,v,B,g,x,T,h,_,E,M,R,U;try{const J=await fetch(`${ts}/stream/podcast`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({topic:n.topic,gradeLevel:n.gradeLevel,sourceText:n.sourceText,activityLength:n.activityLength}),signal:a.signal});if(!J.ok){const I=await J.text();(c=s.onError)==null||c.call(s,I),l(new Error(I));return}const X=(v=J.body)==null?void 0:v.getReader();if(!X){l(new Error("No response body"));return}const k=new TextDecoder;let G="",f="";for(;;){const{done:I,value:F}=await X.read();if(I)break;G+=k.decode(F,{stream:!0});const j=G.split(`
`);G=j.pop()||"";for(const C of j){if(C.startsWith("event: ")){const V=C.slice(7).trim(),Q=j.indexOf(C)+1;if(Q<j.length){const Y=j[Q],se=$t(Y);if(!se)continue;switch(V){case"progress":(B=s.onProgress)==null||B.call(s,se.content,se.metadata);break;case"chunk":f+=se.content,(g=s.onChunk)==null||g.call(s,se.content,se.metadata);break;case"done":try{const ne=JSON.parse(se.content);(x=s.onComplete)==null||x.call(s,ne),p(ne)}catch{(T=s.onComplete)==null||T.call(s,f),p(f)}return;case"error":(h=s.onError)==null||h.call(s,se.content),l(new Error(se.content));return}}continue}const $=$t(C);if($){if($.type==="text")f+=$.content,(_=s.onChunk)==null||_.call(s,$.content,$.metadata);else if($.type==="json_complete"||$.type==="done"){try{const V=JSON.parse($.content);(E=s.onComplete)==null||E.call(s,V),p(V)}catch{(M=s.onComplete)==null||M.call(s,f),p(f)}return}else if($.type==="error"){(R=s.onError)==null||R.call(s,$.content),l(new Error($.content));return}}}}p(f)}catch(J){J.name!=="AbortError"&&((U=s.onError)==null||U.call(s,J.message||"Stream failed"),l(J))}});return{controller:a,result:d}}async function er(n,s){const r=await ss(),a=new AbortController,d=new Promise(async(p,l)=>{var c,v,B,g,x,T,h,_,E,M,R,U,J,X;try{const k=await fetch(`${ts}/stream/activity`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({topic:n.topic,gradeLevel:n.gradeLevel,subject:n.subject,sourceText:n.sourceText,activityLength:n.activityLength,mode:n.productType==="exam"?"exam":"learning",productType:n.productType||"activity",questionPreferences:n.questionPreferences}),signal:a.signal});if(!k.ok){const $=await k.text();(c=s.onError)==null||c.call(s,$),l(new Error($));return}const G=(v=k.body)==null?void 0:v.getReader();if(!G){l(new Error("No response body"));return}const f=new TextDecoder;let I="",F=null;const j=[];let C=null;for(;;){const{done:$,value:V}=await G.read();if($)break;I+=f.decode(V,{stream:!0});const Q=I.split(`
`);I=Q.pop()||"";for(let Y=0;Y<Q.length;Y++){const se=Q[Y];if(se.startsWith("event: ")){const fe=se.slice(7).trim(),je=Q[Y+1];if(je!=null&&je.startsWith("data: ")){const Ne=$t(je);if(!Ne)continue;switch(fe){case"progress":(B=s.onProgress)==null||B.call(s,Ne.content,Ne.metadata);break;case"skeleton_complete":try{F=JSON.parse(Ne.content),(g=s.onSkeletonComplete)==null||g.call(s,F)}catch(Pe){console.warn("Failed to parse skeleton:",Pe)}break;case"step_complete":try{const Pe=JSON.parse(Ne.content);j.push(Pe),(h=s.onStepComplete)==null||h.call(s,Pe,((x=Ne.metadata)==null?void 0:x.stepNumber)||j.length,((T=Ne.metadata)==null?void 0:T.totalSteps)||5)}catch(Pe){console.warn("Failed to parse step:",Pe)}break;case"done":try{C=JSON.parse(Ne.content),(_=s.onComplete)==null||_.call(s,C),p(C);return}catch{C={title:(F==null?void 0:F.unit_title)||n.topic||"×¤×¢×™×œ×•×ª",steps:j,skeleton:F,metadata:Ne.metadata},(E=s.onComplete)==null||E.call(s,C),p(C);return}case"error":(M=s.onError)==null||M.call(s,Ne.content),l(new Error(Ne.content));return}Y++}continue}const ne=$t(se);if(ne){if(ne.type==="done"){try{C=JSON.parse(ne.content)}catch{C={title:(F==null?void 0:F.unit_title)||n.topic||"×¤×¢×™×œ×•×ª",steps:j,skeleton:F}}(R=s.onComplete)==null||R.call(s,C),p(C);return}else if(ne.type==="error"){(U=s.onError)==null||U.call(s,ne.content),l(new Error(ne.content));return}}}}C||(C={title:(F==null?void 0:F.unit_title)||n.topic||"×¤×¢×™×œ×•×ª",steps:j,skeleton:F},(J=s.onComplete)==null||J.call(s,C),p(C))}catch(k){k.name!=="AbortError"&&((X=s.onError)==null||X.call(s,k.message||"Stream failed"),l(k))}});return{controller:a,result:d}}function Kt(){return typeof ReadableStream<"u"&&typeof fetch<"u"}const $n=new Map,Ka=5*60*1e3;function Za(n){return`${n.topic}|${n.gradeLevel}|${n.language||"he"}|${n.maxResults||5}`}async function ei(n){const s=Za(n),r=$n.get(s);if(r&&Date.now()-r.timestamp<Ka)return console.log("[YouTube] Cache hit for:",n.topic),r.data;try{const p=(await xr(hr,"searchYouTubeEducational")(n)).data;return p.success&&$n.set(s,{data:p,timestamp:Date.now()}),p}catch(a){throw console.error("[YouTube] Search failed:",a),new Error(`×—×™×¤×•×© YouTube × ×›×©×œ: ${a.message}`)}}const Bn=n=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]}),ti=n=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),Un=n=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:e.jsx("polyline",{points:"20 6 9 17 4 12"})}),Fs=n=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:e.jsx("polygon",{points:"5 3 19 12 5 21 5 3"})}),si=n=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]}),Pn=n=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:[e.jsx("rect",{x:"2",y:"4",width:"20",height:"16",rx:"2"}),e.jsx("path",{d:"M7 15h4M15 15h2M7 11h2M13 11h4"})]}),ni=n=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:e.jsx("polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})}),ri=n=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:[e.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"6"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"22"}),e.jsx("line",{x1:"4.93",y1:"4.93",x2:"7.76",y2:"7.76"}),e.jsx("line",{x1:"16.24",y1:"16.24",x2:"19.07",y2:"19.07"}),e.jsx("line",{x1:"2",y1:"12",x2:"6",y2:"12"}),e.jsx("line",{x1:"18",y1:"12",x2:"22",y2:"12"}),e.jsx("line",{x1:"4.93",y1:"19.07",x2:"7.76",y2:"16.24"}),e.jsx("line",{x1:"16.24",y1:"7.76",x2:"19.07",y2:"4.93"})]}),ai=({isOpen:n,onClose:s,onSelectVideo:r,gradeLevel:a,subject:d,initialQuery:p=""})=>{const[l,c]=S.useState(p),[v,B]=S.useState([]),[g,x]=S.useState(!1),[T,h]=S.useState(null),[_,E]=S.useState(null),[M,R]=S.useState(null),U=S.useCallback(async()=>{if(l.trim()){x(!0),h(null);try{const f=await ei({topic:l,gradeLevel:a,language:"he",maxResults:6,requireCaptions:!0,educationalOnly:!0});f.success?(B(f.videos),f.videos.length===0&&h("×œ× × ×ž×¦××• ×¡×¨×˜×•× ×™× ×ž×ª××™×ž×™×. × ×¡×” ×ž×™×œ×•×ª ×—×™×¤×•×© ××—×¨×•×ª.")):h("×—×™×¤×•×© × ×›×©×œ. ×× × × ×¡×” ×©× ×™×ª.")}catch(f){h(f.message||"×©×’×™××” ×‘×—×™×¤×•×©")}finally{x(!1)}}},[l,a]),J=f=>{f.key==="Enter"&&U()},X=f=>{E(f.videoId),r(f),s()},k=f=>f>=80?"text-green-600":f>=60?"text-yellow-600":"text-red-600",G=f=>{const I=parseInt(f);return I>=1e6?`${(I/1e6).toFixed(1)}M`:I>=1e3?`${(I/1e3).toFixed(0)}K`:f};return n?Js.createPortal(e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",dir:"rtl",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-[900px] max-w-[95vw] max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-l from-red-50 to-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-red-500 flex items-center justify-center",children:e.jsx(Fs,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"×—×™×¤×•×© ×¡×¨×˜×•×Ÿ YouTube"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["×¡×¨×˜×•× ×™× ×—×™× ×•×›×™×™× ×ž×•×ª××ž×™× ×œ",a]})]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(ti,{className:"w-6 h-6 text-gray-500"})})]}),e.jsxs("div",{className:"p-4 bg-gray-50 border-b border-gray-200",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",value:l,onChange:f=>c(f.target.value),onKeyPress:J,placeholder:`×—×¤×© ×¡×¨×˜×•×Ÿ ×‘× ×•×©× ${d||"×”× ×•×©×"}...`,className:"w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none",autoFocus:!0}),e.jsx(Bn,{className:"absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"})]}),e.jsx("button",{onClick:U,disabled:g||!l.trim(),className:"px-6 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(ri,{className:"w-5 h-5 animate-spin"}),"×ž×—×¤×©..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Bn,{className:"w-5 h-5"}),"×—×¤×©"]})})]}),e.jsxs("div",{className:"flex gap-2 mt-3 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-200",children:[e.jsx(Pn,{className:"w-3 h-3"})," ×¢×‘×¨×™×ª/×›×ª×•×‘×™×•×ª"]}),e.jsxs("span",{className:"flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-200",children:[e.jsx(Un,{className:"w-3 h-3 text-green-500"})," ×—×™×¤×•×© ×‘×˜×•×—"]}),e.jsxs("span",{className:"flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-200",children:[e.jsx(si,{className:"w-3 h-3"})," 1-20 ×“×§×•×ª"]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[T&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{className:"text-red-500 mb-2",children:T}),e.jsx("p",{className:"text-sm",children:"×˜×™×¤: × ×¡×” ×œ×—×¤×© ×‘×ž×™×œ×™× ×¤×©×•×˜×•×ª ×™×•×ª×¨ ××• ×‘×¢×‘×¨×™×ª"})]}),!g&&v.length===0&&!T&&e.jsxs("div",{className:"text-center py-16 text-gray-500",children:[e.jsx(Fs,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-lg font-medium",children:"×—×¤×© ×¡×¨×˜×•×Ÿ ×—×™× ×•×›×™"}),e.jsx("p",{className:"text-sm mt-2",children:"×”×§×œ×“ × ×•×©× ×•×”×ž×¢×¨×›×ª ×ª×ž×¦× ×¡×¨×˜×•× ×™× ×ž×ª××™×ž×™× ×œ×©×›×‘×ª ×”×’×™×œ"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:v.map(f=>e.jsxs("div",{className:`bg-white rounded-xl border-2 overflow-hidden transition-all hover:shadow-lg cursor-pointer ${_===f.videoId?"border-red-500 ring-2 ring-red-200":"border-gray-200 hover:border-red-300"}`,onClick:()=>R(M===f.videoId?null:f.videoId),children:[e.jsx("div",{className:"relative aspect-video bg-gray-100",children:M===f.videoId?e.jsx("iframe",{src:`${f.embedUrl}?autoplay=1&rel=0`,className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:f.thumbnailUrl,alt:f.title,className:"w-full h-full object-cover",loading:"lazy",decoding:"async"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 hover:opacity-100 transition-opacity",children:e.jsx("div",{className:"w-14 h-14 rounded-full bg-red-500 flex items-center justify-center",children:e.jsx(Fs,{className:"w-6 h-6 text-white mr-[-2px]"})})}),e.jsx("span",{className:"absolute bottom-2 left-2 bg-black/80 text-white text-xs px-2 py-1 rounded",children:f.duration})]})}),e.jsxs("div",{className:"p-3",children:[e.jsx("h3",{className:"font-medium text-gray-800 line-clamp-2 text-sm mb-1",children:f.title}),e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:f.channelTitle}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`flex items-center gap-1 ${k(f.relevanceScore)}`,children:[e.jsx(ni,{className:"w-3 h-3"}),f.relevanceScore,"%"]}),f.hasCaptions&&e.jsxs("span",{className:"flex items-center gap-1 text-blue-600",children:[e.jsx(Pn,{className:"w-3 h-3"}),"×›×ª×•×‘×™×•×ª"]})]}),e.jsxs("span",{className:"text-gray-400",children:[G(f.viewCount)," ×¦×¤×™×•×ª"]})]}),e.jsxs("button",{onClick:I=>{I.stopPropagation(),X(f)},className:"w-full mt-3 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors flex items-center justify-center gap-2",children:[e.jsx(Un,{className:"w-4 h-4"}),"×‘×—×¨ ×¡×¨×˜×•×Ÿ ×–×”"]})]})]},f.videoId))})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 bg-gray-50 text-center text-xs text-gray-500",children:"×”×¡×¨×˜×•× ×™× ×¢×‘×¨×• ×¡×™× ×•×Ÿ ××•×˜×•×ž×˜×™ ×œ×ª×•×›×Ÿ ×‘×˜×•×— ×•×—×™× ×•×›×™ ×‘×œ×‘×“"})]})}),document.body):null},ii=[{name:"×›×—×•×œ",value:"#3B82F6"},{name:"×™×¨×•×§",value:"#10B981"},{name:"×›×ª×•×",value:"#F59E0B"},{name:"××“×•×",value:"#EF4444"},{name:"×¡×’×•×œ",value:"#8B5CF6"},{name:"×•×¨×•×“",value:"#EC4899"},{name:"×¦×™××Ÿ",value:"#06B6D4"},{name:"××¤×•×¨",value:"#6B7280"}],Xt=({data:n,id:s,selected:r})=>{const[a,d]=S.useState(!1),[p,l]=S.useState(n.label),c=n.color||"#fff",B=c.toLowerCase()==="#fff"||c.toLowerCase()==="#ffffff"||c.startsWith("#")&&parseInt(c.slice(1,3),16)>180?"#1f2937":"#ffffff",g=h=>{h.stopPropagation(),d(!0)},x=()=>{d(!1),n.onLabelChange&&p!==n.label&&n.onLabelChange(s,p)},T=h=>{h.key==="Enter"&&x(),h.key==="Escape"&&(l(n.label),d(!1))};return e.jsxs("div",{className:`px-4 py-2 rounded-xl shadow-md border-2 min-w-[100px] text-center cursor-pointer transition-all ${r?"ring-2 ring-blue-500 ring-offset-2":""}`,style:{backgroundColor:c,borderColor:r?"#3B82F6":`${c}80`,direction:"rtl"},onDoubleClick:g,children:[e.jsx(hs,{type:"target",position:fs.Top,className:"w-3 h-3 !bg-blue-400"}),e.jsx(hs,{type:"source",position:fs.Bottom,className:"w-3 h-3 !bg-blue-400"}),e.jsx(hs,{type:"target",position:fs.Right,className:"w-3 h-3 !bg-blue-400"}),e.jsx(hs,{type:"source",position:fs.Left,className:"w-3 h-3 !bg-blue-400"}),a?e.jsx("input",{type:"text",value:p,onChange:h=>l(h.target.value),onBlur:x,onKeyDown:T,className:"w-full bg-transparent border-none outline-none text-center font-bold text-sm",style:{color:B},autoFocus:!0,onClick:h=>h.stopPropagation()}):e.jsx("div",{className:"font-bold text-sm",style:{color:B},children:n.label})]})},oi={default:Xt,topic:Xt,subtopic:Xt,detail:Xt,example:Xt},li=n=>{var s;return((s=n.data)==null?void 0:s.color)||"#94a3b8"},ci=({content:n,onChange:s,onSave:r})=>{const[a,d]=oa(n.nodes),[p,l]=la(n.edges),[c,v]=S.useState(null),[B,g]=S.useState(!1),x=S.useCallback(f=>{d(I=>ca(f,I))},[d]),T=S.useCallback(f=>{l(I=>da(f,I))},[l]),h=S.useCallback(f=>{l(I=>ua({...f,id:`e-${ze()}`,style:{stroke:"#94a3b8",strokeWidth:2}},I))},[l]),_=S.useCallback((f,I)=>{v(I.id),g(!1)},[]),E=S.useCallback(()=>{v(null),g(!1)},[]),M=()=>{let f=400,I=300;if(c){const j=a.find(C=>C.id===c);j&&(f=j.position.x-150,I=j.position.y+100)}const F={id:ze(),type:"subtopic",data:{label:"×¦×•×ž×ª ×—×“×©",color:"#10B981"},position:{x:f,y:I}};d(j=>[...j,F]),c&&l(j=>[...j,{id:`e-${ze()}`,source:c,target:F.id,style:{stroke:"#94a3b8",strokeWidth:2}}]),v(F.id)},R=()=>{if(c){if(a.length>0&&a[0].id===c){alert("×œ× × ×™×ª×Ÿ ×œ×ž×—×•×§ ××ª ×”×¦×•×ž×ª ×”×¨××©×™");return}d(f=>f.filter(I=>I.id!==c)),l(f=>f.filter(I=>I.source!==c&&I.target!==c)),v(null)}},U=f=>{c&&(d(I=>I.map(F=>F.id===c?{...F,data:{...F.data,color:f}}:F)),g(!1))},J=S.useCallback((f,I)=>{d(F=>F.map(j=>j.id===f?{...j,data:{...j.data,label:I}}:j))},[d]),X=S.useMemo(()=>a.map(f=>({...f,data:{...f.data,onLabelChange:J}})),[a,J]),k=S.useMemo(()=>p.map(f=>({...f,style:{stroke:"#94a3b8",strokeWidth:2}})),[p]),G=()=>{const f={...n,nodes:a,edges:p};s(f),r==null||r()};return e.jsxs("div",{className:"bg-white rounded-2xl border border-gray-200 overflow-hidden",dir:"rtl",children:[e.jsx("div",{className:"h-[500px] relative",children:e.jsxs(ma,{nodes:X,edges:k,nodeTypes:oi,onNodesChange:x,onEdgesChange:T,onConnect:h,onNodeClick:_,onPaneClick:E,fitView:!0,fitViewOptions:{padding:.2},proOptions:{hideAttribution:!0},snapToGrid:!0,snapGrid:[15,15],children:[e.jsx(ga,{position:"bottom-left"}),e.jsx(pa,{nodeColor:li,maskColor:"rgba(240, 240, 240, 0.8)",position:"bottom-right",pannable:!0,zoomable:!0}),e.jsx(xa,{color:"#e0e7ff",gap:16}),e.jsxs(ha,{position:"top-right",className:"flex gap-2 bg-white/95 p-3 rounded-xl shadow-lg border border-gray-200",children:[e.jsx("button",{onClick:M,className:"p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors",title:"×”×•×¡×£ ×¦×•×ž×ª",children:e.jsx(ba,{className:"w-5 h-5"})}),e.jsx("button",{onClick:R,disabled:!c,className:"p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed",title:"×ž×—×§ ×¦×•×ž×ª × ×‘×—×¨",children:e.jsx(wa,{className:"w-5 h-5"})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>g(!B),disabled:!c,className:"p-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed",title:"×©× ×” ×¦×‘×¢",children:e.jsx($a,{className:"w-5 h-5"})}),B&&c&&e.jsxs("div",{className:"absolute top-full left-0 mt-2 p-2 bg-white rounded-xl shadow-xl border border-gray-200 flex flex-wrap gap-1 z-50 w-[140px]",children:[ii.map(f=>e.jsx("button",{onClick:()=>U(f.value),className:"w-7 h-7 rounded-full border-2 border-white shadow-md hover:scale-110 transition-transform",style:{backgroundColor:f.value},title:f.name},f.value)),e.jsx("button",{onClick:()=>g(!1),className:"w-full mt-1 p-1 text-xs text-gray-500 hover:text-gray-700",children:e.jsx(Fn,{className:"w-4 h-4 mx-auto"})})]})]}),e.jsx("div",{className:"w-px bg-gray-300 mx-1"}),e.jsxs("button",{onClick:G,className:"p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1 px-3",children:[e.jsx(On,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:"×©×ž×•×¨"})]})]})]})}),e.jsx("div",{className:"p-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500 text-center",children:"×œ×—×¥ ×¤×¢×ž×™×™× ×¢×œ ×¦×•×ž×ª ×œ×¢×¨×™×›×ª ×˜×§×¡×˜ | ×’×¨×•×¨ ×¦×ž×ª×™× ×›×“×™ ×œ×¡×“×¨ | ×—×‘×¨ ×‘×™×Ÿ ×¦×ž×ª×™× ×¢×œ ×™×“×™ ×’×¨×™×¨×” ×ž× ×§×•×“×ª ×”×—×™×‘×•×¨"})]})},di=n=>e.jsx(ia,{children:e.jsx(ci,{...n})}),ui=Hs,mi=async(n,s,r,a=12)=>{const d=n.slice(0,3e3),p=`Create a Mind Map for the topic: "${s}"
Grade level: ${r}
Maximum nodes: ${a}

Source content:
${d}

Return JSON with this structure:
{
    "title": "Map Title",
    "nodes": [
        {
            "id": "node-1",
            "type": "topic",
            "data": { "label": "Main Topic", "description": "Short description", "color": "#4F46E5" },
            "position": { "x": 0, "y": 0 }
        },
        {
            "id": "node-2",
            "type": "subtopic",
            "data": { "label": "Subtopic", "color": "#10B981" },
            "position": { "x": 200, "y": -100 }
        }
    ],
    "edges": [
        { "id": "edge-1", "source": "node-1", "target": "node-2", "type": "smoothstep" }
    ],
    "suggestedLayout": "RL"
}

Guidelines:
- First node (type: "topic") is central, positioned at 0,0
- Arrange nodes hierarchically: topic -> subtopic -> detail -> example
- Use different colors for each level
- Create edges between related nodes
- suggestedLayout can be: "TB", "BT", "LR", "RL" (right-to-left for Hebrew)`;try{const c=(await ui.chat.completions.create({model:Ws,messages:[{role:"user",content:p}],response_format:{type:"json_object"},temperature:.7})).choices[0].message.content||"{}";return JSON.parse(c)}catch(l){return console.error("Mind Map Generation Error",l),null}},gi=({isOpen:n,onClose:s,onGenerate:r,sourceText:a,topic:d,gradeLevel:p})=>{const[l,c]=S.useState(!1),[v,B]=S.useState(null),[g,x]=S.useState(null),[T,h]=S.useState(12),_=async()=>{c(!0),x(null);try{const U=await mi(a,d,p,T);if(U){const J={title:U.title,nodes:U.nodes,edges:U.edges,layoutDirection:U.suggestedLayout||"RL"};B(J)}else x("×œ× ×”×¦×œ×—× ×• ×œ×™×™×¦×¨ ××ª ×ž×¤×ª ×”×—×©×™×‘×”. × ×¡×• ×©×•×‘.")}catch(U){x(U.message||"×©×’×™××” ×‘×™×¦×™×¨×ª ×ž×¤×ª ×”×—×©×™×‘×”")}finally{c(!1)}},E=()=>{v&&(r(v),M())},M=()=>{B(null),x(null),s()},R=()=>{B(null),_()};return n?Js.createPortal(e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",dir:"rtl",onClick:U=>U.target===U.currentTarget&&M(),children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-[900px] max-w-[95vw] max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-l from-purple-50 to-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg",children:e.jsx(ja,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"×™×¦×™×¨×ª ×ž×¤×ª ×—×©×™×‘×”"}),e.jsx("p",{className:"text-sm text-gray-500",children:"×ž×¤×” ×•×™×–×•××œ×™×ª ×ž×ª×•×›×Ÿ ×”×©×™×¢×•×¨"})]})]}),e.jsx("button",{onClick:M,className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Fn,{className:"w-6 h-6 text-gray-500"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:v?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"font-bold text-lg text-gray-800 flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"âœ¨"}),"×ª×¦×•×’×” ×ž×§×“×™×ž×”"]}),e.jsxs("span",{className:"text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full",children:[v.nodes.length," ×¦×ž×ª×™×"]})]}),e.jsx(fa,{content:v,title:v.title,className:"shadow-lg"}),e.jsxs("div",{className:"bg-amber-50 p-4 rounded-xl border border-amber-200 text-sm text-amber-800",children:[e.jsx("span",{className:"font-medium",children:"ðŸ’¡ ×˜×™×¤:"})," ×œ××—×¨ ×”×”×•×¡×¤×” ×œ×™×—×™×“×”, ×ª×•×›×œ ×œ×¢×¨×•×š ××ª ×”×ž×¤×” - ×œ×”×•×¡×™×£ ×¦×ž×ª×™×, ×œ×©× ×•×ª ×¦×‘×¢×™× ×•×œ×”×–×™×– ××œ×ž× ×˜×™×."]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:R,disabled:l,className:"flex-1 py-3 border-2 border-purple-300 text-purple-600 rounded-xl font-bold hover:bg-purple-50 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:l?e.jsxs(e.Fragment,{children:[e.jsx(vn,{className:"w-5 h-5 animate-spin"}),"×ž×™×™×¦×¨ ×ž×—×“×©..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fr,{className:"w-5 h-5"}),"×™×™×¦×¨ ×ž×—×“×©"]})}),e.jsxs("button",{onClick:E,className:"flex-1 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold hover:from-purple-700 hover:to-indigo-700 transition-all flex items-center justify-center gap-2 shadow-lg",children:[e.jsx(On,{className:"w-5 h-5"}),"×”×•×¡×£ ×œ×™×—×™×“×”"]})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-indigo-50 p-5 rounded-xl border border-purple-100",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"×ž×¡×¤×¨ ×¦×ž×ª×™× ×ž×§×¡×™×ž×œ×™"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"range",min:"6",max:"20",value:T,onChange:U=>h(parseInt(U.target.value)),className:"flex-1 h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer accent-purple-600"}),e.jsx("div",{className:"w-12 h-12 rounded-xl bg-white border-2 border-purple-200 flex items-center justify-center font-bold text-purple-600 text-lg",children:T})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"×ž×¤×” ×¢× ×¤×—×•×ª ×¦×ž×ª×™× ×ª×”×™×” ×¤×©×•×˜×” ×™×•×ª×¨ ×œ×”×‘× ×”. ×ž×¤×” ×¢× ×™×•×ª×¨ ×¦×ž×ª×™× ×ª×›×™×œ ×™×•×ª×¨ ×¤×¨×˜×™×."})]}),d&&e.jsx("div",{className:"bg-blue-50 p-4 rounded-xl border border-blue-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“š"}),e.jsx("span",{className:"font-medium",children:"× ×•×©×:"}),e.jsx("span",{children:d})]})}),e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-7xl mb-4",children:"ðŸ—ºï¸"}),e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:"×¦×•×¨ ×ž×¤×ª ×—×©×™×‘×” ×ž×”×ª×•×›×Ÿ"}),e.jsx("p",{className:"text-gray-500 text-sm max-w-md mx-auto",children:"×”×ž×¢×¨×›×ª ×ª× ×ª×— ××ª ×ª×•×›×Ÿ ×”×™×—×™×“×” ×•×ª×™×¦×•×¨ ×ž×¤×ª ×—×©×™×‘×” ×•×™×–×•××œ×™×ª ×¢× ×”×§×©×¨×™× ×‘×™×Ÿ ×”×ž×•×©×’×™× ×”×ž×¨×›×–×™×™×."})]}),g&&e.jsxs("div",{className:"bg-red-50 text-red-600 p-4 rounded-xl text-center border border-red-200",children:[e.jsx("span",{className:"text-lg mr-2",children:"âš ï¸"}),g]}),e.jsx("button",{onClick:_,disabled:l,className:"w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold hover:from-purple-700 hover:to-indigo-700 transition-all disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg",children:l?e.jsxs(e.Fragment,{children:[e.jsx(vn,{className:"w-5 h-5 animate-spin"}),"×ž×™×™×¦×¨ ×ž×¤×ª ×—×©×™×‘×”..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Rn,{className:"w-5 h-5"}),"×¦×•×¨ ×ž×¤×ª ×—×©×™×‘×”"]})})]})})]})}),document.body):null},pi=!0,$e={text:"×˜×§×¡×˜ / ×”×¡×‘×¨",image:"×ª×ž×•× ×”",video:"×•×™×“××•","multiple-choice":"×©××œ×” ××ž×¨×™×§××™×ª","open-question":"×©××œ×” ×¤×ª×•×—×”","interactive-chat":"×¦×³××˜ ××™× ×˜×¨××§×˜×™×‘×™",fill_in_blanks:"×”×©×œ×ž×ª ×ž×©×¤×˜×™×",ordering:"×¡×™×“×•×¨ ×¨×¦×£",categorization:"×ž×™×•×Ÿ ×œ×§×˜×’×•×¨×™×•×ª",memory_game:"×ž×©×—×§ ×–×™×›×¨×•×Ÿ",true_false_speed:"××ž×ª ××• ×©×§×¨",matching:"×”×ª××ž×”",highlight:"×¡×™×ž×•×Ÿ ×‘×˜×§×¡×˜",sentence_builder:"×‘× ×™×™×ª ×ž×©×¤×˜",image_labeling:"×ª×™×•×’ ×ª×ž×•× ×”",table_completion:"×”×©×œ×ž×ª ×˜×‘×œ×”",text_selection:"×‘×—×™×¨×” ×ž×˜×§×¡×˜",rating_scale:"×¡×§××œ×ª ×“×™×¨×•×’",matrix:"×ž×˜×¨×™×§×¡","audio-response":"×ª×©×•×‘×” ×§×•×œ×™×ª",mindmap:"×ž×¤×ª ×—×©×™×‘×”","activity-intro":"×¤×ª×™×—×”","scenario-image":"×ª×ž×•× ×ª ×ª×¨×—×™×©",infographic:"××™× ×¤×•×’×¨×¤×™×§×”",podcast:"×¤×•×“×§××¡×˜","loading-placeholder":"×˜×•×¢×Ÿ..."},En=n=>{const s=document.createElement("div");return s.innerHTML=n,s.textContent||s.innerText||""},xi=n=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...n,children:e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"})}),Ln=n=>typeof n=="string"?n:n&&typeof n=="object"&&n.text?n.text:"",hi=n=>[{label:"×©×¤×¨ × ×™×¡×•×—",prompt:`×©×¤×¨ ××ª ×”× ×™×¡×•×— ×©×™×”×™×” ×–×•×¨×, ×ž×§×¦×•×¢×™ ×•×ž×•×ª×× ×œ×ª×œ×ž×™×“×™ ${n}`},{label:"×§×¦×¨ ×˜×§×¡×˜",prompt:"×§×¦×¨ ××ª ×”×˜×§×¡×˜ ×ª×•×š ×©×ž×™×¨×” ×¢×œ ×”×ž×¡×¨ ×”×¢×™×§×¨×™"},{label:"×¤×©×˜ ×©×¤×”",prompt:`×¤×©×˜ ××ª ×”×©×¤×” ×•×”×ž×•×©×’×™× ×œ×¨×ž×” ×©×œ ×ª×œ×ž×™×“×™ ${n}, ×”×¡×‘×¨ ×ž×™×œ×™× ×§×©×•×ª`},{label:"×”×¢×ž×§ ×ª×•×›×Ÿ",prompt:"×”×•×¡×£ ×¢×•×ž×§, ×“×•×’×ž××•×ª ×•×”×§×©×¨ ×¨×—×‘ ×™×•×ª×¨"}],fi=({unit:n,gradeLevel:s="×›×œ×œ×™",subject:r,onSave:a,onCancel:d,onPreview:p})=>{var Ys,Qs,Xs,Ks;const{course:l}=zn(),[c,v]=S.useState(n),B=S.useRef(n);S.useEffect(()=>{B.current=c},[c]);const[g,x]=S.useState(null),[T,h]=S.useState(null),[_,E]=S.useState(null),[M,R]=S.useState(!1),[U,J]=S.useState(!1),[X,k]=S.useState(!1),[G,f]=S.useState({}),[I,F]=S.useState({}),j=S.useRef(!1),[C,$]=S.useState(!1),[V,Q]=S.useState(!1),[Y,se]=S.useState(!1),[ne,fe]=S.useState({}),[je,Ne]=S.useState(null),[Pe,He]=S.useState({}),[Ut,ns]=S.useState({}),[rs,kt]=S.useState(!1),[as,qt]=S.useState(null),[N,de]=S.useState(!1),[ve,ye]=S.useState(null),[We,Je]=S.useState(null),ue=async t=>{const i=as;if(i){x(i);try{let u="";try{const y=await Yt.processYoutubeUrl(t.watchUrl);y!=null&&y.text&&(u=y.text)}catch(y){console.warn("Could not get transcript for YouTube video:",y)}const m=c.activityBlocks.find(y=>y.id===i);m&&w(i,m.content,{media:t.embedUrl,mediaType:"video",transcript:u,videoId:t.videoId,videoTitle:t.title,channelTitle:t.channelTitle,duration:t.duration,thumbnailUrl:t.thumbnailUrl,hasCaptions:t.hasCaptions,educationalScore:t.educationalScore,source:"youtube-search"})}catch(u){console.error("Error embedding YouTube video:",u)}finally{x(null),f({...G,[i]:null})}}},ee=()=>{Y?window.confirm("×™×© ×œ×š ×©×™× ×•×™×™× ×©×œ× × ×©×ž×¨×•. ×”×× ×œ×¦××ª ×œ×œ× ×©×ž×™×¨×”?")&&d():d()},[oe,ae]=S.useState(!1),[q,K]=S.useState(()=>{const t=new Date;return t.setDate(t.getDate()+3),{title:n.title||"",dueDate:t.toISOString().split("T")[0],dueTime:"23:59",instructions:""}}),[_e,st]=S.useState(null),ie=()=>{Y&&!confirm(`âš ï¸ ×™×© ×©×™× ×•×™×™× ×©×œ× × ×©×ž×¨×•!

×× ×ª×™×¦×¨×• ×§×™×©×•×¨ ×¢×›×©×™×•, ×”×§×™×©×•×¨ ×™×¤× ×” ×œ×’×¨×¡×” ×œ×œ× ×”×©×™× ×•×™×™× ×”××—×¨×•× ×™×.

×ž×•×ž×œ×¥ ×œ×œ×—×•×¥ "×©×ž×™×¨×”" ×§×•×“×, ××• ×œ×—×¦×• "××™×©×•×¨" ×œ×”×ž×©×™×š ×‘×›×œ ×–××ª.`)||(K(t=>({...t,title:`×”×’×©×”: ${n.title||c.title}`})),ae(!0))},Ee=async()=>{if(!q.title||!q.dueDate)return alert("×—×¡×¨×™× ×¤×¨×˜×™×");try{const t=new Date(`${q.dueDate}T${q.dueTime}`),i=await Mr(Dr(zt,"assignments"),{courseId:l.id,title:q.title,dueDate:t.toISOString(),instructions:q.instructions,createdAt:Fr(),teacherId:l.teacherId||"unknown"}),u=`${window.location.origin}/?assignmentId=${i.id}`;st(u)}catch(t){console.error("Error creating assignment",t),alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ž×©×™×ž×”")}},Ge=()=>{_e&&navigator.clipboard.writeText(_e)},Be=()=>{ae(!1),st(null)};if(!l)return null;const le=l.mode==="exam"||n.type==="test",ft=hi(s),O="cursor-pointer bg-white text-gray-600 hover:text-blue-600 hover:bg-blue-50 border border-gray-200 hover:border-blue-200 px-3 py-1.5 rounded-lg text-xs flex items-center gap-2 transition-all shadow-sm",Te=zs.useMemo(()=>c.activityBlocks?c.activityBlocks.reduce((t,i)=>{var u;return t+(((u=i.metadata)==null?void 0:u.score)||0)},0):0,[c.activityBlocks]);S.useEffect(()=>{(async()=>{var y,z,xe,H;if(n.activityBlocks&&n.activityBlocks.length>0||j.current){v(n);return}j.current=!0,R(!0);const i=((y=l==null?void 0:l.wizardData)==null?void 0:y.settings)||{},u=i.productType||"lesson",m=new(await Dn(async()=>{const{GenerationTimer:Me}=await import("./generationTimingService-B4dIuwqG.js");return{GenerationTimer:Me}},__vite__mapDeps([0,1,2]))).GenerationTimer(l.id,n.id,u,l);try{console.log("ðŸš€ Starting Incremental Generation: Skeleton Phase..."),v(re=>({...re,activityBlocks:[{id:"skeleton-loader",type:"text",content:"× × ×œ×”×ž×ª×™×Ÿ ×ž×¡×¤×¨ ×©× ×™×•×ª, ×”×ž×¢×¨×›×ª ×ž×™×™×¦×¨×ª ×¢×‘×•×¨×›× ××ª ×”×ª×•×›×Ÿ...",metadata:{isSkeleton:!0}}]}));const Me=i.activityLength||"medium",Ze=i.includeBot===!0,ge=(l==null?void 0:l.fullBookContent)||((z=l==null?void 0:l.wizardData)==null?void 0:z.pastedText)||"";if(console.log("ðŸ“š Source Text Length:",(ge==null?void 0:ge.length)||0),u==="podcast"){console.log("ðŸŽ™ï¸ Generating Podcast Activity...");const re={id:ze(),type:"podcast",content:{title:`×¤×•×“×§××¡×˜: ${n.title}`,description:"×”××–×™× ×• ×œ×¤×¨×§ ×”×‘× ×•×¢× ×• ×¢×œ ×”×©××œ×•×ª."},metadata:{autoGenerate:!0}};v(ce=>({...ce,activityBlocks:[re]})),R(!1);return}if(pi&&u==="activity"&&Kt()){console.log("ðŸš€ Using NEW streaming generation (parallel, faster)...");try{const re=performance.now(),ce=[];let De=null;const{result:et}=await er({topic:n.title,gradeLevel:s,subject:i.subject||"×›×œ×œ×™",sourceText:ge,activityLength:Me,productType:u,questionPreferences:i.questionPreferences,contentTone:i.contentTone||"friendly"},{onProgress:(te,we)=>{console.log(`â³ [Streaming] ${te}`,we),v(tt=>({...tt,activityBlocks:[{id:"streaming-progress",type:"text",content:te,metadata:{isSkeleton:!0}}]}))},onSkeletonComplete:te=>{var we,tt;if(console.log("ðŸ“‹ [Streaming] Skeleton ready:",(we=te.steps)==null?void 0:we.length,"steps"),m.mark("skeleton_complete"),m.setStepCount(((tt=te.steps)==null?void 0:tt.length)||5),te.context_image_prompt){const gt=n.title||(l==null?void 0:l.title)||"",pt=i.subject||"×›×œ×œ×™";In(gt,pt,s,te.context_image_prompt).then(lt=>{lt&&(console.log("ðŸ–¼ï¸ [Streaming] Context image ready!"),De=lt,v(wt=>({...wt,activityBlocks:[lt,...wt.activityBlocks.filter(jt=>jt.id!=="streaming-progress"&&jt.type!=="activity-intro")]})))}).catch(lt=>console.warn("âš ï¸ Context image failed:",lt))}},onStepComplete:(te,we,tt)=>{if(console.log(`âœ… [Streaming] Step ${we}/${tt} complete`),te.teach_content&&te.teach_content.trim().length>0){const pt={id:ze(),type:"teach",content:te.teach_content,metadata:{stepNumber:te.step_number,bloomLevel:te.bloom_level}};ce.push(pt)}const gt=It(te);console.log("ðŸ“¦ [DEBUG] Step from AI:",JSON.stringify(te,null,2)),console.log("ðŸ“¦ [DEBUG] Parsed block:",JSON.stringify(gt,null,2)),gt?ce.push(gt):console.error("âŒ [DEBUG] Parser returned null for step:",we),v(pt=>{const lt=ce.filter(jt=>jt.id!=="streaming-progress"),wt=De?[De,...lt]:lt;return{...pt,activityBlocks:wt}})},onComplete:te=>{const we=performance.now()-re;console.log(`ðŸ [Streaming] Complete in ${(we/1e3).toFixed(1)}s`),m.mark("content_complete")},onError:te=>{throw console.error("âŒ [Streaming] Error:",te),new Error(te)}}),Ue=await et;if(console.log("âœ… [Streaming] Final result:",Ue.title,"with",(xe=Ue.steps)==null?void 0:xe.length,"steps"),console.log("ðŸ–¼ï¸ [Streaming] Context image block exists:",!!De,"streamedBlocks:",ce.length),ce.length===0&&Ue.steps)for(const te of Ue.steps){if(te.teach_content&&te.teach_content.trim().length>0){const tt={id:ze(),type:"teach",content:te.teach_content,metadata:{stepNumber:te.step_number,bloomLevel:te.bloom_level}};ce.push(tt)}const we=It(te);we&&ce.push(we)}const at=De||null;console.log("ðŸ–¼ï¸ [Streaming] Preparing final blocks. contextImageBlock:",!!De,"streamedBlocks:",ce.length);const mt=at?[at,...ce]:ce;console.log("ðŸ–¼ï¸ [Streaming] Final blocks array created:",mt.length,"with context image:",!!at),v(te=>({...te,title:Ue.title||te.title,activityBlocks:mt}));const Ot={...B.current,title:Ue.title||B.current.title,activityBlocks:mt};if(console.log("ðŸ–¼ï¸ [Streaming] Saving unit with",mt.length,"blocks"),setTimeout(()=>{a(Ot)},100),await m.finish(!0),R(!1),(H=Ue.steps)!=null&&H.some(te=>{var we;return(we=te.suggested_media)==null?void 0:we.needed})){console.log("ðŸ“· [Streaming] Processing suggested_media in background...");const te=n.title||(l==null?void 0:l.title)||"";Va(Ue.steps,te,(we,tt,gt)=>{console.log(`ðŸ“· [SuggestedMedia] ${we} (${tt}/${gt})`)}).then(we=>{we.size>0&&(console.log(`âœ… [Streaming] Generated ${we.size} media blocks`),v(tt=>{var lt;const gt=[...tt.activityBlocks||[]],pt=[];for(const wt of gt){const jt=(lt=wt.metadata)==null?void 0:lt.stepNumber,Vt=jt?we.get(jt):null;Vt&&pt.push(Vt),pt.push(wt)}return{...tt,activityBlocks:pt}}),setTimeout(()=>a(B.current),100))}).catch(we=>{console.warn("âš ï¸ [Streaming] suggested_media processing failed:",we)})}return}catch(re){console.warn("âš ï¸ [Streaming] Failed, falling back to legacy flow:",re.message)}}const Ie=await bs(n.title,s,Me,ge,l.mode||i.courseMode||"learning",i.taxonomy,u);if(!Ie||!Ie.steps)throw new Error("Failed to generate skeleton");m.mark("skeleton_complete"),m.setStepCount(Ie.steps.length),console.log("âœ… Skeleton Ready:",Ie.steps.length,"steps");let ut=null;if(u==="activity"){const re=n.title||(l==null?void 0:l.title)||"",ce=i.subject||"×›×œ×œ×™",De=Ie.context_image_prompt;console.log("ðŸ–¼ï¸ [Parallel] Starting context image generation alongside content..."),De?console.log("ðŸŽ¯ Using AI-generated prompt from skeleton:",De.substring(0,100)+"..."):console.warn("âš ï¸ No context_image_prompt from skeleton - using generic fallback. Topic:",re,"Subject:",ce),ut=In(re,ce,s,De)}const ls=Ie.steps.map(re=>({id:`step-${re.step_number}`,type:"loading-placeholder",content:{stepNumber:re.step_number,title:re.title,message:"×›×•×ª×‘ ×ª×•×›×Ÿ..."},metadata:{isLoading:!0,stepInfo:re}})),cs={id:ze(),type:"text",content:`# ×ž×ª×—×™×œ×™×! ðŸš€
×”×¤×¢×™×œ×•×ª ×‘× ×•×©× **${n.title}** ×™×•×¦××ª ×œ×“×¨×š.
×œ×¤× ×™×›× ×ª×¨×’×•×œ ×§×¦×¨ ×•×ž×ž×•×§×“. ×‘×”×¦×œ×—×”!`,metadata:{}};let Ft=null;if(Ze){const re=i.botPersona||"socratic",ce=xs[re]||xs.socratic;Ft={id:ze(),type:"interactive-chat",content:{title:ce.name,description:`×¢×–×¨×” ×‘× ×•×©× ${n.title}`},metadata:{botPersona:re,initialMessage:ce.initialMessage,systemPrompt:ce.systemPrompt}}}const ds=[cs,...Ft?[Ft]:[],...ls];v(re=>({...re,activityBlocks:ds})),console.log("âš¡ Triggering Parallel Step Generation...");const us=Ie.steps.length,ms=Ie.steps.map(async re=>{const ce=await ws(n.title,re,s,ge,void 0,l.mode||"learning",void 0,us);if(console.log(`ðŸ“¦ AI Response for Step ${re.step_number}:`,Object.keys(ce||{})),ce!=null&&ce.teach_content?console.log(`   ðŸ“ Found Teach Content for Step ${re.step_number}`):console.warn(`   âš ï¸ NO Teach Content for Step ${re.step_number} (Mode: ${l.mode})`),ce){const De=[];ce.teach_content&&De.push({id:ze(),type:"text",content:ce.teach_content,metadata:{note:`Step ${re.step_number}`}});const et=It(ce);et&&De.push(et),v(Ue=>{const at=[...Ue.activityBlocks],mt=at.findIndex(Ot=>Ot.id===`step-${re.step_number}`);return mt!==-1&&at.splice(mt,1,...De),{...Ue,activityBlocks:at}}),et&&_r(et,n.title).then(Ue=>{console.log(`âœ¨ Auto-Enriched block ${Ue.id}`),v(at=>({...at,activityBlocks:at.activityBlocks.map(mt=>mt.id===Ue.id?Ue:mt)}))}).catch(Ue=>console.warn("Auto-enrichment failed",Ue))}});await Promise.all(ms),m.mark("content_complete"),console.log("ðŸ All steps generated. Auto-Saving to Firestore..."),console.log("ðŸ” DEBUG: productType =",u,"| Expected: 'activity'");let Et=null;if(ut&&(m.mark("image_start"),console.log("ðŸ–¼ï¸ [Parallel] Waiting for context image to complete..."),Et=await ut,m.mark("image_complete"),Et?(console.log("âœ… [Parallel] Context image ready! Inserting at beginning..."),v(re=>({...re,activityBlocks:[Et,...re.activityBlocks]}))):console.warn("âš ï¸ [Parallel] Context image not available, continuing without it")),setTimeout(()=>{a(B.current)},100),await m.finish(!0),R(!1),u==="activity"&&!Et){console.log("ðŸ–¼ï¸ [Fallback] Context image failed, trying full enrichment...");const re=n.title||(l==null?void 0:l.title)||"",ce=i.subject||"×›×œ×œ×™",De=B.current;De&&!qa(De)&&Ga(De,re,ce,s,(et,Ue,at)=>{console.log(`ðŸ–¼ï¸ Media Generation: ${et} (${Ue}/${at})`)}).then(et=>{console.log("âœ… Activity enriched with images!"),v(et),a(et)}).catch(et=>{console.warn("âš ï¸ Image enrichment failed (activity still works):",et)})}}catch(Me){console.error("Incremental Auto Generation Failed",Me),await m.finish(!1,(Me==null?void 0:Me.message)||"Unknown error"),R(!1)}})()},[n.id]),S.useEffect(()=>{var i;const t=(i=c.activityBlocks)==null?void 0:i.find(u=>{var m;return u.type==="podcast"&&((m=u.metadata)==null?void 0:m.autoGenerate)});t&&!g&&(console.log("ðŸŽ™ï¸ Auto-triggering podcast generation for block:",t.id),x(t.id),v(u=>({...u,activityBlocks:u.activityBlocks.map(m=>m.id===t.id?{...m,metadata:{...m.metadata,autoGenerate:!1}}:m)})),nt(t.id))},[c.activityBlocks,g]);const dt=async()=>{$(!0);try{await a(c),setTimeout(()=>{$(!1),Q(!0),se(!1),setTimeout(()=>{Q(!1)},3e3)},600)}catch(t){console.error("Save failed",t),$(!1),alert("×©×’×™××” ×‘×©×ž×™×¨×”. ×× × × ×¡×• ×©×•×‘.")}},be=()=>{const t=c.activityBlocks.filter(ge=>ge.type==="multiple-choice"||ge.type==="open-question");if(t.length===0)return alert("××™×Ÿ ×©××œ×•×ª ×‘×™×—×™×“×” ×–×• ×œ×—×œ×•×§×ª × ×™×§×•×“.");const u=prompt("×ž×” ×¡×š ×”× ×™×§×•×“ ×”×›×•×œ×œ ×œ×™×—×™×“×” ×–×•?","100"),m=parseInt(u||"0");if(!m||m<=0)return;const y=t.reduce((ge,Ie)=>ge+(Ie.type==="open-question"?2:1),0),z=Math.floor(m/y);let xe=0;const H=c.activityBlocks.map(ge=>{if(ge.type==="multiple-choice"||ge.type==="open-question"){const Ie=ge.type==="open-question"?2:1,ut=z*Ie;return xe+=ut,{...ge,metadata:{...ge.metadata,score:ut}}}return ge});let Me=m-xe,Ze=0;for(;Me>0;){const ge=H.findIndex((Ie,ut)=>(Ie.type==="multiple-choice"||Ie.type==="open-question")&&ut>=Ze);ge!==-1?(H[ge].metadata.score+=1,Me-=1,Ze=ge+1):Ze=0}v({...c,activityBlocks:H})},ke=(t,i)=>{const u=[...c.activityBlocks];i==="up"&&t>0?[u[t],u[t-1]]=[u[t-1],u[t]]:i==="down"&&t<u.length-1&&([u[t],u[t+1]]=[u[t+1],u[t]]),v({...c,activityBlocks:u})},Le=(t,i="")=>{const u=`××ª×” ×ž× ×—×” ×¤×¢×™×œ×•×ª ×¢×‘×•×¨ ×ž×©×ª×ª×¤×™× ×‘×©×›×‘×ª ×’×™×œ: ${s}. ×”× ×•×©× ×”× ×œ×ž×“: "${c.title}".`,m="×¤×¨×•×˜×•×§×•×œ ×‘×˜×™×—×•×ª (×—×•×‘×”): 1. ×©×ž×•×¨ ×¢×œ ×©×¤×” ×ž×›×‘×“×ª. 2. ×× ×”×ž×©×ª×ª×£ ×ž×‘×™×¢ ×ž×¦×•×§×” ××• ××œ×™×ž×•×ª - ×”×¤×¡×§ ××ª ×”×©×™×— ×•×¤× ×” ×œ×’×•×¨× ××—×¨××™.";let y="";if(le)y="×ž×¦×‘ ×ž×‘×—×Ÿ (EXAM MODE): ×ª×¤×§×™×“×š ×”×•× ×ž×©×’×™×— ×•×¡×™×™×¢×Ÿ ×˜×›× ×™ ×‘×œ×‘×“. ××™×¡×•×¨ ×ž×•×—×œ×˜ ×œ×ª×ª ×ª×©×•×‘×•×ª ××• ×¨×ž×–×™×.";else{const z=xs[t]||xs.socratic;t==="historical"?y=`×›× ×¡ ×œ×“×ž×•×ª ×©×œ ${i||"×“×ž×•×ª ×”×™×¡×˜×•×¨×™×ª"}.`:y=z.systemPrompt}return`${u}
${y}
${m}`},b=async(t,i)=>{const u=l.botPersona||"socratic",m=Or(t,u),y=[...c.activityBlocks||[]];y.splice(i,0,m),v({...c,activityBlocks:y}),se(!0),E(null),Je(m.id),["fill_in_blanks","ordering","categorization","memory_game","multiple-choice","true_false_speed"].includes(t)&&setTimeout(()=>{switch(t){case"fill_in_blanks":Ce(m.id);break;case"ordering":me(m.id);break;case"categorization":St(m.id);break;case"memory_game":Fe(m.id);break;case"multiple-choice":ht(m.id);break;case"true_false_speed":Ts(m.id);break}},100)},he=t=>{confirm("×œ×ž×—×•×§ ××ª ×”×¨×›×™×‘?")&&v({...c,activityBlocks:c.activityBlocks.filter(i=>i.id!==t)})},w=(t,i,u)=>{v(m=>({...m,activityBlocks:m.activityBlocks.map(y=>y.id===t?{...y,content:i,metadata:{...y.metadata,...u}}:y)})),se(!0)},Ke=(t,i)=>{var m;let u;if(i==="×™×™×©×•×")u=t.content;else{const y=i==="×”×‘× ×”"?"scaffolding_variant":"enrichment_variant",z=(m=t.metadata)==null?void 0:m[y];u=(z==null?void 0:z.content)||t.content}return typeof u=="string"?ps(u):u},Ye=(t,i,u)=>{var m;if(u==="×™×™×©×•×")w(t,i);else{const y=c.activityBlocks.find(H=>H.id===t);if(!y)return;const z=u==="×”×‘× ×”"?"scaffolding_variant":"enrichment_variant",xe=((m=y.metadata)==null?void 0:m[z])||{};w(t,y.content,{[z]:{...xe,content:i},has_variants:!0})}},Mt=async(t,i)=>{const u=c.activityBlocks.find(m=>m.id===t);if(u){Ne({blockId:t,level:i});try{const m=c.title||"× ×•×©× ×›×œ×œ×™";let y=null;if(i==="×”×‘× ×”"?y=await Rr(u,m):y=await zr(u,m),y){const z=i==="×”×‘× ×”"?"scaffolding_variant":"enrichment_variant";w(t,u.content,{[z]:y,has_variants:!0})}}catch(m){console.error(`Failed to regenerate ${i} variant:`,m),alert(`×©×’×™××” ×‘×™×¦×™×¨×ª ×’×¨×¡×ª ${i}`)}finally{Ne(null)}}},Bt=({blockId:t,hasVariants:i,currentLevel:u,onChange:m})=>{if(!i)return null;const y=[{key:"×”×‘× ×”",label:"×”×‘× ×”"},{key:"×™×™×©×•×",label:"×™×™×©×•×"},{key:"×”×¢×ž×§×”",label:"×”×¢×ž×§×”"}],z=(je==null?void 0:je.blockId)===t;return e.jsxs("div",{className:"flex items-center gap-2 bg-white border border-gray-200 p-1 rounded-lg",children:[y.map(xe=>e.jsx("button",{onClick:()=>m(xe.key),className:`px-3 py-1.5 rounded-md text-sm font-medium transition-all
                            ${u===xe.key?"bg-gray-700 text-white shadow-sm":"text-gray-600 hover:bg-gray-100"}`,children:xe.label},xe.key)),u!=="×™×™×©×•×"&&e.jsx("button",{onClick:()=>Mt(t,u),disabled:z,className:"p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors disabled:opacity-50",title:`×¦×•×¨ ×ž×—×“×© ×¨×ž×ª ${u}`,children:z&&(je==null?void 0:je.level)===u?e.jsx("div",{className:"w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"}):e.jsx($r,{className:"w-4 h-4"})})]})},Se=(t,i,u)=>{const m=Le(i,"");w(t,u,{botPersona:i,systemPrompt:m})},yt=async(t,i,u="content")=>{var y;const m=(y=t.target.files)==null?void 0:y[0];if(m){if(m.type.startsWith("video")&&m.size>50*1024*1024){alert("×§×•×‘×¥ ×”×•×™×“××• ×’×“×•×œ ×ž×“×™. ×”×’×•×“×œ ×”×ž×§×¡×™×ž×œ×™ ×”×•× 50MB.");return}h(i);try{const z=await Ds(m,m.type.startsWith("video")?"videos":"images");if(u==="content")w(i,z,{fileName:m.name,uploadedFileUrl:z,mediaType:m.type.startsWith("video")?"video":"image"});else{const xe=c.activityBlocks.find(H=>H.id===i);xe&&w(i,xe.content,{media:z,mediaType:m.type.startsWith("video")?"video":"image"})}}catch(z){alert(z.message||"×©×’×™××”")}finally{h(null)}}},Pt=async(t,i,u)=>{if(i){x(t);try{const m=await Br(i,u);w(t,m)}catch{alert("×©×’×™××”")}finally{x(null)}}},Ae=async t=>{x(t);try{const i=c.activityBlocks.map(y=>{var z;return(z=y.metadata)==null?void 0:z.transcript}).filter(y=>y).join(`

`),u=(l.fullBookContent||"")+(i?`

--- Video Transcripts ---
${i}`:"");if(!u||u.length<10){const y=prompt("× ×¨××” ×©××™×Ÿ ×ž×¡×¤×™×§ ×ª×•×›×Ÿ ×œ×™×¦×™×¨×ª ×©××œ×”. ×¢×œ ×ž×” ×ª×¨×¦×• ×©×”×©××œ×” ×ª×”×™×”?");if(!y)return;const z=await Bs(c.title,s,{},y);z&&w(t,{question:z.content.question},{modelAnswer:z.metadata.modelAnswer});return}const m=await Bs(c.title,s,{},u);m?w(t,{question:m.content.question},{modelAnswer:m.metadata.modelAnswer}):alert("××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×©××œ×”. ×× × × ×¡×• ×©×•×‘.")}catch{alert("×©×’×™××”")}finally{x(null)}},ht=async t=>{x(t);try{const i=c.activityBlocks.map(y=>{var z;return(z=y.metadata)==null?void 0:z.transcript}).filter(y=>y).join(`

`),u=(l.fullBookContent||"")+(i?`

--- Video Transcripts ---
${i}`:"");if(!u||u.length<10){const y=prompt("× ×¨××” ×©××™×Ÿ ×ž×¡×¤×™×§ ×ª×•×›×Ÿ ×œ×™×¦×™×¨×ª ×©××œ×”. ×¢×œ ×ž×” ×ª×¨×¦×• ×©×”×©××œ×” ×ª×”×™×”?");if(!y)return;const z=await $s(c.title,s,{},y,r);z&&w(t,{question:z.content.question,options:z.content.options,correctAnswer:z.content.correctAnswer});return}const m=await $s(c.title,s,{},u,r);m?w(t,{question:m.content.question,options:m.content.options,correctAnswer:m.content.correctAnswer}):alert("××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×©××œ×”. ×× × × ×¡×• ×©×•×‘.")}catch{alert("×©×’×™××”")}finally{x(null)}},St=async t=>{x(t);try{const i=l.fullBookContent||"",u=await Lr(c.title,s,i,r);if(u){const{learning_level:m,...y}=u;w(t,y,{learningLevel:m||"×™×™×©×•×"})}}catch{alert("×©×’×™××”")}finally{x(null)}},me=async t=>{x(t);try{const i=l.fullBookContent||"",u=await Er(c.title,s,i,r);if(u){const{learning_level:m,...y}=u;w(t,y,{learningLevel:m||"×™×™×©×•×"})}}catch{alert("×©×’×™××”")}finally{x(null)}},Ce=async t=>{x(t);try{const i=l.fullBookContent||"",u=await Pr(c.title,s,i,r);if(u){const m=typeof u=="object"?u.text:u,y=typeof u=="object"?u.learning_level:"×™×™×©×•×";w(t,m,{learningLevel:y||"×™×™×©×•×"})}}catch{alert("×©×’×™××”")}finally{x(null)}},Fe=async t=>{x(t);try{const i=l.fullBookContent||"",u=await Ar(c.title,s,i,r);if(u){const{learning_level:m,...y}=u;w(t,y,{learningLevel:m||"×™×™×©×•×"})}}catch{alert("×©×’×™××”")}finally{x(null)}},Ts=async t=>{x(t);try{const i=l.fullBookContent||"",u=await Gr(c.title,s,i,r);if(u){const{learning_level:m,...y}=u;w(t,y,{learningLevel:m||"×™×™×©×•×"})}}catch{alert("×©×’×™××”")}finally{x(null)}},nt=async t=>{if(!yr.isConfigured()){alert("× ×“×¨×© ×ž×¤×ª×— API ×©×œ ElevenLabs ×‘×§×•×‘×¥ .env ×œ×¦×•×¨×š ×™×¦×™×¨×ª ×¤×•×“×§××¡×˜.");return}x(t),w(t,{title:"×ž×™×™×¦×¨ ×¤×•×“×§××¡×˜...",script:null,audioUrl:null,description:"â³ ×”×ž×¢×¨×›×ª ×ž×™×™×¦×¨×ª ×ª×¡×¨×™×˜ ×œ×¤×•×“×§××¡×˜... ×× × ×”×ž×ª×Ÿ (×¤×¢×•×œ×” ×–×• ×¢×©×•×™×” ×œ×§×—×ª ×›×“×§×”)"});try{const i=c.activityBlocks.find(y=>y.id===t),u=Pe[t]||"full";let m="";if(u==="custom"){if(m=Ut[t]||"",!m||m.length<50){alert("×× × ×”×–×™× ×• ×˜×§×¡×˜ ×‘××•×¨×š ×©×œ ×œ×¤×—×•×ª 50 ×ª×•×•×™×.");return}}else if(m=l.fullBookContent||"",(!m||m.length<50)&&(m=c.activityBlocks.filter(y=>y.type==="text"&&typeof y.content=="string").map(y=>y.content).join(`

`)),!m||m.length<50){alert(`××™×Ÿ ×ž×¡×¤×™×§ ×ª×•×›×Ÿ ×œ×™×¦×™×¨×ª ×¤×•×“×§××¡×˜.

×”×ž×¢×¨×›×ª ×ž×—×¤×©×ª ×ª×•×›×Ÿ ×ž×§×•×¨ ×©×œ ×”×§×•×¨×¡, ××• ×‘×œ×•×§×™× ×©×œ ×˜×§×¡×˜ ×‘×™×—×™×“×” ×”× ×•×›×—×™×ª.
×× × ×”×•×¡×£ ×ª×•×›×Ÿ ×˜×§×¡×˜ ×œ×™×—×™×“×” ××• ×”×©×ª×ž×© ×‘××¤×©×¨×•×ª '×˜×§×¡×˜ ×ž×•×ª××'.`);return}x(t),console.log("ðŸŽ™ï¸ Starting Podcast Generation for Grade:",s);try{const y=await Ua.generateScript({sourceText:m.substring(0,15e3),targetAudience:s||"Student",language:"he",focusTopic:c.title});if(y){const z={...c.activityBlocks.find(Ze=>Ze.id===t),content:{title:"×¤×•×“×§××¡×˜ ×œ×¡×™×›×•× ×”×™×—×™×“×”",description:"×”××–×™× ×• ×œ×©×™×—×” ×”×ž×¨×ª×§×ª ×‘×™×Ÿ ×”×ž× ×—×™× ×•×¢× ×• ×¢×œ ×”×©××œ×•×ª ×©××—×¨×™.",script:y,audioUrl:null},metadata:{autoGenerate:!1}},xe=y.lines.map(Ze=>`${Ze.speaker}: ${Ze.text}`).join(`
`),H=await $s(c.title,s,[],xe),Me=await Bs(c.title,s,[],xe);v(Ze=>{const ge=[...Ze.activityBlocks],Ie=ge.findIndex(ut=>ut.id===t);return Ie!==-1&&(ge[Ie]=z,H&&(H.id=ze(),ge.splice(Ie+1,0,H)),Me&&(Me.id=ze(),ge.splice(Ie+2,0,Me))),{...Ze,activityBlocks:ge}})}else alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¤×•×“×§××¡×˜. × ×¡×” ×©×•×‘.")}catch(y){console.error(y),alert("×©×’×™××”")}finally{x(null)}}catch(i){console.error("Outer error in podcast generation:",i),alert("×©×’×™××” ×›×œ×œ×™×ª ×‘×™×¦×™×¨×ª ×”×¤×•×“×§××¡×˜"),x(null)}},_t=async(t,i="content")=>{const u=I[t];if(u){x(t);try{const m=await Ur(u);if(!m)throw new Error("Failed to generate image");const y=`ai_gen_${ze()}.png`,z=new File([m],y,{type:"image/png"}),xe=await Ds(z,"images");if(i==="content")w(t,xe,{mediaType:"image",aiPrompt:u});else{const H=c.activityBlocks.find(Me=>Me.id===t);H&&w(t,H.content,{media:xe,mediaType:"image",aiPrompt:u})}f(H=>({...H,[t]:null}))}catch(m){console.error("AI Generation Error:",m),alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª×ž×•× ×”. × ×¡×” ×©×•×‘.")}finally{x(null)}}},pe=(t,i)=>{const u=c.activityBlocks.find(y=>y.id===t);if(!u)return;const m=i==="multiple-choice"?{type:i,question:"",options:["","","",""],correctAnswer:""}:{type:i,question:""};w(t,u.content,{relatedQuestion:m})},rt=(t,i)=>{var m;const u=c.activityBlocks.find(y=>y.id===t);u&&w(t,u.content,{relatedQuestion:{...((m=u.metadata)==null?void 0:m.relatedQuestion)||{},...i}})},Re=t=>{const i=c.activityBlocks.find(u=>u.id===t);i&&w(t,i.content,{relatedQuestion:null})},it=(t,i)=>{var u;return i?e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100 bg-gray-50/50 rounded-xl p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("span",{className:"text-xs font-bold text-gray-500 uppercase flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," ×©××œ×” ×ž×©×•×™×›×ª"]}),e.jsx("button",{onClick:()=>Re(t),className:"text-red-400 hover:text-red-600 p-1",children:e.jsx(ct,{className:"w-3 h-3"})})]}),e.jsx("input",{type:"text",className:"w-full font-bold p-2 bg-white border border-gray-200 rounded-lg mb-2 focus:border-blue-400 outline-none",value:i.question,onChange:m=>rt(t,{question:m.target.value}),placeholder:"×›×ª×‘×• ××ª ×”×©××œ×” ×›××Ÿ..."}),i.type==="multiple-choice"&&e.jsx("div",{className:"space-y-2",children:(u=i.options)==null?void 0:u.map((m,y)=>{const z=Ln(m);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>rt(t,{correctAnswer:z}),className:`w-5 h-5 rounded-full border flex items-center justify-center ${i.correctAnswer===z?"bg-green-500 border-green-500 text-white":"bg-white border-gray-300"}`,children:i.correctAnswer===z&&e.jsx(At,{className:"w-3 h-3"})}),e.jsx("input",{type:"text",className:"flex-1 p-1.5 text-sm border border-gray-200 rounded bg-white",value:z,onChange:xe=>{const H=[...i.options];typeof H[y]=="object"?H[y]={...H[y],text:xe.target.value}:H[y]=xe.target.value,rt(t,{options:H})},placeholder:`××¤×©×¨×•×ª ${y+1}`})]},y)})})]}):null},Tt=t=>{const i=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,u=t.match(i);return u&&u[2].length===11?`https://www.youtube.com/embed/${u[2]}`:t},vt=t=>{const i=G[t];return i?i==="image_select"?e.jsxs("div",{className:"flex gap-2 bg-blue-50 p-1 rounded-lg animate-scale-in",children:[e.jsxs("label",{className:O,children:[e.jsx(gs,{className:"w-4 h-4"})," ×”×¢×œ××”",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:u=>{yt(u,t,"metadata"),f({...G,[t]:null})}})]}),e.jsxs("button",{onClick:()=>{const u=c.activityBlocks.find(y=>y.id===t);let m="";if(u){const y=u.content;if(typeof y=="string")m=En(y).substring(0,100);else if(y){const z=y.question||y.text||y.title||y.prompt||y.teach_content||"";m=En(z),m.length>100&&(m=m.substring(0,100))}}m&&F({...I,[t]:`×ª×ž×•× ×” ×œ×”×ž×—×©×” ×¢×‘×•×¨: ${m}`}),f({...G,[t]:"image_ai"})},className:O,children:[e.jsx(bn,{className:"w-4 h-4"})," ×¦×•×¨ ×‘-AI"]}),e.jsx("button",{onClick:()=>f({...G,[t]:null}),className:"p-1.5 text-gray-400 hover:text-red-500",children:e.jsx(Ct,{className:"w-4 h-4"})})]}):i==="video_select"?e.jsxs("div",{className:"flex gap-2 bg-blue-50 p-1 rounded-lg animate-scale-in",children:[e.jsxs("button",{onClick:()=>{qt(t),kt(!0)},className:`${O} bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 border-red-200`,children:[e.jsx(As,{className:"w-4 h-4"})," ×—×¤×© YouTube"]}),e.jsxs("label",{className:O,children:[e.jsx(gs,{className:"w-4 h-4"})," ×”×¢×œ××”",e.jsx("input",{type:"file",accept:"video/*",className:"hidden",onChange:u=>{yt(u,t,"metadata"),f({...G,[t]:null})}})]}),e.jsxs("button",{onClick:()=>f({...G,[t]:"video_link"}),className:O,children:[e.jsx(Lt,{className:"w-4 h-4"})," ×§×™×©×•×¨ ×™×“× ×™"]}),e.jsx("button",{onClick:()=>f({...G,[t]:null}),className:"p-1.5 text-gray-400 hover:text-red-500",children:e.jsx(Ct,{className:"w-4 h-4"})})]}):i==="image_ai"?null:i==="video_link"?e.jsxs("div",{className:"flex flex-col gap-2 w-full bg-blue-50 p-3 rounded-lg border border-blue-100 animate-scale-in mt-2",children:[e.jsx("span",{className:"text-xs font-bold text-blue-600",children:"×§×™×©×•×¨ ×œ-YouTube:"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",dir:"ltr",className:"flex-1 p-2 border rounded text-sm text-left",placeholder:"https://youtube.com/...",onChange:u=>F({...I,[t]:u.target.value})}),e.jsxs("button",{onClick:async()=>{var xe;const u=I[t];if(!u)return;x(t);let m="";console.log("Checking URL for transcription:",u);const y=Yt.validateYouTubeUrl(u);if(console.log("Validation Result (Video ID):",y),y)try{console.log("Calling processYoutubeUrl...");const H=await Yt.processYoutubeUrl(u);console.log("Transcript Result Length:",(xe=H==null?void 0:H.text)==null?void 0:xe.length),H!=null&&H.text?m=H.text:alert("×”×©×¨×ª ×”×—×–×™×¨ ×ª×ž×œ×•×œ ×¨×™×§. ×™×™×ª×›×Ÿ ×•××™×Ÿ ×›×ª×•×‘×™×•×ª ×‘×¡×¨×˜×•×Ÿ ×–×”.")}catch(H){console.error("Transcription Error Full:",H),alert("×©×’×™××” ×‘×ž×©×™×›×ª ×”×ª×ž×œ×•×œ: "+H.message)}else console.warn("URL failed validation for transcription but might still be embeddable.");const z=c.activityBlocks.find(H=>H.id===t);z&&w(t,z.content,{media:Tt(u),mediaType:"video",transcript:m}),x(null),f({...G,[t]:null})},className:"bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap flex items-center gap-2",children:[g===t?e.jsx(Os,{className:"w-3 h-3 animate-spin"}):null,"×”×˜×ž×¢"]}),e.jsx("button",{onClick:()=>f({...G,[t]:null}),className:"text-gray-400 hover:text-red-500",children:e.jsx(Ct,{className:"w-5 h-5"})})]})]}):null:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>f({...G,[t]:"image_select"}),className:O,title:"×”×•×¡×™×¤×• ×ª×ž×•× ×”",children:[e.jsx(Ls,{className:"w-4 h-4"})," ×ª×ž×•× ×”"]}),e.jsxs("button",{onClick:()=>f({...G,[t]:"video_select"}),className:O,title:"×”×•×¡×™×¤×• ×•×™×“××•",children:[e.jsx(As,{className:"w-4 h-4"})," ×•×™×“××•"]})]})},bt=t=>G[t]==="image_ai"?e.jsxs("div",{className:"w-full bg-blue-50 p-3 rounded-lg border border-blue-100 animate-scale-in mt-2",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-xs font-bold text-blue-600",children:"×ª×™××•×¨ ×”×ª×ž×•× ×” ×œ×™×¦×™×¨×”:"}),e.jsx("button",{onClick:()=>f({...G,[t]:null}),className:"text-gray-400 hover:text-red-500",children:e.jsx(Ct,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsx("textarea",{rows:2,className:"flex-1 p-2 border rounded text-sm resize-none",placeholder:"×œ×ž×©×œ: ×ª× ×‘×™×•×œ×•×’×™ ×ž×ª×—×ª ×œ×ž×™×§×¨×•×¡×§×•×¤...",value:I[t]||"",onChange:u=>F({...I,[t]:u.target.value})}),e.jsx("button",{onClick:()=>_t(t,"metadata"),disabled:g===t,className:"bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold whitespace-nowrap flex items-center gap-2",children:g===t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"})," ×™×•×¦×¨..."]}):"×¦×•×¨"})]})]}):null,Qe=({index:t})=>e.jsxs("div",{className:"relative py-4 flex justify-center z-20",children:[e.jsx("div",{className:"absolute inset-x-0 top-1/2 h-0.5 bg-blue-100/50 -z-10"}),e.jsx("div",{children:_===t?e.jsxs("div",{className:"glass border border-white/60 shadow-xl rounded-2xl p-4 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 animate-scale-in backdrop-blur-xl bg-white/95 ring-4 ring-blue-50/50 max-w-3xl",children:[e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("text",t)},className:"insert-btn",children:[e.jsx(jn,{className:"w-4 h-4"}),e.jsx("span",{children:$e.text})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("image",t)},className:"insert-btn",children:[e.jsx(Ls,{className:"w-4 h-4"}),e.jsx("span",{children:$e.image})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("video",t)},className:"insert-btn",children:[e.jsx(As,{className:"w-4 h-4"}),e.jsx("span",{children:$e.video})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("multiple-choice",t)},className:"insert-btn",children:[e.jsx(Ms,{className:"w-4 h-4"}),e.jsx("span",{children:$e["multiple-choice"]})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("open-question",t)},className:"insert-btn",children:[e.jsx(Rt,{className:"w-4 h-4"}),e.jsx("span",{children:$e["open-question"]})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("interactive-chat",t)},className:"insert-btn",children:[e.jsx(kn,{className:"w-4 h-4"}),e.jsx("span",{children:$e["interactive-chat"]})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("fill_in_blanks",t)},className:"insert-btn",children:[e.jsx(Rt,{className:"w-4 h-4"}),e.jsx("span",{children:$e.fill_in_blanks})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("ordering",t)},className:"insert-btn",children:[e.jsx(Ms,{className:"w-4 h-4"}),e.jsx("span",{children:$e.ordering})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("categorization",t)},className:"insert-btn",children:[e.jsx(Nn,{className:"w-4 h-4"}),e.jsx("span",{children:$e.categorization})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("memory_game",t)},className:"insert-btn",children:[e.jsx(Es,{className:"w-4 h-4"}),e.jsx("span",{children:$e.memory_game})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("true_false_speed",t)},className:"insert-btn",children:[e.jsx(Xe,{className:"w-4 h-4"}),e.jsx("span",{children:$e.true_false_speed})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("matching",t)},className:"insert-btn",children:[e.jsx(Lt,{className:"w-4 h-4"}),e.jsx("span",{children:$e.matching})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("highlight",t)},className:"insert-btn",children:[e.jsx(Rt,{className:"w-4 h-4"}),e.jsx("span",{children:$e.highlight})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("sentence_builder",t)},className:"insert-btn",children:[e.jsx(jn,{className:"w-4 h-4"}),e.jsx("span",{children:$e.sentence_builder})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("image_labeling",t)},className:"insert-btn",children:[e.jsx(Ls,{className:"w-4 h-4"}),e.jsx("span",{children:$e.image_labeling})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("table_completion",t)},className:"insert-btn",children:[e.jsx(Ms,{className:"w-4 h-4"}),e.jsx("span",{children:$e.table_completion})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("text_selection",t)},className:"insert-btn",children:[e.jsx(At,{className:"w-4 h-4"}),e.jsx("span",{children:$e.text_selection})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("rating_scale",t)},className:"insert-btn",children:[e.jsx(Ps,{className:"w-4 h-4"}),e.jsx("span",{children:$e.rating_scale})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("matrix",t)},className:"insert-btn",children:[e.jsx(Nn,{className:"w-4 h-4"}),e.jsx("span",{children:$e.matrix})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("audio-response",t)},className:"insert-btn",children:[e.jsx(Tr,{className:"w-4 h-4"}),e.jsx("span",{children:$e["audio-response"]})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("podcast",t)},className:"insert-btn",children:[e.jsx(wn,{className:"w-4 h-4"}),e.jsx("span",{children:"×¤×•×“×§××¡×˜ AI"})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("infographic",t)},className:"insert-btn",children:[e.jsx(Ir,{className:"w-4 h-4"}),e.jsx("span",{children:"××™× ×¤×•×’×¨×¤×™×§×”"})]}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),b("mindmap",t)},className:"insert-btn bg-gradient-to-r from-purple-50 to-indigo-50 border-purple-200 hover:border-purple-300",children:[e.jsx(Es,{className:"w-4 h-4 text-purple-600"}),e.jsx("span",{className:"text-purple-700",children:$e.mindmap})]}),e.jsx("button",{onClick:i=>{i.stopPropagation(),E(null)},className:"text-gray-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-full transition-colors ml-2",children:e.jsx(Ct,{className:"w-5 h-5"})})]}):e.jsxs("button",{onClick:()=>E(t),className:"bg-white text-blue-600 border border-blue-200 rounded-full px-4 py-1.5 flex items-center gap-2 shadow-sm hover:shadow-md hover:scale-105 transition-all hover:bg-blue-50 hover:border-blue-300",children:[e.jsx(_s,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-bold",children:"×”×•×¡×™×¤×• ×¨×›×™×‘"})]})})]}),ot=(t,i)=>i!=null&&i.media?e.jsxs("div",{className:"mb-4 relative rounded-xl overflow-hidden border border-gray-200",children:[i.mediaType==="video"?e.jsx("video",{src:i.media,controls:!0,className:"w-full max-h-[300px] bg-black"}):e.jsx("img",{src:i.media,alt:"×ž×“×™×”",className:"w-full max-h-[300px] object-contain bg-gray-50",loading:"lazy",decoding:"async"}),e.jsx("button",{onClick:()=>{const u=c.activityBlocks.find(m=>m.id===t);u&&w(t,u.content,{media:null,mediaType:null})},className:"absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 hover:bg-red-50 hover:text-red-600 transition-colors shadow-md border border-red-200",title:"×”×¡×¨ ×ž×“×™×”",children:e.jsx(ct,{className:"w-4 h-4"})})]}):null,qe=((Qs=(Ys=l==null?void 0:l.wizardData)==null?void 0:Ys.settings)==null?void 0:Qs.productType)||"lesson",Ve={lesson:"×ž×¢×¨×š ×”×©×™×¢×•×¨",activity:"×”×¤×¢×™×œ×•×ª ×œ×ª×œ×ž×™×“",exam:"×”×ž×‘×—×Ÿ",podcast:"×”×¤×•×“×§××¡×˜"}[qe]||"×”×¤×¢×™×œ×•×ª",is={lesson:"×ž×¦×‘ ×œ×ž×™×“×”",activity:"×ž×¦×‘ ×ª×¨×’×•×œ",exam:"×ž×¦×‘ ×ž×‘×—×Ÿ",podcast:"×ž×¦×‘ ×”××–× ×”"}[qe]||"×ž×¦×‘ ×¤×¢×™×œ×•×ª",Dt={lesson:"lesson",activity:"activity",exam:"exam",podcast:"general"}[qe]||"activity",os=((Xs=l==null?void 0:l.wizardData)==null?void 0:Xs.mode)||"topic",tr={upload:"×ž×”×§×•×‘×¥ ×©×”×¢×œ×ª×",text:"×ž×”×˜×§×¡×˜ ×©×”×“×‘×§×ª×",multimodal:"×ž×”×¡×¨×˜×•×Ÿ ×©×ª×ž×œ×œ×ª×",topic:"×¢×œ ×”× ×•×©× ×©×‘×—×¨×ª×"}[os]||"";return M?e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-gray-50",children:[e.jsx("div",{className:"relative mb-6",children:e.jsx(Gn,{size:"xl",color:"gradient"})}),e.jsxs("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:[Ve," ",tr," ×‘×‘× ×™×”..."]}),e.jsx("div",{className:"min-h-[2rem]",children:e.jsx(Us,{contentType:Dt,isVisible:!0,showSpinner:!1,className:"text-indigo-600"})})]}):e.jsxs("div",{className:"min-h-screen p-8 font-sans pb-24 bg-gray-50/50",children:[e.jsxs("div",{className:"sticky top-4 z-50 card-glass p-4 flex justify-between items-center mb-10 gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("input",{type:"text",value:c.title,onChange:t=>{v({...c,title:t.target.value}),se(!0)},className:"text-2xl font-bold text-gray-800 bg-transparent border-b border-transparent focus:border-blue-500 outline-none px-2 transition-colors placeholder-gray-400 w-full",placeholder:`×›×•×ª×¨×ª ${Ve}`}),e.jsxs("div",{className:"text-sm text-gray-500 px-2 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:["×©×›×‘×ª ×’×™×œ: ",s]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-1 h-1 bg-gray-400 rounded-full"}),e.jsxs("span",{children:["×ª×—×•× ×“×¢×ª: ",r]})]}),e.jsx("span",{className:"w-1 h-1 bg-gray-400 rounded-full"}),e.jsx("span",{className:`font-bold ${le?"text-blue-800":"text-green-700"}`,children:le?"×ž×¦×‘ ×ž×‘×—×Ÿ":is})]})]}),e.jsxs("div",{className:"flex gap-3 flex-shrink-0 items-center",children:[p&&e.jsxs("button",{onClick:()=>p(c),className:"px-5 py-2 rounded-xl text-blue-600 bg-blue-50 hover:bg-blue-100 font-bold transition-colors flex items-center gap-2 border border-blue-200",children:[e.jsx(Ss,{className:"w-4 h-4"})," ×ª×¦×•×’×ª ×ª×œ×ž×™×“"]}),e.jsx("button",{onClick:dt,disabled:C,className:`px-6 py-2 rounded-xl shadow-lg font-bold transition-all hover:-translate-y-0.5 flex items-center gap-2 min-w-[140px] justify-center
                        ${V?"bg-green-600 text-white shadow-green-200":"bg-blue-600 text-white hover:bg-blue-700 shadow-blue-200"}`,children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"})," ×©×•×ž×¨..."]}):V?e.jsxs(e.Fragment,{children:[e.jsx(At,{className:"w-4 h-4"})," × ×©×ž×¨!"]}):e.jsxs(e.Fragment,{children:[e.jsx(vr,{className:"w-4 h-4"})," ×©×ž×¨×• ×©×™× ×•×™×™×"]})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>k(!X),className:"p-2 rounded-xl text-gray-600 hover:bg-white/80 border border-gray-200 transition-colors",children:e.jsx(br,{className:"w-5 h-5"})}),X&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>k(!1)}),e.jsxs("div",{className:"absolute left-0 top-full mt-2 bg-white rounded-xl shadow-xl border border-gray-200 py-2 min-w-[200px] z-50",children:[(l.fullBookContent||l.pdfSource)&&e.jsxs("button",{onClick:()=>{J(!U),k(!1)},className:"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700",children:[e.jsx(Ns,{className:"w-4 h-4 text-indigo-500"}),U?"×¡×’×•×¨ ×ž×§×•×¨":"×”×¦×’ ×ž×§×•×¨"]}),le&&e.jsxs("button",{onClick:()=>{be(),k(!1)},className:"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700",children:[e.jsx(Ps,{className:"w-4 h-4 text-yellow-600"}),"×—×œ×§ × ×™×§×•×“"]}),e.jsxs("button",{onClick:()=>{ie(),k(!1)},className:"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700",children:[e.jsx(Lt,{className:`w-4 h-4 ${Y?"text-amber-500":"text-indigo-500"}`}),Y?"×©×ž×•×¨ ×œ×¤× ×™ ×©×™×ª×•×£!":"×”×¢×ª×§×ª ×§×™×©×•×¨ ×œ×ª×œ×ž×™×“"]}),e.jsx("div",{className:"border-t border-gray-100 my-1"}),e.jsxs("button",{onClick:()=>{ee(),k(!1)},className:"w-full px-4 py-2.5 text-right hover:bg-gray-50 flex items-center gap-3 text-sm font-medium text-gray-700",children:[e.jsx(wr,{className:"w-4 h-4 rotate-180 text-gray-500"}),"×—×–×¨×”"]})]})]})]})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden relative",children:[e.jsx("div",{className:`flex-1 overflow-y-auto custom-scrollbar p-8 pb-32 transition-all ${U?"w-1/2":"w-full max-w-4xl mx-auto"}`,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(Qe,{index:0}),(Ks=c.activityBlocks)==null?void 0:Ks.map((t,i)=>{var u,m,y,z,xe,H,Me,Ze,ge,Ie,ut,ls,cs,Ft,ds,us,ms,Et,re,ce,De,et,Ue,at,mt,Ot,te,we,tt,gt,pt,lt,wt,jt,Vt,Zs,en,tn,sn,nn,rn,an,on,ln,cn,dn,un,mn,gn,pn,xn,hn,fn,yn;return e.jsxs(zs.Fragment,{children:[e.jsxs("div",{className:"card-glass relative group transition-all p-4 pb-14",children:[!["image","video","podcast","audio-response","loading-placeholder","activity-intro","scenario-image","infographic"].includes(t.type)&&e.jsx("div",{className:"absolute top-2 left-2 z-10 opacity-70 group-hover:opacity-100 transition-opacity",children:vt(t.id)}),e.jsx("div",{className:"absolute bottom-3 left-2 z-10",children:e.jsx(Da,{blockId:t.id,blockType:t.type,content:t.content,onUpdate:o=>w(t.id,o),unitId:n.id})}),e.jsxs("div",{className:"absolute bottom-3 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 backdrop-blur-sm rounded-lg p-1 shadow-sm border border-gray-100",children:[e.jsx("button",{onClick:()=>ke(i,"up"),disabled:i===0,className:"p-1.5 hover:text-blue-600 disabled:opacity-30 rounded hover:bg-blue-50 transition-colors",children:e.jsx(Gs,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ke(i,"down"),disabled:i===c.activityBlocks.length-1,className:"p-1.5 hover:text-blue-600 disabled:opacity-30 rounded hover:bg-blue-50 transition-colors",children:e.jsx(vs,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>he(t.id),className:"p-1.5 hover:text-red-500 rounded hover:bg-red-50 transition-colors",children:e.jsx(ct,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("span",{className:"text-[10px] font-bold bg-gray-100/80 text-gray-500 px-2 py-0.5 rounded-full uppercase tracking-wide",children:$e[t.type]||t.type}),!["text","image","video","pdf","gem-link","podcast","activity-intro","scenario-image","infographic","loading-placeholder"].includes(t.type)&&e.jsx("span",{className:"text-[10px] font-medium px-2 py-0.5 rounded-full bg-gray-50 text-gray-500 border border-gray-200",children:((u=t.metadata)==null?void 0:u.learningLevel)||"×™×™×©×•×"})]}),e.jsxs("div",{children:[t.type==="text"&&e.jsxs("div",{children:[(((m=t.metadata)==null?void 0:m.has_variants)||((y=t.metadata)==null?void 0:y.scaffolding_variant)||((z=t.metadata)==null?void 0:z.enrichment_variant))&&e.jsx("div",{className:"mb-3",children:e.jsx(Bt,{blockId:t.id,hasVariants:!0,currentLevel:ne[t.id]||"×™×™×©×•×",onChange:o=>fe(P=>({...P,[t.id]:o}))})}),e.jsxs("div",{className:"flex flex-col lg:flex-row-reverse gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[(xe=t.metadata)!=null&&xe.isLoading||(H=t.metadata)!=null&&H.isSkeleton?e.jsx("div",{className:"w-full p-8 border border-indigo-100 bg-gradient-to-br from-indigo-50/50 to-blue-50/50 rounded-2xl flex flex-col items-center justify-center text-center gap-4 min-h-[180px]",children:e.jsx(Us,{contentType:Dt,isVisible:!0})}):e.jsx(xt,{value:Ke(t,ne[t.id]||"×™×™×©×•×")||"",onChange:o=>Ye(t.id,o,ne[t.id]||"×™×™×©×•×"),placeholder:`×›×ª×‘×• ×›××Ÿ ××ª ×ª×•×›×Ÿ ${Ve}...`,minHeight:"200px",maxHeight:"400px"}),ot(t.id,t.metadata)]}),e.jsx("div",{className:"lg:w-28 lg:flex-shrink-0",children:e.jsx("div",{className:"lg:sticky lg:top-4 bg-blue-50/60 p-2 rounded-xl border border-blue-100/50 backdrop-blur-sm",children:e.jsxs("div",{className:"flex lg:flex-col gap-1.5 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1 text-blue-600 px-2 py-1 font-bold text-xs",children:[e.jsx(Xe,{className:"w-4 h-4"}),e.jsx("span",{className:"lg:hidden",children:"AI:"})]}),ft.map(o=>e.jsx("button",{onClick:()=>Pt(t.id,t.content,o.prompt),disabled:g===t.id,className:"text-xs bg-white/80 text-blue-700 border border-blue-100 px-2.5 py-1.5 rounded-lg hover:bg-blue-50 transition-colors font-medium shadow-sm disabled:opacity-50 lg:w-full lg:text-center",children:g===t.id?"...":o.label},o.label))]})})})]}),bt(t.id)]}),t.type==="image"&&e.jsxs("div",{className:"p-2",children:[t.content?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t.content,className:"w-full max-h-[400px] object-contain rounded-xl shadow-md bg-gray-100",alt:"Block Media",loading:"lazy",decoding:"async"}),e.jsx("button",{onClick:()=>w(t.id,"",{caption:null,mediaType:null,aiPrompt:null,uploadedFileUrl:null,fileName:null}),className:"absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 hover:bg-red-50 hover:text-red-600 transition-colors shadow-md border border-red-200",title:"×”×¡×¨ ×ª×ž×•× ×”",children:e.jsx(ct,{className:"w-4 h-4"})}),e.jsx("div",{className:"mt-3",children:e.jsx("input",{type:"text",className:"w-full bg-transparent border-b border-gray-200 focus:border-blue-400 outline-none p-1 text-sm text-center text-gray-600 placeholder-gray-400",placeholder:"×”×•×¡×™×¤×• ×›×™×ª×•×‘ ×œ×ª×ž×•× ×”...",value:((Me=t.metadata)==null?void 0:Me.caption)||"",onChange:o=>w(t.id,t.content,{caption:o.target.value})})})]}):g===t.id?e.jsx(jr,{height:"h-48",prompt:I[t.id]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 h-48",children:[e.jsxs("label",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition-all group",children:[e.jsx(gs,{className:"w-8 h-8 text-gray-400 group-hover:text-blue-500 mb-2"}),e.jsx("span",{className:"font-bold text-gray-500 group-hover:text-blue-600",children:"×”×¢×œ××ª ×ª×ž×•× ×”"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:o=>yt(o,t.id)})]}),e.jsxs("button",{onClick:()=>f({...G,[t.id]:"ai"}),className:"flex flex-col items-center justify-center border-2 border-dashed border-blue-200 rounded-xl bg-blue-50/50 hover:bg-blue-50 hover:border-blue-300 transition-all group",children:[e.jsx(bn,{className:"w-8 h-8 text-blue-400 group-hover:text-blue-600 mb-2"}),e.jsx("span",{className:"font-bold text-blue-500 group-hover:text-blue-700",children:"×™×¦×™×¨×” ×‘-AI"})]}),G[t.id]==="ai"&&e.jsxs("div",{className:"col-span-2 bg-white p-4 rounded-xl border border-blue-100 shadow-lg absolute inset-0 z-10 flex flex-col justify-center",children:[e.jsx("h4",{className:"text-sm font-bold text-blue-700 mb-2",children:"×ª××¨ ××ª ×”×ª×ž×•× ×” ×©×‘×¨×¦×•× ×š ×œ×™×¦×•×¨:"}),e.jsx("textarea",{className:"w-full p-2 border rounded-lg mb-2 text-sm focus:border-blue-400 outline-none",rows:2,placeholder:"×™×œ×“ ×¨×¥ ×‘×©×“×” ×—×ž× ×™×•×ª...",onChange:o=>F({...I,[t.id]:o.target.value})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>f({...G,[t.id]:null}),className:"text-gray-500 text-xs hover:bg-gray-100 px-3 py-1 rounded",children:"×‘×™×˜×•×œ"}),e.jsx("button",{onClick:()=>_t(t.id,"content"),disabled:g===t.id,className:"bg-blue-600 text-white text-xs px-4 py-1.5 rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center gap-2",children:g===t.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"})," ×™×•×¦×¨..."]}):e.jsxs(e.Fragment,{children:[" ",e.jsx(Rs,{className:"w-3 h-3"})," ×¦×•×¨ ×ª×ž×•× ×”"]})})]})]})]}),t.content&&!((Ze=t.metadata)!=null&&Ze.relatedQuestion)&&e.jsx("div",{className:"flex justify-center mt-4",children:e.jsxs("div",{className:"flex gap-2 bg-white border border-gray-200 rounded-full p-1 shadow-sm",children:[e.jsx("button",{onClick:()=>pe(t.id,"open-question"),className:"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors",children:"×”×•×¡×£ ×©××œ×” ×¤×ª×•×—×”"}),e.jsx("div",{className:"w-px bg-gray-200"}),e.jsx("button",{onClick:()=>pe(t.id,"multiple-choice"),className:"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors",children:"×”×•×¡×£ ×©××œ×” ××ž×¨×™×§××™×ª"})]})}),it(t.id,(ge=t.metadata)==null?void 0:ge.relatedQuestion)]}),t.type==="video"&&e.jsxs("div",{className:"p-2",children:[t.content?e.jsxs("div",{className:"relative",children:[t.content.includes("youtube")||t.content.includes("vimeo")?e.jsx("iframe",{src:t.content,className:"w-full h-64 rounded-xl shadow-md bg-black",allowFullScreen:!0,title:"Video Player"}):e.jsx("video",{src:t.content,controls:!0,className:"w-full h-64 bg-black rounded-xl shadow-md"}),e.jsx("button",{onClick:()=>w(t.id,"",{caption:null,mediaType:null,transcript:null,videoId:null,videoTitle:null,channelTitle:null,duration:null,thumbnailUrl:null,hasCaptions:null,educationalScore:null,source:null}),className:"absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 hover:bg-red-50 hover:text-red-600 transition-colors shadow-md border border-red-200",title:"×”×¡×¨ ×•×™×“××•",children:e.jsx(ct,{className:"w-4 h-4"})}),e.jsx("div",{className:"mt-3",children:e.jsx("input",{type:"text",className:"w-full bg-transparent border-b border-gray-200 focus:border-blue-400 outline-none p-1 text-sm text-center text-gray-600 placeholder-gray-400",placeholder:"×”×•×¡×™×¤×• ×›×™×ª×•×‘ ×œ×•×™×“××•...",value:((Ie=t.metadata)==null?void 0:Ie.caption)||"",onChange:o=>w(t.id,t.content,{caption:o.target.value})})})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 h-48",children:[e.jsxs("label",{className:"flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition-all group",children:[T===t.id?e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"}):e.jsx(gs,{className:"w-8 h-8 text-gray-400 group-hover:text-blue-500 mb-2"}),e.jsx("span",{className:"font-bold text-gray-500 group-hover:text-blue-600",children:"×”×¢×œ××ª ×§×•×‘×¥ (×¢×“ 50MB)"}),e.jsx("input",{type:"file",accept:"video/*",className:"hidden",onChange:o=>yt(o,t.id)})]}),e.jsxs("button",{onClick:()=>f({...G,[t.id]:"link"}),className:"flex flex-col items-center justify-center border-2 border-dashed border-red-200 rounded-xl bg-red-50/50 hover:bg-red-50 hover:border-red-300 transition-all group",children:[e.jsx(Lt,{className:"w-8 h-8 text-red-400 group-hover:text-red-600 mb-2"}),e.jsx("span",{className:"font-bold text-red-500 group-hover:text-red-700",children:"×§×™×©×•×¨ ×—×™×¦×•× ×™ (YouTube)"})]}),G[t.id]==="link"&&e.jsxs("div",{className:"col-span-2 bg-white p-4 rounded-xl border border-red-100 shadow-lg absolute inset-0 z-10 flex flex-col justify-center",children:[e.jsx("h4",{className:"text-sm font-bold text-red-700 mb-2",children:"×”×“×‘×§ ×§×™×©×•×¨ (YouTube / Vimeo):"}),e.jsx("input",{type:"text",dir:"ltr",className:"w-full p-2 border rounded-lg mb-2 text-sm text-left",placeholder:"https://www.youtube.com/watch?v=...",onChange:o=>F({...I,[t.id]:o.target.value})}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>f({...G,[t.id]:null}),className:"text-gray-500 text-xs hover:bg-gray-100 px-3 py-1 rounded",children:"×‘×™×˜×•×œ"}),e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[e.jsx("button",{onClick:async()=>{const o=I[t.id];if(!o)return;x(t.id);let P="";const D=L=>{console.log(L);const Z=document.getElementById(`debug-${t.id}`);Z&&(Z.innerHTML+=`<div class="border-b border-gray-800 pb-1 mb-1">${new Date().toLocaleTimeString()} - ${L}</div>`)},A=document.getElementById(`debug-${t.id}`);if(A&&(A.innerHTML="<div>Starting process...</div>"),D(`URL: ${o}`),Yt.validateYouTubeUrl(o))try{D("Valid YouTube URL. Fetching transcript...");const L=await Yt.processYoutubeUrl(o);L!=null&&L.text?(D(`Transcript found! Length: ${L.text.length} chars`),P=L.text):(D("Transcript is empty/null from server."),alert("×”×©×¨×ª ×”×—×–×™×¨ ×ª×ž×œ×•×œ ×¨×™×§."))}catch(L){D(`Error fetching: ${L.message}`),console.warn("Failed to fetch transcript",L),alert("×©×’×™××” ×‘×ž×©×™×›×ª ×”×ª×ž×œ×•×œ: "+L.message)}else D("Invalid YouTube URL format.");w(t.id,Tt(o),{mediaType:"video",transcript:P}),D("Block updated. Finished."),x(null),f({...G,[t.id]:null}),F({...I,[t.id]:""})},className:"bg-red-600 text-white text-xs font-bold px-4 py-2 rounded shadow hover:bg-red-700 transition-colors",children:"××™×©×•×¨ ×•×”×˜×ž×¢×”"}),e.jsx("div",{id:`debug-${t.id}`,className:"text-[10px] font-mono bg-black text-green-400 p-2 rounded h-32 overflow-y-auto w-full text-left ltr border border-gray-700 shadow-inner",children:"Ready for logs..."})]})]})]})]}),((ut=t.metadata)==null?void 0:ut.transcript)&&e.jsxs("div",{className:"mt-2 text-xs text-green-600 bg-green-50 px-2 py-1 rounded-md inline-block font-bold",children:["âœ… ×ª×ž×œ×•×œ ×•×™×“××• ×–×•×”×” (",t.metadata.transcript.length," ×ª×•×•×™×)"]}),t.content&&!((ls=t.metadata)!=null&&ls.relatedQuestion)&&e.jsx("div",{className:"flex justify-center mt-4",children:e.jsxs("div",{className:"flex gap-2 bg-white border border-gray-200 rounded-full p-1 shadow-sm",children:[e.jsx("button",{onClick:()=>pe(t.id,"open-question"),className:"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors",children:"×”×•×¡×£ ×©××œ×” ×¤×ª×•×—×”"}),e.jsx("div",{className:"w-px bg-gray-200"}),e.jsx("button",{onClick:()=>pe(t.id,"multiple-choice"),className:"px-3 py-1 rounded-full text-xs font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors",children:"×”×•×¡×£ ×©××œ×” ××ž×¨×™×§××™×ª"})]})}),it(t.id,(cs=t.metadata)==null?void 0:cs.relatedQuestion)]}),t.type==="podcast"&&e.jsxs("div",{className:"bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-2xl border border-indigo-100 relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-purple-200/20 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl"}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"bg-white p-3 rounded-xl shadow-sm",children:e.jsx(wn,{className:"w-6 h-6 text-indigo-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-indigo-900",children:"×¤×•×“×§××¡×˜ AI"}),e.jsx("p",{className:"text-xs text-indigo-600 opacity-80",children:"×™×¦×™×¨×ª ×¡×™×›×•× ×©×ž×¢ ××•×˜×•×ž×˜×™"})]})]}),t.content.script?e.jsx("div",{className:"animate-fade-in w-full max-w-2xl mx-auto",children:e.jsx(Nr,{script:t.content.script,title:t.content.title})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsxs("div",{className:"inline-flex bg-white p-1 rounded-xl shadow-sm border border-indigo-100 mb-6",children:[e.jsxs("button",{onClick:()=>He(o=>({...o,[t.id]:"full"})),className:`px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${!Pe[t.id]||Pe[t.id]==="full"?"bg-indigo-600 text-white shadow-md":"text-gray-500 hover:bg-gray-50"}`,disabled:g===t.id,children:[e.jsx(Ns,{className:"w-4 h-4"})," ×›×œ ×”×™×—×™×“×”"]}),e.jsxs("button",{onClick:()=>He(o=>({...o,[t.id]:"custom"})),className:`px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${Pe[t.id]==="custom"?"bg-indigo-600 text-white shadow-md":"text-gray-500 hover:bg-gray-50"}`,disabled:g===t.id,children:[e.jsx(Rt,{className:"w-4 h-4"})," ×˜×§×¡×˜ ×ž×•×ª××"]})]}),Pe[t.id]==="custom"&&e.jsxs("div",{className:"mb-6 animate-scale-in",children:[e.jsx(xt,{value:Ut[t.id]||"",onChange:o=>ns(P=>({...P,[t.id]:o})),placeholder:"×”×“×‘×™×§×• ×›××Ÿ ××ª ×”×˜×§×¡×˜ ×¢×œ×™×• ×™×‘×•×¡×¡ ×”×¤×•×“×§××¡×˜...",minHeight:"120px",maxHeight:"300px",disabled:g===t.id,className:"border-indigo-200"}),e.jsx("p",{className:"text-right text-xs text-gray-400 mt-1",children:"×ž×™× ×™×ž×•× 50 ×ª×•×•×™×"})]}),g===t.id?e.jsxs("div",{className:"bg-indigo-50 border border-indigo-100 rounded-xl p-6 flex flex-col items-center animate-pulse",children:[e.jsx(Os,{className:"w-8 h-8 text-indigo-600 animate-spin mb-3"}),e.jsx("h4",{className:"text-indigo-800 font-bold mb-1",children:"×× ×—× ×• ×¢×œ ×–×”!"}),e.jsx("p",{className:"text-indigo-600 text-sm",children:t.content.description||"×”×ž×¢×¨×›×ª ×ž×™×™×¦×¨×ª ×ª×¡×¨×™×˜ ×œ×¤×•×“×§××¡×˜... ×× × ×”×ž×ª×Ÿ."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>nt(t.id),className:"bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-indigo-700 hover:scale-105 transition-all flex items-center gap-2 mx-auto",children:[e.jsx(Xe,{className:"w-5 h-5"}),"×¦×•×¨ ×¤×•×“×§××¡×˜ ×¢×›×©×™×•"]}),e.jsxs("p",{className:"text-xs text-indigo-400 mt-3 max-w-xs mx-auto",children:["×”×ž×¢×¨×›×ª ×ª× ×ª×— ××ª ",!Pe[t.id]||Pe[t.id]==="full"?"×›×œ ×ª×•×›×Ÿ ×”×™×—×™×“×”":"×”×˜×§×¡×˜ ×©×”×–× ×ª×"," ×•×ª×¤×™×§ ×ª×¡×¨×™×˜ ×©×™×—×” ×ž×¨×ª×§ ×‘×™×Ÿ ×©× ×™ ×ž× ×—×™×."]})]})]})]})]}),t.type==="mindmap"&&e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-2xl border border-purple-100 relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 w-64 h-64 bg-purple-200/20 rounded-full -translate-y-1/2 -translate-x-1/2 blur-3xl"}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-white p-3 rounded-xl shadow-sm",children:e.jsx(Es,{className:"w-6 h-6 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-purple-900",children:t.content.title||"×ž×¤×ª ×—×©×™×‘×”"}),e.jsx("p",{className:"text-xs text-purple-600 opacity-80",children:"×”×ž×—×©×” ×•×™×–×•××œ×™×ª ×©×œ ×ž×•×©×’×™×"})]})]}),e.jsxs("button",{onClick:()=>{ye(t.id),de(!0)},className:"px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700 transition-colors flex items-center gap-2 shadow-md",children:[e.jsx(Xe,{className:"w-4 h-4"}),t.content.nodes&&t.content.nodes.length>1?"×™×™×¦×¨ ×ž×—×“×©":"×¦×•×¨ ×ž×¤×”"]})]}),t.content.nodes&&t.content.nodes.length>1?e.jsx(di,{content:t.content,onChange:o=>w(t.id,o),onSave:()=>se(!0)}):e.jsxs("div",{className:"text-center py-12 bg-white/50 rounded-xl border border-purple-100",children:[e.jsx("div",{className:"text-7xl mb-4",children:"ðŸ—ºï¸"}),e.jsx("h4",{className:"text-purple-800 font-bold text-lg mb-2",children:"×˜×¨× × ×•×¦×¨×” ×ž×¤×ª ×—×©×™×‘×”"}),e.jsx("p",{className:"text-purple-600 text-sm mb-6 max-w-md mx-auto",children:'×œ×—×¦×• ×¢×œ "×¦×•×¨ ×ž×¤×”" ×›×“×™ ×œ×™×¦×•×¨ ×ž×¤×ª ×—×©×™×‘×” ××•×˜×•×ž×˜×™×ª ×ž×ª×•×›×Ÿ ×”×™×—×™×“×”'}),e.jsxs("button",{onClick:()=>{ye(t.id),de(!0)},className:"px-8 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full font-bold shadow-lg hover:from-purple-700 hover:to-indigo-700 hover:scale-105 transition-all flex items-center gap-2 mx-auto",children:[e.jsx(Xe,{className:"w-5 h-5"}),"×¦×•×¨ ×ž×¤×ª ×—×©×™×‘×”"]})]})]})]}),t.type==="audio-response"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×©××œ×” / ×”× ×—×™×”"}),e.jsx(xt,{value:t.content&&t.content.question||"",onChange:o=>w(t.id,{...t.content,question:o}),placeholder:"×œ×ž×©×œ: ×”×¡×‘×™×¨×• ×‘×ž×™×œ×™× ×©×œ×›×...",minHeight:"40px",maxHeight:"150px",collapsible:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×ª×™××•×¨ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)"}),e.jsx(xt,{value:t.content&&t.content.description||"",onChange:o=>w(t.id,{...t.content,description:o}),placeholder:"×”× ×—×™×•×ª × ×•×¡×¤×•×ª...",minHeight:"40px",maxHeight:"100px",collapsible:!0})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×ž×©×š ×–×ž×Ÿ ×ž×§×¡' (×©× ×™×•×ª)"}),e.jsx("input",{type:"number",min:"10",max:"300",className:"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm",value:t.content&&t.content.maxDuration||60,onChange:o=>w(t.id,{...t.content,maxDuration:parseInt(o.target.value)})})]}),e.jsx("div",{className:"flex-1 text-xs text-gray-400 pt-4",children:"×”×ª×œ×ž×™×“ ×™×•×›×œ ×œ×”×§×œ×™×˜ ×ª×©×•×‘×” ×•×œ×©×œ×•×—."})]})]}),t.type==="interactive-chat"&&e.jsxs("div",{className:"space-y-3",children:[le&&e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(xi,{className:"w-4 h-4"}),e.jsx("span",{children:"×ž×¦×‘ ×ž×‘×—×Ÿ - ×”×‘×•×˜ ×—×¡×•×"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×›×•×ª×¨×ª ×”×‘×•×˜"}),e.jsx("input",{type:"text",className:"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm",value:t.content.title||"",onChange:o=>w(t.id,{...t.content,title:o.target.value}),placeholder:"×œ×ž×©×œ: ×”×ž× ×—×” ×”×ž×œ×•×•×” ×©×œ×š"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:le?"opacity-50 pointer-events-none":"",children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×ª×¤×§×™×“ ×”×‘×•×˜"}),e.jsxs("select",{className:"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm",value:((Ft=t.metadata)==null?void 0:Ft.botPersona)||"socratic",onChange:o=>Se(t.id,o.target.value,t.content),disabled:le,children:[e.jsx("option",{value:"socratic",children:"×ž× ×—×” ×¡×•×§×¨×˜×™"}),e.jsx("option",{value:"teacher",children:"×ž×•×¨×” ×ž×œ×•×•×”"}),e.jsx("option",{value:"concise",children:"×ª×ž×¦×™×ª×™"}),e.jsx("option",{value:"coach",children:"×ž××ž×Ÿ ×ž××ª×’×¨"}),e.jsx("option",{value:"historical",children:"×“×ž×•×ª ×”×™×¡×˜×•×¨×™×ª"}),e.jsx("option",{value:"debate",children:"×™×¨×™×‘ ×œ×“×™×‘×™×™×˜"})]})]}),((ds=t.metadata)==null?void 0:ds.botPersona)==="historical"&&!le&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×©× ×”×“×ž×•×ª"}),e.jsx("input",{type:"text",className:"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm",placeholder:"×œ×ž×©×œ: ×”×¨×¦×œ...",onChange:o=>w(t.id,t.content,{systemPrompt:`××ª×” ${o.target.value}. ×“×‘×¨ ×‘×’×•×£ ×¨××©×•×Ÿ.`})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×”×•×“×¢×ª ×¤×ª×™×—×”"}),e.jsx("input",{type:"text",className:"w-full p-2 border border-gray-200 rounded-lg bg-white text-sm",value:((us=t.metadata)==null?void 0:us.initialMessage)||"",onChange:o=>w(t.id,t.content,{initialMessage:o.target.value})})]})]}),(t.type==="multiple-choice"||t.type==="open-question")&&e.jsxs("div",{children:[(((ms=t.metadata)==null?void 0:ms.has_variants)||((Et=t.metadata)==null?void 0:Et.scaffolding_variant)||((re=t.metadata)==null?void 0:re.enrichment_variant))&&e.jsx("div",{className:"mb-2",children:e.jsx(Bt,{blockId:t.id,hasVariants:!0,currentLevel:ne[t.id]||"×™×™×©×•×",onChange:o=>fe(P=>({...P,[t.id]:o}))})}),e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(xt,{value:ps(t.content&&t.content.question||""),onChange:o=>w(t.id,{...t.content,question:o}),placeholder:t.type==="multiple-choice"?"×›×ª×‘×• ×©××œ×” ××ž×¨×™×§××™×ª...":"×›×ª×‘×• ×©××œ×” ×¤×ª×•×—×”...",minHeight:"40px",maxHeight:"150px",collapsible:!0})}),le&&e.jsxs("div",{className:"flex items-center gap-1 mr-2",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"× ×™×§×•×“:"}),e.jsx("input",{type:"number",className:"w-12 text-center p-1 rounded border border-gray-200 text-sm",value:((ce=t.metadata)==null?void 0:ce.score)||0,onChange:o=>w(t.id,t.content,{score:Number(o.target.value)})})]})]}),ot(t.id,t.metadata),t.type==="multiple-choice"&&e.jsxs("div",{className:"space-y-1.5",children:[!(t.content&&t.content.question)&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:()=>ht(t.id),disabled:g===t.id,className:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," ×¦×¨×• ×©××œ×”"]})}),(((De=t.content)==null?void 0:De.options)||[]).map((o,P)=>{var A,L;const D=Ln(o);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>w(t.id,{...t.content,correctAnswer:D}),className:`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${((A=t.content)==null?void 0:A.correctAnswer)===D?"bg-green-500 border-green-500 text-white":"bg-white border-gray-300"}`,children:((L=t.content)==null?void 0:L.correctAnswer)===D&&e.jsx(At,{className:"w-3 h-3"})}),e.jsx("input",{type:"text",className:"flex-1 p-2 text-sm border border-gray-200 rounded-lg bg-white",value:D,onChange:Z=>{var Nt;const Oe=[...((Nt=t.content)==null?void 0:Nt.options)||[]];typeof Oe[P]=="object"?Oe[P]={...Oe[P],text:Z.target.value}:Oe[P]=Z.target.value,w(t.id,{...t.content,options:Oe})},placeholder:`××¤×©×¨×•×ª ${P+1}`})]},P)})]}),t.type==="open-question"&&e.jsxs("div",{children:[!(t.content&&t.content.question)&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:()=>Ae(t.id),disabled:g===t.id,className:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," ×¦×¨×• ×©××œ×”"]})}),e.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"×ª×©×•×‘×” ×ž×¦×•×¤×”:"}),e.jsx(xt,{value:ps(((et=t.metadata)==null?void 0:et.modelAnswer)||""),onChange:o=>w(t.id,t.content,{modelAnswer:o}),placeholder:"×›×ª×‘×• ×›××Ÿ ××ª ×”×ª×©×•×‘×” ×”×ž×¦×•×¤×”...",minHeight:"80px",maxHeight:"200px",collapsible:!0})]}),bt(t.id)]}),t.type==="fill_in_blanks"&&e.jsxs("div",{children:[!t.content&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:()=>Ce(t.id),disabled:g===t.id,className:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," ",g===t.id?"×™×•×¦×¨...":"×¦×•×¨ ×‘-AI"]})}),e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:'×”×§×™×¤×• ×ž×™×œ×™× ×œ×”×¡×ª×¨×” ×‘-[×¡×•×’×¨×™×™× ×ž×¨×•×‘×¢×™×]. ×œ×ž×©×œ: "×‘×™×¨×ª ×™×©×¨××œ ×”×™× [×™×¨×•×©×œ×™×]".'}),e.jsx(xt,{value:ps(typeof t.content=="object"?t.content.sentence||t.content.text||"":t.content||""),onChange:o=>w(t.id,o),placeholder:"×›×ª×‘×• ××ª ×”×˜×§×¡×˜ ×”×ž×œ× ×¢× [×ž×™×œ×™× ×œ×”×¡×ª×¨×”]...",minHeight:"120px",maxHeight:"300px",collapsible:!0})]}),t.type==="ordering"&&e.jsxs("div",{children:[!((Ue=t.content)!=null&&Ue.instruction||((mt=(at=t.content)==null?void 0:at.correct_order)==null?void 0:mt.length)>0)&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:()=>me(t.id),disabled:g===t.id,className:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," ",g===t.id?"×™×•×¦×¨...":"×¦×•×¨ ×‘-AI"]})}),e.jsx(xt,{value:t.content&&t.content.instruction||"",onChange:o=>w(t.id,{...t.content,instruction:o}),placeholder:"×©××œ×” / ×”× ×—×™×” (×œ×ž×©×œ: ×¡×“×¨ ××ª ×”××™×¨×•×¢×™×...)",minHeight:"40px",maxHeight:"150px",collapsible:!0}),e.jsxs("div",{className:"space-y-1.5",children:[(((Ot=t.content)==null?void 0:Ot.correct_order)||[]).map((o,P)=>e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"font-medium text-gray-400 w-5 text-sm",children:[P+1,"."]}),e.jsx("input",{type:"text",className:"flex-1 p-2 border border-gray-200 rounded-lg bg-white text-sm",value:o||"",onChange:D=>{var L;const A=[...((L=t.content)==null?void 0:L.correct_order)||[]];A[P]=D.target.value,w(t.id,{...t.content,correct_order:A})}}),e.jsx("button",{onClick:()=>{var A;const D=(((A=t.content)==null?void 0:A.correct_order)||[]).filter((L,Z)=>Z!==P);w(t.id,{...t.content,correct_order:D})},className:"text-gray-400 hover:text-red-500",children:e.jsx(ct,{className:"w-4 h-4"})})]},P)),e.jsx("button",{onClick:()=>{var o;return w(t.id,{...t.content,correct_order:[...((o=t.content)==null?void 0:o.correct_order)||[],"×¤×¨×™×˜ ×—×“×©"]})},className:"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg mt-1",children:"+ ×”×•×¡×£ ×¤×¨×™×˜"})]})]}),t.type==="categorization"&&e.jsxs("div",{children:[!((te=t.content)!=null&&te.question||((tt=(we=t.content)==null?void 0:we.categories)==null?void 0:tt.length)>0||((pt=(gt=t.content)==null?void 0:gt.items)==null?void 0:pt.length)>0)&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:()=>St(t.id),disabled:g===t.id,className:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," ",g===t.id?"×™×•×¦×¨...":"×¦×•×¨ ×‘-AI"]})}),e.jsx(xt,{value:t.content&&t.content.question||"",onChange:o=>w(t.id,{...t.content,question:o}),placeholder:"×”× ×—×™×”...",minHeight:"40px",maxHeight:"150px",collapsible:!0}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500 mb-2",children:"×§×˜×’×•×¨×™×•×ª"}),e.jsxs("div",{className:"space-y-1.5",children:[(Array.isArray((lt=t.content)==null?void 0:lt.categories)?t.content.categories:[]).map((o,P)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",className:"flex-1 p-2 border border-gray-200 rounded-lg bg-white text-sm",value:o||"",onChange:D=>{var L;const A=[...((L=t.content)==null?void 0:L.categories)||[]];A[P]=D.target.value,w(t.id,{...t.content,categories:A})},placeholder:`×§×˜×’×•×¨×™×” ${P+1}`}),e.jsx("button",{onClick:()=>{var A;const D=(((A=t.content)==null?void 0:A.categories)||[]).filter((L,Z)=>Z!==P);w(t.id,{...t.content,categories:D})},className:"text-gray-400 hover:text-red-500",children:e.jsx(ct,{className:"w-4 h-4"})})]},P)),e.jsx("button",{onClick:()=>{var o;return w(t.id,{...t.content,categories:[...((o=t.content)==null?void 0:o.categories)||[],"×§×˜×’×•×¨×™×” ×—×“×©×”"]})},className:"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg",children:"+ ×§×˜×’×•×¨×™×”"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500 mb-2",children:"×¤×¨×™×˜×™× ×œ×ž×™×•×Ÿ"}),e.jsxs("div",{className:"space-y-1.5",children:[(((wt=t.content)==null?void 0:wt.items)||[]).map((o,P)=>{var D;return e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"text",className:"flex-1 p-2 text-sm border border-gray-200 rounded-lg",value:(o==null?void 0:o.text)||"",onChange:A=>{var Z;const L=[...((Z=t.content)==null?void 0:Z.items)||[]];L[P].text=A.target.value,w(t.id,{...t.content,items:L})},placeholder:"×˜×§×¡×˜ ×”×¤×¨×™×˜"}),e.jsxs("select",{className:"text-xs p-1.5 bg-gray-50 rounded-lg border border-gray-200",value:(o==null?void 0:o.category)||"",onChange:A=>{var Z;const L=[...((Z=t.content)==null?void 0:Z.items)||[]];L[P].category=A.target.value,w(t.id,{...t.content,items:L})},children:[e.jsx("option",{value:"",disabled:!0,children:"×‘×—×¨"}),(((D=t.content)==null?void 0:D.categories)||[]).map(A=>e.jsx("option",{value:A,children:A},A))]}),e.jsx("button",{onClick:()=>{var L;const A=(((L=t.content)==null?void 0:L.items)||[]).filter((Z,Oe)=>Oe!==P);w(t.id,{...t.content,items:A})},className:"text-gray-400 hover:text-red-500",children:e.jsx(ct,{className:"w-3 h-3"})})]},P)}),e.jsx("button",{onClick:()=>{var o,P,D;return w(t.id,{...t.content,items:[...((o=t.content)==null?void 0:o.items)||[],{text:"×¤×¨×™×˜ ×—×“×©",category:((D=(P=t.content)==null?void 0:P.categories)==null?void 0:D[0])||""}]})},className:"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg",children:"+ ×¤×¨×™×˜"})]})]})]})]}),t.type==="memory_game"&&e.jsxs("div",{children:[!(((Vt=(jt=t.content)==null?void 0:jt.pairs)==null?void 0:Vt.length)>0)&&e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs("button",{onClick:()=>Fe(t.id),disabled:g===t.id,className:"bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-medium transition-all flex items-center gap-1",children:[e.jsx(Xe,{className:"w-3 h-3"})," ",g===t.id?"×™×•×¦×¨...":"×¦×•×¨ ×‘-AI"]})}),e.jsx(xt,{value:t.content&&t.content.instruction||"",onChange:o=>w(t.id,{...t.content,instruction:o}),placeholder:"×”× ×—×™×” (×œ×ž×©×œ: ×ž×¦××• ××ª ×”×–×•×’×•×ª ×”×ª×•××ž×™×...)",minHeight:"40px",maxHeight:"150px",collapsible:!0}),e.jsx("p",{className:"text-xs text-gray-500 mb-2 mt-3",children:"×¦×¨×• ×–×•×’×•×ª ×ª×•××ž×™×. ×”×ª×œ×ž×™×“ ×™×¦×˜×¨×š ×œ×ž×¦×•× ××ª ×”×”×ª××ž×•×ª."}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:[(((Zs=t.content)==null?void 0:Zs.pairs)||[]).map((o,P)=>e.jsxs("div",{className:"p-2 rounded-lg border border-gray-200 relative group/pair",children:[e.jsxs("div",{className:"mb-1.5",children:[e.jsx("label",{className:"text-[10px] text-gray-400 block mb-0.5",children:"×¦×“ ×'"}),e.jsx("input",{type:"text",className:"w-full p-2 border border-gray-200 rounded-lg text-sm",value:(o==null?void 0:o.card_a)||"",onChange:D=>{var L;const A=[...((L=t.content)==null?void 0:L.pairs)||[]];A[P].card_a=D.target.value,w(t.id,{...t.content,pairs:A})}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-gray-400 block mb-0.5",children:"×¦×“ ×‘'"}),e.jsx("input",{type:"text",className:"w-full p-2 border border-gray-200 rounded-lg text-sm",value:(o==null?void 0:o.card_b)||"",onChange:D=>{var L;const A=[...((L=t.content)==null?void 0:L.pairs)||[]];A[P].card_b=D.target.value,w(t.id,{...t.content,pairs:A})}})]}),e.jsx("button",{onClick:()=>{var A;const D=(((A=t.content)==null?void 0:A.pairs)||[]).filter((L,Z)=>Z!==P);w(t.id,{...t.content,pairs:D})},className:"absolute -top-1 -left-1 bg-white text-gray-400 hover:text-red-500 p-0.5 rounded-full shadow border border-gray-200 opacity-0 group-hover/pair:opacity-100 transition-opacity",children:e.jsx(Ct,{className:"w-3 h-3"})})]},P)),e.jsxs("button",{onClick:()=>{var o;return w(t.id,{...t.content,pairs:[...((o=t.content)==null?void 0:o.pairs)||[],{card_a:"",card_b:""}]})},className:"min-h-[100px] border border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:bg-gray-50 hover:border-gray-400 transition-all",children:[e.jsx(_s,{className:"w-5 h-5 mb-1"}),e.jsx("span",{className:"text-xs",children:"×”×•×¡×£ ×–×•×’"})]})]})]}),t.type==="true_false_speed"&&e.jsxs("div",{children:[e.jsx(xt,{value:t.content&&t.content.instruction||"",onChange:o=>w(t.id,{...t.content,instruction:o}),placeholder:"×”× ×—×™×” (×œ×ž×©×œ: ×§×‘×¢×• ×× ×”×ž×©×¤×˜×™× ×”×‘××™× × ×›×•× ×™× ××• ×œ×...)",minHeight:"40px",maxHeight:"150px",collapsible:!0}),e.jsx("p",{className:"text-xs text-gray-500 mb-2 mt-3",children:"×ž×©×—×§ ×ž×”×™×¨×•×ª: ×”×ª×œ×ž×™×“ ×¦×¨×™×š ×œ×”×—×œ×™×˜ ×‘×ž×”×™×¨×•×ª ×× ×”×ž×©×¤×˜ × ×›×•×Ÿ ××• ×œ×."}),e.jsxs("div",{className:"space-y-1.5",children:[(((en=t.content)==null?void 0:en.statements)||[]).map((o,P)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium text-gray-400 w-5 text-sm",children:[P+1,"."]}),e.jsx("input",{type:"text",className:"flex-1 p-2 text-sm border border-gray-200 rounded-lg",value:(o==null?void 0:o.text)||"",onChange:D=>{var L;const A=[...((L=t.content)==null?void 0:L.statements)||[]];A[P].text=D.target.value,w(t.id,{...t.content,statements:A})},placeholder:"×›×ª×‘×• ×¢×•×‘×“×”..."}),e.jsx("button",{onClick:()=>{var A;const D=[...((A=t.content)==null?void 0:A.statements)||[]];D[P].is_true=!D[P].is_true,w(t.id,{...t.content,statements:D})},className:`px-2 py-1 rounded text-xs font-medium transition-colors ${o!=null&&o.is_true?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:o!=null&&o.is_true?"××ž×ª":"×©×§×¨"}),e.jsx("button",{onClick:()=>{var A;const D=(((A=t.content)==null?void 0:A.statements)||[]).filter((L,Z)=>Z!==P);w(t.id,{...t.content,statements:D})},className:"text-gray-400 hover:text-red-500",children:e.jsx(ct,{className:"w-4 h-4"})})]},P)),e.jsx("button",{onClick:()=>{var o;return w(t.id,{...t.content,statements:[...((o=t.content)==null?void 0:o.statements)||[],{text:"",is_true:!0}]})},className:"text-xs font-medium text-gray-600 hover:bg-gray-100 px-3 py-1 rounded-lg",children:"+ ×”×•×¡×£ ×©××œ×”"})]})]}),t.type==="loading-placeholder"&&e.jsxs("div",{className:"p-8 bg-gradient-to-br from-indigo-50/50 to-blue-50/50 rounded-2xl border border-indigo-100 flex flex-col items-center justify-center min-h-[180px]",children:[e.jsx(Us,{contentType:Dt,isVisible:!0}),((tn=t.content)==null?void 0:tn.title)&&e.jsx("div",{className:"mt-4 text-indigo-600 text-sm font-medium",children:(sn=t.content)==null?void 0:sn.title})]}),t.type==="activity-intro"&&e.jsx("div",{children:(nn=t.content)!=null&&nn.imageUrl?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t.content.imageUrl,alt:((rn=t.content)==null?void 0:rn.title)||"×ª×ž×•× ×ª ×¤×ª×™×—×”",className:"w-full max-h-[400px] object-contain rounded-lg bg-gray-50",loading:"lazy"}),e.jsxs("div",{className:"mt-2 p-2",children:[e.jsx("h3",{className:"text-gray-800 font-medium text-sm",children:(an=t.content)==null?void 0:an.title}),((on=t.content)==null?void 0:on.description)&&e.jsx("p",{className:"text-gray-500 text-xs mt-1",children:t.content.description})]})]}):e.jsx("div",{className:"h-32 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400",children:e.jsxs("div",{className:"text-center text-sm",children:[e.jsx(Xe,{className:"w-5 h-5 mx-auto mb-1 animate-pulse"}),e.jsx("span",{children:"×ž×™×™×¦×¨ ×ª×ž×•× ×”..."})]})})}),t.type==="scenario-image"&&e.jsx("div",{children:(ln=t.content)!=null&&ln.imageUrl?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t.content.imageUrl,alt:((cn=t.content)==null?void 0:cn.caption)||"×ª×ž×•× ×ª ×“×™×œ×ž×”",className:"w-full max-h-[400px] object-contain rounded-lg bg-gray-50",loading:"lazy"}),((dn=t.content)==null?void 0:dn.caption)&&e.jsx("p",{className:"mt-1 text-center text-gray-600 text-xs",children:t.content.caption})]}):e.jsx("div",{className:"h-24 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm",children:e.jsx("span",{className:"animate-pulse",children:"×ž×™×™×¦×¨ ×ª×ž×•× ×”..."})})}),t.type==="infographic"&&e.jsx("div",{children:(un=t.content)!=null&&un.imageUrl?e.jsxs("div",{children:[e.jsx("img",{src:t.content.imageUrl,alt:((mn=t.content)==null?void 0:mn.title)||"××™× ×¤×•×’×¨×¤×™×§×”",className:"w-full rounded-lg bg-white",loading:"lazy"}),e.jsxs("div",{className:"mt-2 space-y-1.5",children:[e.jsx("input",{type:"text",className:"w-full border border-gray-200 rounded-lg p-2 text-sm",placeholder:"×›×•×ª×¨×ª...",value:((gn=t.content)==null?void 0:gn.title)||"",onChange:o=>w(t.id,{...t.content,title:o.target.value})}),e.jsx("input",{type:"text",className:"w-full border border-gray-200 rounded-lg p-2 text-sm",placeholder:"×›×™×ª×•×‘ (××•×¤×¦×™×•× ×œ×™)...",value:((pn=t.content)==null?void 0:pn.caption)||"",onChange:o=>w(t.id,{...t.content,caption:o.target.value})})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"×¡×•×’:"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:[{type:"flowchart",label:"×ª×¨×©×™× ×–×¨×™×ž×”"},{type:"timeline",label:"×¦×™×¨ ×–×ž×Ÿ"},{type:"comparison",label:"×”×©×•×•××”"},{type:"cycle",label:"×ž×—×–×•×¨"}].map(({type:o,label:P})=>{var D;return e.jsx("button",{onClick:()=>w(t.id,{...t.content,visualType:o}),className:`px-2 py-1 rounded-lg border text-xs transition-all ${((D=t.content)==null?void 0:D.visualType)===o?"bg-gray-700 border-gray-700 text-white":"bg-white border-gray-200 text-gray-600 hover:border-gray-300"}`,children:P},o)})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"×ª×•×›×Ÿ:"}),e.jsx("textarea",{className:"w-full border border-gray-200 rounded-lg p-2 text-sm resize-none",rows:3,placeholder:"×”×›× ×™×¡×• ××ª ×”×˜×§×¡×˜ ×©×™×•×¦×’ ×‘××™× ×¤×•×’×¨×¤×™×§×”...",value:I[t.id]||"",onChange:o=>F({...I,[t.id]:o.target.value})})]}),e.jsx("button",{onClick:async()=>{var P;const o=I[t.id];if(!o||o.trim().length<10){alert("× × ×œ×”×–×™×Ÿ ×ª×•×›×Ÿ (×œ×¤×—×•×ª 10 ×ª×•×•×™×)");return}x(t.id);try{const D=((P=t.content)==null?void 0:P.visualType)||"flowchart",A=await Cr(o,D,n==null?void 0:n.title);if(A){const L=await Ds(A,`infographic_${t.id}.png`,"image/png");w(t.id,{imageUrl:L,title:(n==null?void 0:n.title)||"××™× ×¤×•×’×¨×¤×™×§×”",caption:"",visualType:D},{infographicType:D}),F({...I,[t.id]:""})}else alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”××™× ×¤×•×’×¨×¤×™×§×”")}catch(D){console.error("Infographic generation error:",D),alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”××™× ×¤×•×’×¨×¤×™×§×”")}finally{x(null)}},disabled:g===t.id||!((xn=I[t.id])!=null&&xn.trim()),className:"w-full bg-gray-700 text-white py-2 px-3 rounded-lg text-sm font-medium hover:bg-gray-800 transition-all disabled:opacity-50 flex items-center justify-center gap-2",children:g===t.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"×™×•×¦×¨..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Rs,{className:"w-3 h-3"}),"×¦×•×¨ ××™× ×¤×•×’×¨×¤×™×§×”"]})})]})}),t.type==="matching"&&e.jsxs("div",{className:"bg-violet-50/50 p-5 rounded-xl border border-violet-100",children:[e.jsx("div",{className:"flex items-center gap-2 mb-4 text-violet-700 font-bold justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Lt,{className:"w-5 h-5"})," ×”×ª××ž×”"]})}),e.jsx(xt,{value:t.content&&t.content.instruction||"",onChange:o=>w(t.id,{...t.content,instruction:o}),placeholder:"×”× ×—×™×” (×œ×ž×©×œ: ×”×ª××™×ž×• ×‘×™×Ÿ ×”×ž×•×©×’×™× ×œ×”×’×“×¨×•×ª)",minHeight:"40px",maxHeight:"150px",collapsible:!0}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-violet-400 uppercase mb-2",children:"×¢×ž×•×“×” ×©×ž××œ (×ž×•×©×’×™×)"}),e.jsxs("div",{className:"space-y-2",children:[(((hn=t.content)==null?void 0:hn.leftItems)||[]).map((o,P)=>e.jsxs("div",{className:"flex gap-2 items-center bg-white p-2 rounded border border-violet-100",children:[e.jsx("span",{className:"text-xs text-violet-300 font-mono w-6",children:o.id}),e.jsx("input",{type:"text",className:"flex-1 p-2 text-base border-b border-gray-200 focus:border-violet-400 outline-none",value:(o==null?void 0:o.text)||"",onChange:D=>{var L;const A=[...((L=t.content)==null?void 0:L.leftItems)||[]];A[P]={...A[P],text:D.target.value},w(t.id,{...t.content,leftItems:A})},placeholder:"×˜×§×¡×˜ ×”×¤×¨×™×˜"}),e.jsx("button",{onClick:()=>{var Z,Oe,Nt,Ht,Wt;const D=(Nt=(Oe=(Z=t.content)==null?void 0:Z.leftItems)==null?void 0:Oe[P])==null?void 0:Nt.id,A=(((Ht=t.content)==null?void 0:Ht.leftItems)||[]).filter((Jt,Is)=>Is!==P),L=(((Wt=t.content)==null?void 0:Wt.correctMatches)||[]).filter(Jt=>Jt.left!==D);w(t.id,{...t.content,leftItems:A,correctMatches:L})},className:"text-red-400 hover:text-red-600",children:e.jsx(ct,{className:"w-3 h-3"})})]},o.id||P)),e.jsx("button",{onClick:()=>{var P,D,A;const o=`l${(((D=(P=t.content)==null?void 0:P.leftItems)==null?void 0:D.length)||0)+1}`;w(t.id,{...t.content,leftItems:[...((A=t.content)==null?void 0:A.leftItems)||[],{id:o,text:""}]})},className:"text-xs font-bold text-violet-600 bg-violet-100 hover:bg-violet-200 px-3 py-1 rounded-full",children:"+ ×¤×¨×™×˜ ×©×ž××œ"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-violet-400 uppercase mb-2",children:"×¢×ž×•×“×” ×™×ž×™×Ÿ (×”×’×“×¨×•×ª)"}),e.jsxs("div",{className:"space-y-2",children:[(((fn=t.content)==null?void 0:fn.rightItems)||[]).map((o,P)=>e.jsxs("div",{className:"flex gap-2 items-center bg-white p-2 rounded border border-violet-100",children:[e.jsx("span",{className:"text-xs text-violet-300 font-mono w-6",children:o.id}),e.jsx("input",{type:"text",className:"flex-1 p-2 text-base border-b border-gray-200 focus:border-violet-400 outline-none",value:(o==null?void 0:o.text)||"",onChange:D=>{var L;const A=[...((L=t.content)==null?void 0:L.rightItems)||[]];A[P]={...A[P],text:D.target.value},w(t.id,{...t.content,rightItems:A})},placeholder:"×˜×§×¡×˜ ×”×”×ª××ž×”"}),e.jsx("button",{onClick:()=>{var Z,Oe,Nt,Ht,Wt;const D=(Nt=(Oe=(Z=t.content)==null?void 0:Z.rightItems)==null?void 0:Oe[P])==null?void 0:Nt.id,A=(((Ht=t.content)==null?void 0:Ht.rightItems)||[]).filter((Jt,Is)=>Is!==P),L=(((Wt=t.content)==null?void 0:Wt.correctMatches)||[]).filter(Jt=>Jt.right!==D);w(t.id,{...t.content,rightItems:A,correctMatches:L})},className:"text-red-400 hover:text-red-600",children:e.jsx(ct,{className:"w-3 h-3"})})]},o.id||P)),e.jsx("button",{onClick:()=>{var P,D,A;const o=`r${(((D=(P=t.content)==null?void 0:P.rightItems)==null?void 0:D.length)||0)+1}`;w(t.id,{...t.content,rightItems:[...((A=t.content)==null?void 0:A.rightItems)||[],{id:o,text:""}]})},className:"text-xs font-bold text-violet-600 bg-violet-100 hover:bg-violet-200 px-3 py-1 rounded-full",children:"+ ×¤×¨×™×˜ ×™×ž×™×Ÿ"})]})]})]}),e.jsxs("div",{className:"mt-6 p-4 bg-violet-100/50 rounded-lg",children:[e.jsx("h4",{className:"text-xs font-bold text-violet-500 uppercase mb-3",children:"×”×ª××ž×•×ª × ×›×•× ×•×ª"}),e.jsxs("div",{className:"space-y-2",children:[(((yn=t.content)==null?void 0:yn.correctMatches)||[]).map((o,P)=>{var D,A;return e.jsxs("div",{className:"flex gap-2 items-center bg-white p-2 rounded border border-violet-200",children:[e.jsxs("select",{className:"flex-1 p-2 bg-gray-50 rounded border border-gray-200 text-sm",value:(o==null?void 0:o.left)||"",onChange:L=>{var Oe;const Z=[...((Oe=t.content)==null?void 0:Oe.correctMatches)||[]];Z[P]={...Z[P],left:L.target.value},w(t.id,{...t.content,correctMatches:Z})},children:[e.jsx("option",{value:"",disabled:!0,children:"×‘×—×¨ ×¤×¨×™×˜ ×©×ž××œ"}),(((D=t.content)==null?void 0:D.leftItems)||[]).map(L=>e.jsx("option",{value:L.id,children:L.text||L.id},L.id))]}),e.jsx("span",{className:"text-violet-400 font-bold",children:"â†”"}),e.jsxs("select",{className:"flex-1 p-2 bg-gray-50 rounded border border-gray-200 text-sm",value:(o==null?void 0:o.right)||"",onChange:L=>{var Oe;const Z=[...((Oe=t.content)==null?void 0:Oe.correctMatches)||[]];Z[P]={...Z[P],right:L.target.value},w(t.id,{...t.content,correctMatches:Z})},children:[e.jsx("option",{value:"",disabled:!0,children:"×‘×—×¨ ×¤×¨×™×˜ ×™×ž×™×Ÿ"}),(((A=t.content)==null?void 0:A.rightItems)||[]).map(L=>e.jsx("option",{value:L.id,children:L.text||L.id},L.id))]}),e.jsx("button",{onClick:()=>{var Z;const L=(((Z=t.content)==null?void 0:Z.correctMatches)||[]).filter((Oe,Nt)=>Nt!==P);w(t.id,{...t.content,correctMatches:L})},className:"text-red-400 hover:text-red-600",children:e.jsx(ct,{className:"w-4 h-4"})})]},P)}),e.jsx("button",{onClick:()=>{var o;return w(t.id,{...t.content,correctMatches:[...((o=t.content)==null?void 0:o.correctMatches)||[],{left:"",right:""}]})},className:"text-xs font-bold text-violet-600 bg-violet-200 hover:bg-violet-300 px-3 py-1 rounded-full",children:"+ ×”×•×¡×£ ×”×ª××ž×”"})]})]})]}),["highlight","sentence_builder","image_labeling","table_completion","text_selection","rating_scale","matrix","drag_and_drop","hotspot"].includes(t.type)&&e.jsxs("div",{className:"bg-slate-50/50 p-5 rounded-xl border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4 text-slate-700 font-bold",children:[e.jsx(Rt,{className:"w-5 h-5"})," ",$e[t.type]||t.type]}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:"×¡×•×’ ×©××œ×” ×–×” × ×ª×ž×š ×‘×ž×¢×¨×›×ª. ×¢×¨×›×• ××ª ×”×ª×•×›×Ÿ ×™×©×™×¨×•×ª ×‘-JSON ××• ×”×©×ª×ž×©×• ×‘-AI ×œ×™×¦×™×¨×” ××•×˜×•×ž×˜×™×ª."}),e.jsx("pre",{className:"bg-white p-3 rounded-lg border text-xs overflow-auto max-h-40 text-left",dir:"ltr",children:JSON.stringify(t.content,null,2)})]})]})]}),e.jsx(Qe,{index:i+1})]},t.id)})]})}),U&&e.jsx("div",{className:"w-1/2 border-r border-gray-200 bg-white shadow-xl z-20 animate-slide-in-left relative overflow-hidden flex flex-col h-full bg-slate-50",children:e.jsx(Ea,{content:l.fullBookContent||"××™×Ÿ ×ª×•×›×Ÿ ×–×ž×™×Ÿ.",pdfSource:l.pdfSource||void 0,onClose:()=>J(!1)})})]}),le&&e.jsxs("div",{className:`fixed bottom-0 left-0 right-0 p-3 flex justify-between items-center px-10 transition-colors shadow-[0_-5px_20px_rgba(0,0,0,0.1)] backdrop-blur-md border-t z-50 animate-slide-up
                    ${Te===100?"bg-green-50/90 border-green-200 text-green-900":"bg-white/90 border-red-200 text-slate-800"}`,children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:`text-2xl font-black flex items-center gap-2 ${Te===100?"text-green-600":"text-red-500"}`,children:[e.jsx(Ps,{className:"w-6 h-6"}),Te," / 100"]}),Te!==100&&e.jsx("div",{className:"text-sm font-bold text-red-500 bg-red-100 px-3 py-1 rounded-full animate-pulse",children:Te<100?`×—×¡×¨×•×ª ${100-Te} × ×§×•×“×•×ª`:`×¢×•×“×£ ×©×œ ${Te-100} × ×§×•×“×•×ª`}),Te===100&&e.jsxs("div",{className:"text-sm font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full flex items-center gap-1",children:[e.jsx(At,{className:"w-4 h-4"})," ×¡×š ×”×›×œ ×ª×§×™×Ÿ"]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:be,className:"text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-bold shadow-sm transition-colors",children:"×—×™×©×•×‘ ×ž×—×“×© (××•×˜×•×ž×˜×™)"})})]}),e.jsx("style",{children:`
                .insert-btn { @apply w-20 h-20 p-2 bg-white/50 border border-white/60 rounded-xl text-[10px] font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all flex flex-col items-center justify-center gap-1.5 shadow-sm text-center leading-tight; }
                .insert-btn svg { @apply w-6 h-6 flex-shrink-0; }
                .animate-scale-in { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; transform-origin: bottom center; }
                @keyframes scaleIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
            `}),oe&&Js.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] p-4 text-right",dir:"rtl",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in",children:[e.jsxs("div",{className:"bg-indigo-600 p-4 text-white flex justify-between items-center",children:[e.jsxs("h3",{className:"font-bold text-lg flex items-center gap-2",children:[e.jsx(Lt,{className:"w-5 h-5"})," ",_e?"×”×§×™×©×•×¨ ×ž×•×›×Ÿ!":"×™×¦×™×¨×ª ×§×™×©×•×¨ ×œ×ž×©×™×ž×”"]}),e.jsx("button",{onClick:Be,className:"hover:bg-indigo-700 p-1 rounded-full text-indigo-100",children:e.jsx(Ct,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-6 space-y-4",children:_e?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(At,{className:"w-8 h-8 text-green-600"})}),e.jsx("p",{className:"text-lg font-bold text-slate-700 mb-2",children:"×”×§×™×©×•×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!"}),e.jsx("p",{className:"text-sm text-slate-500",children:"×©×œ×—×• ××ª ×”×§×™×©×•×¨ ×œ×ª×œ×ž×™×“×™×"})]}),e.jsxs("div",{className:"bg-slate-50 border border-slate-200 rounded-xl p-3",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 mb-2",children:"×§×™×©×•×¨ ×œ×ž×©×™×ž×”:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",readOnly:!0,value:_e,className:"flex-1 bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-600 select-all",onClick:t=>t.target.select()}),e.jsxs("button",{onClick:Ge,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors flex items-center gap-1 text-sm",children:[e.jsx(Sr,{className:"w-4 h-4"})," ×”×¢×ª×§"]})]})]}),e.jsx("button",{onClick:Be,className:"w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition-colors mt-2",children:"×¡×’×•×¨"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-slate-700 mb-1",children:"×©× ×”×ž×©×™×ž×” / ×ž×‘×—×Ÿ"}),e.jsx("input",{type:"text",className:"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none",value:q.title,onChange:t=>K({...q,title:t.target.value}),placeholder:"×œ×ž×©×œ: ×¡×™×•× ×¤×¨×§ ×‘×³ - ×—×–×¨×” ×œ×ž×‘×—×Ÿ"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-slate-700 mb-1",children:"×ª××¨×™×š ×”×’×©×”"}),e.jsx("input",{type:"date",className:"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 outline-none",value:q.dueDate,onChange:t=>K({...q,dueDate:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-slate-700 mb-1",children:"×©×¢×”"}),e.jsx("input",{type:"time",className:"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 outline-none",value:q.dueTime,onChange:t=>K({...q,dueTime:t.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-slate-700 mb-1",children:"×”× ×—×™×•×ª ×œ×ª×œ×ž×™×“ (××•×¤×¦×™×•× ×œ×™)"}),e.jsx("textarea",{className:"w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:border-indigo-500 outline-none h-20 resize-none",value:q.instructions,onChange:t=>K({...q,instructions:t.target.value}),placeholder:"×”× ×—×™×•×ª ×ž×™×•×—×“×•×ª, ×–×ž×Ÿ ×ž×•×ž×œ×¥, ×•×›×•'..."})]}),e.jsxs("button",{onClick:Ee,className:"w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors flex justify-center items-center gap-2 mt-2",children:[e.jsx(Lt,{className:"w-5 h-5"})," ×¦×•×¨ ×§×™×©×•×¨"]}),e.jsx("p",{className:"text-xs text-center text-slate-400",children:"×”×§×™×©×•×¨ ×™×©×ž×¨ ×‘×”×™×¡×˜×•×¨×™×™×ª ×”×ž×©×™×ž×•×ª ×©×œ ×”×›×™×ª×”"})]})})]})}),document.body),e.jsx(ai,{isOpen:rs,onClose:()=>{kt(!1),qt(null)},onSelectVideo:ue,gradeLevel:s,subject:r,initialQuery:c.title||""}),e.jsx(gi,{isOpen:N,onClose:()=>{de(!1),ye(null)},onGenerate:t=>{ve&&(w(ve,t),se(!0))},sourceText:(l==null?void 0:l.fullBookContent)||c.baseContent||"",topic:c.title,gradeLevel:s})]})},An={isStreaming:!1,progress:"",currentLevel:void 0,currentPart:void 0,currentStep:void 0,totalSteps:void 0,streamedText:"",error:null};function yi(){const[n,s]=S.useState(An),r=S.useRef(null),a=S.useCallback(()=>{s(An),r.current=null},[]),d=S.useCallback(()=>{r.current&&(r.current.abort(),r.current=null,s(g=>({...g,isStreaming:!1,progress:"×‘×•×˜×œ"})))},[]),p=S.useCallback(async(g,x,T)=>(a(),s(h=>({...h,isStreaming:!0,progress:"×ž×ª×—×™×œ ×œ×™×¦×•×¨..."})),new Promise(async(h,_)=>{try{let E="";const M=await Ja(g,x,T||{},{onChunk:R=>{E+=R,s(U=>({...U,streamedText:E}))},onProgress:R=>{s(U=>({...U,progress:R}))},onComplete:R=>{s(U=>({...U,isStreaming:!1,progress:"×”×•×©×œ×!"})),h(R)},onError:R=>{s(U=>({...U,isStreaming:!1,error:R})),_(new Error(R))}});r.current=M}catch(E){s(M=>({...M,isStreaming:!1,error:E.message})),_(E)}})),[a]),l=S.useCallback(async g=>{a(),s(x=>({...x,isStreaming:!0,progress:"×ž×ª×—×™×œ ×œ×™×¦×•×¨ ×ª×•×›×Ÿ ×ž×•×ª××..."}));try{const{controller:x,result:T}=await Ya(g,{onChunk:(h,_)=>{s(E=>({...E,streamedText:E.streamedText+h,currentLevel:_==null?void 0:_.level}))},onProgress:(h,_)=>{s(E=>({...E,progress:h,currentLevel:_==null?void 0:_.level}))},onLevelStart:h=>{const _={support:"×”×‘× ×”",core:"×™×™×©×•×",enrichment:"×”×¢×ž×§×”"};s(E=>({...E,currentLevel:h,progress:`×ž×™×™×¦×¨ ${_[h]||h}...`,streamedText:""}))},onLevelComplete:h=>{const _={support:"×”×‘× ×”",core:"×™×™×©×•×",enrichment:"×”×¢×ž×§×”"};s(E=>({...E,progress:`âœ“ ${_[h]||h} ×”×•×©×œ×ž×”`}))},onComplete:()=>{s(h=>({...h,isStreaming:!1,progress:"×›×œ ×”×¨×ž×•×ª ×”×•×©×œ×ž×•!",currentLevel:void 0}))},onError:h=>{s(_=>({..._,isStreaming:!1,error:h}))}});return r.current=x,await T}catch(x){throw s(T=>({...T,isStreaming:!1,error:x.message})),x}},[a]),c=S.useCallback(async g=>{a(),s(x=>({...x,isStreaming:!0,progress:"×ž×ª×—×™×œ ×œ×™×¦×•×¨ ×ž×¢×¨×š ×©×™×¢×•×¨..."}));try{const{controller:x,result:T}=await Qa(g,{onChunk:(h,_)=>{s(E=>({...E,streamedText:E.streamedText+h,currentPart:_==null?void 0:_.itemType}))},onProgress:(h,_)=>{s(E=>({...E,progress:h,currentPart:_==null?void 0:_.itemType}))},onPartStart:h=>{const _={hook:"×¤×ª×™×—×”",instruction:"×”×•×¨××”",practice:"×ª×¨×’×•×œ",summary:"×¡×™×›×•×"};s(E=>({...E,currentPart:h,progress:`×ž×™×™×¦×¨ ${_[h]||h}...`,streamedText:""}))},onPartComplete:h=>{const _={hook:"×¤×ª×™×—×”",instruction:"×”×•×¨××”",practice:"×ª×¨×’×•×œ",summary:"×¡×™×›×•×"};s(E=>({...E,progress:`âœ“ ${_[h]||h} ×”×•×©×œ×`}))},onComplete:()=>{s(h=>({...h,isStreaming:!1,progress:"×ž×¢×¨×š ×”×©×™×¢×•×¨ ×”×•×©×œ×!",currentPart:void 0}))},onError:h=>{s(_=>({..._,isStreaming:!1,error:h}))}});return r.current=x,await T}catch(x){throw s(T=>({...T,isStreaming:!1,error:x.message})),x}},[a]),v=S.useCallback(async g=>{a(),s(x=>({...x,isStreaming:!0,progress:"×ž×ª×—×™×œ ×œ×™×¦×•×¨ ×¤×•×“×§××¡×˜..."}));try{const{controller:x,result:T}=await Xa(g,{onChunk:h=>{s(_=>({..._,streamedText:_.streamedText+h}))},onProgress:h=>{s(_=>({..._,progress:h}))},onComplete:()=>{s(h=>({...h,isStreaming:!1,progress:"×”×¤×•×“×§××¡×˜ ×”×•×©×œ×!"}))},onError:h=>{s(_=>({..._,isStreaming:!1,error:h}))}});return r.current=x,await T}catch(x){throw s(T=>({...T,isStreaming:!1,error:x.message})),x}},[a]),B=S.useCallback(async(g,x,T)=>{a(),s(h=>({...h,isStreaming:!0,progress:"×ž×ª×—×™×œ ×œ×™×¦×•×¨ ×¤×¢×™×œ×•×ª..."}));try{const{controller:h,result:_}=await er(g,{onProgress:(E,M)=>{s(R=>({...R,progress:E,currentStep:M==null?void 0:M.stepNumber,totalSteps:M==null?void 0:M.totalSteps}))},onSkeletonComplete:E=>{s(M=>{var R,U;return{...M,progress:`×ž×‘× ×” ×¤×¢×™×œ×•×ª ×ž×•×›×Ÿ - ${((R=E.steps)==null?void 0:R.length)||5} ×¦×¢×“×™×`,totalSteps:((U=E.steps)==null?void 0:U.length)||5}}),T==null||T(E)},onStepComplete:(E,M,R)=>{s(U=>({...U,progress:`×¦×¢×“ ${M}/${R} ×”×•×©×œ×`,currentStep:M,totalSteps:R})),x==null||x(E,M,R)},onComplete:()=>{s(E=>({...E,isStreaming:!1,progress:"×”×¤×¢×™×œ×•×ª ×”×•×©×œ×ž×”!",currentStep:void 0,totalSteps:void 0}))},onError:E=>{s(M=>({...M,isStreaming:!1,error:E}))}});return r.current=h,await _}catch(h){throw s(_=>({..._,isStreaming:!1,error:h.message})),h}},[a]);return{state:n,startStreaming:p,startDifferentiatedStreaming:l,startLessonStreaming:c,startPodcastStreaming:v,startActivityStreaming:B,cancelStreaming:d,resetState:a}}const vi=({currentLevel:n,completedLevels:s=[]})=>{const r=[{key:"support",name:"×ª×•×ž×›×ª",color:"bg-green-500"},{key:"core",name:"×¨×’×™×œ×”",color:"bg-blue-500"},{key:"enrichment",name:"×ž×ª×§×“×ž×ª",color:"bg-purple-500"}];return e.jsx("div",{className:"flex gap-2 items-center justify-center mt-3",children:r.map((a,d)=>{const p=s.includes(a.key),l=n===a.key;return e.jsxs(zs.Fragment,{children:[d>0&&e.jsx("div",{className:`h-0.5 w-8 transition-colors duration-300 ${p||l?"bg-gray-400":"bg-gray-200"}`}),e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("div",{className:`
                  w-8 h-8 rounded-full flex items-center justify-center
                  transition-all duration-300
                  ${p?`${a.color} text-white`:""}
                  ${l?`${a.color} text-white animate-pulse ring-2 ring-offset-2 ring-${a.color}`:""}
                  ${!p&&!l?"bg-gray-200 text-gray-400":""}
                `,children:p?e.jsx(Wn,{className:"w-5 h-5"}):l?e.jsx(Hn,{className:"w-5 h-5 animate-spin"}):e.jsx("span",{className:"text-xs font-medium",children:d+1})}),e.jsx("span",{className:`text-xs font-medium ${l?"text-gray-900":"text-gray-500"}`,children:a.name})]})]},a.key)})})},bi=({text:n})=>n?e.jsx("div",{className:"mt-4 p-4 bg-gray-50 rounded-lg max-h-48 overflow-y-auto",children:e.jsxs("div",{className:"font-mono text-sm text-gray-700 whitespace-pre-wrap break-words",children:[n,e.jsx("span",{className:"inline-block w-2 h-4 bg-blue-500 animate-pulse ml-0.5"})]})}):null,wi=({state:n,onCancel:s,showStreamedText:r=!1,className:a=""})=>{const{isStreaming:d,progress:p,currentLevel:l,currentPart:c,streamedText:v,error:B}=n;if(!d&&!B&&!p)return null;const g=[];return p.includes("âœ“ ×¨×ž×” ×ª×•×ž×›×ª")&&g.push("support"),p.includes("âœ“ ×¨×ž×” ×¨×’×™×œ×”")&&g.push("core"),p.includes("âœ“ ×¨×ž×” ×ž×ª×§×“×ž×ª")&&g.push("enrichment"),e.jsxs("div",{className:`rounded-xl border bg-white shadow-lg p-6 ${a}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[d?e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",children:e.jsx(Rn,{className:"w-5 h-5 text-white animate-pulse"})}),e.jsx("div",{className:"absolute -inset-1 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 opacity-30 animate-ping"})]}):B?e.jsx("div",{className:"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center",children:e.jsx(Ta,{className:"w-5 h-5 text-red-500"})}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-green-100 flex items-center justify-center",children:e.jsx(Wn,{className:"w-5 h-5 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:d?"×™×•×¦×¨ ×ª×•×›×Ÿ...":B?"×©×’×™××”":"×”×•×©×œ×!"}),e.jsx("p",{className:"text-sm text-gray-500",children:p})]})]}),d&&s&&e.jsx("button",{onClick:s,className:"px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",children:"×‘×™×˜×•×œ"})]}),B&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:B}),l&&e.jsx(vi,{currentLevel:l,completedLevels:g}),c&&!l&&e.jsx("div",{className:"mt-3 text-center",children:e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium",children:[e.jsx(Hn,{className:"w-4 h-4 animate-spin"}),c==="hook"&&"×¤×ª×™×—×”",c==="instruction"&&"×”×•×¨××”",c==="practice"&&"×ª×¨×’×•×œ",c==="summary"&&"×¡×™×›×•×"]})}),d&&e.jsx("div",{className:"mt-4 h-1.5 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full animate-streaming-progress"})}),r&&v&&e.jsx(bi,{text:v})]})},ji=({course:n,onUpdateCourse:s,onSelectUnit:r,onUnitUpdate:a,onGenerateWithAI:d,onBack:p})=>{var I,F;qn();const[l,c]=S.useState(new Set),[v,B]=S.useState(null),g=j=>{const C=new Set(l);C.has(j)?C.delete(j):C.add(j),c(C)},x=(j,C,$)=>{var Y;if(!a)return;const V=((Y=j.activityBlocks)==null?void 0:Y.map(se=>se.id===C?{...se,content:$}:se))||[],Q={...j,activityBlocks:V};a(Q)},T=()=>{const j={id:ze(),title:`New Phase ${n.syllabus.length+1}`,learningUnits:[]},C={...n,syllabus:[...n.syllabus,j]};s(C)},h=j=>{if(!confirm("Are you sure you want to delete this phase and all its units?"))return;const C=n.syllabus.filter($=>$.id!==j);s({...n,syllabus:C})},_=(j,C)=>{const $=[...n.syllabus];C==="up"&&j>0?[$[j-1],$[j]]=[$[j],$[j-1]]:C==="down"&&j<$.length-1&&([$[j+1],$[j]]=[$[j],$[j+1]]),s({...n,syllabus:$})},E=j=>{const C={id:ze(),title:"New Activity",type:"practice",baseContent:"",activityBlocks:[]},$=n.syllabus.map(V=>V.id===j?{...V,learningUnits:[...V.learningUnits,C]}:V);s({...n,syllabus:$})},M=(j,C)=>{if(!confirm("Delete this activity?"))return;const $=n.syllabus.map(V=>V.id===j?{...V,learningUnits:V.learningUnits.filter(Q=>Q.id!==C)}:V);s({...n,syllabus:$})},R=(j,C,$)=>{const V=n.syllabus.map(Q=>{if(Q.id===j){const Y=[...Q.learningUnits];return $==="up"&&C>0?[Y[C-1],Y[C]]=[Y[C],Y[C-1]]:$==="down"&&C<Y.length-1&&([Y[C+1],Y[C]]=[Y[C],Y[C+1]]),{...Q,learningUnits:Y}}return Q});s({...n,syllabus:V})},[U,J]=S.useState(null),X=(j,C,$="assign")=>{J({courseTitle:n.title,courseId:n.id,unitId:j,unitTitle:C,initialTab:$})},k=()=>n.syllabus.flatMap(j=>j.learningUnits),G=j=>{if(j)B(j);else{const C=k();C.length>0&&B(C[0])}},f=(j,C)=>j===0?e.jsx(Hr,{className:"w-6 h-6 text-indigo-600"}):j===C-1?e.jsx(Wr,{className:"w-6 h-6 text-red-600"}):j===1?e.jsx(kn,{className:"w-6 h-6 text-blue-600"}):e.jsx(Jr,{className:"w-6 h-6 text-purple-600"});return e.jsxs("div",{className:"p-4 md:p-8 max-w-5xl mx-auto h-full overflow-y-auto custom-scrollbar print:p-0 print:overflow-visible",dir:"rtl",children:[e.jsx("header",{className:"sticky top-4 z-40 card-glass p-6 mb-8 print:mb-4 print:static print:shadow-none print:bg-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>{console.log("ðŸ”™ LessonPlanOverview back clicked, onBack:",typeof p),p?(console.log("ðŸ”™ Calling onBack..."),p()):(console.log("ðŸ”™ No onBack, reloading to home..."),window.location.href="/")},className:"flex items-center justify-center w-10 h-10 rounded-full bg-white/80 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 text-gray-600 hover:text-blue-600 transition-all shadow-sm print:hidden",title:"×—×–×¨×” ×œ×“×£ ×”×‘×™×ª",children:e.jsx(kr,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 print:text-black",children:n.title||"×ž×¢×¨×š ×©×™×¢×•×¨ ×œ×œ× ×©×"}),e.jsxs("div",{className:"flex gap-4 mt-2 text-gray-500 font-medium print:text-sm",children:[e.jsx("span",{className:"px-3 py-1 bg-white/60 backdrop-blur-sm rounded-full text-sm border border-white/40 shadow-sm print:border print:border-gray-300",children:n.gradeLevel||"×’×™×œ ×œ× ×”×•×’×“×¨"}),e.jsx("span",{className:"px-3 py-1 bg-white/60 backdrop-blur-sm rounded-full text-sm border border-white/40 shadow-sm print:border print:border-gray-300",children:n.subject||"×›×œ×œ×™"}),(n.mode==="lesson"||((F=(I=n.wizardData)==null?void 0:I.settings)==null?void 0:F.productType)==="lesson")&&e.jsx("span",{className:"px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-sm print:hidden",children:"×ž×¢×¨×š ×©×™×¢×•×¨"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 print:hidden",children:[e.jsxs("button",{onClick:()=>G(),className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors shadow-sm border border-white/60 bg-white/50",title:"×ž×¦×‘ ×”×§×¨× ×” - ×ª×¦×•×’×ª ×ž×¢×¨×š ×”×©×™×¢×•×¨ ×œ×ž×•×¨×”",children:[e.jsx(Ss,{className:"w-[22px] h-[22px]"}),e.jsx("span",{className:"text-sm font-medium hidden md:inline",children:"×”×§×¨× ×”"})]}),e.jsx("button",{onClick:()=>X(void 0,void 0,"collab"),className:"p-2 text-gray-600 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors shadow-sm border border-white/60 bg-white/50",title:"×©×ª×£ ×¢× ×¢×ž×™×ª",children:e.jsx(qr,{className:"w-[22px] h-[22px]"})}),e.jsx("div",{className:"h-6 w-px bg-gray-200 mx-2"}),e.jsxs("button",{onClick:()=>d==null?void 0:d("module","course","Expand entire syllabus"),className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-violet-100 to-purple-100 text-purple-700 rounded-xl hover:from-violet-200 hover:to-purple-200 border border-purple-200 shadow-sm transition-colors",children:[e.jsx(Cn,{className:"w-5 h-5"}),e.jsx("span",{children:"×¡×™×™×¢ AI"})]})]})]})}),e.jsxs("div",{className:"space-y-6 relative print:space-y-4",children:[e.jsx("div",{className:"absolute right-6 top-4 bottom-4 w-0.5 bg-gray-200 -z-10 print:hidden"}),n.syllabus.map((j,C)=>e.jsxs("div",{className:"relative pr-4 md:pr-14 group print:pr-0",children:[e.jsx("div",{className:"absolute right-3 top-6 w-10 h-10 rounded-full bg-white/80 backdrop-blur-sm border-2 border-blue-200 z-10 shadow-md flex items-center justify-center print:hidden",children:f(C,n.syllabus.length)}),e.jsxs("div",{className:"card-glass hover:shadow-lg transition-all p-6 relative overflow-hidden print:shadow-none print:border-gray-300 print:break-inside-avoid print:bg-white",children:[e.jsx("div",{className:"absolute top-0 left-0 w-64 h-64 bg-gradient-to-br from-blue-50 to-transparent opacity-50 rounded-br-full -z-0 pointer-events-none print:hidden"}),e.jsxs("div",{className:"flex items-center justify-between mb-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:j.title}),e.jsx("button",{className:"text-gray-400 hover:text-blue-600 transition-colors print:hidden p-1 hover:bg-blue-50 rounded shadow-sm border border-white/60 bg-white/50",children:e.jsx(Rt,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center gap-2 print:hidden",children:[d&&e.jsxs("button",{onClick:()=>d("module",j.id),className:"flex items-center gap-1 px-2 py-1 text-xs text-purple-600 bg-gradient-to-r from-violet-50 to-purple-50 rounded-lg hover:from-violet-100 hover:to-purple-100 border border-purple-100 shadow-sm",title:"×¢×¨×•×š ×©×œ×‘ ×¢× AI",children:[e.jsx(Cn,{className:"w-3.5 h-3.5"})," AI ×¢×¨×™×›×”"]}),e.jsx("div",{className:"h-4 w-px bg-gray-300 mx-1"}),e.jsx("button",{onClick:()=>_(C,"up"),disabled:C===0,className:"p-1 hover:bg-blue-50 hover:text-blue-600 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm",children:e.jsx(Gs,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>_(C,"down"),disabled:C===n.syllabus.length-1,className:"p-1 hover:bg-blue-50 hover:text-blue-600 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm",children:e.jsx(vs,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>h(j.id),className:"p-1 text-red-500 hover:bg-red-50 rounded ml-2 bg-white/50 border border-white/60 shadow-sm",children:e.jsx(ct,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"space-y-3 relative z-10",children:j.learningUnits.length===0?e.jsxs("div",{className:"text-center py-6 border-2 border-dashed border-blue-100 rounded-xl bg-blue-50/30 backdrop-blur-sm print:hidden",children:[e.jsx("p",{className:"text-gray-400 text-sm mb-2",children:"××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×‘×©×œ×‘ ×–×” ×¢×“×™×™×Ÿ."}),e.jsx("button",{onClick:()=>E(j.id),className:"text-blue-600 text-sm hover:underline font-medium",children:"+ ×”×•×¡×£ ×¤×¢×™×œ×•×ª"})]}):j.learningUnits.map(($,V)=>{var se,ne,fe,je,Ne,Pe;if(console.log(`[LPO Render] Unit: ${$.title} (${$.id}) | Status: ${(se=$.metadata)==null?void 0:se.status} | Blocks: ${(ne=$.activityBlocks)==null?void 0:ne.length}`),((fe=$.metadata)==null?void 0:fe.status)==="generating"||((je=$.metadata)==null?void 0:je.status)==="pending"||((Ne=$.activityBlocks)==null?void 0:Ne.length)===0&&$.baseContent==="PENDING_GENERATION")return e.jsxs("div",{className:"p-4 bg-white rounded-xl border border-indigo-100 shadow-sm relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-indigo-50/50 to-transparent w-full animate-shimmer",style:{backgroundSize:"200% 100%"}}),e.jsxs("div",{className:"flex items-center gap-4 relative z-10",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-400",children:e.jsx(Xe,{className:"w-5 h-5 animate-pulse"})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-5 bg-slate-100 rounded-md w-1/3 animate-pulse"}),e.jsx("div",{className:"h-3 bg-slate-50 rounded-md w-1/4 animate-pulse"})]}),e.jsx("div",{className:"px-3 py-1 bg-indigo-50 text-indigo-600 text-xs font-bold rounded-full animate-pulse",children:$.title||"×‘×•× ×” ×™×—×™×“×”..."})]})]},$.id);const Y=l.has($.id);return e.jsxs("div",{className:`flex flex-col rounded-xl border transition-all group/unit
                                                    ${Y?"card-glass border-blue-200 shadow-lg ring-2 ring-blue-50/50":"bg-white/60 border-white/60 backdrop-blur-sm hover:bg-white/80 hover:border-blue-200 shadow-sm"}
                                                `,children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center justify-between p-4 cursor-pointer",onClick:()=>g($.id),children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`
                                                            w-10 h-10 rounded-lg flex items-center justify-center transition-colors
                                                            ${$.type==="test"?"bg-red-100 text-red-600":$.type==="acquisition"?"bg-green-100 text-green-600":Y?"bg-indigo-600 text-white":"bg-blue-100 text-blue-600"}
                                                        `,children:$.type==="test"?e.jsx(Ns,{className:"w-5 h-5"}):e.jsx(Vr,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h3",{className:`font-semibold ${Y?"text-indigo-900":"text-gray-800"}`,children:$.title}),e.jsxs("p",{className:"text-xs text-gray-500 capitalize flex items-center gap-2",children:[e.jsxs("span",{children:[((Pe=$.activityBlocks)==null?void 0:Pe.length)||0," ×¨×›×™×‘×™×"]}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-gray-300"}),e.jsx("span",{children:$.type==="practice"?"×ª×¨×’×•×œ":$.type==="test"?"×ž×‘×—×Ÿ":"×œ×ž×™×“×”"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end print:hidden",children:[e.jsxs("div",{className:"flex items-center gap-1 mx-2",children:[e.jsx("button",{onClick:He=>{He.stopPropagation(),R(j.id,V,"up")},disabled:V===0,className:"p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm",children:e.jsx(Gs,{className:"w-4 h-4"})}),e.jsx("button",{onClick:He=>{He.stopPropagation(),R(j.id,V,"down")},disabled:V===j.learningUnits.length-1,className:"p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded disabled:opacity-30 bg-white/50 border border-white/60 shadow-sm",children:e.jsx(vs,{className:"w-4 h-4"})})]}),e.jsx("button",{onClick:He=>{He.stopPropagation(),G($)},className:"p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors bg-white/50 border border-white/60 shadow-sm",title:"×ª×¦×•×’×ª ×”×§×¨× ×”",children:e.jsx(Ss,{className:"w-[18px] h-[18px]"})}),e.jsx("button",{onClick:He=>{He.stopPropagation(),M(j.id,$.id)},className:"p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors bg-white/50 border border-white/60 shadow-sm",title:"×ž×—×§ ×™×—×™×“×”",children:e.jsx(ct,{className:"w-[18px] h-[18px]"})}),e.jsx("div",{className:`transform transition-transform duration-200 ${Y?"rotate-180":""}`,children:e.jsx(vs,{className:"w-5 h-5 text-gray-400"})})]})]}),Y&&e.jsx("div",{className:"border-t border-blue-100",onClick:He=>He.stopPropagation(),children:e.jsx(ks,{unit:$,courseId:n.id,embedded:!0,onExit:()=>g($.id),onUnitUpdate:a,onUpdateBlock:(He,Ut)=>x($,He,Ut)})})]},$.id)})}),e.jsx("div",{className:"mt-4 pt-4 border-t border-blue-50 flex justify-center print:hidden",children:e.jsxs("button",{onClick:()=>E(j.id),className:"flex items-center gap-2 text-sm text-blue-500 hover:text-blue-600 transition-colors px-4 py-1.5 rounded-full hover:bg-blue-50 bg-white/50 border border-white/60 shadow-sm",children:[e.jsx(_s,{className:"w-3.5 h-3.5"})," ×”×•×¡×£ ×¤×¢×™×œ×•×ª ×œ×©×œ×‘"]})})]})]},j.id)),e.jsx("div",{className:"pr-4 md:pr-14 print:hidden",children:e.jsxs("button",{onClick:T,className:"w-full py-4 border-2 border-dashed border-blue-200 rounded-2xl text-blue-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50/50 backdrop-blur-sm bg-white/40 transition-all flex items-center justify-center gap-2 group",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-50 group-hover:bg-blue-100 flex items-center justify-center transition-colors shadow-sm",children:e.jsx(_s,{className:"w-[18px] h-[18px]"})}),e.jsx("span",{className:"font-semibold",children:"×”×•×¡×£ ×©×œ×‘ ×—×“×©"})]})})]}),e.jsx("div",{className:"h-20"})," ",e.jsx(Ca,{isOpen:U!==null,onClose:()=>J(null),courseId:n.id,courseTitle:n.title,unitId:U==null?void 0:U.unitId,unitTitle:U==null?void 0:U.unitTitle,initialTab:U==null?void 0:U.initialTab}),v&&e.jsx(ks,{unit:v,courseId:n.id,embedded:!1,onExit:()=>B(null),onUnitUpdate:j=>{a&&a(j),B(j)}})]})};ra.workerSrc=new URL("/assets/pdf.worker.min-yatZIOMy.mjs",import.meta.url).toString();const Ni=n=>new Promise((s,r)=>{const a=new FileReader;a.readAsDataURL(n),a.onload=()=>{const p=a.result.split(",")[1];s({base64:p,mimeType:n.type})},a.onerror=d=>r(d)}),Ci=async n=>{const s=await n.arrayBuffer(),r=await ea({data:s}).promise;let a="";const d=Math.min(r.numPages,5);for(let p=1;p<=d;p++){const v=(await(await r.getPage(p)).getTextContent()).items.map(B=>B.str).join(" ");a+=`--- Page ${p} ---
${v}

`}return a},Si=n=>{const s=`
        <style>
            @keyframes shimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }
            @keyframes pulse-glow {
                0%, 100% { box-shadow: 0 0 8px rgba(99, 102, 241, 0.4); }
                50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.7); }
            }
            @keyframes float {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-3px); }
            }
            @keyframes progress-flow {
                0% { background-position: 0% 50%; }
                100% { background-position: 200% 50%; }
            }
            .skeleton-loading {
                background: linear-gradient(90deg, #e5e7eb 25%, #d1d5db 50%, #e5e7eb 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s ease-in-out infinite;
                border-radius: 8px;
            }
            .skeleton-line {
                height: 14px;
                margin: 10px 0;
            }
            .skeleton-paragraph {
                height: 50px;
            }
            .building-container {
                background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);
                border: 2px solid #c7d2fe;
                border-radius: 16px;
                padding: 20px;
                margin: 12px 0;
                position: relative;
                overflow: hidden;
            }
            .building-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #818cf8, #6366f1, #4f46e5, #6366f1, #818cf8);
                background-size: 200% 100%;
                animation: progress-flow 2s linear infinite;
            }
            .building-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
            }
            .building-icon {
                width: 48px;
                height: 48px;
                background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: float 2s ease-in-out infinite;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }
            .building-icon svg {
                width: 24px;
                height: 24px;
                color: white;
            }
            .building-text {
                flex: 1;
            }
            .building-title {
                font-size: 18px;
                font-weight: 700;
                color: #3730a3;
                margin: 0 0 4px 0;
            }
            .building-subtitle {
                font-size: 14px;
                color: #6366f1;
                margin: 0;
            }
            .building-badge {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                background: white;
                border: 2px solid #a5b4fc;
                border-radius: 24px;
                padding: 8px 16px;
                font-size: 14px;
                font-weight: 600;
                color: #4f46e5;
                animation: pulse-glow 2s ease-in-out infinite;
            }
            .building-badge .spinner {
                width: 16px;
                height: 16px;
                border: 3px solid #c7d2fe;
                border-top-color: #4f46e5;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            .section-preview {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-top: 12px;
            }
            .preview-chip {
                background: white;
                border: 1px solid #e0e7ff;
                border-radius: 8px;
                padding: 6px 12px;
                font-size: 12px;
                color: #6b7280;
            }
        </style>
    `,a=`
        <div class="building-container">
            ${s}
            <div class="building-header">
                <div class="building-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg></div>
                <div class="building-text">
                    <h3 class="building-title">âœ¨ ×‘×•× ×” ××ª ×ž×¢×¨×š ×”×©×™×¢×•×¨ ×©×œ×š</h3>
                    <p class="building-subtitle">×”×‘×™× ×” ×”×ž×œ××›×•×ª×™×ª ×™×•×¦×¨×ª ×ª×•×›×Ÿ ×ž×•×ª×× ××™×©×™×ª</p>
                </div>
                <div class="building-badge">
                    <div class="spinner"></div>
                    ×¢×•×‘×“ ×¢×œ ×–×”...
                </div>
            </div>
            <div class="section-preview">
                <span class="preview-chip">ðŸª ×¤×ª×™×—×” ×ž×¢× ×™×™× ×ª</span>
                <span class="preview-chip">ðŸŽ“ ×”×•×¨××” ×¤×¨×•× ×˜×œ×™×ª</span>
                <span class="preview-chip">ðŸ§‘â€ðŸ« ×ª×¨×’×•×œ ×ž×•×“×¨×š</span>
                <span class="preview-chip">ðŸ’» ×¤×¢×™×œ×•×™×•×ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª</span>
                <span class="preview-chip">ðŸ’¬ ×“×™×•×Ÿ</span>
                <span class="preview-chip">ðŸ“ ×¡×™×›×•×</span>
            </div>
        </div>
    `,d='<div class="building-badge"><div class="spinner"></div>×‘×‘× ×™×™×”...</div>';return[{id:crypto.randomUUID(),type:"text",content:a,metadata:{time:"5 min",bloomLevel:"remember",isLoading:!0,isMainLoader:!0}},{id:crypto.randomUUID(),type:"text",content:`<div class="lesson-section hook">${s}<h3>ðŸª ×¤×ª×™×—×” (The Hook)</h3>${d}<div class="skeleton-loading skeleton-paragraph"></div><div class="skeleton-loading skeleton-line" style="width: 60%;"></div></div>`,metadata:{time:"5 min",bloomLevel:"remember",isLoading:!0}},{id:crypto.randomUUID(),type:"text",content:`<div class="lesson-section instruction"><h3>ðŸŽ“ ×”×•×¨××” ×¤×¨×•× ×˜×œ×™×ª (Direct Instruction)</h3>${d}<div class="skeleton-loading skeleton-paragraph"></div><div class="skeleton-loading skeleton-line" style="width: 80%;"></div><div class="skeleton-loading skeleton-line" style="width: 65%;"></div></div>`,metadata:{time:"15 min",bloomLevel:"understand",isLoading:!0}},{id:crypto.randomUUID(),type:"text",content:`<div class="lesson-section practice"><h3>ðŸ§‘â€ðŸ« ×ª×¨×’×•×œ ×ž×•×“×¨×š (Guided Practice)</h3>${d}<div class="skeleton-loading skeleton-paragraph"></div></div>`,metadata:{time:"10 min",bloomLevel:"apply",isLoading:!0}},{id:crypto.randomUUID(),type:"text",content:`<div class="lesson-section independent-practice"><h3>ðŸ’» ×ª×¨×’×•×œ ×¢×¦×ž××™ (Independent Practice)</h3>${d}<div class="skeleton-loading skeleton-paragraph"></div></div>`,metadata:{time:"10 min",bloomLevel:"apply",isLoading:!0}},{id:crypto.randomUUID(),type:"text",content:`<div class="lesson-section discussion"><h3>ðŸ’¬ ×“×™×•×Ÿ ×›×™×ª×ª×™ (Discussion)</h3>${d}<div class="skeleton-loading skeleton-line" style="width: 85%;"></div><div class="skeleton-loading skeleton-line" style="width: 75%;"></div></div>`,metadata:{time:"5 min",bloomLevel:"evaluate",isLoading:!0}},{id:crypto.randomUUID(),type:"text",content:`<div class="lesson-section summary"><h3>ðŸ“ ×¡×™×›×•× (Summary)</h3>${d}<div class="skeleton-loading skeleton-line" style="width: 70%;"></div><div class="skeleton-loading" style="height: 120px; margin-top: 12px;"></div></div>`,metadata:{time:"5 min",bloomLevel:"remember",isLoading:!0}}]},_i=({unit:n,onClose:s})=>(S.useEffect(()=>(document.body.style.overflow="hidden",()=>{document.body.style.overflow="unset"}),[]),e.jsxs("div",{className:"fixed inset-0 z-[100] bg-gray-50 h-screen w-full flex flex-col animate-fade-in",dir:"rtl",children:[e.jsx("style",{children:`
                .preview-scroll::-webkit-scrollbar {
                    width: 16px;
                    display: block; /* Force display */
                }
                .preview-scroll::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-left: 1px solid #e5e7eb;
                }
                .preview-scroll::-webkit-scrollbar-thumb {
                    background-color: #9ca3af;
                    border-radius: 4px;
                    border: 3px solid #f1f1f1;
                }
                .preview-scroll::-webkit-scrollbar-thumb:hover {
                    background-color: #6b7280;
                }
            `}),e.jsxs("div",{className:"relative flex-none h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shadow-sm z-[200]",children:[e.jsxs("h3",{className:"text-gray-900 font-bold text-lg flex items-center gap-2",children:[e.jsx(Ss,{className:"w-5 h-5 text-indigo-600"}),"×ª×¦×•×’×” ×ž×§×“×™×ž×”: ",n.title]}),e.jsx("button",{onClick:s,className:"flex items-center justify-center w-10 h-10 bg-gray-900 hover:bg-black text-white rounded-full transition-transform hover:scale-110 shadow-lg",title:"×¡×’×•×¨ ×ª×¦×•×’×”",children:e.jsx("span",{className:"font-bold text-lg",children:"X"})})]}),e.jsx("div",{className:"flex-1 w-full overflow-y-scroll preview-scroll bg-gray-50 relative",children:e.jsxs("div",{className:"w-full max-w-5xl mx-auto pb-32 pt-8 px-4 min-h-full",children:[e.jsx(ya,{reviewMode:!0,studentData:{studentName:"×ª×¦×•×’×” ×ž×§×“×™×ž×”",answers:{}},onExitReview:s,forcedUnitId:n.id,unitOverride:n,hideReviewHeader:!0}),e.jsx("div",{className:"h-20 w-full"})]})})]})),Ri=({onBack:n})=>{var Y,se,ne,fe,je,Ne,Pe,He,Ut,ns,rs,kt,as,qt;const s=qn(),{course:r,setCourse:a}=zn(),[d,p]=S.useState(null),[l,c]=S.useState(null),[v,B]=S.useState(!1),[g,x]=S.useState(!1),{state:T,startDifferentiatedStreaming:h,startPodcastStreaming:_,startActivityStreaming:E,cancelStreaming:M}=yi(),[R,U]=S.useState(""),J=S.useRef(!1),X=S.useRef(!1);S.useEffect(()=>{var Je,ue,ee,oe,ae,q,K;if(J.current||g||!r||r.id==="loading")return;const N=r.syllabus&&r.syllabus.length>0,de=((ue=(Je=r.wizardData)==null?void 0:Je.settings)==null?void 0:ue.productType)==="lesson"||r.mode==="lesson",ve=((oe=(ee=r.wizardData)==null?void 0:ee.settings)==null?void 0:oe.isDifferentiated)===!0,ye=(K=(q=(ae=r.syllabus)==null?void 0:ae[0])==null?void 0:q.learningUnits)==null?void 0:K[0],We=N&&ye&&(!ye.activityBlocks||ye.activityBlocks.length===0);if(We&&r.wizardData&&de){F(r.wizardData);return}if(We&&r.wizardData&&ve){console.log("ðŸ§¬ Detected Fresh Shell with Differentiated Mode. Triggering 3-Level Generation..."),F(r.wizardData);return}N&&!X.current?ye&&!d&&!de&&!ve&&(p(ye.id),X.current=!0):N||!v&&!g&&B(!0)},[r,v,g,d]);const k=async(N,de,ve)=>{var ye,We,Je,ue,ee,oe;if(N==="unit"){const ae=r.syllabus.flatMap(K=>K.learningUnits).find(K=>K.id===de);if(!ae)return;if(Kt())try{console.log("ðŸŒŠ Manual regeneration using V5 streaming..."),await G(ae,r.fullBookContent||"",r.gradeLevel||"General",r.activityLength||"medium",((We=(ye=r.wizardData)==null?void 0:ye.settings)==null?void 0:We.productType)||"activity",(ue=(Je=r.wizardData)==null?void 0:Je.settings)==null?void 0:ue.questionPreferences);return}catch(K){console.warn("ðŸŒŠ Streaming failed, falling back to legacy:",K)}console.log("ðŸ“œ Manual regeneration using legacy flow..."),a(K=>{const _e=K.syllabus.map(st=>({...st,learningUnits:st.learningUnits.map(ie=>ie.id===de?{...ie,metadata:{...ie.metadata,status:"generating"}}:ie)}));return{...K,syllabus:_e}});try{const K=await bs(ae.title,r.gradeLevel||"General",r.activityLength||"medium",r.fullBookContent,r.mode==="lesson"?"learning":r.mode,void 0,(oe=(ee=r.wizardData)==null?void 0:ee.settings)==null?void 0:oe.productType);if(K&&K.steps){const _e=K.steps.length,st=K.steps.map(async Ge=>{const Be=await ws(ae.title,Ge,r.gradeLevel||"General",r.fullBookContent,void 0,"learning",void 0,_e);return It(Be)});let Ee=(await Promise.all(st)).filter(Ge=>Ge!==null);Ee.length===0&&(Ee=[{id:crypto.randomUUID(),type:"text",content:`âš ï¸ **×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª×•×›×Ÿ**

×”×ž×¢×¨×›×ª ×œ× ×”×¦×œ×™×—×” ×œ×™×™×¦×¨ ×ª×•×›×Ÿ ×¢×‘×•×¨ ×™×—×™×“×” ×–×•. ×™×™×ª×›×Ÿ ×©×™×©× ×” ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ-AI ××• ×©×”×ª×•×›×Ÿ ×”×ž×§×•×¨×™ ×œ× ×”×¡×¤×™×§.

×× × × ×¡×• ×œ×œ×—×•×¥ ×©×•×‘ ×¢×œ ×›×¤×ª×•×¨ '×¢×¨×™×›×” ×¢× AI' ××• ×”×•×¡×™×¤×• ×ª×•×›×Ÿ ×™×“× ×™×ª.`,metadata:{score:0,bloomLevel:"evaluation"}}]),a(Ge=>{const Be=Ge.syllabus.map(ft=>({...ft,learningUnits:ft.learningUnits.map(O=>O.id===de?{...O,activityBlocks:Ee,metadata:{...O.metadata,status:"ready"}}:O)})),le={...Ge,syllabus:Be};return Qt(le),le})}}catch(K){console.error("Manual Gen Error",K),alert("Generation failed"),a(_e=>{const st=_e.syllabus.map(ie=>({...ie,learningUnits:ie.learningUnits.map(Ee=>Ee.id===de?{...Ee,metadata:{...Ee.metadata,status:"error"}}:Ee)}));return{..._e,syllabus:st}})}}},G=async(N,de,ve,ye,We,Je)=>{console.log("ðŸŒŠ V5 Streaming: Starting parallel activity generation..."),a(ue=>{if(!ue)return ue;const ee=ue.syllabus.map(oe=>({...oe,learningUnits:oe.learningUnits.map(ae=>ae.id===N.id?{...ae,metadata:{...ae.metadata,status:"generating"}}:ae)}));return{...ue,syllabus:ee}});try{const ee=(await E({topic:N.title,gradeLevel:ve,subject:(r==null?void 0:r.subject)||"×›×œ×œ×™",sourceText:de||void 0,activityLength:ye,productType:We==="exam"?"exam":"activity",questionPreferences:Je},(oe,ae,q)=>{console.log(`ðŸŒŠ Step ${ae}/${q} complete`)},oe=>{var ae;console.log(`ðŸŒŠ Skeleton complete: ${((ae=oe.steps)==null?void 0:ae.length)||0} steps`)})).steps.map(oe=>It(oe)).filter(oe=>oe!==null);return ee.length===0&&ee.push({id:crypto.randomUUID(),type:"text",content:`âš ï¸ **×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª×•×›×Ÿ**

×”×ž×¢×¨×›×ª ×œ× ×”×¦×œ×™×—×” ×œ×™×™×¦×¨ ×ª×•×›×Ÿ. ×× × × ×¡×• ×©×•×‘.`,metadata:{score:0,bloomLevel:"evaluation"}}),a(oe=>{if(!oe)return oe;const ae=oe.syllabus.map(K=>({...K,learningUnits:K.learningUnits.map(_e=>_e.id===N.id?{..._e,activityBlocks:ee,metadata:{..._e.metadata,status:"ready"}}:_e)})),q={...oe,syllabus:ae};return Qt(q),q}),console.log(`ðŸŒŠ V5 Streaming: Activity generation complete (${ee.length} blocks)`),ee}catch(ue){throw console.error("ðŸŒŠ V5 Streaming failed:",ue),a(ee=>{if(!ee)return ee;const oe=ee.syllabus.map(ae=>({...ae,learningUnits:ae.learningUnits.map(q=>q.id===N.id?{...q,metadata:{...q.metadata,status:"error"}}:q)}));return{...ee,syllabus:oe}}),ue}};if(!r)return e.jsx("div",{className:"flex items-center justify-center h-screen text-gray-500",children:"× × ×œ×‘×—×•×¨ ×©×™×¢×•×¨..."});const f=R||r.gradeLevel||r.targetAudience||"×›×œ×œ×™",I=async(N,de,ve,ye,We,Je,ue)=>{var oe,ae,q,K,_e,st;const ee=N.flatMap(ie=>ie.learningUnits).filter(ie=>!ie.activityBlocks||ie.activityBlocks.length===0);for(const ie of ee){a(Ee=>{if(!Ee)return Ee;const Ge=Ee.syllabus.map(Be=>({...Be,learningUnits:Be.learningUnits.map(le=>le.id===ie.id?{...le,metadata:{...le.metadata,status:"generating"}}:le)}));return{...Ee,syllabus:Ge}});try{if(We==="lesson"||ue==="lesson"){let Be="TOPIC_ONLY";const le=r==null?void 0:r.wizardData;le?le.mediaType==="youtube"||le.pastedText&&le.pastedText.includes("TRANSCRIPT:")?Be="YOUTUBE":(le.pastedText&&le.pastedText.length>100||de&&de.length>100)&&(Be="TEXT_FILE"):de&&de.length>100&&(Be="TEXT_FILE"),console.log("ðŸš€ Progressive Loading: Creating skeleton blocks...");const ft=Si(ie.title);a(be=>{if(!be)return be;const ke=be.syllabus.map(Le=>({...Le,learningUnits:Le.learningUnits.map(b=>b.id===ie.id?{...b,activityBlocks:ft,metadata:{...b.metadata,status:"loading-content"}}:b)}));return{...be,syllabus:ke}});let O=null,Te=!0;const dt=be=>{var b;const ke={id:crypto.randomUUID(),type:"text",content:`
                                <div class="lesson-section hook">
                                    <h3>ðŸª ×¤×ª×™×—×” (The Hook)</h3>
                                    ${(b=be.lesson_metadata)!=null&&b.learning_objectives?`
                                        <div class="learning-objectives">
                                            <strong>ðŸŽ¯ ×ž×˜×¨×•×ª ×”×œ×ž×™×“×”:</strong>
                                            <ul>${be.lesson_metadata.learning_objectives.map(he=>`<li>${he}</li>`).join("")}</ul>
                                        </div>
                                    `:""}
                                    <p class="teacher-script">${be.hook.script_for_teacher}</p>
                                    ${be.hook.classroom_management_tip?`<div class="management-tip">ðŸ’¡ ${be.hook.classroom_management_tip}</div>`:""}
                                    <div class="visual-placeholder">ðŸŽ¨ ×™×•×¦×¨ ×ª×ž×•× ×”...</div>
                                </div>
                            `,metadata:{time:"5 min",bloomLevel:"remember"}},Le=be.direct_instruction.slides.map(he=>({id:crypto.randomUUID(),type:"text",content:`
                                <div class="lesson-section instruction">
                                    <h3>ðŸŽ“ ×”×•×¨××” ×¤×¨×•× ×˜×œ×™×ª: ${he.slide_title}</h3>
                                    <div class="board-points">
                                        <strong>ðŸ“ ×¢×œ ×”×œ×•×—:</strong>
                                        <ul>${he.bullet_points_for_board.map(w=>`<li>${w}</li>`).join("")}</ul>
                                    </div>
                                    <p class="teacher-script"><strong>ðŸ—£ï¸ ×œ×ž×•×¨×”:</strong> ${he.script_to_say}</p>
                                    ${he.differentiation_note?`<div class="diff-note">ðŸ’¡ ${he.differentiation_note}</div>`:""}
                                </div>
                            `,metadata:{time:he.timing_estimate||"5 min",bloomLevel:"understand"}}));return[ke,...Le]};if(Te)try{console.log("ðŸš€ Trying parallel generation..."),O=await ta(ie.title,de,ve,Be,be=>{if(!be)return;console.log("âš¡ Part1 ready! Updating UI immediately...");const ke=dt(be);a(Le=>{if(!Le)return Le;const b=Le.syllabus.map(he=>({...he,learningUnits:he.learningUnits.map(w=>w.id===ie.id?{...w,activityBlocks:[...ke,{id:crypto.randomUUID(),type:"text",content:'<div class="lesson-section practice"><h3>ðŸ§‘â€ðŸ« ×ª×¨×’×•×œ ×ž×•×“×¨×š (Guided Practice)</h3><div class="building-badge"><div class="spinner"></div>×‘×‘× ×™×™×”...</div></div>',metadata:{time:"10 min",bloomLevel:"apply",isLoading:!0}},{id:crypto.randomUUID(),type:"text",content:'<div class="lesson-section independent-practice"><h3>ðŸ’» ×ª×¨×’×•×œ ×¢×¦×ž××™</h3><div class="building-badge"><div class="spinner"></div>×‘×‘× ×™×™×”...</div></div>',metadata:{time:"10 min",bloomLevel:"apply",isLoading:!0}},{id:crypto.randomUUID(),type:"text",content:'<div class="lesson-section summary"><h3>ðŸ“ ×¡×™×›×•×</h3><div class="building-badge"><div class="spinner"></div>×‘×‘× ×™×™×”...</div></div>',metadata:{time:"5 min",bloomLevel:"remember",isLoading:!0}}],metadata:{...w.metadata,status:"loading-part2"}}:w)}));return{...Le,syllabus:b}})})}catch(be){console.warn("âš ï¸ Parallel generation failed, falling back to sequential:",be),O=null}if(O||(console.log("ðŸ”„ Using sequential generation (fallback)..."),O=await sa(ie.title,de,ve,Be,le==null?void 0:le.fileData)),O){const be=na(O).then(async b=>{console.log("âœ… Visual assets generation completed (background)"),a(he=>{if(!(he!=null&&he.syllabus))return he;const w=he.syllabus.map(Ke=>Ke!=null&&Ke.learningUnits?{...Ke,learningUnits:Ke.learningUnits.map(Ye=>{var Bt;if(!Ye||Ye.id!==ie.id||!((Bt=Ye.activityBlocks)!=null&&Bt.length))return Ye;const Mt=Ye.activityBlocks.filter(Se=>Se!==null).map(Se=>{var yt,Pt,Ae,ht,St;if((Se==null?void 0:Se.type)==="text"&&((yt=Se==null?void 0:Se.content)!=null&&yt.includes("lesson-section hook"))){const me=(Ae=(Pt=b.hook)==null?void 0:Pt.media_asset)==null?void 0:Ae.url;if(me){let Ce=Se.content.replace(/<div class="media-badge">ðŸ“º[^<]*<\/div>/,`<div class="generated-visual"><img src="${me}" alt="Hook Visual" style="max-width: 100%; border-radius: 8px; margin-top: 1rem;" /></div>`);return Ce=Ce.replace('<div class="visual-placeholder">ðŸŽ¨ ×™×•×¦×¨ ×ª×ž×•× ×”...</div>',`<div class="generated-visual"><img src="${me}" alt="Hook Visual" style="max-width: 100%; border-radius: 8px; margin-top: 1rem;" /></div>`),{...Se,content:Ce}}}if((Se==null?void 0:Se.type)==="text"&&((ht=Se==null?void 0:Se.content)!=null&&ht.includes("lesson-section summary"))){const me=(St=b.summary.visual_summary)==null?void 0:St.url;if(me){const Ce=Se.content.replace('<div class="visual-placeholder">ðŸŽ¨ ×™×•×¦×¨ ××™× ×¤×•×’×¨×¤×™×§×”...</div>',`<div class="generated-visual"><img src="${me}" alt="Summary Visual" style="max-width: 100%; border-radius: 8px; margin-top: 1rem;" /></div>`);return{...Se,content:Ce}}}return Se});return{...Ye,activityBlocks:Mt}})}:Ke);return{...he,syllabus:w}})}).catch(b=>console.error("Background visual generation error:",b));console.log("ðŸŽ¨ Visual generation started in background (not blocking content display)");let ke=[];(oe=O.independent_practice)!=null&&oe.interactive_blocks&&O.independent_practice.interactive_blocks.length>0&&(console.log("ðŸŽ® Processing independent practice interactive blocks..."),ke=O.independent_practice.interactive_blocks.map(b=>It({type:b.type,selected_interaction:b.type,...b.data})).filter(b=>b!=null),console.log(`âœ… Processed ${ke.length} independent practice blocks`));const Le=[{id:crypto.randomUUID(),type:"text",content:`
                                    <div class="lesson-section hook">
                                        <h3>ðŸª ×¤×ª×™×—×” (The Hook)</h3>
                                        ${O.lesson_metadata.learning_objectives?`
                                            <div class="learning-objectives">
                                                <strong>ðŸŽ¯ ×ž×˜×¨×•×ª ×”×œ×ž×™×“×”:</strong>
                                                <ul>${O.lesson_metadata.learning_objectives.map(b=>`<li>${b}</li>`).join("")}</ul>
                                            </div>
                                        `:""}
                                        <p class="teacher-script">${O.hook.script_for_teacher}</p>
                                        ${O.hook.classroom_management_tip?`<div class="management-tip">ðŸ’¡ ${O.hook.classroom_management_tip}</div>`:""}
                                        ${(ae=O.hook.media_asset)!=null&&ae.url?`
                                            <div class="generated-visual">
                                                <img src="${O.hook.media_asset.url}" alt="Hook Visual" style="max-width: 100%; border-radius: 8px; margin-top: 1rem;" />
                                            </div>
                                        `:O.hook.media_asset?'<div class="visual-placeholder">ðŸŽ¨ ×™×•×¦×¨ ×ª×ž×•× ×”...</div>':""}
                                    </div>
                                `,metadata:{time:"5 min",bloomLevel:"remember"}},...O.direct_instruction.slides.map((b,he)=>{var w;return{id:crypto.randomUUID(),type:"text",content:`
                                    <div class="lesson-section instruction">
                                        <h3>ðŸŽ“ ×”×•×¨××” ×¤×¨×•× ×˜×œ×™×ª: ${b.slide_title}</h3>
                                        <div class="board-points">
                                            <strong>ðŸ“ ×¢×œ ×”×œ×•×—:</strong>
                                            <ul>${b.bullet_points_for_board.map(Ke=>`<li>${Ke}</li>`).join("")}</ul>
                                        </div>
                                        <p class="teacher-script"><strong>ðŸ—£ï¸ ×œ×ž×•×¨×”:</strong> ${b.script_to_say}</p>
                                        ${b.differentiation_note?`<div class="diff-note">ðŸ’¡ ${b.differentiation_note}</div>`:""}
                                        ${(w=b.media_asset)!=null&&w.url?`
                                            <div class="generated-visual">
                                                <img src="${b.media_asset.url}" alt="${b.slide_title}" style="max-width: 100%; border-radius: 8px; margin-top: 1rem;" />
                                            </div>
                                        `:b.media_asset?`<div class="media-badge">ðŸ“º ${b.media_asset.content}</div>`:""}
                                    </div>
                                `,metadata:{time:b.timing_estimate||"5 min",bloomLevel:"understand"}}}),{id:crypto.randomUUID(),type:"text",content:`
                                    <div class="lesson-section practice">
                                        <h3>ðŸ§‘â€ðŸ« ×ª×¨×’×•×œ ×ž×•×“×¨×š (Guided Practice - In-Class)</h3>
                                        <p><strong>ðŸŽ¯ ×”× ×—×™×” ×œ×”× ×—×™×™×ª ×”×ª×¨×’×•×œ:</strong> ${O.guided_practice.teacher_facilitation_script}</p>

                                        ${O.guided_practice.example_questions&&O.guided_practice.example_questions.length>0?`
                                            <div class="example-questions" style="margin: 15px 0; background: #EFF6FF; padding: 15px; border-radius: 8px; border-right: 4px solid #2B59C3;">
                                                <strong style="color: #2B59C3; font-size: 16px;">â“ ×©××œ×•×ª ×œ×”×§×¨××” ×‘×›×™×ª×”:</strong>
                                                ${O.guided_practice.example_questions.map((b,he)=>`
                                                    <div style="margin: 12px 0; padding: 12px; background: white; border-radius: 5px;">
                                                        <p style="margin: 0; font-weight: bold; color: #1E40AF;">×©××œ×” ${he+1}: ${b.question_text}</p>
                                                        <p style="margin: 8px 0 5px 0; color: #166534;">âœ“ <strong>×ª×©×•×‘×” ×¦×¤×•×™×”:</strong> ${b.expected_answer}</p>
                                                        ${b.common_mistakes&&b.common_mistakes.length>0?`<p style="margin: 5px 0; color: #DC2626;">âš ï¸ <strong>×˜×¢×•×™×•×ª × ×¤×•×¦×•×ª:</strong> ${b.common_mistakes.join(" | ")}</p>`:""}
                                                        ${b.follow_up_prompt?`<p style="margin: 5px 0; color: #7C3AED;">ðŸ”„ <strong>×©××œ×ª ×”×ž×©×š:</strong> ${b.follow_up_prompt}</p>`:""}
                                                    </div>
                                                `).join("")}
                                            </div>
                                        `:""}

                                        ${O.guided_practice.worked_example?`
                                            <div class="worked-example" style="margin: 15px 0; background: #FEF3C7; padding: 15px; border-radius: 8px; border: 2px solid #F59E0B;">
                                                <strong style="color: #B45309; font-size: 16px;">ðŸ“ ×“×•×’×ž×” ×ž×¢×©×™×ª (×œ×¤×ª×¨×•×Ÿ ×¢×œ ×”×œ×•×—):</strong>
                                                <p style="margin: 10px 0; font-weight: bold;">${O.guided_practice.worked_example.problem}</p>
                                                <div style="background: white; padding: 12px; border-radius: 5px; margin: 10px 0;">
                                                    <strong>×©×œ×‘×™ ×”×¤×ª×¨×•×Ÿ:</strong>
                                                    <ol style="margin: 8px 0;">${O.guided_practice.worked_example.solution_steps.map(b=>`<li style="margin: 5px 0;">${b}</li>`).join("")}</ol>
                                                </div>
                                                ${O.guided_practice.worked_example.key_points&&O.guided_practice.worked_example.key_points.length>0?`
                                                    <div style="margin-top: 10px;">
                                                        <strong style="color: #B45309;">ðŸ’¡ × ×§×•×“×•×ª ×œ×”×“×’×©×”:</strong>
                                                        <ul style="margin: 5px 0;">${O.guided_practice.worked_example.key_points.map(b=>`<li>${b}</li>`).join("")}</ul>
                                                    </div>
                                                `:""}
                                            </div>
                                        `:""}

                                        ${O.guided_practice.differentiation_strategies?`
                                            <div class="differentiation">
                                                <strong>ðŸŽ¯ ×“×™×¤×¨× ×¦×™××¦×™×”:</strong>
                                                <p>ðŸ‘¥ <strong>×ª×œ×ž×™×“×™× ×ž×ª×§×©×™×:</strong> ${O.guided_practice.differentiation_strategies.for_struggling_students}</p>
                                                <p>ðŸš€ <strong>×ª×œ×ž×™×“×™× ×ž×ª×§×“×ž×™×:</strong> ${O.guided_practice.differentiation_strategies.for_advanced_students}</p>
                                            </div>
                                        `:""}
                                        ${O.guided_practice.assessment_tips&&O.guided_practice.assessment_tips.length>0?`
                                            <div class="assessment-tips">
                                                <strong>ðŸ“Š ×¢×œ ×ž×” ×œ×©×™× ×œ×‘ ×‘×ž×”×œ×š ×”×ª×¨×’×•×œ:</strong>
                                                <ul>${O.guided_practice.assessment_tips.map(b=>`<li>${b}</li>`).join("")}</ul>
                                            </div>
                                        `:""}
                                    </div>
                                `,metadata:{time:"10 min",bloomLevel:"apply"}},{id:crypto.randomUUID(),type:"text",content:`
                                    <div class="lesson-section independent-practice">
                                        <h3>ðŸ’» ×ª×¨×’×•×œ ×¢×¦×ž××™ (Independent Practice)</h3>
                                        <p><strong>ðŸ“ ×”× ×—×™×•×ª:</strong> ${((q=O.independent_practice)==null?void 0:q.introduction_text)||"×‘×¦×¢×• ××ª ×”×¤×¢×™×œ×•×™×•×ª ×”××™× ×˜×¨××§×˜×™×‘×™×•×ª ×”×‘××•×ª"}</p>
                                        ${(K=O.independent_practice)!=null&&K.estimated_duration?`<div class="duration-badge">â±ï¸ ×ž×©×š ×ž×©×•×¢×¨: ${O.independent_practice.estimated_duration}</div>`:""}
                                    </div>
                                `,metadata:{time:"10 min",bloomLevel:"apply"}},...ke,{id:crypto.randomUUID(),type:"text",content:`
                                    <div class="lesson-section discussion">
                                        <h3>ðŸ’¬ ×“×™×•×Ÿ ×›×™×ª×ª×™ (Discussion)</h3>
                                        <div class="discussion-questions">
                                            <ul>${O.discussion.questions.map(b=>typeof b=="string"?`<li>â“ ${b}</li>`:typeof b=="object"&&b!==null?`<li>â“ ${b.question||b.text||b.question_text||JSON.stringify(b)}</li>`:"").join("")}</ul>
                                        </div>
                                        ${O.discussion.facilitation_tips?`
                                            <div class="facilitation-tips">
                                                <strong>ðŸŽ¯ ×˜×™×¤×™× ×œ×”× ×—×™×”:</strong>
                                                <ul>${O.discussion.facilitation_tips.map(b=>`<li>${typeof b=="string"?b:(b==null?void 0:b.text)||(b==null?void 0:b.tip)||""}</li>`).join("")}</ul>
                                            </div>
                                        `:""}
                                    </div>
                                `,metadata:{time:"5 min",bloomLevel:"evaluate"}},{id:crypto.randomUUID(),type:"text",content:`
                                    <div class="lesson-section summary">
                                        <h3>ðŸ“ ×¡×™×›×•× (Summary)</h3>
                                        <p class="takeaway"><strong>ðŸ’¡ ×ž×©×¤×˜ ×¡×™×›×•× ×œ×ž×—×‘×¨×ª:</strong> "${O.summary.takeaway_sentence}"</p>
                                        <div class="visual-placeholder">ðŸŽ¨ ×™×•×¦×¨ ××™× ×¤×•×’×¨×¤×™×§×”...</div>
                                        ${O.summary.homework_suggestion?`
                                            <div class="homework">
                                                <strong>ðŸ“š ×”×¦×¢×” ×œ×©×™×¢×•×¨×™ ×‘×™×ª:</strong> ${O.summary.homework_suggestion}
                                            </div>
                                        `:""}
                                    </div>
                                `,metadata:{time:"5 min",bloomLevel:"remember"}}];a(b=>{if(!b)return b;const he=b.syllabus.map(Ke=>({...Ke,learningUnits:Ke.learningUnits.map(Ye=>Ye.id===ie.id?{...Ye,activityBlocks:Le,metadata:{...Ye.metadata,status:"ready"}}:Ye)})),w={...b,syllabus:he};return Qt(w),w});continue}}if(Kt())try{console.log("ðŸŒŠ Using V5 streaming activity generation..."),await G(ie,de,ve,ye,ue||"activity",(st=(_e=r==null?void 0:r.wizardData)==null?void 0:_e.settings)==null?void 0:st.questionPreferences);continue}catch(Be){console.warn("ðŸŒŠ Streaming failed, falling back to sequential:",Be)}console.log("ðŸ“œ Using legacy sequential generation...");const Ge=await bs(ie.title,ve,ye,de,We==="lesson"?"learning":We,Je,ue);if(Ge&&Ge.steps){const Be=Ge.steps.length,le=Ge.steps.map(async Te=>{const dt=await ws(ie.title,Te,ve,de,void 0,"learning",void 0,Be);return It(dt)});let O=(await Promise.all(le)).map((Te,dt)=>Te===null?{id:crypto.randomUUID(),type:"text",content:`âš ï¸ **Debug: Block Generation Failed for Step ${dt+1}**

Check console logs for 'step content' or 'mapping' errors.`,metadata:{score:0,bloomLevel:"evaluation"}}:Te);O.length===0&&(console.warn("Generation yielded 0 blocks. Inserting Error Block."),O=[{id:crypto.randomUUID(),type:"text",content:`âš ï¸ **×ª×§×œ×” ×‘×™×¦×™×¨×”**

×œ× ×”×¦×œ×—× ×• ×œ×™×™×¦×¨ ××ª ×©×œ×‘×™ ×”×©×™×¢×•×¨ ×‘××•×¤×Ÿ ××•×˜×•×ž×˜×™. ×× × × ×¡×• ×œ×™×™×¦×¨ ×©×•×‘ ×™×“× ×™×ª.

(Debug Info: API returned null or empty blocks)`,metadata:{score:0,bloomLevel:"evaluation"}}]),a(Te=>{if(!Te)return Te;let dt=!1;const be=Te.syllabus.map(Le=>({...Le,learningUnits:Le.learningUnits.map(b=>b.id===ie.id?(dt=!0,{...b,activityBlocks:O,metadata:{...b.metadata,status:"ready"}}):b)}));dt||console.error(`âŒ [State Update] Unit ${ie.id} NOT FOUND in current state! IDs mismatch.`);const ke={...Te,syllabus:be};return Qt(ke).catch(Le=>console.error("Auto-save failed",Le)),ke})}else console.warn("Skeleton generation failed for",ie.title)}catch(Ee){console.error("Error building unit",ie.title,Ee)}}},F=async N=>{var de,ve,ye,We,Je,ue,ee,oe,ae,q,K,_e,st,ie,Ee,Ge,Be,le,ft,O,Te,dt,be,ke,Le,b,he,w,Ke,Ye,Mt,Bt,Se,yt,Pt;if(!g){W.startStep("CourseEditor: Initial setup"),J.current=!0,B(!1),x(!0);try{const Ae=(Array.isArray(N.targetAudience)?N.targetAudience[0]:N.targetAudience)||(Array.isArray(N.gradeLevel)?N.gradeLevel[0]:N.gradeLevel)||(Array.isArray(N.grade)?N.grade[0]:N.grade)||((de=N.settings)==null?void 0:de.targetAudience)||((ve=N.settings)==null?void 0:ve.gradeLevel)||((ye=N.settings)==null?void 0:ye.grade)||"×›×œ×œ×™",ht=((We=N.settings)==null?void 0:We.subject)||N.subject||"×›×œ×œ×™";U(Ae),W.endStep(),W.startStep("File/Text processing");let St,me;if(N.file){const pe=N.file;W.checkpoint(`Processing file: ${pe.name}`);try{pe.type==="application/pdf"?(me=await Ci(pe),W.checkpoint("PDF text extracted")):pe.type.startsWith("image/")?(St=await Ni(pe),W.checkpoint("Image converted to base64")):pe.type==="text/plain"?(me=await pe.text(),W.checkpoint("Text file read")):console.warn("Unsupported file type for AI analysis, using metadata solely.")}catch(rt){console.error("File processing failed:",rt),alert("×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥. ×”×ž×¢×¨×›×ª ×ª×ž×©×™×š ×¢×œ ×‘×¡×™×¡ ×”× ×•×©× ×‘×œ×‘×“.")}}else N.pastedText&&(me=N.pastedText,W.checkpoint(`Pasted text: ${N.pastedText.length} chars`));W.endStep();let Ce=N.topic||N.title||r.title;(!Ce||Ce==="×¤×¢×™×œ×•×ª ×˜×§×¡×˜ ×—×•×¤×©×™"||Ce==="× ×•×©× ×›×œ×œ×™")&&me&&me.length>100&&(W.startStep("AI: Extract topic from text"),Ce=await Yr(me),W.endStep()),Ce=Ce||"× ×•×©× ×›×œ×œ×™",W.startStep("Firestore: Save course metadata");const Fe={...r,title:Ce,subject:ht,gradeLevel:Ae,mode:((Je=N.settings)==null?void 0:Je.courseMode)||"learning",activityLength:((ue=N.settings)==null?void 0:ue.activityLength)||"medium",botPersona:((ee=N.settings)==null?void 0:ee.botPersona)||null,showSourceToStudent:((oe=N.settings)==null?void 0:oe.showSourceToStudent)||!1,fullBookContent:me||r.fullBookContent||"",wizardData:N};a(Fe);const Ts=JSON.parse(JSON.stringify({title:Ce,subject:ht,gradeLevel:Ae,mode:Fe.mode,activityLength:Fe.activityLength,botPersona:Fe.botPersona,showSourceToStudent:Fe.showSourceToStudent,fullBookContent:Fe.fullBookContent,wizardData:N}));await Qr(Cs(zt,"courses",r.id),Ts),W.endStep();let nt=[];((ae=N.settings)==null?void 0:ae.productType)==="lesson"?(W.startStep("AI: Generate lesson syllabus"),nt=await Xr(Ce,Ae,((q=N.settings)==null?void 0:q.activityLength)||"medium",ht,me,(K=N.settings)==null?void 0:K.productType),W.endStep(),I(nt,me||Ce,Ae,((_e=N.settings)==null?void 0:_e.activityLength)||"medium","lesson",null,(st=N.settings)==null?void 0:st.productType).catch(pe=>console.error("Queue Error:",pe))):(W.startStep("AI: Generate course plan"),nt=await Kr(Ce,Ae,St,ht,me,((ie=N.settings)==null?void 0:ie.includeBot)!==!1,(Ee=N.settings)==null?void 0:Ee.productType,(Ge=N.settings)==null?void 0:Ge.activityLength,(Be=N.settings)==null?void 0:Be.taxonomy,(le=N.settings)==null?void 0:le.questionPreferences),W.endStep()),W.startStep("Firestore: Save syllabus");const _t={...Fe,syllabus:nt};if(a(_t),await ys(_t),W.endStep(),nt.length>0&&nt[0].learningUnits.length>0){const pe=nt[0].learningUnits[0];if(((ft=N.settings)==null?void 0:ft.productType)==="podcast"){W.startStep("AI: Generate podcast script");const rt=Kt();let Re=null;if(rt)try{Re=await _({topic:Ce,gradeLevel:Ae,sourceText:me||"",activityLength:((O=N.settings)==null?void 0:O.activityLength)||"medium"}),console.log("ðŸŒŠ Podcast streaming completed:",Re)}catch(it){console.error("ðŸŒŠ Podcast streaming failed, falling back:",it),Re=await Sn(me||"",Ce,Ae,((Te=N.settings)==null?void 0:Te.activityLength)||"medium")}else Re=await Sn(me||"",Ce,Ae,((dt=N.settings)==null?void 0:dt.activityLength)||"medium");if(Re){const it={id:crypto.randomUUID(),type:"podcast",content:{title:`×¤×•×“×§××¡×˜: ${Ce}`,script:Re,audioUrl:null},metadata:{bloomLevel:"synthesis",score:100,difficultyLevel:3,generatedBy:"wizdi-wizard-v4"}},Tt=nt.map(bt=>({...bt,learningUnits:bt.learningUnits.map(Qe=>Qe.id===pe.id?{...Qe,activityBlocks:[it]}:Qe)})),vt={..._t,syllabus:Tt};a(vt),await ys(vt),p(pe.id),W.endStep()}else W.endStep(),alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¤×•×“×§××¡×˜. × ×¡×” ×©×•×‘.");W.endSession()}else if((be=N.settings)!=null&&be.isDifferentiated){W.startStep("AI: Generate differentiated content");let rt=null;const Re=((ke=N.settings)==null?void 0:ke.productType)==="exam",it=(Qe,ot)=>{const qe=ot.map(Ve=>It({data:Ve})).filter(Ve=>Ve!==null);return{id:crypto.randomUUID(),title:`${pe.title} (${Qe})`,baseContent:me||"",activityBlocks:qe,type:Re?"test":"practice"}},Tt=crypto.randomUUID(),vt=crypto.randomUUID(),bt=crypto.randomUUID();try{const Qe=[{id:Tt,title:`${pe.title} (×”×‘× ×”)`,baseContent:me||"",activityBlocks:[],type:Re?"test":"practice"},{id:vt,title:`${pe.title} (×™×™×©×•×)`,baseContent:me||"",activityBlocks:[],type:Re?"test":"practice"},{id:bt,title:`${pe.title} (×”×¢×ž×§×”)`,baseContent:me||"",activityBlocks:[],type:Re?"test":"practice"}],ot=nt.map(qe=>({...qe,learningUnits:qe.learningUnits.map(Ve=>Ve.id===pe.id?Qe:Ve).flat()}));a({..._t,syllabus:ot}),p(vt),rt=await h({topic:Ce,gradeLevel:Ae,subject:ht,sourceText:me||r.title,productType:((Le=N.settings)==null?void 0:Le.productType)||"activity",activityLength:((b=N.settings)==null?void 0:b.activityLength)||"medium",questionPreferences:(he=N.settings)==null?void 0:he.questionPreferences}),console.log("ðŸŒŠ Streaming completed:",rt)}catch(Qe){console.error("ðŸ§¬ Differentiated generation failed:",Qe),alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×•×›×Ÿ ×“×™×¤×¨× ×¦×™××œ×™. × ×¡×” ×©×•×‘."),x(!1);return}if(rt){const Qe=it("×”×‘× ×”",rt.support);Qe.id=Tt;const ot=it("×™×™×©×•×",rt.core);ot.id=vt;const qe=it("×”×¢×ž×§×”",rt.enrichment);qe.id=bt;const Ve=nt.map(Dt=>({...Dt,learningUnits:Dt.learningUnits.map(os=>os.id===pe.id?[Qe,ot,qe]:os).flat()})),is={..._t,syllabus:Ve};a(is),await ys(is),p(ot.id),((w=N.settings)==null?void 0:w.productType)==="lesson"&&c(ot),W.endStep()}else W.endStep(),alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×•×›×Ÿ ×“×™×¤×¨× ×¦×™××œ×™.");W.endSession()}else{if(((Ke=N.settings)==null?void 0:Ke.productType)==="lesson"||Fe.mode==="lesson"){p(null),W.startStep("Background: Lesson plan queue"),I(nt,me||Fe.fullBookContent,Ae,Fe.activityLength||"medium",Fe.mode||"learning",(Ye=N.settings)==null?void 0:Ye.taxonomy,(Mt=N.settings)==null?void 0:Mt.productType),W.endStep(),W.endSession();return}if(Kt())try{W.startStep("AI: V5 Streaming activity generation"),console.log("ðŸŒŠ Using V5 streaming for initial activity generation..."),await G(pe,me||Fe.fullBookContent||"",Ae,Fe.activityLength||"medium",((Bt=N.settings)==null?void 0:Bt.productType)||"activity",(Se=N.settings)==null?void 0:Se.questionPreferences),W.endStep(),p(pe.id),W.endSession();return}catch(it){console.warn("ðŸŒŠ Streaming failed, falling back to sequential:",it)}W.startStep("AI: Generate unit skeleton (fallback)"),console.log("ðŸ“œ Using legacy sequential generation...");const Re=await bs(pe.title,Ae,Fe.activityLength||"medium",me||Fe.fullBookContent,Fe.mode||"learning",(yt=N.settings)==null?void 0:yt.taxonomy,(Pt=N.settings)==null?void 0:Pt.productType);if(W.endStep(),Re&&Re.steps){W.startStep(`AI: Generate ${Re.steps.length} steps (parallel)`);const it=Re.steps.length,Tt=Re.steps.map(async qe=>{const Ve=await ws(pe.title,qe,Ae,me||Fe.fullBookContent,St,"learning",void 0,it);return It(Ve)}),vt=await Promise.all(Tt);W.endStep();const bt=vt.filter(qe=>qe!==null);W.startStep("Firestore: Save final content");const Qe=nt.map(qe=>({...qe,learningUnits:qe.learningUnits.map(Ve=>Ve.id===pe.id?{...Ve,activityBlocks:bt}:Ve)})),ot={..._t,syllabus:Qe};a(ot),await ys(ot),W.endStep(),p(pe.id)}else console.error("âŒ Skeleton Generation Failed"),p(pe.id);W.endSession()}}}catch(Ae){console.error("Error generating content:",Ae),W.endSession(),setTimeout(()=>{alert("××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª×•×›×Ÿ. ×™×™×ª×›×Ÿ ×©×™×© ×¢×•×ž×¡ ×¢×œ ×”×©×¨×ª.")},100)}finally{x(!1)}}},j=async N=>{var Je;console.log("[handleSaveUnit] Called with unit:",N.id,N.title),console.log("[handleSaveUnit] isGenerating:",g),console.log("[handleSaveUnit] activityBlocks:",(Je=N.activityBlocks)==null?void 0:Je.length);const de=r.syllabus.map(ue=>({...ue,learningUnits:ue.learningUnits.map(ee=>ee.id===N.id?N:ee)}));let ve=null,ye=!1;if(!g)for(const ue of de){for(const ee of ue.learningUnits){if(ye&&(!ee.activityBlocks||ee.activityBlocks.length===0)){ve=ee;break}ee.id===N.id&&(ye=!0)}if(ve)break}if(ve){const ue=r.subject||"×›×œ×œ×™";aa(ve.title,r.title,f,void 0,ue,void 0,void 0,!0,r.mode||"learning",r.activityLength||"medium",!0).then(ee=>{if(ee.length>0){const oe=de.map(q=>({...q,learningUnits:q.learningUnits.map(K=>K.id===ve.id?{...K,activityBlocks:ee}:K)})),ae=oe.flatMap(q=>q.learningUnits).find(q=>q.id===ve.id);ae&&Tn(r.id,ae).catch(q=>console.error("Background unit save failed",q)),a({...r,syllabus:oe})}})}const We={...r,syllabus:de};a(We);try{await Tn(r.id,N)}catch(ue){console.error("Save error:",ue)}},C=(Y=r.syllabus)==null?void 0:Y.flatMap(N=>N.learningUnits).find(N=>N.id===d),$=(fe=(ne=(se=r.syllabus)==null?void 0:se[0])==null?void 0:ne.learningUnits)==null?void 0:fe[0],V=((Ne=(je=r.wizardData)==null?void 0:je.settings)==null?void 0:Ne.productType)==="lesson"||r.mode==="lesson",Q=C||(V?$:null);return e.jsxs("div",{className:"min-h-screen bg-gray-50 font-sans",children:[v&&!g&&e.jsx(Na,{onComplete:F,onCancel:()=>{var N;B(!1),(N=r==null?void 0:r.syllabus)!=null&&N.length||s("/")},initialTopic:r.title,title:"×”×’×“×¨×•×ª ×¤×¢×™×œ×•×ª",cancelLabel:"×¡×’×•×¨",cancelIcon:e.jsx(Ct,{className:"w-6 h-6"})}),T.isStreaming&&e.jsx("div",{className:"fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 z-50",children:e.jsx(wi,{state:T,onCancel:M,showStreamedText:!1})}),l&&e.jsx(_i,{unit:l,onClose:()=>c(null)}),Q?((He=(Pe=r.wizardData)==null?void 0:Pe.settings)==null?void 0:He.productType)==="lesson"||r.mode==="lesson"?e.jsx(ks,{unit:Q,courseId:r.id,onExit:()=>{n?n():window.location.href="/"},onUnitUpdate:j,onUpdateBlock:async(N,de)=>{const ve={...Q,activityBlocks:Q.activityBlocks.map(ye=>ye.id===N?{...ye,content:de}:ye)};j(ve)}}):e.jsx(fi,{unit:Q,gradeLevel:f,subject:r.subject,onSave:j,onCancel:()=>{s("/")},onPreview:N=>c(N||Q),cancelLabel:"×”×’×“×¨×•×ª"}):((ns=(Ut=r.wizardData)==null?void 0:Ut.settings)==null?void 0:ns.productType)==="lesson"||r.mode==="lesson"?e.jsx(ji,{course:r,onUpdateCourse:N=>{a(N),Qt(N).catch(console.error)},onSelectUnit:N=>p(N),onUnitUpdate:N=>j(N),onGenerateWithAI:k,onBack:n}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-screen bg-gray-50 text-center px-4",children:[e.jsx(Gn,{size:"xl",color:"primary",className:"mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium text-lg mb-3",children:"×˜×•×¢×Ÿ ××ª ×”×¤×¢×™×œ×•×ª..."}),e.jsx("div",{className:"min-h-[1.5rem] mb-3",children:e.jsx(Zr,{contentType:((kt=(rs=r.wizardData)==null?void 0:rs.settings)==null?void 0:kt.productType)==="exam"?"exam":((qt=(as=r.wizardData)==null?void 0:as.settings)==null?void 0:qt.productType)==="lesson"?"lesson":"activity",isVisible:!0,className:"text-indigo-600 font-medium"})}),e.jsx("p",{className:"text-gray-400 text-sm mt-2 max-w-md",children:"×”× ×ª×•× ×™× ×ž×ª×¢×“×›× ×™× ×ž×”×¢× ×Ÿ. ×× ×–×” ×œ×•×§×— ×–×ž×Ÿ ×¨×‘, × ×¡×” ×œ×¨×¢× ×Ÿ."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"mt-6 text-indigo-600 hover:text-indigo-800 text-sm font-bold underline",children:"×¨×¢× ×Ÿ ×¢×ž×•×“"})]})]})};export{Ri as default};
//# sourceMappingURL=CourseEditor-DgLQTIpt.js.map
