{"version":3,"file":"QADashboard-BkCVd0t5.js","sources":["../../src/types/qa.types.ts","../../src/services/qa/qaTestingService.ts","../../src/services/qa/contentQualityAgent.ts","../../src/services/qa/studentSimulationAgent.ts","../../src/services/qa/aiGenerationAgent.ts","../../src/services/qa/e2eGenerationAgent.ts","../../src/services/qa/studentActivityAgent.ts","../../src/services/qa/assessmentIntegrityAgent.ts","../../src/services/qa/knowledgeBaseQAAgent.ts","../../src/services/qa/autoFixAgent.ts","../../src/services/qa/index.ts","../../src/components/QADashboard.tsx"],"sourcesContent":["/**\n * QA Testing System Types\n * ××¢×¨×›×ª ×‘×“×™×§×•×ª ××™×›×•×ª ××•×˜×•××˜×™×ª\n */\n\n// ===== BASE TEST TYPES =====\n\nexport type TestStatus = 'passed' | 'failed' | 'warning' | 'skipped' | 'running';\nexport type TestCategory = 'sanity' | 'data-integrity' | 'performance' | 'security' | 'content-quality' | 'student-simulation' | 'ai-generation';\nexport type TestSeverity = 'critical' | 'high' | 'medium' | 'low' | 'info';\n\nexport interface TestResult {\n  id: string;\n  name: string;\n  nameHe: string;\n  category: TestCategory;\n  status: TestStatus;\n  severity: TestSeverity;\n  message: string;\n  messageHe: string;\n  details?: Record<string, unknown>;\n  duration: number; // ms\n  timestamp: Date;\n}\n\nexport interface TestSuite {\n  id: string;\n  name: string;\n  nameHe: string;\n  category: TestCategory;\n  tests: TestResult[];\n  passedCount: number;\n  failedCount: number;\n  warningCount: number;\n  skippedCount: number;\n  duration: number;\n  status: TestStatus;\n}\n\nexport interface QAReport {\n  id: string;\n  createdAt: Date;\n  completedAt: Date;\n  triggeredBy: 'manual' | 'scheduled' | 'ci';\n  triggeredByUserId?: string;\n  environment: 'development' | 'staging' | 'production';\n  suites: TestSuite[];\n  summary: QAReportSummary;\n  metadata: {\n    appVersion?: string;\n    nodeVersion?: string;\n    browserInfo?: string;\n  };\n}\n\nexport interface QAReportSummary {\n  totalTests: number;\n  passed: number;\n  failed: number;\n  warnings: number;\n  skipped: number;\n  passRate: number; // 0-100\n  overallStatus: TestStatus;\n  criticalIssues: TestResult[];\n  duration: number;\n}\n\n// ===== CONTENT QUALITY AGENT =====\n\nexport interface ContentIssue {\n  type: 'missing' | 'invalid' | 'incomplete' | 'quality' | 'accessibility';\n  field: string;\n  message: string;\n  messageHe: string;\n  severity: TestSeverity;\n  autoFixable: boolean;\n  suggestedFix?: string;\n}\n\nexport interface ContentQualityCheck {\n  courseId: string;\n  unitId: string;\n  blockId?: string;\n  checkType:\n    | 'lesson_structure'\n    | 'content_completeness'\n    | 'block_validity'\n    | 'pedagogical_flow'\n    | 'language_quality'\n    | 'media_availability'\n    | 'instructions_clarity';\n  passed: boolean;\n  score: number;\n  issues: ContentIssue[];\n  suggestions: string[];\n}\n\nexport interface LessonPlanValidation {\n  lessonPlanId: string;\n  courseId: string;\n  hasHook: boolean;\n  hasDirectInstruction: boolean;\n  hasGuidedPractice: boolean;\n  hasIndependentPractice: boolean;\n  hasDiscussion: boolean;\n  hasSummary: boolean;\n  slideCount: number;\n  mediaAssetCount: number;\n  mediaAssetsGenerated: number;\n  mediaAssetsFailed: number;\n  scriptWordCount: number;\n  estimatedDuration: number;\n  bloomLevelsUsed: string[];\n  overallScore: number;\n  issues: ContentIssue[];\n}\n\n// ===== STUDENT SIMULATION AGENT =====\n\nexport interface SimulatedStudentProfile {\n  type: 'beginner' | 'average' | 'advanced' | 'struggling' | 'random';\n  correctAnswerRate: number;\n  useHints: boolean;\n  readContent: boolean;\n  interactionSpeed: 'slow' | 'normal' | 'fast';\n}\n\nexport interface BlockStuckInfo {\n  blockId: string;\n  blockType: string;\n  reason: 'no_correct_option' | 'missing_content' | 'ui_blocked' | 'infinite_loop' | 'error_thrown';\n  errorMessage?: string;\n}\n\nexport interface NavigationIssue {\n  fromUnit: string;\n  toUnit: string;\n  issue: 'link_broken' | 'back_not_working' | 'progress_not_saved' | 'wrong_redirect';\n  details: string;\n}\n\nexport interface ContentError {\n  blockId: string;\n  blockType: string;\n  errorType: 'render_failed' | 'missing_data' | 'invalid_state' | 'crash';\n  errorMessage: string;\n  stackTrace?: string;\n}\n\nexport interface UXProblem {\n  location: string;\n  problemType: 'confusing_ui' | 'slow_response' | 'accessibility' | 'mobile_broken';\n  description: string;\n  severity: TestSeverity;\n}\n\nexport interface StudentSimulationRun {\n  id: string;\n  courseId: string;\n  simulationType: 'full_course' | 'single_unit' | 'specific_blocks';\n  studentProfile: SimulatedStudentProfile;\n  startedAt: Date;\n  completedAt?: Date;\n  status: 'running' | 'completed' | 'failed' | 'stuck';\n  unitsAttempted: number;\n  unitsCompleted: number;\n  blocksAttempted: number;\n  blocksCompleted: number;\n  blocksStuck: BlockStuckInfo[];\n  navigationIssues: NavigationIssue[];\n  contentErrors: ContentError[];\n  uxProblems: UXProblem[];\n  averageTimePerBlock: number;\n  errorRate: number;\n  completionRate: number;\n}\n\n// ===== AI GENERATION AGENT =====\n\nexport interface AIGenerationIssue {\n  type:\n    | 'invalid_json'\n    | 'schema_mismatch'\n    | 'empty_field'\n    | 'content_too_short'\n    | 'content_too_long'\n    | 'wrong_language'\n    | 'inappropriate_content'\n    | 'timeout'\n    | 'rate_limited';\n  field?: string;\n  expected?: string;\n  actual?: string;\n  message: string;\n}\n\nexport interface AIGenerationTest {\n  id: string;\n  testType:\n    | 'lesson_plan_generation'\n    | 'activity_generation'\n    | 'quiz_generation'\n    | 'podcast_generation'\n    | 'image_generation'\n    | 'mindmap_generation';\n  inputParams: Record<string, unknown>;\n  expectedOutputSchema?: Record<string, unknown>;\n  startedAt: Date;\n  completedAt?: Date;\n  status: 'running' | 'completed' | 'failed' | 'timeout';\n  duration: number;\n  tokenCount?: number;\n  retryCount: number;\n  outputValid: boolean;\n  schemaMatch: boolean;\n  contentQualityScore: number;\n  issues: AIGenerationIssue[];\n  generatedContent?: unknown;\n}\n\n// ===== CONFIGURATIONS =====\n\nexport interface QATestConfig {\n  sanity: {\n    checkFirebaseConnection: boolean;\n    checkAuthService: boolean;\n    checkStorageAccess: boolean;\n    checkCriticalPages: boolean;\n  };\n  dataIntegrity: {\n    checkOrphanedCourses: boolean;\n    checkEmptyUnits: boolean;\n    checkBrokenReferences: boolean;\n    maxCoursesToCheck: number;\n  };\n  performance: {\n    maxQueryTimeMs: number;\n    maxPageLoadTimeMs: number;\n  };\n  contentQuality: {\n    checkLessonStructure: boolean;\n    checkBlockValidity: boolean;\n    minBlocksPerUnit: number;\n    maxBlocksPerUnit: number;\n  };\n  studentSimulation: {\n    enabled: boolean;\n    coursesToTest: 'all' | 'recent' | 'random' | string[];\n    maxCoursesPerRun: number;\n    studentProfiles: SimulatedStudentProfile[];\n    timeout: number;\n  };\n  aiGeneration: {\n    enabled: boolean;\n    testLessonPlanGeneration: boolean;\n    testActivityGeneration: boolean;\n    testQuizGeneration: boolean;\n    maxRetries: number;\n    timeout: number;\n  };\n}\n\nexport const DEFAULT_STUDENT_PROFILES: SimulatedStudentProfile[] = [\n  { type: 'beginner', correctAnswerRate: 0.3, useHints: true, readContent: true, interactionSpeed: 'slow' },\n  { type: 'average', correctAnswerRate: 0.7, useHints: false, readContent: true, interactionSpeed: 'normal' },\n  { type: 'advanced', correctAnswerRate: 0.95, useHints: false, readContent: false, interactionSpeed: 'fast' },\n  { type: 'struggling', correctAnswerRate: 0.2, useHints: true, readContent: true, interactionSpeed: 'slow' },\n];\n\nexport const DEFAULT_QA_CONFIG: QATestConfig = {\n  sanity: {\n    checkFirebaseConnection: true,\n    checkAuthService: true,\n    checkStorageAccess: true,\n    checkCriticalPages: true,\n  },\n  dataIntegrity: {\n    checkOrphanedCourses: true,\n    checkEmptyUnits: true,\n    checkBrokenReferences: true,\n    maxCoursesToCheck: 100,\n  },\n  performance: {\n    maxQueryTimeMs: 3000,\n    maxPageLoadTimeMs: 5000,\n  },\n  contentQuality: {\n    checkLessonStructure: true,\n    checkBlockValidity: true,\n    minBlocksPerUnit: 3,\n    maxBlocksPerUnit: 20,\n  },\n  studentSimulation: {\n    enabled: true,\n    coursesToTest: 'recent',\n    maxCoursesPerRun: 5,\n    studentProfiles: DEFAULT_STUDENT_PROFILES,\n    timeout: 60000,\n  },\n  aiGeneration: {\n    enabled: true,\n    testLessonPlanGeneration: true,\n    testActivityGeneration: true,\n    testQuizGeneration: true,\n    maxRetries: 2,\n    timeout: 30000,\n  },\n};\n\n// ===== AGENT RESPONSE =====\n\nexport interface QAAgentResult {\n  agentType: 'content-quality' | 'student-simulation' | 'ai-generation';\n  success: boolean;\n  duration: number;\n  testsRun: number;\n  testsPassed: number;\n  testsFailed: number;\n  criticalIssues: TestResult[];\n  allResults: TestResult[];\n}\n\n// ===== AUTO-FIX SYSTEM =====\n\nexport type FixType =\n  | 'regenerate_content'      // ×™×¦×™×¨×” ××—×“×© ×©×œ ×ª×•×›×Ÿ\n  | 'add_missing_field'       // ×”×•×¡×¤×ª ×©×“×” ×—×¡×¨\n  | 'fix_structure'           // ×ª×™×§×•×Ÿ ××‘× ×”\n  | 'remove_invalid'          // ×”×¡×¨×ª ×ª×•×›×Ÿ ×œ× ×ª×§×™×Ÿ\n  | 'update_reference'        // ×¢×“×›×•×Ÿ ×”×¤× ×™×”\n  | 'regenerate_block'        // ×™×¦×™×¨×” ××—×“×© ×©×œ ×‘×œ×•×§\n  | 'fix_options'             // ×ª×™×§×•×Ÿ ××¤×©×¨×•×™×•×ª (×©××œ×•×ª ×‘×—×™×¨×”)\n  | 'add_correct_answer'      // ×”×•×¡×¤×ª ×ª×©×•×‘×” × ×›×•× ×”\n  | 'fix_json_schema'         // ×ª×™×§×•×Ÿ ×¡×›××ª JSON\n  | 'manual_review';          // ×“×•×¨×© ×‘×“×™×§×” ×™×“× ×™×ª\n\nexport interface FixSuggestion {\n  id: string;\n  testResultId: string;\n  fixType: FixType;\n  description: string;\n  descriptionHe: string;\n  autoFixable: boolean;\n  estimatedDuration: number; // seconds\n  riskLevel: 'low' | 'medium' | 'high';\n  targetPath: {\n    collection: string;\n    documentId: string;\n    field?: string;\n    blockId?: string;\n  };\n  fixData?: Record<string, unknown>;\n  requiresAI: boolean;\n  aiPrompt?: string;\n}\n\nexport interface FixResult {\n  id: string;\n  suggestionId: string;\n  status: 'success' | 'failed' | 'partial' | 'skipped';\n  appliedAt: Date;\n  appliedBy?: string;\n  previousValue?: unknown;\n  newValue?: unknown;\n  errorMessage?: string;\n  revalidationResult?: TestResult;\n}\n\nexport interface FixBatch {\n  id: string;\n  createdAt: Date;\n  fixes: FixSuggestion[];\n  status: 'pending' | 'in_progress' | 'completed' | 'failed';\n  completedFixes: number;\n  failedFixes: number;\n  results: FixResult[];\n}\n\n// Extended TestResult with fix suggestions\nexport interface TestResultWithFix extends TestResult {\n  fixSuggestions?: FixSuggestion[];\n  canAutoFix?: boolean;\n}\n\n// ===== KNOWLEDGE BASE QA AGENT =====\n\nexport interface KBSearchTestResult {\n  success: boolean;\n  resultsCount: number;\n  avgSimilarity: number;\n  duration: number;\n  error?: string;\n}\n\nexport interface KBExtractionCounts {\n  exercises: number;\n  commonMistakes: number;\n  progressionLevels: number;\n  mathLanguage: number;\n  examples: number;\n  questionPhrasing: number;\n  studentAddressing: number;\n  explanationPatterns: number;\n}\n\nexport interface KBExtractionResult {\n  success: boolean;\n  extractedCounts: KBExtractionCounts;\n  hasRawContext: boolean;\n  rawContextLength: number;\n  duration: number;\n  sampleExtractions: {\n    exercises: string[];\n    questionPhrasing: string[];\n    studentAddressing: string[];\n  };\n  error?: string;\n}\n\nexport interface KBPromptFormattingResult {\n  success: boolean;\n  promptLength: number;\n  hasSections: {\n    studentAddressing: boolean;\n    questionPhrasing: boolean;\n    explanationPatterns: boolean;\n    exercises: boolean;\n    commonMistakes: boolean;\n    criticalInstructions: boolean;\n  };\n  duration: number;\n  formattedPromptPreview: string;\n}\n\nexport interface KBLanguageAnalysis {\n  usesHebrewTextbookStyle: boolean;\n  hasAppropriateAddressing: boolean;\n  matchesGradeLevel: boolean;\n  issues: string[];\n}\n\nexport interface KBContentGenerationResult {\n  success: boolean;\n  hasKBContext: boolean;\n  generationDuration: number;\n  generatedContent: unknown;\n  languageAnalysis: KBLanguageAnalysis;\n  error?: string;\n}\n\nexport interface KBCoverageResult {\n  totalBooks: number;\n  booksWithContent: string[];\n  gradesWithContent: string[];\n  coveragePercentage: number;\n  missingGrades: string[];\n}\n","/**\r\n * QA Testing Service - Main orchestrator\r\n * ×©×™×¨×•×ª ×‘×“×™×§×•×ª ××™×›×•×ª ×¨××©×™\r\n */\r\n\r\nimport { db } from '../../firebase';\r\nimport { collection, getDocs, query, limit, orderBy, where, doc, setDoc, Timestamp } from 'firebase/firestore';\r\nimport type {\r\n  TestResult,\r\n  TestSuite,\r\n  QAReport,\r\n  QAReportSummary,\r\n  QATestConfig,\r\n  TestStatus,\r\n  TestCategory,\r\n  TestSeverity\r\n} from '../../types/qa.types';\r\nimport { DEFAULT_QA_CONFIG } from '../../types/qa.types';\r\n\r\n// ===== HELPER FUNCTIONS =====\r\n\r\nfunction createTestResult(\r\n  name: string,\r\n  nameHe: string,\r\n  category: TestCategory,\r\n  status: TestStatus,\r\n  severity: TestSeverity,\r\n  message: string,\r\n  messageHe: string,\r\n  duration: number,\r\n  details?: Record<string, unknown>\r\n): TestResult {\r\n  return {\r\n    id: `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n    name,\r\n    nameHe,\r\n    category,\r\n    status,\r\n    severity,\r\n    message,\r\n    messageHe,\r\n    details,\r\n    duration,\r\n    timestamp: new Date()\r\n  };\r\n}\r\n\r\nfunction createTestSuite(\r\n  name: string,\r\n  nameHe: string,\r\n  category: TestCategory,\r\n  tests: TestResult[]\r\n): TestSuite {\r\n  const passedCount = tests.filter(t => t.status === 'passed').length;\r\n  const failedCount = tests.filter(t => t.status === 'failed').length;\r\n  const warningCount = tests.filter(t => t.status === 'warning').length;\r\n  const skippedCount = tests.filter(t => t.status === 'skipped').length;\r\n  const duration = tests.reduce((sum, t) => sum + t.duration, 0);\r\n\r\n  let status: TestStatus = 'passed';\r\n  if (failedCount > 0) status = 'failed';\r\n  else if (warningCount > 0) status = 'warning';\r\n\r\n  return {\r\n    id: `suite_${category}_${Date.now()}`,\r\n    name,\r\n    nameHe,\r\n    category,\r\n    tests,\r\n    passedCount,\r\n    failedCount,\r\n    warningCount,\r\n    skippedCount,\r\n    duration,\r\n    status\r\n  };\r\n}\r\n\r\n// ===== SANITY TESTS =====\r\n\r\nasync function runSanityTests(): Promise<TestSuite> {\r\n  const tests: TestResult[] = [];\r\n  const startTime = Date.now();\r\n\r\n  // Test 1: Firebase Connection\r\n  try {\r\n    const testQuery = query(collection(db, 'courses'), limit(1));\r\n    await getDocs(testQuery);\r\n    tests.push(createTestResult(\r\n      'Firebase Connection',\r\n      '×—×™×‘×•×¨ Firebase',\r\n      'sanity',\r\n      'passed',\r\n      'critical',\r\n      'Successfully connected to Firestore',\r\n      '×”×ª×—×‘×¨×•×ª ××•×¦×œ×—×ª ×œ-Firestore',\r\n      Date.now() - startTime\r\n    ));\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Firebase Connection',\r\n      '×—×™×‘×•×¨ Firebase',\r\n      'sanity',\r\n      'failed',\r\n      'critical',\r\n      `Firebase connection failed: ${error.message}`,\r\n      `×—×™×‘×•×¨ Firebase × ×›×©×œ: ${error.message}`,\r\n      Date.now() - startTime,\r\n      { error: error.message }\r\n    ));\r\n  }\r\n\r\n  // Test 2: Courses Collection Accessible\r\n  const coursesStart = Date.now();\r\n  try {\r\n    const coursesQuery = query(collection(db, 'courses'), limit(5));\r\n    const snapshot = await getDocs(coursesQuery);\r\n    tests.push(createTestResult(\r\n      'Courses Collection',\r\n      '××•×¡×£ ×§×•×¨×¡×™×',\r\n      'sanity',\r\n      'passed',\r\n      'high',\r\n      `Found ${snapshot.size} courses`,\r\n      `× ××¦××• ${snapshot.size} ×§×•×¨×¡×™×`,\r\n      Date.now() - coursesStart,\r\n      { courseCount: snapshot.size }\r\n    ));\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Courses Collection',\r\n      '××•×¡×£ ×§×•×¨×¡×™×',\r\n      'sanity',\r\n      'failed',\r\n      'high',\r\n      `Cannot access courses: ${error.message}`,\r\n      `××™×Ÿ ×’×™×©×” ×œ×§×•×¨×¡×™×: ${error.message}`,\r\n      Date.now() - coursesStart\r\n    ));\r\n  }\r\n\r\n  // Test 3: Assignments Collection\r\n  const assignmentsStart = Date.now();\r\n  try {\r\n    const assignmentsQuery = query(collection(db, 'student_tasks'), limit(5));\r\n    const snapshot = await getDocs(assignmentsQuery);\r\n    tests.push(createTestResult(\r\n      'Assignments Collection',\r\n      '××•×¡×£ ××˜×œ×•×ª',\r\n      'sanity',\r\n      'passed',\r\n      'medium',\r\n      `Found ${snapshot.size} assignments`,\r\n      `× ××¦××• ${snapshot.size} ××˜×œ×•×ª`,\r\n      Date.now() - assignmentsStart\r\n    ));\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Assignments Collection',\r\n      '××•×¡×£ ××˜×œ×•×ª',\r\n      'sanity',\r\n      'failed',\r\n      'medium',\r\n      `Cannot access assignments: ${error.message}`,\r\n      `××™×Ÿ ×’×™×©×” ×œ××˜×œ×•×ª: ${error.message}`,\r\n      Date.now() - assignmentsStart\r\n    ));\r\n  }\r\n\r\n  // Test 4: Users Collection\r\n  const usersStart = Date.now();\r\n  try {\r\n    const usersQuery = query(collection(db, 'users'), limit(5));\r\n    const snapshot = await getDocs(usersQuery);\r\n    tests.push(createTestResult(\r\n      'Users Collection',\r\n      '××•×¡×£ ××©×ª××©×™×',\r\n      'sanity',\r\n      'passed',\r\n      'medium',\r\n      `Found ${snapshot.size} users`,\r\n      `× ××¦××• ${snapshot.size} ××©×ª××©×™×`,\r\n      Date.now() - usersStart\r\n    ));\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Users Collection',\r\n      '××•×¡×£ ××©×ª××©×™×',\r\n      'sanity',\r\n      'warning',\r\n      'medium',\r\n      `Users collection issue: ${error.message}`,\r\n      `×‘×¢×™×” ×‘××•×¡×£ ××©×ª××©×™×: ${error.message}`,\r\n      Date.now() - usersStart\r\n    ));\r\n  }\r\n\r\n  return createTestSuite('Sanity Tests', '×‘×“×™×§×•×ª ×¡× ×™×˜×™', 'sanity', tests);\r\n}\r\n\r\n// ===== DATA INTEGRITY TESTS =====\r\n\r\nasync function runDataIntegrityTests(config: QATestConfig['dataIntegrity']): Promise<TestSuite> {\r\n  const tests: TestResult[] = [];\r\n\r\n  // Test 1: Check for courses with empty syllabus\r\n  const emptyStart = Date.now();\r\n  try {\r\n    const coursesQuery = query(collection(db, 'courses'), limit(config.maxCoursesToCheck));\r\n    const snapshot = await getDocs(coursesQuery);\r\n\r\n    let emptyCount = 0;\r\n    let totalCourses = 0;\r\n    const emptyCourses: string[] = [];\r\n\r\n    snapshot.forEach(doc => {\r\n      totalCourses++;\r\n      const data = doc.data();\r\n      const syllabus = data.syllabus || [];\r\n      if (!syllabus.length || syllabus.every((m: any) => !m.learningUnits?.length)) {\r\n        emptyCount++;\r\n        emptyCourses.push(doc.id);\r\n      }\r\n    });\r\n\r\n    if (emptyCount === 0) {\r\n      tests.push(createTestResult(\r\n        'Empty Courses Check',\r\n        '×‘×“×™×§×ª ×§×•×¨×¡×™× ×¨×™×§×™×',\r\n        'data-integrity',\r\n        'passed',\r\n        'medium',\r\n        `All ${totalCourses} courses have content`,\r\n        `×›×œ ${totalCourses} ×”×§×•×¨×¡×™× ××›×™×œ×™× ×ª×•×›×Ÿ`,\r\n        Date.now() - emptyStart\r\n      ));\r\n    } else {\r\n      tests.push(createTestResult(\r\n        'Empty Courses Check',\r\n        '×‘×“×™×§×ª ×§×•×¨×¡×™× ×¨×™×§×™×',\r\n        'data-integrity',\r\n        'warning',\r\n        'medium',\r\n        `Found ${emptyCount} courses with no content`,\r\n        `× ××¦××• ${emptyCount} ×§×•×¨×¡×™× ×œ×œ× ×ª×•×›×Ÿ`,\r\n        Date.now() - emptyStart,\r\n        { emptyCount, emptyCourses: emptyCourses.slice(0, 10) }\r\n      ));\r\n    }\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Empty Courses Check',\r\n      '×‘×“×™×§×ª ×§×•×¨×¡×™× ×¨×™×§×™×',\r\n      'data-integrity',\r\n      'failed',\r\n      'medium',\r\n      `Check failed: ${error.message}`,\r\n      `×‘×“×™×§×” × ×›×©×œ×”: ${error.message}`,\r\n      Date.now() - emptyStart\r\n    ));\r\n  }\r\n\r\n  // Test 2: Check for blocks with missing content\r\n  const blocksStart = Date.now();\r\n  try {\r\n    const coursesQuery = query(collection(db, 'courses'), limit(20));\r\n    const snapshot = await getDocs(coursesQuery);\r\n\r\n    let invalidBlocks = 0;\r\n    const issues: { courseId: string; unitId: string; blockId: string; issue: string }[] = [];\r\n\r\n    snapshot.forEach(doc => {\r\n      const data = doc.data();\r\n      const syllabus = data.syllabus || [];\r\n\r\n      syllabus.forEach((module: any) => {\r\n        (module.learningUnits || []).forEach((unit: any) => {\r\n          (unit.activityBlocks || []).forEach((block: any) => {\r\n            // Check for missing content\r\n            if (!block.content && block.type !== 'text') {\r\n              invalidBlocks++;\r\n              issues.push({\r\n                courseId: doc.id,\r\n                unitId: unit.id,\r\n                blockId: block.id,\r\n                issue: 'missing_content'\r\n              });\r\n            }\r\n            // Check multiple choice without correct answer\r\n            if (block.type === 'multiple-choice') {\r\n              const content = block.content || {};\r\n              if (!content.correctAnswer && !content.correct_answer) {\r\n                invalidBlocks++;\r\n                issues.push({\r\n                  courseId: doc.id,\r\n                  unitId: unit.id,\r\n                  blockId: block.id,\r\n                  issue: 'no_correct_answer'\r\n                });\r\n              }\r\n            }\r\n          });\r\n        });\r\n      });\r\n    });\r\n\r\n    if (invalidBlocks === 0) {\r\n      tests.push(createTestResult(\r\n        'Block Validity Check',\r\n        '×‘×“×™×§×ª ×ª×§×™× ×•×ª ×‘×œ×•×§×™×',\r\n        'data-integrity',\r\n        'passed',\r\n        'high',\r\n        'All activity blocks are valid',\r\n        '×›×œ ×‘×œ×•×§×™ ×”×¤×¢×™×œ×•×ª ×ª×§×™× ×™×',\r\n        Date.now() - blocksStart\r\n      ));\r\n    } else {\r\n      tests.push(createTestResult(\r\n        'Block Validity Check',\r\n        '×‘×“×™×§×ª ×ª×§×™× ×•×ª ×‘×œ×•×§×™×',\r\n        'data-integrity',\r\n        'warning',\r\n        'high',\r\n        `Found ${invalidBlocks} blocks with issues`,\r\n        `× ××¦××• ${invalidBlocks} ×‘×œ×•×§×™× ×¢× ×‘×¢×™×•×ª`,\r\n        Date.now() - blocksStart,\r\n        { invalidBlocks, issues: issues.slice(0, 20) }\r\n      ));\r\n    }\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Block Validity Check',\r\n      '×‘×“×™×§×ª ×ª×§×™× ×•×ª ×‘×œ×•×§×™×',\r\n      'data-integrity',\r\n      'failed',\r\n      'high',\r\n      `Check failed: ${error.message}`,\r\n      `×‘×“×™×§×” × ×›×©×œ×”: ${error.message}`,\r\n      Date.now() - blocksStart\r\n    ));\r\n  }\r\n\r\n  // Test 3: Check for assignments without valid courses\r\n  const assignmentsStart = Date.now();\r\n  try {\r\n    const tasksQuery = query(collection(db, 'student_tasks'), limit(50));\r\n    const tasksSnapshot = await getDocs(tasksQuery);\r\n\r\n    const courseIds = new Set<string>();\r\n    tasksSnapshot.forEach(doc => {\r\n      const data = doc.data();\r\n      if (data.courseId) courseIds.add(data.courseId);\r\n    });\r\n\r\n    let orphanedTasks = 0;\r\n    for (const courseId of courseIds) {\r\n      try {\r\n        const courseDoc = await getDocs(query(collection(db, 'courses'), where('__name__', '==', courseId)));\r\n        if (courseDoc.empty) orphanedTasks++;\r\n      } catch {\r\n        // Skip if we can't check\r\n      }\r\n    }\r\n\r\n    if (orphanedTasks === 0) {\r\n      tests.push(createTestResult(\r\n        'Orphaned Tasks Check',\r\n        '×‘×“×™×§×ª ××˜×œ×•×ª ×™×ª×•××•×ª',\r\n        'data-integrity',\r\n        'passed',\r\n        'medium',\r\n        'All tasks linked to valid courses',\r\n        '×›×œ ×”××˜×œ×•×ª ××§×•×©×¨×•×ª ×œ×§×•×¨×¡×™× ×ª×§×™× ×™×',\r\n        Date.now() - assignmentsStart\r\n      ));\r\n    } else {\r\n      tests.push(createTestResult(\r\n        'Orphaned Tasks Check',\r\n        '×‘×“×™×§×ª ××˜×œ×•×ª ×™×ª×•××•×ª',\r\n        'data-integrity',\r\n        'warning',\r\n        'medium',\r\n        `Found ${orphanedTasks} tasks with missing courses`,\r\n        `× ××¦××• ${orphanedTasks} ××˜×œ×•×ª ×¢× ×§×•×¨×¡×™× ×—×¡×¨×™×`,\r\n        Date.now() - assignmentsStart,\r\n        { orphanedTasks }\r\n      ));\r\n    }\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Orphaned Tasks Check',\r\n      '×‘×“×™×§×ª ××˜×œ×•×ª ×™×ª×•××•×ª',\r\n      'data-integrity',\r\n      'skipped',\r\n      'low',\r\n      `Check skipped: ${error.message}`,\r\n      `×‘×“×™×§×” ×“×•×œ×’×”: ${error.message}`,\r\n      Date.now() - assignmentsStart\r\n    ));\r\n  }\r\n\r\n  return createTestSuite('Data Integrity Tests', '×‘×“×™×§×•×ª ×©×œ××•×ª × ×ª×•× ×™×', 'data-integrity', tests);\r\n}\r\n\r\n// ===== PERFORMANCE TESTS =====\r\n\r\nasync function runPerformanceTests(config: QATestConfig['performance']): Promise<TestSuite> {\r\n  const tests: TestResult[] = [];\r\n\r\n  // Test 1: Course query time\r\n  const queryStart = Date.now();\r\n  try {\r\n    const coursesQuery = query(collection(db, 'courses'), orderBy('createdAt', 'desc'), limit(10));\r\n    await getDocs(coursesQuery);\r\n    const queryTime = Date.now() - queryStart;\r\n\r\n    if (queryTime < config.maxQueryTimeMs) {\r\n      tests.push(createTestResult(\r\n        'Course Query Performance',\r\n        '×‘×™×¦×•×¢×™ ×©××™×œ×ª×ª ×§×•×¨×¡×™×',\r\n        'performance',\r\n        'passed',\r\n        'medium',\r\n        `Query completed in ${queryTime}ms (limit: ${config.maxQueryTimeMs}ms)`,\r\n        `×©××™×œ×ª×” ×”×•×©×œ××” ×‘-${queryTime}ms (×’×‘×•×œ: ${config.maxQueryTimeMs}ms)`,\r\n        queryTime,\r\n        { queryTime, limit: config.maxQueryTimeMs }\r\n      ));\r\n    } else {\r\n      tests.push(createTestResult(\r\n        'Course Query Performance',\r\n        '×‘×™×¦×•×¢×™ ×©××™×œ×ª×ª ×§×•×¨×¡×™×',\r\n        'performance',\r\n        'warning',\r\n        'medium',\r\n        `Query took ${queryTime}ms (exceeds ${config.maxQueryTimeMs}ms limit)`,\r\n        `×©××™×œ×ª×” ×œ×§×—×” ${queryTime}ms (×—×•×¨×’ ××’×‘×•×œ ${config.maxQueryTimeMs}ms)`,\r\n        queryTime,\r\n        { queryTime, limit: config.maxQueryTimeMs }\r\n      ));\r\n    }\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Course Query Performance',\r\n      '×‘×™×¦×•×¢×™ ×©××™×œ×ª×ª ×§×•×¨×¡×™×',\r\n      'performance',\r\n      'failed',\r\n      'medium',\r\n      `Query failed: ${error.message}`,\r\n      `×©××™×œ×ª×” × ×›×©×œ×”: ${error.message}`,\r\n      Date.now() - queryStart\r\n    ));\r\n  }\r\n\r\n  // Test 2: Complex aggregation query\r\n  const aggStart = Date.now();\r\n  try {\r\n    const tasksQuery = query(\r\n      collection(db, 'student_tasks'),\r\n      where('status', '==', 'submitted'),\r\n      limit(20)\r\n    );\r\n    await getDocs(tasksQuery);\r\n    const aggTime = Date.now() - aggStart;\r\n\r\n    tests.push(createTestResult(\r\n      'Task Query Performance',\r\n      '×‘×™×¦×•×¢×™ ×©××™×œ×ª×ª ××˜×œ×•×ª',\r\n      'performance',\r\n      aggTime < config.maxQueryTimeMs ? 'passed' : 'warning',\r\n      'low',\r\n      `Aggregation query: ${aggTime}ms`,\r\n      `×©××™×œ×ª×ª ××’×¨×’×¦×™×”: ${aggTime}ms`,\r\n      aggTime\r\n    ));\r\n  } catch (error: any) {\r\n    tests.push(createTestResult(\r\n      'Task Query Performance',\r\n      '×‘×™×¦×•×¢×™ ×©××™×œ×ª×ª ××˜×œ×•×ª',\r\n      'performance',\r\n      'skipped',\r\n      'low',\r\n      `Skipped: ${error.message}`,\r\n      `×“×•×œ×’×”: ${error.message}`,\r\n      Date.now() - aggStart\r\n    ));\r\n  }\r\n\r\n  return createTestSuite('Performance Tests', '×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™×', 'performance', tests);\r\n}\r\n\r\n// ===== MAIN ORCHESTRATOR =====\r\n\r\nexport async function runFullQAReport(\r\n  config: QATestConfig = DEFAULT_QA_CONFIG,\r\n  triggeredBy: 'manual' | 'scheduled' | 'ci' = 'manual',\r\n  userId?: string\r\n): Promise<QAReport> {\r\n  const startTime = Date.now();\r\n  const suites: TestSuite[] = [];\r\n\r\n  // Run all test suites\r\n  console.log('ğŸ” Starting QA Tests...');\r\n\r\n  // 1. Sanity Tests\r\n  console.log('  â–¶ Running Sanity Tests...');\r\n  suites.push(await runSanityTests());\r\n\r\n  // 2. Data Integrity Tests\r\n  console.log('  â–¶ Running Data Integrity Tests...');\r\n  suites.push(await runDataIntegrityTests(config.dataIntegrity));\r\n\r\n  // 3. Performance Tests\r\n  console.log('  â–¶ Running Performance Tests...');\r\n  suites.push(await runPerformanceTests(config.performance));\r\n\r\n  // Calculate summary\r\n  const allTests = suites.flatMap(s => s.tests);\r\n  const passed = allTests.filter(t => t.status === 'passed').length;\r\n  const failed = allTests.filter(t => t.status === 'failed').length;\r\n  const warnings = allTests.filter(t => t.status === 'warning').length;\r\n  const skipped = allTests.filter(t => t.status === 'skipped').length;\r\n  const criticalIssues = allTests.filter(t => t.status === 'failed' && t.severity === 'critical');\r\n\r\n  let overallStatus: TestStatus = 'passed';\r\n  if (failed > 0) overallStatus = 'failed';\r\n  else if (warnings > 0) overallStatus = 'warning';\r\n\r\n  const summary: QAReportSummary = {\r\n    totalTests: allTests.length,\r\n    passed,\r\n    failed,\r\n    warnings,\r\n    skipped,\r\n    passRate: Math.round((passed / allTests.length) * 100),\r\n    overallStatus,\r\n    criticalIssues,\r\n    duration: Date.now() - startTime\r\n  };\r\n\r\n  const report: QAReport = {\r\n    id: `report_${Date.now()}`,\r\n    createdAt: new Date(startTime),\r\n    completedAt: new Date(),\r\n    triggeredBy,\r\n    triggeredByUserId: userId,\r\n    environment: process.env.NODE_ENV === 'production' ? 'production' : 'development',\r\n    suites,\r\n    summary,\r\n    metadata: {\r\n      browserInfo: typeof navigator !== 'undefined' ? navigator.userAgent : 'Node.js'\r\n    }\r\n  };\r\n\r\n  console.log(`âœ… QA Report Complete: ${passed}/${allTests.length} passed (${summary.passRate}%)`);\r\n\r\n  return report;\r\n}\r\n\r\n// ===== SAVE REPORT TO FIRESTORE =====\r\n\r\nexport async function saveQAReport(report: QAReport): Promise<string> {\r\n  const reportRef = doc(collection(db, 'qa_reports'));\r\n\r\n  // Clean undefined values to prevent Firestore errors\r\n  const cleanReport = {\r\n    id: report.id,\r\n    createdAt: Timestamp.fromDate(report.createdAt),\r\n    completedAt: Timestamp.fromDate(report.completedAt),\r\n    triggeredBy: report.triggeredBy,\r\n    environment: report.environment,\r\n    summary: report.summary,\r\n    metadata: {\r\n      browserInfo: report.metadata?.browserInfo || null,\r\n      appVersion: report.metadata?.appVersion || null,\r\n      nodeVersion: report.metadata?.nodeVersion || null\r\n    },\r\n    // Only include triggeredByUserId if it exists\r\n    ...(report.triggeredByUserId && { triggeredByUserId: report.triggeredByUserId }),\r\n    // Store suites with cleaned timestamps\r\n    suites: report.suites.map(s => ({\r\n      ...s,\r\n      tests: s.tests.map(t => ({\r\n        ...t,\r\n        timestamp: Timestamp.fromDate(t.timestamp),\r\n        // Clean optional details field\r\n        details: t.details || null\r\n      }))\r\n    }))\r\n  };\r\n\r\n  await setDoc(reportRef, cleanReport);\r\n\r\n  return reportRef.id;\r\n}\r\n\r\n// ===== GET RECENT REPORTS =====\r\n\r\nexport async function getRecentQAReports(limitCount: number = 10): Promise<QAReport[]> {\r\n  const reportsQuery = query(\r\n    collection(db, 'qa_reports'),\r\n    orderBy('createdAt', 'desc'),\r\n    limit(limitCount)\r\n  );\r\n\r\n  const snapshot = await getDocs(reportsQuery);\r\n  return snapshot.docs.map(doc => {\r\n    const data = doc.data();\r\n    return {\r\n      ...data,\r\n      id: doc.id,\r\n      createdAt: data.createdAt?.toDate?.() || new Date(),\r\n      completedAt: data.completedAt?.toDate?.() || new Date()\r\n    } as QAReport;\r\n  });\r\n}\r\n","/**\n * Content Quality Agent\n * ×¡×•×›×Ÿ ×‘×•×“×§ ××™×›×•×ª ×ª×•×›×Ÿ - ×‘×•×“×§ ××¢×¨×›×™ ×©×™×¢×•×¨ ×•×ª×•×›×Ÿ ×©× ×•×¦×¨\n */\n\nimport { db } from '../../firebase';\nimport { collection, getDocs, query, limit, orderBy, doc, getDoc } from 'firebase/firestore';\nimport type {\n  TestResult,\n  TestSuite,\n  ContentQualityCheck,\n  ContentIssue,\n  LessonPlanValidation,\n  QAAgentResult,\n  TestSeverity\n} from '../../types/qa.types';\nimport type { Course, LearningUnit, ActivityBlock, Module } from '../../shared/types/courseTypes';\nimport type { TeacherLessonPlan } from '../../shared/types/gemini.types';\n\n// ===== BLOCK VALIDATORS =====\n\ninterface BlockValidationResult {\n  valid: boolean;\n  issues: ContentIssue[];\n  score: number;\n}\n\nfunction validateMultipleChoiceBlock(block: ActivityBlock): BlockValidationResult {\n  const issues: ContentIssue[] = [];\n  const content = block.content || {};\n\n  // Check for question\n  if (!content.question) {\n    issues.push({\n      type: 'missing',\n      field: 'question',\n      message: 'Multiple choice block missing question',\n      messageHe: '×‘×œ×•×§ ×‘×—×™×¨×” ××¨×•×‘×” ×—×¡×¨ ×©××œ×”',\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  // Check for options\n  const options = content.options || [];\n  if (options.length < 2) {\n    issues.push({\n      type: 'incomplete',\n      field: 'options',\n      message: `Only ${options.length} options (minimum 2 required)`,\n      messageHe: `×¨×§ ${options.length} ××¤×©×¨×•×™×•×ª (××™× ×™××•× 2 × ×“×¨×©×•×ª)`,\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  if (options.length > 6) {\n    issues.push({\n      type: 'quality',\n      field: 'options',\n      message: 'Too many options (max 6 recommended)',\n      messageHe: '×™×•×ª×¨ ××“×™ ××¤×©×¨×•×™×•×ª (××§×¡×™××•× 6 ××•××œ×¥)',\n      severity: 'low',\n      autoFixable: false\n    });\n  }\n\n  // Check for correct answer\n  if (!content.correctAnswer && !content.correct_answer) {\n    issues.push({\n      type: 'missing',\n      field: 'correctAnswer',\n      message: 'No correct answer specified',\n      messageHe: '×œ× ×¦×•×™× ×” ×ª×©×•×‘×” × ×›×•× ×”',\n      severity: 'critical',\n      autoFixable: false\n    });\n  }\n\n  // Verify correct answer is in options\n  const correctAnswer = content.correctAnswer || content.correct_answer;\n  if (correctAnswer && options.length > 0) {\n    const optionTexts = options.map((o: any) => typeof o === 'string' ? o : o.text || o.label);\n    if (!optionTexts.includes(correctAnswer)) {\n      issues.push({\n        type: 'invalid',\n        field: 'correctAnswer',\n        message: 'Correct answer not found in options',\n        messageHe: '×”×ª×©×•×‘×” ×”× ×›×•× ×” ×œ× × ××¦××ª ×‘××¤×©×¨×•×™×•×ª',\n        severity: 'critical',\n        autoFixable: false\n      });\n    }\n  }\n\n  const score = Math.max(0, 100 - (issues.length * 20));\n  return { valid: issues.length === 0, issues, score };\n}\n\nfunction validateOpenQuestionBlock(block: ActivityBlock): BlockValidationResult {\n  const issues: ContentIssue[] = [];\n  const content = block.content || {};\n\n  if (!content.question) {\n    issues.push({\n      type: 'missing',\n      field: 'question',\n      message: 'Open question missing question text',\n      messageHe: '×©××œ×” ×¤×ª×•×—×” ×—×¡×¨×” ×˜×§×¡×˜ ×©××œ×”',\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  // Check for model answer (recommended)\n  if (!block.metadata?.modelAnswer) {\n    issues.push({\n      type: 'quality',\n      field: 'modelAnswer',\n      message: 'No model answer provided (recommended for grading)',\n      messageHe: '×œ× ×¡×•×¤×§×” ×ª×©×•×‘×ª ××•×“×œ (××•××œ×¥ ×œ×¦×•×¨×›×™ ×¦×™×•×Ÿ)',\n      severity: 'low',\n      autoFixable: false\n    });\n  }\n\n  const score = Math.max(0, 100 - (issues.length * 15));\n  return { valid: issues.filter(i => i.severity !== 'low').length === 0, issues, score };\n}\n\nfunction validateOrderingBlock(block: ActivityBlock): BlockValidationResult {\n  const issues: ContentIssue[] = [];\n  const content = block.content || {};\n\n  if (!content.instruction) {\n    issues.push({\n      type: 'missing',\n      field: 'instruction',\n      message: 'Ordering block missing instruction',\n      messageHe: '×‘×œ×•×§ ×¡×™×“×•×¨ ×—×¡×¨ ×”× ×—×™×”',\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  const correctOrder = content.correct_order || content.correctOrder || [];\n  if (correctOrder.length < 2) {\n    issues.push({\n      type: 'incomplete',\n      field: 'correct_order',\n      message: `Only ${correctOrder.length} items to order (minimum 2)`,\n      messageHe: `×¨×§ ${correctOrder.length} ×¤×¨×™×˜×™× ×œ×¡×™×“×•×¨ (××™× ×™××•× 2)`,\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  const score = Math.max(0, 100 - (issues.length * 20));\n  return { valid: issues.length === 0, issues, score };\n}\n\nfunction validateCategorizationBlock(block: ActivityBlock): BlockValidationResult {\n  const issues: ContentIssue[] = [];\n  const content = block.content || {};\n\n  const categories = content.categories || [];\n  const items = content.items || [];\n\n  if (categories.length < 2) {\n    issues.push({\n      type: 'incomplete',\n      field: 'categories',\n      message: `Only ${categories.length} categories (minimum 2)`,\n      messageHe: `×¨×§ ${categories.length} ×§×˜×’×•×¨×™×•×ª (××™× ×™××•× 2)`,\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  if (items.length < categories.length) {\n    issues.push({\n      type: 'incomplete',\n      field: 'items',\n      message: 'Fewer items than categories',\n      messageHe: '×¤×—×•×ª ×¤×¨×™×˜×™× ××§×˜×’×•×¨×™×•×ª',\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  // Check all items have valid category assignments\n  items.forEach((item: any, index: number) => {\n    if (item.category && !categories.includes(item.category)) {\n      issues.push({\n        type: 'invalid',\n        field: `items[${index}].category`,\n        message: `Item assigned to non-existent category: ${item.category}`,\n        messageHe: `×¤×¨×™×˜ ××•×§×¦×” ×œ×§×˜×’×•×¨×™×” ×©×œ× ×§×™×™××ª: ${item.category}`,\n        severity: 'high',\n        autoFixable: false\n      });\n    }\n  });\n\n  const score = Math.max(0, 100 - (issues.length * 15));\n  return { valid: issues.filter(i => i.severity === 'critical' || i.severity === 'high').length === 0, issues, score };\n}\n\nfunction validateTextBlock(block: ActivityBlock): BlockValidationResult {\n  const issues: ContentIssue[] = [];\n  const content = block.content;\n\n  if (!content || (typeof content === 'string' && content.trim().length === 0)) {\n    issues.push({\n      type: 'missing',\n      field: 'content',\n      message: 'Text block is empty',\n      messageHe: '×‘×œ×•×§ ×˜×§×¡×˜ ×¨×™×§',\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  if (typeof content === 'string' && content.length < 20) {\n    issues.push({\n      type: 'quality',\n      field: 'content',\n      message: 'Text content is very short',\n      messageHe: '×ª×•×›×Ÿ ×”×˜×§×¡×˜ ×§×¦×¨ ×××•×“',\n      severity: 'low',\n      autoFixable: false\n    });\n  }\n\n  const score = Math.max(0, 100 - (issues.length * 20));\n  return { valid: issues.filter(i => i.severity !== 'low').length === 0, issues, score };\n}\n\nfunction validateMemoryGameBlock(block: ActivityBlock): BlockValidationResult {\n  const issues: ContentIssue[] = [];\n  const content = block.content || {};\n\n  const pairs = content.pairs || content.cards || [];\n  if (pairs.length < 3) {\n    issues.push({\n      type: 'incomplete',\n      field: 'pairs',\n      message: `Only ${pairs.length} pairs (minimum 3 recommended)`,\n      messageHe: `×¨×§ ${pairs.length} ×–×•×’×•×ª (××™× ×™××•× 3 ××•××œ×¥)`,\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  if (pairs.length > 12) {\n    issues.push({\n      type: 'quality',\n      field: 'pairs',\n      message: 'Too many pairs (max 12 recommended for playability)',\n      messageHe: '×™×•×ª×¨ ××“×™ ×–×•×’×•×ª (××§×¡×™××•× 12 ××•××œ×¥ ×œ×©×—×™×§×•×ª)',\n      severity: 'low',\n      autoFixable: false\n    });\n  }\n\n  const score = Math.max(0, 100 - (issues.length * 15));\n  return { valid: issues.filter(i => i.severity === 'critical' || i.severity === 'high').length === 0, issues, score };\n}\n\nfunction validateBlock(block: ActivityBlock): BlockValidationResult {\n  switch (block.type) {\n    case 'multiple-choice':\n      return validateMultipleChoiceBlock(block);\n    case 'open-question':\n      return validateOpenQuestionBlock(block);\n    case 'ordering':\n      return validateOrderingBlock(block);\n    case 'categorization':\n      return validateCategorizationBlock(block);\n    case 'text':\n      return validateTextBlock(block);\n    case 'memory_game':\n      return validateMemoryGameBlock(block);\n    case 'video':\n    case 'image':\n    case 'pdf':\n      // Media blocks - check for URL/content\n      if (!block.content) {\n        return {\n          valid: false,\n          issues: [{\n            type: 'missing',\n            field: 'content',\n            message: `${block.type} block missing content/URL`,\n            messageHe: `×‘×œ×•×§ ${block.type} ×—×¡×¨ ×ª×•×›×Ÿ/×§×™×©×•×¨`,\n            severity: 'high',\n            autoFixable: false\n          }],\n          score: 0\n        };\n      }\n      return { valid: true, issues: [], score: 100 };\n    default:\n      // Unknown or complex blocks - basic validation\n      return { valid: true, issues: [], score: 80 };\n  }\n}\n\n// ===== UNIT VALIDATION =====\n\ninterface UnitValidationResult {\n  unitId: string;\n  unitTitle: string;\n  valid: boolean;\n  blockCount: number;\n  validBlocks: number;\n  invalidBlocks: number;\n  issues: ContentIssue[];\n  score: number;\n  blockScores: { blockId: string; type: string; score: number }[];\n}\n\nfunction validateUnit(unit: LearningUnit): UnitValidationResult {\n  const issues: ContentIssue[] = [];\n  const blockScores: { blockId: string; type: string; score: number }[] = [];\n\n  const blocks = unit.activityBlocks || [];\n\n  // Check minimum blocks\n  if (blocks.length === 0) {\n    issues.push({\n      type: 'missing',\n      field: 'activityBlocks',\n      message: 'Unit has no activity blocks',\n      messageHe: '×œ×™×—×™×“×” ××™×Ÿ ×‘×œ×•×§×™ ×¤×¢×™×œ×•×ª',\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  // Validate each block\n  let validBlocks = 0;\n  let totalScore = 0;\n\n  blocks.forEach(block => {\n    const result = validateBlock(block);\n    blockScores.push({ blockId: block.id, type: block.type, score: result.score });\n    totalScore += result.score;\n\n    if (result.valid) {\n      validBlocks++;\n    } else {\n      issues.push(...result.issues);\n    }\n  });\n\n  // Check for content diversity\n  const blockTypes = new Set(blocks.map(b => b.type));\n  if (blocks.length > 3 && blockTypes.size === 1) {\n    issues.push({\n      type: 'quality',\n      field: 'diversity',\n      message: 'Unit uses only one block type - consider adding variety',\n      messageHe: '×”×™×—×™×“×” ××©×ª××©×ª ×¨×§ ×‘×¡×•×’ ×‘×œ×•×§ ××—×“ - ×©×§×•×œ ×œ×”×•×¡×™×£ ××’×•×•×Ÿ',\n      severity: 'low',\n      autoFixable: false\n    });\n  }\n\n  // Check base content\n  if (!unit.baseContent || unit.baseContent.trim().length < 50) {\n    issues.push({\n      type: 'incomplete',\n      field: 'baseContent',\n      message: 'Unit base content is missing or too short',\n      messageHe: '×ª×•×›×Ÿ ×”×‘×¡×™×¡ ×©×œ ×”×™×—×™×“×” ×—×¡×¨ ××• ×§×¦×¨ ××“×™',\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  const avgScore = blocks.length > 0 ? Math.round(totalScore / blocks.length) : 0;\n\n  return {\n    unitId: unit.id,\n    unitTitle: unit.title,\n    valid: issues.filter(i => i.severity === 'critical' || i.severity === 'high').length === 0,\n    blockCount: blocks.length,\n    validBlocks,\n    invalidBlocks: blocks.length - validBlocks,\n    issues,\n    score: avgScore,\n    blockScores\n  };\n}\n\n// ===== COURSE VALIDATION =====\n\ninterface CourseValidationResult {\n  courseId: string;\n  courseTitle: string;\n  valid: boolean;\n  moduleCount: number;\n  unitCount: number;\n  blockCount: number;\n  issues: ContentIssue[];\n  unitResults: UnitValidationResult[];\n  overallScore: number;\n}\n\nfunction validateCourse(course: Course): CourseValidationResult {\n  const issues: ContentIssue[] = [];\n  const unitResults: UnitValidationResult[] = [];\n\n  const modules = course.syllabus || [];\n  let totalUnits = 0;\n  let totalBlocks = 0;\n  let totalScore = 0;\n  let unitScoreCount = 0;\n\n  // Check basic course info\n  if (!course.title) {\n    issues.push({\n      type: 'missing',\n      field: 'title',\n      message: 'Course has no title',\n      messageHe: '×œ×§×•×¨×¡ ××™×Ÿ ×›×•×ª×¨×ª',\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  if (!course.targetAudience) {\n    issues.push({\n      type: 'missing',\n      field: 'targetAudience',\n      message: 'Course has no target audience defined',\n      messageHe: '×œ× ×”×•×’×“×¨ ×§×”×œ ×™×¢×“ ×œ×§×•×¨×¡',\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  if (modules.length === 0) {\n    issues.push({\n      type: 'missing',\n      field: 'syllabus',\n      message: 'Course has no modules',\n      messageHe: '×œ×§×•×¨×¡ ××™×Ÿ ××•×“×•×œ×™×',\n      severity: 'critical',\n      autoFixable: false\n    });\n  }\n\n  // Validate each module and unit\n  modules.forEach(module => {\n    const units = module.learningUnits || [];\n    totalUnits += units.length;\n\n    if (units.length === 0) {\n      issues.push({\n        type: 'incomplete',\n        field: `module_${module.id}`,\n        message: `Module \"${module.title}\" has no units`,\n        messageHe: `×œ××•×“×•×œ \"${module.title}\" ××™×Ÿ ×™×—×™×“×•×ª`,\n        severity: 'medium',\n        autoFixable: false\n      });\n    }\n\n    units.forEach(unit => {\n      const unitResult = validateUnit(unit);\n      unitResults.push(unitResult);\n      totalBlocks += unitResult.blockCount;\n      totalScore += unitResult.score;\n      unitScoreCount++;\n\n      if (!unitResult.valid) {\n        issues.push(...unitResult.issues.filter(i => i.severity === 'critical' || i.severity === 'high'));\n      }\n    });\n  });\n\n  const overallScore = unitScoreCount > 0 ? Math.round(totalScore / unitScoreCount) : 0;\n\n  return {\n    courseId: course.id,\n    courseTitle: course.title,\n    valid: issues.filter(i => i.severity === 'critical').length === 0,\n    moduleCount: modules.length,\n    unitCount: totalUnits,\n    blockCount: totalBlocks,\n    issues,\n    unitResults,\n    overallScore\n  };\n}\n\n// ===== LESSON PLAN VALIDATION =====\n\nfunction validateLessonPlan(lessonPlan: TeacherLessonPlan, courseId: string): LessonPlanValidation {\n  const issues: ContentIssue[] = [];\n\n  const hasHook = !!lessonPlan.hook?.script_for_teacher;\n  const hasDirectInstruction = !!lessonPlan.direct_instruction?.slides?.length;\n  const hasGuidedPractice = !!lessonPlan.guided_practice?.teacher_facilitation_script;\n  const hasIndependentPractice = !!lessonPlan.independent_practice?.interactive_blocks?.length;\n  const hasDiscussion = !!lessonPlan.discussion?.questions?.length;\n  const hasSummary = !!lessonPlan.summary?.takeaway_sentence;\n\n  // Check required sections\n  if (!hasHook) {\n    issues.push({\n      type: 'missing',\n      field: 'hook',\n      message: 'Lesson plan missing hook section',\n      messageHe: '××¢×¨×š ×”×©×™×¢×•×¨ ×—×¡×¨ ×¤×ª×™×—',\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  if (!hasDirectInstruction) {\n    issues.push({\n      type: 'missing',\n      field: 'direct_instruction',\n      message: 'Lesson plan missing direct instruction',\n      messageHe: '××¢×¨×š ×”×©×™×¢×•×¨ ×—×¡×¨ ×”×•×¨××” ×™×©×™×¨×”',\n      severity: 'high',\n      autoFixable: false\n    });\n  }\n\n  if (!hasSummary) {\n    issues.push({\n      type: 'missing',\n      field: 'summary',\n      message: 'Lesson plan missing summary',\n      messageHe: '××¢×¨×š ×”×©×™×¢×•×¨ ×—×¡×¨ ×¡×™×›×•×',\n      severity: 'medium',\n      autoFixable: false\n    });\n  }\n\n  // Count slides and media\n  const slides = lessonPlan.direct_instruction?.slides || [];\n  const slideCount = slides.length;\n\n  let mediaAssetCount = 0;\n  let mediaAssetsGenerated = 0;\n  let mediaAssetsFailed = 0;\n\n  // Count media in hook\n  if (lessonPlan.hook?.media_asset) {\n    mediaAssetCount++;\n    if (lessonPlan.hook.media_asset.url) mediaAssetsGenerated++;\n    if (lessonPlan.hook.media_asset.status === 'failed') mediaAssetsFailed++;\n  }\n\n  // Count media in slides\n  slides.forEach(slide => {\n    if (slide.media_asset) {\n      mediaAssetCount++;\n      if (slide.media_asset.url) mediaAssetsGenerated++;\n      if (slide.media_asset.status === 'failed') mediaAssetsFailed++;\n    }\n  });\n\n  // Calculate script word count\n  let scriptWordCount = 0;\n  if (lessonPlan.hook?.script_for_teacher) {\n    scriptWordCount += lessonPlan.hook.script_for_teacher.split(/\\s+/).length;\n  }\n  slides.forEach(slide => {\n    if (slide.script_to_say) {\n      scriptWordCount += slide.script_to_say.split(/\\s+/).length;\n    }\n  });\n\n  // Estimate duration (rough: 120 words per minute)\n  const estimatedDuration = Math.ceil(scriptWordCount / 120);\n\n  // Get bloom levels used\n  const bloomLevelsUsed: string[] = [];\n  // This would need actual block analysis\n\n  // Calculate overall score\n  let score = 100;\n  if (!hasHook) score -= 10;\n  if (!hasDirectInstruction) score -= 25;\n  if (!hasGuidedPractice) score -= 15;\n  if (!hasIndependentPractice) score -= 15;\n  if (!hasDiscussion) score -= 10;\n  if (!hasSummary) score -= 10;\n  if (slideCount < 3) score -= 15;\n\n  return {\n    lessonPlanId: `lp_${courseId}_${Date.now()}`,\n    courseId,\n    hasHook,\n    hasDirectInstruction,\n    hasGuidedPractice,\n    hasIndependentPractice,\n    hasDiscussion,\n    hasSummary,\n    slideCount,\n    mediaAssetCount,\n    mediaAssetsGenerated,\n    mediaAssetsFailed,\n    scriptWordCount,\n    estimatedDuration,\n    bloomLevelsUsed,\n    overallScore: Math.max(0, score),\n    issues\n  };\n}\n\n// ===== MAIN AGENT FUNCTION =====\n\nexport async function runContentQualityAgent(maxCourses: number = 10): Promise<QAAgentResult> {\n  const startTime = Date.now();\n  const allResults: TestResult[] = [];\n\n  console.log('ğŸ” Content Quality Agent starting...');\n\n  try {\n    // Fetch recent courses\n    const coursesQuery = query(\n      collection(db, 'courses'),\n      orderBy('createdAt', 'desc'),\n      limit(maxCourses)\n    );\n    const snapshot = await getDocs(coursesQuery);\n\n    let totalTests = 0;\n    let passedTests = 0;\n    let failedTests = 0;\n    const criticalIssues: TestResult[] = [];\n\n    for (const docSnap of snapshot.docs) {\n      const course = { id: docSnap.id, ...docSnap.data() } as Course;\n      const result = validateCourse(course);\n\n      totalTests++;\n\n      const testResult: TestResult = {\n        id: `content_${course.id}`,\n        name: `Course: ${course.title || course.id}`,\n        nameHe: `×§×•×¨×¡: ${course.title || course.id}`,\n        category: 'content-quality',\n        status: result.valid ? 'passed' : (result.issues.some(i => i.severity === 'critical') ? 'failed' : 'warning'),\n        severity: result.issues.some(i => i.severity === 'critical') ? 'critical' :\n                  result.issues.some(i => i.severity === 'high') ? 'high' : 'medium',\n        message: `Score: ${result.overallScore}% | ${result.unitCount} units, ${result.blockCount} blocks | ${result.issues.length} issues`,\n        messageHe: `×¦×™×•×Ÿ: ${result.overallScore}% | ${result.unitCount} ×™×—×™×“×•×ª, ${result.blockCount} ×‘×œ×•×§×™× | ${result.issues.length} ×‘×¢×™×•×ª`,\n        details: {\n          courseId: course.id,\n          score: result.overallScore,\n          moduleCount: result.moduleCount,\n          unitCount: result.unitCount,\n          blockCount: result.blockCount,\n          issues: result.issues,\n          unitResults: result.unitResults.map(u => ({\n            unitId: u.unitId,\n            title: u.unitTitle,\n            score: u.score,\n            blockCount: u.blockCount,\n            issueCount: u.issues.length\n          }))\n        },\n        duration: 0,\n        timestamp: new Date()\n      };\n\n      allResults.push(testResult);\n\n      if (testResult.status === 'passed') {\n        passedTests++;\n      } else {\n        failedTests++;\n        if (testResult.severity === 'critical') {\n          criticalIssues.push(testResult);\n        }\n      }\n    }\n\n    console.log(`âœ… Content Quality Agent completed: ${passedTests}/${totalTests} courses passed`);\n\n    return {\n      agentType: 'content-quality',\n      success: failedTests === 0,\n      duration: Date.now() - startTime,\n      testsRun: totalTests,\n      testsPassed: passedTests,\n      testsFailed: failedTests,\n      criticalIssues,\n      allResults\n    };\n\n  } catch (error: any) {\n    console.error('âŒ Content Quality Agent failed:', error);\n\n    return {\n      agentType: 'content-quality',\n      success: false,\n      duration: Date.now() - startTime,\n      testsRun: 0,\n      testsPassed: 0,\n      testsFailed: 1,\n      criticalIssues: [{\n        id: 'agent_error',\n        name: 'Content Quality Agent Error',\n        nameHe: '×©×’×™××ª ×¡×•×›×Ÿ ××™×›×•×ª ×ª×•×›×Ÿ',\n        category: 'content-quality',\n        status: 'failed',\n        severity: 'critical',\n        message: error.message,\n        messageHe: error.message,\n        duration: Date.now() - startTime,\n        timestamp: new Date()\n      }],\n      allResults: []\n    };\n  }\n}\n\nexport { validateCourse, validateUnit, validateBlock, validateLessonPlan };\n","/**\n * Student Simulation Agent\n * ×¡×•×›×Ÿ ××“××” ×ª×œ××™×“ - ×¢×•×‘×¨ ×¢×œ ×”×§×•×¨×¡×™× ×›×ª×œ××™×“ ×××™×ª×™ ×•×‘×•×“×§ ×ª×§×™× ×•×ª\n */\n\nimport { db } from '../../firebase';\nimport { collection, getDocs, query, limit, orderBy } from 'firebase/firestore';\nimport type {\n  TestResult,\n  QAAgentResult,\n  StudentSimulationRun,\n  SimulatedStudentProfile,\n  BlockStuckInfo,\n  NavigationIssue,\n  ContentError,\n  UXProblem\n} from '../../types/qa.types';\nimport { DEFAULT_STUDENT_PROFILES } from '../../types/qa.types';\nimport type { Course, LearningUnit, ActivityBlock, Module } from '../../shared/types/courseTypes';\n\n// ===== SIMULATED STUDENT BEHAVIOR =====\n\ninterface StudentAction {\n  type: 'view' | 'answer' | 'skip' | 'hint' | 'retry';\n  blockId: string;\n  answer?: any;\n  correct?: boolean;\n  timeSpent: number; // ms\n}\n\ninterface BlockSimulationResult {\n  blockId: string;\n  blockType: string;\n  completed: boolean;\n  stuck: boolean;\n  stuckReason?: BlockStuckInfo['reason'];\n  error?: ContentError;\n  actions: StudentAction[];\n  timeSpent: number;\n}\n\ninterface UnitSimulationResult {\n  unitId: string;\n  unitTitle: string;\n  completed: boolean;\n  blocksAttempted: number;\n  blocksCompleted: number;\n  blocksStuck: BlockStuckInfo[];\n  contentErrors: ContentError[];\n  totalTime: number;\n  blockResults: BlockSimulationResult[];\n}\n\n// ===== BLOCK SIMULATORS =====\n\nfunction simulateMultipleChoiceBlock(\n  block: ActivityBlock,\n  profile: SimulatedStudentProfile\n): BlockSimulationResult {\n  const startTime = Date.now();\n  const actions: StudentAction[] = [];\n  const content = block.content || {};\n\n  // Check if block is valid\n  const options = content.options || [];\n  const correctAnswer = content.correctAnswer || content.correct_answer;\n\n  if (options.length === 0) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'missing_content',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'missing_data',\n        errorMessage: 'No options available'\n      },\n      actions: [],\n      timeSpent: Date.now() - startTime\n    };\n  }\n\n  if (!correctAnswer) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'no_correct_option',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'missing_data',\n        errorMessage: 'No correct answer defined'\n      },\n      actions: [],\n      timeSpent: Date.now() - startTime\n    };\n  }\n\n  // Simulate reading time\n  const readTime = profile.readContent ?\n    (profile.interactionSpeed === 'slow' ? 5000 : profile.interactionSpeed === 'fast' ? 1000 : 2500) : 500;\n\n  actions.push({\n    type: 'view',\n    blockId: block.id,\n    timeSpent: readTime\n  });\n\n  // Decide if student answers correctly\n  const answersCorrectly = Math.random() < profile.correctAnswerRate;\n\n  // Use hint if struggling and hints available\n  if (!answersCorrectly && profile.useHints && block.metadata?.progressiveHints?.length) {\n    actions.push({\n      type: 'hint',\n      blockId: block.id,\n      timeSpent: 1500\n    });\n  }\n\n  // Submit answer\n  const selectedAnswer = answersCorrectly ? correctAnswer : options[Math.floor(Math.random() * options.length)];\n  const isCorrect = selectedAnswer === correctAnswer;\n\n  actions.push({\n    type: 'answer',\n    blockId: block.id,\n    answer: selectedAnswer,\n    correct: isCorrect,\n    timeSpent: profile.interactionSpeed === 'slow' ? 3000 : profile.interactionSpeed === 'fast' ? 800 : 1500\n  });\n\n  // Retry if wrong and profile is persistent\n  if (!isCorrect && profile.type === 'struggling') {\n    actions.push({\n      type: 'retry',\n      blockId: block.id,\n      timeSpent: 1000\n    });\n    actions.push({\n      type: 'answer',\n      blockId: block.id,\n      answer: correctAnswer,\n      correct: true,\n      timeSpent: 2000\n    });\n  }\n\n  const totalTime = actions.reduce((sum, a) => sum + a.timeSpent, 0);\n\n  return {\n    blockId: block.id,\n    blockType: block.type,\n    completed: true,\n    stuck: false,\n    actions,\n    timeSpent: totalTime\n  };\n}\n\nfunction simulateOpenQuestionBlock(\n  block: ActivityBlock,\n  profile: SimulatedStudentProfile\n): BlockSimulationResult {\n  const startTime = Date.now();\n  const actions: StudentAction[] = [];\n  const content = block.content || {};\n\n  if (!content.question) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'missing_content',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'missing_data',\n        errorMessage: 'No question text'\n      },\n      actions: [],\n      timeSpent: Date.now() - startTime\n    };\n  }\n\n  // Simulate reading\n  const readTime = profile.readContent ? 3000 : 1000;\n  actions.push({\n    type: 'view',\n    blockId: block.id,\n    timeSpent: readTime\n  });\n\n  // Simulate typing answer (longer for open questions)\n  const typingTime = profile.interactionSpeed === 'slow' ? 15000 :\n                     profile.interactionSpeed === 'fast' ? 5000 : 8000;\n\n  actions.push({\n    type: 'answer',\n    blockId: block.id,\n    answer: '[Simulated open answer]',\n    timeSpent: typingTime\n  });\n\n  const totalTime = actions.reduce((sum, a) => sum + a.timeSpent, 0);\n\n  return {\n    blockId: block.id,\n    blockType: block.type,\n    completed: true,\n    stuck: false,\n    actions,\n    timeSpent: totalTime\n  };\n}\n\nfunction simulateOrderingBlock(\n  block: ActivityBlock,\n  profile: SimulatedStudentProfile\n): BlockSimulationResult {\n  const startTime = Date.now();\n  const actions: StudentAction[] = [];\n  const content = block.content || {};\n\n  const correctOrder = content.correct_order || content.correctOrder || [];\n\n  if (correctOrder.length < 2) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'missing_content',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'missing_data',\n        errorMessage: 'Not enough items to order'\n      },\n      actions: [],\n      timeSpent: Date.now() - startTime\n    };\n  }\n\n  actions.push({\n    type: 'view',\n    blockId: block.id,\n    timeSpent: profile.readContent ? 2000 : 500\n  });\n\n  // Simulate drag and drop actions\n  const interactionTime = correctOrder.length * (profile.interactionSpeed === 'slow' ? 2000 : 1000);\n  actions.push({\n    type: 'answer',\n    blockId: block.id,\n    answer: correctOrder, // Simulated correct order\n    correct: Math.random() < profile.correctAnswerRate,\n    timeSpent: interactionTime\n  });\n\n  const totalTime = actions.reduce((sum, a) => sum + a.timeSpent, 0);\n\n  return {\n    blockId: block.id,\n    blockType: block.type,\n    completed: true,\n    stuck: false,\n    actions,\n    timeSpent: totalTime\n  };\n}\n\nfunction simulateCategorizationBlock(\n  block: ActivityBlock,\n  profile: SimulatedStudentProfile\n): BlockSimulationResult {\n  const startTime = Date.now();\n  const actions: StudentAction[] = [];\n  const content = block.content || {};\n\n  const categories = content.categories || [];\n  const items = content.items || [];\n\n  if (categories.length < 2 || items.length === 0) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'missing_content',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'missing_data',\n        errorMessage: 'Missing categories or items'\n      },\n      actions: [],\n      timeSpent: Date.now() - startTime\n    };\n  }\n\n  actions.push({\n    type: 'view',\n    blockId: block.id,\n    timeSpent: profile.readContent ? 3000 : 1000\n  });\n\n  const interactionTime = items.length * (profile.interactionSpeed === 'slow' ? 1500 : 800);\n  actions.push({\n    type: 'answer',\n    blockId: block.id,\n    correct: Math.random() < profile.correctAnswerRate,\n    timeSpent: interactionTime\n  });\n\n  const totalTime = actions.reduce((sum, a) => sum + a.timeSpent, 0);\n\n  return {\n    blockId: block.id,\n    blockType: block.type,\n    completed: true,\n    stuck: false,\n    actions,\n    timeSpent: totalTime\n  };\n}\n\nfunction simulateMemoryGameBlock(\n  block: ActivityBlock,\n  profile: SimulatedStudentProfile\n): BlockSimulationResult {\n  const startTime = Date.now();\n  const actions: StudentAction[] = [];\n  const content = block.content || {};\n\n  const pairs = content.pairs || content.cards || [];\n\n  if (pairs.length < 2) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'missing_content',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'missing_data',\n        errorMessage: 'Not enough pairs for memory game'\n      },\n      actions: [],\n      timeSpent: Date.now() - startTime\n    };\n  }\n\n  actions.push({\n    type: 'view',\n    blockId: block.id,\n    timeSpent: 1000\n  });\n\n  // Simulate playing memory game (time based on pairs and skill)\n  const baseTime = pairs.length * 3000;\n  const skillMultiplier = profile.type === 'advanced' ? 0.6 : profile.type === 'struggling' ? 1.5 : 1;\n  const playTime = Math.round(baseTime * skillMultiplier);\n\n  actions.push({\n    type: 'answer',\n    blockId: block.id,\n    correct: true, // Memory games always complete eventually\n    timeSpent: playTime\n  });\n\n  const totalTime = actions.reduce((sum, a) => sum + a.timeSpent, 0);\n\n  return {\n    blockId: block.id,\n    blockType: block.type,\n    completed: true,\n    stuck: false,\n    actions,\n    timeSpent: totalTime\n  };\n}\n\nfunction simulateMediaBlock(\n  block: ActivityBlock,\n  profile: SimulatedStudentProfile\n): BlockSimulationResult {\n  const startTime = Date.now();\n  const actions: StudentAction[] = [];\n\n  if (!block.content) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'missing_content',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'missing_data',\n        errorMessage: 'No media content/URL'\n      },\n      actions: [],\n      timeSpent: Date.now() - startTime\n    };\n  }\n\n  // Simulate viewing media\n  const viewTime = block.type === 'video' ? 30000 :\n                   block.type === 'text' ? 5000 :\n                   block.type === 'image' ? 3000 : 10000;\n\n  const adjustedTime = profile.readContent ? viewTime : Math.round(viewTime * 0.3);\n\n  actions.push({\n    type: 'view',\n    blockId: block.id,\n    timeSpent: adjustedTime\n  });\n\n  return {\n    blockId: block.id,\n    blockType: block.type,\n    completed: true,\n    stuck: false,\n    actions,\n    timeSpent: adjustedTime\n  };\n}\n\nfunction simulateBlock(\n  block: ActivityBlock,\n  profile: SimulatedStudentProfile\n): BlockSimulationResult {\n  try {\n    switch (block.type) {\n      case 'multiple-choice':\n        return simulateMultipleChoiceBlock(block, profile);\n      case 'open-question':\n        return simulateOpenQuestionBlock(block, profile);\n      case 'ordering':\n        return simulateOrderingBlock(block, profile);\n      case 'categorization':\n        return simulateCategorizationBlock(block, profile);\n      case 'memory_game':\n        return simulateMemoryGameBlock(block, profile);\n      case 'text':\n      case 'video':\n      case 'image':\n      case 'pdf':\n        return simulateMediaBlock(block, profile);\n      default:\n        // Generic block handling\n        return {\n          blockId: block.id,\n          blockType: block.type,\n          completed: true,\n          stuck: false,\n          actions: [{ type: 'view', blockId: block.id, timeSpent: 2000 }],\n          timeSpent: 2000\n        };\n    }\n  } catch (error: any) {\n    return {\n      blockId: block.id,\n      blockType: block.type,\n      completed: false,\n      stuck: true,\n      stuckReason: 'error_thrown',\n      error: {\n        blockId: block.id,\n        blockType: block.type,\n        errorType: 'crash',\n        errorMessage: error.message,\n        stackTrace: error.stack\n      },\n      actions: [],\n      timeSpent: 0\n    };\n  }\n}\n\n// ===== UNIT SIMULATOR =====\n\nfunction simulateUnit(\n  unit: LearningUnit,\n  profile: SimulatedStudentProfile\n): UnitSimulationResult {\n  const blocks = unit.activityBlocks || [];\n  const blockResults: BlockSimulationResult[] = [];\n  const blocksStuck: BlockStuckInfo[] = [];\n  const contentErrors: ContentError[] = [];\n\n  let blocksCompleted = 0;\n  let totalTime = 0;\n\n  for (const block of blocks) {\n    const result = simulateBlock(block, profile);\n    blockResults.push(result);\n    totalTime += result.timeSpent;\n\n    if (result.completed) {\n      blocksCompleted++;\n    }\n\n    if (result.stuck && result.stuckReason) {\n      blocksStuck.push({\n        blockId: block.id,\n        blockType: block.type,\n        reason: result.stuckReason,\n        errorMessage: result.error?.errorMessage\n      });\n    }\n\n    if (result.error) {\n      contentErrors.push(result.error);\n    }\n  }\n\n  return {\n    unitId: unit.id,\n    unitTitle: unit.title,\n    completed: blocksCompleted === blocks.length && blocks.length > 0,\n    blocksAttempted: blocks.length,\n    blocksCompleted,\n    blocksStuck,\n    contentErrors,\n    totalTime,\n    blockResults\n  };\n}\n\n// ===== COURSE SIMULATOR =====\n\nfunction simulateCourse(\n  course: Course,\n  profile: SimulatedStudentProfile\n): StudentSimulationRun {\n  const startedAt = new Date();\n  const modules = course.syllabus || [];\n\n  let unitsAttempted = 0;\n  let unitsCompleted = 0;\n  let blocksAttempted = 0;\n  let blocksCompleted = 0;\n  const allBlocksStuck: BlockStuckInfo[] = [];\n  const allContentErrors: ContentError[] = [];\n  const allUxProblems: UXProblem[] = [];\n  const navigationIssues: NavigationIssue[] = [];\n  let totalTime = 0;\n\n  // Check for empty course\n  if (modules.length === 0) {\n    allUxProblems.push({\n      location: `course_${course.id}`,\n      problemType: 'confusing_ui',\n      description: 'Course has no modules to navigate',\n      severity: 'high'\n    });\n  }\n\n  for (const module of modules) {\n    const units = module.learningUnits || [];\n\n    if (units.length === 0) {\n      allUxProblems.push({\n        location: `module_${module.id}`,\n        problemType: 'confusing_ui',\n        description: `Module \"${module.title}\" has no units`,\n        severity: 'medium'\n      });\n      continue;\n    }\n\n    for (let i = 0; i < units.length; i++) {\n      const unit = units[i];\n      unitsAttempted++;\n\n      const unitResult = simulateUnit(unit, profile);\n      blocksAttempted += unitResult.blocksAttempted;\n      blocksCompleted += unitResult.blocksCompleted;\n      totalTime += unitResult.totalTime;\n\n      if (unitResult.completed) {\n        unitsCompleted++;\n      }\n\n      allBlocksStuck.push(...unitResult.blocksStuck);\n      allContentErrors.push(...unitResult.contentErrors);\n\n      // Check navigation to next unit\n      if (i < units.length - 1 && unitResult.blocksStuck.length > 0) {\n        // If stuck, check if can still navigate forward\n        navigationIssues.push({\n          fromUnit: unit.id,\n          toUnit: units[i + 1].id,\n          issue: 'progress_not_saved',\n          details: 'Student got stuck but progress may not be saved correctly'\n        });\n      }\n    }\n  }\n\n  const avgTimePerBlock = blocksAttempted > 0 ? Math.round(totalTime / blocksAttempted) : 0;\n  const errorRate = blocksAttempted > 0 ? Math.round((allBlocksStuck.length / blocksAttempted) * 100) : 0;\n  const completionRate = blocksAttempted > 0 ? Math.round((blocksCompleted / blocksAttempted) * 100) : 0;\n\n  return {\n    id: `sim_${course.id}_${Date.now()}`,\n    courseId: course.id,\n    simulationType: 'full_course',\n    studentProfile: profile,\n    startedAt,\n    completedAt: new Date(),\n    status: allBlocksStuck.length > 0 ? 'stuck' : 'completed',\n    unitsAttempted,\n    unitsCompleted,\n    blocksAttempted,\n    blocksCompleted,\n    blocksStuck: allBlocksStuck,\n    navigationIssues,\n    contentErrors: allContentErrors,\n    uxProblems: allUxProblems,\n    averageTimePerBlock: avgTimePerBlock,\n    errorRate,\n    completionRate\n  };\n}\n\n// ===== MAIN AGENT FUNCTION =====\n\nexport async function runStudentSimulationAgent(\n  maxCourses: number = 5,\n  profiles: SimulatedStudentProfile[] = [\n    { type: 'average', correctAnswerRate: 0.7, useHints: false, readContent: true, interactionSpeed: 'normal' }\n  ]\n): Promise<QAAgentResult> {\n  const startTime = Date.now();\n  const allResults: TestResult[] = [];\n\n  console.log('ğŸ“ Student Simulation Agent starting...');\n  console.log(`   Testing with ${profiles.length} student profile(s)...`);\n\n  try {\n    // Fetch recent courses\n    const coursesQuery = query(\n      collection(db, 'courses'),\n      orderBy('createdAt', 'desc'),\n      limit(maxCourses)\n    );\n    const snapshot = await getDocs(coursesQuery);\n\n    let totalTests = 0;\n    let passedTests = 0;\n    let failedTests = 0;\n    const criticalIssues: TestResult[] = [];\n\n    for (const docSnap of snapshot.docs) {\n      const course = { id: docSnap.id, ...docSnap.data() } as Course;\n\n      for (const profile of profiles) {\n        totalTests++;\n        const simulation = simulateCourse(course, profile);\n\n        const hasCriticalIssues = simulation.contentErrors.length > 0 ||\n                                   simulation.blocksStuck.some(b => b.reason === 'error_thrown');\n        const hasIssues = simulation.blocksStuck.length > 0 || simulation.uxProblems.length > 0;\n\n        const status = hasCriticalIssues ? 'failed' :\n                       hasIssues ? 'warning' : 'passed';\n\n        const testResult: TestResult = {\n          id: `sim_${course.id}_${profile.type}`,\n          name: `[${profile.type}] ${course.title || course.id}`,\n          nameHe: `[${profile.type}] ${course.title || course.id}`,\n          category: 'student-simulation',\n          status,\n          severity: hasCriticalIssues ? 'critical' : hasIssues ? 'medium' : 'low',\n          message: `Completion: ${simulation.completionRate}% | Stuck: ${simulation.blocksStuck.length} | Errors: ${simulation.contentErrors.length}`,\n          messageHe: `×”×©×œ××”: ${simulation.completionRate}% | ×ª×§×•×¢: ${simulation.blocksStuck.length} | ×©×’×™××•×ª: ${simulation.contentErrors.length}`,\n          details: {\n            courseId: course.id,\n            profile: profile.type,\n            unitsAttempted: simulation.unitsAttempted,\n            unitsCompleted: simulation.unitsCompleted,\n            blocksAttempted: simulation.blocksAttempted,\n            blocksCompleted: simulation.blocksCompleted,\n            completionRate: simulation.completionRate,\n            errorRate: simulation.errorRate,\n            avgTimePerBlock: simulation.averageTimePerBlock,\n            blocksStuck: simulation.blocksStuck,\n            contentErrors: simulation.contentErrors,\n            uxProblems: simulation.uxProblems,\n            navigationIssues: simulation.navigationIssues\n          },\n          duration: simulation.completedAt ?\n            simulation.completedAt.getTime() - simulation.startedAt.getTime() : 0,\n          timestamp: new Date()\n        };\n\n        allResults.push(testResult);\n\n        if (status === 'passed') {\n          passedTests++;\n        } else {\n          failedTests++;\n          if (hasCriticalIssues) {\n            criticalIssues.push(testResult);\n          }\n        }\n      }\n    }\n\n    console.log(`âœ… Student Simulation completed: ${passedTests}/${totalTests} passed`);\n\n    return {\n      agentType: 'student-simulation',\n      success: criticalIssues.length === 0,\n      duration: Date.now() - startTime,\n      testsRun: totalTests,\n      testsPassed: passedTests,\n      testsFailed: failedTests,\n      criticalIssues,\n      allResults\n    };\n\n  } catch (error: any) {\n    console.error('âŒ Student Simulation Agent failed:', error);\n\n    return {\n      agentType: 'student-simulation',\n      success: false,\n      duration: Date.now() - startTime,\n      testsRun: 0,\n      testsPassed: 0,\n      testsFailed: 1,\n      criticalIssues: [{\n        id: 'sim_agent_error',\n        name: 'Student Simulation Error',\n        nameHe: '×©×’×™××ª ×¡×™××•×œ×¦×™×™×ª ×ª×œ××™×“',\n        category: 'student-simulation',\n        status: 'failed',\n        severity: 'critical',\n        message: error.message,\n        messageHe: error.message,\n        duration: Date.now() - startTime,\n        timestamp: new Date()\n      }],\n      allResults: []\n    };\n  }\n}\n\nexport { simulateCourse, simulateUnit, simulateBlock };\n","/**\r\n * AI Generation Agent\r\n * ×¡×•×›×Ÿ ×‘×•×“×§ ×™×¦×™×¨×ª ×ª×•×›×Ÿ AI - ×‘×•×“×§ ××”×™×¨×•×ª ×•××™×›×•×ª ×”×™×¦×™×¨×”\r\n */\r\n\r\nimport { db } from '../../firebase';\r\nimport { collection, getDocs, query, limit, orderBy } from 'firebase/firestore';\r\nimport type {\r\n  TestResult,\r\n  QAAgentResult,\r\n  AIGenerationTest,\r\n  AIGenerationIssue\r\n} from '../../types/qa.types';\r\n\r\n// Import generation functions\r\nimport {\r\n  generateSingleMultipleChoiceQuestion,\r\n  generateSingleOpenQuestion,\r\n  generateCategorizationQuestion,\r\n  generateOrderingQuestion,\r\n  generateMemoryGame,\r\n  generateFillInBlanksQuestion\r\n} from '../../gemini';\r\n\r\n// ===== TEST PARAMETERS =====\r\n\r\nconst TEST_TOPICS = [\r\n  { topic: '××œ×—××ª ×”×¢×•×œ× ×”×©× ×™×™×”', gradeLevel: '×˜', subject: '×”×™×¡×˜×•×¨×™×”' },\r\n  { topic: '×¤×•×˜×•×¡×™× ×ª×–×”', gradeLevel: '×–', subject: '××“×¢×™×' },\r\n  { topic: '××©×•×•××•×ª ×¨×™×‘×•×¢×™×•×ª', gradeLevel: '×™', subject: '××ª××˜×™×§×”' },\r\n];\r\n\r\nconst SAMPLE_SOURCE_TEXT = `\r\n×¤×•×˜×•×¡×™× ×ª×–×” ×”×™× ×ª×”×œ×™×š ×‘×™×•×›×™××™ ×©×‘×• ×¦××—×™×, ××¦×•×ª ×•×—×™×™×“×§×™× ××¡×•×™××™× ×”×•×¤×›×™× ××•×¨ ×©××© ×œ×× ×¨×’×™×” ×›×™××™×ª.\r\n×”×ª×”×œ×™×š ××ª×¨×—×© ×‘×›×œ×•×¨×•×¤×œ×¡×˜×™× ×©×œ ×”×ª× ×”×¦××—×™, ×©× ×§×™×™× ×”×¤×™×’×× ×˜ ×”×™×¨×•×§ ×›×œ×•×¨×•×¤×™×œ.\r\n×‘××”×œ×š ×”×¤×•×˜×•×¡×™× ×ª×–×”, ×”×¦××— ×§×•×œ×˜ ×¤×—××Ÿ ×“×•-×—××¦× ×™ ××”××•×•×™×¨ ×•××™× ××”××“××”, ×•×‘×¢×–×¨×ª ×× ×¨×’×™×™×ª ××•×¨\r\n××™×™×¦×¨ ×’×œ×•×§×•×– ×•×—××¦×Ÿ. ×”×’×œ×•×§×•×– ××©××© ×œ×‘× ×™×™×ª ×¨×§××•×ª ×”×¦××— ×•×œ×™×™×¦×•×¨ ×× ×¨×’×™×”, ×•××™×œ×• ×”×—××¦×Ÿ ××©×ª×—×¨×¨ ×œ××˜××•×¡×¤×™×¨×”.\r\n`;\r\n\r\n// ===== VALIDATION HELPERS =====\r\n\r\nfunction validateMultipleChoiceOutput(output: any): { valid: boolean; issues: AIGenerationIssue[] } {\r\n  const issues: AIGenerationIssue[] = [];\r\n\r\n  if (!output) {\r\n    issues.push({ type: 'invalid_json', message: 'No output returned' });\r\n    return { valid: false, issues };\r\n  }\r\n\r\n  // Check for question\r\n  if (!output.question && !output.content?.question) {\r\n    issues.push({ type: 'empty_field', field: 'question', message: 'Missing question text' });\r\n  }\r\n\r\n  // Check for options\r\n  const options = output.options || output.content?.options || [];\r\n  if (options.length < 2) {\r\n    issues.push({ type: 'schema_mismatch', field: 'options', expected: '2-4 options', actual: `${options.length} options`, message: 'Not enough options' });\r\n  }\r\n\r\n  // Check for correct answer\r\n  const correctAnswer = output.correctAnswer || output.correct_answer || output.content?.correctAnswer;\r\n  if (!correctAnswer) {\r\n    issues.push({ type: 'empty_field', field: 'correctAnswer', message: 'Missing correct answer' });\r\n  }\r\n\r\n  // Check language (Hebrew expected)\r\n  const questionText = output.question || output.content?.question || '';\r\n  const hasHebrew = /[\\u0590-\\u05FF]/.test(questionText);\r\n  if (questionText && !hasHebrew) {\r\n    issues.push({ type: 'wrong_language', expected: 'Hebrew', actual: 'Non-Hebrew', message: 'Question not in Hebrew' });\r\n  }\r\n\r\n  return { valid: issues.length === 0, issues };\r\n}\r\n\r\nfunction validateOpenQuestionOutput(output: any): { valid: boolean; issues: AIGenerationIssue[] } {\r\n  const issues: AIGenerationIssue[] = [];\r\n\r\n  if (!output) {\r\n    issues.push({ type: 'invalid_json', message: 'No output returned' });\r\n    return { valid: false, issues };\r\n  }\r\n\r\n  const question = output.question || output.content?.question || '';\r\n  if (!question || question.length < 10) {\r\n    issues.push({ type: 'content_too_short', field: 'question', message: 'Question too short or missing' });\r\n  }\r\n\r\n  // Check for Hebrew\r\n  const hasHebrew = /[\\u0590-\\u05FF]/.test(question);\r\n  if (question && !hasHebrew) {\r\n    issues.push({ type: 'wrong_language', expected: 'Hebrew', message: 'Question not in Hebrew' });\r\n  }\r\n\r\n  return { valid: issues.length === 0, issues };\r\n}\r\n\r\nfunction validateCategorizationOutput(output: any): { valid: boolean; issues: AIGenerationIssue[] } {\r\n  const issues: AIGenerationIssue[] = [];\r\n\r\n  if (!output) {\r\n    issues.push({ type: 'invalid_json', message: 'No output returned' });\r\n    return { valid: false, issues };\r\n  }\r\n\r\n  const content = output.content || output;\r\n  const categories = content.categories || [];\r\n  const items = content.items || [];\r\n\r\n  if (categories.length < 2) {\r\n    issues.push({ type: 'schema_mismatch', field: 'categories', expected: '2+ categories', actual: `${categories.length}`, message: 'Not enough categories' });\r\n  }\r\n\r\n  if (items.length < categories.length) {\r\n    issues.push({ type: 'schema_mismatch', field: 'items', message: 'Fewer items than categories' });\r\n  }\r\n\r\n  // Check all items have category assignment\r\n  const invalidItems = items.filter((item: any) => !item.category || !categories.includes(item.category));\r\n  if (invalidItems.length > 0) {\r\n    issues.push({ type: 'schema_mismatch', field: 'items', message: `${invalidItems.length} items with invalid category assignment` });\r\n  }\r\n\r\n  return { valid: issues.length === 0, issues };\r\n}\r\n\r\nfunction validateOrderingOutput(output: any): { valid: boolean; issues: AIGenerationIssue[] } {\r\n  const issues: AIGenerationIssue[] = [];\r\n\r\n  if (!output) {\r\n    issues.push({ type: 'invalid_json', message: 'No output returned' });\r\n    return { valid: false, issues };\r\n  }\r\n\r\n  const content = output.content || output;\r\n  const correctOrder = content.correct_order || content.correctOrder || [];\r\n\r\n  if (correctOrder.length < 3) {\r\n    issues.push({ type: 'schema_mismatch', field: 'correct_order', expected: '3+ items', actual: `${correctOrder.length}`, message: 'Not enough items to order' });\r\n  }\r\n\r\n  if (!content.instruction) {\r\n    issues.push({ type: 'empty_field', field: 'instruction', message: 'Missing instruction' });\r\n  }\r\n\r\n  return { valid: issues.length === 0, issues };\r\n}\r\n\r\nfunction validateMemoryGameOutput(output: any): { valid: boolean; issues: AIGenerationIssue[] } {\r\n  const issues: AIGenerationIssue[] = [];\r\n\r\n  if (!output) {\r\n    issues.push({ type: 'invalid_json', message: 'No output returned' });\r\n    return { valid: false, issues };\r\n  }\r\n\r\n  const content = output.content || output;\r\n  const pairs = content.pairs || content.cards || [];\r\n\r\n  if (pairs.length < 4) {\r\n    issues.push({ type: 'schema_mismatch', field: 'pairs', expected: '4+ pairs', actual: `${pairs.length}`, message: 'Not enough pairs for memory game' });\r\n  }\r\n\r\n  // Check pairs have left/right or card_a/card_b\r\n  const invalidPairs = pairs.filter((pair: any) =>\r\n    !(pair.left && pair.right) && !(pair.card_a && pair.card_b) && !(pair.term && pair.definition)\r\n  );\r\n  if (invalidPairs.length > 0) {\r\n    issues.push({ type: 'schema_mismatch', field: 'pairs', message: `${invalidPairs.length} pairs with invalid structure` });\r\n  }\r\n\r\n  return { valid: issues.length === 0, issues };\r\n}\r\n\r\n// ===== INDIVIDUAL TEST RUNNERS =====\r\n\r\nasync function testMultipleChoiceGeneration(\r\n  topic: string,\r\n  gradeLevel: string,\r\n  sourceText?: string,\r\n  timeout: number = 30000\r\n): Promise<AIGenerationTest> {\r\n  const startTime = Date.now();\r\n  const testId = `mc_${Date.now()}`;\r\n\r\n  try {\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const result = await Promise.race([\r\n      generateSingleMultipleChoiceQuestion(topic, gradeLevel, null, sourceText || SAMPLE_SOURCE_TEXT),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    const duration = Date.now() - startTime;\r\n    const validation = validateMultipleChoiceOutput(result);\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'multiple-choice' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: 'completed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: validation.valid,\r\n      schemaMatch: validation.valid,\r\n      contentQualityScore: validation.valid ? 100 : Math.max(0, 100 - (validation.issues.length * 25)),\r\n      issues: validation.issues,\r\n      generatedContent: result\r\n    };\r\n  } catch (error: any) {\r\n    const duration = Date.now() - startTime;\r\n    const isTimeout = error.message === 'Timeout';\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'multiple-choice' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: isTimeout ? 'timeout' : 'failed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: false,\r\n      schemaMatch: false,\r\n      contentQualityScore: 0,\r\n      issues: [{ type: isTimeout ? 'timeout' : 'invalid_json', message: error.message }]\r\n    };\r\n  }\r\n}\r\n\r\nasync function testOpenQuestionGeneration(\r\n  topic: string,\r\n  gradeLevel: string,\r\n  sourceText?: string,\r\n  timeout: number = 30000\r\n): Promise<AIGenerationTest> {\r\n  const startTime = Date.now();\r\n  const testId = `oq_${Date.now()}`;\r\n\r\n  try {\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const result = await Promise.race([\r\n      generateSingleOpenQuestion(topic, gradeLevel, null, sourceText || SAMPLE_SOURCE_TEXT),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    const duration = Date.now() - startTime;\r\n    const validation = validateOpenQuestionOutput(result);\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'open-question' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: 'completed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: validation.valid,\r\n      schemaMatch: validation.valid,\r\n      contentQualityScore: validation.valid ? 100 : Math.max(0, 100 - (validation.issues.length * 25)),\r\n      issues: validation.issues,\r\n      generatedContent: result\r\n    };\r\n  } catch (error: any) {\r\n    const duration = Date.now() - startTime;\r\n    const isTimeout = error.message === 'Timeout';\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'open-question' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: isTimeout ? 'timeout' : 'failed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: false,\r\n      schemaMatch: false,\r\n      contentQualityScore: 0,\r\n      issues: [{ type: isTimeout ? 'timeout' : 'invalid_json', message: error.message }]\r\n    };\r\n  }\r\n}\r\n\r\nasync function testCategorizationGeneration(\r\n  topic: string,\r\n  gradeLevel: string,\r\n  sourceText?: string,\r\n  timeout: number = 30000\r\n): Promise<AIGenerationTest> {\r\n  const startTime = Date.now();\r\n  const testId = `cat_${Date.now()}`;\r\n\r\n  try {\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const result = await Promise.race([\r\n      generateCategorizationQuestion(topic, gradeLevel, sourceText || SAMPLE_SOURCE_TEXT),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    const duration = Date.now() - startTime;\r\n    const validation = validateCategorizationOutput(result);\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'categorization' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: 'completed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: validation.valid,\r\n      schemaMatch: validation.valid,\r\n      contentQualityScore: validation.valid ? 100 : Math.max(0, 100 - (validation.issues.length * 25)),\r\n      issues: validation.issues,\r\n      generatedContent: result\r\n    };\r\n  } catch (error: any) {\r\n    const duration = Date.now() - startTime;\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'categorization' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: error.message === 'Timeout' ? 'timeout' : 'failed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: false,\r\n      schemaMatch: false,\r\n      contentQualityScore: 0,\r\n      issues: [{ type: error.message === 'Timeout' ? 'timeout' : 'invalid_json', message: error.message }]\r\n    };\r\n  }\r\n}\r\n\r\nasync function testOrderingGeneration(\r\n  topic: string,\r\n  gradeLevel: string,\r\n  sourceText?: string,\r\n  timeout: number = 30000\r\n): Promise<AIGenerationTest> {\r\n  const startTime = Date.now();\r\n  const testId = `ord_${Date.now()}`;\r\n\r\n  try {\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const result = await Promise.race([\r\n      generateOrderingQuestion(topic, gradeLevel, sourceText || SAMPLE_SOURCE_TEXT),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    const duration = Date.now() - startTime;\r\n    const validation = validateOrderingOutput(result);\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'ordering' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: 'completed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: validation.valid,\r\n      schemaMatch: validation.valid,\r\n      contentQualityScore: validation.valid ? 100 : Math.max(0, 100 - (validation.issues.length * 25)),\r\n      issues: validation.issues,\r\n      generatedContent: result\r\n    };\r\n  } catch (error: any) {\r\n    const duration = Date.now() - startTime;\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'ordering' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: error.message === 'Timeout' ? 'timeout' : 'failed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: false,\r\n      schemaMatch: false,\r\n      contentQualityScore: 0,\r\n      issues: [{ type: error.message === 'Timeout' ? 'timeout' : 'invalid_json', message: error.message }]\r\n    };\r\n  }\r\n}\r\n\r\nasync function testMemoryGameGeneration(\r\n  topic: string,\r\n  gradeLevel: string,\r\n  sourceText?: string,\r\n  timeout: number = 30000\r\n): Promise<AIGenerationTest> {\r\n  const startTime = Date.now();\r\n  const testId = `mem_${Date.now()}`;\r\n\r\n  try {\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const result = await Promise.race([\r\n      generateMemoryGame(topic, gradeLevel, sourceText || SAMPLE_SOURCE_TEXT),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    const duration = Date.now() - startTime;\r\n    const validation = validateMemoryGameOutput(result);\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'memory_game' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: 'completed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: validation.valid,\r\n      schemaMatch: validation.valid,\r\n      contentQualityScore: validation.valid ? 100 : Math.max(0, 100 - (validation.issues.length * 25)),\r\n      issues: validation.issues,\r\n      generatedContent: result\r\n    };\r\n  } catch (error: any) {\r\n    const duration = Date.now() - startTime;\r\n\r\n    return {\r\n      id: testId,\r\n      testType: 'activity_generation',\r\n      inputParams: { topic, gradeLevel, type: 'memory_game' },\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      status: error.message === 'Timeout' ? 'timeout' : 'failed',\r\n      duration,\r\n      retryCount: 0,\r\n      outputValid: false,\r\n      schemaMatch: false,\r\n      contentQualityScore: 0,\r\n      issues: [{ type: error.message === 'Timeout' ? 'timeout' : 'invalid_json', message: error.message }]\r\n    };\r\n  }\r\n}\r\n\r\n// ===== MAIN AGENT FUNCTION =====\r\n\r\nexport async function runAIGenerationAgent(\r\n  testTypes: ('multiple-choice' | 'open-question' | 'categorization' | 'ordering' | 'memory_game')[] = ['multiple-choice', 'open-question'],\r\n  timeout: number = 30000\r\n): Promise<QAAgentResult> {\r\n  const startTime = Date.now();\r\n  const allResults: TestResult[] = [];\r\n  const allGenerationTests: AIGenerationTest[] = [];\r\n\r\n  console.log('ğŸ¤– AI Generation Agent starting...');\r\n  console.log(`   Testing types: ${testTypes.join(', ')}`);\r\n\r\n  let totalTests = 0;\r\n  let passedTests = 0;\r\n  let failedTests = 0;\r\n  const criticalIssues: TestResult[] = [];\r\n\r\n  // Run tests for each topic\r\n  for (const testTopic of TEST_TOPICS) {\r\n    const { topic, gradeLevel } = testTopic;\r\n\r\n    for (const testType of testTypes) {\r\n      totalTests++;\r\n      let generationTest: AIGenerationTest;\r\n\r\n      switch (testType) {\r\n        case 'multiple-choice':\r\n          generationTest = await testMultipleChoiceGeneration(topic, gradeLevel, SAMPLE_SOURCE_TEXT, timeout);\r\n          break;\r\n        case 'open-question':\r\n          generationTest = await testOpenQuestionGeneration(topic, gradeLevel, SAMPLE_SOURCE_TEXT, timeout);\r\n          break;\r\n        case 'categorization':\r\n          generationTest = await testCategorizationGeneration(topic, gradeLevel, SAMPLE_SOURCE_TEXT, timeout);\r\n          break;\r\n        case 'ordering':\r\n          generationTest = await testOrderingGeneration(topic, gradeLevel, SAMPLE_SOURCE_TEXT, timeout);\r\n          break;\r\n        case 'memory_game':\r\n          generationTest = await testMemoryGameGeneration(topic, gradeLevel, SAMPLE_SOURCE_TEXT, timeout);\r\n          break;\r\n        default:\r\n          continue;\r\n      }\r\n\r\n      allGenerationTests.push(generationTest);\r\n\r\n      const isPassed = generationTest.status === 'completed' && generationTest.outputValid;\r\n      const status = isPassed ? 'passed' :\r\n                     generationTest.status === 'timeout' ? 'warning' : 'failed';\r\n\r\n      const testResult: TestResult = {\r\n        id: generationTest.id,\r\n        name: `[${testType}] ${topic}`,\r\n        nameHe: `[${testType}] ${topic}`,\r\n        category: 'ai-generation',\r\n        status,\r\n        severity: generationTest.status === 'failed' ? 'high' :\r\n                  generationTest.status === 'timeout' ? 'medium' : 'low',\r\n        message: `Duration: ${generationTest.duration}ms | Quality: ${generationTest.contentQualityScore}% | Issues: ${generationTest.issues.length}`,\r\n        messageHe: `××©×š: ${generationTest.duration}ms | ××™×›×•×ª: ${generationTest.contentQualityScore}% | ×‘×¢×™×•×ª: ${generationTest.issues.length}`,\r\n        details: {\r\n          testType,\r\n          topic,\r\n          gradeLevel,\r\n          duration: generationTest.duration,\r\n          qualityScore: generationTest.contentQualityScore,\r\n          outputValid: generationTest.outputValid,\r\n          issues: generationTest.issues,\r\n          generatedContentPreview: generationTest.generatedContent ?\r\n            JSON.stringify(generationTest.generatedContent).substring(0, 200) + '...' : null\r\n        },\r\n        duration: generationTest.duration,\r\n        timestamp: new Date()\r\n      };\r\n\r\n      allResults.push(testResult);\r\n\r\n      if (isPassed) {\r\n        passedTests++;\r\n      } else {\r\n        failedTests++;\r\n        if (generationTest.status === 'failed') {\r\n          criticalIssues.push(testResult);\r\n        }\r\n      }\r\n\r\n      // Small delay between API calls to avoid rate limiting\r\n      await new Promise(resolve => setTimeout(resolve, 500));\r\n    }\r\n  }\r\n\r\n  // Calculate performance metrics\r\n  const avgDuration = allGenerationTests.length > 0 ?\r\n    Math.round(allGenerationTests.reduce((sum, t) => sum + t.duration, 0) / allGenerationTests.length) : 0;\r\n  const avgQuality = allGenerationTests.length > 0 ?\r\n    Math.round(allGenerationTests.reduce((sum, t) => sum + t.contentQualityScore, 0) / allGenerationTests.length) : 0;\r\n\r\n  console.log(`âœ… AI Generation Agent completed:`);\r\n  console.log(`   Passed: ${passedTests}/${totalTests}`);\r\n  console.log(`   Avg Duration: ${avgDuration}ms`);\r\n  console.log(`   Avg Quality: ${avgQuality}%`);\r\n\r\n  // Add summary test result\r\n  allResults.push({\r\n    id: 'ai_gen_summary',\r\n    name: 'AI Generation Summary',\r\n    nameHe: '×¡×™×›×•× ×™×¦×™×¨×ª AI',\r\n    category: 'ai-generation',\r\n    status: failedTests === 0 ? 'passed' : failedTests > totalTests / 2 ? 'failed' : 'warning',\r\n    severity: 'info',\r\n    message: `Avg Duration: ${avgDuration}ms | Avg Quality: ${avgQuality}% | Pass Rate: ${Math.round((passedTests / totalTests) * 100)}%`,\r\n    messageHe: `××©×š ×××•×¦×¢: ${avgDuration}ms | ××™×›×•×ª ×××•×¦×¢×ª: ${avgQuality}% | ××—×•×– ×”×¦×œ×—×”: ${Math.round((passedTests / totalTests) * 100)}%`,\r\n    details: {\r\n      avgDuration,\r\n      avgQuality,\r\n      passRate: Math.round((passedTests / totalTests) * 100),\r\n      testsPerType: testTypes.map(type => ({\r\n        type,\r\n        count: allGenerationTests.filter(t => t.inputParams.type === type).length\r\n      }))\r\n    },\r\n    duration: Date.now() - startTime,\r\n    timestamp: new Date()\r\n  });\r\n\r\n  return {\r\n    agentType: 'ai-generation',\r\n    success: failedTests === 0,\r\n    duration: Date.now() - startTime,\r\n    testsRun: totalTests,\r\n    testsPassed: passedTests,\r\n    testsFailed: failedTests,\r\n    criticalIssues,\r\n    allResults\r\n  };\r\n}\r\n\r\nexport {\r\n  testMultipleChoiceGeneration,\r\n  testOpenQuestionGeneration,\r\n  testCategorizationGeneration,\r\n  testOrderingGeneration,\r\n  testMemoryGameGeneration,\r\n  validateMultipleChoiceOutput,\r\n  validateOpenQuestionOutput\r\n};\r\n","/**\r\n * E2E Generation Agent (End-to-End Content Generation Testing)\r\n * ×¡×•×›×Ÿ ×‘×“×™×§×•×ª ×™×¦×™×¨×ª ×ª×•×›×Ÿ ××§×¦×” ×œ×§×¦×”\r\n *\r\n * ××“××” ××•×¨×” ×××™×ª×™ ×©××©×ª××© ×‘××¢×¨×›×ª ×œ×™×¦×™×¨×ª ×ª×›× ×™×:\r\n * - ×”×¢×œ××ª PDF â†’ ××¢×¨×š ×©×™×¢×•×¨\r\n * - ×§×™×©×•×¨ YouTube â†’ ××¢×¨×š ×©×™×¢×•×¨\r\n * - ×˜×§×¡×˜ ×—×•×¤×©×™ â†’ ×¤×•×“×§××¡×˜\r\n * - × ×•×©× ×—×•×¤×©×™ â†’ ×¤×¢×™×œ×•×ª ×œ×ª×œ××™×“\r\n * - ×•×¢×•×“...\r\n */\r\n\r\nimport type {\r\n  TestResult,\r\n  QAAgentResult,\r\n} from '../../types/qa.types';\r\n\r\n// Import generation functions from gemini\r\nimport {\r\n  generateCourseSyllabus,\r\n  generatePodcastScript,\r\n  generateSingleMultipleChoiceQuestion,\r\n  generateSingleOpenQuestion,\r\n  generateCategorizationQuestion,\r\n  generateOrderingQuestion,\r\n} from '../../gemini';\r\n\r\n// Import multimodal service for YouTube transcription\r\nimport { MultimodalService, TRANSCRIPTION_ERROR_CODES } from '../multimodalService';\r\n\r\n// ===== TEST DATA =====\r\n\r\n// Sample source texts for different subjects\r\nconst SAMPLE_SOURCES = {\r\n  history: {\r\n    topic: '××œ×—××ª ×”×¢×•×œ× ×”×©× ×™×™×”',\r\n    gradeLevel: '×˜',\r\n    subject: '×”×™×¡×˜×•×¨×™×”',\r\n    text: `\r\n××œ×—××ª ×”×¢×•×œ× ×”×©× ×™×™×” ×”×™×™×ª×” ×”×¡×›×¡×•×š ×”×¦×‘××™ ×”×’×“×•×œ ×•×”×§×˜×œ× ×™ ×‘×™×•×ª×¨ ×‘×”×™×¡×˜×•×¨×™×” ×”×× ×•×©×™×ª.\r\n×”××œ×—××” ×”×ª× ×”×œ×” ×‘×™×Ÿ ×©×ª×™ ×‘×¨×™×ª ×¦×‘××™×•×ª: ××¢×¦××•×ª ×”×¦×™×¨ (×’×¨×× ×™×”, ××™×˜×œ×™×” ×•×™×¤×Ÿ) ×•×‘×¢×œ×•×ª ×”×‘×¨×™×ª (×‘×¨×™×˜× ×™×”, ×‘×¨×™×ª ×”××•×¢×¦×•×ª, ××¨×¦×•×ª ×”×‘×¨×™×ª ×•×¦×¨×¤×ª).\r\n×”××œ×—××” ×”×—×œ×” ×‘-1 ×‘×¡×¤×˜××‘×¨ 1939 ×¢× ×¤×œ×™×©×ª ×’×¨×× ×™×” ×”× ××¦×™×ª ×œ×¤×•×œ×™×Ÿ ×•×”×¡×ª×™×™××” ×‘-2 ×‘×¡×¤×˜××‘×¨ 1945 ×¢× ×›× ×™×¢×ª ×™×¤×Ÿ.\r\n×‘××”×œ×š ×”××œ×—××” ×”×ª×¨×—×©×” ×”×©×•××” - ×¨×¦×— ×©×™×˜×ª×™ ×©×œ ×©×™×©×” ××™×œ×™×•×Ÿ ×™×”×•×“×™× ×¢×œ ×™×“×™ ×”× ××¦×™×.\r\n×”××œ×—××” ×”×‘×™××” ×œ×©×™× ×•×™×™× ×’×™××•×¤×•×œ×™×˜×™×™× ×¢×¦×•××™× ×•×”×•×‘×™×œ×” ×œ×”×§××ª ×”××•\"× ×•×œ××œ×—××” ×”×§×¨×”.\r\n    `.trim()\r\n  },\r\n  science: {\r\n    topic: '×¤×•×˜×•×¡×™× ×ª×–×”',\r\n    gradeLevel: '×–',\r\n    subject: '××“×¢×™×',\r\n    text: `\r\n×¤×•×˜×•×¡×™× ×ª×–×” ×”×™× ×ª×”×œ×™×š ×‘×™×•×›×™××™ ×©×‘×• ×¦××—×™×, ××¦×•×ª ×•×—×™×™×“×§×™× ××¡×•×™××™× ×”×•×¤×›×™× ××•×¨ ×©××© ×œ×× ×¨×’×™×” ×›×™××™×ª.\r\n×”×ª×”×œ×™×š ××ª×¨×—×© ×‘×›×œ×•×¨×•×¤×œ×¡×˜×™× ×©×œ ×”×ª× ×”×¦××—×™, ×©× ×§×™×™× ×”×¤×™×’×× ×˜ ×”×™×¨×•×§ ×›×œ×•×¨×•×¤×™×œ.\r\n×‘××”×œ×š ×”×¤×•×˜×•×¡×™× ×ª×–×”, ×”×¦××— ×§×•×œ×˜ ×¤×—××Ÿ ×“×•-×—××¦× ×™ ××”××•×•×™×¨ ×•××™× ××”××“××”, ×•×‘×¢×–×¨×ª ×× ×¨×’×™×™×ª ××•×¨\r\n××™×™×¦×¨ ×’×œ×•×§×•×– ×•×—××¦×Ÿ. ×”×’×œ×•×§×•×– ××©××© ×œ×‘× ×™×™×ª ×¨×§××•×ª ×”×¦××— ×•×œ×™×™×¦×•×¨ ×× ×¨×’×™×”.\r\n×”×—××¦×Ÿ ××©×ª×—×¨×¨ ×œ××˜××•×¡×¤×™×¨×” ×•××©××© ×œ× ×©×™××” ×©×œ ×‘×¢×œ×™ ×—×™×™× ×•×‘× ×™ ××“×.\r\n×”××©×•×•××” ×”×›×œ×œ×™×ª: 6CO2 + 6H2O + ××•×¨ â†’ C6H12O6 + 6O2\r\n    `.trim()\r\n  },\r\n  math: {\r\n    topic: '××©×•×•××•×ª ×¨×™×‘×•×¢×™×•×ª',\r\n    gradeLevel: '×™',\r\n    subject: '××ª××˜×™×§×”',\r\n    text: `\r\n××©×•×•××” ×¨×™×‘×•×¢×™×ª ×”×™× ××©×•×•××” ××”×¦×•×¨×” axÂ² + bx + c = 0, ×›××©×¨ a â‰  0.\r\n×”×¤×ª×¨×•× ×•×ª ×©×œ ×”××©×•×•××” × ×§×¨××™× ×©×•×¨×©×™× ×•××¡×•×× ×™× xâ‚ ×•-xâ‚‚.\r\n× ×•×¡×—×ª ×”×©×•×¨×©×™×: x = (-b Â± âˆš(bÂ²-4ac)) / 2a\r\n×”×‘×™×˜×•×™ Î” = bÂ² - 4ac × ×§×¨× ×“×™×¡×§×¨×™××™× × ×˜×” ×•×§×•×‘×¢ ××ª ××¡×¤×¨ ×”×¤×ª×¨×•× ×•×ª:\r\n- ×× Î” > 0: ×©× ×™ ×¤×ª×¨×•× ×•×ª ×©×•× ×™×\r\n- ×× Î” = 0: ×¤×ª×¨×•×Ÿ ×™×—×™×“ (×©×•×¨×© ×›×¤×•×œ)\r\n- ×× Î” < 0: ××™×Ÿ ×¤×ª×¨×•× ×•×ª ×××©×™×™×\r\n××©×•×•××•×ª ×¨×™×‘×•×¢×™×•×ª ××•×¤×™×¢×•×ª ×‘×‘×¢×™×•×ª ×¤×™×–×™×§×œ×™×•×ª ×¨×‘×•×ª ×›××• ×ª× ×•×¢×” ×‘×›×•×— ×”×›×‘×™×“×”.\r\n    `.trim()\r\n  },\r\n  literature: {\r\n    topic: '×©×™×¨×ª ×‘×™××œ×™×§',\r\n    gradeLevel: '×—',\r\n    subject: '×¡×¤×¨×•×ª',\r\n    text: `\r\n×—×™×™× × ×—××Ÿ ×‘×™××œ×™×§ (1873-1934) × ×—×©×‘ ×œ××©×•×¨×¨ ×”×œ××•××™ ×©×œ ×”×¢× ×”×™×”×•×“×™.\r\n×©×™×¨×ª×• ××©×œ×‘×ª ××•×˜×™×‘×™× ××”××¡×•×¨×ª ×”×™×”×•×“×™×ª ×¢× ×¨×’×©×•×ª ××™×©×™×™× ×•×œ××•××™×™×.\r\n×”×©×™×¨ \"××œ ×”×¦×™×¤×•×¨\" ××‘×™×¢ ×’×¢×’×•×¢×™× ×œ××¨×¥ ×™×©×¨××œ ×•×ª×§×•×•×” ×œ×©×™×‘×ª ×¦×™×•×Ÿ.\r\n×‘×©×™×¨ \"×‘×¢×™×¨ ×”×”×¨×’×”\" ××ª××¨ ×‘×™××œ×™×§ ××ª ×¤×¨×¢×•×ª ×§×™×©×™× ×‘ ×•××‘×§×¨ ××ª ×”×¤×¡×™×‘×™×•×ª ×”×™×”×•×“×™×ª.\r\n×‘×™××œ×™×§ ×›×ª×‘ ×’× ×©×™×¨×™ ×™×œ×“×™× ×›××• \"×¦×¤ ×¦×¤ ×¦×¤×¨×“×¢×™×\" ×”××ª××¨ ×¡×™×¤×•×¨ ××”×’×“×” ×©×œ ×¤×¡×—.\r\n×©×¤×ª×• ×¢×©×™×¨×” ×•××œ×™×¦×™×ª, ××©×œ×‘×ª ×¢×‘×¨×™×ª ××§×¨××™×ª ×¢× ×¢×‘×¨×™×ª ××•×“×¨× ×™×ª.\r\n    `.trim()\r\n  }\r\n};\r\n\r\n// Sample YouTube URLs for testing (real educational content in Hebrew)\r\nconst SAMPLE_YOUTUBE_SOURCES = {\r\n  // Khan Academy Hebrew - Math\r\n  math: {\r\n    url: 'https://www.youtube.com/watch?v=NybHckSEQBI', // ×§××Ÿ ××§×“××™ - ××©×•×•××•×ª\r\n    topic: '××©×•×•××•×ª',\r\n    gradeLevel: '×—',\r\n    subject: '××ª××˜×™×§×”',\r\n    expectedMinLength: 100 // Minimum expected transcript length\r\n  },\r\n  // Educational content - Science\r\n  science: {\r\n    url: 'https://www.youtube.com/watch?v=0z1rn0KdL3w', // ××“×¢ - Davidson Institute\r\n    topic: '××“×¢',\r\n    gradeLevel: '×–',\r\n    subject: '××“×¢×™×',\r\n    expectedMinLength: 100\r\n  }\r\n};\r\n\r\n// ===== TYPES =====\r\n\r\ninterface E2ETestResult {\r\n  testType: 'lesson_from_text' | 'lesson_from_youtube' | 'podcast' | 'exam' | 'activity' | 'differentiated';\r\n  sourceType: 'text' | 'youtube' | 'pdf' | 'topic';\r\n  subject: string;\r\n  gradeLevel: string;\r\n\r\n  // Timing\r\n  startedAt: Date;\r\n  completedAt: Date;\r\n  duration: number;\r\n\r\n  // Results\r\n  status: 'passed' | 'failed' | 'warning';\r\n  syllabusGenerated: boolean;\r\n  unitsGenerated: number;\r\n  blocksGenerated: number;\r\n\r\n  // Quality metrics\r\n  qualityScore: number; // 0-100\r\n  issues: E2EIssue[];\r\n\r\n  // Output preview (first 500 chars)\r\n  outputPreview: string | null;\r\n}\r\n\r\ninterface E2EIssue {\r\n  type: 'empty_content' | 'missing_blocks' | 'invalid_structure' | 'timeout' | 'api_error' | 'quality_issue';\r\n  message: string;\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n}\r\n\r\n// ===== VALIDATION HELPERS =====\r\n\r\nfunction validateSyllabus(syllabus: any): { valid: boolean; issues: E2EIssue[]; score: number } {\r\n  const issues: E2EIssue[] = [];\r\n  let score = 100;\r\n\r\n  if (!syllabus) {\r\n    issues.push({ type: 'empty_content', message: 'Syllabus is null or undefined', severity: 'critical' });\r\n    return { valid: false, issues, score: 0 };\r\n  }\r\n\r\n  if (!Array.isArray(syllabus) || syllabus.length === 0) {\r\n    issues.push({ type: 'empty_content', message: 'Syllabus has no modules', severity: 'critical' });\r\n    return { valid: false, issues, score: 0 };\r\n  }\r\n\r\n  let totalUnits = 0;\r\n  let totalBlocks = 0;\r\n  let emptyUnits = 0;\r\n\r\n  syllabus.forEach((module: any, mIdx: number) => {\r\n    if (!module.title) {\r\n      issues.push({ type: 'invalid_structure', message: `Module ${mIdx} has no title`, severity: 'medium' });\r\n      score -= 5;\r\n    }\r\n\r\n    const units = module.learningUnits || module.units || [];\r\n    totalUnits += units.length;\r\n\r\n    if (units.length === 0) {\r\n      issues.push({ type: 'missing_blocks', message: `Module \"${module.title || mIdx}\" has no units`, severity: 'high' });\r\n      score -= 10;\r\n    }\r\n\r\n    units.forEach((unit: any, uIdx: number) => {\r\n      if (!unit.title) {\r\n        issues.push({ type: 'invalid_structure', message: `Unit ${mIdx}.${uIdx} has no title`, severity: 'medium' });\r\n        score -= 3;\r\n      }\r\n\r\n      const blocks = unit.activityBlocks || unit.blocks || [];\r\n      totalBlocks += blocks.length;\r\n\r\n      if (blocks.length === 0) {\r\n        emptyUnits++;\r\n      }\r\n    });\r\n  });\r\n\r\n  // Warn if more than 30% of units are empty\r\n  if (totalUnits > 0 && emptyUnits / totalUnits > 0.3) {\r\n    issues.push({\r\n      type: 'quality_issue',\r\n      message: `${emptyUnits}/${totalUnits} units have no blocks (${Math.round(emptyUnits/totalUnits*100)}%)`,\r\n      severity: 'medium'\r\n    });\r\n    score -= 15;\r\n  }\r\n\r\n  return {\r\n    valid: issues.filter(i => i.severity === 'critical').length === 0,\r\n    issues,\r\n    score: Math.max(0, score)\r\n  };\r\n}\r\n\r\nfunction validatePodcastScript(script: any): { valid: boolean; issues: E2EIssue[]; score: number } {\r\n  const issues: E2EIssue[] = [];\r\n  let score = 100;\r\n\r\n  if (!script) {\r\n    issues.push({ type: 'empty_content', message: 'Podcast script is null', severity: 'critical' });\r\n    return { valid: false, issues, score: 0 };\r\n  }\r\n\r\n  // Check for dialogue structure\r\n  const dialogue = script.dialogue || script.turns || script.script || [];\r\n  if (!Array.isArray(dialogue) || dialogue.length < 4) {\r\n    issues.push({ type: 'quality_issue', message: `Script too short: ${dialogue.length} turns`, severity: 'high' });\r\n    score -= 30;\r\n  }\r\n\r\n  // Check for Hebrew content\r\n  const fullText = JSON.stringify(script);\r\n  const hebrewRatio = (fullText.match(/[\\u0590-\\u05FF]/g) || []).length / fullText.length;\r\n  if (hebrewRatio < 0.3) {\r\n    issues.push({ type: 'quality_issue', message: 'Script has insufficient Hebrew content', severity: 'medium' });\r\n    score -= 20;\r\n  }\r\n\r\n  // Check for two speakers\r\n  const speakers = new Set(dialogue.map((turn: any) => turn.speaker || turn.name || turn.host));\r\n  if (speakers.size < 2) {\r\n    issues.push({ type: 'quality_issue', message: 'Script should have 2 speakers/hosts', severity: 'medium' });\r\n    score -= 15;\r\n  }\r\n\r\n  return {\r\n    valid: issues.filter(i => i.severity === 'critical').length === 0,\r\n    issues,\r\n    score: Math.max(0, score)\r\n  };\r\n}\r\n\r\nfunction validateInteractiveBlocks(blocks: any[]): { valid: boolean; issues: E2EIssue[]; score: number } {\r\n  const issues: E2EIssue[] = [];\r\n  let score = 100;\r\n\r\n  if (!blocks || blocks.length === 0) {\r\n    issues.push({ type: 'empty_content', message: 'No interactive blocks generated', severity: 'critical' });\r\n    return { valid: false, issues, score: 0 };\r\n  }\r\n\r\n  let validBlocks = 0;\r\n\r\n  blocks.forEach((block, idx) => {\r\n    if (!block.type) {\r\n      issues.push({ type: 'invalid_structure', message: `Block ${idx} has no type`, severity: 'high' });\r\n      score -= 10;\r\n      return;\r\n    }\r\n\r\n    if (block.type === 'multiple-choice') {\r\n      const content = block.content || {};\r\n      if (!content.question) {\r\n        issues.push({ type: 'invalid_structure', message: `MC block ${idx} has no question`, severity: 'high' });\r\n        score -= 10;\r\n      } else if (!content.options || content.options.length < 2) {\r\n        issues.push({ type: 'invalid_structure', message: `MC block ${idx} has insufficient options`, severity: 'high' });\r\n        score -= 10;\r\n      } else if (!content.correctAnswer) {\r\n        issues.push({ type: 'invalid_structure', message: `MC block ${idx} has no correct answer`, severity: 'high' });\r\n        score -= 10;\r\n      } else {\r\n        // Validate correct answer is in options\r\n        const optionTexts = content.options.map((o: any) => typeof o === 'string' ? o : o.text || o.label);\r\n        if (!optionTexts.includes(content.correctAnswer)) {\r\n          issues.push({ type: 'quality_issue', message: `MC block ${idx}: correct answer not in options`, severity: 'medium' });\r\n          score -= 5;\r\n        } else {\r\n          validBlocks++;\r\n        }\r\n      }\r\n    } else if (block.type === 'open-question') {\r\n      const content = block.content || {};\r\n      if (!content.question || content.question.length < 10) {\r\n        issues.push({ type: 'invalid_structure', message: `Open question ${idx} too short`, severity: 'medium' });\r\n        score -= 5;\r\n      } else {\r\n        validBlocks++;\r\n      }\r\n    } else {\r\n      validBlocks++; // Other types pass by default\r\n    }\r\n  });\r\n\r\n  return {\r\n    valid: validBlocks > 0,\r\n    issues,\r\n    score: Math.max(0, score)\r\n  };\r\n}\r\n\r\n// ===== TEST RUNNERS =====\r\n\r\nasync function testLessonFromText(\r\n  source: typeof SAMPLE_SOURCES.history,\r\n  timeout: number = 60000\r\n): Promise<E2ETestResult> {\r\n  const startTime = Date.now();\r\n  const issues: E2EIssue[] = [];\r\n\r\n  try {\r\n    // Step 1: Generate syllabus structure\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const syllabusResult = await Promise.race([\r\n      generateCourseSyllabus(source.text, source.topic, source.gradeLevel, source.subject),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    if (!syllabusResult) {\r\n      return {\r\n        testType: 'lesson_from_text',\r\n        sourceType: 'text',\r\n        subject: source.subject,\r\n        gradeLevel: source.gradeLevel,\r\n        startedAt: new Date(startTime),\r\n        completedAt: new Date(),\r\n        duration: Date.now() - startTime,\r\n        status: 'failed',\r\n        syllabusGenerated: false,\r\n        unitsGenerated: 0,\r\n        blocksGenerated: 0,\r\n        qualityScore: 0,\r\n        issues: [{ type: 'empty_content', message: 'generateCourseSyllabus returned null', severity: 'critical' }],\r\n        outputPreview: null\r\n      };\r\n    }\r\n\r\n    // Validate syllabus\r\n    const validation = validateSyllabus(syllabusResult);\r\n    issues.push(...validation.issues);\r\n\r\n    // Count units and blocks\r\n    let unitsCount = 0;\r\n    let blocksCount = 0;\r\n    const syllabus = Array.isArray(syllabusResult) ? syllabusResult : [syllabusResult];\r\n    syllabus.forEach((mod: any) => {\r\n      const units = mod.learningUnits || mod.units || [];\r\n      unitsCount += units.length;\r\n      units.forEach((unit: any) => {\r\n        blocksCount += (unit.activityBlocks || unit.blocks || []).length;\r\n      });\r\n    });\r\n\r\n    return {\r\n      testType: 'lesson_from_text',\r\n      sourceType: 'text',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: validation.valid ? (validation.score >= 70 ? 'passed' : 'warning') : 'failed',\r\n      syllabusGenerated: true,\r\n      unitsGenerated: unitsCount,\r\n      blocksGenerated: blocksCount,\r\n      qualityScore: validation.score,\r\n      issues,\r\n      outputPreview: JSON.stringify(syllabusResult).substring(0, 500)\r\n    };\r\n\r\n  } catch (error: any) {\r\n    return {\r\n      testType: 'lesson_from_text',\r\n      sourceType: 'text',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: 'failed',\r\n      syllabusGenerated: false,\r\n      unitsGenerated: 0,\r\n      blocksGenerated: 0,\r\n      qualityScore: 0,\r\n      issues: [{\r\n        type: error.message === 'Timeout' ? 'timeout' : 'api_error',\r\n        message: error.message,\r\n        severity: 'critical'\r\n      }],\r\n      outputPreview: null\r\n    };\r\n  }\r\n}\r\n\r\nasync function testPodcastGeneration(\r\n  source: typeof SAMPLE_SOURCES.history,\r\n  timeout: number = 60000\r\n): Promise<E2ETestResult> {\r\n  const startTime = Date.now();\r\n  const issues: E2EIssue[] = [];\r\n\r\n  try {\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const podcastResult = await Promise.race([\r\n      generatePodcastScript(source.text, source.topic, source.gradeLevel, 'medium'),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    if (!podcastResult) {\r\n      return {\r\n        testType: 'podcast',\r\n        sourceType: 'text',\r\n        subject: source.subject,\r\n        gradeLevel: source.gradeLevel,\r\n        startedAt: new Date(startTime),\r\n        completedAt: new Date(),\r\n        duration: Date.now() - startTime,\r\n        status: 'failed',\r\n        syllabusGenerated: false,\r\n        unitsGenerated: 0,\r\n        blocksGenerated: 0,\r\n        qualityScore: 0,\r\n        issues: [{ type: 'empty_content', message: 'generatePodcastScript returned null', severity: 'critical' }],\r\n        outputPreview: null\r\n      };\r\n    }\r\n\r\n    // Validate podcast\r\n    const validation = validatePodcastScript(podcastResult);\r\n    issues.push(...validation.issues);\r\n\r\n    // Count dialogue turns\r\n    const dialogue = podcastResult.dialogue || podcastResult.turns || podcastResult.script || [];\r\n\r\n    return {\r\n      testType: 'podcast',\r\n      sourceType: 'text',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: validation.valid ? (validation.score >= 70 ? 'passed' : 'warning') : 'failed',\r\n      syllabusGenerated: true,\r\n      unitsGenerated: 1,\r\n      blocksGenerated: dialogue.length,\r\n      qualityScore: validation.score,\r\n      issues,\r\n      outputPreview: JSON.stringify(podcastResult).substring(0, 500)\r\n    };\r\n\r\n  } catch (error: any) {\r\n    return {\r\n      testType: 'podcast',\r\n      sourceType: 'text',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: 'failed',\r\n      syllabusGenerated: false,\r\n      unitsGenerated: 0,\r\n      blocksGenerated: 0,\r\n      qualityScore: 0,\r\n      issues: [{\r\n        type: error.message === 'Timeout' ? 'timeout' : 'api_error',\r\n        message: error.message,\r\n        severity: 'critical'\r\n      }],\r\n      outputPreview: null\r\n    };\r\n  }\r\n}\r\n\r\nasync function testInteractiveBlocksGeneration(\r\n  source: typeof SAMPLE_SOURCES.history,\r\n  timeout: number = 60000\r\n): Promise<E2ETestResult> {\r\n  const startTime = Date.now();\r\n  const issues: E2EIssue[] = [];\r\n  const blocks: any[] = [];\r\n\r\n  try {\r\n    // Generate multiple block types\r\n    const blockPromises = [\r\n      generateSingleMultipleChoiceQuestion(source.topic, source.gradeLevel, null, source.text),\r\n      generateSingleOpenQuestion(source.topic, source.gradeLevel, null, source.text),\r\n      generateCategorizationQuestion(source.topic, source.gradeLevel, source.text),\r\n      generateOrderingQuestion(source.topic, source.gradeLevel, source.text),\r\n    ];\r\n\r\n    const timeoutPromise = new Promise<null[]>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const results = await Promise.race([\r\n      Promise.all(blockPromises),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    if (results) {\r\n      blocks.push(...results.filter(Boolean));\r\n    }\r\n\r\n    // Validate blocks\r\n    const validation = validateInteractiveBlocks(blocks);\r\n    issues.push(...validation.issues);\r\n\r\n    return {\r\n      testType: 'activity',\r\n      sourceType: 'text',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: validation.valid ? (validation.score >= 70 ? 'passed' : 'warning') : 'failed',\r\n      syllabusGenerated: false,\r\n      unitsGenerated: 0,\r\n      blocksGenerated: blocks.length,\r\n      qualityScore: validation.score,\r\n      issues,\r\n      outputPreview: JSON.stringify(blocks).substring(0, 500)\r\n    };\r\n\r\n  } catch (error: any) {\r\n    return {\r\n      testType: 'activity',\r\n      sourceType: 'text',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: 'failed',\r\n      syllabusGenerated: false,\r\n      unitsGenerated: 0,\r\n      blocksGenerated: blocks.length,\r\n      qualityScore: 0,\r\n      issues: [{\r\n        type: error.message === 'Timeout' ? 'timeout' : 'api_error',\r\n        message: error.message,\r\n        severity: 'critical'\r\n      }],\r\n      outputPreview: null\r\n    };\r\n  }\r\n}\r\n\r\n// ===== YouTube Test =====\r\n\r\ninterface YouTubeSource {\r\n  url: string;\r\n  topic: string;\r\n  gradeLevel: string;\r\n  subject: string;\r\n  expectedMinLength: number;\r\n}\r\n\r\nasync function testLessonFromYouTube(\r\n  source: YouTubeSource,\r\n  timeout: number = 120000 // 2 minutes for transcription + generation\r\n): Promise<E2ETestResult> {\r\n  const startTime = Date.now();\r\n  const issues: E2EIssue[] = [];\r\n\r\n  try {\r\n    console.log(`   ğŸ“¹ Transcribing YouTube video: ${source.url}`);\r\n\r\n    // Step 1: Transcribe YouTube video\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    let transcriptText: string;\r\n\r\n    try {\r\n      const transcriptionResult = await Promise.race([\r\n        MultimodalService.processYoutubeUrl(source.url),\r\n        timeoutPromise\r\n      ]);\r\n\r\n      if (!transcriptionResult || !transcriptionResult.text) {\r\n        return {\r\n          testType: 'lesson_from_youtube',\r\n          sourceType: 'youtube',\r\n          subject: source.subject,\r\n          gradeLevel: source.gradeLevel,\r\n          startedAt: new Date(startTime),\r\n          completedAt: new Date(),\r\n          duration: Date.now() - startTime,\r\n          status: 'failed',\r\n          syllabusGenerated: false,\r\n          unitsGenerated: 0,\r\n          blocksGenerated: 0,\r\n          qualityScore: 0,\r\n          issues: [{ type: 'empty_content', message: 'YouTube transcription returned empty', severity: 'critical' }],\r\n          outputPreview: null\r\n        };\r\n      }\r\n\r\n      transcriptText = transcriptionResult.text;\r\n      console.log(`   âœ… Transcription successful: ${transcriptText.length} characters`);\r\n\r\n      // Validate transcript length\r\n      if (transcriptText.length < source.expectedMinLength) {\r\n        issues.push({\r\n          type: 'quality_issue',\r\n          message: `Transcript too short: ${transcriptText.length} chars (expected ${source.expectedMinLength}+)`,\r\n          severity: 'medium'\r\n        });\r\n      }\r\n\r\n    } catch (transcriptError: any) {\r\n      // Handle specific transcription errors\r\n      const errorCode = transcriptError?.code;\r\n      let errorType: E2EIssue['type'] = 'api_error';\r\n      let errorMessage = transcriptError.message || 'Unknown transcription error';\r\n\r\n      if (errorCode === TRANSCRIPTION_ERROR_CODES.NO_CAPTIONS) {\r\n        errorType = 'quality_issue';\r\n        errorMessage = 'Video has no captions available';\r\n      } else if (errorCode === TRANSCRIPTION_ERROR_CODES.PRIVATE_VIDEO) {\r\n        errorType = 'api_error';\r\n        errorMessage = 'Video is private or restricted';\r\n      } else if (errorCode === TRANSCRIPTION_ERROR_CODES.VIDEO_NOT_FOUND) {\r\n        errorType = 'api_error';\r\n        errorMessage = 'Video not found';\r\n      }\r\n\r\n      return {\r\n        testType: 'lesson_from_youtube',\r\n        sourceType: 'youtube',\r\n        subject: source.subject,\r\n        gradeLevel: source.gradeLevel,\r\n        startedAt: new Date(startTime),\r\n        completedAt: new Date(),\r\n        duration: Date.now() - startTime,\r\n        status: 'warning', // Warning because the video might just not have captions\r\n        syllabusGenerated: false,\r\n        unitsGenerated: 0,\r\n        blocksGenerated: 0,\r\n        qualityScore: 0,\r\n        issues: [{ type: errorType, message: errorMessage, severity: 'high' }],\r\n        outputPreview: `Transcription error: ${errorMessage}`\r\n      };\r\n    }\r\n\r\n    // Step 2: Generate syllabus from transcript\r\n    console.log(`   ğŸ“ Generating syllabus from transcript...`);\r\n\r\n    const syllabusResult = await Promise.race([\r\n      generateCourseSyllabus(transcriptText, source.topic, source.gradeLevel, source.subject),\r\n      new Promise<null>((_, reject) =>\r\n        setTimeout(() => reject(new Error('Syllabus generation timeout')), 60000)\r\n      )\r\n    ]);\r\n\r\n    if (!syllabusResult) {\r\n      return {\r\n        testType: 'lesson_from_youtube',\r\n        sourceType: 'youtube',\r\n        subject: source.subject,\r\n        gradeLevel: source.gradeLevel,\r\n        startedAt: new Date(startTime),\r\n        completedAt: new Date(),\r\n        duration: Date.now() - startTime,\r\n        status: 'failed',\r\n        syllabusGenerated: false,\r\n        unitsGenerated: 0,\r\n        blocksGenerated: 0,\r\n        qualityScore: 30, // Partial credit for successful transcription\r\n        issues: [\r\n          ...issues,\r\n          { type: 'empty_content', message: 'Syllabus generation returned null', severity: 'critical' }\r\n        ],\r\n        outputPreview: `Transcript: ${transcriptText.substring(0, 200)}...`\r\n      };\r\n    }\r\n\r\n    // Validate syllabus\r\n    const validation = validateSyllabus(syllabusResult);\r\n    issues.push(...validation.issues);\r\n\r\n    // Count units and blocks\r\n    let unitsCount = 0;\r\n    let blocksCount = 0;\r\n    const syllabus = Array.isArray(syllabusResult) ? syllabusResult : [syllabusResult];\r\n    syllabus.forEach((mod: any) => {\r\n      const units = mod.learningUnits || mod.units || [];\r\n      unitsCount += units.length;\r\n      units.forEach((unit: any) => {\r\n        blocksCount += (unit.activityBlocks || unit.blocks || []).length;\r\n      });\r\n    });\r\n\r\n    // Bonus points for successful YouTube flow\r\n    const finalScore = Math.min(100, validation.score + 10); // +10 for successful transcription\r\n\r\n    return {\r\n      testType: 'lesson_from_youtube',\r\n      sourceType: 'youtube',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: validation.valid ? (finalScore >= 70 ? 'passed' : 'warning') : 'failed',\r\n      syllabusGenerated: true,\r\n      unitsGenerated: unitsCount,\r\n      blocksGenerated: blocksCount,\r\n      qualityScore: finalScore,\r\n      issues,\r\n      outputPreview: JSON.stringify(syllabusResult).substring(0, 500)\r\n    };\r\n\r\n  } catch (error: any) {\r\n    return {\r\n      testType: 'lesson_from_youtube',\r\n      sourceType: 'youtube',\r\n      subject: source.subject,\r\n      gradeLevel: source.gradeLevel,\r\n      startedAt: new Date(startTime),\r\n      completedAt: new Date(),\r\n      duration: Date.now() - startTime,\r\n      status: 'failed',\r\n      syllabusGenerated: false,\r\n      unitsGenerated: 0,\r\n      blocksGenerated: 0,\r\n      qualityScore: 0,\r\n      issues: [{\r\n        type: error.message?.includes('Timeout') ? 'timeout' : 'api_error',\r\n        message: error.message || 'Unknown error',\r\n        severity: 'critical'\r\n      }],\r\n      outputPreview: null\r\n    };\r\n  }\r\n}\r\n\r\n// ===== MAIN AGENT =====\r\n\r\nexport async function runE2EGenerationAgent(): Promise<QAAgentResult> {\r\n  const startTime = Date.now();\r\n  const tests: TestResult[] = [];\r\n  const e2eResults: E2ETestResult[] = [];\r\n\r\n  console.log('ğŸš€ Starting E2E Generation Agent...');\r\n\r\n  // Test 1: Lesson from Text (History)\r\n  console.log('ğŸ“ Testing: Lesson from Text (History)...');\r\n  const lessonHistory = await testLessonFromText(SAMPLE_SOURCES.history);\r\n  e2eResults.push(lessonHistory);\r\n  tests.push({\r\n    id: `e2e_lesson_history_${Date.now()}`,\r\n    name: `[lesson] ${SAMPLE_SOURCES.history.topic}`,\r\n    nameHe: `[××¢×¨×š ×©×™×¢×•×¨] ${SAMPLE_SOURCES.history.topic}`,\r\n    category: 'e2e-generation',\r\n    status: lessonHistory.status,\r\n    severity: 'high',\r\n    message: `Duration: ${lessonHistory.duration}ms | Units: ${lessonHistory.unitsGenerated} | Quality: ${lessonHistory.qualityScore}%`,\r\n    messageHe: `××©×š: ${lessonHistory.duration}ms | ×™×—×™×“×•×ª: ${lessonHistory.unitsGenerated} | ××™×›×•×ª: ${lessonHistory.qualityScore}%`,\r\n    details: lessonHistory,\r\n    duration: lessonHistory.duration,\r\n    timestamp: new Date()\r\n  });\r\n\r\n  // Test 2: Lesson from Text (Science)\r\n  console.log('ğŸ“ Testing: Lesson from Text (Science)...');\r\n  const lessonScience = await testLessonFromText(SAMPLE_SOURCES.science);\r\n  e2eResults.push(lessonScience);\r\n  tests.push({\r\n    id: `e2e_lesson_science_${Date.now()}`,\r\n    name: `[lesson] ${SAMPLE_SOURCES.science.topic}`,\r\n    nameHe: `[××¢×¨×š ×©×™×¢×•×¨] ${SAMPLE_SOURCES.science.topic}`,\r\n    category: 'e2e-generation',\r\n    status: lessonScience.status,\r\n    severity: 'high',\r\n    message: `Duration: ${lessonScience.duration}ms | Units: ${lessonScience.unitsGenerated} | Quality: ${lessonScience.qualityScore}%`,\r\n    messageHe: `××©×š: ${lessonScience.duration}ms | ×™×—×™×“×•×ª: ${lessonScience.unitsGenerated} | ××™×›×•×ª: ${lessonScience.qualityScore}%`,\r\n    details: lessonScience,\r\n    duration: lessonScience.duration,\r\n    timestamp: new Date()\r\n  });\r\n\r\n  // Test 3: Podcast Generation\r\n  console.log('ğŸ™ï¸ Testing: Podcast Generation...');\r\n  const podcast = await testPodcastGeneration(SAMPLE_SOURCES.literature);\r\n  e2eResults.push(podcast);\r\n  tests.push({\r\n    id: `e2e_podcast_${Date.now()}`,\r\n    name: `[podcast] ${SAMPLE_SOURCES.literature.topic}`,\r\n    nameHe: `[×¤×•×“×§××¡×˜] ${SAMPLE_SOURCES.literature.topic}`,\r\n    category: 'e2e-generation',\r\n    status: podcast.status,\r\n    severity: 'high',\r\n    message: `Duration: ${podcast.duration}ms | Turns: ${podcast.blocksGenerated} | Quality: ${podcast.qualityScore}%`,\r\n    messageHe: `××©×š: ${podcast.duration}ms | ×ª×•×¨×•×ª: ${podcast.blocksGenerated} | ××™×›×•×ª: ${podcast.qualityScore}%`,\r\n    details: podcast,\r\n    duration: podcast.duration,\r\n    timestamp: new Date()\r\n  });\r\n\r\n  // Test 4: Interactive Blocks (Game/Activity)\r\n  console.log('ğŸ® Testing: Interactive Blocks Generation...');\r\n  const game = await testInteractiveBlocksGeneration(SAMPLE_SOURCES.math);\r\n  e2eResults.push(game);\r\n  tests.push({\r\n    id: `e2e_game_${Date.now()}`,\r\n    name: `[activity] ${SAMPLE_SOURCES.math.topic}`,\r\n    nameHe: `[×¤×¢×™×œ×•×ª] ${SAMPLE_SOURCES.math.topic}`,\r\n    category: 'e2e-generation',\r\n    status: game.status,\r\n    severity: 'high',\r\n    message: `Duration: ${game.duration}ms | Blocks: ${game.blocksGenerated} | Quality: ${game.qualityScore}%`,\r\n    messageHe: `××©×š: ${game.duration}ms | ×‘×œ×•×§×™×: ${game.blocksGenerated} | ××™×›×•×ª: ${game.qualityScore}%`,\r\n    details: game,\r\n    duration: game.duration,\r\n    timestamp: new Date()\r\n  });\r\n\r\n  // Test 5: Lesson from YouTube (Math)\r\n  console.log('ğŸ“¹ Testing: Lesson from YouTube...');\r\n  const youtubeLesson = await testLessonFromYouTube(SAMPLE_YOUTUBE_SOURCES.math);\r\n  e2eResults.push(youtubeLesson);\r\n  tests.push({\r\n    id: `e2e_youtube_${Date.now()}`,\r\n    name: `[youtubeâ†’lesson] ${SAMPLE_YOUTUBE_SOURCES.math.topic}`,\r\n    nameHe: `[×™×•×˜×™×•×‘â†’××¢×¨×š ×©×™×¢×•×¨] ${SAMPLE_YOUTUBE_SOURCES.math.topic}`,\r\n    category: 'e2e-generation',\r\n    status: youtubeLesson.status,\r\n    severity: 'high',\r\n    message: `Duration: ${youtubeLesson.duration}ms | Units: ${youtubeLesson.unitsGenerated} | Quality: ${youtubeLesson.qualityScore}%`,\r\n    messageHe: `××©×š: ${youtubeLesson.duration}ms | ×™×—×™×“×•×ª: ${youtubeLesson.unitsGenerated} | ××™×›×•×ª: ${youtubeLesson.qualityScore}%`,\r\n    details: youtubeLesson,\r\n    duration: youtubeLesson.duration,\r\n    timestamp: new Date()\r\n  });\r\n\r\n  // Summary test\r\n  const passedCount = e2eResults.filter(r => r.status === 'passed').length;\r\n  const failedCount = e2eResults.filter(r => r.status === 'failed').length;\r\n  const warningCount = e2eResults.filter(r => r.status === 'warning').length;\r\n  const avgQuality = Math.round(e2eResults.reduce((sum, r) => sum + r.qualityScore, 0) / e2eResults.length);\r\n  const avgDuration = Math.round(e2eResults.reduce((sum, r) => sum + r.duration, 0) / e2eResults.length);\r\n\r\n  tests.push({\r\n    id: `e2e_summary_${Date.now()}`,\r\n    name: 'E2E Generation Summary',\r\n    nameHe: '×¡×™×›×•× ×™×¦×™×¨×ª ×ª×•×›×Ÿ ××§×¦×” ×œ×§×¦×”',\r\n    category: 'e2e-generation',\r\n    status: failedCount === 0 ? (warningCount === 0 ? 'passed' : 'warning') : 'failed',\r\n    severity: 'critical',\r\n    message: `Passed: ${passedCount}/${e2eResults.length} | Avg Quality: ${avgQuality}% | Avg Duration: ${avgDuration}ms`,\r\n    messageHe: `×¢×‘×¨×•: ${passedCount}/${e2eResults.length} | ××™×›×•×ª ×××•×¦×¢×ª: ${avgQuality}% | ××©×š ×××•×¦×¢: ${avgDuration}ms`,\r\n    details: {\r\n      totalTests: e2eResults.length,\r\n      passed: passedCount,\r\n      failed: failedCount,\r\n      warnings: warningCount,\r\n      avgQuality,\r\n      avgDuration,\r\n      byType: {\r\n        lesson: e2eResults.filter(r => r.testType === 'lesson_from_text').length,\r\n        youtube: e2eResults.filter(r => r.testType === 'lesson_from_youtube').length,\r\n        podcast: e2eResults.filter(r => r.testType === 'podcast').length,\r\n        activity: e2eResults.filter(r => r.testType === 'activity').length,\r\n      }\r\n    },\r\n    duration: Date.now() - startTime,\r\n    timestamp: new Date()\r\n  });\r\n\r\n  console.log(`âœ… E2E Generation Agent completed: ${passedCount}/${e2eResults.length} passed`);\r\n\r\n  return {\r\n    agentName: 'E2E Generation Agent',\r\n    agentNameHe: '×¡×•×›×Ÿ ×™×¦×™×¨×ª ×ª×•×›×Ÿ ××§×¦×” ×œ×§×¦×”',\r\n    status: failedCount === 0 ? 'passed' : 'failed',\r\n    tests,\r\n    summary: {\r\n      totalTests: tests.length,\r\n      passed: passedCount + (failedCount === 0 ? 1 : 0), // +1 for summary test\r\n      failed: failedCount,\r\n      warnings: warningCount,\r\n      duration: Date.now() - startTime\r\n    }\r\n  };\r\n}\r\n\r\nexport default runE2EGenerationAgent;\r\n","/**\r\n * Student Activity Agent\r\n * ×¡×•×›×Ÿ ×¤×¢×™×œ×•×ª ×ª×œ××™×“ - ××‘×¦×¢ ×¤×¢×™×œ×•×™×•×ª ×•×‘×—×™× ×•×ª ×•×‘×•×“×§ ×©×”× ×™×§×•×“ ×ª×§×™×Ÿ\r\n *\r\n * This agent actually performs activities and exams like a real student,\r\n * testing that scoring, hints, retries, and XP/gems work correctly.\r\n */\r\n\r\nimport { db } from '../../firebase';\r\nimport { collection, getDocs, query, limit as firestoreLimit, orderBy } from 'firebase/firestore';\r\nimport type { TestResult, QAAgentResult } from '../../types/qa.types';\r\nimport type { Course, ActivityBlock } from '../../shared/types/courseTypes';\r\nimport { SCORING_CONFIG, calculateQuestionScore } from '../../utils/scoring';\r\n\r\n// ===== TYPES =====\r\n\r\nexport interface ActivityAttempt {\r\n  blockId: string;\r\n  blockType: string;\r\n  questionText?: string;\r\n\r\n  // Attempt details\r\n  attempts: number;\r\n  hintsUsed: number;\r\n  responseTimeSec: number;\r\n\r\n  // Answer details\r\n  selectedAnswer?: any;\r\n  correctAnswer?: any;\r\n  isCorrect: boolean;\r\n\r\n  // Scoring results\r\n  expectedScore: number;\r\n  actualScore?: number;\r\n  scoreMatch: boolean;\r\n\r\n  // Gamification\r\n  expectedXP: number;\r\n  expectedGems: number;\r\n\r\n  // Issues found\r\n  issues: ActivityIssue[];\r\n}\r\n\r\nexport interface ActivityIssue {\r\n  type: 'scoring_mismatch' | 'hint_penalty_wrong' | 'retry_score_wrong' |\r\n        'xp_mismatch' | 'gems_mismatch' | 'exam_hint_allowed' |\r\n        'missing_feedback' | 'invalid_options' | 'no_correct_answer' |\r\n        'answer_not_in_options' | 'max_attempts_exceeded';\r\n  severity: 'critical' | 'high' | 'medium' | 'low';\r\n  message: string;\r\n  messageHe: string;\r\n  expected?: any;\r\n  actual?: any;\r\n}\r\n\r\nexport interface ActivitySessionResult {\r\n  sessionId: string;\r\n  courseId: string;\r\n  courseTitle: string;\r\n  isExamMode: boolean;\r\n\r\n  // Statistics\r\n  totalBlocks: number;\r\n  blocksAttempted: number;\r\n  blocksCorrectFirstTry: number;\r\n  blocksCorrectWithHints: number;\r\n  blocksCorrectAfterRetry: number;\r\n  blocksIncorrect: number;\r\n\r\n  // Scoring validation\r\n  totalExpectedScore: number;\r\n  totalActualScore: number;\r\n  scoringAccurate: boolean;\r\n\r\n  // Issues\r\n  issues: ActivityIssue[];\r\n  attempts: ActivityAttempt[];\r\n\r\n  // Timing\r\n  totalTime: number;\r\n}\r\n\r\n// ===== SCORING CALCULATOR (mirrors actual scoring logic) =====\r\n\r\nfunction calculateExpectedScore(\r\n  isCorrect: boolean,\r\n  attempts: number,\r\n  hintsUsed: number\r\n): { score: number; xp: number; gems: number } {\r\n  let score = 0;\r\n  let xp = 0;\r\n  let gems = 0;\r\n\r\n  if (isCorrect) {\r\n    if (attempts === 1) {\r\n      // First try correct\r\n      if (hintsUsed > 0) {\r\n        score = Math.max(0, SCORING_CONFIG.CORRECT_FIRST_TRY - (hintsUsed * SCORING_CONFIG.HINT_PENALTY));\r\n      } else {\r\n        score = SCORING_CONFIG.CORRECT_FIRST_TRY;\r\n      }\r\n    } else {\r\n      // Retry correct\r\n      score = SCORING_CONFIG.RETRY_PARTIAL;\r\n    }\r\n\r\n    // XP equals score\r\n    xp = score;\r\n\r\n    // Gems\r\n    gems = 1;\r\n    if (score === 100) {\r\n      gems = 2; // Bonus for perfect\r\n    }\r\n  }\r\n\r\n  return { score, xp, gems };\r\n}\r\n\r\n// ===== ACTIVITY SIMULATORS =====\r\n\r\nfunction performMultipleChoiceActivity(\r\n  block: ActivityBlock,\r\n  isExamMode: boolean,\r\n  scenario: 'correct_first' | 'correct_with_hints' | 'correct_after_retry' | 'incorrect'\r\n): ActivityAttempt {\r\n  const content = block.content || {};\r\n  const options = content.options || [];\r\n  const correctAnswer = content.correctAnswer || content.correct_answer;\r\n  const hints = block.metadata?.progressiveHints || [];\r\n\r\n  const issues: ActivityIssue[] = [];\r\n\r\n  // Validate block structure\r\n  if (options.length === 0) {\r\n    issues.push({\r\n      type: 'invalid_options',\r\n      severity: 'critical',\r\n      message: 'Multiple choice has no options',\r\n      messageHe: '×©××œ×ª ×‘×—×™×¨×” ×œ×œ× ××¤×©×¨×•×™×•×ª'\r\n    });\r\n  }\r\n\r\n  if (!correctAnswer) {\r\n    issues.push({\r\n      type: 'no_correct_answer',\r\n      severity: 'critical',\r\n      message: 'No correct answer defined',\r\n      messageHe: '×œ× ××•×’×“×¨×ª ×ª×©×•×‘×” × ×›×•× ×”'\r\n    });\r\n  }\r\n\r\n  // Check if correct answer is in options\r\n  if (correctAnswer && options.length > 0) {\r\n    const optionTexts = options.map((o: any) =>\r\n      typeof o === 'string' ? o : (o.text || o.label || o.value || '')\r\n    );\r\n    if (!optionTexts.includes(correctAnswer)) {\r\n      issues.push({\r\n        type: 'answer_not_in_options',\r\n        severity: 'critical',\r\n        message: `Correct answer \"${correctAnswer}\" not found in options`,\r\n        messageHe: `×”×ª×©×•×‘×” ×”× ×›×•× ×” \"${correctAnswer}\" ×œ× × ××¦××ª ×‘××¤×©×¨×•×™×•×ª`,\r\n        expected: correctAnswer,\r\n        actual: optionTexts\r\n      });\r\n    }\r\n  }\r\n\r\n  // Simulate activity based on scenario\r\n  let attempts = 1;\r\n  let hintsUsed = 0;\r\n  let isCorrect = false;\r\n  let selectedAnswer = options[0];\r\n\r\n  switch (scenario) {\r\n    case 'correct_first':\r\n      attempts = 1;\r\n      hintsUsed = 0;\r\n      isCorrect = true;\r\n      selectedAnswer = correctAnswer;\r\n      break;\r\n\r\n    case 'correct_with_hints':\r\n      attempts = 1;\r\n      hintsUsed = Math.min(2, hints.length);\r\n      isCorrect = true;\r\n      selectedAnswer = correctAnswer;\r\n\r\n      // Check if hints are allowed in exam mode\r\n      if (isExamMode && hintsUsed > 0) {\r\n        issues.push({\r\n          type: 'exam_hint_allowed',\r\n          severity: 'critical',\r\n          message: 'Hints should be disabled in exam mode',\r\n          messageHe: '×¨××–×™× ×¦×¨×™×›×™× ×œ×”×™×•×ª ×—×¡×•××™× ×‘××¦×‘ ××‘×—×Ÿ'\r\n        });\r\n      }\r\n      break;\r\n\r\n    case 'correct_after_retry':\r\n      attempts = 2;\r\n      hintsUsed = 0;\r\n      isCorrect = true;\r\n      selectedAnswer = correctAnswer;\r\n      break;\r\n\r\n    case 'incorrect':\r\n      attempts = 1;\r\n      hintsUsed = 0;\r\n      isCorrect = false;\r\n      selectedAnswer = options.find((o: any) => o !== correctAnswer) || options[0];\r\n      break;\r\n  }\r\n\r\n  const { score, xp, gems } = calculateExpectedScore(isCorrect, attempts, hintsUsed);\r\n\r\n  // Verify against actual scoring function\r\n  const actualCalculatedScore = calculateQuestionScore({\r\n    isCorrect,\r\n    attempts,\r\n    hintsUsed,\r\n    responseTimeSec: 5\r\n  });\r\n\r\n  if (actualCalculatedScore !== score) {\r\n    issues.push({\r\n      type: 'scoring_mismatch',\r\n      severity: 'critical',\r\n      message: `Scoring function returned ${actualCalculatedScore}, expected ${score}`,\r\n      messageHe: `×¤×•× ×§×¦×™×™×ª ×”× ×™×§×•×“ ×”×—×–×™×¨×” ${actualCalculatedScore}, ×¦×¤×•×™ ${score}`,\r\n      expected: score,\r\n      actual: actualCalculatedScore\r\n    });\r\n  }\r\n\r\n  return {\r\n    blockId: block.id,\r\n    blockType: block.type,\r\n    questionText: content.question,\r\n    attempts,\r\n    hintsUsed,\r\n    responseTimeSec: 5,\r\n    selectedAnswer,\r\n    correctAnswer,\r\n    isCorrect,\r\n    expectedScore: score,\r\n    actualScore: actualCalculatedScore,\r\n    scoreMatch: actualCalculatedScore === score,\r\n    expectedXP: xp,\r\n    expectedGems: gems,\r\n    issues\r\n  };\r\n}\r\n\r\nfunction performOpenQuestionActivity(\r\n  block: ActivityBlock,\r\n  isExamMode: boolean\r\n): ActivityAttempt {\r\n  const content = block.content || {};\r\n  const issues: ActivityIssue[] = [];\r\n\r\n  if (!content.question) {\r\n    issues.push({\r\n      type: 'invalid_options',\r\n      severity: 'high',\r\n      message: 'Open question has no question text',\r\n      messageHe: '×©××œ×” ×¤×ª×•×—×” ×œ×œ× ×˜×§×¡×˜ ×©××œ×”'\r\n    });\r\n  }\r\n\r\n  // Open questions are graded by AI, so we simulate a \"correct\" answer\r\n  // Scoring for open questions is different (AI-graded)\r\n  return {\r\n    blockId: block.id,\r\n    blockType: block.type,\r\n    questionText: content.question,\r\n    attempts: 1,\r\n    hintsUsed: 0,\r\n    responseTimeSec: 30,\r\n    selectedAnswer: '[Simulated open answer]',\r\n    correctAnswer: content.modelAnswer || block.metadata?.modelAnswer,\r\n    isCorrect: true, // Assume AI grades it correct\r\n    expectedScore: 100, // Full marks assumed\r\n    scoreMatch: true,\r\n    expectedXP: 100,\r\n    expectedGems: 2,\r\n    issues\r\n  };\r\n}\r\n\r\nfunction performOrderingActivity(\r\n  block: ActivityBlock,\r\n  scenario: 'correct' | 'incorrect'\r\n): ActivityAttempt {\r\n  const content = block.content || {};\r\n  const correctOrder = content.correct_order || content.correctOrder || [];\r\n  const issues: ActivityIssue[] = [];\r\n\r\n  if (correctOrder.length < 2) {\r\n    issues.push({\r\n      type: 'invalid_options',\r\n      severity: 'critical',\r\n      message: 'Ordering activity has less than 2 items',\r\n      messageHe: '×¤×¢×™×œ×•×ª ×¡×™×“×•×¨ ×¢× ×¤×—×•×ª ×-2 ×¤×¨×™×˜×™×'\r\n    });\r\n  }\r\n\r\n  const isCorrect = scenario === 'correct';\r\n  const { score, xp, gems } = calculateExpectedScore(isCorrect, 1, 0);\r\n\r\n  return {\r\n    blockId: block.id,\r\n    blockType: block.type,\r\n    questionText: content.instruction || content.question,\r\n    attempts: 1,\r\n    hintsUsed: 0,\r\n    responseTimeSec: 15,\r\n    selectedAnswer: isCorrect ? correctOrder : [...correctOrder].reverse(),\r\n    correctAnswer: correctOrder,\r\n    isCorrect,\r\n    expectedScore: score,\r\n    scoreMatch: true,\r\n    expectedXP: xp,\r\n    expectedGems: gems,\r\n    issues\r\n  };\r\n}\r\n\r\n// ===== SESSION RUNNER =====\r\n\r\nfunction runActivitySession(\r\n  course: Course,\r\n  isExamMode: boolean\r\n): ActivitySessionResult {\r\n  const startTime = Date.now();\r\n  const attempts: ActivityAttempt[] = [];\r\n  const allIssues: ActivityIssue[] = [];\r\n\r\n  const modules = course.syllabus || [];\r\n  let totalBlocks = 0;\r\n  let blocksAttempted = 0;\r\n  let blocksCorrectFirstTry = 0;\r\n  let blocksCorrectWithHints = 0;\r\n  let blocksCorrectAfterRetry = 0;\r\n  let blocksIncorrect = 0;\r\n  let totalExpectedScore = 0;\r\n  let totalActualScore = 0;\r\n\r\n  // Count all interactive blocks\r\n  for (const module of modules) {\r\n    for (const unit of module.learningUnits || []) {\r\n      for (const block of unit.activityBlocks || []) {\r\n        const isInteractive = ['multiple-choice', 'open-question', 'ordering',\r\n                              'categorization', 'fill-in-blanks', 'true-false'].includes(block.type);\r\n        if (isInteractive) {\r\n          totalBlocks++;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Run activities with different scenarios\r\n  for (const module of modules) {\r\n    for (const unit of module.learningUnits || []) {\r\n      for (const block of unit.activityBlocks || []) {\r\n        let attempt: ActivityAttempt | null = null;\r\n\r\n        switch (block.type) {\r\n          case 'multiple-choice':\r\n          case 'true-false':\r\n            // Test all scenarios for first few blocks, then random\r\n            if (blocksAttempted === 0) {\r\n              attempt = performMultipleChoiceActivity(block, isExamMode, 'correct_first');\r\n              blocksCorrectFirstTry++;\r\n            } else if (blocksAttempted === 1) {\r\n              attempt = performMultipleChoiceActivity(block, isExamMode, 'correct_with_hints');\r\n              blocksCorrectWithHints++;\r\n            } else if (blocksAttempted === 2) {\r\n              attempt = performMultipleChoiceActivity(block, isExamMode, 'correct_after_retry');\r\n              blocksCorrectAfterRetry++;\r\n            } else if (blocksAttempted === 3) {\r\n              attempt = performMultipleChoiceActivity(block, isExamMode, 'incorrect');\r\n              blocksIncorrect++;\r\n            } else {\r\n              // Random scenario\r\n              const scenarios = ['correct_first', 'correct_with_hints', 'correct_after_retry', 'incorrect'] as const;\r\n              const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];\r\n              attempt = performMultipleChoiceActivity(block, isExamMode, scenario);\r\n              if (scenario === 'correct_first') blocksCorrectFirstTry++;\r\n              else if (scenario === 'correct_with_hints') blocksCorrectWithHints++;\r\n              else if (scenario === 'correct_after_retry') blocksCorrectAfterRetry++;\r\n              else blocksIncorrect++;\r\n            }\r\n            break;\r\n\r\n          case 'open-question':\r\n            attempt = performOpenQuestionActivity(block, isExamMode);\r\n            blocksCorrectFirstTry++;\r\n            break;\r\n\r\n          case 'ordering':\r\n            attempt = performOrderingActivity(block, blocksAttempted % 2 === 0 ? 'correct' : 'incorrect');\r\n            if (attempt.isCorrect) blocksCorrectFirstTry++;\r\n            else blocksIncorrect++;\r\n            break;\r\n        }\r\n\r\n        if (attempt) {\r\n          attempts.push(attempt);\r\n          allIssues.push(...attempt.issues);\r\n          blocksAttempted++;\r\n          totalExpectedScore += attempt.expectedScore;\r\n          totalActualScore += attempt.actualScore || attempt.expectedScore;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    sessionId: `activity_${course.id}_${Date.now()}`,\r\n    courseId: course.id,\r\n    courseTitle: course.title || course.id,\r\n    isExamMode,\r\n    totalBlocks,\r\n    blocksAttempted,\r\n    blocksCorrectFirstTry,\r\n    blocksCorrectWithHints,\r\n    blocksCorrectAfterRetry,\r\n    blocksIncorrect,\r\n    totalExpectedScore,\r\n    totalActualScore,\r\n    scoringAccurate: totalExpectedScore === totalActualScore,\r\n    issues: allIssues,\r\n    attempts,\r\n    totalTime: Date.now() - startTime\r\n  };\r\n}\r\n\r\n// ===== MAIN AGENT FUNCTION =====\r\n\r\nexport async function runStudentActivityAgent(\r\n  maxCourses: number = 5,\r\n  testExamMode: boolean = true\r\n): Promise<QAAgentResult> {\r\n  const startTime = Date.now();\r\n  const allResults: TestResult[] = [];\r\n\r\n  console.log('ğŸ“ Student Activity Agent starting...');\r\n  console.log(`   Testing activities and scoring on ${maxCourses} courses...`);\r\n\r\n  try {\r\n    // Fetch courses\r\n    const coursesQuery = query(\r\n      collection(db, 'courses'),\r\n      orderBy('createdAt', 'desc'),\r\n      firestoreLimit(maxCourses)\r\n    );\r\n    const snapshot = await getDocs(coursesQuery);\r\n\r\n    let totalTests = 0;\r\n    let passedTests = 0;\r\n    let failedTests = 0;\r\n    const criticalIssues: TestResult[] = [];\r\n\r\n    for (const docSnap of snapshot.docs) {\r\n      const course = { id: docSnap.id, ...docSnap.data() } as Course;\r\n\r\n      // Test in learning mode\r\n      const learningSession = runActivitySession(course, false);\r\n      totalTests++;\r\n\r\n      const learningCritical = learningSession.issues.filter(i => i.severity === 'critical');\r\n      const learningHigh = learningSession.issues.filter(i => i.severity === 'high');\r\n      const hasCriticalLearning = learningCritical.length > 0;\r\n      const hasHighLearning = learningHigh.length > 0 || !learningSession.scoringAccurate;\r\n\r\n      const learningStatus = hasCriticalLearning ? 'failed' :\r\n                            hasHighLearning ? 'warning' : 'passed';\r\n\r\n      const learningResult: TestResult = {\r\n        id: `activity_learning_${course.id}`,\r\n        name: `[Learning Mode] ${course.title || course.id}`,\r\n        nameHe: `[××¦×‘ ×œ××™×“×”] ${course.title || course.id}`,\r\n        category: 'student-activity',\r\n        status: learningStatus,\r\n        severity: hasCriticalLearning ? 'critical' : hasHighLearning ? 'high' : 'low',\r\n        message: `Blocks: ${learningSession.blocksAttempted}/${learningSession.totalBlocks} | ` +\r\n                 `Score: ${learningSession.totalActualScore}/${learningSession.totalExpectedScore} | ` +\r\n                 `Issues: ${learningSession.issues.length}`,\r\n        messageHe: `×‘×œ×•×§×™×: ${learningSession.blocksAttempted}/${learningSession.totalBlocks} | ` +\r\n                   `× ×™×§×•×“: ${learningSession.totalActualScore}/${learningSession.totalExpectedScore} | ` +\r\n                   `×‘×¢×™×•×ª: ${learningSession.issues.length}`,\r\n        details: {\r\n          courseId: course.id,\r\n          mode: 'learning',\r\n          ...learningSession,\r\n          issuesSummary: {\r\n            critical: learningCritical.length,\r\n            high: learningHigh.length,\r\n            medium: learningSession.issues.filter(i => i.severity === 'medium').length,\r\n            low: learningSession.issues.filter(i => i.severity === 'low').length\r\n          }\r\n        },\r\n        duration: learningSession.totalTime,\r\n        timestamp: new Date()\r\n      };\r\n\r\n      allResults.push(learningResult);\r\n\r\n      if (learningStatus === 'passed') {\r\n        passedTests++;\r\n      } else {\r\n        failedTests++;\r\n        if (hasCriticalLearning) {\r\n          criticalIssues.push(learningResult);\r\n        }\r\n      }\r\n\r\n      // Test in exam mode if requested\r\n      if (testExamMode) {\r\n        const examSession = runActivitySession(course, true);\r\n        totalTests++;\r\n\r\n        const examCritical = examSession.issues.filter(i => i.severity === 'critical');\r\n        const examHigh = examSession.issues.filter(i => i.severity === 'high');\r\n        const hasCriticalExam = examCritical.length > 0;\r\n        const hasHighExam = examHigh.length > 0;\r\n\r\n        // Check for hints in exam mode (should not be allowed)\r\n        const hintsInExam = examSession.attempts.filter(a => a.hintsUsed > 0 &&\r\n          a.issues.some(i => i.type === 'exam_hint_allowed'));\r\n\r\n        if (hintsInExam.length > 0) {\r\n          examSession.issues.push({\r\n            type: 'exam_hint_allowed',\r\n            severity: 'critical',\r\n            message: `${hintsInExam.length} blocks allowed hints in exam mode`,\r\n            messageHe: `${hintsInExam.length} ×‘×œ×•×§×™× ××¤×©×¨×• ×¨××–×™× ×‘××¦×‘ ××‘×—×Ÿ`\r\n          });\r\n        }\r\n\r\n        const examStatus = hasCriticalExam || hintsInExam.length > 0 ? 'failed' :\r\n                          hasHighExam ? 'warning' : 'passed';\r\n\r\n        const examResult: TestResult = {\r\n          id: `activity_exam_${course.id}`,\r\n          name: `[Exam Mode] ${course.title || course.id}`,\r\n          nameHe: `[××¦×‘ ××‘×—×Ÿ] ${course.title || course.id}`,\r\n          category: 'student-activity',\r\n          status: examStatus,\r\n          severity: hasCriticalExam ? 'critical' : hasHighExam ? 'high' : 'low',\r\n          message: `Blocks: ${examSession.blocksAttempted}/${examSession.totalBlocks} | ` +\r\n                   `Hints blocked: ${hintsInExam.length === 0 ? 'Yes' : 'NO!'} | ` +\r\n                   `Issues: ${examSession.issues.length}`,\r\n          messageHe: `×‘×œ×•×§×™×: ${examSession.blocksAttempted}/${examSession.totalBlocks} | ` +\r\n                     `×¨××–×™× ×—×¡×•××™×: ${hintsInExam.length === 0 ? '×›×Ÿ' : '×œ×!'} | ` +\r\n                     `×‘×¢×™×•×ª: ${examSession.issues.length}`,\r\n          details: {\r\n            courseId: course.id,\r\n            mode: 'exam',\r\n            hintsBlockedCorrectly: hintsInExam.length === 0,\r\n            ...examSession\r\n          },\r\n          duration: examSession.totalTime,\r\n          timestamp: new Date()\r\n        };\r\n\r\n        allResults.push(examResult);\r\n\r\n        if (examStatus === 'passed') {\r\n          passedTests++;\r\n        } else {\r\n          failedTests++;\r\n          if (hasCriticalExam || hintsInExam.length > 0) {\r\n            criticalIssues.push(examResult);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Add scoring policy validation test\r\n    totalTests++;\r\n    const policyTest = validateScoringPolicy();\r\n    allResults.push(policyTest);\r\n    if (policyTest.status === 'passed') passedTests++;\r\n    else {\r\n      failedTests++;\r\n      if (policyTest.severity === 'critical') criticalIssues.push(policyTest);\r\n    }\r\n\r\n    console.log(`âœ… Student Activity Agent completed: ${passedTests}/${totalTests} passed`);\r\n\r\n    return {\r\n      agentType: 'student-activity',\r\n      success: criticalIssues.length === 0,\r\n      duration: Date.now() - startTime,\r\n      testsRun: totalTests,\r\n      testsPassed: passedTests,\r\n      testsFailed: failedTests,\r\n      criticalIssues,\r\n      allResults\r\n    };\r\n\r\n  } catch (error: any) {\r\n    console.error('âŒ Student Activity Agent failed:', error);\r\n\r\n    return {\r\n      agentType: 'student-activity',\r\n      success: false,\r\n      duration: Date.now() - startTime,\r\n      testsRun: 0,\r\n      testsPassed: 0,\r\n      testsFailed: 1,\r\n      criticalIssues: [{\r\n        id: 'activity_agent_error',\r\n        name: 'Student Activity Error',\r\n        nameHe: '×©×’×™××ª ×¤×¢×™×œ×•×ª ×ª×œ××™×“',\r\n        category: 'student-activity',\r\n        status: 'failed',\r\n        severity: 'critical',\r\n        message: error.message,\r\n        messageHe: error.message,\r\n        duration: Date.now() - startTime,\r\n        timestamp: new Date()\r\n      }],\r\n      allResults: []\r\n    };\r\n  }\r\n}\r\n\r\n// ===== SCORING POLICY VALIDATION =====\r\n\r\nfunction validateScoringPolicy(): TestResult {\r\n  const issues: string[] = [];\r\n\r\n  // Test 1: Correct first try with no hints = 100\r\n  const test1 = calculateQuestionScore({ isCorrect: true, attempts: 1, hintsUsed: 0, responseTimeSec: 5 });\r\n  if (test1 !== 100) {\r\n    issues.push(`Correct first try should be 100, got ${test1}`);\r\n  }\r\n\r\n  // Test 2: Correct first try with 1 hint = 98\r\n  const test2 = calculateQuestionScore({ isCorrect: true, attempts: 1, hintsUsed: 1, responseTimeSec: 5 });\r\n  const expected2 = 100 - SCORING_CONFIG.HINT_PENALTY;\r\n  if (test2 !== expected2) {\r\n    issues.push(`Correct with 1 hint should be ${expected2}, got ${test2}`);\r\n  }\r\n\r\n  // Test 3: Correct first try with 3 hints = 94\r\n  const test3 = calculateQuestionScore({ isCorrect: true, attempts: 1, hintsUsed: 3, responseTimeSec: 5 });\r\n  const expected3 = 100 - (3 * SCORING_CONFIG.HINT_PENALTY);\r\n  if (test3 !== expected3) {\r\n    issues.push(`Correct with 3 hints should be ${expected3}, got ${test3}`);\r\n  }\r\n\r\n  // Test 4: Correct on retry = 50\r\n  const test4 = calculateQuestionScore({ isCorrect: true, attempts: 2, hintsUsed: 0, responseTimeSec: 5 });\r\n  if (test4 !== SCORING_CONFIG.RETRY_PARTIAL) {\r\n    issues.push(`Correct on retry should be ${SCORING_CONFIG.RETRY_PARTIAL}, got ${test4}`);\r\n  }\r\n\r\n  // Test 5: Incorrect = 0\r\n  const test5 = calculateQuestionScore({ isCorrect: false, attempts: 1, hintsUsed: 0, responseTimeSec: 5 });\r\n  if (test5 !== 0) {\r\n    issues.push(`Incorrect should be 0, got ${test5}`);\r\n  }\r\n\r\n  // Test 6: Many hints should not go below 0\r\n  const test6 = calculateQuestionScore({ isCorrect: true, attempts: 1, hintsUsed: 100, responseTimeSec: 5 });\r\n  if (test6 < 0) {\r\n    issues.push(`Score should not be negative, got ${test6}`);\r\n  }\r\n\r\n  const hasCritical = issues.length > 0;\r\n\r\n  return {\r\n    id: 'scoring_policy_validation',\r\n    name: 'Scoring Policy Validation',\r\n    nameHe: '×‘×“×™×§×ª ××“×™× ×™×•×ª × ×™×§×•×“',\r\n    category: 'student-activity',\r\n    status: hasCritical ? 'failed' : 'passed',\r\n    severity: hasCritical ? 'critical' : 'low',\r\n    message: hasCritical ? `${issues.length} scoring policy violations` : 'All scoring rules validated correctly',\r\n    messageHe: hasCritical ? `${issues.length} ×”×¤×¨×•×ª ××“×™× ×™×•×ª × ×™×§×•×“` : '×›×œ ×›×œ×œ×™ ×”× ×™×§×•×“ ×ª×§×™× ×™×',\r\n    details: {\r\n      testedRules: [\r\n        'Correct first try = 100',\r\n        `Hint penalty = ${SCORING_CONFIG.HINT_PENALTY} per hint`,\r\n        `Retry partial = ${SCORING_CONFIG.RETRY_PARTIAL}`,\r\n        'Incorrect = 0',\r\n        'Score >= 0 always'\r\n      ],\r\n      issues,\r\n      config: SCORING_CONFIG\r\n    },\r\n    duration: 0,\r\n    timestamp: new Date()\r\n  };\r\n}\r\n\r\nexport { runActivitySession, validateScoringPolicy };\r\n","/**\r\n * Assessment Integrity Agent\r\n * ×¡×•×›×Ÿ ××™× ×˜×’×¨×™×˜×™ ×”×¢×¨×›×” - ×‘×•×“×§ ×©××¢×¨×›×ª ×”×”×¢×¨×›×” ×•×”× ×™×§×•×“ ×ª×§×™× ×”\r\n *\r\n * This agent validates that:\r\n * 1. Scoring follows the defined policy (100 first try, -2 per hint, 50 retry, 0 incorrect)\r\n * 2. Hints are disabled in exam mode\r\n * 3. XP and gems are awarded correctly\r\n * 4. Bloom's taxonomy affects scoring appropriately\r\n * 5. Rubrics are present for open questions\r\n * 6. All interactive blocks have correct answers defined\r\n * 7. Exam questions don't contain teaching content or hints\r\n */\r\n\r\nimport { db } from '../../firebase';\r\nimport { collection, getDocs, query, limit as firestoreLimit, orderBy } from 'firebase/firestore';\r\nimport type { TestResult, QAAgentResult } from '../../types/qa.types';\r\nimport type { Course, ActivityBlock } from '../../shared/types/courseTypes';\r\nimport { SCORING_CONFIG, calculateQuestionScore } from '../../utils/scoring';\r\n\r\n// ===== ASSESSMENT POLICY RULES =====\r\n\r\nexport const ASSESSMENT_POLICY = {\r\n  // Scoring rules\r\n  scoring: {\r\n    CORRECT_FIRST_TRY: 100,\r\n    HINT_PENALTY: 2,         // Points deducted per hint\r\n    RETRY_PARTIAL: 50,        // Score for correct on retry\r\n    INCORRECT: 0,\r\n    MIN_SCORE: 0,             // Score cannot go below 0\r\n  },\r\n\r\n  // Exam mode rules\r\n  examMode: {\r\n    HINTS_FORBIDDEN: true,\r\n    TEACHING_CONTENT_FORBIDDEN: true,\r\n    PROGRESSIVE_HINTS_FORBIDDEN: true,\r\n    FRIENDLY_TONE_FORBIDDEN: true,\r\n  },\r\n\r\n  // Gamification rules\r\n  gamification: {\r\n    XP_EQUALS_SCORE: true,    // XP gain = score\r\n    GEMS_ON_CORRECT: 1,       // 1 gem for correct answer\r\n    GEMS_ON_PERFECT: 2,       // 2 gems for perfect score (100)\r\n    GEMS_ON_INCORRECT: 0,\r\n  },\r\n\r\n  // Content requirements\r\n  contentRequirements: {\r\n    MC_MIN_OPTIONS: 3,        // Multiple choice needs at least 3 options\r\n    MC_MAX_OPTIONS: 5,        // Multiple choice should have at most 5 options\r\n    ORDERING_MIN_ITEMS: 3,    // Ordering needs at least 3 items\r\n    OPEN_QUESTION_NEEDS_RUBRIC: true,\r\n    OPEN_QUESTION_NEEDS_MODEL_ANSWER: false, // Recommended but not required\r\n  },\r\n\r\n  // Bloom's taxonomy scoring multipliers (for exams)\r\n  bloomMultipliers: {\r\n    'remember': 1.0,\r\n    'understand': 1.2,\r\n    'apply': 1.5,\r\n    'analyze': 1.7,\r\n    'evaluate': 2.0,\r\n    'create': 2.2,\r\n  }\r\n};\r\n\r\n// ===== TYPES =====\r\n\r\nexport interface PolicyViolation {\r\n  type: 'scoring' | 'exam_mode' | 'gamification' | 'content' | 'bloom' | 'rubric' | 'answer_mismatch';\r\n  rule: string;\r\n  ruleHe: string;\r\n  severity: 'critical' | 'high' | 'medium' | 'low';\r\n  location: string;  // courseId/unitId/blockId\r\n  message: string;\r\n  messageHe: string;\r\n  expected?: any;\r\n  actual?: any;\r\n}\r\n\r\nexport interface BlockAssessmentResult {\r\n  blockId: string;\r\n  blockType: string;\r\n  courseId: string;\r\n  unitId: string;\r\n  isExamContent: boolean;\r\n  violations: PolicyViolation[];\r\n  checks: {\r\n    hasCorrectAnswer: boolean;\r\n    correctAnswerInOptions: boolean;\r\n    hasEnoughOptions: boolean;\r\n    hasRubric: boolean;\r\n    hasModelAnswer: boolean;\r\n    hasBloomLevel: boolean;\r\n    noHintsInExam: boolean;\r\n    noTeachingInExam: boolean;\r\n  };\r\n}\r\n\r\nexport interface CourseAssessmentResult {\r\n  courseId: string;\r\n  courseTitle: string;\r\n  totalBlocks: number;\r\n  interactiveBlocks: number;\r\n  examBlocks: number;\r\n  violations: PolicyViolation[];\r\n  blockResults: BlockAssessmentResult[];\r\n  summary: {\r\n    critical: number;\r\n    high: number;\r\n    medium: number;\r\n    low: number;\r\n  };\r\n}\r\n\r\n// ===== BLOCK VALIDATORS =====\r\n\r\nfunction validateMultipleChoiceBlock(\r\n  block: ActivityBlock,\r\n  courseId: string,\r\n  unitId: string,\r\n  isExamContent: boolean\r\n): BlockAssessmentResult {\r\n  const violations: PolicyViolation[] = [];\r\n  const content = block.content || {};\r\n  const metadata = block.metadata || {};\r\n  const location = `${courseId}/${unitId}/${block.id}`;\r\n\r\n  const options = content.options || [];\r\n  const correctAnswer = content.correctAnswer || content.correct_answer;\r\n  const hints = metadata.progressiveHints || [];\r\n  const teachContent = metadata.teach_content || metadata.teachContent;\r\n  const bloomLevel = metadata.bloomLevel || metadata.bloom_level;\r\n\r\n  // Check 1: Has correct answer\r\n  const hasCorrectAnswer = !!correctAnswer;\r\n  if (!hasCorrectAnswer) {\r\n    violations.push({\r\n      type: 'content',\r\n      rule: 'MC must have correctAnswer',\r\n      ruleHe: '×©××œ×ª ×‘×—×™×¨×” ×—×™×™×‘×ª ×ª×©×•×‘×” × ×›×•× ×”',\r\n      severity: 'critical',\r\n      location,\r\n      message: 'Multiple choice block has no correct answer defined',\r\n      messageHe: '×‘×œ×•×§ ×‘×—×™×¨×” ××¨×•×‘×” ×œ×œ× ×ª×©×•×‘×” × ×›×•× ×” ××•×’×“×¨×ª'\r\n    });\r\n  }\r\n\r\n  // Check 2: Correct answer in options\r\n  let correctAnswerInOptions = false;\r\n  if (correctAnswer && options.length > 0) {\r\n    const optionTexts = options.map((o: any) =>\r\n      typeof o === 'string' ? o : (o.text || o.label || o.value || o.answer || '')\r\n    );\r\n    correctAnswerInOptions = optionTexts.includes(correctAnswer);\r\n\r\n    if (!correctAnswerInOptions) {\r\n      violations.push({\r\n        type: 'answer_mismatch',\r\n        rule: 'correctAnswer must match an option',\r\n        ruleHe: '×”×ª×©×•×‘×” ×”× ×›×•× ×” ×—×™×™×‘×ª ×œ×”×ª××™× ×œ××—×ª ×”××¤×©×¨×•×™×•×ª',\r\n        severity: 'critical',\r\n        location,\r\n        message: `Correct answer \"${correctAnswer}\" not found in options`,\r\n        messageHe: `×”×ª×©×•×‘×” ×”× ×›×•× ×” \"${correctAnswer}\" ×œ× × ××¦××ª ×‘××¤×©×¨×•×™×•×ª`,\r\n        expected: correctAnswer,\r\n        actual: optionTexts\r\n      });\r\n    }\r\n  }\r\n\r\n  // Check 3: Enough options\r\n  const hasEnoughOptions = options.length >= ASSESSMENT_POLICY.contentRequirements.MC_MIN_OPTIONS;\r\n  if (!hasEnoughOptions && options.length > 0) {\r\n    violations.push({\r\n      type: 'content',\r\n      rule: `MC needs at least ${ASSESSMENT_POLICY.contentRequirements.MC_MIN_OPTIONS} options`,\r\n      ruleHe: `×©××œ×ª ×‘×—×™×¨×” ×¦×¨×™×›×” ×œ×¤×—×•×ª ${ASSESSMENT_POLICY.contentRequirements.MC_MIN_OPTIONS} ××¤×©×¨×•×™×•×ª`,\r\n      severity: 'medium',\r\n      location,\r\n      message: `Only ${options.length} options, need at least ${ASSESSMENT_POLICY.contentRequirements.MC_MIN_OPTIONS}`,\r\n      messageHe: `×¨×§ ${options.length} ××¤×©×¨×•×™×•×ª, ×¦×¨×™×š ×œ×¤×—×•×ª ${ASSESSMENT_POLICY.contentRequirements.MC_MIN_OPTIONS}`,\r\n      expected: ASSESSMENT_POLICY.contentRequirements.MC_MIN_OPTIONS,\r\n      actual: options.length\r\n    });\r\n  }\r\n\r\n  // Check 4: No hints in exam mode\r\n  let noHintsInExam = true;\r\n  if (isExamContent && hints.length > 0) {\r\n    noHintsInExam = false;\r\n    violations.push({\r\n      type: 'exam_mode',\r\n      rule: 'No hints in exam mode',\r\n      ruleHe: '××™×Ÿ ×¨××–×™× ×‘××¦×‘ ××‘×—×Ÿ',\r\n      severity: 'critical',\r\n      location,\r\n      message: `Exam block has ${hints.length} hints which should be forbidden`,\r\n      messageHe: `×‘×œ×•×§ ××‘×—×Ÿ ××›×™×œ ${hints.length} ×¨××–×™× ×©×¦×¨×™×›×™× ×œ×”×™×•×ª ×—×¡×•××™×`,\r\n      expected: 0,\r\n      actual: hints.length\r\n    });\r\n  }\r\n\r\n  // Check 5: No teaching content in exam mode\r\n  let noTeachingInExam = true;\r\n  if (isExamContent && teachContent) {\r\n    noTeachingInExam = false;\r\n    violations.push({\r\n      type: 'exam_mode',\r\n      rule: 'No teaching content in exam mode',\r\n      ruleHe: '××™×Ÿ ×ª×•×›×Ÿ ×œ×™××•×“×™ ×‘××¦×‘ ××‘×—×Ÿ',\r\n      severity: 'high',\r\n      location,\r\n      message: 'Exam block contains teaching content which reveals answers',\r\n      messageHe: '×‘×œ×•×§ ××‘×—×Ÿ ××›×™×œ ×ª×•×›×Ÿ ×œ×™××•×“×™ ×©×—×•×©×£ ×ª×©×•×‘×•×ª'\r\n    });\r\n  }\r\n\r\n  // Check 6: Has Bloom level (recommended)\r\n  const hasBloomLevel = !!bloomLevel;\r\n  if (!hasBloomLevel && isExamContent) {\r\n    violations.push({\r\n      type: 'bloom',\r\n      rule: 'Exam questions should have Bloom level',\r\n      ruleHe: '×©××œ×•×ª ××‘×—×Ÿ ×¦×¨×™×›×•×ª ×¨××ª ×‘×œ×•×',\r\n      severity: 'low',\r\n      location,\r\n      message: 'Exam block missing Bloom taxonomy level for proper scoring',\r\n      messageHe: '×‘×œ×•×§ ××‘×—×Ÿ ×—×¡×¨ ×¨××ª ×‘×œ×•× ×œ× ×™×§×•×“ ×ª×§×™×Ÿ'\r\n    });\r\n  }\r\n\r\n  return {\r\n    blockId: block.id,\r\n    blockType: block.type,\r\n    courseId,\r\n    unitId,\r\n    isExamContent,\r\n    violations,\r\n    checks: {\r\n      hasCorrectAnswer,\r\n      correctAnswerInOptions,\r\n      hasEnoughOptions,\r\n      hasRubric: false, // N/A for MC\r\n      hasModelAnswer: false, // N/A for MC\r\n      hasBloomLevel,\r\n      noHintsInExam,\r\n      noTeachingInExam\r\n    }\r\n  };\r\n}\r\n\r\nfunction validateOpenQuestionBlock(\r\n  block: ActivityBlock,\r\n  courseId: string,\r\n  unitId: string,\r\n  isExamContent: boolean\r\n): BlockAssessmentResult {\r\n  const violations: PolicyViolation[] = [];\r\n  const content = block.content || {};\r\n  const metadata = block.metadata || {};\r\n  const location = `${courseId}/${unitId}/${block.id}`;\r\n\r\n  const rubric = metadata.rubric || metadata.analytic_rubric;\r\n  const modelAnswer = metadata.modelAnswer || metadata.model_answer || content.modelAnswer;\r\n  const bloomLevel = metadata.bloomLevel || metadata.bloom_level;\r\n  const hints = metadata.progressiveHints || [];\r\n\r\n  // Check 1: Has rubric (required for exams)\r\n  const hasRubric = !!rubric;\r\n  if (!hasRubric && isExamContent && ASSESSMENT_POLICY.contentRequirements.OPEN_QUESTION_NEEDS_RUBRIC) {\r\n    violations.push({\r\n      type: 'rubric',\r\n      rule: 'Open questions in exams need rubric',\r\n      ruleHe: '×©××œ×•×ª ×¤×ª×•×—×•×ª ×‘××‘×—×Ÿ ×¦×¨×™×›×•×ª ×¨×•×‘×¨×™×§×”',\r\n      severity: 'high',\r\n      location,\r\n      message: 'Exam open question missing grading rubric',\r\n      messageHe: '×©××œ×” ×¤×ª×•×—×” ×‘××‘×—×Ÿ ×—×¡×¨×” ×¨×•×‘×¨×™×§×ª ×”×¢×¨×›×”'\r\n    });\r\n  }\r\n\r\n  // Check 2: Has model answer (recommended)\r\n  const hasModelAnswer = !!modelAnswer;\r\n  if (!hasModelAnswer && isExamContent) {\r\n    violations.push({\r\n      type: 'content',\r\n      rule: 'Open questions should have model answer',\r\n      ruleHe: '×©××œ×•×ª ×¤×ª×•×—×•×ª ×¦×¨×™×›×•×ª ×ª×©×•×‘×” ×œ×“×•×’××”',\r\n      severity: 'low',\r\n      location,\r\n      message: 'Open question missing model answer for AI grading',\r\n      messageHe: '×©××œ×” ×¤×ª×•×—×” ×—×¡×¨×” ×ª×©×•×‘×” ×œ×“×•×’××” ×œ×¦×™×•×Ÿ AI'\r\n    });\r\n  }\r\n\r\n  // Check 3: No hints in exam\r\n  let noHintsInExam = true;\r\n  if (isExamContent && hints.length > 0) {\r\n    noHintsInExam = false;\r\n    violations.push({\r\n      type: 'exam_mode',\r\n      rule: 'No hints in exam mode',\r\n      ruleHe: '××™×Ÿ ×¨××–×™× ×‘××¦×‘ ××‘×—×Ÿ',\r\n      severity: 'critical',\r\n      location,\r\n      message: `Exam open question has ${hints.length} hints`,\r\n      messageHe: `×©××œ×” ×¤×ª×•×—×” ×‘××‘×—×Ÿ ××›×™×œ×” ${hints.length} ×¨××–×™×`,\r\n      expected: 0,\r\n      actual: hints.length\r\n    });\r\n  }\r\n\r\n  // Check 4: Has Bloom level\r\n  const hasBloomLevel = !!bloomLevel;\r\n\r\n  return {\r\n    blockId: block.id,\r\n    blockType: block.type,\r\n    courseId,\r\n    unitId,\r\n    isExamContent,\r\n    violations,\r\n    checks: {\r\n      hasCorrectAnswer: true, // N/A, AI graded\r\n      correctAnswerInOptions: true, // N/A\r\n      hasEnoughOptions: true, // N/A\r\n      hasRubric,\r\n      hasModelAnswer,\r\n      hasBloomLevel,\r\n      noHintsInExam,\r\n      noTeachingInExam: true\r\n    }\r\n  };\r\n}\r\n\r\nfunction validateOrderingBlock(\r\n  block: ActivityBlock,\r\n  courseId: string,\r\n  unitId: string,\r\n  isExamContent: boolean\r\n): BlockAssessmentResult {\r\n  const violations: PolicyViolation[] = [];\r\n  const content = block.content || {};\r\n  const metadata = block.metadata || {};\r\n  const location = `${courseId}/${unitId}/${block.id}`;\r\n\r\n  const correctOrder = content.correct_order || content.correctOrder || [];\r\n  const hints = metadata.progressiveHints || [];\r\n\r\n  // Check 1: Has correct order\r\n  const hasCorrectAnswer = correctOrder.length >= ASSESSMENT_POLICY.contentRequirements.ORDERING_MIN_ITEMS;\r\n  if (!hasCorrectAnswer) {\r\n    violations.push({\r\n      type: 'content',\r\n      rule: `Ordering needs at least ${ASSESSMENT_POLICY.contentRequirements.ORDERING_MIN_ITEMS} items`,\r\n      ruleHe: `×¡×™×“×•×¨ ×¦×¨×™×š ×œ×¤×—×•×ª ${ASSESSMENT_POLICY.contentRequirements.ORDERING_MIN_ITEMS} ×¤×¨×™×˜×™×`,\r\n      severity: 'high',\r\n      location,\r\n      message: `Ordering has ${correctOrder.length} items, need at least ${ASSESSMENT_POLICY.contentRequirements.ORDERING_MIN_ITEMS}`,\r\n      messageHe: `×œ×¡×™×“×•×¨ ×™×© ${correctOrder.length} ×¤×¨×™×˜×™×, ×¦×¨×™×š ×œ×¤×—×•×ª ${ASSESSMENT_POLICY.contentRequirements.ORDERING_MIN_ITEMS}`,\r\n      expected: ASSESSMENT_POLICY.contentRequirements.ORDERING_MIN_ITEMS,\r\n      actual: correctOrder.length\r\n    });\r\n  }\r\n\r\n  // Check 2: No hints in exam\r\n  let noHintsInExam = true;\r\n  if (isExamContent && hints.length > 0) {\r\n    noHintsInExam = false;\r\n    violations.push({\r\n      type: 'exam_mode',\r\n      rule: 'No hints in exam mode',\r\n      ruleHe: '××™×Ÿ ×¨××–×™× ×‘××¦×‘ ××‘×—×Ÿ',\r\n      severity: 'critical',\r\n      location,\r\n      message: `Exam ordering has ${hints.length} hints`,\r\n      messageHe: `×¡×™×“×•×¨ ×‘××‘×—×Ÿ ××›×™×œ ${hints.length} ×¨××–×™×`\r\n    });\r\n  }\r\n\r\n  return {\r\n    blockId: block.id,\r\n    blockType: block.type,\r\n    courseId,\r\n    unitId,\r\n    isExamContent,\r\n    violations,\r\n    checks: {\r\n      hasCorrectAnswer,\r\n      correctAnswerInOptions: true,\r\n      hasEnoughOptions: true,\r\n      hasRubric: false,\r\n      hasModelAnswer: false,\r\n      hasBloomLevel: !!metadata.bloomLevel,\r\n      noHintsInExam,\r\n      noTeachingInExam: true\r\n    }\r\n  };\r\n}\r\n\r\nfunction validateBlock(\r\n  block: ActivityBlock,\r\n  courseId: string,\r\n  unitId: string,\r\n  isExamContent: boolean\r\n): BlockAssessmentResult | null {\r\n  switch (block.type) {\r\n    case 'multiple-choice':\r\n    case 'true-false':\r\n      return validateMultipleChoiceBlock(block, courseId, unitId, isExamContent);\r\n    case 'open-question':\r\n      return validateOpenQuestionBlock(block, courseId, unitId, isExamContent);\r\n    case 'ordering':\r\n      return validateOrderingBlock(block, courseId, unitId, isExamContent);\r\n    default:\r\n      return null; // Non-graded block types\r\n  }\r\n}\r\n\r\n// ===== SCORING VALIDATION =====\r\n\r\nfunction validateScoringRules(): PolicyViolation[] {\r\n  const violations: PolicyViolation[] = [];\r\n\r\n  // Test scoring function against policy\r\n  const testCases = [\r\n    { isCorrect: true, attempts: 1, hintsUsed: 0, expected: ASSESSMENT_POLICY.scoring.CORRECT_FIRST_TRY },\r\n    { isCorrect: true, attempts: 1, hintsUsed: 1, expected: ASSESSMENT_POLICY.scoring.CORRECT_FIRST_TRY - ASSESSMENT_POLICY.scoring.HINT_PENALTY },\r\n    { isCorrect: true, attempts: 1, hintsUsed: 5, expected: ASSESSMENT_POLICY.scoring.CORRECT_FIRST_TRY - (5 * ASSESSMENT_POLICY.scoring.HINT_PENALTY) },\r\n    { isCorrect: true, attempts: 2, hintsUsed: 0, expected: ASSESSMENT_POLICY.scoring.RETRY_PARTIAL },\r\n    { isCorrect: true, attempts: 3, hintsUsed: 0, expected: ASSESSMENT_POLICY.scoring.RETRY_PARTIAL },\r\n    { isCorrect: false, attempts: 1, hintsUsed: 0, expected: ASSESSMENT_POLICY.scoring.INCORRECT },\r\n    { isCorrect: false, attempts: 5, hintsUsed: 10, expected: ASSESSMENT_POLICY.scoring.INCORRECT },\r\n  ];\r\n\r\n  for (const tc of testCases) {\r\n    const actual = calculateQuestionScore({\r\n      isCorrect: tc.isCorrect,\r\n      attempts: tc.attempts,\r\n      hintsUsed: tc.hintsUsed,\r\n      responseTimeSec: 5\r\n    });\r\n\r\n    if (actual !== tc.expected) {\r\n      violations.push({\r\n        type: 'scoring',\r\n        rule: 'Scoring function must match policy',\r\n        ruleHe: '×¤×•× ×§×¦×™×™×ª × ×™×§×•×“ ×—×™×™×‘×ª ×œ×”×ª××™× ×œ××“×™× ×™×•×ª',\r\n        severity: 'critical',\r\n        location: 'scoring.ts',\r\n        message: `Score mismatch: correct=${tc.isCorrect}, attempts=${tc.attempts}, hints=${tc.hintsUsed} â†’ expected ${tc.expected}, got ${actual}`,\r\n        messageHe: `××™-×”×ª×××ª × ×™×§×•×“: × ×›×•×Ÿ=${tc.isCorrect}, × ×™×¡×™×•× ×•×ª=${tc.attempts}, ×¨××–×™×=${tc.hintsUsed} â†’ ×¦×¤×•×™ ${tc.expected}, ×”×ª×§×‘×œ ${actual}`,\r\n        expected: tc.expected,\r\n        actual\r\n      });\r\n    }\r\n  }\r\n\r\n  // Test score never goes below MIN_SCORE\r\n  const extremeCase = calculateQuestionScore({\r\n    isCorrect: true,\r\n    attempts: 1,\r\n    hintsUsed: 1000, // Absurd number of hints\r\n    responseTimeSec: 5\r\n  });\r\n\r\n  if (extremeCase < ASSESSMENT_POLICY.scoring.MIN_SCORE) {\r\n    violations.push({\r\n      type: 'scoring',\r\n      rule: 'Score cannot be negative',\r\n      ruleHe: '× ×™×§×•×“ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×©×œ×™×œ×™',\r\n      severity: 'critical',\r\n      location: 'scoring.ts',\r\n      message: `Score went below ${ASSESSMENT_POLICY.scoring.MIN_SCORE} with many hints: ${extremeCase}`,\r\n      messageHe: `×”× ×™×§×•×“ ×™×¨×“ ××ª×—×ª ×œ-${ASSESSMENT_POLICY.scoring.MIN_SCORE} ×¢× ×”×¨×‘×” ×¨××–×™×: ${extremeCase}`,\r\n      expected: `>= ${ASSESSMENT_POLICY.scoring.MIN_SCORE}`,\r\n      actual: extremeCase\r\n    });\r\n  }\r\n\r\n  return violations;\r\n}\r\n\r\n// ===== COURSE VALIDATOR =====\r\n\r\nfunction validateCourseAssessment(course: Course): CourseAssessmentResult {\r\n  const violations: PolicyViolation[] = [];\r\n  const blockResults: BlockAssessmentResult[] = [];\r\n  const modules = course.syllabus || [];\r\n\r\n  let totalBlocks = 0;\r\n  let interactiveBlocks = 0;\r\n  let examBlocks = 0;\r\n\r\n  // Detect if course is exam-type\r\n  const isExamCourse = course.contentType === 'exam' ||\r\n                       course.title?.toLowerCase().includes('××‘×—×Ÿ') ||\r\n                       course.title?.toLowerCase().includes('exam');\r\n\r\n  for (const module of modules) {\r\n    for (const unit of module.learningUnits || []) {\r\n      // Check if unit is exam-type\r\n      const isExamUnit = unit.title?.toLowerCase().includes('××‘×—×Ÿ') ||\r\n                        unit.title?.toLowerCase().includes('exam') ||\r\n                        (unit as any).isExam === true;\r\n\r\n      for (const block of unit.activityBlocks || []) {\r\n        totalBlocks++;\r\n\r\n        const isInteractive = ['multiple-choice', 'true-false', 'open-question',\r\n                              'ordering', 'categorization', 'fill-in-blanks'].includes(block.type);\r\n\r\n        if (isInteractive) {\r\n          interactiveBlocks++;\r\n\r\n          // Check if block is exam content\r\n          const isExamBlock = isExamCourse || isExamUnit ||\r\n                             block.metadata?.isExam === true ||\r\n                             block.metadata?.mode === 'exam';\r\n\r\n          if (isExamBlock) examBlocks++;\r\n\r\n          const result = validateBlock(block, course.id, unit.id, isExamBlock);\r\n          if (result) {\r\n            blockResults.push(result);\r\n            violations.push(...result.violations);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Count by severity\r\n  const summary = {\r\n    critical: violations.filter(v => v.severity === 'critical').length,\r\n    high: violations.filter(v => v.severity === 'high').length,\r\n    medium: violations.filter(v => v.severity === 'medium').length,\r\n    low: violations.filter(v => v.severity === 'low').length\r\n  };\r\n\r\n  return {\r\n    courseId: course.id,\r\n    courseTitle: course.title || course.id,\r\n    totalBlocks,\r\n    interactiveBlocks,\r\n    examBlocks,\r\n    violations,\r\n    blockResults,\r\n    summary\r\n  };\r\n}\r\n\r\n// ===== MAIN AGENT FUNCTION =====\r\n\r\nexport async function runAssessmentIntegrityAgent(\r\n  maxCourses: number = 10\r\n): Promise<QAAgentResult> {\r\n  const startTime = Date.now();\r\n  const allResults: TestResult[] = [];\r\n\r\n  console.log('âš–ï¸ Assessment Integrity Agent starting...');\r\n  console.log(`   Validating scoring policy and assessment integrity on ${maxCourses} courses...`);\r\n\r\n  try {\r\n    // First, validate the scoring rules themselves\r\n    const scoringViolations = validateScoringRules();\r\n\r\n    const scoringTest: TestResult = {\r\n      id: 'scoring_rules_validation',\r\n      name: 'Scoring Rules Validation',\r\n      nameHe: '×‘×“×™×§×ª ×›×œ×œ×™ × ×™×§×•×“',\r\n      category: 'assessment-integrity',\r\n      status: scoringViolations.length === 0 ? 'passed' : 'failed',\r\n      severity: scoringViolations.length > 0 ? 'critical' : 'low',\r\n      message: scoringViolations.length === 0\r\n        ? 'All scoring rules follow policy correctly'\r\n        : `${scoringViolations.length} scoring policy violations found`,\r\n      messageHe: scoringViolations.length === 0\r\n        ? '×›×œ ×›×œ×œ×™ ×”× ×™×§×•×“ ×ª×•×××™× ×œ××“×™× ×™×•×ª'\r\n        : `× ××¦××• ${scoringViolations.length} ×”×¤×¨×•×ª ××“×™× ×™×•×ª × ×™×§×•×“`,\r\n      details: {\r\n        policy: ASSESSMENT_POLICY.scoring,\r\n        violations: scoringViolations\r\n      },\r\n      duration: 0,\r\n      timestamp: new Date()\r\n    };\r\n\r\n    allResults.push(scoringTest);\r\n\r\n    // Fetch courses\r\n    const coursesQuery = query(\r\n      collection(db, 'courses'),\r\n      orderBy('createdAt', 'desc'),\r\n      firestoreLimit(maxCourses)\r\n    );\r\n    const snapshot = await getDocs(coursesQuery);\r\n\r\n    let totalTests = 1; // Already counted scoring test\r\n    let passedTests = scoringViolations.length === 0 ? 1 : 0;\r\n    let failedTests = scoringViolations.length > 0 ? 1 : 0;\r\n    const criticalIssues: TestResult[] = [];\r\n\r\n    if (scoringViolations.length > 0) {\r\n      criticalIssues.push(scoringTest);\r\n    }\r\n\r\n    for (const docSnap of snapshot.docs) {\r\n      const course = { id: docSnap.id, ...docSnap.data() } as Course;\r\n      totalTests++;\r\n\r\n      const result = validateCourseAssessment(course);\r\n      const hasCritical = result.summary.critical > 0;\r\n      const hasHigh = result.summary.high > 0;\r\n\r\n      const status = hasCritical ? 'failed' :\r\n                    hasHigh ? 'warning' : 'passed';\r\n\r\n      const testResult: TestResult = {\r\n        id: `assessment_${course.id}`,\r\n        name: `Assessment Integrity: ${course.title || course.id}`,\r\n        nameHe: `××™× ×˜×’×¨×™×˜×™ ×”×¢×¨×›×”: ${course.title || course.id}`,\r\n        category: 'assessment-integrity',\r\n        status,\r\n        severity: hasCritical ? 'critical' : hasHigh ? 'high' : 'low',\r\n        message: `Blocks: ${result.interactiveBlocks}/${result.totalBlocks} | ` +\r\n                 `Exam: ${result.examBlocks} | ` +\r\n                 `Violations: ${result.violations.length} (${result.summary.critical} critical)`,\r\n        messageHe: `×‘×œ×•×§×™×: ${result.interactiveBlocks}/${result.totalBlocks} | ` +\r\n                   `××‘×—×Ÿ: ${result.examBlocks} | ` +\r\n                   `×”×¤×¨×•×ª: ${result.violations.length} (${result.summary.critical} ×§×¨×™×˜×™×•×ª)`,\r\n        details: {\r\n          courseId: course.id,\r\n          courseTitle: course.title,\r\n          statistics: {\r\n            totalBlocks: result.totalBlocks,\r\n            interactiveBlocks: result.interactiveBlocks,\r\n            examBlocks: result.examBlocks\r\n          },\r\n          summary: result.summary,\r\n          violations: result.violations,\r\n          blockResults: result.blockResults.filter(b => b.violations.length > 0)\r\n        },\r\n        duration: 0,\r\n        timestamp: new Date()\r\n      };\r\n\r\n      allResults.push(testResult);\r\n\r\n      if (status === 'passed') {\r\n        passedTests++;\r\n      } else {\r\n        failedTests++;\r\n        if (hasCritical) {\r\n          criticalIssues.push(testResult);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Add summary test\r\n    totalTests++;\r\n    const overallViolations = allResults.reduce((sum, r) => {\r\n      const details = r.details as any;\r\n      return sum + (details?.violations?.length || 0);\r\n    }, 0);\r\n\r\n    const summaryTest: TestResult = {\r\n      id: 'assessment_summary',\r\n      name: 'Assessment Integrity Summary',\r\n      nameHe: '×¡×™×›×•× ××™× ×˜×’×¨×™×˜×™ ×”×¢×¨×›×”',\r\n      category: 'assessment-integrity',\r\n      status: criticalIssues.length === 0 ? 'passed' : 'failed',\r\n      severity: criticalIssues.length > 0 ? 'critical' : 'low',\r\n      message: `Total violations: ${overallViolations} across ${snapshot.size} courses`,\r\n      messageHe: `×¡×”\"×› ×”×¤×¨×•×ª: ${overallViolations} ×‘-${snapshot.size} ×§×•×¨×¡×™×`,\r\n      details: {\r\n        coursesChecked: snapshot.size,\r\n        totalViolations: overallViolations,\r\n        criticalCount: criticalIssues.length,\r\n        policy: ASSESSMENT_POLICY\r\n      },\r\n      duration: Date.now() - startTime,\r\n      timestamp: new Date()\r\n    };\r\n\r\n    allResults.push(summaryTest);\r\n    if (summaryTest.status === 'passed') passedTests++;\r\n    else failedTests++;\r\n\r\n    console.log(`âœ… Assessment Integrity Agent completed: ${passedTests}/${totalTests} passed`);\r\n    console.log(`   Total violations found: ${overallViolations}`);\r\n\r\n    return {\r\n      agentType: 'assessment-integrity',\r\n      success: criticalIssues.length === 0,\r\n      duration: Date.now() - startTime,\r\n      testsRun: totalTests,\r\n      testsPassed: passedTests,\r\n      testsFailed: failedTests,\r\n      criticalIssues,\r\n      allResults\r\n    };\r\n\r\n  } catch (error: any) {\r\n    console.error('âŒ Assessment Integrity Agent failed:', error);\r\n\r\n    return {\r\n      agentType: 'assessment-integrity',\r\n      success: false,\r\n      duration: Date.now() - startTime,\r\n      testsRun: 0,\r\n      testsPassed: 0,\r\n      testsFailed: 1,\r\n      criticalIssues: [{\r\n        id: 'assessment_agent_error',\r\n        name: 'Assessment Integrity Error',\r\n        nameHe: '×©×’×™××ª ××™× ×˜×’×¨×™×˜×™ ×”×¢×¨×›×”',\r\n        category: 'assessment-integrity',\r\n        status: 'failed',\r\n        severity: 'critical',\r\n        message: error.message,\r\n        messageHe: error.message,\r\n        duration: Date.now() - startTime,\r\n        timestamp: new Date()\r\n      }],\r\n      allResults: []\r\n    };\r\n  }\r\n}\r\n\r\nexport {\r\n  validateCourseAssessment,\r\n  validateScoringRules,\r\n  validateBlock\r\n};\r\n","/**\r\n * Knowledge Base Integration QA Agent\r\n * ×¡×•×›×Ÿ ×‘×“×™×§×•×ª ×œ××™× ×˜×’×¨×¦×™×™×ª ×‘×¡×™×¡ ×”×™×“×¢\r\n *\r\n * ×‘×•×“×§:\r\n * 1. ×©×œ×™×¤×” ××‘×¡×™×¡ ×”×™×“×¢ ×¢×•×‘×“×ª\r\n * 2. ×—×™×œ×•×¥ ××œ×× ×˜×™× ×¤×“×’×•×’×™×™× (×ª×¨×’×™×œ×™×, ×˜×¢×•×™×•×ª, ×©×¤×”)\r\n * 3. ×™×™×©×•× ×”×”×§×©×¨ ×‘×™×¦×™×¨×ª ×ª×•×›×Ÿ AI\r\n * 4. ×”×ª×××ª ×”×©×¤×” ×•×”×¡×’× ×•×Ÿ ×œ×¡×¤×¨ ×”×œ×™××•×“\r\n */\r\n\r\nimport type {\r\n  TestResult,\r\n  QAAgentResult,\r\n} from '../../types/qa.types';\r\n\r\nimport {\r\n  searchKnowledge,\r\n  getMathPedagogicalContext,\r\n  formatPedagogicalContextForPrompt,\r\n} from '../knowledgeBaseService';\r\n\r\nimport { generateSingleMultipleChoiceQuestion, generateStepContent } from '../../gemini';\r\nimport type { SkeletonStep } from '../../types/learning.types';\r\n\r\n// ===== TEST CONFIGURATION =====\r\n\r\n// Dynamic test topics - will be populated based on actual KB content\r\nconst DEFAULT_TEST_TOPICS = [\r\n  // Generic topics that should match most math content\r\n  { topic: '××¡×¤×¨×™×', grade: '×', description: 'Numbers for grade 1' },\r\n  { topic: '××¡×¤×¨×™×', grade: '×‘', description: 'Numbers for grade 2' },\r\n  { topic: '×ª×¨×’×™×œ×™×', grade: '×', description: 'Exercises for grade 1' },\r\n  { topic: '×ª×¨×’×™×œ×™×', grade: '×‘', description: 'Exercises for grade 2' },\r\n  { topic: '×—×™×‘×•×¨ ×•×—×™×¡×•×¨', grade: '×', description: 'Addition and subtraction grade 1' },\r\n  { topic: '×—×™×‘×•×¨ ×•×—×™×¡×•×¨', grade: '×‘', description: 'Addition and subtraction grade 2' },\r\n];\r\n\r\n// Expected patterns that should be extracted from textbooks\r\nconst EXPECTED_EXTRACTION_PATTERNS = {\r\n  questionPhrasing: [\r\n    /×›××”/,\r\n    /××”/,\r\n    /×—×©×‘/,\r\n    /×¤×ª×•×¨/,\r\n    /×”×©×œ×/,\r\n    /××¦×/,\r\n  ],\r\n  studentAddressing: [\r\n    /× ×—×©×‘/,\r\n    /×‘×•×/,\r\n    /× ××¦×/,\r\n    /×©×™× ×œ×‘/,\r\n    /×–×›×•×¨/,\r\n  ],\r\n  explanationPatterns: [\r\n    /×›×œ×•××¨/,\r\n    /×–××ª ××•××¨×ª/,\r\n    /××©××¢×•×ª/,\r\n  ]\r\n};\r\n\r\n// ===== HELPER FUNCTIONS =====\r\n\r\nfunction createTestResult(\r\n  id: string,\r\n  name: string,\r\n  nameHe: string,\r\n  status: 'passed' | 'failed' | 'warning',\r\n  severity: 'critical' | 'high' | 'medium' | 'low' | 'info',\r\n  message: string,\r\n  messageHe: string,\r\n  duration: number,\r\n  details?: Record<string, unknown>\r\n): TestResult {\r\n  return {\r\n    id,\r\n    name,\r\n    nameHe,\r\n    category: 'knowledge-base',\r\n    status,\r\n    severity,\r\n    message,\r\n    messageHe,\r\n    details,\r\n    duration,\r\n    timestamp: new Date()\r\n  };\r\n}\r\n\r\n// ===== TEST 1: KB SEARCH CONNECTIVITY =====\r\n\r\nasync function testKBSearchConnectivity(topic: string, grade: string): Promise<{\r\n  success: boolean;\r\n  resultsCount: number;\r\n  avgSimilarity: number;\r\n  duration: number;\r\n  error?: string;\r\n}> {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    const results = await searchKnowledge(topic, { grade }, 5);\r\n    const duration = Date.now() - startTime;\r\n\r\n    const avgSimilarity = results.length > 0\r\n      ? results.reduce((sum, r) => sum + r.similarity, 0) / results.length\r\n      : 0;\r\n\r\n    return {\r\n      success: results.length > 0,\r\n      resultsCount: results.length,\r\n      avgSimilarity: Math.round(avgSimilarity * 100),\r\n      duration\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      resultsCount: 0,\r\n      avgSimilarity: 0,\r\n      duration: Date.now() - startTime,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n// ===== TEST 2: PEDAGOGICAL CONTEXT EXTRACTION =====\r\n\r\ninterface ExtractionResult {\r\n  success: boolean;\r\n  extractedCounts: {\r\n    exercises: number;\r\n    commonMistakes: number;\r\n    progressionLevels: number;\r\n    mathLanguage: number;\r\n    examples: number;\r\n    questionPhrasing: number;\r\n    studentAddressing: number;\r\n    explanationPatterns: number;\r\n  };\r\n  hasRawContext: boolean;\r\n  rawContextLength: number;\r\n  duration: number;\r\n  sampleExtractions: {\r\n    exercises: string[];\r\n    questionPhrasing: string[];\r\n    studentAddressing: string[];\r\n  };\r\n  error?: string;\r\n}\r\n\r\nasync function testPedagogicalContextExtraction(topic: string, grade: string): Promise<ExtractionResult> {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    const context = await getMathPedagogicalContext(topic, grade);\r\n    const duration = Date.now() - startTime;\r\n\r\n    const extractedCounts = {\r\n      exercises: context.exercises.length,\r\n      commonMistakes: context.commonMistakes.length,\r\n      progressionLevels: context.progressionLevels.length,\r\n      mathLanguage: context.mathLanguage.length,\r\n      examples: context.examples.length,\r\n      questionPhrasing: context.questionPhrasing.length,\r\n      studentAddressing: context.studentAddressing.length,\r\n      explanationPatterns: context.explanationPatterns.length\r\n    };\r\n\r\n    const totalExtracted = Object.values(extractedCounts).reduce((a, b) => a + b, 0);\r\n\r\n    return {\r\n      success: totalExtracted > 0,\r\n      extractedCounts,\r\n      hasRawContext: context.rawContext.length > 0,\r\n      rawContextLength: context.rawContext.length,\r\n      duration,\r\n      sampleExtractions: {\r\n        exercises: context.exercises.slice(0, 2),\r\n        questionPhrasing: context.questionPhrasing.slice(0, 2),\r\n        studentAddressing: context.studentAddressing.slice(0, 2)\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      extractedCounts: {\r\n        exercises: 0,\r\n        commonMistakes: 0,\r\n        progressionLevels: 0,\r\n        mathLanguage: 0,\r\n        examples: 0,\r\n        questionPhrasing: 0,\r\n        studentAddressing: 0,\r\n        explanationPatterns: 0\r\n      },\r\n      hasRawContext: false,\r\n      rawContextLength: 0,\r\n      duration: Date.now() - startTime,\r\n      sampleExtractions: { exercises: [], questionPhrasing: [], studentAddressing: [] },\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n// ===== TEST 3: PROMPT FORMATTING =====\r\n\r\ninterface PromptFormattingResult {\r\n  success: boolean;\r\n  promptLength: number;\r\n  hasSections: {\r\n    studentAddressing: boolean;\r\n    questionPhrasing: boolean;\r\n    explanationPatterns: boolean;\r\n    exercises: boolean;\r\n    commonMistakes: boolean;\r\n    criticalInstructions: boolean;\r\n  };\r\n  duration: number;\r\n  formattedPromptPreview: string;\r\n}\r\n\r\nasync function testPromptFormatting(topic: string, grade: string): Promise<PromptFormattingResult> {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    const context = await getMathPedagogicalContext(topic, grade);\r\n    const formattedPrompt = formatPedagogicalContextForPrompt(context);\r\n    const duration = Date.now() - startTime;\r\n\r\n    const hasSections = {\r\n      studentAddressing: formattedPrompt.includes('×¡×’× ×•×Ÿ ×”×¤× ×™×™×” ×œ×ª×œ××™×“'),\r\n      questionPhrasing: formattedPrompt.includes('× ×™×¡×•×— ×©××œ×•×ª'),\r\n      explanationPatterns: formattedPrompt.includes('×ª×‘× ×™×•×ª ×œ×”×¡×‘×¨'),\r\n      exercises: formattedPrompt.includes('×“×•×’×××•×ª ×œ×ª×¨×’×™×œ×™×'),\r\n      commonMistakes: formattedPrompt.includes('×˜×¢×•×™×•×ª × ×¤×•×¦×•×ª'),\r\n      criticalInstructions: formattedPrompt.includes('×”×•×¨××•×ª ×§×¨×™×˜×™×•×ª')\r\n    };\r\n\r\n    const sectionsPresent = Object.values(hasSections).filter(Boolean).length;\r\n\r\n    return {\r\n      success: formattedPrompt.length > 100 && sectionsPresent >= 3,\r\n      promptLength: formattedPrompt.length,\r\n      hasSections,\r\n      duration,\r\n      formattedPromptPreview: formattedPrompt.substring(0, 500) + '...'\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      promptLength: 0,\r\n      hasSections: {\r\n        studentAddressing: false,\r\n        questionPhrasing: false,\r\n        explanationPatterns: false,\r\n        exercises: false,\r\n        commonMistakes: false,\r\n        criticalInstructions: false\r\n      },\r\n      duration: Date.now() - startTime,\r\n      formattedPromptPreview: ''\r\n    };\r\n  }\r\n}\r\n\r\n// ===== TEST 4: CONTENT GENERATION WITH KB CONTEXT =====\r\n\r\ninterface ContentGenerationWithKBResult {\r\n  success: boolean;\r\n  hasKBContext: boolean;\r\n  generationDuration: number;\r\n  generatedContent: any;\r\n  languageAnalysis: {\r\n    usesHebrewTextbookStyle: boolean;\r\n    hasAppropriateAddressing: boolean;\r\n    matchesGradeLevel: boolean;\r\n    issues: string[];\r\n  };\r\n  error?: string;\r\n}\r\n\r\nasync function testContentGenerationWithKB(\r\n  topic: string,\r\n  grade: string,\r\n  timeout: number = 60000\r\n): Promise<ContentGenerationWithKBResult> {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    // First get KB context\r\n    const context = await getMathPedagogicalContext(topic, grade);\r\n    const hasKBContext = context.rawContext.length > 0;\r\n\r\n    // Generate content (the generateStepContent function should use KB internally)\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const gradeLevel = `×›×™×ª×” ${grade}`;\r\n    const result = await Promise.race([\r\n      generateSingleMultipleChoiceQuestion(topic, gradeLevel, null, undefined),\r\n      timeoutPromise\r\n    ]);\r\n\r\n    const duration = Date.now() - startTime;\r\n\r\n    // Analyze generated content for KB influence\r\n    const generatedText = JSON.stringify(result || {});\r\n    const languageAnalysis = analyzeGeneratedContentLanguage(generatedText, context, grade);\r\n\r\n    return {\r\n      success: result !== null && languageAnalysis.issues.length < 3,\r\n      hasKBContext,\r\n      generationDuration: duration,\r\n      generatedContent: result,\r\n      languageAnalysis\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      hasKBContext: false,\r\n      generationDuration: Date.now() - startTime,\r\n      generatedContent: null,\r\n      languageAnalysis: {\r\n        usesHebrewTextbookStyle: false,\r\n        hasAppropriateAddressing: false,\r\n        matchesGradeLevel: false,\r\n        issues: [error.message]\r\n      },\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\nfunction analyzeGeneratedContentLanguage(\r\n  generatedText: string,\r\n  kbContext: Awaited<ReturnType<typeof getMathPedagogicalContext>>,\r\n  grade: string\r\n): {\r\n  usesHebrewTextbookStyle: boolean;\r\n  hasAppropriateAddressing: boolean;\r\n  matchesGradeLevel: boolean;\r\n  issues: string[];\r\n} {\r\n  const issues: string[] = [];\r\n\r\n  // Check if content is in Hebrew\r\n  const hasHebrew = /[\\u0590-\\u05FF]/.test(generatedText);\r\n  if (!hasHebrew) {\r\n    issues.push('Content not in Hebrew');\r\n  }\r\n\r\n  // Check for textbook-style addressing patterns\r\n  const addressingPatterns = ['× ×—×©×‘', '×‘×•××•', '× ××¦×', '×©×™× ×œ×‘', '×–×›×•×¨', '× ×¡×ª×›×œ'];\r\n  const hasAddressing = addressingPatterns.some(p => generatedText.includes(p));\r\n  if (!hasAddressing && kbContext.studentAddressing.length > 0) {\r\n    issues.push('Missing textbook-style student addressing');\r\n  }\r\n\r\n  // Check for appropriate grade level (simple heuristic)\r\n  const complexTerms = ['××™× ×˜×’×¨×œ', '×“×™×¤×¨× ×¦×™××œ', '×œ×•×’×¨×™×ª×', '×˜×¨×™×’×•× ×•××˜×¨×™×”'];\r\n  const hasComplexTerms = complexTerms.some(t => generatedText.includes(t));\r\n  const isLowGrade = ['×', '×‘', '×’'].includes(grade);\r\n\r\n  if (isLowGrade && hasComplexTerms) {\r\n    issues.push('Content too complex for grade level');\r\n  }\r\n\r\n  // Check if using KB patterns\r\n  const usesKBPatterns = kbContext.questionPhrasing.some(p =>\r\n    generatedText.toLowerCase().includes(p.toLowerCase().substring(0, 10))\r\n  );\r\n\r\n  return {\r\n    usesHebrewTextbookStyle: hasHebrew,\r\n    hasAppropriateAddressing: hasAddressing,\r\n    matchesGradeLevel: !(isLowGrade && hasComplexTerms),\r\n    issues\r\n  };\r\n}\r\n\r\n// ===== TEST 5: ACTUAL OUTPUT QUALITY CHECK =====\r\n\r\ninterface OutputQualityResult {\r\n  success: boolean;\r\n  generatedContent: any;\r\n  qualityChecks: {\r\n    hasTextbookStyleAddressing: boolean;\r\n    hasContextualQuestion: boolean;\r\n    hasHebrewContent: boolean;\r\n    hasAppropriateComplexity: boolean;\r\n    usesKBPatterns: boolean;\r\n  };\r\n  matchedPatterns: string[];\r\n  issues: string[];\r\n  duration: number;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Test actual activity output quality\r\n * This tests the REAL output that students will see\r\n */\r\nasync function testActualOutputQuality(\r\n  topic: string,\r\n  grade: string,\r\n  timeout: number = 90000\r\n): Promise<OutputQualityResult> {\r\n  const startTime = Date.now();\r\n  const issues: string[] = [];\r\n  const matchedPatterns: string[] = [];\r\n\r\n  try {\r\n    // 1. Get KB context first for comparison\r\n    const kbContext = await getMathPedagogicalContext(topic, grade);\r\n\r\n    // 2. Create a step to generate\r\n    const testStep: SkeletonStep = {\r\n      step_number: 1,\r\n      title: topic,\r\n      bloom_level: 'Understand',\r\n      suggested_interaction_type: 'Multiple Choice',\r\n      narrative_focus: topic,\r\n      forbidden_topics: [],\r\n      key_learning_points: [topic]\r\n    };\r\n\r\n    // 3. Generate actual step content\r\n    const timeoutPromise = new Promise<null>((_, reject) =>\r\n      setTimeout(() => reject(new Error('Timeout')), timeout)\r\n    );\r\n\r\n    const gradeLevel = `×›×™×ª×” ${grade}`;\r\n    const result = await Promise.race([\r\n      generateStepContent(topic, testStep, gradeLevel, undefined, undefined, 'learning', 'math', 5), // 5 is the default for QA testing\r\n      timeoutPromise\r\n    ]);\r\n\r\n    const duration = Date.now() - startTime;\r\n\r\n    if (!result) {\r\n      return {\r\n        success: false,\r\n        generatedContent: null,\r\n        qualityChecks: {\r\n          hasTextbookStyleAddressing: false,\r\n          hasContextualQuestion: false,\r\n          hasHebrewContent: false,\r\n          hasAppropriateComplexity: false,\r\n          usesKBPatterns: false\r\n        },\r\n        matchedPatterns: [],\r\n        issues: ['Generation returned null'],\r\n        duration,\r\n        error: 'Generation failed'\r\n      };\r\n    }\r\n\r\n    // 4. Analyze output quality\r\n    const contentText = JSON.stringify(result);\r\n    const teachContent = result.teach_content || '';\r\n    const questionData = result.data || {};\r\n    const questionText = questionData.question || '';\r\n\r\n    // Check 1: Textbook-style addressing (\"× ×—×©×‘\", \"×‘×•××• × ×¨××”\", etc.)\r\n    const textbookPatterns = [\r\n      '× ×—×©×‘', '× ×—×©×•×‘', '×‘×•××• × ', '× ××¦×', '× ×¡×ª×›×œ',\r\n      '×©×™× ×œ×‘', '×–×›×•×¨', '×”×× ×–×›×•×¨', '×›××• ×©×œ××“× ×•'\r\n    ];\r\n    const hasTextbookStyleAddressing = textbookPatterns.some(p =>\r\n      contentText.includes(p)\r\n    );\r\n\r\n    if (hasTextbookStyleAddressing) {\r\n      const found = textbookPatterns.filter(p => contentText.includes(p));\r\n      matchedPatterns.push(...found.map(p => `×¤× ×™×™×”: \"${p}\"`));\r\n    } else {\r\n      issues.push('×—×¡×¨ ×¡×’× ×•×Ÿ ×¤× ×™×™×” ×œ×¡×¤×¨ ×œ×™××•×“ (× ×—×©×‘, ×‘×•××• × ×¨××”, ×•×›×•\\')');\r\n    }\r\n\r\n    // Check 2: Contextual question (story-based, not just \"compute X+Y\")\r\n    const contextualIndicators = [\r\n      /\\b×œ?\\w+\\s+(×§× ×”|××¡×£|×™×©|×§×™×‘×œ|× ×ª×Ÿ|×”×œ×š|×‘×|×©×|×œ×§×—)/,\r\n      /×›××”\\s+\\w+\\s+(×™×©|× ×©××¨|×§×™×‘×œ|×™×”×™×•)/,\r\n      /×¡×™×¤×•×¨|×“×•×’××”|×‘×¢×™×”/\r\n    ];\r\n    const hasContextualQuestion = contextualIndicators.some(p =>\r\n      p.test(questionText) || p.test(teachContent)\r\n    );\r\n\r\n    if (hasContextualQuestion) {\r\n      matchedPatterns.push('×©××œ×” ×”×§×©×¨×™×ª ×¢× ×¡×™×¤×•×¨');\r\n    } else {\r\n      // Check if it's just a bare computation\r\n      const bareComputation = /^[×—×©×‘|××¦×|×¤×ª×•×¨]\\s*:?\\s*\\d+\\s*[+\\-Ã—Ã·]\\s*\\d+/;\r\n      if (bareComputation.test(questionText)) {\r\n        issues.push('×©××œ×” ×’× ×¨×™×ª ×œ×œ× ×”×§×©×¨ ×™×•××™×•××™');\r\n      }\r\n    }\r\n\r\n    // Check 3: Hebrew content\r\n    const hebrewCount = (contentText.match(/[\\u0590-\\u05FF]/g) || []).length;\r\n    const hasHebrewContent = hebrewCount > 50;\r\n\r\n    if (!hasHebrewContent) {\r\n      issues.push('×ª×•×›×Ÿ ×œ× ×‘×¢×‘×¨×™×ª ××• ××¢×˜ ×××•×“ ×¢×‘×¨×™×ª');\r\n    }\r\n\r\n    // Check 4: Appropriate complexity for grade\r\n    const complexTerms = ['××™× ×˜×’×¨×œ', '× ×’×–×¨×ª', '×œ×•×’×¨×™×ª×', '×—×–×§×”', '×©×•×¨×©', '××©×•×•××”'];\r\n    const simpleGrades = ['×', '×‘'];\r\n    const hasComplexTerms = complexTerms.some(t => contentText.includes(t));\r\n    const hasAppropriateComplexity = !(simpleGrades.includes(grade) && hasComplexTerms);\r\n\r\n    if (!hasAppropriateComplexity) {\r\n      issues.push('×¨××ª ×§×•×©×™ ×œ× ××ª××™××” ×œ×›×™×ª×”');\r\n    }\r\n\r\n    // Check 5: Uses KB patterns from actual textbook\r\n    let usesKBPatterns = false;\r\n    if (kbContext.studentAddressing.length > 0 || kbContext.questionPhrasing.length > 0) {\r\n      // Check if output uses similar patterns to KB\r\n      const allKBPatterns = [\r\n        ...kbContext.studentAddressing,\r\n        ...kbContext.questionPhrasing.slice(0, 3)\r\n      ];\r\n\r\n      for (const kbPattern of allKBPatterns) {\r\n        // Extract key words from pattern (first 2-3 words)\r\n        const keyWords = kbPattern.split(/\\s+/).slice(0, 3).join(' ');\r\n        if (keyWords.length > 5 && contentText.includes(keyWords.substring(0, 10))) {\r\n          usesKBPatterns = true;\r\n          matchedPatterns.push(`×“×¤×•×¡ KB: \"${keyWords.substring(0, 20)}...\"`);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!usesKBPatterns && kbContext.studentAddressing.length > 0) {\r\n      issues.push('×œ× ××©×ª××© ×‘×“×¤×•×¡×™× ××¡×¤×¨ ×”×œ×™××•×“');\r\n    }\r\n\r\n    const qualityChecks = {\r\n      hasTextbookStyleAddressing,\r\n      hasContextualQuestion,\r\n      hasHebrewContent,\r\n      hasAppropriateComplexity,\r\n      usesKBPatterns\r\n    };\r\n\r\n    const passedChecks = Object.values(qualityChecks).filter(Boolean).length;\r\n    const success = passedChecks >= 4 && issues.length <= 1;\r\n\r\n    return {\r\n      success,\r\n      generatedContent: {\r\n        teach_content_preview: teachContent.substring(0, 200),\r\n        question_preview: questionText.substring(0, 200),\r\n        interaction_type: result.selected_interaction\r\n      },\r\n      qualityChecks,\r\n      matchedPatterns,\r\n      issues,\r\n      duration\r\n    };\r\n\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      generatedContent: null,\r\n      qualityChecks: {\r\n        hasTextbookStyleAddressing: false,\r\n        hasContextualQuestion: false,\r\n        hasHebrewContent: false,\r\n        hasAppropriateComplexity: false,\r\n        usesKBPatterns: false\r\n      },\r\n      matchedPatterns: [],\r\n      issues: [error.message],\r\n      duration: Date.now() - startTime,\r\n      error: error.message\r\n    };\r\n  }\r\n}\r\n\r\n// ===== TEST 6: KB COVERAGE CHECK =====\r\n\r\ninterface KBCoverageResult {\r\n  totalBooks: number;\r\n  booksWithContent: string[];\r\n  gradesWithContent: string[];\r\n  coveragePercentage: number;\r\n  missingGrades: string[];\r\n  sampleContent: { grade: string; chapter: string; contentPreview: string }[];\r\n}\r\n\r\nasync function testKBCoverage(): Promise<KBCoverageResult> {\r\n  const allGrades = ['×', '×‘', '×’', '×“', '×”', '×•'];\r\n  const gradesWithContent: string[] = [];\r\n  const booksWithContent: string[] = [];\r\n  const sampleContent: { grade: string; chapter: string; contentPreview: string }[] = [];\r\n\r\n  // Use very broad search terms to find any content\r\n  const broadSearchTerms = ['××¡×¤×¨×™×', '×ª×¨×’×™×œ', '×—×©×‘×•×Ÿ', '×¤×¨×§'];\r\n\r\n  for (const grade of allGrades) {\r\n    // Try multiple search terms to find content\r\n    for (const searchTerm of broadSearchTerms) {\r\n      try {\r\n        const results = await searchKnowledge(searchTerm, { grade }, 3);\r\n        if (results.length > 0) {\r\n          if (!gradesWithContent.includes(grade)) {\r\n            gradesWithContent.push(grade);\r\n          }\r\n\r\n          for (const result of results) {\r\n            const bookId = `${grade}-${result.chunk.volume}-${result.chunk.volumeType}`;\r\n            if (!booksWithContent.includes(bookId)) {\r\n              booksWithContent.push(bookId);\r\n\r\n              // Collect sample content for diagnostics\r\n              sampleContent.push({\r\n                grade,\r\n                chapter: result.chunk.chapter || '×œ× ×™×“×•×¢',\r\n                contentPreview: result.chunk.content.substring(0, 150) + '...'\r\n              });\r\n            }\r\n          }\r\n\r\n          break; // Found content for this grade, move to next\r\n        }\r\n      } catch {\r\n        // Search failed, continue with next term\r\n      }\r\n    }\r\n  }\r\n\r\n  const missingGrades = allGrades.filter(g => !gradesWithContent.includes(g));\r\n\r\n  return {\r\n    totalBooks: booksWithContent.length,\r\n    booksWithContent,\r\n    gradesWithContent,\r\n    coveragePercentage: Math.round((gradesWithContent.length / allGrades.length) * 100),\r\n    missingGrades,\r\n    sampleContent: sampleContent.slice(0, 5) // Limit to 5 samples\r\n  };\r\n}\r\n\r\n// ===== MAIN AGENT RUNNER =====\r\n\r\nexport async function runKnowledgeBaseQAAgent(\r\n  maxTopics: number = 3\r\n): Promise<QAAgentResult> {\r\n  console.log('ğŸ” Starting Knowledge Base QA Agent...');\r\n\r\n  const startTime = Date.now();\r\n  const allResults: TestResult[] = [];\r\n  let testsPassed = 0;\r\n  let testsFailed = 0;\r\n  const criticalIssues: TestResult[] = [];\r\n\r\n  // First, get KB coverage to determine which grades have content\r\n  console.log('ğŸ“Š Testing KB coverage...');\r\n  const coverageResult = await testKBCoverage();\r\n\r\n  // Build dynamic test topics based on actual KB content\r\n  const topicsToTest: { topic: string; grade: string; description: string }[] = [];\r\n\r\n  if (coverageResult.gradesWithContent.length > 0) {\r\n    // Create test topics only for grades that have content\r\n    for (const grade of coverageResult.gradesWithContent) {\r\n      topicsToTest.push({ topic: '××¡×¤×¨×™×', grade, description: `Numbers for grade ${grade}` });\r\n      topicsToTest.push({ topic: '×ª×¨×’×™×œ×™×', grade, description: `Exercises for grade ${grade}` });\r\n    }\r\n  } else {\r\n    // Fallback to default topics if no content detected\r\n    topicsToTest.push(...DEFAULT_TEST_TOPICS);\r\n  }\r\n\r\n  // Limit to maxTopics\r\n  const limitedTopicsToTest = topicsToTest.slice(0, maxTopics);\r\n\r\n  // Test 1: KB Coverage Check (already done above)\r\n\r\n  const coverageTest = createTestResult(\r\n    'kb_coverage',\r\n    'Knowledge Base Coverage',\r\n    '×›×™×¡×•×™ ×‘×¡×™×¡ ×”×™×“×¢',\r\n    coverageResult.coveragePercentage >= 50 ? 'passed' :\r\n      coverageResult.coveragePercentage > 0 ? 'warning' : 'failed',\r\n    coverageResult.coveragePercentage === 0 ? 'critical' : 'medium',\r\n    `Coverage: ${coverageResult.coveragePercentage}% | Books: ${coverageResult.totalBooks} | Grades: ${coverageResult.gradesWithContent.join(', ') || 'None'}`,\r\n    `×›×™×¡×•×™: ${coverageResult.coveragePercentage}% | ×¡×¤×¨×™×: ${coverageResult.totalBooks} | ×›×™×ª×•×ª: ${coverageResult.gradesWithContent.join(', ') || '××™×Ÿ'}`,\r\n    Date.now() - startTime,\r\n    {\r\n      coverage: coverageResult,\r\n      missingGrades: coverageResult.missingGrades,\r\n      sampleContent: coverageResult.sampleContent,\r\n      topicsToTest: limitedTopicsToTest.map(t => `${t.topic} (×›×™×ª×” ${t.grade})`)\r\n    }\r\n  );\r\n\r\n  allResults.push(coverageTest);\r\n  if (coverageTest.status === 'passed') testsPassed++;\r\n  else {\r\n    testsFailed++;\r\n    if (coverageResult.coveragePercentage === 0) criticalIssues.push(coverageTest);\r\n  }\r\n\r\n  // If no content in KB, skip detailed tests\r\n  if (coverageResult.coveragePercentage === 0) {\r\n    console.log('âš ï¸ KB is empty, skipping detailed tests');\r\n\r\n    allResults.push(createTestResult(\r\n      'kb_empty_warning',\r\n      'KB Empty - Tests Skipped',\r\n      '×‘×¡×™×¡ ×™×“×¢ ×¨×™×§ - ×‘×“×™×§×•×ª ×“×•×œ×’×•',\r\n      'warning',\r\n      'high',\r\n      'Knowledge base has no content. Upload textbooks to enable testing.',\r\n      '×‘×¡×™×¡ ×”×™×“×¢ ×¨×™×§. ×”×¢×œ×” ×¡×¤×¨×™ ×œ×™××•×“ ×›×“×™ ×œ××¤×©×¨ ×‘×“×™×§×•×ª.',\r\n      0,\r\n      {}\r\n    ));\r\n\r\n    return {\r\n      agentType: 'knowledge-base',\r\n      success: false,\r\n      duration: Date.now() - startTime,\r\n      testsRun: allResults.length,\r\n      testsPassed,\r\n      testsFailed,\r\n      criticalIssues,\r\n      allResults\r\n    };\r\n  }\r\n\r\n  // Test topics that have content\r\n  for (const { topic, grade, description } of limitedTopicsToTest) {\r\n    console.log(`\\nğŸ“š Testing topic: ${topic} (${grade})`);\r\n\r\n    // Test 2: Search Connectivity\r\n    const searchResult = await testKBSearchConnectivity(topic, grade);\r\n    const searchTest = createTestResult(\r\n      `kb_search_${topic}_${grade}`,\r\n      `KB Search: ${topic}`,\r\n      `×—×™×¤×•×© KB: ${topic}`,\r\n      searchResult.success ? 'passed' : 'failed',\r\n      searchResult.success ? 'low' : 'high',\r\n      `Results: ${searchResult.resultsCount} | Similarity: ${searchResult.avgSimilarity}% | Duration: ${searchResult.duration}ms`,\r\n      `×ª×•×¦××•×ª: ${searchResult.resultsCount} | ×“××™×•×Ÿ: ${searchResult.avgSimilarity}% | ××©×š: ${searchResult.duration}ms`,\r\n      searchResult.duration,\r\n      { searchResult }\r\n    );\r\n\r\n    allResults.push(searchTest);\r\n    if (searchTest.status === 'passed') testsPassed++;\r\n    else testsFailed++;\r\n\r\n    // Test 3: Pedagogical Context Extraction\r\n    const extractionResult = await testPedagogicalContextExtraction(topic, grade);\r\n\r\n    const totalExtracted = Object.values(extractionResult.extractedCounts).reduce((a, b) => a + b, 0);\r\n    const extractionTest = createTestResult(\r\n      `kb_extraction_${topic}_${grade}`,\r\n      `Pedagogical Extraction: ${topic}`,\r\n      `×—×™×œ×•×¥ ×¤×“×’×•×’×™: ${topic}`,\r\n      extractionResult.success ? 'passed' : totalExtracted > 0 ? 'warning' : 'failed',\r\n      extractionResult.success ? 'low' : 'medium',\r\n      `Extracted: ${totalExtracted} elements | Exercises: ${extractionResult.extractedCounts.exercises} | Questions: ${extractionResult.extractedCounts.questionPhrasing} | Addressing: ${extractionResult.extractedCounts.studentAddressing}`,\r\n      `×—×•×œ×¦×•: ${totalExtracted} ××œ×× ×˜×™× | ×ª×¨×’×™×œ×™×: ${extractionResult.extractedCounts.exercises} | ×©××œ×•×ª: ${extractionResult.extractedCounts.questionPhrasing} | ×¤× ×™×™×”: ${extractionResult.extractedCounts.studentAddressing}`,\r\n      extractionResult.duration,\r\n      {\r\n        extractedCounts: extractionResult.extractedCounts,\r\n        samples: extractionResult.sampleExtractions,\r\n        rawContextLength: extractionResult.rawContextLength\r\n      }\r\n    );\r\n\r\n    allResults.push(extractionTest);\r\n    if (extractionTest.status === 'passed') testsPassed++;\r\n    else testsFailed++;\r\n\r\n    // Test 4: Prompt Formatting\r\n    const formattingResult = await testPromptFormatting(topic, grade);\r\n\r\n    const sectionsCount = Object.values(formattingResult.hasSections).filter(Boolean).length;\r\n    const formattingTest = createTestResult(\r\n      `kb_formatting_${topic}_${grade}`,\r\n      `Prompt Formatting: ${topic}`,\r\n      `×¢×™×¦×•×‘ ×¤×¨×•××¤×˜: ${topic}`,\r\n      formattingResult.success ? 'passed' : sectionsCount >= 2 ? 'warning' : 'failed',\r\n      formattingResult.success ? 'low' : 'medium',\r\n      `Sections: ${sectionsCount}/6 | Length: ${formattingResult.promptLength} chars`,\r\n      `×¡×¢×™×¤×™×: ${sectionsCount}/6 | ××•×¨×š: ${formattingResult.promptLength} ×ª×•×•×™×`,\r\n      formattingResult.duration,\r\n      {\r\n        hasSections: formattingResult.hasSections,\r\n        promptPreview: formattingResult.formattedPromptPreview.substring(0, 200)\r\n      }\r\n    );\r\n\r\n    allResults.push(formattingTest);\r\n    if (formattingTest.status === 'passed') testsPassed++;\r\n    else testsFailed++;\r\n\r\n    // Test 5: Content Generation with KB (only for first topic to save time)\r\n    const isFirstTopic = limitedTopicsToTest.findIndex(t => t.topic === topic && t.grade === grade) === 0;\r\n    if (isFirstTopic) {\r\n      console.log('ğŸ¤– Testing content generation with KB context...');\r\n\r\n      const generationResult = await testContentGenerationWithKB(topic, grade);\r\n\r\n      const generationTest = createTestResult(\r\n        `kb_generation_${topic}_${grade}`,\r\n        `AI Generation with KB: ${topic}`,\r\n        `×™×¦×™×¨×ª AI ×¢× KB: ${topic}`,\r\n        generationResult.success ? 'passed' :\r\n          generationResult.languageAnalysis.issues.length < 2 ? 'warning' : 'failed',\r\n        generationResult.success ? 'low' : 'high',\r\n        `KB Context: ${generationResult.hasKBContext ? 'Yes' : 'No'} | Hebrew Style: ${generationResult.languageAnalysis.usesHebrewTextbookStyle ? 'Yes' : 'No'} | Issues: ${generationResult.languageAnalysis.issues.length}`,\r\n        `×”×§×©×¨ KB: ${generationResult.hasKBContext ? '×›×Ÿ' : '×œ×'} | ×¡×’× ×•×Ÿ ×¢×‘×¨×™: ${generationResult.languageAnalysis.usesHebrewTextbookStyle ? '×›×Ÿ' : '×œ×'} | ×‘×¢×™×•×ª: ${generationResult.languageAnalysis.issues.length}`,\r\n        generationResult.generationDuration,\r\n        {\r\n          hasKBContext: generationResult.hasKBContext,\r\n          languageAnalysis: generationResult.languageAnalysis,\r\n          generatedContentPreview: JSON.stringify(generationResult.generatedContent).substring(0, 300)\r\n        }\r\n      );\r\n\r\n      allResults.push(generationTest);\r\n      if (generationTest.status === 'passed') testsPassed++;\r\n      else {\r\n        testsFailed++;\r\n        if (!generationResult.success) criticalIssues.push(generationTest);\r\n      }\r\n\r\n      // Test 6: ACTUAL OUTPUT QUALITY - Tests the real student-facing content\r\n      console.log('ğŸ“ Testing ACTUAL output quality (student-facing content)...');\r\n\r\n      const outputQualityResult = await testActualOutputQuality(topic, grade);\r\n\r\n      const passedQualityChecks = Object.values(outputQualityResult.qualityChecks).filter(Boolean).length;\r\n      const qualityTest = createTestResult(\r\n        `kb_output_quality_${topic}_${grade}`,\r\n        `Output Quality Check: ${topic}`,\r\n        `×‘×“×™×§×ª ××™×›×•×ª ×¤×œ×˜: ${topic}`,\r\n        outputQualityResult.success ? 'passed' :\r\n          passedQualityChecks >= 3 ? 'warning' : 'failed',\r\n        outputQualityResult.success ? 'low' : 'critical',\r\n        `Quality: ${passedQualityChecks}/5 checks | Textbook Style: ${outputQualityResult.qualityChecks.hasTextbookStyleAddressing ? 'Yes' : 'No'} | Issues: ${outputQualityResult.issues.length}`,\r\n        `××™×›×•×ª: ${passedQualityChecks}/5 ×‘×“×™×§×•×ª | ×¡×’× ×•×Ÿ ×¡×¤×¨: ${outputQualityResult.qualityChecks.hasTextbookStyleAddressing ? '×›×Ÿ' : '×œ×'} | ×‘×¢×™×•×ª: ${outputQualityResult.issues.length}`,\r\n        outputQualityResult.duration,\r\n        {\r\n          qualityChecks: outputQualityResult.qualityChecks,\r\n          matchedPatterns: outputQualityResult.matchedPatterns,\r\n          issues: outputQualityResult.issues,\r\n          generatedContent: outputQualityResult.generatedContent\r\n        }\r\n      );\r\n\r\n      allResults.push(qualityTest);\r\n      if (qualityTest.status === 'passed') testsPassed++;\r\n      else {\r\n        testsFailed++;\r\n        if (!outputQualityResult.success) criticalIssues.push(qualityTest);\r\n      }\r\n    }\r\n\r\n    // Small delay between topics\r\n    await new Promise(resolve => setTimeout(resolve, 300));\r\n  }\r\n\r\n  // Summary\r\n  const totalDuration = Date.now() - startTime;\r\n  const passRate = Math.round((testsPassed / allResults.length) * 100);\r\n\r\n  console.log(`\\nâœ… Knowledge Base QA completed:`);\r\n  console.log(`   Passed: ${testsPassed}/${allResults.length} (${passRate}%)`);\r\n  console.log(`   Duration: ${totalDuration}ms`);\r\n\r\n  allResults.push(createTestResult(\r\n    'kb_summary',\r\n    'Knowledge Base Integration Summary',\r\n    '×¡×™×›×•× ××™× ×˜×’×¨×¦×™×™×ª ×‘×¡×™×¡ ×”×™×“×¢',\r\n    passRate >= 80 ? 'passed' : passRate >= 50 ? 'warning' : 'failed',\r\n    'info',\r\n    `Pass Rate: ${passRate}% | Tests: ${allResults.length} | Coverage: ${coverageResult.coveragePercentage}%`,\r\n    `××—×•×– ×”×¦×œ×—×”: ${passRate}% | ×‘×“×™×§×•×ª: ${allResults.length} | ×›×™×¡×•×™: ${coverageResult.coveragePercentage}%`,\r\n    totalDuration,\r\n    {\r\n      passRate,\r\n      coverage: coverageResult.coveragePercentage,\r\n      testedTopics: limitedTopicsToTest.map(t => `${t.topic} (×›×™×ª×” ${t.grade})`)\r\n    }\r\n  ));\r\n\r\n  return {\r\n    agentType: 'knowledge-base',\r\n    success: testsFailed === 0,\r\n    duration: totalDuration,\r\n    testsRun: allResults.length,\r\n    testsPassed,\r\n    testsFailed,\r\n    criticalIssues,\r\n    allResults\r\n  };\r\n}\r\n\r\nexport {\r\n  testKBSearchConnectivity,\r\n  testPedagogicalContextExtraction,\r\n  testPromptFormatting,\r\n  testContentGenerationWithKB,\r\n  testKBCoverage,\r\n  testActualOutputQuality\r\n};\r\n","/**\n * Auto-Fix Agent\n * ×¡×•×›×Ÿ ×ª×™×§×•×Ÿ ××•×˜×•××˜×™ - ×× ×ª×— ×©×’×™××•×ª ×•××¦×™×¢ ×ª×™×§×•× ×™×\n */\n\nimport { db } from '../../firebase';\nimport { doc, getDoc, updateDoc, collection, getDocs, query, where } from 'firebase/firestore';\nimport type {\n  TestResult,\n  FixSuggestion,\n  FixResult,\n  FixType,\n  TestResultWithFix,\n  ContentIssue\n} from '../../types/qa.types';\nimport type { Course, LearningUnit, ActivityBlock } from '../../shared/types/courseTypes';\n\n// Import AI generation functions for regeneration fixes\nimport {\n  generateSingleMultipleChoiceQuestion,\n  generateSingleOpenQuestion,\n  generateCategorizationQuestion,\n  generateOrderingQuestion,\n  generateFillInBlanksQuestion\n} from '../../gemini';\n\n// ===== FIX SUGGESTION GENERATORS =====\n\n/**\n * Analyze a test result and generate fix suggestions\n */\nexport function generateFixSuggestions(testResult: TestResult): FixSuggestion[] {\n  const suggestions: FixSuggestion[] = [];\n  const details = testResult.details || {};\n\n  // Parse error type from test result\n  const errorType = parseErrorType(testResult);\n\n  switch (errorType) {\n    case 'missing_question':\n      suggestions.push(createRegenerateBlockSuggestion(testResult, details));\n      break;\n\n    case 'missing_options':\n    case 'insufficient_options':\n      suggestions.push(createFixOptionsSuggestion(testResult, details));\n      break;\n\n    case 'no_correct_answer':\n      suggestions.push(createAddCorrectAnswerSuggestion(testResult, details));\n      break;\n\n    case 'empty_content':\n      suggestions.push(createRegenerateContentSuggestion(testResult, details));\n      break;\n\n    case 'invalid_block_structure':\n      suggestions.push(createFixStructureSuggestion(testResult, details));\n      break;\n\n    case 'missing_feedback':\n      suggestions.push(createAddMissingFieldSuggestion(testResult, details, 'feedback'));\n      break;\n\n    case 'orphaned_reference':\n      suggestions.push(createRemoveInvalidSuggestion(testResult, details));\n      break;\n\n    default:\n      // For unknown errors, suggest manual review\n      suggestions.push(createManualReviewSuggestion(testResult, details));\n  }\n\n  return suggestions;\n}\n\nfunction parseErrorType(testResult: TestResult): string {\n  const message = testResult.message.toLowerCase();\n  const messageHe = testResult.messageHe;\n\n  if (message.includes('missing question') || messageHe.includes('×—×¡×¨ ×©××œ×”')) {\n    return 'missing_question';\n  }\n  if (message.includes('no options') || message.includes('insufficient options') || messageHe.includes('××¤×©×¨×•×™×•×ª')) {\n    return 'missing_options';\n  }\n  if (message.includes('no correct') || messageHe.includes('×ª×©×•×‘×” × ×›×•× ×”')) {\n    return 'no_correct_answer';\n  }\n  if (message.includes('empty') || messageHe.includes('×¨×™×§')) {\n    return 'empty_content';\n  }\n  if (message.includes('invalid structure') || messageHe.includes('××‘× ×”')) {\n    return 'invalid_block_structure';\n  }\n  if (message.includes('feedback') || messageHe.includes('××©×•×‘')) {\n    return 'missing_feedback';\n  }\n  if (message.includes('orphan') || message.includes('reference') || messageHe.includes('×”×¤× ×™×”')) {\n    return 'orphaned_reference';\n  }\n\n  return 'unknown';\n}\n\n// ===== SUGGESTION CREATORS =====\n\nfunction createRegenerateBlockSuggestion(testResult: TestResult, details: Record<string, unknown>): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'regenerate_block',\n    description: 'Regenerate the entire block using AI',\n    descriptionHe: '×™×¦×™×¨×” ××—×“×© ×©×œ ×”×‘×œ×•×§ ×‘×××¦×¢×•×ª AI',\n    autoFixable: true,\n    estimatedDuration: 15,\n    riskLevel: 'medium',\n    targetPath: {\n      collection: 'courses',\n      documentId: details.courseId as string || '',\n      field: 'units',\n      blockId: details.blockId as string || ''\n    },\n    requiresAI: true,\n    aiPrompt: `Regenerate ${details.blockType || 'activity'} block for topic: ${details.topic || 'unknown'}`\n  };\n}\n\nfunction createFixOptionsSuggestion(testResult: TestResult, details: Record<string, unknown>): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'fix_options',\n    description: 'Add or fix answer options',\n    descriptionHe: '×”×•×¡×¤×” ××• ×ª×™×§×•×Ÿ ××¤×©×¨×•×™×•×ª ×ª×©×•×‘×”',\n    autoFixable: true,\n    estimatedDuration: 10,\n    riskLevel: 'low',\n    targetPath: {\n      collection: 'courses',\n      documentId: details.courseId as string || '',\n      field: 'content.options',\n      blockId: details.blockId as string || ''\n    },\n    requiresAI: true,\n    aiPrompt: `Generate 4 answer options for question: ${details.question || 'unknown'}`\n  };\n}\n\nfunction createAddCorrectAnswerSuggestion(testResult: TestResult, details: Record<string, unknown>): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'add_correct_answer',\n    description: 'Mark one option as correct answer',\n    descriptionHe: '×¡×™××•×Ÿ ×ª×©×•×‘×” × ×›×•× ×”',\n    autoFixable: true,\n    estimatedDuration: 5,\n    riskLevel: 'low',\n    targetPath: {\n      collection: 'courses',\n      documentId: details.courseId as string || '',\n      field: 'content.correctAnswer',\n      blockId: details.blockId as string || ''\n    },\n    requiresAI: false,\n    fixData: {\n      action: 'set_first_as_correct'\n    }\n  };\n}\n\nfunction createRegenerateContentSuggestion(testResult: TestResult, details: Record<string, unknown>): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'regenerate_content',\n    description: 'Regenerate content using AI',\n    descriptionHe: '×™×¦×™×¨×ª ×ª×•×›×Ÿ ××—×“×© ×‘×××¦×¢×•×ª AI',\n    autoFixable: true,\n    estimatedDuration: 20,\n    riskLevel: 'medium',\n    targetPath: {\n      collection: 'courses',\n      documentId: details.courseId as string || '',\n      field: 'content',\n      blockId: details.blockId as string || ''\n    },\n    requiresAI: true\n  };\n}\n\nfunction createFixStructureSuggestion(testResult: TestResult, details: Record<string, unknown>): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'fix_structure',\n    description: 'Fix block structure to match schema',\n    descriptionHe: '×ª×™×§×•×Ÿ ××‘× ×” ×”×‘×œ×•×§',\n    autoFixable: true,\n    estimatedDuration: 5,\n    riskLevel: 'low',\n    targetPath: {\n      collection: 'courses',\n      documentId: details.courseId as string || '',\n      blockId: details.blockId as string || ''\n    },\n    requiresAI: false\n  };\n}\n\nfunction createAddMissingFieldSuggestion(testResult: TestResult, details: Record<string, unknown>, field: string): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'add_missing_field',\n    description: `Add missing ${field} field`,\n    descriptionHe: `×”×•×¡×¤×ª ×©×“×” ${field} ×—×¡×¨`,\n    autoFixable: true,\n    estimatedDuration: 10,\n    riskLevel: 'low',\n    targetPath: {\n      collection: 'courses',\n      documentId: details.courseId as string || '',\n      field: `content.${field}`,\n      blockId: details.blockId as string || ''\n    },\n    requiresAI: field === 'feedback'\n  };\n}\n\nfunction createRemoveInvalidSuggestion(testResult: TestResult, details: Record<string, unknown>): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'remove_invalid',\n    description: 'Remove invalid or orphaned reference',\n    descriptionHe: '×”×¡×¨×ª ×”×¤× ×™×” ×œ× ×ª×§×™× ×”',\n    autoFixable: true,\n    estimatedDuration: 3,\n    riskLevel: 'medium',\n    targetPath: {\n      collection: 'courses',\n      documentId: details.courseId as string || '',\n      blockId: details.blockId as string || ''\n    },\n    requiresAI: false\n  };\n}\n\nfunction createManualReviewSuggestion(testResult: TestResult, details: Record<string, unknown>): FixSuggestion {\n  return {\n    id: `fix_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    testResultId: testResult.id,\n    fixType: 'manual_review',\n    description: 'This issue requires manual review',\n    descriptionHe: '×‘×¢×™×” ×–×• ×“×•×¨×©×ª ×‘×“×™×§×” ×™×“× ×™×ª',\n    autoFixable: false,\n    estimatedDuration: 0,\n    riskLevel: 'high',\n    targetPath: {\n      collection: details.collection as string || 'courses',\n      documentId: details.documentId as string || details.courseId as string || ''\n    },\n    requiresAI: false\n  };\n}\n\n// ===== FIX EXECUTORS =====\n\n/**\n * Execute a fix suggestion and return the result\n */\nexport async function executeFix(suggestion: FixSuggestion, userId?: string): Promise<FixResult> {\n  const startTime = Date.now();\n\n  try {\n    let result: FixResult;\n\n    switch (suggestion.fixType) {\n      case 'regenerate_block':\n        result = await executeRegenerateBlock(suggestion);\n        break;\n\n      case 'fix_options':\n        result = await executeFixOptions(suggestion);\n        break;\n\n      case 'add_correct_answer':\n        result = await executeAddCorrectAnswer(suggestion);\n        break;\n\n      case 'regenerate_content':\n        result = await executeRegenerateContent(suggestion);\n        break;\n\n      case 'fix_structure':\n        result = await executeFixStructure(suggestion);\n        break;\n\n      case 'add_missing_field':\n        result = await executeAddMissingField(suggestion);\n        break;\n\n      case 'remove_invalid':\n        result = await executeRemoveInvalid(suggestion);\n        break;\n\n      case 'manual_review':\n      default:\n        result = {\n          id: `result_${Date.now()}`,\n          suggestionId: suggestion.id,\n          status: 'skipped',\n          appliedAt: new Date(),\n          appliedBy: userId,\n          errorMessage: 'Manual review required - cannot auto-fix'\n        };\n    }\n\n    result.appliedBy = userId;\n    return result;\n\n  } catch (error: any) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      appliedBy: userId,\n      errorMessage: error.message || 'Unknown error during fix execution'\n    };\n  }\n}\n\nasync function executeRegenerateBlock(suggestion: FixSuggestion): Promise<FixResult> {\n  const { targetPath, aiPrompt } = suggestion;\n\n  // Get current block data\n  const courseRef = doc(db, 'courses', targetPath.documentId);\n  const courseSnap = await getDoc(courseRef);\n\n  if (!courseSnap.exists()) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      errorMessage: 'Course not found'\n    };\n  }\n\n  const course = courseSnap.data() as Course;\n  let blockFound = false;\n  let previousValue: unknown;\n  let newValue: unknown;\n\n  // Find and update the block\n  const updatedUnits = course.units?.map(unit => {\n    const updatedBlocks = unit.activityBlocks?.map(block => {\n      if (block.id === targetPath.blockId) {\n        blockFound = true;\n        previousValue = { ...block };\n\n        // Regenerate based on block type\n        // For now, mark as needing regeneration\n        const updatedBlock = {\n          ...block,\n          content: {\n            ...block.content,\n            _needsRegeneration: true,\n            _regenerationPrompt: aiPrompt\n          }\n        };\n        newValue = updatedBlock;\n        return updatedBlock;\n      }\n      return block;\n    });\n    return { ...unit, activityBlocks: updatedBlocks };\n  });\n\n  if (!blockFound) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      errorMessage: 'Block not found in course'\n    };\n  }\n\n  await updateDoc(courseRef, { units: updatedUnits });\n\n  return {\n    id: `result_${Date.now()}`,\n    suggestionId: suggestion.id,\n    status: 'success',\n    appliedAt: new Date(),\n    previousValue,\n    newValue\n  };\n}\n\nasync function executeFixOptions(suggestion: FixSuggestion): Promise<FixResult> {\n  const { targetPath } = suggestion;\n\n  const courseRef = doc(db, 'courses', targetPath.documentId);\n  const courseSnap = await getDoc(courseRef);\n\n  if (!courseSnap.exists()) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      errorMessage: 'Course not found'\n    };\n  }\n\n  const course = courseSnap.data() as Course;\n  let previousValue: unknown;\n  let newValue: unknown;\n  let updated = false;\n\n  const updatedUnits = course.units?.map(unit => {\n    const updatedBlocks = unit.activityBlocks?.map(block => {\n      if (block.id === targetPath.blockId && block.type === 'multiple-choice') {\n        previousValue = block.content?.options;\n\n        // Ensure at least 4 options\n        const currentOptions = block.content?.options || [];\n        const question = block.content?.question || '';\n\n        if (currentOptions.length < 4) {\n          // Add placeholder options that need AI regeneration\n          const newOptions = [...currentOptions];\n          while (newOptions.length < 4) {\n            newOptions.push({\n              id: `opt_${Date.now()}_${newOptions.length}`,\n              text: `[×“×•×¨×© ×™×¦×™×¨×” ××—×“×© - ××¤×©×¨×•×ª ${newOptions.length + 1}]`,\n              isCorrect: false\n            });\n          }\n\n          // Ensure at least one is correct\n          if (!newOptions.some(opt => opt.isCorrect)) {\n            newOptions[0].isCorrect = true;\n          }\n\n          newValue = newOptions;\n          updated = true;\n\n          return {\n            ...block,\n            content: {\n              ...block.content,\n              options: newOptions\n            }\n          };\n        }\n      }\n      return block;\n    });\n    return { ...unit, activityBlocks: updatedBlocks };\n  });\n\n  if (!updated) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'skipped',\n      appliedAt: new Date(),\n      errorMessage: 'Block not found or already has enough options'\n    };\n  }\n\n  await updateDoc(courseRef, { units: updatedUnits });\n\n  return {\n    id: `result_${Date.now()}`,\n    suggestionId: suggestion.id,\n    status: 'success',\n    appliedAt: new Date(),\n    previousValue,\n    newValue\n  };\n}\n\nasync function executeAddCorrectAnswer(suggestion: FixSuggestion): Promise<FixResult> {\n  const { targetPath } = suggestion;\n\n  const courseRef = doc(db, 'courses', targetPath.documentId);\n  const courseSnap = await getDoc(courseRef);\n\n  if (!courseSnap.exists()) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      errorMessage: 'Course not found'\n    };\n  }\n\n  const course = courseSnap.data() as Course;\n  let previousValue: unknown;\n  let newValue: unknown;\n  let updated = false;\n\n  const updatedUnits = course.units?.map(unit => {\n    const updatedBlocks = unit.activityBlocks?.map(block => {\n      if (block.id === targetPath.blockId && block.type === 'multiple-choice') {\n        const options = block.content?.options || [];\n        previousValue = options.map((o: any) => ({ ...o }));\n\n        // Mark first option as correct if none are correct\n        if (!options.some((opt: any) => opt.isCorrect)) {\n          const newOptions = options.map((opt: any, idx: number) => ({\n            ...opt,\n            isCorrect: idx === 0\n          }));\n          newValue = newOptions;\n          updated = true;\n\n          return {\n            ...block,\n            content: {\n              ...block.content,\n              options: newOptions\n            }\n          };\n        }\n      }\n      return block;\n    });\n    return { ...unit, activityBlocks: updatedBlocks };\n  });\n\n  if (!updated) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'skipped',\n      appliedAt: new Date(),\n      errorMessage: 'Block not found or already has correct answer'\n    };\n  }\n\n  await updateDoc(courseRef, { units: updatedUnits });\n\n  return {\n    id: `result_${Date.now()}`,\n    suggestionId: suggestion.id,\n    status: 'success',\n    appliedAt: new Date(),\n    previousValue,\n    newValue\n  };\n}\n\nasync function executeRegenerateContent(suggestion: FixSuggestion): Promise<FixResult> {\n  // Similar to regenerate block but for specific content field\n  return executeRegenerateBlock(suggestion);\n}\n\nasync function executeFixStructure(suggestion: FixSuggestion): Promise<FixResult> {\n  const { targetPath } = suggestion;\n\n  const courseRef = doc(db, 'courses', targetPath.documentId);\n  const courseSnap = await getDoc(courseRef);\n\n  if (!courseSnap.exists()) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      errorMessage: 'Course not found'\n    };\n  }\n\n  const course = courseSnap.data() as Course;\n  let previousValue: unknown;\n  let newValue: unknown;\n  let updated = false;\n\n  const updatedUnits = course.units?.map(unit => {\n    const updatedBlocks = unit.activityBlocks?.map(block => {\n      if (block.id === targetPath.blockId) {\n        previousValue = { ...block };\n\n        // Ensure required fields exist based on block type\n        const fixedBlock = ensureBlockStructure(block);\n        newValue = fixedBlock;\n        updated = true;\n\n        return fixedBlock;\n      }\n      return block;\n    });\n    return { ...unit, activityBlocks: updatedBlocks };\n  });\n\n  if (!updated) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'skipped',\n      appliedAt: new Date(),\n      errorMessage: 'Block not found'\n    };\n  }\n\n  await updateDoc(courseRef, { units: updatedUnits });\n\n  return {\n    id: `result_${Date.now()}`,\n    suggestionId: suggestion.id,\n    status: 'success',\n    appliedAt: new Date(),\n    previousValue,\n    newValue\n  };\n}\n\nfunction ensureBlockStructure(block: ActivityBlock): ActivityBlock {\n  const content = block.content || {};\n\n  switch (block.type) {\n    case 'multiple-choice':\n      return {\n        ...block,\n        content: {\n          question: content.question || '[×©××œ×” ×—×¡×¨×”]',\n          options: content.options || [],\n          feedback: content.feedback || { correct: '× ×›×•×Ÿ!', incorrect: '×œ× × ×›×•×Ÿ, × ×¡×” ×©×•×‘' },\n          ...content\n        }\n      };\n\n    case 'open-question':\n      return {\n        ...block,\n        content: {\n          question: content.question || '[×©××œ×” ×—×¡×¨×”]',\n          sampleAnswer: content.sampleAnswer || '',\n          rubric: content.rubric || [],\n          ...content\n        }\n      };\n\n    case 'fill-in-blanks':\n      return {\n        ...block,\n        content: {\n          text: content.text || '[×˜×§×¡×˜ ×—×¡×¨]',\n          blanks: content.blanks || [],\n          ...content\n        }\n      };\n\n    default:\n      return block;\n  }\n}\n\nasync function executeAddMissingField(suggestion: FixSuggestion): Promise<FixResult> {\n  const { targetPath } = suggestion;\n  const fieldName = targetPath.field?.split('.').pop() || '';\n\n  const courseRef = doc(db, 'courses', targetPath.documentId);\n  const courseSnap = await getDoc(courseRef);\n\n  if (!courseSnap.exists()) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      errorMessage: 'Course not found'\n    };\n  }\n\n  const course = courseSnap.data() as Course;\n  let updated = false;\n  let newValue: unknown;\n\n  const updatedUnits = course.units?.map(unit => {\n    const updatedBlocks = unit.activityBlocks?.map(block => {\n      if (block.id === targetPath.blockId) {\n        const content = block.content || {};\n\n        // Add default value for missing field\n        let defaultValue: unknown;\n        switch (fieldName) {\n          case 'feedback':\n            defaultValue = { correct: '×›×œ ×”×›×‘×•×“!', incorrect: '× ×¡×” ×©×•×‘' };\n            break;\n          case 'hint':\n            defaultValue = '×—×©×•×‘ ×¢×œ ×”×ª×©×•×‘×” ×©×•×‘';\n            break;\n          default:\n            defaultValue = '';\n        }\n\n        newValue = defaultValue;\n        updated = true;\n\n        return {\n          ...block,\n          content: {\n            ...content,\n            [fieldName]: defaultValue\n          }\n        };\n      }\n      return block;\n    });\n    return { ...unit, activityBlocks: updatedBlocks };\n  });\n\n  if (!updated) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'skipped',\n      appliedAt: new Date(),\n      errorMessage: 'Block not found'\n    };\n  }\n\n  await updateDoc(courseRef, { units: updatedUnits });\n\n  return {\n    id: `result_${Date.now()}`,\n    suggestionId: suggestion.id,\n    status: 'success',\n    appliedAt: new Date(),\n    newValue\n  };\n}\n\nasync function executeRemoveInvalid(suggestion: FixSuggestion): Promise<FixResult> {\n  const { targetPath } = suggestion;\n\n  const courseRef = doc(db, 'courses', targetPath.documentId);\n  const courseSnap = await getDoc(courseRef);\n\n  if (!courseSnap.exists()) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'failed',\n      appliedAt: new Date(),\n      errorMessage: 'Course not found'\n    };\n  }\n\n  const course = courseSnap.data() as Course;\n  let previousValue: unknown;\n  let removed = false;\n\n  const updatedUnits = course.units?.map(unit => {\n    const updatedBlocks = unit.activityBlocks?.filter(block => {\n      if (block.id === targetPath.blockId) {\n        previousValue = block;\n        removed = true;\n        return false; // Remove this block\n      }\n      return true;\n    });\n    return { ...unit, activityBlocks: updatedBlocks };\n  });\n\n  if (!removed) {\n    return {\n      id: `result_${Date.now()}`,\n      suggestionId: suggestion.id,\n      status: 'skipped',\n      appliedAt: new Date(),\n      errorMessage: 'Block not found'\n    };\n  }\n\n  await updateDoc(courseRef, { units: updatedUnits });\n\n  return {\n    id: `result_${Date.now()}`,\n    suggestionId: suggestion.id,\n    status: 'success',\n    appliedAt: new Date(),\n    previousValue\n  };\n}\n\n// ===== BATCH FIX EXECUTION =====\n\n/**\n * Execute multiple fixes and return results\n */\nexport async function executeFixBatch(\n  suggestions: FixSuggestion[],\n  userId?: string,\n  onProgress?: (completed: number, total: number) => void\n): Promise<FixResult[]> {\n  const results: FixResult[] = [];\n  const autoFixable = suggestions.filter(s => s.autoFixable);\n\n  for (let i = 0; i < autoFixable.length; i++) {\n    const suggestion = autoFixable[i];\n    const result = await executeFix(suggestion, userId);\n    results.push(result);\n\n    if (onProgress) {\n      onProgress(i + 1, autoFixable.length);\n    }\n\n    // Small delay to prevent overwhelming the database\n    await new Promise(resolve => setTimeout(resolve, 100));\n  }\n\n  return results;\n}\n\n// ===== ENHANCE TEST RESULTS WITH FIX SUGGESTIONS =====\n\n/**\n * Add fix suggestions to test results\n */\nexport function enhanceTestResultsWithFixes(testResults: TestResult[]): TestResultWithFix[] {\n  return testResults.map(result => {\n    if (result.status === 'failed' || result.status === 'warning') {\n      const fixSuggestions = generateFixSuggestions(result);\n      return {\n        ...result,\n        fixSuggestions,\n        canAutoFix: fixSuggestions.some(s => s.autoFixable)\n      };\n    }\n    return {\n      ...result,\n      fixSuggestions: [],\n      canAutoFix: false\n    };\n  });\n}\n\n// ===== REVALIDATION =====\n\n/**\n * Revalidate a specific test after applying a fix\n */\nexport async function revalidateAfterFix(\n  suggestion: FixSuggestion,\n  originalTest: TestResult\n): Promise<TestResult> {\n  // This would re-run the specific validation that created the original test\n  // For now, return a placeholder that indicates revalidation is needed\n\n  return {\n    ...originalTest,\n    id: `revalidate_${Date.now()}`,\n    status: 'running',\n    message: 'Revalidation in progress...',\n    messageHe: '××ª×‘×¦×¢×ª ×‘×“×™×§×” ××—×“×©...',\n    timestamp: new Date()\n  };\n}\n","/**\r\n * QA Testing System - Main Exports\r\n * ××¢×¨×›×ª ×‘×“×™×§×•×ª ××™×›×•×ª - ×™×™×¦×•× ×¨××©×™\r\n */\r\n\r\n// Main service\r\nexport { runFullQAReport, saveQAReport, getRecentQAReports } from './qaTestingService';\r\n\r\n// Agents\r\nexport { runContentQualityAgent, validateCourse, validateUnit, validateBlock, validateLessonPlan } from './contentQualityAgent';\r\nexport { runStudentSimulationAgent, simulateCourse, simulateUnit } from './studentSimulationAgent';\r\nexport { runAIGenerationAgent, testMultipleChoiceGeneration, testOpenQuestionGeneration } from './aiGenerationAgent';\r\nexport { runE2EGenerationAgent } from './e2eGenerationAgent';\r\n\r\n// New Assessment Agents\r\nexport { runStudentActivityAgent, runActivitySession, validateScoringPolicy } from './studentActivityAgent';\r\nexport { runAssessmentIntegrityAgent, validateCourseAssessment, validateScoringRules, ASSESSMENT_POLICY } from './assessmentIntegrityAgent';\r\n\r\n// Knowledge Base Integration Agent\r\nexport {\r\n  runKnowledgeBaseQAAgent,\r\n  testKBSearchConnectivity,\r\n  testPedagogicalContextExtraction,\r\n  testPromptFormatting,\r\n  testContentGenerationWithKB,\r\n  testKBCoverage\r\n} from './knowledgeBaseQAAgent';\r\n\r\n// Auto-Fix Agent\r\nexport {\r\n  generateFixSuggestions,\r\n  executeFix,\r\n  executeFixBatch,\r\n  enhanceTestResultsWithFixes,\r\n  revalidateAfterFix\r\n} from './autoFixAgent';\r\n\r\n// Types re-export\r\nexport type {\r\n  TestResult,\r\n  TestSuite,\r\n  QAReport,\r\n  QAReportSummary,\r\n  QAAgentResult,\r\n  TestStatus,\r\n  TestCategory,\r\n  TestSeverity,\r\n  ContentQualityCheck,\r\n  StudentSimulationRun,\r\n  AIGenerationTest,\r\n  QATestConfig,\r\n  FixSuggestion,\r\n  FixResult,\r\n  FixBatch,\r\n  FixType,\r\n  TestResultWithFix\r\n} from '../../types/qa.types';\r\n\r\nexport { DEFAULT_QA_CONFIG, DEFAULT_STUDENT_PROFILES } from '../../types/qa.types';\r\n\r\n// ===== COMBINED RUNNER =====\r\n\r\nimport { runFullQAReport, saveQAReport } from './qaTestingService';\r\nimport { runContentQualityAgent } from './contentQualityAgent';\r\nimport { runStudentSimulationAgent } from './studentSimulationAgent';\r\nimport { runAIGenerationAgent } from './aiGenerationAgent';\r\nimport { runE2EGenerationAgent } from './e2eGenerationAgent';\r\nimport { runStudentActivityAgent } from './studentActivityAgent';\r\nimport { runAssessmentIntegrityAgent } from './assessmentIntegrityAgent';\r\nimport { runKnowledgeBaseQAAgent } from './knowledgeBaseQAAgent';\r\nimport type { QAReport, QAAgentResult, TestSuite, TestResult } from '../../types/qa.types';\r\n\r\nexport interface FullQARunOptions {\r\n  includeContentQuality?: boolean;\r\n  includeStudentSimulation?: boolean;\r\n  includeAIGeneration?: boolean;\r\n  includeE2EGeneration?: boolean;  // E2E content generation testing\r\n  includeStudentActivity?: boolean;  // Student activity/exam testing with scoring\r\n  includeAssessmentIntegrity?: boolean;  // Assessment policy validation\r\n  includeKnowledgeBase?: boolean;  // Knowledge Base integration testing\r\n  maxCourses?: number;\r\n  saveReport?: boolean;\r\n  userId?: string;\r\n}\r\n\r\n/**\r\n * Run comprehensive QA testing including all agents\r\n * ×”×¨×¦×ª ×‘×“×™×§×•×ª QA ××§×™×¤×•×ª ×›×•×œ×œ ×›×œ ×”×¡×•×›× ×™×\r\n */\r\nexport async function runComprehensiveQA(options: FullQARunOptions = {}): Promise<{\r\n  report: QAReport;\r\n  agentResults: QAAgentResult[];\r\n  reportId?: string;\r\n}> {\r\n  const {\r\n    includeContentQuality = true,\r\n    includeStudentSimulation = true,\r\n    includeAIGeneration = false, // Disabled by default (API costs)\r\n    includeE2EGeneration = false, // Disabled by default (API costs)\r\n    includeStudentActivity = false, // Disabled by default\r\n    includeAssessmentIntegrity = false, // Disabled by default\r\n    includeKnowledgeBase = false, // Disabled by default\r\n    maxCourses = 10,\r\n    saveReport = true,\r\n    userId\r\n  } = options;\r\n\r\n  console.log('ğŸš€ Starting Comprehensive QA Run...');\r\n  const startTime = Date.now();\r\n\r\n  // Run base QA tests first\r\n  const report = await runFullQAReport(undefined, 'manual', userId);\r\n  const agentResults: QAAgentResult[] = [];\r\n\r\n  // Run Content Quality Agent\r\n  if (includeContentQuality) {\r\n    console.log('\\nğŸ“ Running Content Quality Agent...');\r\n    const contentResult = await runContentQualityAgent(maxCourses);\r\n    agentResults.push(contentResult);\r\n\r\n    // Add to report\r\n    const contentSuite: TestSuite = {\r\n      id: 'suite_content_quality',\r\n      name: 'Content Quality Tests',\r\n      nameHe: '×‘×“×™×§×•×ª ××™×›×•×ª ×ª×•×›×Ÿ',\r\n      category: 'content-quality',\r\n      tests: contentResult.allResults,\r\n      passedCount: contentResult.testsPassed,\r\n      failedCount: contentResult.testsFailed,\r\n      warningCount: contentResult.allResults.filter(t => t.status === 'warning').length,\r\n      skippedCount: 0,\r\n      duration: contentResult.duration,\r\n      status: contentResult.success ? 'passed' : 'failed'\r\n    };\r\n    report.suites.push(contentSuite);\r\n  }\r\n\r\n  // Run Student Simulation Agent\r\n  if (includeStudentSimulation) {\r\n    console.log('\\nğŸ“ Running Student Simulation Agent...');\r\n    const simResult = await runStudentSimulationAgent(Math.min(maxCourses, 5));\r\n    agentResults.push(simResult);\r\n\r\n    const simSuite: TestSuite = {\r\n      id: 'suite_student_simulation',\r\n      name: 'Student Simulation Tests',\r\n      nameHe: '×‘×“×™×§×•×ª ×¡×™××•×œ×¦×™×™×ª ×ª×œ××™×“',\r\n      category: 'student-simulation',\r\n      tests: simResult.allResults,\r\n      passedCount: simResult.testsPassed,\r\n      failedCount: simResult.testsFailed,\r\n      warningCount: simResult.allResults.filter(t => t.status === 'warning').length,\r\n      skippedCount: 0,\r\n      duration: simResult.duration,\r\n      status: simResult.success ? 'passed' : 'failed'\r\n    };\r\n    report.suites.push(simSuite);\r\n  }\r\n\r\n  // Run AI Generation Agent (optional, costs money)\r\n  if (includeAIGeneration) {\r\n    console.log('\\nğŸ¤– Running AI Generation Agent...');\r\n    const aiResult = await runAIGenerationAgent(['multiple-choice', 'open-question']);\r\n    agentResults.push(aiResult);\r\n\r\n    const aiSuite: TestSuite = {\r\n      id: 'suite_ai_generation',\r\n      name: 'AI Generation Tests',\r\n      nameHe: '×‘×“×™×§×•×ª ×™×¦×™×¨×ª AI',\r\n      category: 'ai-generation',\r\n      tests: aiResult.allResults,\r\n      passedCount: aiResult.testsPassed,\r\n      failedCount: aiResult.testsFailed,\r\n      warningCount: aiResult.allResults.filter(t => t.status === 'warning').length,\r\n      skippedCount: 0,\r\n      duration: aiResult.duration,\r\n      status: aiResult.success ? 'passed' : 'failed'\r\n    };\r\n    report.suites.push(aiSuite);\r\n  }\r\n\r\n  // Run E2E Generation Agent (optional, costs money - full content generation flows)\r\n  if (includeE2EGeneration) {\r\n    console.log('\\nğŸ­ Running E2E Generation Agent...');\r\n    const e2eResult = await runE2EGenerationAgent();\r\n    agentResults.push(e2eResult);\r\n\r\n    const e2eSuite: TestSuite = {\r\n      id: 'suite_e2e_generation',\r\n      name: 'E2E Content Generation Tests',\r\n      nameHe: '×‘×“×™×§×•×ª ×™×¦×™×¨×ª ×ª×•×›×Ÿ ××§×¦×” ×œ×§×¦×”',\r\n      category: 'e2e-generation',\r\n      tests: e2eResult.tests,\r\n      passedCount: e2eResult.summary.passed,\r\n      failedCount: e2eResult.summary.failed,\r\n      warningCount: e2eResult.summary.warnings,\r\n      skippedCount: 0,\r\n      duration: e2eResult.summary.duration,\r\n      status: e2eResult.status\r\n    };\r\n    report.suites.push(e2eSuite);\r\n  }\r\n\r\n  // Run Student Activity Agent (tests scoring with actual activity simulation)\r\n  if (includeStudentActivity) {\r\n    console.log('\\nğŸ“ Running Student Activity Agent...');\r\n    const activityResult = await runStudentActivityAgent(Math.min(maxCourses, 5), true);\r\n    agentResults.push(activityResult);\r\n\r\n    const activitySuite: TestSuite = {\r\n      id: 'suite_student_activity',\r\n      name: 'Student Activity Tests',\r\n      nameHe: '×‘×“×™×§×•×ª ×¤×¢×™×œ×•×ª ×ª×œ××™×“',\r\n      category: 'student-activity',\r\n      tests: activityResult.allResults,\r\n      passedCount: activityResult.testsPassed,\r\n      failedCount: activityResult.testsFailed,\r\n      warningCount: activityResult.allResults.filter(t => t.status === 'warning').length,\r\n      skippedCount: 0,\r\n      duration: activityResult.duration,\r\n      status: activityResult.success ? 'passed' : 'failed'\r\n    };\r\n    report.suites.push(activitySuite);\r\n  }\r\n\r\n  // Run Assessment Integrity Agent (validates scoring policy compliance)\r\n  if (includeAssessmentIntegrity) {\r\n    console.log('\\nâš–ï¸ Running Assessment Integrity Agent...');\r\n    const integrityResult = await runAssessmentIntegrityAgent(maxCourses);\r\n    agentResults.push(integrityResult);\r\n\r\n    const integritySuite: TestSuite = {\r\n      id: 'suite_assessment_integrity',\r\n      name: 'Assessment Integrity Tests',\r\n      nameHe: '×‘×“×™×§×•×ª ××™× ×˜×’×¨×™×˜×™ ×”×¢×¨×›×”',\r\n      category: 'assessment-integrity',\r\n      tests: integrityResult.allResults,\r\n      passedCount: integrityResult.testsPassed,\r\n      failedCount: integrityResult.testsFailed,\r\n      warningCount: integrityResult.allResults.filter(t => t.status === 'warning').length,\r\n      skippedCount: 0,\r\n      duration: integrityResult.duration,\r\n      status: integrityResult.success ? 'passed' : 'failed'\r\n    };\r\n    report.suites.push(integritySuite);\r\n  }\r\n\r\n  // Run Knowledge Base Integration Agent (tests KB extraction and usage)\r\n  if (includeKnowledgeBase) {\r\n    console.log('\\nğŸ“š Running Knowledge Base QA Agent...');\r\n    const kbResult = await runKnowledgeBaseQAAgent(3); // Test 3 topics\r\n    agentResults.push(kbResult);\r\n\r\n    const kbSuite: TestSuite = {\r\n      id: 'suite_knowledge_base',\r\n      name: 'Knowledge Base Integration Tests',\r\n      nameHe: '×‘×“×™×§×•×ª ××™× ×˜×’×¨×¦×™×™×ª ×‘×¡×™×¡ ×™×“×¢',\r\n      category: 'knowledge-base',\r\n      tests: kbResult.allResults,\r\n      passedCount: kbResult.testsPassed,\r\n      failedCount: kbResult.testsFailed,\r\n      warningCount: kbResult.allResults.filter(t => t.status === 'warning').length,\r\n      skippedCount: 0,\r\n      duration: kbResult.duration,\r\n      status: kbResult.success ? 'passed' : 'failed'\r\n    };\r\n    report.suites.push(kbSuite);\r\n  }\r\n\r\n  // Recalculate summary\r\n  const allTests = report.suites.flatMap(s => s.tests);\r\n  report.summary = {\r\n    totalTests: allTests.length,\r\n    passed: allTests.filter(t => t.status === 'passed').length,\r\n    failed: allTests.filter(t => t.status === 'failed').length,\r\n    warnings: allTests.filter(t => t.status === 'warning').length,\r\n    skipped: allTests.filter(t => t.status === 'skipped').length,\r\n    passRate: Math.round((allTests.filter(t => t.status === 'passed').length / allTests.length) * 100),\r\n    overallStatus: allTests.some(t => t.status === 'failed' && t.severity === 'critical') ? 'failed' :\r\n                   allTests.some(t => t.status === 'failed') ? 'warning' : 'passed',\r\n    criticalIssues: allTests.filter(t => t.status === 'failed' && t.severity === 'critical'),\r\n    duration: Date.now() - startTime\r\n  };\r\n\r\n  report.completedAt = new Date();\r\n\r\n  // Save to Firestore\r\n  let reportId: string | undefined;\r\n  if (saveReport) {\r\n    try {\r\n      reportId = await saveQAReport(report);\r\n      console.log(`\\nğŸ’¾ Report saved with ID: ${reportId}`);\r\n    } catch (error) {\r\n      console.error('Failed to save report:', error);\r\n    }\r\n  }\r\n\r\n  console.log(`\\nâœ… Comprehensive QA Complete!`);\r\n  console.log(`   Total Tests: ${report.summary.totalTests}`);\r\n  console.log(`   Passed: ${report.summary.passed} (${report.summary.passRate}%)`);\r\n  console.log(`   Failed: ${report.summary.failed}`);\r\n  console.log(`   Warnings: ${report.summary.warnings}`);\r\n  console.log(`   Duration: ${Math.round(report.summary.duration / 1000)}s`);\r\n\r\n  return { report, agentResults, reportId };\r\n}\r\n","/**\r\n * QA Dashboard - Admin Page for QA Reports with Auto-Fix\r\n * ×“×£ × ×™×”×•×œ ×‘×“×™×§×•×ª ××™×›×•×ª ×¢× ×ª×™×§×•×Ÿ ××•×˜×•××˜×™\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport {\r\n  runComprehensiveQA,\r\n  getRecentQAReports,\r\n  runContentQualityAgent,\r\n  runStudentSimulationAgent,\r\n  runAIGenerationAgent,\r\n  runE2EGenerationAgent,\r\n  runStudentActivityAgent,\r\n  runAssessmentIntegrityAgent,\r\n  runKnowledgeBaseQAAgent,\r\n  generateFixSuggestions,\r\n  executeFix,\r\n  executeFixBatch,\r\n  enhanceTestResultsWithFixes\r\n} from '../services/qa';\r\nimport type {\r\n  QAReport,\r\n  TestResult,\r\n  TestSuite,\r\n  QAAgentResult,\r\n  FixSuggestion,\r\n  FixResult,\r\n  TestResultWithFix\r\n} from '../types/qa.types';\r\n\r\n// ===== INLINE ICONS =====\r\n\r\nconst IconRefresh = () => (\r\n  <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <polyline points=\"23 4 23 10 17 10\"></polyline>\r\n    <polyline points=\"1 20 1 14 7 14\"></polyline>\r\n    <path d=\"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15\"></path>\r\n  </svg>\r\n);\r\n\r\nconst IconCheck = ({ className = \"w-4 h-4\" }: { className?: string }) => (\r\n  <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <polyline points=\"20 6 9 17 4 12\"></polyline>\r\n  </svg>\r\n);\r\n\r\nconst IconX = ({ className = \"w-4 h-4\" }: { className?: string }) => (\r\n  <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line>\r\n    <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line>\r\n  </svg>\r\n);\r\n\r\nconst IconWarning = ({ className = \"w-4 h-4\" }: { className?: string }) => (\r\n  <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"></path>\r\n    <line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"></line>\r\n    <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"></line>\r\n  </svg>\r\n);\r\n\r\nconst IconLoader = ({ className = \"w-5 h-5\" }: { className?: string }) => (\r\n  <svg className={`${className} animate-spin`} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <path d=\"M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83\"></path>\r\n  </svg>\r\n);\r\n\r\nconst IconChevronDown = () => (\r\n  <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <polyline points=\"6 9 12 15 18 9\"></polyline>\r\n  </svg>\r\n);\r\n\r\nconst IconChevronUp = () => (\r\n  <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <polyline points=\"18 15 12 9 6 15\"></polyline>\r\n  </svg>\r\n);\r\n\r\nconst IconBack = () => (\r\n  <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <line x1=\"19\" y1=\"12\" x2=\"5\" y2=\"12\"></line>\r\n    <polyline points=\"12 19 5 12 12 5\"></polyline>\r\n  </svg>\r\n);\r\n\r\nconst IconWrench = ({ className = \"w-4 h-4\" }: { className?: string }) => (\r\n  <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <path d=\"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z\"></path>\r\n  </svg>\r\n);\r\n\r\nconst IconZap = ({ className = \"w-4 h-4\" }: { className?: string }) => (\r\n  <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <polygon points=\"13 2 3 14 12 14 11 22 21 10 12 10 13 2\"></polygon>\r\n  </svg>\r\n);\r\n\r\nconst IconCopy = ({ className = \"w-4 h-4\" }: { className?: string }) => (\r\n  <svg className={className} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\r\n    <rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"></rect>\r\n    <path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"></path>\r\n  </svg>\r\n);\r\n\r\n// ===== HELPER COMPONENTS =====\r\n\r\nconst StatusBadge: React.FC<{ status: string }> = ({ status }) => {\r\n  const getStyle = () => {\r\n    switch (status) {\r\n      case 'passed': return 'bg-green-500 text-white';\r\n      case 'failed': return 'bg-red-500 text-white';\r\n      case 'warning': return 'bg-yellow-500 text-white';\r\n      case 'running': return 'bg-blue-500 text-white';\r\n      case 'fixed': return 'bg-purple-500 text-white';\r\n      default: return 'bg-gray-500 text-white';\r\n    }\r\n  };\r\n\r\n  const getIcon = () => {\r\n    switch (status) {\r\n      case 'passed': return <IconCheck className=\"w-3 h-3\" />;\r\n      case 'failed': return <IconX className=\"w-3 h-3\" />;\r\n      case 'warning': return <IconWarning className=\"w-3 h-3\" />;\r\n      case 'running': return <IconLoader className=\"w-3 h-3\" />;\r\n      case 'fixed': return <IconWrench className=\"w-3 h-3\" />;\r\n      default: return null;\r\n    }\r\n  };\r\n\r\n  const getLabel = () => {\r\n    switch (status) {\r\n      case 'passed': return '×¢×‘×¨';\r\n      case 'failed': return '× ×›×©×œ';\r\n      case 'warning': return '××–×”×¨×”';\r\n      case 'running': return '×¨×¥...';\r\n      case 'fixed': return '×ª×•×§×Ÿ';\r\n      default: return status;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${getStyle()}`}>\r\n      {getIcon()}\r\n      {getLabel()}\r\n    </span>\r\n  );\r\n};\r\n\r\nconst StatCard: React.FC<{ value: number | string; label: string; color?: string }> = ({ value, label, color }) => (\r\n  <div className=\"bg-slate-800 rounded-xl p-4 text-center border border-slate-700\">\r\n    <div className=\"text-3xl font-bold\" style={{ color: color || 'white' }}>{value}</div>\r\n    <div className=\"text-sm text-slate-400 mt-1\">{label}</div>\r\n  </div>\r\n);\r\n\r\n// ===== FIX SUGGESTION COMPONENT =====\r\n\r\ninterface FixSuggestionItemProps {\r\n  suggestion: FixSuggestion;\r\n  onFix: (suggestion: FixSuggestion) => Promise<void>;\r\n  isFixing: boolean;\r\n  fixResult?: FixResult;\r\n}\r\n\r\nconst FixSuggestionItem: React.FC<FixSuggestionItemProps> = ({\r\n  suggestion,\r\n  onFix,\r\n  isFixing,\r\n  fixResult\r\n}) => {\r\n  const getRiskColor = () => {\r\n    switch (suggestion.riskLevel) {\r\n      case 'low': return 'text-green-400';\r\n      case 'medium': return 'text-yellow-400';\r\n      case 'high': return 'text-red-400';\r\n    }\r\n  };\r\n\r\n  const getRiskLabel = () => {\r\n    switch (suggestion.riskLevel) {\r\n      case 'low': return '×¡×™×›×•×Ÿ × ××•×š';\r\n      case 'medium': return '×¡×™×›×•×Ÿ ×‘×™× ×•× ×™';\r\n      case 'high': return '×¡×™×›×•×Ÿ ×’×‘×•×”';\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"bg-slate-800 rounded-lg p-3 border border-slate-600 mt-2\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex-1\">\r\n          <div className=\"flex items-center gap-2 text-sm\">\r\n            <IconWrench className=\"w-4 h-4 text-purple-400\" />\r\n            <span className=\"text-slate-200\">{suggestion.descriptionHe}</span>\r\n          </div>\r\n          <div className=\"flex items-center gap-3 mt-1 text-xs text-slate-400\">\r\n            <span className={getRiskColor()}>{getRiskLabel()}</span>\r\n            <span>~{suggestion.estimatedDuration} ×©× ×™×•×ª</span>\r\n            {suggestion.requiresAI && <span className=\"text-purple-400\">×“×•×¨×© AI</span>}\r\n          </div>\r\n        </div>\r\n\r\n        {fixResult ? (\r\n          <div className=\"flex items-center gap-2\">\r\n            {fixResult.status === 'success' ? (\r\n              <span className=\"text-green-400 text-xs flex items-center gap-1\">\r\n                <IconCheck className=\"w-4 h-4\" /> ×ª×•×§×Ÿ\r\n              </span>\r\n            ) : fixResult.status === 'failed' ? (\r\n              <span className=\"text-red-400 text-xs flex items-center gap-1\">\r\n                <IconX className=\"w-4 h-4\" /> × ×›×©×œ\r\n              </span>\r\n            ) : (\r\n              <span className=\"text-yellow-400 text-xs\">{fixResult.status}</span>\r\n            )}\r\n          </div>\r\n        ) : suggestion.autoFixable ? (\r\n          <button\r\n            onClick={() => onFix(suggestion)}\r\n            disabled={isFixing}\r\n            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition ${\r\n              isFixing\r\n                ? 'bg-purple-600/50 cursor-not-allowed'\r\n                : 'bg-purple-600 hover:bg-purple-700'\r\n            }`}\r\n          >\r\n            {isFixing ? (\r\n              <>\r\n                <IconLoader className=\"w-3 h-3\" />\r\n                ××ª×§×Ÿ...\r\n              </>\r\n            ) : (\r\n              <>\r\n                <IconZap className=\"w-3 h-3\" />\r\n                ×ª×§×Ÿ\r\n              </>\r\n            )}\r\n          </button>\r\n        ) : (\r\n          <span className=\"text-xs text-slate-500\">×“×•×¨×© ×‘×“×™×§×” ×™×“× ×™×ª</span>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// ===== TEST RESULT WITH FIX =====\r\n\r\ninterface TestResultItemProps {\r\n  test: TestResult;\r\n  onFixTest?: (test: TestResult, suggestion: FixSuggestion) => Promise<void>;\r\n  fixingTestId?: string;\r\n  fixResults?: Map<string, FixResult>;\r\n}\r\n\r\nconst TestResultItem: React.FC<TestResultItemProps> = ({\r\n  test,\r\n  onFixTest,\r\n  fixingTestId,\r\n  fixResults\r\n}) => {\r\n  const [showDetails, setShowDetails] = useState(false);\r\n  const [showFixes, setShowFixes] = useState(false);\r\n\r\n  // Generate fix suggestions for failed tests\r\n  const fixSuggestions = (test.status === 'failed' || test.status === 'warning')\r\n    ? generateFixSuggestions(test)\r\n    : [];\r\n\r\n  const hasAutoFix = fixSuggestions.some(s => s.autoFixable);\r\n  const isFixing = fixingTestId === test.id;\r\n\r\n  return (\r\n    <div className={`bg-slate-900 rounded-lg p-3 border ${\r\n      fixResults?.has(test.id) && fixResults.get(test.id)?.status === 'success'\r\n        ? 'border-green-600'\r\n        : 'border-slate-700'\r\n    }`}>\r\n      <div className=\"flex items-start justify-between\">\r\n        <div className=\"flex-1\">\r\n          <div className=\"flex items-center gap-2 mb-1\">\r\n            <StatusBadge status={\r\n              fixResults?.has(test.id) && fixResults.get(test.id)?.status === 'success'\r\n                ? 'fixed'\r\n                : test.status\r\n            } />\r\n            <span className=\"font-medium text-sm\">{test.nameHe}</span>\r\n          </div>\r\n          <div className=\"text-xs text-slate-400\">{test.messageHe}</div>\r\n          {test.duration > 0 && (\r\n            <div className=\"text-xs text-slate-500 mt-1\">â±ï¸ {test.duration}ms</div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Fix button for failed tests */}\r\n        {hasAutoFix && onFixTest && !fixResults?.has(test.id) && (\r\n          <button\r\n            onClick={() => setShowFixes(!showFixes)}\r\n            className=\"flex items-center gap-1 px-2 py-1 text-xs rounded bg-purple-600/20 text-purple-400 hover:bg-purple-600/30 transition\"\r\n          >\r\n            <IconWrench className=\"w-3 h-3\" />\r\n            {fixSuggestions.length} ×ª×™×§×•× ×™×\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Fix Suggestions */}\r\n      {showFixes && fixSuggestions.length > 0 && (\r\n        <div className=\"mt-3 pt-3 border-t border-slate-700\">\r\n          <div className=\"text-xs text-slate-400 mb-2\">×”×¦×¢×•×ª ×ª×™×§×•×Ÿ:</div>\r\n          {fixSuggestions.map(suggestion => (\r\n            <FixSuggestionItem\r\n              key={suggestion.id}\r\n              suggestion={suggestion}\r\n              onFix={async (s) => onFixTest && await onFixTest(test, s)}\r\n              isFixing={isFixing}\r\n              fixResult={fixResults?.get(suggestion.id)}\r\n            />\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {/* Details */}\r\n      {test.details && (\r\n        <>\r\n          <button\r\n            onClick={() => setShowDetails(!showDetails)}\r\n            className=\"text-purple-400 text-xs mt-2 hover:underline\"\r\n          >\r\n            {showDetails ? '×”×¡×ª×¨ ×¤×¨×˜×™×' : '×”×¦×’ ×¤×¨×˜×™×'}\r\n          </button>\r\n          {showDetails && (\r\n            <pre className=\"mt-2 p-2 bg-slate-950 rounded text-xs overflow-auto max-h-40 text-slate-300\">\r\n              {JSON.stringify(test.details, null, 2)}\r\n            </pre>\r\n          )}\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n// ===== TEST SUITE WITH FIX ALL =====\r\n\r\ninterface TestSuiteCardProps {\r\n  suite: TestSuite;\r\n  defaultExpanded?: boolean;\r\n  onFixTest?: (test: TestResult, suggestion: FixSuggestion) => Promise<void>;\r\n  onFixAll?: (suite: TestSuite) => Promise<void>;\r\n  fixingTestId?: string;\r\n  fixResults?: Map<string, FixResult>;\r\n  isFixingAll?: boolean;\r\n}\r\n\r\nconst TestSuiteCard: React.FC<TestSuiteCardProps> = ({\r\n  suite,\r\n  defaultExpanded = false,\r\n  onFixTest,\r\n  onFixAll,\r\n  fixingTestId,\r\n  fixResults,\r\n  isFixingAll\r\n}) => {\r\n  const [expanded, setExpanded] = useState(defaultExpanded);\r\n\r\n  // Count fixable issues\r\n  const fixableCount = suite.tests.filter(t =>\r\n    (t.status === 'failed' || t.status === 'warning') &&\r\n    generateFixSuggestions(t).some(s => s.autoFixable)\r\n  ).length;\r\n\r\n  return (\r\n    <div className=\"bg-slate-800 rounded-xl p-4 mb-4 border border-slate-700\">\r\n      <div\r\n        className=\"flex justify-between items-center cursor-pointer\"\r\n        onClick={() => setExpanded(!expanded)}\r\n      >\r\n        <div className=\"flex items-center gap-3\">\r\n          <span className=\"text-lg\">ğŸ“Š</span>\r\n          <span className=\"font-semibold\">{suite.nameHe}</span>\r\n          <StatusBadge status={suite.status} />\r\n        </div>\r\n        <div className=\"flex items-center gap-4\">\r\n          <span className=\"text-green-400\">âœ“ {suite.passedCount}</span>\r\n          <span className=\"text-red-400\">âœ— {suite.failedCount}</span>\r\n          <span className=\"text-yellow-400\">âš  {suite.warningCount}</span>\r\n          {expanded ? <IconChevronUp /> : <IconChevronDown />}\r\n        </div>\r\n      </div>\r\n\r\n      {expanded && (\r\n        <div className=\"mt-4 pt-4 border-t border-slate-700\">\r\n          {/* Fix All Button */}\r\n          {fixableCount > 0 && onFixAll && (\r\n            <div className=\"mb-4 flex justify-end\">\r\n              <button\r\n                onClick={(e) => {\r\n                  e.stopPropagation();\r\n                  onFixAll(suite);\r\n                }}\r\n                disabled={isFixingAll}\r\n                className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${\r\n                  isFixingAll\r\n                    ? 'bg-purple-600/50 cursor-not-allowed'\r\n                    : 'bg-purple-600 hover:bg-purple-700'\r\n                }`}\r\n              >\r\n                {isFixingAll ? (\r\n                  <>\r\n                    <IconLoader className=\"w-4 h-4\" />\r\n                    ××ª×§×Ÿ ×”×›×œ...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <IconZap className=\"w-4 h-4\" />\r\n                    ×ª×§×Ÿ ×”×›×œ ({fixableCount})\r\n                  </>\r\n                )}\r\n              </button>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"space-y-2\">\r\n            {suite.tests.map(test => (\r\n              <TestResultItem\r\n                key={test.id}\r\n                test={test}\r\n                onFixTest={onFixTest}\r\n                fixingTestId={fixingTestId}\r\n                fixResults={fixResults}\r\n              />\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n// ===== MAIN COMPONENT =====\r\n\r\ninterface QADashboardProps {\r\n  onBack?: () => void;\r\n}\r\n\r\nconst QADashboard: React.FC<QADashboardProps> = ({ onBack }) => {\r\n  const { currentUser } = useAuth();\r\n  const [isRunning, setIsRunning] = useState(false);\r\n  const [currentReport, setCurrentReport] = useState<QAReport | null>(null);\r\n  const [recentReports, setRecentReports] = useState<QAReport[]>([]);\r\n  const [runProgress, setRunProgress] = useState<string>('');\r\n  const [selectedAgents, setSelectedAgents] = useState({\r\n    contentQuality: true,\r\n    studentSimulation: true,\r\n    aiGeneration: false,\r\n    e2eGeneration: false,\r\n    studentActivity: false,\r\n    assessmentIntegrity: false,\r\n    knowledgeBase: false\r\n  });\r\n\r\n  // Fix state\r\n  const [fixingTestId, setFixingTestId] = useState<string | undefined>();\r\n  const [isFixingAll, setIsFixingAll] = useState(false);\r\n  const [fixResults, setFixResults] = useState<Map<string, FixResult>>(new Map());\r\n  const [fixProgress, setFixProgress] = useState<string>('');\r\n  const [copySuccess, setCopySuccess] = useState(false);\r\n\r\n  useEffect(() => {\r\n    loadRecentReports();\r\n  }, []);\r\n\r\n  const loadRecentReports = async () => {\r\n    try {\r\n      const reports = await getRecentQAReports(5);\r\n      setRecentReports(reports);\r\n    } catch (error) {\r\n      console.error('Failed to load reports:', error);\r\n    }\r\n  };\r\n\r\n  const handleRunQA = async () => {\r\n    setIsRunning(true);\r\n    setRunProgress('××ª×—×™×œ ×‘×“×™×§×•×ª...');\r\n    setFixResults(new Map()); // Clear previous fix results\r\n\r\n    try {\r\n      const { report } = await runComprehensiveQA({\r\n        includeContentQuality: selectedAgents.contentQuality,\r\n        includeStudentSimulation: selectedAgents.studentSimulation,\r\n        includeAIGeneration: selectedAgents.aiGeneration,\r\n        includeE2EGeneration: selectedAgents.e2eGeneration,\r\n        includeStudentActivity: selectedAgents.studentActivity,\r\n        includeAssessmentIntegrity: selectedAgents.assessmentIntegrity,\r\n        includeKnowledgeBase: selectedAgents.knowledgeBase,\r\n        maxCourses: 10,\r\n        saveReport: true,\r\n        userId: currentUser?.uid\r\n      });\r\n\r\n      setCurrentReport(report);\r\n      await loadRecentReports();\r\n      setRunProgress('');\r\n    } catch (error: any) {\r\n      console.error('QA run failed:', error);\r\n      setRunProgress(`×©×’×™××”: ${error.message}`);\r\n    } finally {\r\n      setIsRunning(false);\r\n    }\r\n  };\r\n\r\n  const handleRunSingleAgent = async (agentType: 'content' | 'simulation' | 'ai' | 'e2e' | 'activity' | 'integrity' | 'knowledge-base') => {\r\n    setIsRunning(true);\r\n    setRunProgress(`××¨×™×¥ ×¡×•×›×Ÿ...`);\r\n    setFixResults(new Map());\r\n\r\n    try {\r\n      let result: QAAgentResult;\r\n      let agentNameHe: string;\r\n      let categoryName: string;\r\n\r\n      switch (agentType) {\r\n        case 'content':\r\n          result = await runContentQualityAgent(10);\r\n          agentNameHe = '××™×›×•×ª ×ª×•×›×Ÿ';\r\n          categoryName = 'content-quality';\r\n          break;\r\n        case 'simulation':\r\n          result = await runStudentSimulationAgent(5);\r\n          agentNameHe = '×¡×™××•×œ×¦×™×™×ª ×ª×œ××™×“';\r\n          categoryName = 'student-simulation';\r\n          break;\r\n        case 'ai':\r\n          result = await runAIGenerationAgent(['multiple-choice', 'open-question']);\r\n          agentNameHe = '×™×¦×™×¨×ª AI';\r\n          categoryName = 'ai-generation';\r\n          break;\r\n        case 'e2e':\r\n          result = await runE2EGenerationAgent();\r\n          agentNameHe = '×™×¦×™×¨×ª ×ª×•×›×Ÿ ××§×¦×” ×œ×§×¦×”';\r\n          categoryName = 'e2e-generation';\r\n          break;\r\n        case 'activity':\r\n          result = await runStudentActivityAgent(5, true);\r\n          agentNameHe = '×¤×¢×™×œ×•×ª ×ª×œ××™×“';\r\n          categoryName = 'student-activity';\r\n          break;\r\n        case 'integrity':\r\n          result = await runAssessmentIntegrityAgent(10);\r\n          agentNameHe = '××™× ×˜×’×¨×™×˜×™ ×”×¢×¨×›×”';\r\n          categoryName = 'assessment-integrity';\r\n          break;\r\n        case 'knowledge-base':\r\n          result = await runKnowledgeBaseQAAgent(3);\r\n          agentNameHe = '××™× ×˜×’×¨×¦×™×™×ª ×‘×¡×™×¡ ×™×“×¢';\r\n          categoryName = 'knowledge-base';\r\n          break;\r\n      }\r\n\r\n      const miniReport: QAReport = {\r\n        id: `single_${Date.now()}`,\r\n        createdAt: new Date(),\r\n        completedAt: new Date(),\r\n        triggeredBy: 'manual',\r\n        triggeredByUserId: currentUser?.uid,\r\n        environment: 'development',\r\n        suites: [{\r\n          id: `suite_${agentType}`,\r\n          name: agentType,\r\n          nameHe: agentNameHe,\r\n          category: categoryName,\r\n          tests: result.allResults,\r\n          passedCount: result.testsPassed,\r\n          failedCount: result.testsFailed,\r\n          warningCount: result.allResults.filter(t => t.status === 'warning').length,\r\n          skippedCount: 0,\r\n          duration: result.duration,\r\n          status: result.success ? 'passed' : 'failed'\r\n        }],\r\n        summary: {\r\n          totalTests: result.testsRun,\r\n          passed: result.testsPassed,\r\n          failed: result.testsFailed,\r\n          warnings: result.allResults.filter(t => t.status === 'warning').length,\r\n          skipped: 0,\r\n          passRate: result.testsRun > 0 ? Math.round((result.testsPassed / result.testsRun) * 100) : 0,\r\n          overallStatus: result.success ? 'passed' : 'failed',\r\n          criticalIssues: result.criticalIssues,\r\n          duration: result.duration\r\n        },\r\n        metadata: {}\r\n      };\r\n\r\n      setCurrentReport(miniReport);\r\n      setRunProgress('');\r\n    } catch (error: any) {\r\n      console.error('Agent run failed:', error);\r\n      setRunProgress(`×©×’×™××”: ${error.message}`);\r\n    } finally {\r\n      setIsRunning(false);\r\n    }\r\n  };\r\n\r\n  // Handle single fix\r\n  const handleFixTest = async (test: TestResult, suggestion: FixSuggestion) => {\r\n    setFixingTestId(test.id);\r\n    setFixProgress(`××ª×§×Ÿ: ${suggestion.descriptionHe}`);\r\n\r\n    try {\r\n      const result = await executeFix(suggestion, currentUser?.uid);\r\n      setFixResults(prev => new Map(prev).set(test.id, result));\r\n\r\n      if (result.status === 'success') {\r\n        setFixProgress(`âœ… ×ª×•×§×Ÿ ×‘×”×¦×œ×—×”!`);\r\n      } else {\r\n        setFixProgress(`âŒ ×ª×™×§×•×Ÿ × ×›×©×œ: ${result.errorMessage}`);\r\n      }\r\n    } catch (error: any) {\r\n      setFixProgress(`âŒ ×©×’×™××”: ${error.message}`);\r\n    } finally {\r\n      setFixingTestId(undefined);\r\n      setTimeout(() => setFixProgress(''), 3000);\r\n    }\r\n  };\r\n\r\n  // Handle fix all in suite\r\n  const handleFixAll = async (suite: TestSuite) => {\r\n    setIsFixingAll(true);\r\n\r\n    // Collect all fixable suggestions\r\n    const allSuggestions: { test: TestResult; suggestion: FixSuggestion }[] = [];\r\n\r\n    for (const test of suite.tests) {\r\n      if (test.status === 'failed' || test.status === 'warning') {\r\n        const suggestions = generateFixSuggestions(test);\r\n        const autoFixable = suggestions.filter(s => s.autoFixable);\r\n        if (autoFixable.length > 0) {\r\n          allSuggestions.push({ test, suggestion: autoFixable[0] });\r\n        }\r\n      }\r\n    }\r\n\r\n    setFixProgress(`××ª×§×Ÿ ${allSuggestions.length} ×‘×¢×™×•×ª...`);\r\n\r\n    let completed = 0;\r\n    for (const { test, suggestion } of allSuggestions) {\r\n      try {\r\n        const result = await executeFix(suggestion, currentUser?.uid);\r\n        setFixResults(prev => new Map(prev).set(test.id, result));\r\n        completed++;\r\n        setFixProgress(`××ª×§×Ÿ ${completed}/${allSuggestions.length}...`);\r\n      } catch (error) {\r\n        console.error('Fix failed:', error);\r\n      }\r\n    }\r\n\r\n    setFixProgress(`âœ… ×”×•×©×œ×! ${completed}/${allSuggestions.length} ×ª×•×§× ×•`);\r\n    setIsFixingAll(false);\r\n    setTimeout(() => setFixProgress(''), 5000);\r\n  };\r\n\r\n  // Count total fixable issues\r\n  const totalFixable = currentReport?.suites.reduce((sum, suite) => {\r\n    return sum + suite.tests.filter(t =>\r\n      (t.status === 'failed' || t.status === 'warning') &&\r\n      generateFixSuggestions(t).some(s => s.autoFixable)\r\n    ).length;\r\n  }, 0) || 0;\r\n\r\n  // Generate full report for copying\r\n  const generateFullReport = (): string => {\r\n    if (!currentReport) return '';\r\n\r\n    const lines: string[] = [];\r\n\r\n    lines.push('# ğŸ“Š ×“×•×— QA ××œ×');\r\n    lines.push(`×ª××¨×™×š: ${new Date(currentReport.createdAt).toLocaleString('he-IL')}`);\r\n    lines.push(`×¡×‘×™×‘×”: ${currentReport.environment}`);\r\n    lines.push('');\r\n\r\n    lines.push('## ğŸ“ˆ ×¡×™×›×•×');\r\n    lines.push(`- ×¡×”\"×› ×‘×“×™×§×•×ª: ${currentReport.summary.totalTests}`);\r\n    lines.push(`- ×¢×‘×¨×•: ${currentReport.summary.passed} (${currentReport.summary.passRate}%)`);\r\n    lines.push(`- × ×›×©×œ×•: ${currentReport.summary.failed}`);\r\n    lines.push(`- ××–×”×¨×•×ª: ${currentReport.summary.warnings}`);\r\n    lines.push(`- ×–××Ÿ ×¨×™×¦×”: ${Math.round(currentReport.summary.duration / 1000)} ×©× ×™×•×ª`);\r\n    lines.push('');\r\n\r\n    // Critical Issues\r\n    if (currentReport.summary.criticalIssues.length > 0) {\r\n      lines.push('## ğŸ”´ ×‘×¢×™×•×ª ×§×¨×™×˜×™×•×ª');\r\n      currentReport.summary.criticalIssues.forEach(issue => {\r\n        lines.push(`### âŒ ${issue.nameHe}`);\r\n        lines.push(`- ×”×•×“×¢×”: ${issue.messageHe}`);\r\n        if (issue.details) {\r\n          lines.push('- ×¤×¨×˜×™×:');\r\n          lines.push('```json');\r\n          lines.push(JSON.stringify(issue.details, null, 2));\r\n          lines.push('```');\r\n        }\r\n        lines.push('');\r\n      });\r\n    }\r\n\r\n    // All Suites\r\n    lines.push('## ğŸ“‹ ×ª×•×¦××•×ª ××¤×•×¨×˜×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”');\r\n    lines.push('');\r\n\r\n    currentReport.suites.forEach(suite => {\r\n      const statusIcon = suite.status === 'passed' ? 'âœ…' : suite.status === 'failed' ? 'âŒ' : 'âš ï¸';\r\n      lines.push(`### ${statusIcon} ${suite.nameHe}`);\r\n      lines.push(`- ×¢×‘×¨×•: ${suite.passedCount} | × ×›×©×œ×•: ${suite.failedCount} | ××–×”×¨×•×ª: ${suite.warningCount}`);\r\n      lines.push('');\r\n\r\n      suite.tests.forEach(test => {\r\n        const testIcon = test.status === 'passed' ? 'âœ…' : test.status === 'failed' ? 'âŒ' : 'âš ï¸';\r\n        lines.push(`#### ${testIcon} ${test.nameHe}`);\r\n        lines.push(`- ×¡×˜×˜×•×¡: ${test.status}`);\r\n        lines.push(`- ×”×•×“×¢×”: ${test.messageHe}`);\r\n        if (test.duration > 0) {\r\n          lines.push(`- ×–××Ÿ: ${test.duration}ms`);\r\n        }\r\n\r\n        if (test.details) {\r\n          lines.push('- **×¤×¨×˜×™× ××œ××™×:**');\r\n          lines.push('```json');\r\n          lines.push(JSON.stringify(test.details, null, 2));\r\n          lines.push('```');\r\n        }\r\n\r\n        // Add fix suggestions for failed tests\r\n        if (test.status === 'failed' || test.status === 'warning') {\r\n          const suggestions = generateFixSuggestions(test);\r\n          if (suggestions.length > 0) {\r\n            lines.push('- **×”×¦×¢×•×ª ×ª×™×§×•×Ÿ:**');\r\n            suggestions.forEach(s => {\r\n              lines.push(`  - ${s.descriptionHe} (${s.autoFixable ? '××•×˜×•××˜×™' : '×™×“× ×™'})`);\r\n            });\r\n          }\r\n        }\r\n\r\n        lines.push('');\r\n      });\r\n    });\r\n\r\n    // Add raw JSON at the end\r\n    lines.push('---');\r\n    lines.push('## ğŸ“„ JSON ××œ× (×œ× ×™×ª×•×— ×˜×›× ×™)');\r\n    lines.push('```json');\r\n    lines.push(JSON.stringify(currentReport, null, 2));\r\n    lines.push('```');\r\n\r\n    return lines.join('\\n');\r\n  };\r\n\r\n  const handleCopyReport = async () => {\r\n    const fullReport = generateFullReport();\r\n    try {\r\n      await navigator.clipboard.writeText(fullReport);\r\n      setCopySuccess(true);\r\n      setTimeout(() => setCopySuccess(false), 3000);\r\n    } catch (error) {\r\n      console.error('Failed to copy:', error);\r\n      // Fallback: create a textarea and copy\r\n      const textarea = document.createElement('textarea');\r\n      textarea.value = fullReport;\r\n      document.body.appendChild(textarea);\r\n      textarea.select();\r\n      document.execCommand('copy');\r\n      document.body.removeChild(textarea);\r\n      setCopySuccess(true);\r\n      setTimeout(() => setCopySuccess(false), 3000);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-900 text-white p-6\" dir=\"rtl\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-wrap justify-between items-center gap-4 mb-6\">\r\n        <div className=\"flex items-center gap-4\">\r\n          {onBack && (\r\n            <button\r\n              onClick={onBack}\r\n              className=\"flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-800 transition\"\r\n            >\r\n              <IconBack />\r\n              ×—×–×¨×”\r\n            </button>\r\n          )}\r\n          <h1 className=\"text-2xl font-bold flex items-center gap-3\">\r\n            ğŸ§  ××¢×¨×›×ª ×‘×“×™×§×•×ª ××™×›×•×ª\r\n            <span className=\"text-xs bg-purple-600 px-2 py-1 rounded-full\">Admin</span>\r\n          </h1>\r\n        </div>\r\n\r\n        <div className=\"flex gap-2\">\r\n          <button\r\n            onClick={handleCopyReport}\r\n            disabled={!currentReport}\r\n            className={`flex items-center gap-2 px-4 py-2.5 rounded-lg font-medium transition ${\r\n              copySuccess\r\n                ? 'bg-green-600 text-white'\r\n                : !currentReport\r\n                  ? 'bg-slate-800 text-slate-500 cursor-not-allowed border border-slate-700'\r\n                  : 'bg-slate-700 hover:bg-slate-600 border border-slate-600'\r\n            }`}\r\n            title={!currentReport ? '×”×¨×¥ ×‘×“×™×§×•×ª ×›×“×™ ×œ×™×¦×•×¨ ×“×•×—' : '×”×¢×ª×§ ×“×•×— ××œ× ×œ×œ×•×—'}\r\n          >\r\n            {copySuccess ? (\r\n              <>\r\n                <IconCheck className=\"w-4 h-4\" />\r\n                ×”×•×¢×ª×§!\r\n              </>\r\n            ) : (\r\n              <>\r\n                <IconCopy className=\"w-4 h-4\" />\r\n                ×”×¢×ª×§ ×“×•×— ××œ×\r\n              </>\r\n            )}\r\n          </button>\r\n          <button\r\n            onClick={handleRunQA}\r\n            disabled={isRunning || isFixingAll}\r\n            className={`flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium transition ${\r\n              isRunning || isFixingAll\r\n                ? 'bg-purple-600/50 cursor-not-allowed'\r\n                : 'bg-purple-600 hover:bg-purple-700'\r\n            }`}\r\n          >\r\n            {isRunning ? <IconLoader /> : <IconRefresh />}\r\n            {isRunning ? '×¨×¥...' : '×”×¨×¥ ×‘×“×™×§×•×ª'}\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Agent Selection */}\r\n      <div className=\"bg-slate-800 rounded-xl p-4 mb-6 border border-slate-700\">\r\n        <h3 className=\"font-semibold mb-3\">×‘×—×¨ ×¡×•×›× ×™× ×œ×”×¨×¦×”:</h3>\r\n        <div className=\"flex flex-wrap gap-4 mb-4\">\r\n          <label className=\"flex items-center gap-2 cursor-pointer\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={selectedAgents.contentQuality}\r\n              onChange={e => setSelectedAgents(prev => ({ ...prev, contentQuality: e.target.checked }))}\r\n              className=\"w-4 h-4\"\r\n            />\r\n            ğŸ“ ×‘×“×™×§×ª ××™×›×•×ª ×ª×•×›×Ÿ\r\n          </label>\r\n          <label className=\"flex items-center gap-2 cursor-pointer\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={selectedAgents.studentSimulation}\r\n              onChange={e => setSelectedAgents(prev => ({ ...prev, studentSimulation: e.target.checked }))}\r\n              className=\"w-4 h-4\"\r\n            />\r\n            ğŸ“ ×¡×™××•×œ×¦×™×™×ª ×ª×œ××™×“\r\n          </label>\r\n          <label className=\"flex items-center gap-2 cursor-pointer\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={selectedAgents.aiGeneration}\r\n              onChange={e => setSelectedAgents(prev => ({ ...prev, aiGeneration: e.target.checked }))}\r\n              className=\"w-4 h-4\"\r\n            />\r\n            âœ¨ ×‘×“×™×§×ª ×™×¦×™×¨×ª AI (×¢×œ×•×ª API)\r\n          </label>\r\n          <label className=\"flex items-center gap-2 cursor-pointer\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={selectedAgents.e2eGeneration}\r\n              onChange={e => setSelectedAgents(prev => ({ ...prev, e2eGeneration: e.target.checked }))}\r\n              className=\"w-4 h-4\"\r\n            />\r\n            ğŸ­ ×™×¦×™×¨×ª ×ª×•×›×Ÿ ××§×¦×” ×œ×§×¦×” (×¢×œ×•×ª API)\r\n          </label>\r\n          <label className=\"flex items-center gap-2 cursor-pointer\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={selectedAgents.studentActivity}\r\n              onChange={e => setSelectedAgents(prev => ({ ...prev, studentActivity: e.target.checked }))}\r\n              className=\"w-4 h-4\"\r\n            />\r\n            ğŸ“ ×¤×¢×™×œ×•×ª ×ª×œ××™×“ (× ×™×§×•×“)\r\n          </label>\r\n          <label className=\"flex items-center gap-2 cursor-pointer\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={selectedAgents.assessmentIntegrity}\r\n              onChange={e => setSelectedAgents(prev => ({ ...prev, assessmentIntegrity: e.target.checked }))}\r\n              className=\"w-4 h-4\"\r\n            />\r\n            âš–ï¸ ××™× ×˜×’×¨×™×˜×™ ×”×¢×¨×›×”\r\n          </label>\r\n          <label className=\"flex items-center gap-2 cursor-pointer\">\r\n            <input\r\n              type=\"checkbox\"\r\n              checked={selectedAgents.knowledgeBase}\r\n              onChange={e => setSelectedAgents(prev => ({ ...prev, knowledgeBase: e.target.checked }))}\r\n              className=\"w-4 h-4\"\r\n            />\r\n            ğŸ“š ××™× ×˜×’×¨×¦×™×™×ª ×‘×¡×™×¡ ×™×“×¢\r\n          </label>\r\n        </div>\r\n\r\n        <div className=\"flex flex-wrap gap-2\">\r\n          <span className=\"text-slate-400 text-sm\">×”×¨×¦×” ××”×™×¨×”:</span>\r\n          <button\r\n            onClick={() => handleRunSingleAgent('content')}\r\n            disabled={isRunning}\r\n            className=\"px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50\"\r\n          >\r\n            ğŸ“ ××™×›×•×ª ×ª×•×›×Ÿ\r\n          </button>\r\n          <button\r\n            onClick={() => handleRunSingleAgent('simulation')}\r\n            disabled={isRunning}\r\n            className=\"px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50\"\r\n          >\r\n            ğŸ“ ×¡×™××•×œ×¦×™×”\r\n          </button>\r\n          <button\r\n            onClick={() => handleRunSingleAgent('ai')}\r\n            disabled={isRunning}\r\n            className=\"px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50\"\r\n          >\r\n            âœ¨ ×™×¦×™×¨×ª AI\r\n          </button>\r\n          <button\r\n            onClick={() => handleRunSingleAgent('e2e')}\r\n            disabled={isRunning}\r\n            className=\"px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50\"\r\n          >\r\n            ğŸ­ E2E ×™×¦×™×¨×ª ×ª×•×›×Ÿ\r\n          </button>\r\n          <button\r\n            onClick={() => handleRunSingleAgent('activity')}\r\n            disabled={isRunning}\r\n            className=\"px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50\"\r\n          >\r\n            ğŸ“ ×¤×¢×™×œ×•×ª ×ª×œ××™×“\r\n          </button>\r\n          <button\r\n            onClick={() => handleRunSingleAgent('integrity')}\r\n            disabled={isRunning}\r\n            className=\"px-3 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50\"\r\n          >\r\n            âš–ï¸ ××™× ×˜×’×¨×™×˜×™\r\n          </button>\r\n          <button\r\n            onClick={() => handleRunSingleAgent('knowledge-base')}\r\n            disabled={isRunning}\r\n            className=\"px-3 py-1 text-xs rounded bg-purple-700 hover:bg-purple-600 transition disabled:opacity-50\"\r\n          >\r\n            ğŸ“š ×‘×¡×™×¡ ×™×“×¢\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Progress */}\r\n      {(runProgress || fixProgress) && (\r\n        <div className={`rounded-xl p-4 mb-6 flex items-center gap-3 ${\r\n          fixProgress.includes('âœ…') ? 'bg-green-900/50 border border-green-700' :\r\n          fixProgress.includes('âŒ') ? 'bg-red-900/50 border border-red-700' :\r\n          'bg-blue-900/50 border border-blue-700'\r\n        }`}>\r\n          {!fixProgress.includes('âœ…') && !fixProgress.includes('âŒ') && <IconLoader />}\r\n          <span>{fixProgress || runProgress}</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Current Report */}\r\n      {currentReport && (\r\n        <>\r\n          {/* Summary Stats */}\r\n          <div className=\"grid grid-cols-2 md:grid-cols-7 gap-4 mb-6\">\r\n            <StatCard value={currentReport.summary.totalTests} label=\"×¡×”×´×› ×‘×“×™×§×•×ª\" />\r\n            <StatCard value={currentReport.summary.passed} label=\"×¢×‘×¨×•\" color=\"#10b981\" />\r\n            <StatCard value={currentReport.summary.failed} label=\"× ×›×©×œ×•\" color=\"#ef4444\" />\r\n            <StatCard value={currentReport.summary.warnings} label=\"××–×”×¨×•×ª\" color=\"#f59e0b\" />\r\n            <StatCard value={totalFixable} label=\"× ×™×ª×Ÿ ×œ×ª×™×§×•×Ÿ\" color=\"#a855f7\" />\r\n            <StatCard\r\n              value={`${currentReport.summary.passRate}%`}\r\n              label=\"××—×•×– ×”×¦×œ×—×”\"\r\n              color={currentReport.summary.passRate >= 80 ? '#10b981' : currentReport.summary.passRate >= 50 ? '#f59e0b' : '#ef4444'}\r\n            />\r\n            <StatCard value={`${Math.round(currentReport.summary.duration / 1000)}s`} label=\"×–××Ÿ ×¨×™×¦×”\" />\r\n          </div>\r\n\r\n          {/* Overall Status with Fix All */}\r\n          <div className={`rounded-xl p-4 mb-6 flex items-center justify-between ${\r\n            currentReport.summary.overallStatus === 'passed'\r\n              ? 'bg-green-900/50 border border-green-700'\r\n              : currentReport.summary.overallStatus === 'failed'\r\n              ? 'bg-red-900/50 border border-red-700'\r\n              : 'bg-yellow-900/50 border border-yellow-700'\r\n          }`}>\r\n            <div className=\"flex items-center gap-3 text-lg font-semibold\">\r\n              {currentReport.summary.overallStatus === 'passed' ? 'âœ…' : currentReport.summary.overallStatus === 'failed' ? 'âŒ' : 'âš ï¸'}\r\n              <span>\r\n                {currentReport.summary.overallStatus === 'passed'\r\n                  ? '×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”!'\r\n                  : currentReport.summary.overallStatus === 'failed'\r\n                  ? '× ××¦××• ×‘×¢×™×•×ª ×§×¨×™×˜×™×•×ª'\r\n                  : '× ××¦××• ××–×”×¨×•×ª'}\r\n              </span>\r\n            </div>\r\n\r\n            {totalFixable > 0 && (\r\n              <button\r\n                onClick={() => {\r\n                  // Fix all issues across all suites\r\n                  currentReport.suites.forEach(suite => handleFixAll(suite));\r\n                }}\r\n                disabled={isFixingAll}\r\n                className={`flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium transition ${\r\n                  isFixingAll\r\n                    ? 'bg-purple-600/50 cursor-not-allowed'\r\n                    : 'bg-purple-600 hover:bg-purple-700'\r\n                }`}\r\n              >\r\n                {isFixingAll ? (\r\n                  <>\r\n                    <IconLoader />\r\n                    ××ª×§×Ÿ...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <IconZap />\r\n                    ×ª×§×Ÿ ×”×›×œ ({totalFixable})\r\n                  </>\r\n                )}\r\n              </button>\r\n            )}\r\n          </div>\r\n\r\n          {/* Critical Issues */}\r\n          {currentReport.summary.criticalIssues.length > 0 && (\r\n            <div className=\"bg-red-900/30 border border-red-700 rounded-xl p-4 mb-6\">\r\n              <h3 className=\"text-red-400 font-semibold mb-3 flex items-center gap-2\">\r\n                âš ï¸ ×‘×¢×™×•×ª ×§×¨×™×˜×™×•×ª ({currentReport.summary.criticalIssues.length})\r\n              </h3>\r\n              <div className=\"space-y-2\">\r\n                {currentReport.summary.criticalIssues.map(issue => (\r\n                  <TestResultItem\r\n                    key={issue.id}\r\n                    test={issue}\r\n                    onFixTest={handleFixTest}\r\n                    fixingTestId={fixingTestId}\r\n                    fixResults={fixResults}\r\n                  />\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Test Suites */}\r\n          <h2 className=\"text-xl font-semibold mb-4\">×ª×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”</h2>\r\n          {currentReport.suites.map(suite => (\r\n            <TestSuiteCard\r\n              key={suite.id}\r\n              suite={suite}\r\n              defaultExpanded={suite.status === 'failed'}\r\n              onFixTest={handleFixTest}\r\n              onFixAll={handleFixAll}\r\n              fixingTestId={fixingTestId}\r\n              fixResults={fixResults}\r\n              isFixingAll={isFixingAll}\r\n            />\r\n          ))}\r\n        </>\r\n      )}\r\n\r\n      {/* Recent Reports */}\r\n      {recentReports.length > 0 && !currentReport && (\r\n        <div className=\"bg-slate-800 rounded-xl p-4 border border-slate-700\">\r\n          <h3 className=\"font-semibold mb-4\">×“×•×—×•×ª ××—×¨×•× ×™×</h3>\r\n          <div className=\"space-y-2\">\r\n            {recentReports.map(report => (\r\n              <div\r\n                key={report.id}\r\n                onClick={() => setCurrentReport(report)}\r\n                className=\"flex justify-between items-center p-3 bg-slate-900 rounded-lg border border-slate-700 cursor-pointer hover:bg-slate-800 transition\"\r\n              >\r\n                <div>\r\n                  <div className=\"font-medium\">{new Date(report.createdAt).toLocaleString('he-IL')}</div>\r\n                  <div className=\"text-sm text-slate-400\">\r\n                    {report.summary.totalTests} ×‘×“×™×§×•×ª | {report.summary.passRate}% ×”×¦×œ×—×”\r\n                  </div>\r\n                </div>\r\n                <StatusBadge status={report.summary.overallStatus} />\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Empty State */}\r\n      {!currentReport && recentReports.length === 0 && !isRunning && (\r\n        <div className=\"bg-slate-800 rounded-xl p-12 text-center border border-slate-700\">\r\n          <div className=\"text-5xl mb-4 opacity-50\">ğŸ§ </div>\r\n          <h3 className=\"text-lg font-semibold mb-2\">××™×Ÿ ×“×•×—×•×ª ×‘×“×™×§×•×ª</h3>\r\n          <p className=\"text-slate-400\">×œ×—×¥ ×¢×œ \"×”×¨×¥ ×‘×“×™×§×•×ª\" ×›×“×™ ×œ×”×ª×—×™×œ</p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default QADashboard;\r\n"],"names":["DEFAULT_STUDENT_PROFILES","DEFAULT_QA_CONFIG","createTestResult","name","nameHe","category","status","severity","message","messageHe","duration","details","createTestSuite","tests","passedCount","t","failedCount","warningCount","skippedCount","sum","runSanityTests","startTime","testQuery","query","collection","db","limit","getDocs","error","coursesStart","coursesQuery","snapshot","assignmentsStart","assignmentsQuery","usersStart","usersQuery","runDataIntegrityTests","config","emptyStart","emptyCount","totalCourses","emptyCourses","doc","syllabus","m","_a","blocksStart","invalidBlocks","issues","module","unit","block","content","tasksQuery","tasksSnapshot","courseIds","data","orphanedTasks","courseId","where","runPerformanceTests","queryStart","orderBy","queryTime","aggStart","aggTime","runFullQAReport","triggeredBy","userId","suites","allTests","s","passed","failed","warnings","skipped","criticalIssues","overallStatus","summary","report","saveQAReport","reportRef","cleanReport","Timestamp","_b","_c","setDoc","getRecentQAReports","limitCount","reportsQuery","_d","validateMultipleChoiceBlock","options","correctAnswer","o","score","validateOpenQuestionBlock","validateOrderingBlock","correctOrder","validateCategorizationBlock","categories","items","item","index","i","validateTextBlock","validateMemoryGameBlock","pairs","validateBlock","validateUnit","blockScores","blocks","validBlocks","totalScore","result","blockTypes","b","avgScore","validateCourse","course","unitResults","modules","totalUnits","totalBlocks","unitScoreCount","units","unitResult","overallScore","runContentQualityAgent","maxCourses","allResults","totalTests","passedTests","failedTests","docSnap","testResult","simulateMultipleChoiceBlock","profile","actions","readTime","answersCorrectly","selectedAnswer","isCorrect","totalTime","a","simulateOpenQuestionBlock","typingTime","simulateOrderingBlock","interactionTime","simulateCategorizationBlock","simulateMemoryGameBlock","baseTime","skillMultiplier","playTime","simulateMediaBlock","viewTime","adjustedTime","simulateBlock","simulateUnit","blockResults","blocksStuck","contentErrors","blocksCompleted","simulateCourse","startedAt","unitsAttempted","unitsCompleted","blocksAttempted","allBlocksStuck","allContentErrors","allUxProblems","navigationIssues","avgTimePerBlock","errorRate","completionRate","runStudentSimulationAgent","profiles","simulation","hasCriticalIssues","hasIssues","TEST_TOPICS","SAMPLE_SOURCE_TEXT","validateMultipleChoiceOutput","output","questionText","hasHebrew","validateOpenQuestionOutput","question","validateCategorizationOutput","invalidItems","validateOrderingOutput","validateMemoryGameOutput","invalidPairs","pair","testMultipleChoiceGeneration","topic","gradeLevel","sourceText","timeout","testId","timeoutPromise","_","reject","generateSingleMultipleChoiceQuestion","validation","isTimeout","testOpenQuestionGeneration","generateSingleOpenQuestion","testCategorizationGeneration","generateCategorizationQuestion","testOrderingGeneration","generateOrderingQuestion","testMemoryGameGeneration","generateMemoryGame","runAIGenerationAgent","testTypes","allGenerationTests","testTopic","testType","generationTest","isPassed","resolve","avgDuration","avgQuality","type","SAMPLE_SOURCES","SAMPLE_YOUTUBE_SOURCES","validateSyllabus","emptyUnits","mIdx","uIdx","validatePodcastScript","script","dialogue","fullText","turn","validateInteractiveBlocks","idx","testLessonFromText","source","syllabusResult","generateCourseSyllabus","unitsCount","blocksCount","mod","testPodcastGeneration","podcastResult","generatePodcastScript","testInteractiveBlocksGeneration","blockPromises","results","testLessonFromYouTube","transcriptText","transcriptionResult","MultimodalService","transcriptError","errorCode","errorType","errorMessage","TRANSCRIPTION_ERROR_CODES","finalScore","runE2EGenerationAgent","e2eResults","lessonHistory","lessonScience","podcast","game","youtubeLesson","r","calculateExpectedScore","attempts","hintsUsed","xp","gems","SCORING_CONFIG","performMultipleChoiceActivity","isExamMode","scenario","hints","optionTexts","actualCalculatedScore","calculateQuestionScore","performOpenQuestionActivity","performOrderingActivity","runActivitySession","allIssues","blocksCorrectFirstTry","blocksCorrectWithHints","blocksCorrectAfterRetry","blocksIncorrect","totalExpectedScore","totalActualScore","attempt","scenarios","runStudentActivityAgent","testExamMode","firestoreLimit","learningSession","learningCritical","learningHigh","hasCriticalLearning","hasHighLearning","learningStatus","learningResult","examSession","examCritical","examHigh","hasCriticalExam","hasHighExam","hintsInExam","examStatus","examResult","policyTest","validateScoringPolicy","test1","test2","expected2","test3","expected3","test4","test5","test6","hasCritical","ASSESSMENT_POLICY","unitId","isExamContent","violations","metadata","location","teachContent","bloomLevel","hasCorrectAnswer","correctAnswerInOptions","hasEnoughOptions","noHintsInExam","noTeachingInExam","hasBloomLevel","rubric","modelAnswer","hasRubric","hasModelAnswer","validateScoringRules","testCases","tc","actual","extremeCase","validateCourseAssessment","interactiveBlocks","examBlocks","isExamCourse","isExamUnit","isExamBlock","_e","_f","v","runAssessmentIntegrityAgent","scoringViolations","scoringTest","hasHigh","overallViolations","summaryTest","DEFAULT_TEST_TOPICS","id","testKBSearchConnectivity","grade","searchKnowledge","avgSimilarity","testPedagogicalContextExtraction","context","getMathPedagogicalContext","extractedCounts","testPromptFormatting","formattedPrompt","formatPedagogicalContextForPrompt","hasSections","sectionsPresent","testContentGenerationWithKB","hasKBContext","generatedText","languageAnalysis","analyzeGeneratedContentLanguage","kbContext","hasAddressing","p","hasComplexTerms","isLowGrade","testActualOutputQuality","matchedPatterns","testStep","generateStepContent","contentText","textbookPatterns","hasTextbookStyleAddressing","found","hasContextualQuestion","hasHebrewContent","complexTerms","simpleGrades","hasAppropriateComplexity","usesKBPatterns","allKBPatterns","kbPattern","keyWords","qualityChecks","testKBCoverage","allGrades","gradesWithContent","booksWithContent","sampleContent","broadSearchTerms","searchTerm","bookId","missingGrades","g","runKnowledgeBaseQAAgent","maxTopics","testsPassed","testsFailed","coverageResult","topicsToTest","limitedTopicsToTest","coverageTest","description","searchResult","searchTest","extractionResult","totalExtracted","extractionTest","formattingResult","sectionsCount","formattingTest","generationResult","outputQualityResult","passedQualityChecks","qualityTest","totalDuration","passRate","generateFixSuggestions","suggestions","parseErrorType","createRegenerateBlockSuggestion","createFixOptionsSuggestion","createAddCorrectAnswerSuggestion","createRegenerateContentSuggestion","createFixStructureSuggestion","createAddMissingFieldSuggestion","createRemoveInvalidSuggestion","createManualReviewSuggestion","field","executeFix","suggestion","executeRegenerateBlock","executeFixOptions","executeAddCorrectAnswer","executeRegenerateContent","executeFixStructure","executeAddMissingField","executeRemoveInvalid","targetPath","aiPrompt","courseRef","courseSnap","getDoc","blockFound","previousValue","newValue","updatedUnits","updatedBlocks","updatedBlock","updateDoc","updated","currentOptions","newOptions","opt","fixedBlock","ensureBlockStructure","fieldName","defaultValue","removed","runComprehensiveQA","includeContentQuality","includeStudentSimulation","includeAIGeneration","includeE2EGeneration","includeStudentActivity","includeAssessmentIntegrity","includeKnowledgeBase","saveReport","agentResults","contentResult","contentSuite","simResult","simSuite","aiResult","aiSuite","e2eResult","e2eSuite","activityResult","activitySuite","integrityResult","integritySuite","kbResult","kbSuite","reportId","IconRefresh","jsxs","jsx","IconCheck","className","IconX","IconWarning","IconLoader","IconChevronDown","IconChevronUp","IconBack","IconWrench","IconZap","IconCopy","StatusBadge","getStyle","getIcon","getLabel","StatCard","value","label","color","FixSuggestionItem","onFix","isFixing","fixResult","getRiskColor","getRiskLabel","Fragment","TestResultItem","test","onFixTest","fixingTestId","fixResults","showDetails","setShowDetails","useState","showFixes","setShowFixes","fixSuggestions","hasAutoFix","TestSuiteCard","suite","defaultExpanded","onFixAll","isFixingAll","expanded","setExpanded","fixableCount","e","QADashboard","onBack","currentUser","useAuth","isRunning","setIsRunning","currentReport","setCurrentReport","recentReports","setRecentReports","runProgress","setRunProgress","selectedAgents","setSelectedAgents","setFixingTestId","setIsFixingAll","setFixResults","fixProgress","setFixProgress","copySuccess","setCopySuccess","useEffect","loadRecentReports","reports","handleRunQA","handleRunSingleAgent","agentType","agentNameHe","categoryName","miniReport","handleFixTest","prev","handleFixAll","allSuggestions","autoFixable","completed","totalFixable","generateFullReport","lines","issue","statusIcon","testIcon","handleCopyReport","fullReport","textarea"],"mappings":"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"}